<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>5 Fitness model | Estimating Social Animal Models in Stan</title>
  <meta name="description" content="5 Fitness model | Estimating Social Animal Models in Stan" />
  <meta name="generator" content="bookdown 0.22 and GitBook 2.6.7" />

  <meta property="og:title" content="5 Fitness model | Estimating Social Animal Models in Stan" />
  <meta property="og:type" content="book" />
  
  
  
  

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="5 Fitness model | Estimating Social Animal Models in Stan" />
  
  
  

<meta name="author" content="Jordan S. Martin &amp; Adrian V. Jaeggi" />


<meta name="date" content="2021-07-15" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="within-and-between-partner-sam.html"/>
<link rel="next" href="extending-sams.html"/>
<script src="libs/header-attrs-2.8/header-attrs.js"></script>
<script src="libs/jquery-2.2.3/jquery.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />









<link href="libs/anchor-sections-1.0.1/anchor-sections.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.0.1/anchor-sections.js"></script>


<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<style type="text/css">
/* Used with Pandoc 2.11+ new --citeproc when CSL is used */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
}
.hanging div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}
</style>

<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li class="chapter" data-level="" data-path="introduction.html"><a href="introduction.html"><i class="fa fa-check"></i>Introduction</a></li>
<li class="chapter" data-level="1" data-path="using-stan-in-r.html"><a href="using-stan-in-r.html"><i class="fa fa-check"></i><b>1</b> Using Stan in R</a>
<ul>
<li class="chapter" data-level="1.1" data-path="using-stan-in-r.html"><a href="using-stan-in-r.html#why-stan"><i class="fa fa-check"></i><b>1.1</b> Why Stan?</a></li>
<li class="chapter" data-level="1.2" data-path="using-stan-in-r.html"><a href="using-stan-in-r.html#getting-started"><i class="fa fa-check"></i><b>1.2</b> Getting Started</a></li>
<li class="chapter" data-level="1.3" data-path="using-stan-in-r.html"><a href="using-stan-in-r.html#bayesian-inference"><i class="fa fa-check"></i><b>1.3</b> Bayesian inference</a></li>
<li class="chapter" data-level="1.4" data-path="using-stan-in-r.html"><a href="using-stan-in-r.html#basic-coding-tutorial"><i class="fa fa-check"></i><b>1.4</b> Basic coding tutorial</a>
<ul>
<li class="chapter" data-level="1.4.1" data-path="using-stan-in-r.html"><a href="using-stan-in-r.html#cholesky-decompositions"><i class="fa fa-check"></i><b>1.4.1</b> Cholesky decompositions</a></li>
<li class="chapter" data-level="1.4.2" data-path="using-stan-in-r.html"><a href="using-stan-in-r.html#non-centered-random-effects"><i class="fa fa-check"></i><b>1.4.2</b> Non-centered random effects</a></li>
</ul></li>
<li class="chapter" data-level="1.5" data-path="using-stan-in-r.html"><a href="using-stan-in-r.html#animal-models"><i class="fa fa-check"></i><b>1.5</b> Animal models</a>
<ul>
<li class="chapter" data-level="1.5.1" data-path="using-stan-in-r.html"><a href="using-stan-in-r.html#simulate-data"><i class="fa fa-check"></i><b>1.5.1</b> Simulate data</a></li>
<li class="chapter" data-level="1.5.2" data-path="using-stan-in-r.html"><a href="using-stan-in-r.html#kronecker-products"><i class="fa fa-check"></i><b>1.5.2</b> Kronecker products</a></li>
<li class="chapter" data-level="1.5.3" data-path="using-stan-in-r.html"><a href="using-stan-in-r.html#identifying-genetic-effects"><i class="fa fa-check"></i><b>1.5.3</b> Identifying genetic effects</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="2" data-path="within-partner-sam.html"><a href="within-partner-sam.html"><i class="fa fa-check"></i><b>2</b> Within partner SAM</a>
<ul>
<li class="chapter" data-level="2.1" data-path="within-partner-sam.html"><a href="within-partner-sam.html#formal-overview"><i class="fa fa-check"></i><b>2.1</b> Formal overview</a></li>
<li class="chapter" data-level="2.2" data-path="within-partner-sam.html"><a href="within-partner-sam.html#computational-approach"><i class="fa fa-check"></i><b>2.2</b> Computational approach</a></li>
<li class="chapter" data-level="2.3" data-path="within-partner-sam.html"><a href="within-partner-sam.html#simulate-data-1"><i class="fa fa-check"></i><b>2.3</b> Simulate data</a>
<ul>
<li class="chapter" data-level="2.3.1" data-path="within-partner-sam.html"><a href="within-partner-sam.html#srn-parameters"><i class="fa fa-check"></i><b>2.3.1</b> SRN parameters</a></li>
<li class="chapter" data-level="2.3.2" data-path="within-partner-sam.html"><a href="within-partner-sam.html#assortment"><i class="fa fa-check"></i><b>2.3.2</b> Assortment</a></li>
<li class="chapter" data-level="2.3.3" data-path="within-partner-sam.html"><a href="within-partner-sam.html#repeated-measurements-within-the-partner"><i class="fa fa-check"></i><b>2.3.3</b> Repeated measurements within the partner</a></li>
</ul></li>
<li class="chapter" data-level="2.4" data-path="within-partner-sam.html"><a href="within-partner-sam.html#coding-the-model"><i class="fa fa-check"></i><b>2.4</b> Coding the model</a></li>
<li class="chapter" data-level="2.5" data-path="within-partner-sam.html"><a href="within-partner-sam.html#estimating-the-model"><i class="fa fa-check"></i><b>2.5</b> Estimating the model</a></li>
<li class="chapter" data-level="2.6" data-path="within-partner-sam.html"><a href="within-partner-sam.html#failure-to-detect-assortment"><i class="fa fa-check"></i><b>2.6</b> Failure to detect assortment</a></li>
<li class="chapter" data-level="2.7" data-path="within-partner-sam.html"><a href="within-partner-sam.html#phenotypic-model"><i class="fa fa-check"></i><b>2.7</b> Phenotypic model</a></li>
</ul></li>
<li class="chapter" data-level="3" data-path="between-partner-sam.html"><a href="between-partner-sam.html"><i class="fa fa-check"></i><b>3</b> Between partner SAM</a>
<ul>
<li class="chapter" data-level="3.1" data-path="between-partner-sam.html"><a href="between-partner-sam.html#simulate-data-2"><i class="fa fa-check"></i><b>3.1</b> Simulate data</a></li>
<li class="chapter" data-level="3.2" data-path="between-partner-sam.html"><a href="between-partner-sam.html#estimate-the-model"><i class="fa fa-check"></i><b>3.2</b> Estimate the model</a></li>
<li class="chapter" data-level="3.3" data-path="between-partner-sam.html"><a href="between-partner-sam.html#estimating-assortment"><i class="fa fa-check"></i><b>3.3</b> Estimating assortment</a></li>
<li class="chapter" data-level="3.4" data-path="between-partner-sam.html"><a href="between-partner-sam.html#phenotypic-model-1"><i class="fa fa-check"></i><b>3.4</b> Phenotypic model</a></li>
</ul></li>
<li class="chapter" data-level="4" data-path="within-and-between-partner-sam.html"><a href="within-and-between-partner-sam.html"><i class="fa fa-check"></i><b>4</b> Within-and-between partner SAM</a>
<ul>
<li class="chapter" data-level="4.1" data-path="within-and-between-partner-sam.html"><a href="within-and-between-partner-sam.html#simulate-data-3"><i class="fa fa-check"></i><b>4.1</b> Simulate data</a></li>
<li class="chapter" data-level="4.2" data-path="within-and-between-partner-sam.html"><a href="within-and-between-partner-sam.html#estimate-the-model-1"><i class="fa fa-check"></i><b>4.2</b> Estimate the model</a></li>
<li class="chapter" data-level="4.3" data-path="within-and-between-partner-sam.html"><a href="within-and-between-partner-sam.html#estimating-assortment-1"><i class="fa fa-check"></i><b>4.3</b> Estimating assortment</a></li>
<li class="chapter" data-level="4.4" data-path="within-and-between-partner-sam.html"><a href="within-and-between-partner-sam.html#phenotypic-model-2"><i class="fa fa-check"></i><b>4.4</b> Phenotypic model</a></li>
</ul></li>
<li class="chapter" data-level="5" data-path="fitness-model.html"><a href="fitness-model.html"><i class="fa fa-check"></i><b>5</b> Fitness model</a>
<ul>
<li class="chapter" data-level="5.1" data-path="fitness-model.html"><a href="fitness-model.html#simulate-data-4"><i class="fa fa-check"></i><b>5.1</b> Simulate data</a></li>
<li class="chapter" data-level="5.2" data-path="fitness-model.html"><a href="fitness-model.html#estimating-the-model-1"><i class="fa fa-check"></i><b>5.2</b> Estimating the model</a></li>
<li class="chapter" data-level="5.3" data-path="fitness-model.html"><a href="fitness-model.html#estimating-assortment-2"><i class="fa fa-check"></i><b>5.3</b> Estimating assortment</a></li>
<li class="chapter" data-level="5.4" data-path="fitness-model.html"><a href="fitness-model.html#estimating-selection-differentials-and-genetic-responses"><i class="fa fa-check"></i><b>5.4</b> Estimating selection differentials and genetic responses</a></li>
</ul></li>
<li class="chapter" data-level="6" data-path="extending-sams.html"><a href="extending-sams.html"><i class="fa fa-check"></i><b>6</b> Extending SAMs</a></li>
<li class="chapter" data-level="" data-path="resources.html"><a href="resources.html"><i class="fa fa-check"></i>Resources</a></li>
</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Estimating Social Animal Models in Stan</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="fitness-model" class="section level1" number="5">
<h1><span class="header-section-number">5</span> Fitness model</h1>
<p>This chapter is a work in progress.</p>
<p>Previous chapters showed how to estimate SRNs and assortment on SRN parameters using SAMs. In this chapter, we’ll extend this basic approach to model how between-individual variation in SRN parameters affects individuals’ relative fitness, which we’ll then use to predict patterns of adaptive social evolution in the phenotype.</p>
<p>Our basic fitness model considers linear directional selection on each individual’s SRN intercept <span class="math inline">\(\mu_j\)</span> and slope <span class="math inline">\(\psi_j\)</span>, as well as directional social selection due to partner SRN intercepts <span class="math inline">\(\mu&#39;_k\)</span> and slopes <span class="math inline">\(\psi&#39;_k\)</span>. In addition, the magnitude of this directional selection is modulated by the interactive effects of the joint individual and partner phenotypes <span class="math inline">\(\mu_j\mu&#39;_k\)</span> and <span class="math inline">\(\psi_j\psi&#39;_k\)</span>. These interactive effects reflect synergy (+) or antagonism (-) between the trait values of individuals and their social partners. In <span class="citation"><a href="#ref-SAM" role="doc-biblioref">Martin and Jaeggi</a> (<a href="#ref-SAM" role="doc-biblioref">2021</a>)</span>, the fitness model is formally presented for the effects of the average social partner. For the purposes of this simulation, we instead consider a fitness model for the reproductive success of each individual and partner dyad across multiple reproductive seasons, rather than the effect of the average partner across seasons. In particular, following the within and between partner model (Ch. <a href="within-and-between-partner-sam.html#within-and-between-partner-sam">4</a> ), we assume that individuals are sampled repeated within partners (2x) across multiple partners (x4). For the fitness model, we assume that these pairs are (serially) monogamous breeding partners measured across breeding seasons, with a single fitness measure (e.g. fledgling success) taken once per pair at the end of the breeding season. Estimating fitness effects across these repeated measures provides more power for the estimation of selection and assortment, on the assumption that fitness effects do not meaningfully vary across breeding seasons. This may be unrealistic for a variety of reasons (e.g. density-dependent effects), in which case the fitness model can be expanded with season-specific coefficients.</p>
<p>The model for relative fitness <span class="math inline">\(w\)</span> measure <span class="math inline">\(i\)</span> of individual <span class="math inline">\(j\)</span> with partner <span class="math inline">\(k\)</span> is therefore given as</p>
<p><span class="math display">\[w_{ijk} =  \nu_0 + \beta_{N1} + \beta_{N2} + \beta_{S1} + \beta_{S2} + \beta_{I2} + \beta_{I2} \]</span>
where we. Note that the interpretation of the regression coefficients is contingent on the potentially arbitrary designation of focal and social partner sex. In this case, we treat males as focals, such that <span class="math inline">\(\boldsymbol{\beta_N}\)</span> represent nonsocial selection gradients on male SRNs, while <span class="math inline">\(\boldsymbol{\beta_S}\)</span> represent social selection gradients acting on males due to female mating partners. For females in this simplified context of purely monogamous reproduction, the interpretation is reversed, given that <span class="math inline">\(w_{ijk}\)</span> is the shared fitness of both partners during their interaction. Under the further simplifying assumptions that <span class="math inline">\(\beta_{N1}=\beta_{S1}\)</span> and <span class="math inline">\(\beta_{N2}=\beta_{S2}\)</span>, a single selection differential can be used to characterize both males and females in the population. Of course, this will often be unrealistic, and males and female partners will often have only partially shared fitness outcomes, in which case more general sex-specific response models can also be specified</p>
<p><span class="math display">\[w_{ij} =  \nu_0 + \beta_{N1}\mu_j + \beta_{N2}\psi_j + \beta_{S1}\mu&#39;_k + \beta_{S2}\psi&#39;_k + \beta_{I2}(\mu_j\mu&#39;_k) + \beta_{I2}(\psi_j\psi&#39;_k) \]</span>
<span class="math display">\[w&#39;_{ik} =  \nu_0 + \beta&#39;_{N1}\mu&#39;_k + \beta&#39;_{N2}\psi&#39;_k + \beta&#39;_{S1}\mu_j + \beta&#39;_{S2}\psi_j + \beta&#39;_{I2}(\mu&#39;_k\mu_j) + \beta&#39;_{I2}(\psi&#39;_k\psi_j) \]</span>
For pedagogical purposes, we simulate data under the simpler shared dyadic fitness model and will consider more complex cases in subsequent SAM extensions.</p>
<div id="simulate-data-4" class="section level2" number="5.1">
<h2><span class="header-section-number">5.1</span> Simulate data</h2>
<p>The initial simulation approach is identical to previous chapters and can be reviewed there. We generate data appropriate for the within and between partner SAM, assuming that assortment occurs between dyadic partners for SRN slopes.</p>
<div class="sourceCode" id="cb144"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb144-1"><a href="fitness-model.html#cb144-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(mvtnorm)</span>
<span id="cb144-2"><a href="fitness-model.html#cb144-2" aria-hidden="true" tabindex="-1"></a><span class="co">#common settings</span></span>
<span id="cb144-3"><a href="fitness-model.html#cb144-3" aria-hidden="true" tabindex="-1"></a>I_partner <span class="ot">=</span> <span class="dv">4</span> <span class="co">#partners/individual</span></span>
<span id="cb144-4"><a href="fitness-model.html#cb144-4" aria-hidden="true" tabindex="-1"></a>I_obs <span class="ot">=</span> <span class="dv">2</span> <span class="co">#observations/individual/seasonal partner</span></span>
<span id="cb144-5"><a href="fitness-model.html#cb144-5" aria-hidden="true" tabindex="-1"></a>I_sample <span class="ot">=</span> I_partner<span class="sc">*</span>I_obs <span class="co">#samples/individual</span></span>
<span id="cb144-6"><a href="fitness-model.html#cb144-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb144-7"><a href="fitness-model.html#cb144-7" aria-hidden="true" tabindex="-1"></a><span class="co">#population properties</span></span>
<span id="cb144-8"><a href="fitness-model.html#cb144-8" aria-hidden="true" tabindex="-1"></a>I<span class="ot">=</span><span class="dv">300</span> <span class="co">#total individuals for simulation</span></span>
<span id="cb144-9"><a href="fitness-model.html#cb144-9" aria-hidden="true" tabindex="-1"></a>popmin<span class="ot">=</span><span class="dv">400</span></span>
<span id="cb144-10"><a href="fitness-model.html#cb144-10" aria-hidden="true" tabindex="-1"></a>popmax<span class="ot">=</span><span class="dv">600</span></span>
<span id="cb144-11"><a href="fitness-model.html#cb144-11" aria-hidden="true" tabindex="-1"></a>ngenerations <span class="ot">=</span> <span class="dv">10</span></span>
<span id="cb144-12"><a href="fitness-model.html#cb144-12" aria-hidden="true" tabindex="-1"></a>nids<span class="ot">&lt;-</span><span class="fu">sample</span>(popmin<span class="sc">:</span>popmax, ngenerations, <span class="at">replace=</span><span class="cn">TRUE</span>) <span class="co">#N / generation</span></span>
<span id="cb144-13"><a href="fitness-model.html#cb144-13" aria-hidden="true" tabindex="-1"></a>epm <span class="ot">=</span> <span class="fu">sample</span>(<span class="fu">seq</span>(<span class="fl">0.15</span>, <span class="fl">0.25</span>,<span class="at">by=</span><span class="fl">0.05</span>),<span class="dv">1</span>) <span class="co">#extra-pair mating</span></span>
<span id="cb144-14"><a href="fitness-model.html#cb144-14" aria-hidden="true" tabindex="-1"></a>nonb <span class="ot">=</span> <span class="fu">sample</span>(<span class="fu">seq</span>(<span class="fl">0.4</span>,<span class="fl">0.6</span>,<span class="at">by=</span><span class="fl">0.05</span>),<span class="dv">1</span>) <span class="co">#proportion of non-breeding / generation</span></span>
<span id="cb144-15"><a href="fitness-model.html#cb144-15" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb144-16"><a href="fitness-model.html#cb144-16" aria-hidden="true" tabindex="-1"></a><span class="co">#relatedness matrix</span></span>
<span id="cb144-17"><a href="fitness-model.html#cb144-17" aria-hidden="true" tabindex="-1"></a>A_mat <span class="ot">&lt;-</span> <span class="fu">pedfun</span>(<span class="at">popmin=</span>popmin, <span class="at">popmax=</span>popmax, <span class="at">ngenerations=</span>ngenerations,</span>
<span id="cb144-18"><a href="fitness-model.html#cb144-18" aria-hidden="true" tabindex="-1"></a>                  <span class="at">epm=</span>epm, <span class="at">nonb=</span>nonb, <span class="at">nids=</span>nids, <span class="at">I=</span>I, <span class="at">missing=</span><span class="cn">FALSE</span>)</span>
<span id="cb144-19"><a href="fitness-model.html#cb144-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb144-20"><a href="fitness-model.html#cb144-20" aria-hidden="true" tabindex="-1"></a><span class="do">#####################################################################</span></span>
<span id="cb144-21"><a href="fitness-model.html#cb144-21" aria-hidden="true" tabindex="-1"></a><span class="co">#Parameter values</span></span>
<span id="cb144-22"><a href="fitness-model.html#cb144-22" aria-hidden="true" tabindex="-1"></a><span class="do">#####################################################################</span></span>
<span id="cb144-23"><a href="fitness-model.html#cb144-23" aria-hidden="true" tabindex="-1"></a>alpha_0 <span class="ot">=</span> <span class="dv">0</span> <span class="co">#global intercept</span></span>
<span id="cb144-24"><a href="fitness-model.html#cb144-24" aria-hidden="true" tabindex="-1"></a>psi_1 <span class="ot">=</span> <span class="sc">-</span><span class="fl">0.5</span> <span class="co">#population interaction coefficient</span></span>
<span id="cb144-25"><a href="fitness-model.html#cb144-25" aria-hidden="true" tabindex="-1"></a>phi <span class="ot">=</span>  <span class="fl">0.5</span> <span class="co">#residual feedback coefficient (epsilon_j ~ epsilon_t-1k)</span></span>
<span id="cb144-26"><a href="fitness-model.html#cb144-26" aria-hidden="true" tabindex="-1"></a>SD_intercept <span class="ot">=</span> <span class="fl">0.3</span> <span class="co">#standard deviation of SRN intercepts</span></span>
<span id="cb144-27"><a href="fitness-model.html#cb144-27" aria-hidden="true" tabindex="-1"></a>SD_slope <span class="ot">=</span> <span class="fl">0.3</span> <span class="co">#SD of SRN slopes</span></span>
<span id="cb144-28"><a href="fitness-model.html#cb144-28" aria-hidden="true" tabindex="-1"></a>r_alpha <span class="ot">=</span> <span class="fl">0.3</span> <span class="co">#assortment coefficient (expressed as correlation)</span></span>
<span id="cb144-29"><a href="fitness-model.html#cb144-29" aria-hidden="true" tabindex="-1"></a>r_G <span class="ot">=</span> <span class="fl">0.3</span> <span class="co">#genetic correlation of random intercepts and slopes</span></span>
<span id="cb144-30"><a href="fitness-model.html#cb144-30" aria-hidden="true" tabindex="-1"></a>r_E <span class="ot">=</span> <span class="fl">0.3</span> <span class="co">#environmental correlation</span></span>
<span id="cb144-31"><a href="fitness-model.html#cb144-31" aria-hidden="true" tabindex="-1"></a>r_R <span class="ot">=</span> <span class="sc">-</span><span class="fl">0.3</span> <span class="co">#residual effect correlation (epsilon_tj = epsilon_tk)</span></span>
<span id="cb144-32"><a href="fitness-model.html#cb144-32" aria-hidden="true" tabindex="-1"></a>V_G <span class="ot">=</span> <span class="fl">0.3</span> <span class="co">#genetic variance of REs</span></span>
<span id="cb144-33"><a href="fitness-model.html#cb144-33" aria-hidden="true" tabindex="-1"></a>V_E <span class="ot">=</span> <span class="fl">0.3</span> <span class="co">#genetic variance of REs</span></span>
<span id="cb144-34"><a href="fitness-model.html#cb144-34" aria-hidden="true" tabindex="-1"></a>res_V <span class="ot">=</span> <span class="dv">1</span></span>
<span id="cb144-35"><a href="fitness-model.html#cb144-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb144-36"><a href="fitness-model.html#cb144-36" aria-hidden="true" tabindex="-1"></a><span class="co">#Random effect correlations</span></span>
<span id="cb144-37"><a href="fitness-model.html#cb144-37" aria-hidden="true" tabindex="-1"></a>G_cor <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">c</span>(<span class="dv">1</span>,r_G,r_G,<span class="dv">1</span>), <span class="at">nrow=</span><span class="dv">2</span>, <span class="at">ncol=</span><span class="dv">2</span>) <span class="co">#mu_A, beta_A</span></span>
<span id="cb144-38"><a href="fitness-model.html#cb144-38" aria-hidden="true" tabindex="-1"></a>G_sd  <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fu">sqrt</span>(V_G),<span class="fu">sqrt</span>(V_G)) <span class="co">#G effect sds</span></span>
<span id="cb144-39"><a href="fitness-model.html#cb144-39" aria-hidden="true" tabindex="-1"></a>G_cov <span class="ot">&lt;-</span> <span class="fu">diag</span>(G_sd) <span class="sc">%*%</span> G_cor <span class="sc">%*%</span> <span class="fu">diag</span>(G_sd)</span>
<span id="cb144-40"><a href="fitness-model.html#cb144-40" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb144-41"><a href="fitness-model.html#cb144-41" aria-hidden="true" tabindex="-1"></a>E_cor <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">c</span>(<span class="dv">1</span>,r_E,r_E,<span class="dv">1</span>), <span class="at">nrow=</span><span class="dv">2</span>, <span class="at">ncol=</span><span class="dv">2</span>) <span class="co">#mu_E, beta_E</span></span>
<span id="cb144-42"><a href="fitness-model.html#cb144-42" aria-hidden="true" tabindex="-1"></a>E_sd  <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fu">sqrt</span>(V_E),<span class="fu">sqrt</span>(V_E)) <span class="co">#E effect sds</span></span>
<span id="cb144-43"><a href="fitness-model.html#cb144-43" aria-hidden="true" tabindex="-1"></a>E_cov <span class="ot">&lt;-</span> <span class="fu">diag</span>(E_sd) <span class="sc">%*%</span> E_cor <span class="sc">%*%</span> <span class="fu">diag</span>(E_sd)</span>
<span id="cb144-44"><a href="fitness-model.html#cb144-44" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb144-45"><a href="fitness-model.html#cb144-45" aria-hidden="true" tabindex="-1"></a><span class="co">#matrices</span></span>
<span id="cb144-46"><a href="fitness-model.html#cb144-46" aria-hidden="true" tabindex="-1"></a>G_block <span class="ot">&lt;-</span> G_cov <span class="sc">%x%</span> A_mat</span>
<span id="cb144-47"><a href="fitness-model.html#cb144-47" aria-hidden="true" tabindex="-1"></a>E_block <span class="ot">&lt;-</span> E_cov <span class="sc">%x%</span> <span class="fu">diag</span>(<span class="dv">1</span>,I)</span>
<span id="cb144-48"><a href="fitness-model.html#cb144-48" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb144-49"><a href="fitness-model.html#cb144-49" aria-hidden="true" tabindex="-1"></a><span class="co">#generate correlated REs</span></span>
<span id="cb144-50"><a href="fitness-model.html#cb144-50" aria-hidden="true" tabindex="-1"></a>Gvalues <span class="ot">&lt;-</span> <span class="fu">rmvnorm</span>(<span class="dv">1</span>, <span class="at">mean=</span><span class="fu">rep</span>(<span class="dv">0</span>,I<span class="sc">*</span><span class="dv">2</span>), <span class="at">sigma=</span>G_block)</span>
<span id="cb144-51"><a href="fitness-model.html#cb144-51" aria-hidden="true" tabindex="-1"></a>G_val <span class="ot">=</span> <span class="fu">data.frame</span>(<span class="fu">matrix</span>(Gvalues, <span class="at">nrow=</span>I, <span class="at">ncol=</span><span class="dv">2</span>))</span>
<span id="cb144-52"><a href="fitness-model.html#cb144-52" aria-hidden="true" tabindex="-1"></a><span class="fu">cor</span>(G_val)</span></code></pre></div>
<pre><code>##          X1       X2
## X1 1.000000 0.198498
## X2 0.198498 1.000000</code></pre>
<div class="sourceCode" id="cb146"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb146-1"><a href="fitness-model.html#cb146-1" aria-hidden="true" tabindex="-1"></a>Evalues <span class="ot">&lt;-</span> <span class="fu">rmvnorm</span>(<span class="dv">1</span>, <span class="at">mean=</span><span class="fu">rep</span>(<span class="dv">0</span>,I<span class="sc">*</span><span class="dv">2</span>), <span class="at">sigma=</span>E_block)</span>
<span id="cb146-2"><a href="fitness-model.html#cb146-2" aria-hidden="true" tabindex="-1"></a>E_val <span class="ot">=</span> <span class="fu">data.frame</span>(<span class="fu">matrix</span>(Evalues, <span class="at">nrow=</span>I, <span class="at">ncol=</span><span class="dv">2</span>))</span>
<span id="cb146-3"><a href="fitness-model.html#cb146-3" aria-hidden="true" tabindex="-1"></a><span class="fu">cor</span>(E_val)</span></code></pre></div>
<pre><code>##           X1        X2
## X1 1.0000000 0.3342701
## X2 0.3342701 1.0000000</code></pre>
<div class="sourceCode" id="cb148"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb148-1"><a href="fitness-model.html#cb148-1" aria-hidden="true" tabindex="-1"></a><span class="co">#combine temporary object for all SRN parameters</span></span>
<span id="cb148-2"><a href="fitness-model.html#cb148-2" aria-hidden="true" tabindex="-1"></a><span class="co">#use shorthand mu = 0, psi = 1</span></span>
<span id="cb148-3"><a href="fitness-model.html#cb148-3" aria-hidden="true" tabindex="-1"></a>P <span class="ot">=</span> <span class="fu">cbind</span>(G_val,E_val)</span>
<span id="cb148-4"><a href="fitness-model.html#cb148-4" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(P) <span class="ot">=</span> <span class="fu">c</span>(<span class="st">&quot;A0&quot;</span>, <span class="st">&quot;A1&quot;</span>, <span class="st">&quot;E0&quot;</span>, <span class="st">&quot;E1&quot;</span>)</span>
<span id="cb148-5"><a href="fitness-model.html#cb148-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb148-6"><a href="fitness-model.html#cb148-6" aria-hidden="true" tabindex="-1"></a><span class="co">#individual phenotypic REs</span></span>
<span id="cb148-7"><a href="fitness-model.html#cb148-7" aria-hidden="true" tabindex="-1"></a><span class="co">#use shorthand mu = 0, psi = 1</span></span>
<span id="cb148-8"><a href="fitness-model.html#cb148-8" aria-hidden="true" tabindex="-1"></a>P<span class="sc">$</span>P0 <span class="ot">=</span> P<span class="sc">$</span>A0 <span class="sc">+</span> P<span class="sc">$</span>E0 </span>
<span id="cb148-9"><a href="fitness-model.html#cb148-9" aria-hidden="true" tabindex="-1"></a>P<span class="sc">$</span>P1 <span class="ot">=</span> P<span class="sc">$</span>A1 <span class="sc">+</span> P<span class="sc">$</span>E1</span>
<span id="cb148-10"><a href="fitness-model.html#cb148-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb148-11"><a href="fitness-model.html#cb148-11" aria-hidden="true" tabindex="-1"></a><span class="co">#add ID</span></span>
<span id="cb148-12"><a href="fitness-model.html#cb148-12" aria-hidden="true" tabindex="-1"></a>P<span class="sc">$</span>ID <span class="ot">=</span> <span class="fu">seq</span>(<span class="dv">1</span><span class="sc">:</span>I)</span>
<span id="cb148-13"><a href="fitness-model.html#cb148-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb148-14"><a href="fitness-model.html#cb148-14" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb148-15"><a href="fitness-model.html#cb148-15" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(MASS)</span>
<span id="cb148-16"><a href="fitness-model.html#cb148-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb148-17"><a href="fitness-model.html#cb148-17" aria-hidden="true" tabindex="-1"></a>pairs <span class="ot">=</span> <span class="fu">list</span>()</span>
<span id="cb148-18"><a href="fitness-model.html#cb148-18" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (j <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>I_partner){</span>
<span id="cb148-19"><a href="fitness-model.html#cb148-19" aria-hidden="true" tabindex="-1"></a>    <span class="co">#male additive genetic RN slopes (x I_partner for multiple lifetime partners)</span></span>
<span id="cb148-20"><a href="fitness-model.html#cb148-20" aria-hidden="true" tabindex="-1"></a>    sort.m <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">P1_m =</span> P<span class="sc">$</span>P1[<span class="dv">1</span><span class="sc">:</span>(I<span class="sc">/</span><span class="dv">2</span>)], <span class="at">ID_m =</span> (<span class="dv">1</span><span class="sc">:</span>(I<span class="sc">/</span><span class="dv">2</span>)) )</span>
<span id="cb148-21"><a href="fitness-model.html#cb148-21" aria-hidden="true" tabindex="-1"></a>    sort.m<span class="ot">&lt;-</span>sort.m[<span class="fu">order</span>(sort.m[,<span class="st">&quot;P1_m&quot;</span>]),]</span>
<span id="cb148-22"><a href="fitness-model.html#cb148-22" aria-hidden="true" tabindex="-1"></a>    <span class="co">#female phenotypic RN slopes</span></span>
<span id="cb148-23"><a href="fitness-model.html#cb148-23" aria-hidden="true" tabindex="-1"></a>    sort.f <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">P1_f =</span> P<span class="sc">$</span>P1[(I<span class="sc">/</span><span class="dv">2</span> <span class="sc">+</span> <span class="dv">1</span>)<span class="sc">:</span>I], <span class="at">ID_f =</span> ((I<span class="sc">/</span><span class="dv">2</span><span class="sc">+</span><span class="dv">1</span>)<span class="sc">:</span>I) )</span>
<span id="cb148-24"><a href="fitness-model.html#cb148-24" aria-hidden="true" tabindex="-1"></a>    sort.f<span class="ot">&lt;-</span>sort.f[<span class="fu">order</span>(sort.f[,<span class="st">&quot;P1_f&quot;</span>]),]</span>
<span id="cb148-25"><a href="fitness-model.html#cb148-25" aria-hidden="true" tabindex="-1"></a>    <span class="co">#generate random dataset with desired rank-order correlation</span></span>
<span id="cb148-26"><a href="fitness-model.html#cb148-26" aria-hidden="true" tabindex="-1"></a>    temp_mat <span class="ot">&lt;-</span> <span class="fu">matrix</span>(r_alpha, <span class="at">ncol =</span> <span class="dv">2</span>, <span class="at">nrow =</span> <span class="dv">2</span>) <span class="co">#cor of male and female values</span></span>
<span id="cb148-27"><a href="fitness-model.html#cb148-27" aria-hidden="true" tabindex="-1"></a>    <span class="fu">diag</span>(temp_mat) <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="co">#cor matrix</span></span>
<span id="cb148-28"><a href="fitness-model.html#cb148-28" aria-hidden="true" tabindex="-1"></a>    <span class="co">#sim values</span></span>
<span id="cb148-29"><a href="fitness-model.html#cb148-29" aria-hidden="true" tabindex="-1"></a>    temp_data1<span class="ot">&lt;-</span>MASS<span class="sc">::</span><span class="fu">mvrnorm</span>(<span class="at">n =</span> I<span class="sc">/</span><span class="dv">2</span>, <span class="at">mu =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">0</span>), <span class="at">Sigma =</span> temp_mat, <span class="at">empirical=</span><span class="cn">TRUE</span>)</span>
<span id="cb148-30"><a href="fitness-model.html#cb148-30" aria-hidden="true" tabindex="-1"></a>    <span class="co">#ranks of random data</span></span>
<span id="cb148-31"><a href="fitness-model.html#cb148-31" aria-hidden="true" tabindex="-1"></a>    rm <span class="ot">&lt;-</span> <span class="fu">rank</span>(temp_data1[ , <span class="dv">1</span>], <span class="at">ties.method =</span> <span class="st">&quot;first&quot;</span>)</span>
<span id="cb148-32"><a href="fitness-model.html#cb148-32" aria-hidden="true" tabindex="-1"></a>    rf <span class="ot">&lt;-</span> <span class="fu">rank</span>(temp_data1[ , <span class="dv">2</span>], <span class="at">ties.method =</span> <span class="st">&quot;first&quot;</span>)</span>
<span id="cb148-33"><a href="fitness-model.html#cb148-33" aria-hidden="true" tabindex="-1"></a>    <span class="co">#induce cor through rank-ordering of RN vectors</span></span>
<span id="cb148-34"><a href="fitness-model.html#cb148-34" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cor</span>(sort.m<span class="sc">$</span>P1_m[rm], sort.f<span class="sc">$</span>P1_f[rf])</span>
<span id="cb148-35"><a href="fitness-model.html#cb148-35" aria-hidden="true" tabindex="-1"></a>    <span class="co">#sort partner ids into dataframe</span></span>
<span id="cb148-36"><a href="fitness-model.html#cb148-36" aria-hidden="true" tabindex="-1"></a>    partner.id <span class="ot">=</span> <span class="fu">data.frame</span>(<span class="at">ID_m =</span> sort.m<span class="sc">$</span>ID_m[rm], <span class="at">ID_f =</span> sort.f<span class="sc">$</span>ID_f[rf])</span>
<span id="cb148-37"><a href="fitness-model.html#cb148-37" aria-hidden="true" tabindex="-1"></a>    partner.id <span class="ot">=</span> partner.id[<span class="fu">order</span>(partner.id[,<span class="st">&quot;ID_m&quot;</span>]),]</span>
<span id="cb148-38"><a href="fitness-model.html#cb148-38" aria-hidden="true" tabindex="-1"></a>    <span class="co">#add to list</span></span>
<span id="cb148-39"><a href="fitness-model.html#cb148-39" aria-hidden="true" tabindex="-1"></a>    pairs[[j]] <span class="ot">=</span> partner.id</span>
<span id="cb148-40"><a href="fitness-model.html#cb148-40" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb148-41"><a href="fitness-model.html#cb148-41" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb148-42"><a href="fitness-model.html#cb148-42" aria-hidden="true" tabindex="-1"></a>partner.id <span class="ot">=</span> <span class="fu">bind_rows</span>(pairs)</span>
<span id="cb148-43"><a href="fitness-model.html#cb148-43" aria-hidden="true" tabindex="-1"></a>partner.id <span class="ot">=</span> partner.id[<span class="fu">order</span>(partner.id<span class="sc">$</span>ID_m),]</span>
<span id="cb148-44"><a href="fitness-model.html#cb148-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb148-45"><a href="fitness-model.html#cb148-45" aria-hidden="true" tabindex="-1"></a><span class="co">#put all dyads together</span></span>
<span id="cb148-46"><a href="fitness-model.html#cb148-46" aria-hidden="true" tabindex="-1"></a>partner.id<span class="sc">$</span>dyadn <span class="ot">=</span> <span class="fu">seq</span>(<span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(partner.id))</span>
<span id="cb148-47"><a href="fitness-model.html#cb148-47" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb148-48"><a href="fitness-model.html#cb148-48" aria-hidden="true" tabindex="-1"></a><span class="co">#add values back to dataframe (male and joint)</span></span>
<span id="cb148-49"><a href="fitness-model.html#cb148-49" aria-hidden="true" tabindex="-1"></a>partner.id<span class="sc">$</span>P0m <span class="ot">&lt;-</span> P<span class="sc">$</span>P0[<span class="fu">match</span>(partner.id<span class="sc">$</span>ID_m,P<span class="sc">$</span>ID)]</span>
<span id="cb148-50"><a href="fitness-model.html#cb148-50" aria-hidden="true" tabindex="-1"></a>partner.id<span class="sc">$</span>P0f <span class="ot">&lt;-</span> P<span class="sc">$</span>P0[<span class="fu">match</span>(partner.id<span class="sc">$</span>ID_f,P<span class="sc">$</span>ID)]</span>
<span id="cb148-51"><a href="fitness-model.html#cb148-51" aria-hidden="true" tabindex="-1"></a>partner.id<span class="sc">$</span>P1m <span class="ot">&lt;-</span> P<span class="sc">$</span>P1[<span class="fu">match</span>(partner.id<span class="sc">$</span>ID_m,P<span class="sc">$</span>ID)]</span>
<span id="cb148-52"><a href="fitness-model.html#cb148-52" aria-hidden="true" tabindex="-1"></a>partner.id<span class="sc">$</span>P1f <span class="ot">&lt;-</span> P<span class="sc">$</span>P1[<span class="fu">match</span>(partner.id<span class="sc">$</span>ID_f,P<span class="sc">$</span>ID)]</span>
<span id="cb148-53"><a href="fitness-model.html#cb148-53" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb148-54"><a href="fitness-model.html#cb148-54" aria-hidden="true" tabindex="-1"></a>partner.id<span class="sc">$</span>A0m <span class="ot">&lt;-</span> P<span class="sc">$</span>A0[<span class="fu">match</span>(partner.id<span class="sc">$</span>ID_m,P<span class="sc">$</span>ID)]</span>
<span id="cb148-55"><a href="fitness-model.html#cb148-55" aria-hidden="true" tabindex="-1"></a>partner.id<span class="sc">$</span>A0f <span class="ot">&lt;-</span> P<span class="sc">$</span>A0[<span class="fu">match</span>(partner.id<span class="sc">$</span>ID_f,P<span class="sc">$</span>ID)]</span>
<span id="cb148-56"><a href="fitness-model.html#cb148-56" aria-hidden="true" tabindex="-1"></a>partner.id<span class="sc">$</span>A1m <span class="ot">&lt;-</span> P<span class="sc">$</span>A1[<span class="fu">match</span>(partner.id<span class="sc">$</span>ID_m,P<span class="sc">$</span>ID)]</span>
<span id="cb148-57"><a href="fitness-model.html#cb148-57" aria-hidden="true" tabindex="-1"></a>partner.id<span class="sc">$</span>A1f <span class="ot">&lt;-</span> P<span class="sc">$</span>A1[<span class="fu">match</span>(partner.id<span class="sc">$</span>ID_f,P<span class="sc">$</span>ID)]</span>
<span id="cb148-58"><a href="fitness-model.html#cb148-58" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb148-59"><a href="fitness-model.html#cb148-59" aria-hidden="true" tabindex="-1"></a>partner.id<span class="sc">$</span>E0m <span class="ot">&lt;-</span> P<span class="sc">$</span>E0[<span class="fu">match</span>(partner.id<span class="sc">$</span>ID_m,P<span class="sc">$</span>ID)]</span>
<span id="cb148-60"><a href="fitness-model.html#cb148-60" aria-hidden="true" tabindex="-1"></a>partner.id<span class="sc">$</span>E0f <span class="ot">&lt;-</span> P<span class="sc">$</span>E0[<span class="fu">match</span>(partner.id<span class="sc">$</span>ID_f,P<span class="sc">$</span>ID)]</span>
<span id="cb148-61"><a href="fitness-model.html#cb148-61" aria-hidden="true" tabindex="-1"></a>partner.id<span class="sc">$</span>E1m <span class="ot">&lt;-</span> P<span class="sc">$</span>E1[<span class="fu">match</span>(partner.id<span class="sc">$</span>ID_m,P<span class="sc">$</span>ID)]</span>
<span id="cb148-62"><a href="fitness-model.html#cb148-62" aria-hidden="true" tabindex="-1"></a>partner.id<span class="sc">$</span>E1f <span class="ot">&lt;-</span> P<span class="sc">$</span>E1[<span class="fu">match</span>(partner.id<span class="sc">$</span>ID_f,P<span class="sc">$</span>ID)]</span>
<span id="cb148-63"><a href="fitness-model.html#cb148-63" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb148-64"><a href="fitness-model.html#cb148-64" aria-hidden="true" tabindex="-1"></a><span class="co">#check correlation again</span></span>
<span id="cb148-65"><a href="fitness-model.html#cb148-65" aria-hidden="true" tabindex="-1"></a><span class="fu">cor</span>(partner.id<span class="sc">$</span>P1m, partner.id<span class="sc">$</span>P1f)</span></code></pre></div>
<pre><code>## [1] 0.3030801</code></pre>
<div class="sourceCode" id="cb150"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb150-1"><a href="fitness-model.html#cb150-1" aria-hidden="true" tabindex="-1"></a><span class="co">#calculate mean partner phenotype for each subject</span></span>
<span id="cb150-2"><a href="fitness-model.html#cb150-2" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb150-3"><a href="fitness-model.html#cb150-3" aria-hidden="true" tabindex="-1"></a>  <span class="co">#average female for male partners</span></span>
<span id="cb150-4"><a href="fitness-model.html#cb150-4" aria-hidden="true" tabindex="-1"></a>  mean_0m <span class="ot">&lt;-</span> <span class="fu">aggregate</span>(P0f <span class="sc">~</span> ID_m, mean, <span class="at">data =</span> partner.id)</span>
<span id="cb150-5"><a href="fitness-model.html#cb150-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">names</span>(mean_0m)[<span class="dv">2</span>] <span class="ot">&lt;-</span> <span class="st">&quot;meanP0m&quot;</span></span>
<span id="cb150-6"><a href="fitness-model.html#cb150-6" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb150-7"><a href="fitness-model.html#cb150-7" aria-hidden="true" tabindex="-1"></a>  mean_1m <span class="ot">&lt;-</span> <span class="fu">aggregate</span>(P1f <span class="sc">~</span> ID_m, mean, <span class="at">data =</span> partner.id)</span>
<span id="cb150-8"><a href="fitness-model.html#cb150-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">names</span>(mean_1m)[<span class="dv">2</span>] <span class="ot">&lt;-</span> <span class="st">&quot;meanP1m&quot;</span></span>
<span id="cb150-9"><a href="fitness-model.html#cb150-9" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb150-10"><a href="fitness-model.html#cb150-10" aria-hidden="true" tabindex="-1"></a>  partner.id<span class="sc">$</span>meanP0m <span class="ot">&lt;-</span> mean_0m<span class="sc">$</span>meanP0m[<span class="fu">match</span>(partner.id<span class="sc">$</span>ID_m,mean_0m<span class="sc">$</span>ID_m)]</span>
<span id="cb150-11"><a href="fitness-model.html#cb150-11" aria-hidden="true" tabindex="-1"></a>  partner.id<span class="sc">$</span>meanP1m <span class="ot">&lt;-</span> mean_1m<span class="sc">$</span>meanP1m[<span class="fu">match</span>(partner.id<span class="sc">$</span>ID_m,mean_1m<span class="sc">$</span>ID_m)]</span>
<span id="cb150-12"><a href="fitness-model.html#cb150-12" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb150-13"><a href="fitness-model.html#cb150-13" aria-hidden="true" tabindex="-1"></a>  <span class="co">#average male for female partners</span></span>
<span id="cb150-14"><a href="fitness-model.html#cb150-14" aria-hidden="true" tabindex="-1"></a>  mean_0f <span class="ot">&lt;-</span> <span class="fu">aggregate</span>(P0m <span class="sc">~</span> ID_f, mean, <span class="at">data =</span> partner.id)</span>
<span id="cb150-15"><a href="fitness-model.html#cb150-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">names</span>(mean_0f)[<span class="dv">2</span>] <span class="ot">&lt;-</span> <span class="st">&quot;meanP0f&quot;</span></span>
<span id="cb150-16"><a href="fitness-model.html#cb150-16" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb150-17"><a href="fitness-model.html#cb150-17" aria-hidden="true" tabindex="-1"></a>  mean_1f <span class="ot">&lt;-</span> <span class="fu">aggregate</span>(P1m <span class="sc">~</span> ID_f, mean, <span class="at">data =</span> partner.id)</span>
<span id="cb150-18"><a href="fitness-model.html#cb150-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">names</span>(mean_1f)[<span class="dv">2</span>] <span class="ot">&lt;-</span> <span class="st">&quot;meanP1f&quot;</span></span>
<span id="cb150-19"><a href="fitness-model.html#cb150-19" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb150-20"><a href="fitness-model.html#cb150-20" aria-hidden="true" tabindex="-1"></a>  partner.id<span class="sc">$</span>meanP0f <span class="ot">&lt;-</span> mean_0f<span class="sc">$</span>meanP0f[<span class="fu">match</span>(partner.id<span class="sc">$</span>ID_f,mean_0f<span class="sc">$</span>ID_f)]</span>
<span id="cb150-21"><a href="fitness-model.html#cb150-21" aria-hidden="true" tabindex="-1"></a>  partner.id<span class="sc">$</span>meanP1f <span class="ot">&lt;-</span> mean_1f<span class="sc">$</span>meanP1f[<span class="fu">match</span>(partner.id<span class="sc">$</span>ID_f,mean_1f<span class="sc">$</span>ID_f)]</span>
<span id="cb150-22"><a href="fitness-model.html#cb150-22" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb150-23"><a href="fitness-model.html#cb150-23" aria-hidden="true" tabindex="-1"></a>  <span class="co">#number of dyads</span></span>
<span id="cb150-24"><a href="fitness-model.html#cb150-24" aria-hidden="true" tabindex="-1"></a>  ndyad <span class="ot">=</span> <span class="fu">nrow</span>(partner.id)</span>
<span id="cb150-25"><a href="fitness-model.html#cb150-25" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb150-26"><a href="fitness-model.html#cb150-26" aria-hidden="true" tabindex="-1"></a>  <span class="co">#expand for repeated measures</span></span>
<span id="cb150-27"><a href="fitness-model.html#cb150-27" aria-hidden="true" tabindex="-1"></a>  partner.id<span class="sc">$</span>rep <span class="ot">&lt;-</span> I_obs</span>
<span id="cb150-28"><a href="fitness-model.html#cb150-28" aria-hidden="true" tabindex="-1"></a>  pair_df <span class="ot">&lt;-</span> partner.id[<span class="fu">rep</span>(<span class="fu">row.names</span>(partner.id), partner.id<span class="sc">$</span>rep),]</span>
<span id="cb150-29"><a href="fitness-model.html#cb150-29" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb150-30"><a href="fitness-model.html#cb150-30" aria-hidden="true" tabindex="-1"></a>  <span class="co">#correlations</span></span>
<span id="cb150-31"><a href="fitness-model.html#cb150-31" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cor</span>(partner.id<span class="sc">$</span>P0m, partner.id<span class="sc">$</span>P0f)</span></code></pre></div>
<pre><code>## [1] 0.05911671</code></pre>
<div class="sourceCode" id="cb152"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb152-1"><a href="fitness-model.html#cb152-1" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cor</span>(partner.id<span class="sc">$</span>P1m, partner.id<span class="sc">$</span>P0f)</span></code></pre></div>
<pre><code>## [1] 0.1148086</code></pre>
<div class="sourceCode" id="cb154"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb154-1"><a href="fitness-model.html#cb154-1" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cor</span>(partner.id<span class="sc">$</span>P0m, partner.id<span class="sc">$</span>P1f)</span></code></pre></div>
<pre><code>## [1] 0.05707536</code></pre>
<div class="sourceCode" id="cb156"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb156-1"><a href="fitness-model.html#cb156-1" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cor</span>(partner.id<span class="sc">$</span>P1m, partner.id<span class="sc">$</span>P1f)</span></code></pre></div>
<pre><code>## [1] 0.3030801</code></pre>
<div class="sourceCode" id="cb158"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb158-1"><a href="fitness-model.html#cb158-1" aria-hidden="true" tabindex="-1"></a><span class="do">#####################################################################</span></span>
<span id="cb158-2"><a href="fitness-model.html#cb158-2" aria-hidden="true" tabindex="-1"></a><span class="co">#Additional effects</span></span>
<span id="cb158-3"><a href="fitness-model.html#cb158-3" aria-hidden="true" tabindex="-1"></a><span class="do">#####################################################################</span></span>
<span id="cb158-4"><a href="fitness-model.html#cb158-4" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb158-5"><a href="fitness-model.html#cb158-5" aria-hidden="true" tabindex="-1"></a><span class="co">#correlated  residuals between male and females</span></span>
<span id="cb158-6"><a href="fitness-model.html#cb158-6" aria-hidden="true" tabindex="-1"></a>R_cor <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">c</span>(<span class="dv">1</span>,r_R,r_R,<span class="dv">1</span>), <span class="at">nrow=</span><span class="dv">2</span>, <span class="at">ncol=</span><span class="dv">2</span>)</span>
<span id="cb158-7"><a href="fitness-model.html#cb158-7" aria-hidden="true" tabindex="-1"></a>res_sd <span class="ot">&lt;-</span> <span class="fu">sqrt</span>(res_V)</span>
<span id="cb158-8"><a href="fitness-model.html#cb158-8" aria-hidden="true" tabindex="-1"></a>R_cov <span class="ot">&lt;-</span> <span class="fu">diag</span>(<span class="fu">c</span>(res_sd,res_sd)) <span class="sc">%*%</span> R_cor <span class="sc">%*%</span> <span class="fu">diag</span>(<span class="fu">c</span>(res_sd,res_sd))</span>
<span id="cb158-9"><a href="fitness-model.html#cb158-9" aria-hidden="true" tabindex="-1"></a>res_ind<span class="ot">&lt;-</span><span class="fu">data.frame</span>(<span class="fu">rmvnorm</span>(<span class="fu">nrow</span>(pair_df), <span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">0</span>), R_cov))</span>
<span id="cb158-10"><a href="fitness-model.html#cb158-10" aria-hidden="true" tabindex="-1"></a>pair_df<span class="sc">$</span>resAGm <span class="ot">=</span> res_ind<span class="sc">$</span>X1</span>
<span id="cb158-11"><a href="fitness-model.html#cb158-11" aria-hidden="true" tabindex="-1"></a>pair_df<span class="sc">$</span>resAGf <span class="ot">=</span> res_ind<span class="sc">$</span>X2</span>
<span id="cb158-12"><a href="fitness-model.html#cb158-12" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb158-13"><a href="fitness-model.html#cb158-13" aria-hidden="true" tabindex="-1"></a><span class="do">#####################################################################</span></span>
<span id="cb158-14"><a href="fitness-model.html#cb158-14" aria-hidden="true" tabindex="-1"></a><span class="co">#Simulate responses over t = {1,2} per partner</span></span>
<span id="cb158-15"><a href="fitness-model.html#cb158-15" aria-hidden="true" tabindex="-1"></a><span class="do">#####################################################################</span></span>
<span id="cb158-16"><a href="fitness-model.html#cb158-16" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb158-17"><a href="fitness-model.html#cb158-17" aria-hidden="true" tabindex="-1"></a><span class="co">#add interaction number</span></span>
<span id="cb158-18"><a href="fitness-model.html#cb158-18" aria-hidden="true" tabindex="-1"></a>pair_df<span class="sc">$</span>turn <span class="ot">=</span> <span class="fu">rep</span>(<span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">2</span>),ndyad) </span>
<span id="cb158-19"><a href="fitness-model.html#cb158-19" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb158-20"><a href="fitness-model.html#cb158-20" aria-hidden="true" tabindex="-1"></a><span class="co">#average male social environment at time = 1</span></span>
<span id="cb158-21"><a href="fitness-model.html#cb158-21" aria-hidden="true" tabindex="-1"></a>pair_df[pair_df<span class="sc">$</span>turn<span class="sc">==</span><span class="dv">1</span>,<span class="st">&quot;meaneta_m&quot;</span>] <span class="ot">=</span>  pair_df[pair_df<span class="sc">$</span>turn<span class="sc">==</span><span class="dv">1</span>,<span class="st">&quot;meanP0m&quot;</span>] <span class="sc">+</span> </span>
<span id="cb158-22"><a href="fitness-model.html#cb158-22" aria-hidden="true" tabindex="-1"></a>  (psi_1 <span class="sc">+</span> pair_df[pair_df<span class="sc">$</span>turn<span class="sc">==</span><span class="dv">1</span>,<span class="st">&quot;meanP1m&quot;</span>])<span class="sc">*</span>(pair_df[pair_df<span class="sc">$</span>turn<span class="sc">==</span><span class="dv">1</span>,<span class="st">&quot;P0m&quot;</span>])</span>
<span id="cb158-23"><a href="fitness-model.html#cb158-23" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb158-24"><a href="fitness-model.html#cb158-24" aria-hidden="true" tabindex="-1"></a><span class="co">#average female social environment at time = 1</span></span>
<span id="cb158-25"><a href="fitness-model.html#cb158-25" aria-hidden="true" tabindex="-1"></a>pair_df[pair_df<span class="sc">$</span>turn<span class="sc">==</span><span class="dv">1</span>,<span class="st">&quot;meaneta_f&quot;</span>] <span class="ot">=</span>  pair_df[pair_df<span class="sc">$</span>turn<span class="sc">==</span><span class="dv">1</span>,<span class="st">&quot;meanP0f&quot;</span>] <span class="sc">+</span> </span>
<span id="cb158-26"><a href="fitness-model.html#cb158-26" aria-hidden="true" tabindex="-1"></a>  (psi_1 <span class="sc">+</span> pair_df[pair_df<span class="sc">$</span>turn<span class="sc">==</span><span class="dv">1</span>,<span class="st">&quot;meanP1f&quot;</span>])<span class="sc">*</span>(pair_df[pair_df<span class="sc">$</span>turn<span class="sc">==</span><span class="dv">1</span>,<span class="st">&quot;P0f&quot;</span>])</span>
<span id="cb158-27"><a href="fitness-model.html#cb158-27" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb158-28"><a href="fitness-model.html#cb158-28" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb158-29"><a href="fitness-model.html#cb158-29" aria-hidden="true" tabindex="-1"></a><span class="co">#individual prediction at t = 1</span></span>
<span id="cb158-30"><a href="fitness-model.html#cb158-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb158-31"><a href="fitness-model.html#cb158-31" aria-hidden="true" tabindex="-1"></a>  <span class="co">#males</span></span>
<span id="cb158-32"><a href="fitness-model.html#cb158-32" aria-hidden="true" tabindex="-1"></a>  <span class="co">#eta_j{t=1} = mu_j + psi_j*(mu_k - mu_meanK)</span></span>
<span id="cb158-33"><a href="fitness-model.html#cb158-33" aria-hidden="true" tabindex="-1"></a>  pair_df[pair_df<span class="sc">$</span>turn<span class="sc">==</span><span class="dv">1</span>,<span class="st">&quot;eta_m&quot;</span>] <span class="ot">=</span> pair_df[pair_df<span class="sc">$</span>turn<span class="sc">==</span><span class="dv">1</span>,<span class="st">&quot;P0m&quot;</span>] <span class="sc">+</span> </span>
<span id="cb158-34"><a href="fitness-model.html#cb158-34" aria-hidden="true" tabindex="-1"></a>  (psi_1 <span class="sc">+</span> pair_df[pair_df<span class="sc">$</span>turn<span class="sc">==</span><span class="dv">1</span>,<span class="st">&quot;P1m&quot;</span>])<span class="sc">*</span>(pair_df[pair_df<span class="sc">$</span>turn<span class="sc">==</span><span class="dv">1</span>,<span class="st">&quot;P0f&quot;</span>])</span>
<span id="cb158-35"><a href="fitness-model.html#cb158-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb158-36"><a href="fitness-model.html#cb158-36" aria-hidden="true" tabindex="-1"></a>  <span class="co">#females</span></span>
<span id="cb158-37"><a href="fitness-model.html#cb158-37" aria-hidden="true" tabindex="-1"></a>  <span class="co">#eta_k{t=1} = mu_k + psi_k*(mu_j - mu_meanJ)                                                                                                              </span></span>
<span id="cb158-38"><a href="fitness-model.html#cb158-38" aria-hidden="true" tabindex="-1"></a>  pair_df[pair_df<span class="sc">$</span>turn<span class="sc">==</span><span class="dv">1</span>,<span class="st">&quot;eta_f&quot;</span>] <span class="ot">=</span> pair_df[pair_df<span class="sc">$</span>turn<span class="sc">==</span><span class="dv">1</span>,<span class="st">&quot;P0f&quot;</span>] <span class="sc">+</span> </span>
<span id="cb158-39"><a href="fitness-model.html#cb158-39" aria-hidden="true" tabindex="-1"></a>  (psi_1 <span class="sc">+</span> pair_df[pair_df<span class="sc">$</span>turn<span class="sc">==</span><span class="dv">1</span>,<span class="st">&quot;P1f&quot;</span>])<span class="sc">*</span>(pair_df[pair_df<span class="sc">$</span>turn<span class="sc">==</span><span class="dv">1</span>,<span class="st">&quot;P0m&quot;</span>])</span>
<span id="cb158-40"><a href="fitness-model.html#cb158-40" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb158-41"><a href="fitness-model.html#cb158-41" aria-hidden="true" tabindex="-1"></a><span class="co">#individual prediction at t = 2</span></span>
<span id="cb158-42"><a href="fitness-model.html#cb158-42" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb158-43"><a href="fitness-model.html#cb158-43" aria-hidden="true" tabindex="-1"></a>  <span class="co">#eta_j{t=2} = mu_j + psi_j*(eta_k{t=1} - eta_meanK{t=1})</span></span>
<span id="cb158-44"><a href="fitness-model.html#cb158-44" aria-hidden="true" tabindex="-1"></a>  pair_df[pair_df<span class="sc">$</span>turn<span class="sc">==</span><span class="dv">2</span>,<span class="st">&quot;eta_m&quot;</span>] <span class="ot">=</span> pair_df[pair_df<span class="sc">$</span>turn<span class="sc">==</span><span class="dv">2</span>,<span class="st">&quot;P0m&quot;</span>] <span class="sc">+</span></span>
<span id="cb158-45"><a href="fitness-model.html#cb158-45" aria-hidden="true" tabindex="-1"></a>    (psi_1 <span class="sc">+</span> pair_df[pair_df<span class="sc">$</span>turn<span class="sc">==</span><span class="dv">2</span>,<span class="st">&quot;P1m&quot;</span>])<span class="sc">*</span>(pair_df[pair_df<span class="sc">$</span>turn<span class="sc">==</span><span class="dv">1</span>,<span class="st">&quot;eta_f&quot;</span>])</span>
<span id="cb158-46"><a href="fitness-model.html#cb158-46" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb158-47"><a href="fitness-model.html#cb158-47" aria-hidden="true" tabindex="-1"></a>  <span class="co">#females</span></span>
<span id="cb158-48"><a href="fitness-model.html#cb158-48" aria-hidden="true" tabindex="-1"></a>  pair_df[pair_df<span class="sc">$</span>turn<span class="sc">==</span><span class="dv">2</span>,<span class="st">&quot;eta_f&quot;</span>] <span class="ot">=</span> pair_df[pair_df<span class="sc">$</span>turn<span class="sc">==</span><span class="dv">2</span>,<span class="st">&quot;P0f&quot;</span>] <span class="sc">+</span> </span>
<span id="cb158-49"><a href="fitness-model.html#cb158-49" aria-hidden="true" tabindex="-1"></a>    (psi_1 <span class="sc">+</span> pair_df[pair_df<span class="sc">$</span>turn<span class="sc">==</span><span class="dv">2</span>,<span class="st">&quot;P1f&quot;</span>])<span class="sc">*</span>(pair_df[pair_df<span class="sc">$</span>turn<span class="sc">==</span><span class="dv">1</span>,<span class="st">&quot;eta_m&quot;</span>])</span>
<span id="cb158-50"><a href="fitness-model.html#cb158-50" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb158-51"><a href="fitness-model.html#cb158-51" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb158-52"><a href="fitness-model.html#cb158-52" aria-hidden="true" tabindex="-1"></a>  <span class="co">#add intercept and residual</span></span>
<span id="cb158-53"><a href="fitness-model.html#cb158-53" aria-hidden="true" tabindex="-1"></a>  pair_df<span class="sc">$</span>AG_m <span class="ot">=</span> alpha_0 <span class="sc">+</span> pair_df<span class="sc">$</span>eta_m <span class="sc">+</span> pair_df<span class="sc">$</span>resAGm</span>
<span id="cb158-54"><a href="fitness-model.html#cb158-54" aria-hidden="true" tabindex="-1"></a>  pair_df<span class="sc">$</span>AG_f <span class="ot">=</span> alpha_0 <span class="sc">+</span> pair_df<span class="sc">$</span>eta_f <span class="sc">+</span> pair_df<span class="sc">$</span>resAGf</span>
<span id="cb158-55"><a href="fitness-model.html#cb158-55" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb158-56"><a href="fitness-model.html#cb158-56" aria-hidden="true" tabindex="-1"></a>  <span class="co">#add residual feedback</span></span>
<span id="cb158-57"><a href="fitness-model.html#cb158-57" aria-hidden="true" tabindex="-1"></a>  pair_df[pair_df<span class="sc">$</span>turn<span class="sc">==</span><span class="dv">2</span>,<span class="st">&quot;AG_m&quot;</span>] <span class="ot">=</span> pair_df[pair_df<span class="sc">$</span>turn<span class="sc">==</span><span class="dv">2</span>,<span class="st">&quot;AG_m&quot;</span>] <span class="sc">+</span> phi <span class="sc">*</span> pair_df[pair_df<span class="sc">$</span>turn<span class="sc">==</span><span class="dv">1</span>,<span class="st">&quot;resAGf&quot;</span>]</span>
<span id="cb158-58"><a href="fitness-model.html#cb158-58" aria-hidden="true" tabindex="-1"></a>  pair_df[pair_df<span class="sc">$</span>turn<span class="sc">==</span><span class="dv">2</span>,<span class="st">&quot;AG_f&quot;</span>] <span class="ot">=</span> pair_df[pair_df<span class="sc">$</span>turn<span class="sc">==</span><span class="dv">2</span>,<span class="st">&quot;AG_f&quot;</span>] <span class="sc">+</span> phi <span class="sc">*</span> pair_df[pair_df<span class="sc">$</span>turn<span class="sc">==</span><span class="dv">1</span>,<span class="st">&quot;resAGm&quot;</span>]</span></code></pre></div>
<p>We can now simulate the relative fitness measure for each dyad during their interaction. We set the regression coefficients for moderate effect sizes.</p>
<div class="sourceCode" id="cb159"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb159-1"><a href="fitness-model.html#cb159-1" aria-hidden="true" tabindex="-1"></a><span class="co">#set coefficients</span></span>
<span id="cb159-2"><a href="fitness-model.html#cb159-2" aria-hidden="true" tabindex="-1"></a>nu_0 <span class="ot">=</span> <span class="dv">1</span> <span class="co">#relative fitness intercept</span></span>
<span id="cb159-3"><a href="fitness-model.html#cb159-3" aria-hidden="true" tabindex="-1"></a>beta_n1 <span class="ot">=</span> <span class="fl">0.3</span></span>
<span id="cb159-4"><a href="fitness-model.html#cb159-4" aria-hidden="true" tabindex="-1"></a>beta_n2 <span class="ot">=</span> <span class="sc">-</span><span class="fl">0.3</span></span>
<span id="cb159-5"><a href="fitness-model.html#cb159-5" aria-hidden="true" tabindex="-1"></a>beta_s1 <span class="ot">=</span> <span class="fl">0.3</span></span>
<span id="cb159-6"><a href="fitness-model.html#cb159-6" aria-hidden="true" tabindex="-1"></a>beta_s2 <span class="ot">=</span> <span class="sc">-</span><span class="fl">0.3</span></span>
<span id="cb159-7"><a href="fitness-model.html#cb159-7" aria-hidden="true" tabindex="-1"></a>beta_i1 <span class="ot">=</span> <span class="sc">-</span><span class="fl">0.3</span></span>
<span id="cb159-8"><a href="fitness-model.html#cb159-8" aria-hidden="true" tabindex="-1"></a>beta_i2 <span class="ot">=</span> <span class="sc">-</span><span class="fl">0.3</span></span>
<span id="cb159-9"><a href="fitness-model.html#cb159-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb159-10"><a href="fitness-model.html#cb159-10" aria-hidden="true" tabindex="-1"></a><span class="co">#dyad fitness (nu_0 = 1 so that w is relative fitness w = W/W_mean for the unbiased population mean fitness)</span></span>
<span id="cb159-11"><a href="fitness-model.html#cb159-11" aria-hidden="true" tabindex="-1"></a>pair_df<span class="sc">$</span>w_mu <span class="ot">=</span> nu_0 <span class="sc">+</span> beta_n1<span class="sc">*</span>pair_df<span class="sc">$</span>P0m <span class="sc">+</span> beta_n2<span class="sc">*</span>pair_df<span class="sc">$</span>P1m <span class="sc">+</span> beta_s1<span class="sc">*</span>pair_df<span class="sc">$</span>P0f <span class="sc">+</span> beta_s2<span class="sc">*</span>pair_df<span class="sc">$</span>P1f <span class="sc">+</span></span>
<span id="cb159-12"><a href="fitness-model.html#cb159-12" aria-hidden="true" tabindex="-1"></a>                              beta_i1<span class="sc">*</span>(pair_df<span class="sc">$</span>P0m<span class="sc">*</span>pair_df<span class="sc">$</span>P0f) <span class="sc">+</span> beta_i2<span class="sc">*</span>(pair_df<span class="sc">$</span>P1m<span class="sc">*</span>pair_df<span class="sc">$</span>P1f)</span>
<span id="cb159-13"><a href="fitness-model.html#cb159-13" aria-hidden="true" tabindex="-1"></a><span class="co">#remove redundant elements </span></span>
<span id="cb159-14"><a href="fitness-model.html#cb159-14" aria-hidden="true" tabindex="-1"></a>w_mu<span class="ot">&lt;-</span>pair_df[<span class="fu">seq</span>(<span class="dv">1</span>, <span class="fu">nrow</span>(pair_df), <span class="at">by=</span>I_obs),<span class="st">&quot;w_mu&quot;</span>]</span>
<span id="cb159-15"><a href="fitness-model.html#cb159-15" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb159-16"><a href="fitness-model.html#cb159-16" aria-hidden="true" tabindex="-1"></a><span class="co">#add stochastic effects (same sd as phenotype)</span></span>
<span id="cb159-17"><a href="fitness-model.html#cb159-17" aria-hidden="true" tabindex="-1"></a>w <span class="ot">=</span> w_mu <span class="sc">+</span> <span class="fu">rnorm</span>(<span class="fu">length</span>(w_mu),<span class="dv">0</span>, res_sd)</span></code></pre></div>
<p>We’ll need additional indices for the Stan code to appropriately estimate the fitness model.</p>
<div class="sourceCode" id="cb160"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb160-1"><a href="fitness-model.html#cb160-1" aria-hidden="true" tabindex="-1"></a><span class="do">#####################################################################</span></span>
<span id="cb160-2"><a href="fitness-model.html#cb160-2" aria-hidden="true" tabindex="-1"></a><span class="co">#Prepare data for Stan</span></span>
<span id="cb160-3"><a href="fitness-model.html#cb160-3" aria-hidden="true" tabindex="-1"></a><span class="do">#####################################################################</span></span>
<span id="cb160-4"><a href="fitness-model.html#cb160-4" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb160-5"><a href="fitness-model.html#cb160-5" aria-hidden="true" tabindex="-1"></a>  <span class="co">#individual indices</span></span>
<span id="cb160-6"><a href="fitness-model.html#cb160-6" aria-hidden="true" tabindex="-1"></a>  Im <span class="ot">=</span> I<span class="sc">/</span><span class="dv">2</span> <span class="co">#number of males</span></span>
<span id="cb160-7"><a href="fitness-model.html#cb160-7" aria-hidden="true" tabindex="-1"></a>  If <span class="ot">=</span> I<span class="sc">/</span><span class="dv">2</span> <span class="co">#number of females</span></span>
<span id="cb160-8"><a href="fitness-model.html#cb160-8" aria-hidden="true" tabindex="-1"></a>  N_sex <span class="ot">=</span> (I<span class="sc">/</span><span class="dv">2</span>)<span class="sc">*</span><span class="dv">2</span><span class="sc">*</span><span class="dv">4</span> <span class="co">#total observations per sex</span></span>
<span id="cb160-9"><a href="fitness-model.html#cb160-9" aria-hidden="true" tabindex="-1"></a>  idm<span class="ot">&lt;-</span>pair_df<span class="sc">$</span>ID_m <span class="co">#male ID</span></span>
<span id="cb160-10"><a href="fitness-model.html#cb160-10" aria-hidden="true" tabindex="-1"></a>  idf<span class="ot">&lt;-</span>pair_df<span class="sc">$</span>ID_f <span class="co">#female ID</span></span>
<span id="cb160-11"><a href="fitness-model.html#cb160-11" aria-hidden="true" tabindex="-1"></a>  idf<span class="ot">&lt;-</span>idf <span class="sc">-</span> (Im) <span class="co">#index within female vector</span></span>
<span id="cb160-12"><a href="fitness-model.html#cb160-12" aria-hidden="true" tabindex="-1"></a>  dyadAG <span class="ot">&lt;-</span> pair_df<span class="sc">$</span>dyadn</span>
<span id="cb160-13"><a href="fitness-model.html#cb160-13" aria-hidden="true" tabindex="-1"></a>  dyadw <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="dv">1</span><span class="sc">:</span>ndyad)</span>
<span id="cb160-14"><a href="fitness-model.html#cb160-14" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb160-15"><a href="fitness-model.html#cb160-15" aria-hidden="true" tabindex="-1"></a>  <span class="co">#partner IDs for male individuals</span></span>
<span id="cb160-16"><a href="fitness-model.html#cb160-16" aria-hidden="true" tabindex="-1"></a>  partners_m<span class="ot">&lt;-</span><span class="fu">data.frame</span>(<span class="at">idfocal =</span> <span class="fu">rep</span>(<span class="dv">1</span><span class="sc">:</span>(I<span class="sc">/</span><span class="dv">2</span>)), <span class="co">#all partners ID</span></span>
<span id="cb160-17"><a href="fitness-model.html#cb160-17" aria-hidden="true" tabindex="-1"></a>                         <span class="at">partner1 =</span> <span class="cn">NA</span>, <span class="at">partner2 =</span> <span class="cn">NA</span>, <span class="at">partner3 =</span> <span class="cn">NA</span>, <span class="at">partner4 =</span> <span class="cn">NA</span>)</span>
<span id="cb160-18"><a href="fitness-model.html#cb160-18" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>(I<span class="sc">/</span><span class="dv">2</span>)){partners_m[i,<span class="fu">c</span>(<span class="dv">2</span><span class="sc">:</span><span class="dv">5</span>)] <span class="ot">&lt;-</span>partner.id[partner.id<span class="sc">$</span>ID_m<span class="sc">==</span>i,<span class="st">&quot;ID_f&quot;</span>]}</span>
<span id="cb160-19"><a href="fitness-model.html#cb160-19" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb160-20"><a href="fitness-model.html#cb160-20" aria-hidden="true" tabindex="-1"></a>  <span class="co">#partner IDs for female individuals</span></span>
<span id="cb160-21"><a href="fitness-model.html#cb160-21" aria-hidden="true" tabindex="-1"></a>  partners_f<span class="ot">&lt;-</span><span class="fu">data.frame</span>(<span class="at">idfocal =</span> <span class="fu">rep</span>((I<span class="sc">/</span><span class="dv">2</span><span class="sc">+</span><span class="dv">1</span>)<span class="sc">:</span>I), <span class="co">#all partners ID</span></span>
<span id="cb160-22"><a href="fitness-model.html#cb160-22" aria-hidden="true" tabindex="-1"></a>                         <span class="at">partner1 =</span> <span class="cn">NA</span>, <span class="at">partner2 =</span> <span class="cn">NA</span>, <span class="at">partner3 =</span> <span class="cn">NA</span>, <span class="at">partner4 =</span> <span class="cn">NA</span>)</span>
<span id="cb160-23"><a href="fitness-model.html#cb160-23" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(i <span class="cf">in</span> (I<span class="sc">/</span><span class="dv">2</span><span class="sc">+</span><span class="dv">1</span>)<span class="sc">:</span>I){partners_f[i<span class="sc">-</span>(I<span class="sc">/</span><span class="dv">2</span>),<span class="fu">c</span>(<span class="dv">2</span><span class="sc">:</span><span class="dv">5</span>)] <span class="ot">&lt;-</span>partner.id[partner.id<span class="sc">$</span>ID_f<span class="sc">==</span>i,<span class="st">&quot;ID_m&quot;</span>]}</span>
<span id="cb160-24"><a href="fitness-model.html#cb160-24" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb160-25"><a href="fitness-model.html#cb160-25" aria-hidden="true" tabindex="-1"></a><span class="do">######################</span></span>
<span id="cb160-26"><a href="fitness-model.html#cb160-26" aria-hidden="true" tabindex="-1"></a><span class="co">#data prep for Stan</span></span>
<span id="cb160-27"><a href="fitness-model.html#cb160-27" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb160-28"><a href="fitness-model.html#cb160-28" aria-hidden="true" tabindex="-1"></a> stan_data <span class="ot">&lt;-</span></span>
<span id="cb160-29"><a href="fitness-model.html#cb160-29" aria-hidden="true" tabindex="-1"></a>    <span class="fu">list</span>(<span class="at">N_sex =</span> N_sex, <span class="at">I =</span> I, <span class="at">Im=</span>Im, <span class="at">If =</span> If, <span class="at">idm =</span> idm, <span class="at">idf =</span> idf,</span>
<span id="cb160-30"><a href="fitness-model.html#cb160-30" aria-hidden="true" tabindex="-1"></a>         <span class="at">partners_m =</span> partners_m, <span class="at">partners_f =</span> partners_f,</span>
<span id="cb160-31"><a href="fitness-model.html#cb160-31" aria-hidden="true" tabindex="-1"></a>         <span class="at">AG_m =</span> pair_df<span class="sc">$</span>AG_m, <span class="at">AG_f =</span> pair_df<span class="sc">$</span>AG_f, <span class="at">time =</span> pair_df<span class="sc">$</span>turn, <span class="at">A =</span> A_mat,</span>
<span id="cb160-32"><a href="fitness-model.html#cb160-32" aria-hidden="true" tabindex="-1"></a>         <span class="co">#new indices and data</span></span>
<span id="cb160-33"><a href="fitness-model.html#cb160-33" aria-hidden="true" tabindex="-1"></a>         <span class="at">Idyad=</span>ndyad, <span class="at">dyadw =</span> dyadw, <span class="at">idmw =</span> partner.id<span class="sc">$</span>ID_m, <span class="at">idfw =</span> <span class="fu">c</span>(partner.id<span class="sc">$</span>ID_f<span class="sc">-</span>Im),  <span class="at">w =</span> w)</span></code></pre></div>
</div>
<div id="estimating-the-model-1" class="section level2" number="5.2">
<h2><span class="header-section-number">5.2</span> Estimating the model</h2>
<p>We’re now prepared to extend the Stan code for the within and between partner model to account for selection on SRN intercepts and slopes. This involves specifying the fitness model described above as an additional response model, with SRN parameters simultaneously specified on the phenotype and fitness. As described in the main text, this multi-response model will avoid various sources of statistical bias that result from estimating these models in isolation. Fortunately, in contrast to the more complex SRN model, it is quite straightforward to add the fitness model with a few additional declarations in the <code>data</code>, <code>parameters</code>, and <code>model</code> program blocks. These changes are separated out with comments in the code below for clarity.</p>
<div class="sourceCode" id="cb161"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb161-1"><a href="fitness-model.html#cb161-1" aria-hidden="true" tabindex="-1"></a><span class="fu">write</span>(<span class="st">&quot;</span></span>
<span id="cb161-2"><a href="fitness-model.html#cb161-2" aria-hidden="true" tabindex="-1"></a><span class="st">data {</span></span>
<span id="cb161-3"><a href="fitness-model.html#cb161-3" aria-hidden="true" tabindex="-1"></a><span class="st">  </span></span>
<span id="cb161-4"><a href="fitness-model.html#cb161-4" aria-hidden="true" tabindex="-1"></a><span class="st">  //indices and scalars used for model specification</span></span>
<span id="cb161-5"><a href="fitness-model.html#cb161-5" aria-hidden="true" tabindex="-1"></a><span class="st">  int&lt;lower=1&gt; N_sex; //total aggression observations per sex (I/2 * 4 lifetime partners)</span></span>
<span id="cb161-6"><a href="fitness-model.html#cb161-6" aria-hidden="true" tabindex="-1"></a><span class="st">  int&lt;lower=0&gt; I; //total individuals (M + F)</span></span>
<span id="cb161-7"><a href="fitness-model.html#cb161-7" aria-hidden="true" tabindex="-1"></a><span class="st">  int&lt;lower=0&gt; Im; //number of males</span></span>
<span id="cb161-8"><a href="fitness-model.html#cb161-8" aria-hidden="true" tabindex="-1"></a><span class="st">  int&lt;lower=0&gt; If; //number of females</span></span>
<span id="cb161-9"><a href="fitness-model.html#cb161-9" aria-hidden="true" tabindex="-1"></a><span class="st">  int&lt;lower=1&gt; idm[N_sex]; //index of male AG observations (of length N_sex)</span></span>
<span id="cb161-10"><a href="fitness-model.html#cb161-10" aria-hidden="true" tabindex="-1"></a><span class="st">  int&lt;lower=1&gt; idf[N_sex]; //index of female AG observations</span></span>
<span id="cb161-11"><a href="fitness-model.html#cb161-11" aria-hidden="true" tabindex="-1"></a><span class="st">  int&lt;lower=1&gt; partners_m [Im,5]; //index of male partner IDs, first column is focal ID (1 + 4 IDs)</span></span>
<span id="cb161-12"><a href="fitness-model.html#cb161-12" aria-hidden="true" tabindex="-1"></a><span class="st">  int&lt;lower=1&gt; partners_f [If,5]; //index of female partner IDs, first column is focal ID (1 + 4 IDs)</span></span>
<span id="cb161-13"><a href="fitness-model.html#cb161-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb161-14"><a href="fitness-model.html#cb161-14" aria-hidden="true" tabindex="-1"></a><span class="st">  //empirical data</span></span>
<span id="cb161-15"><a href="fitness-model.html#cb161-15" aria-hidden="true" tabindex="-1"></a><span class="st">  matrix[I,I] A; //relatedness matrix</span></span>
<span id="cb161-16"><a href="fitness-model.html#cb161-16" aria-hidden="true" tabindex="-1"></a><span class="st">  real AG_m[N_sex]; //male aggression measurements</span></span>
<span id="cb161-17"><a href="fitness-model.html#cb161-17" aria-hidden="true" tabindex="-1"></a><span class="st">  real AG_f[N_sex]; //female aggression measurements</span></span>
<span id="cb161-18"><a href="fitness-model.html#cb161-18" aria-hidden="true" tabindex="-1"></a><span class="st">  real time[N_sex]; //time index (=1 for all measures)</span></span>
<span id="cb161-19"><a href="fitness-model.html#cb161-19" aria-hidden="true" tabindex="-1"></a><span class="st">  </span></span>
<span id="cb161-20"><a href="fitness-model.html#cb161-20" aria-hidden="true" tabindex="-1"></a><span class="st">  //new fitness data</span></span>
<span id="cb161-21"><a href="fitness-model.html#cb161-21" aria-hidden="true" tabindex="-1"></a><span class="st">  int&lt;lower=1&gt; Idyad; //number of dyads</span></span>
<span id="cb161-22"><a href="fitness-model.html#cb161-22" aria-hidden="true" tabindex="-1"></a><span class="st">  int&lt;lower=1&gt; idmw[Idyad]; //index of male w observations</span></span>
<span id="cb161-23"><a href="fitness-model.html#cb161-23" aria-hidden="true" tabindex="-1"></a><span class="st">  int&lt;lower=1&gt; idfw[Idyad]; //index of female w observations</span></span>
<span id="cb161-24"><a href="fitness-model.html#cb161-24" aria-hidden="true" tabindex="-1"></a><span class="st">  int&lt;lower=1&gt; dyadw[Idyad]; //index of dyads for FS</span></span>
<span id="cb161-25"><a href="fitness-model.html#cb161-25" aria-hidden="true" tabindex="-1"></a><span class="st">  real w[Idyad]; // dyad response</span></span>
<span id="cb161-26"><a href="fitness-model.html#cb161-26" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb161-27"><a href="fitness-model.html#cb161-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb161-28"><a href="fitness-model.html#cb161-28" aria-hidden="true" tabindex="-1"></a><span class="st">transformed data{</span></span>
<span id="cb161-29"><a href="fitness-model.html#cb161-29" aria-hidden="true" tabindex="-1"></a><span class="st">  matrix[I,I] LA = cholesky_decompose(A); //lower-triangle A matrix</span></span>
<span id="cb161-30"><a href="fitness-model.html#cb161-30" aria-hidden="true" tabindex="-1"></a><span class="st">  </span></span>
<span id="cb161-31"><a href="fitness-model.html#cb161-31" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb161-32"><a href="fitness-model.html#cb161-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb161-33"><a href="fitness-model.html#cb161-33" aria-hidden="true" tabindex="-1"></a><span class="st">parameters {</span></span>
<span id="cb161-34"><a href="fitness-model.html#cb161-34" aria-hidden="true" tabindex="-1"></a><span class="st">  </span></span>
<span id="cb161-35"><a href="fitness-model.html#cb161-35" aria-hidden="true" tabindex="-1"></a><span class="st">  //new fitness parameters</span></span>
<span id="cb161-36"><a href="fitness-model.html#cb161-36" aria-hidden="true" tabindex="-1"></a><span class="st">  real nu_0; //fitness global intercept</span></span>
<span id="cb161-37"><a href="fitness-model.html#cb161-37" aria-hidden="true" tabindex="-1"></a><span class="st">  real&lt;lower=0, upper = 1&gt;sd_delta; //residual of fitness</span></span>
<span id="cb161-38"><a href="fitness-model.html#cb161-38" aria-hidden="true" tabindex="-1"></a><span class="st">  real beta_N1; //selection gradients</span></span>
<span id="cb161-39"><a href="fitness-model.html#cb161-39" aria-hidden="true" tabindex="-1"></a><span class="st">  real beta_N2; //could also be specified as vectors</span></span>
<span id="cb161-40"><a href="fitness-model.html#cb161-40" aria-hidden="true" tabindex="-1"></a><span class="st">  real beta_S1; </span></span>
<span id="cb161-41"><a href="fitness-model.html#cb161-41" aria-hidden="true" tabindex="-1"></a><span class="st">  real beta_S2;</span></span>
<span id="cb161-42"><a href="fitness-model.html#cb161-42" aria-hidden="true" tabindex="-1"></a><span class="st">  real beta_I1;</span></span>
<span id="cb161-43"><a href="fitness-model.html#cb161-43" aria-hidden="true" tabindex="-1"></a><span class="st">  real beta_I2;</span></span>
<span id="cb161-44"><a href="fitness-model.html#cb161-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb161-45"><a href="fitness-model.html#cb161-45" aria-hidden="true" tabindex="-1"></a><span class="st">  //population effects</span></span>
<span id="cb161-46"><a href="fitness-model.html#cb161-46" aria-hidden="true" tabindex="-1"></a><span class="st">  real alpha_0; //aggression global intercept</span></span>
<span id="cb161-47"><a href="fitness-model.html#cb161-47" aria-hidden="true" tabindex="-1"></a><span class="st">  real psi_1; //expected interaction coefficient</span></span>
<span id="cb161-48"><a href="fitness-model.html#cb161-48" aria-hidden="true" tabindex="-1"></a><span class="st">  real beta_B; //between partner effect</span></span>
<span id="cb161-49"><a href="fitness-model.html#cb161-49" aria-hidden="true" tabindex="-1"></a><span class="st">  real&lt;lower=-1,upper=1&gt; phi; //(-1,1) ensures unique solution</span></span>
<span id="cb161-50"><a href="fitness-model.html#cb161-50" aria-hidden="true" tabindex="-1"></a><span class="st">  </span></span>
<span id="cb161-51"><a href="fitness-model.html#cb161-51" aria-hidden="true" tabindex="-1"></a><span class="st">  //no way to partition feedback when t=1</span></span>
<span id="cb161-52"><a href="fitness-model.html#cb161-52" aria-hidden="true" tabindex="-1"></a><span class="st">  //real&lt;lower=-1,upper=1&gt; phi; //(-1,1) ensures unique solution</span></span>
<span id="cb161-53"><a href="fitness-model.html#cb161-53" aria-hidden="true" tabindex="-1"></a><span class="st">  </span></span>
<span id="cb161-54"><a href="fitness-model.html#cb161-54" aria-hidden="true" tabindex="-1"></a><span class="st">  //random effects (standard deviations)</span></span>
<span id="cb161-55"><a href="fitness-model.html#cb161-55" aria-hidden="true" tabindex="-1"></a><span class="st">  vector&lt;lower=0, upper = 1&gt;[2] sd_P; //phenotypic SRN mu &amp; psi SDs</span></span>
<span id="cb161-56"><a href="fitness-model.html#cb161-56" aria-hidden="true" tabindex="-1"></a><span class="st">  vector&lt;lower=0, upper = 1&gt;[2] sd_R; //male &amp; female residual SDs</span></span>
<span id="cb161-57"><a href="fitness-model.html#cb161-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb161-58"><a href="fitness-model.html#cb161-58" aria-hidden="true" tabindex="-1"></a><span class="st">  cholesky_factor_corr[2] LG; //genetic SRN correlations</span></span>
<span id="cb161-59"><a href="fitness-model.html#cb161-59" aria-hidden="true" tabindex="-1"></a><span class="st">  cholesky_factor_corr[2] LE; //permanent environmental SRN correlations</span></span>
<span id="cb161-60"><a href="fitness-model.html#cb161-60" aria-hidden="true" tabindex="-1"></a><span class="st">  cholesky_factor_corr[2] LR; //sex-specific residual correlations</span></span>
<span id="cb161-61"><a href="fitness-model.html#cb161-61" aria-hidden="true" tabindex="-1"></a><span class="st">  </span></span>
<span id="cb161-62"><a href="fitness-model.html#cb161-62" aria-hidden="true" tabindex="-1"></a><span class="st">  matrix[I,2] std_devG; //individual-level unscaled G SRN deviations</span></span>
<span id="cb161-63"><a href="fitness-model.html#cb161-63" aria-hidden="true" tabindex="-1"></a><span class="st">  matrix[I,2] std_devE; //individual-level unscaled E SRN deviations</span></span>
<span id="cb161-64"><a href="fitness-model.html#cb161-64" aria-hidden="true" tabindex="-1"></a><span class="st">  </span></span>
<span id="cb161-65"><a href="fitness-model.html#cb161-65" aria-hidden="true" tabindex="-1"></a><span class="st">  //SRN heritability parmameters, i.e. Var(G_RN) / Var(P_RN) </span></span>
<span id="cb161-66"><a href="fitness-model.html#cb161-66" aria-hidden="true" tabindex="-1"></a><span class="st">  //see supplementary appendix SI for further explanation of this parameter</span></span>
<span id="cb161-67"><a href="fitness-model.html#cb161-67" aria-hidden="true" tabindex="-1"></a><span class="st">  vector&lt;lower=0,upper=1&gt;[2] SRN_h2;</span></span>
<span id="cb161-68"><a href="fitness-model.html#cb161-68" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb161-69"><a href="fitness-model.html#cb161-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb161-70"><a href="fitness-model.html#cb161-70" aria-hidden="true" tabindex="-1"></a><span class="st">transformed parameters {</span></span>
<span id="cb161-71"><a href="fitness-model.html#cb161-71" aria-hidden="true" tabindex="-1"></a><span class="st">  vector&lt;lower=0&gt;[2] sd_G; //SDs of G effects (derived from sd_P)</span></span>
<span id="cb161-72"><a href="fitness-model.html#cb161-72" aria-hidden="true" tabindex="-1"></a><span class="st">  vector&lt;lower=0&gt;[2] sd_E; //SDs of E effects (derived from sd_P)</span></span>
<span id="cb161-73"><a href="fitness-model.html#cb161-73" aria-hidden="true" tabindex="-1"></a><span class="st">  </span></span>
<span id="cb161-74"><a href="fitness-model.html#cb161-74" aria-hidden="true" tabindex="-1"></a><span class="st">  matrix[I,2] SRN_P; //scaled P SRN parameter deviations</span></span>
<span id="cb161-75"><a href="fitness-model.html#cb161-75" aria-hidden="true" tabindex="-1"></a><span class="st">  matrix[I,2] SRN_G; //scaled G SRN parameter deviations</span></span>
<span id="cb161-76"><a href="fitness-model.html#cb161-76" aria-hidden="true" tabindex="-1"></a><span class="st">  matrix[I,2] SRN_E; //scaled E SRN parameter deviations</span></span>
<span id="cb161-77"><a href="fitness-model.html#cb161-77" aria-hidden="true" tabindex="-1"></a><span class="st">  </span></span>
<span id="cb161-78"><a href="fitness-model.html#cb161-78" aria-hidden="true" tabindex="-1"></a><span class="st">  matrix[If, 2] partner_meanm; //average SRN parameters of males&#39; partners</span></span>
<span id="cb161-79"><a href="fitness-model.html#cb161-79" aria-hidden="true" tabindex="-1"></a><span class="st">  matrix[Im, 2] partner_meanf; //average SRN parameters of females&#39; partners</span></span>
<span id="cb161-80"><a href="fitness-model.html#cb161-80" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb161-81"><a href="fitness-model.html#cb161-81" aria-hidden="true" tabindex="-1"></a><span class="st">  //standard deviations of genetic effects</span></span>
<span id="cb161-82"><a href="fitness-model.html#cb161-82" aria-hidden="true" tabindex="-1"></a><span class="st">  //simplified from sqrt ( total RN phenotype variance * h2 )</span></span>
<span id="cb161-83"><a href="fitness-model.html#cb161-83" aria-hidden="true" tabindex="-1"></a><span class="st">  sd_G[1] = sd_P[1] * sqrt(SRN_h2[1]); //genetic SD for RN intercepts </span></span>
<span id="cb161-84"><a href="fitness-model.html#cb161-84" aria-hidden="true" tabindex="-1"></a><span class="st">  sd_G[2] = sd_P[2] * sqrt(SRN_h2[2]);  //genetic SD for RN slopes</span></span>
<span id="cb161-85"><a href="fitness-model.html#cb161-85" aria-hidden="true" tabindex="-1"></a><span class="st">  </span></span>
<span id="cb161-86"><a href="fitness-model.html#cb161-86" aria-hidden="true" tabindex="-1"></a><span class="st">  //standard deviations of environmental effects (total phenotype SD * proportion environment SD)</span></span>
<span id="cb161-87"><a href="fitness-model.html#cb161-87" aria-hidden="true" tabindex="-1"></a><span class="st">  sd_E[1] = sd_P[1] * sqrt(1 - SRN_h2[1]); //environment SD for RN intercepts </span></span>
<span id="cb161-88"><a href="fitness-model.html#cb161-88" aria-hidden="true" tabindex="-1"></a><span class="st">  sd_E[2] = sd_P[2] * sqrt(1 - SRN_h2[2]); //environment SD for RN slopes </span></span>
<span id="cb161-89"><a href="fitness-model.html#cb161-89" aria-hidden="true" tabindex="-1"></a><span class="st">  </span></span>
<span id="cb161-90"><a href="fitness-model.html#cb161-90" aria-hidden="true" tabindex="-1"></a><span class="st">  //matrix normal parameterization of Kronecker product between G and A</span></span>
<span id="cb161-91"><a href="fitness-model.html#cb161-91" aria-hidden="true" tabindex="-1"></a><span class="st">  SRN_G =  LA * std_devG  * diag_pre_multiply(sd_G, LG)&#39; ; </span></span>
<span id="cb161-92"><a href="fitness-model.html#cb161-92" aria-hidden="true" tabindex="-1"></a><span class="st">  </span></span>
<span id="cb161-93"><a href="fitness-model.html#cb161-93" aria-hidden="true" tabindex="-1"></a><span class="st">  //non-centered parameterization of permanent environmental effects</span></span>
<span id="cb161-94"><a href="fitness-model.html#cb161-94" aria-hidden="true" tabindex="-1"></a><span class="st">  SRN_E = std_devE * diag_pre_multiply(sd_E, LE)&#39;;</span></span>
<span id="cb161-95"><a href="fitness-model.html#cb161-95" aria-hidden="true" tabindex="-1"></a><span class="st">  </span></span>
<span id="cb161-96"><a href="fitness-model.html#cb161-96" aria-hidden="true" tabindex="-1"></a><span class="st">  //phenotypic RN effects (P = G + E); here G = additive genetic effects</span></span>
<span id="cb161-97"><a href="fitness-model.html#cb161-97" aria-hidden="true" tabindex="-1"></a><span class="st">  SRN_P = SRN_G + SRN_E;</span></span>
<span id="cb161-98"><a href="fitness-model.html#cb161-98" aria-hidden="true" tabindex="-1"></a><span class="st">  </span></span>
<span id="cb161-99"><a href="fitness-model.html#cb161-99" aria-hidden="true" tabindex="-1"></a><span class="st">  //calculate the mean SRN parameters of each male&#39;s lifetime partners</span></span>
<span id="cb161-100"><a href="fitness-model.html#cb161-100" aria-hidden="true" tabindex="-1"></a><span class="st">  for(i in 1:Im) partner_meanm[i] = [mean(col(SRN_P[partners_m[i,2:5]],1)),</span></span>
<span id="cb161-101"><a href="fitness-model.html#cb161-101" aria-hidden="true" tabindex="-1"></a><span class="st">                                mean(col(SRN_P[partners_m[i,2:5]],2))];</span></span>
<span id="cb161-102"><a href="fitness-model.html#cb161-102" aria-hidden="true" tabindex="-1"></a><span class="st">  </span></span>
<span id="cb161-103"><a href="fitness-model.html#cb161-103" aria-hidden="true" tabindex="-1"></a><span class="st">  //calculate the mean SRN parameters of each female&#39;s lifetime partners</span></span>
<span id="cb161-104"><a href="fitness-model.html#cb161-104" aria-hidden="true" tabindex="-1"></a><span class="st">  for(i in 1:If) partner_meanf[i] = [mean(col(SRN_P[partners_f[i,2:5]],1)),</span></span>
<span id="cb161-105"><a href="fitness-model.html#cb161-105" aria-hidden="true" tabindex="-1"></a><span class="st">                                mean(col(SRN_P[partners_f[i,2:5]],2))];</span></span>
<span id="cb161-106"><a href="fitness-model.html#cb161-106" aria-hidden="true" tabindex="-1"></a><span class="st">  </span></span>
<span id="cb161-107"><a href="fitness-model.html#cb161-107" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb161-108"><a href="fitness-model.html#cb161-108" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb161-109"><a href="fitness-model.html#cb161-109" aria-hidden="true" tabindex="-1"></a><span class="st">model{</span></span>
<span id="cb161-110"><a href="fitness-model.html#cb161-110" aria-hidden="true" tabindex="-1"></a><span class="st"> //separate male and female vectors for efficiency</span></span>
<span id="cb161-111"><a href="fitness-model.html#cb161-111" aria-hidden="true" tabindex="-1"></a><span class="st">  matrix[Im,2] SRN_Pm = SRN_P[1:Im]; //male SRN phenotypic deviations</span></span>
<span id="cb161-112"><a href="fitness-model.html#cb161-112" aria-hidden="true" tabindex="-1"></a><span class="st">  matrix[If,2] SRN_Pf = SRN_P[(Im+1):I]; //female SRN phenotypic deviations</span></span>
<span id="cb161-113"><a href="fitness-model.html#cb161-113" aria-hidden="true" tabindex="-1"></a><span class="st">  </span></span>
<span id="cb161-114"><a href="fitness-model.html#cb161-114" aria-hidden="true" tabindex="-1"></a><span class="st">  //separate SRN intercepts and slopes (phenotypic deviations)</span></span>
<span id="cb161-115"><a href="fitness-model.html#cb161-115" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[Im] mu_m = col(SRN_Pm,1); //SRN intercepts</span></span>
<span id="cb161-116"><a href="fitness-model.html#cb161-116" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[If] mu_f = col(SRN_Pf,1); </span></span>
<span id="cb161-117"><a href="fitness-model.html#cb161-117" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[Im] psi_m = col(SRN_Pm,2); //SRN slopes</span></span>
<span id="cb161-118"><a href="fitness-model.html#cb161-118" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[If] psi_f = col(SRN_Pf,2); </span></span>
<span id="cb161-119"><a href="fitness-model.html#cb161-119" aria-hidden="true" tabindex="-1"></a><span class="st">  </span></span>
<span id="cb161-120"><a href="fitness-model.html#cb161-120" aria-hidden="true" tabindex="-1"></a><span class="st">  //separate mean partner SRN intercepts and slopes (deviations)</span></span>
<span id="cb161-121"><a href="fitness-model.html#cb161-121" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[Im] mu_meanm = col(partner_meanm,1); //mean partner SRN intercept for males</span></span>
<span id="cb161-122"><a href="fitness-model.html#cb161-122" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[If] mu_meanf = col(partner_meanf,1); //...for females</span></span>
<span id="cb161-123"><a href="fitness-model.html#cb161-123" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[Im] psi_meanm = col(partner_meanm,2); //mean partner SRN slope for males</span></span>
<span id="cb161-124"><a href="fitness-model.html#cb161-124" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[If] psi_meanf = col(partner_meanf,2); //...for females </span></span>
<span id="cb161-125"><a href="fitness-model.html#cb161-125" aria-hidden="true" tabindex="-1"></a><span class="st">  </span></span>
<span id="cb161-126"><a href="fitness-model.html#cb161-126" aria-hidden="true" tabindex="-1"></a><span class="st">  //initialize vectors for constructing individual-centered linear predictors</span></span>
<span id="cb161-127"><a href="fitness-model.html#cb161-127" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[N_sex] eta_Wm; //within-individual centered male SRN trait value </span></span>
<span id="cb161-128"><a href="fitness-model.html#cb161-128" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[N_sex] eta_Wf; //within-individual centered female SRN trait value</span></span>
<span id="cb161-129"><a href="fitness-model.html#cb161-129" aria-hidden="true" tabindex="-1"></a><span class="st">  </span></span>
<span id="cb161-130"><a href="fitness-model.html#cb161-130" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[N_sex] eta_Bm; //individual male SRN trait value toward average partner </span></span>
<span id="cb161-131"><a href="fitness-model.html#cb161-131" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[N_sex] eta_Bf; //individual female SRN trait toward average partner</span></span>
<span id="cb161-132"><a href="fitness-model.html#cb161-132" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[N_sex] eta_meanm; //average SRN partner values for males</span></span>
<span id="cb161-133"><a href="fitness-model.html#cb161-133" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[N_sex] eta_meanf; //average SRN partner values for females</span></span>
<span id="cb161-134"><a href="fitness-model.html#cb161-134" aria-hidden="true" tabindex="-1"></a><span class="st">  </span></span>
<span id="cb161-135"><a href="fitness-model.html#cb161-135" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[N_sex] linpred_m; //expected value for male responses</span></span>
<span id="cb161-136"><a href="fitness-model.html#cb161-136" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[N_sex] linpred_f; //expected value for female responses</span></span>
<span id="cb161-137"><a href="fitness-model.html#cb161-137" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[N_sex] epsilon_m; //residuals for male responses</span></span>
<span id="cb161-138"><a href="fitness-model.html#cb161-138" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[N_sex] epsilon_f; //residuals for male responses</span></span>
<span id="cb161-139"><a href="fitness-model.html#cb161-139" aria-hidden="true" tabindex="-1"></a><span class="st">  </span></span>
<span id="cb161-140"><a href="fitness-model.html#cb161-140" aria-hidden="true" tabindex="-1"></a><span class="st">  //new fitness model declarations</span></span>
<span id="cb161-141"><a href="fitness-model.html#cb161-141" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[Idyad] w_pred; //linear predictor of fitness</span></span>
<span id="cb161-142"><a href="fitness-model.html#cb161-142" aria-hidden="true" tabindex="-1"></a><span class="st">  </span></span>
<span id="cb161-143"><a href="fitness-model.html#cb161-143" aria-hidden="true" tabindex="-1"></a><span class="st">  //Male and female aggression response model</span></span>
<span id="cb161-144"><a href="fitness-model.html#cb161-144" aria-hidden="true" tabindex="-1"></a><span class="st">  for (n in 1:N_sex) {</span></span>
<span id="cb161-145"><a href="fitness-model.html#cb161-145" aria-hidden="true" tabindex="-1"></a><span class="st">    </span></span>
<span id="cb161-146"><a href="fitness-model.html#cb161-146" aria-hidden="true" tabindex="-1"></a><span class="st">    //SRN trait values</span></span>
<span id="cb161-147"><a href="fitness-model.html#cb161-147" aria-hidden="true" tabindex="-1"></a><span class="st">    //assumes that n = 1 in the context of an ongoing social interaction</span></span>
<span id="cb161-148"><a href="fitness-model.html#cb161-148" aria-hidden="true" tabindex="-1"></a><span class="st">    //if n = 1 prior to social context, then specify eta[t=1] = mu_j instead</span></span>
<span id="cb161-149"><a href="fitness-model.html#cb161-149" aria-hidden="true" tabindex="-1"></a><span class="st">    if (time[n]==1)</span></span>
<span id="cb161-150"><a href="fitness-model.html#cb161-150" aria-hidden="true" tabindex="-1"></a><span class="st">      {</span></span>
<span id="cb161-151"><a href="fitness-model.html#cb161-151" aria-hidden="true" tabindex="-1"></a><span class="st">        //within-individual centered eta</span></span>
<span id="cb161-152"><a href="fitness-model.html#cb161-152" aria-hidden="true" tabindex="-1"></a><span class="st">        //male eta[t=1] = mu_j + psi_j*(mu_k - mu_meanK)</span></span>
<span id="cb161-153"><a href="fitness-model.html#cb161-153" aria-hidden="true" tabindex="-1"></a><span class="st">        eta_Wm[n] = mu_m[idm[n]] +  (psi_1 + psi_m[idm[n]])*(mu_f[idf[n]] - mu_meanm[idm[n]]) ;</span></span>
<span id="cb161-154"><a href="fitness-model.html#cb161-154" aria-hidden="true" tabindex="-1"></a><span class="st">        </span></span>
<span id="cb161-155"><a href="fitness-model.html#cb161-155" aria-hidden="true" tabindex="-1"></a><span class="st">        //female eta[t=1] = mu_k + psi_k*(mu_j - mu_meanJ)</span></span>
<span id="cb161-156"><a href="fitness-model.html#cb161-156" aria-hidden="true" tabindex="-1"></a><span class="st">        eta_Wf[n] = mu_f[idf[n]] +   (psi_1 + psi_f[idf[n]])*(mu_m[idm[n]] - mu_meanf[idf[n]]);</span></span>
<span id="cb161-157"><a href="fitness-model.html#cb161-157" aria-hidden="true" tabindex="-1"></a><span class="st">        </span></span>
<span id="cb161-158"><a href="fitness-model.html#cb161-158" aria-hidden="true" tabindex="-1"></a><span class="st">        //average individual eta</span></span>
<span id="cb161-159"><a href="fitness-model.html#cb161-159" aria-hidden="true" tabindex="-1"></a><span class="st">        //male eta[t=1] = mu_j + psi_j*mu_k</span></span>
<span id="cb161-160"><a href="fitness-model.html#cb161-160" aria-hidden="true" tabindex="-1"></a><span class="st">        eta_Bm[n] =   (psi_1 + psi_m[idm[n]])*mu_meanm[idm[n]];</span></span>
<span id="cb161-161"><a href="fitness-model.html#cb161-161" aria-hidden="true" tabindex="-1"></a><span class="st">        </span></span>
<span id="cb161-162"><a href="fitness-model.html#cb161-162" aria-hidden="true" tabindex="-1"></a><span class="st">        //female eta[t=1] = mu_k + psi_k*mu_j</span></span>
<span id="cb161-163"><a href="fitness-model.html#cb161-163" aria-hidden="true" tabindex="-1"></a><span class="st">        eta_Bf[n] =   (psi_1 + psi_f[idf[n]])*mu_meanf[idf[n]];</span></span>
<span id="cb161-164"><a href="fitness-model.html#cb161-164" aria-hidden="true" tabindex="-1"></a><span class="st">        </span></span>
<span id="cb161-165"><a href="fitness-model.html#cb161-165" aria-hidden="true" tabindex="-1"></a><span class="st">        //average partner eta[t=1]</span></span>
<span id="cb161-166"><a href="fitness-model.html#cb161-166" aria-hidden="true" tabindex="-1"></a><span class="st">        //average eta males&#39; partners [t=1] = mu_meanK + psi_meanK*mu_j</span></span>
<span id="cb161-167"><a href="fitness-model.html#cb161-167" aria-hidden="true" tabindex="-1"></a><span class="st">        eta_meanm[n] = mu_meanm[idm[n]] +   (psi_1 + psi_meanm[idm[n]])*mu_m[idm[n]];</span></span>
<span id="cb161-168"><a href="fitness-model.html#cb161-168" aria-hidden="true" tabindex="-1"></a><span class="st">        </span></span>
<span id="cb161-169"><a href="fitness-model.html#cb161-169" aria-hidden="true" tabindex="-1"></a><span class="st">        //average eta females&#39; partners [t=1] = mu_meanJ + psi_meanJ*mu_k</span></span>
<span id="cb161-170"><a href="fitness-model.html#cb161-170" aria-hidden="true" tabindex="-1"></a><span class="st">        eta_meanf[n] = mu_meanf[idf[n]] +   (psi_1 + psi_meanf[idf[n]])*mu_f[idf[n]];</span></span>
<span id="cb161-171"><a href="fitness-model.html#cb161-171" aria-hidden="true" tabindex="-1"></a><span class="st">      }    </span></span>
<span id="cb161-172"><a href="fitness-model.html#cb161-172" aria-hidden="true" tabindex="-1"></a><span class="st">    else</span></span>
<span id="cb161-173"><a href="fitness-model.html#cb161-173" aria-hidden="true" tabindex="-1"></a><span class="st">      {</span></span>
<span id="cb161-174"><a href="fitness-model.html#cb161-174" aria-hidden="true" tabindex="-1"></a><span class="st">        //within-individual centered eta</span></span>
<span id="cb161-175"><a href="fitness-model.html#cb161-175" aria-hidden="true" tabindex="-1"></a><span class="st">        //male eta[t=2] = mu_j + psi_j*(eta_k[t=1] - eta_meanK[t=1])</span></span>
<span id="cb161-176"><a href="fitness-model.html#cb161-176" aria-hidden="true" tabindex="-1"></a><span class="st">        eta_Wm[n] = mu_m[idm[n]] +   (psi_1 + psi_m[idm[n]])*(eta_Wf[n-1] - eta_meanm[n-1]);</span></span>
<span id="cb161-177"><a href="fitness-model.html#cb161-177" aria-hidden="true" tabindex="-1"></a><span class="st">        </span></span>
<span id="cb161-178"><a href="fitness-model.html#cb161-178" aria-hidden="true" tabindex="-1"></a><span class="st">        //female eta[t=2] = mu_k + psi_k*(eta_j[t=1] - eta_meanJ[t=1])</span></span>
<span id="cb161-179"><a href="fitness-model.html#cb161-179" aria-hidden="true" tabindex="-1"></a><span class="st">        eta_Wf[n] = mu_f[idf[n]] +   (psi_1 + psi_f[idf[n]])*(eta_Wm[n-1] - eta_meanf[n-1]);</span></span>
<span id="cb161-180"><a href="fitness-model.html#cb161-180" aria-hidden="true" tabindex="-1"></a><span class="st">        </span></span>
<span id="cb161-181"><a href="fitness-model.html#cb161-181" aria-hidden="true" tabindex="-1"></a><span class="st">        //average individual eta</span></span>
<span id="cb161-182"><a href="fitness-model.html#cb161-182" aria-hidden="true" tabindex="-1"></a><span class="st">        //male average eta[t=2] = mu_j + psi_j*eta_meanK[t=1]</span></span>
<span id="cb161-183"><a href="fitness-model.html#cb161-183" aria-hidden="true" tabindex="-1"></a><span class="st">        eta_Bm[n] =  (psi_1 + psi_m[idm[n]])*eta_meanm[n-1];</span></span>
<span id="cb161-184"><a href="fitness-model.html#cb161-184" aria-hidden="true" tabindex="-1"></a><span class="st">        </span></span>
<span id="cb161-185"><a href="fitness-model.html#cb161-185" aria-hidden="true" tabindex="-1"></a><span class="st">        //female average eta[t=2] = mu_k + psi_k*eta_meanJ[t=1]</span></span>
<span id="cb161-186"><a href="fitness-model.html#cb161-186" aria-hidden="true" tabindex="-1"></a><span class="st">        eta_Bf[n] =  (psi_1 + psi_f[idf[n]])*eta_meanf[n-1];</span></span>
<span id="cb161-187"><a href="fitness-model.html#cb161-187" aria-hidden="true" tabindex="-1"></a><span class="st">        </span></span>
<span id="cb161-188"><a href="fitness-model.html#cb161-188" aria-hidden="true" tabindex="-1"></a><span class="st">        //average eta males&#39; partners [t=1] = mu_meanK + psi_meanK*mean eta_j[t-1]</span></span>
<span id="cb161-189"><a href="fitness-model.html#cb161-189" aria-hidden="true" tabindex="-1"></a><span class="st">        eta_meanm[n] = mu_meanm[idm[n]] +  (psi_1 + psi_meanm[idm[n]])*(mu_m[idm[n]] + eta_Bm[n-1]);</span></span>
<span id="cb161-190"><a href="fitness-model.html#cb161-190" aria-hidden="true" tabindex="-1"></a><span class="st">        </span></span>
<span id="cb161-191"><a href="fitness-model.html#cb161-191" aria-hidden="true" tabindex="-1"></a><span class="st">        //female average partner eta</span></span>
<span id="cb161-192"><a href="fitness-model.html#cb161-192" aria-hidden="true" tabindex="-1"></a><span class="st">        eta_meanf[n] = mu_meanf[idf[n]] +  (psi_1 + psi_meanf[idf[n]])*(mu_f[idf[n]] +   eta_Bf[n-1]); </span></span>
<span id="cb161-193"><a href="fitness-model.html#cb161-193" aria-hidden="true" tabindex="-1"></a><span class="st">      }</span></span>
<span id="cb161-194"><a href="fitness-model.html#cb161-194" aria-hidden="true" tabindex="-1"></a><span class="st">    </span></span>
<span id="cb161-195"><a href="fitness-model.html#cb161-195" aria-hidden="true" tabindex="-1"></a><span class="st">    //add global intercept and between-individual parameters to linear predictor</span></span>
<span id="cb161-196"><a href="fitness-model.html#cb161-196" aria-hidden="true" tabindex="-1"></a><span class="st">    //other fixed effects can also be added here</span></span>
<span id="cb161-197"><a href="fitness-model.html#cb161-197" aria-hidden="true" tabindex="-1"></a><span class="st">    linpred_m[n] = alpha_0 + eta_Wm[n] + beta_B*eta_Bm[n]; //+beta_B*eta_Bm[n]</span></span>
<span id="cb161-198"><a href="fitness-model.html#cb161-198" aria-hidden="true" tabindex="-1"></a><span class="st">    linpred_f[n] = alpha_0 + eta_Wf[n] + beta_B*eta_Bf[n]; //+beta_B*eta_Bf[n]</span></span>
<span id="cb161-199"><a href="fitness-model.html#cb161-199" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb161-200"><a href="fitness-model.html#cb161-200" aria-hidden="true" tabindex="-1"></a><span class="st">    //residual trait values</span></span>
<span id="cb161-201"><a href="fitness-model.html#cb161-201" aria-hidden="true" tabindex="-1"></a><span class="st">    if(time[n]==1)</span></span>
<span id="cb161-202"><a href="fitness-model.html#cb161-202" aria-hidden="true" tabindex="-1"></a><span class="st">      {</span></span>
<span id="cb161-203"><a href="fitness-model.html#cb161-203" aria-hidden="true" tabindex="-1"></a><span class="st">        epsilon_m [n] = AG_m[n] - linpred_m[n];</span></span>
<span id="cb161-204"><a href="fitness-model.html#cb161-204" aria-hidden="true" tabindex="-1"></a><span class="st">        epsilon_f [n] = AG_f[n] - linpred_f[n];</span></span>
<span id="cb161-205"><a href="fitness-model.html#cb161-205" aria-hidden="true" tabindex="-1"></a><span class="st">      }</span></span>
<span id="cb161-206"><a href="fitness-model.html#cb161-206" aria-hidden="true" tabindex="-1"></a><span class="st">    else</span></span>
<span id="cb161-207"><a href="fitness-model.html#cb161-207" aria-hidden="true" tabindex="-1"></a><span class="st">      {</span></span>
<span id="cb161-208"><a href="fitness-model.html#cb161-208" aria-hidden="true" tabindex="-1"></a><span class="st">       linpred_m[n] = linpred_m[n] + phi * epsilon_f[n-1];</span></span>
<span id="cb161-209"><a href="fitness-model.html#cb161-209" aria-hidden="true" tabindex="-1"></a><span class="st">       epsilon_m[n] = AG_m[n] - linpred_m[n]; </span></span>
<span id="cb161-210"><a href="fitness-model.html#cb161-210" aria-hidden="true" tabindex="-1"></a><span class="st">       </span></span>
<span id="cb161-211"><a href="fitness-model.html#cb161-211" aria-hidden="true" tabindex="-1"></a><span class="st">       linpred_f[n] = linpred_f[n] + phi * epsilon_m[n-1];</span></span>
<span id="cb161-212"><a href="fitness-model.html#cb161-212" aria-hidden="true" tabindex="-1"></a><span class="st">       epsilon_f[n] = AG_f[n] - linpred_f[n]; </span></span>
<span id="cb161-213"><a href="fitness-model.html#cb161-213" aria-hidden="true" tabindex="-1"></a><span class="st">      }</span></span>
<span id="cb161-214"><a href="fitness-model.html#cb161-214" aria-hidden="true" tabindex="-1"></a><span class="st">  </span></span>
<span id="cb161-215"><a href="fitness-model.html#cb161-215" aria-hidden="true" tabindex="-1"></a><span class="st">    //correlated residuals between partners</span></span>
<span id="cb161-216"><a href="fitness-model.html#cb161-216" aria-hidden="true" tabindex="-1"></a><span class="st">    [epsilon_m[n],epsilon_f[n]]&#39; ~ multi_normal_cholesky([0,0], diag_pre_multiply(sd_R, LR));</span></span>
<span id="cb161-217"><a href="fitness-model.html#cb161-217" aria-hidden="true" tabindex="-1"></a><span class="st">  }</span></span>
<span id="cb161-218"><a href="fitness-model.html#cb161-218" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb161-219"><a href="fitness-model.html#cb161-219" aria-hidden="true" tabindex="-1"></a><span class="st">  </span></span>
<span id="cb161-220"><a href="fitness-model.html#cb161-220" aria-hidden="true" tabindex="-1"></a><span class="st">  //new fitness model</span></span>
<span id="cb161-221"><a href="fitness-model.html#cb161-221" aria-hidden="true" tabindex="-1"></a><span class="st">  w_pred = nu_0 + beta_N1*mu_m[idmw] + beta_N2*psi_m[idmw] + beta_S1*mu_f[idfw] + beta_S2*psi_f[idfw] + </span></span>
<span id="cb161-222"><a href="fitness-model.html#cb161-222" aria-hidden="true" tabindex="-1"></a><span class="st">                  beta_I1*(mu_m[idmw].*mu_f[idfw]) + beta_I2*(psi_m[idmw].*psi_f[idfw]);</span></span>
<span id="cb161-223"><a href="fitness-model.html#cb161-223" aria-hidden="true" tabindex="-1"></a><span class="st">  </span></span>
<span id="cb161-224"><a href="fitness-model.html#cb161-224" aria-hidden="true" tabindex="-1"></a><span class="st">  w ~ normal(w_pred, sd_delta);</span></span>
<span id="cb161-225"><a href="fitness-model.html#cb161-225" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb161-226"><a href="fitness-model.html#cb161-226" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb161-227"><a href="fitness-model.html#cb161-227" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb161-228"><a href="fitness-model.html#cb161-228" aria-hidden="true" tabindex="-1"></a><span class="st">//model priors</span></span>
<span id="cb161-229"><a href="fitness-model.html#cb161-229" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb161-230"><a href="fitness-model.html#cb161-230" aria-hidden="true" tabindex="-1"></a><span class="st">  //fixed effects</span></span>
<span id="cb161-231"><a href="fitness-model.html#cb161-231" aria-hidden="true" tabindex="-1"></a><span class="st">  alpha_0 ~ std_normal();</span></span>
<span id="cb161-232"><a href="fitness-model.html#cb161-232" aria-hidden="true" tabindex="-1"></a><span class="st">  psi_1 ~ std_normal();</span></span>
<span id="cb161-233"><a href="fitness-model.html#cb161-233" aria-hidden="true" tabindex="-1"></a><span class="st">  beta_B ~ std_normal();</span></span>
<span id="cb161-234"><a href="fitness-model.html#cb161-234" aria-hidden="true" tabindex="-1"></a><span class="st">  phi ~ std_normal();</span></span>
<span id="cb161-235"><a href="fitness-model.html#cb161-235" aria-hidden="true" tabindex="-1"></a><span class="st">  </span></span>
<span id="cb161-236"><a href="fitness-model.html#cb161-236" aria-hidden="true" tabindex="-1"></a><span class="st">  //random effects</span></span>
<span id="cb161-237"><a href="fitness-model.html#cb161-237" aria-hidden="true" tabindex="-1"></a><span class="st">  to_vector(sd_P) ~ cauchy(0,1);</span></span>
<span id="cb161-238"><a href="fitness-model.html#cb161-238" aria-hidden="true" tabindex="-1"></a><span class="st">  to_vector(sd_R) ~ cauchy(0,1);</span></span>
<span id="cb161-239"><a href="fitness-model.html#cb161-239" aria-hidden="true" tabindex="-1"></a><span class="st">  </span></span>
<span id="cb161-240"><a href="fitness-model.html#cb161-240" aria-hidden="true" tabindex="-1"></a><span class="st">  LG ~ lkj_corr_cholesky(2);</span></span>
<span id="cb161-241"><a href="fitness-model.html#cb161-241" aria-hidden="true" tabindex="-1"></a><span class="st">  LE ~ lkj_corr_cholesky(2);</span></span>
<span id="cb161-242"><a href="fitness-model.html#cb161-242" aria-hidden="true" tabindex="-1"></a><span class="st">  LR ~ lkj_corr_cholesky(2);</span></span>
<span id="cb161-243"><a href="fitness-model.html#cb161-243" aria-hidden="true" tabindex="-1"></a><span class="st">  </span></span>
<span id="cb161-244"><a href="fitness-model.html#cb161-244" aria-hidden="true" tabindex="-1"></a><span class="st">  to_vector(std_devG) ~ std_normal();</span></span>
<span id="cb161-245"><a href="fitness-model.html#cb161-245" aria-hidden="true" tabindex="-1"></a><span class="st">  to_vector(std_devE) ~ std_normal();</span></span>
<span id="cb161-246"><a href="fitness-model.html#cb161-246" aria-hidden="true" tabindex="-1"></a><span class="st">  </span></span>
<span id="cb161-247"><a href="fitness-model.html#cb161-247" aria-hidden="true" tabindex="-1"></a><span class="st">  //reaction norm heritability</span></span>
<span id="cb161-248"><a href="fitness-model.html#cb161-248" aria-hidden="true" tabindex="-1"></a><span class="st">  to_vector(SRN_h2) ~ beta(1.2,1.2);</span></span>
<span id="cb161-249"><a href="fitness-model.html#cb161-249" aria-hidden="true" tabindex="-1"></a><span class="st">  </span></span>
<span id="cb161-250"><a href="fitness-model.html#cb161-250" aria-hidden="true" tabindex="-1"></a><span class="st">  //new fitness priors</span></span>
<span id="cb161-251"><a href="fitness-model.html#cb161-251" aria-hidden="true" tabindex="-1"></a><span class="st">  nu_0 ~ std_normal();</span></span>
<span id="cb161-252"><a href="fitness-model.html#cb161-252" aria-hidden="true" tabindex="-1"></a><span class="st">  sd_delta ~ cauchy(0,1);</span></span>
<span id="cb161-253"><a href="fitness-model.html#cb161-253" aria-hidden="true" tabindex="-1"></a><span class="st">  beta_N1 ~ std_normal();</span></span>
<span id="cb161-254"><a href="fitness-model.html#cb161-254" aria-hidden="true" tabindex="-1"></a><span class="st">  beta_N2 ~ std_normal();</span></span>
<span id="cb161-255"><a href="fitness-model.html#cb161-255" aria-hidden="true" tabindex="-1"></a><span class="st">  beta_S1 ~ std_normal();</span></span>
<span id="cb161-256"><a href="fitness-model.html#cb161-256" aria-hidden="true" tabindex="-1"></a><span class="st">  beta_S2 ~ std_normal();</span></span>
<span id="cb161-257"><a href="fitness-model.html#cb161-257" aria-hidden="true" tabindex="-1"></a><span class="st">  beta_I1 ~ std_normal();</span></span>
<span id="cb161-258"><a href="fitness-model.html#cb161-258" aria-hidden="true" tabindex="-1"></a><span class="st">  beta_I2 ~ std_normal();</span></span>
<span id="cb161-259"><a href="fitness-model.html#cb161-259" aria-hidden="true" tabindex="-1"></a><span class="st">  </span></span>
<span id="cb161-260"><a href="fitness-model.html#cb161-260" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb161-261"><a href="fitness-model.html#cb161-261" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb161-262"><a href="fitness-model.html#cb161-262" aria-hidden="true" tabindex="-1"></a><span class="st">generated quantities{</span></span>
<span id="cb161-263"><a href="fitness-model.html#cb161-263" aria-hidden="true" tabindex="-1"></a><span class="st">//cor and cov matrices of SRN parameters and residuals</span></span>
<span id="cb161-264"><a href="fitness-model.html#cb161-264" aria-hidden="true" tabindex="-1"></a><span class="st">matrix[2,2] Gcor = LG * LG&#39;; //G SRN correlation matric</span></span>
<span id="cb161-265"><a href="fitness-model.html#cb161-265" aria-hidden="true" tabindex="-1"></a><span class="st">matrix[2,2] Ecor = LE * LE&#39;; //E SRN correlation matric</span></span>
<span id="cb161-266"><a href="fitness-model.html#cb161-266" aria-hidden="true" tabindex="-1"></a><span class="st">matrix[2,2] Rcor = LR * LR&#39;; //residual correlation matrix</span></span>
<span id="cb161-267"><a href="fitness-model.html#cb161-267" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb161-268"><a href="fitness-model.html#cb161-268" aria-hidden="true" tabindex="-1"></a><span class="st">matrix[2,2] Rcov = diag_matrix(sd_R)*Rcor*diag_matrix(sd_R); //residual covariance</span></span>
<span id="cb161-269"><a href="fitness-model.html#cb161-269" aria-hidden="true" tabindex="-1"></a><span class="st">matrix[2,2] Gcov = diag_matrix(sd_G)*Gcor*diag_matrix(sd_G); //G SRN covariance</span></span>
<span id="cb161-270"><a href="fitness-model.html#cb161-270" aria-hidden="true" tabindex="-1"></a><span class="st">matrix[2,2] Ecov = diag_matrix(sd_E)*Ecor*diag_matrix(sd_E); //E SRN covariance</span></span>
<span id="cb161-271"><a href="fitness-model.html#cb161-271" aria-hidden="true" tabindex="-1"></a><span class="st">matrix[2,2] Pcov = Gcov + Ecov; //P SRN covariance</span></span>
<span id="cb161-272"><a href="fitness-model.html#cb161-272" aria-hidden="true" tabindex="-1"></a><span class="st">matrix[2,2] Pcor = inverse(diag_matrix(sd_P))*Pcov*inverse(diag_matrix(sd_P)); //P SRN correlation</span></span>
<span id="cb161-273"><a href="fitness-model.html#cb161-273" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb161-274"><a href="fitness-model.html#cb161-274" aria-hidden="true" tabindex="-1"></a><span class="st">//variances</span></span>
<span id="cb161-275"><a href="fitness-model.html#cb161-275" aria-hidden="true" tabindex="-1"></a><span class="st">vector&lt;lower=0&gt;[2] V_P = sd_P .* sd_P;</span></span>
<span id="cb161-276"><a href="fitness-model.html#cb161-276" aria-hidden="true" tabindex="-1"></a><span class="st">vector&lt;lower=0&gt;[2] V_G = sd_G .* sd_G;</span></span>
<span id="cb161-277"><a href="fitness-model.html#cb161-277" aria-hidden="true" tabindex="-1"></a><span class="st">vector&lt;lower=0&gt;[2] V_E = sd_E .* sd_E;</span></span>
<span id="cb161-278"><a href="fitness-model.html#cb161-278" aria-hidden="true" tabindex="-1"></a><span class="st">vector&lt;lower=0&gt;[2] V_R = sd_R .* sd_R;</span></span>
<span id="cb161-279"><a href="fitness-model.html#cb161-279" aria-hidden="true" tabindex="-1"></a><span class="st">}&quot;</span>, <span class="st">&quot;sam5_w.stan&quot;</span>)</span></code></pre></div>
<p>Depending on the sample size set during the simulation, this model will likely take 30+ min to finish sampling. The total number of iterations can be reduced to save time, but is set to a large value here to ensure sufficient effective sample sizes for some parameters.</p>
<div class="sourceCode" id="cb162"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb162-1"><a href="fitness-model.html#cb162-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(rstan)</span>
<span id="cb162-2"><a href="fitness-model.html#cb162-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb162-3"><a href="fitness-model.html#cb162-3" aria-hidden="true" tabindex="-1"></a>sam_5 <span class="ot">=</span> <span class="fu">stan_model</span>(<span class="st">&quot;sam5_w.stan&quot;</span>)</span>
<span id="cb162-4"><a href="fitness-model.html#cb162-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb162-5"><a href="fitness-model.html#cb162-5" aria-hidden="true" tabindex="-1"></a>stan_results5 <span class="ot">&lt;-</span> <span class="fu">sampling</span>(sam_5, <span class="at">data=</span>stan_data, <span class="at">init =</span> <span class="dv">0</span>, <span class="at">warmup=</span><span class="dv">1500</span>, <span class="at">iter =</span> <span class="dv">3000</span>,</span>
<span id="cb162-6"><a href="fitness-model.html#cb162-6" aria-hidden="true" tabindex="-1"></a>                         <span class="at">chains=</span><span class="dv">4</span>, <span class="at">cores=</span><span class="dv">4</span>, <span class="at">control=</span><span class="fu">list</span>(<span class="at">adapt_delta=</span><span class="fl">0.90</span>) )</span>
<span id="cb162-7"><a href="fitness-model.html#cb162-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb162-8"><a href="fitness-model.html#cb162-8" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(bayesplot) </span>
<span id="cb162-9"><a href="fitness-model.html#cb162-9" aria-hidden="true" tabindex="-1"></a><span class="fu">mcmc_areas</span>(stan_results5, <span class="at">pars =</span> <span class="fu">c</span>( <span class="st">&quot;psi_1&quot;</span>, <span class="st">&quot;nu_0&quot;</span>, <span class="st">&quot;beta_B&quot;</span>, <span class="st">&quot;beta_N1&quot;</span>, <span class="st">&quot;beta_N2&quot;</span>,</span>
<span id="cb162-10"><a href="fitness-model.html#cb162-10" aria-hidden="true" tabindex="-1"></a>                                    <span class="st">&quot;beta_S1&quot;</span>, <span class="st">&quot;beta_S2&quot;</span>, <span class="st">&quot;beta_I1&quot;</span>, <span class="st">&quot;beta_I2&quot;</span>, <span class="st">&quot;V_P[1]&quot;</span>, <span class="st">&quot;V_P[2]&quot;</span>, <span class="st">&quot;Gcor[2,1]&quot;</span>, <span class="st">&quot;Ecor[2,1]&quot;</span>, <span class="st">&quot;Rcor[2,1]&quot;</span>, <span class="st">&quot;Pcor[2,1]&quot;</span>,  <span class="st">&quot;SRN_h2[1]&quot;</span>,  <span class="st">&quot;SRN_h2[2]&quot;</span>), <span class="at">prob =</span> <span class="fl">0.9</span> )</span></code></pre></div>
<p><img src="SAMs_files/figure-html/unnamed-chunk-71-1.png" width="672" /></p>
<p>The model appears to be accurately recovering the directions and relative magnitudes of the selection coefficients in the fitness model (beta_N1 = 0.3, beta_N2 = -0.3, beta_S1 = 0.3 beta_S2 = -0.3 beta_i1 = -0.3 beta_i2 = -0.3). We can further summarize all model parameters.</p>
<div class="sourceCode" id="cb163"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb163-1"><a href="fitness-model.html#cb163-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(stan_results5, <span class="at">pars =</span> <span class="fu">c</span>( <span class="st">&quot;psi_1&quot;</span>, <span class="st">&quot;nu_0&quot;</span>, <span class="st">&quot;beta_B&quot;</span>, <span class="st">&quot;beta_N1&quot;</span>, <span class="st">&quot;beta_N2&quot;</span>,</span>
<span id="cb163-2"><a href="fitness-model.html#cb163-2" aria-hidden="true" tabindex="-1"></a>                                    <span class="st">&quot;beta_S1&quot;</span>, <span class="st">&quot;beta_S2&quot;</span>, <span class="st">&quot;beta_I1&quot;</span>, <span class="st">&quot;beta_I2&quot;</span>, <span class="st">&quot;V_P[1]&quot;</span>, <span class="st">&quot;V_P[2]&quot;</span>, <span class="st">&quot;Gcor[2,1]&quot;</span>, <span class="st">&quot;Ecor[2,1]&quot;</span>, <span class="st">&quot;Rcor[2,1]&quot;</span>, <span class="st">&quot;Pcor[2,1]&quot;</span>,  <span class="st">&quot;SRN_h2[1]&quot;</span>,  <span class="st">&quot;SRN_h2[2]&quot;</span>), <span class="at">prob =</span> <span class="fu">c</span>(<span class="fl">0.05</span>,<span class="fl">0.95</span>))<span class="sc">$</span>summary</span></code></pre></div>
<pre><code>##                   mean      se_mean         sd          5%        95%     n_eff      Rhat
## psi_1     -0.443481995 0.0012442400 0.08324063 -0.57733524 -0.3058579 4475.7147 1.0002798
## nu_0       0.958824797 0.0009086336 0.06877314  0.84340655  1.0701557 5728.7523 0.9997568
## beta_B     1.335745242 0.0010406722 0.08754562  1.19719882  1.4854762 7076.8646 0.9997239
## beta_N1    0.363103401 0.0007758041 0.06593526  0.25677521  0.4719454 7223.2282 0.9995771
## beta_N2   -0.374373613 0.0009934570 0.08322067 -0.51425842 -0.2417959 7017.2068 0.9999595
## beta_S1    0.206472948 0.0006979521 0.06270416  0.10539869  0.3097887 8071.2623 0.9996396
## beta_S2   -0.280779114 0.0009797490 0.08093746 -0.41507764 -0.1517067 6824.4783 1.0003098
## beta_I1   -0.309451571 0.0008095484 0.07429362 -0.43109493 -0.1890723 8422.0407 1.0005881
## beta_I2   -0.326841748 0.0012992289 0.10423967 -0.50185096 -0.1598171 6437.1663 0.9996360
## V_P[1]     0.690835004 0.0017936972 0.07753070  0.57235394  0.8270569 1868.3110 0.9999533
## V_P[2]     0.545449567 0.0012424577 0.06999001  0.43843487  0.6680390 3173.2841 0.9999687
## Gcor[2,1]  0.009389303 0.0172081810 0.35366488 -0.62581134  0.5319919  422.3903 1.0133265
## Ecor[2,1]  0.522813019 0.0048832868 0.12863585  0.30033595  0.7202579  693.9043 1.0054932
## Rcor[2,1] -0.258956344 0.0003668427 0.03058283 -0.30832108 -0.2086652 6950.1709 1.0000481
## Pcor[2,1]  0.375065822 0.0009400725 0.06355764  0.26736238  0.4756247 4571.0172 0.9999272
## SRN_h2[1]  0.365168571 0.0069090736 0.14819786  0.13374719  0.6275880  460.0915 1.0063465
## SRN_h2[2]  0.285351378 0.0077327609 0.16022277  0.05502978  0.5790066  429.3182 1.0078258</code></pre>
</div>
<div id="estimating-assortment-2" class="section level2" number="5.3">
<h2><span class="header-section-number">5.3</span> Estimating assortment</h2>
<p>The mean partner intrinsic trait values calculated in the model can then be used to estimate the assortment coefficient of interest <span class="math inline">\(\beta_{{\bar{\psi}&#39;}\psi}\)</span>, as well as the broader assortment matrix <span class="math inline">\(\boldsymbol{B_{\alpha}}\)</span>. We can directly calculate the quantities of the assortment matrix using the vectors of mean partner SRN parameters that we constructed and estimated with the Stan model. In this case, we’re also interesting in estimating the expected assortment within any particular breeding season, under the assumption that variation in assortment coefficients between seasons is random. To do this, we need to scale the (co)variances of interest appropriately for the expected variance of a single partner, rather than the mean of multiple partners. If the intrinsic SRN parameter values of social partners are independent Gaussian variables, then the expected variance for a single partner phenotype <span class="math inline">\(\alpha&#39;_k\)</span> can be derived from the variance of the mean phenotype of <span class="math inline">\(n\)</span> partners such that</p>
<p><span class="math display">\[\mathrm{var}\left({\alpha&#39;_k} \right) = \mathrm{var} \left( \frac{1}{n}\Sigma^n_{k=1}\alpha_k \right)*n \]</span>
Conversely, we can derive the expected variance of the mean of <span class="math inline">\(n\)</span> partners by dividing through the expected variance of a single partner <span class="math inline">\(\mathrm{var}\left({\alpha&#39;_k} \right) /n\)</span>. In this simplified simulation, individuals and their social partners’ SRN parameters are characterized by the same population variances, so we can simply use the expected variance of individual SRN intercepts and slopes, i.e. <span class="math inline">\(\mathrm{var}(\boldsymbol{\alpha})=\mathrm{var}(\boldsymbol{\alpha&#39;})\)</span>, to calculate the expected variance of the mean of <span class="math inline">\(n\)</span> partner phenotypes. We can then use this variance to transform the vector of mean partner trait values to a standardized scale (i.e. variance = 1, z-scores), and subsequently scale these standardized values to the expected variance of a single partner using <span class="math inline">\(\mathrm{var}\left({\alpha&#39;_k} \right)\)</span>.</p>
<div class="sourceCode" id="cb165"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb165-1"><a href="fitness-model.html#cb165-1" aria-hidden="true" tabindex="-1"></a><span class="co">#extract posteriors</span></span>
<span id="cb165-2"><a href="fitness-model.html#cb165-2" aria-hidden="true" tabindex="-1"></a>post <span class="ot">&lt;-</span> rstan<span class="sc">::</span><span class="fu">extract</span>(stan_results5)</span>
<span id="cb165-3"><a href="fitness-model.html#cb165-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb165-4"><a href="fitness-model.html#cb165-4" aria-hidden="true" tabindex="-1"></a><span class="co">#temporary vectors for assortment coefficients</span></span>
<span id="cb165-5"><a href="fitness-model.html#cb165-5" aria-hidden="true" tabindex="-1"></a>SRN_PV <span class="ot">=</span> post<span class="sc">$</span>V_P</span>
<span id="cb165-6"><a href="fitness-model.html#cb165-6" aria-hidden="true" tabindex="-1"></a>SRN_Psd <span class="ot">=</span> post<span class="sc">$</span>sd_P</span>
<span id="cb165-7"><a href="fitness-model.html#cb165-7" aria-hidden="true" tabindex="-1"></a>SRN_PVmean <span class="ot">=</span> post<span class="sc">$</span>V_P <span class="sc">/</span> I_partner <span class="co">#expected variance for mean of partners</span></span>
<span id="cb165-8"><a href="fitness-model.html#cb165-8" aria-hidden="true" tabindex="-1"></a>SRN_Psdmean <span class="ot">=</span> <span class="fu">sqrt</span>(SRN_PVmean) <span class="co">#expected SD for mean of partners</span></span>
<span id="cb165-9"><a href="fitness-model.html#cb165-9" aria-hidden="true" tabindex="-1"></a>SRN_focal1 <span class="ot">&lt;-</span> post<span class="sc">$</span>SRN_P[,,<span class="dv">1</span>] <span class="co">#individual intercepts</span></span>
<span id="cb165-10"><a href="fitness-model.html#cb165-10" aria-hidden="true" tabindex="-1"></a>SRN_focal2 <span class="ot">&lt;-</span> post<span class="sc">$</span>SRN_P[,,<span class="dv">2</span>] <span class="co">#individual slopes</span></span>
<span id="cb165-11"><a href="fitness-model.html#cb165-11" aria-hidden="true" tabindex="-1"></a>SRN_partner1 <span class="ot">&lt;-</span> <span class="fu">cbind</span>(post<span class="sc">$</span>partner_meanm[,,<span class="dv">1</span>], post<span class="sc">$</span>partner_meanf[,,<span class="dv">1</span>])</span>
<span id="cb165-12"><a href="fitness-model.html#cb165-12" aria-hidden="true" tabindex="-1"></a>SRN_partner2 <span class="ot">&lt;-</span> <span class="fu">cbind</span>(post<span class="sc">$</span>partner_meanm[,,<span class="dv">2</span>], post<span class="sc">$</span>partner_meanf[,,<span class="dv">2</span>])</span>
<span id="cb165-13"><a href="fitness-model.html#cb165-13" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb165-14"><a href="fitness-model.html#cb165-14" aria-hidden="true" tabindex="-1"></a><span class="co">#scale mean partner variance to variance of single partner</span></span>
<span id="cb165-15"><a href="fitness-model.html#cb165-15" aria-hidden="true" tabindex="-1"></a>SRN_partner1s <span class="ot">=</span> SRN_partner1</span>
<span id="cb165-16"><a href="fitness-model.html#cb165-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span>(j <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(SRN_partner1))</span>
<span id="cb165-17"><a href="fitness-model.html#cb165-17" aria-hidden="true" tabindex="-1"></a>    {SRN_partner1s[j,] <span class="ot">=</span> ( SRN_partner1[j,] <span class="sc">/</span> SRN_Psdmean[j,<span class="dv">1</span>] ) <span class="sc">*</span> SRN_Psd[j,<span class="dv">1</span>] }</span>
<span id="cb165-18"><a href="fitness-model.html#cb165-18" aria-hidden="true" tabindex="-1"></a>   </span>
<span id="cb165-19"><a href="fitness-model.html#cb165-19" aria-hidden="true" tabindex="-1"></a>SRN_partner2s <span class="ot">=</span> SRN_partner2</span>
<span id="cb165-20"><a href="fitness-model.html#cb165-20" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span>(j <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(SRN_partner2))</span>
<span id="cb165-21"><a href="fitness-model.html#cb165-21" aria-hidden="true" tabindex="-1"></a>    {SRN_partner2s[j,] <span class="ot">=</span> ( SRN_partner2[j,] <span class="sc">/</span> SRN_Psdmean[j,<span class="dv">2</span>] ) <span class="sc">*</span> SRN_Psd[j,<span class="dv">2</span>] }</span>
<span id="cb165-22"><a href="fitness-model.html#cb165-22" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb165-23"><a href="fitness-model.html#cb165-23" aria-hidden="true" tabindex="-1"></a><span class="co">#assortment matrix</span></span>
<span id="cb165-24"><a href="fitness-model.html#cb165-24" aria-hidden="true" tabindex="-1"></a>Beta_alpha <span class="ot">=</span> <span class="fu">list</span>()</span>
<span id="cb165-25"><a href="fitness-model.html#cb165-25" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb165-26"><a href="fitness-model.html#cb165-26" aria-hidden="true" tabindex="-1"></a><span class="co">#generate matrices across each posterior sample</span></span>
<span id="cb165-27"><a href="fitness-model.html#cb165-27" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(j <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(SRN_focal1))</span>
<span id="cb165-28"><a href="fitness-model.html#cb165-28" aria-hidden="true" tabindex="-1"></a>    {</span>
<span id="cb165-29"><a href="fitness-model.html#cb165-29" aria-hidden="true" tabindex="-1"></a>            Beta_mat <span class="ot">=</span> <span class="fu">matrix</span>(<span class="cn">NA</span>,<span class="dv">2</span>,<span class="dv">2</span>)</span>
<span id="cb165-30"><a href="fitness-model.html#cb165-30" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb165-31"><a href="fitness-model.html#cb165-31" aria-hidden="true" tabindex="-1"></a>            <span class="co">#mu&#39; ~ mu</span></span>
<span id="cb165-32"><a href="fitness-model.html#cb165-32" aria-hidden="true" tabindex="-1"></a>            Beta_mat[<span class="dv">1</span>,<span class="dv">1</span>] <span class="ot">=</span>  <span class="fu">cov</span>(SRN_focal1[j,], SRN_partner1s[j,])<span class="sc">/</span><span class="fu">var</span>(SRN_focal1[j,])</span>
<span id="cb165-33"><a href="fitness-model.html#cb165-33" aria-hidden="true" tabindex="-1"></a>            <span class="co">#mu&#39; ~ psi</span></span>
<span id="cb165-34"><a href="fitness-model.html#cb165-34" aria-hidden="true" tabindex="-1"></a>            Beta_mat[<span class="dv">2</span>,<span class="dv">1</span>] <span class="ot">=</span>  <span class="fu">cov</span>(SRN_focal2[j,], SRN_partner1s[j,])<span class="sc">/</span><span class="fu">var</span>(SRN_focal2[j,])</span>
<span id="cb165-35"><a href="fitness-model.html#cb165-35" aria-hidden="true" tabindex="-1"></a>            <span class="co">#psi&#39; ~ mu                                                        </span></span>
<span id="cb165-36"><a href="fitness-model.html#cb165-36" aria-hidden="true" tabindex="-1"></a>            Beta_mat[<span class="dv">1</span>,<span class="dv">2</span>] <span class="ot">=</span>  <span class="fu">cov</span>(SRN_focal1[j,], SRN_partner2s[j,])<span class="sc">/</span><span class="fu">var</span>(SRN_focal1[j,])</span>
<span id="cb165-37"><a href="fitness-model.html#cb165-37" aria-hidden="true" tabindex="-1"></a>            <span class="co">#psi&#39; ~ psi</span></span>
<span id="cb165-38"><a href="fitness-model.html#cb165-38" aria-hidden="true" tabindex="-1"></a>            Beta_mat[<span class="dv">2</span>,<span class="dv">2</span>] <span class="ot">=</span>  <span class="fu">cov</span>(SRN_focal2[j,], SRN_partner2s[j,])<span class="sc">/</span><span class="fu">var</span>(SRN_focal2[j,])</span>
<span id="cb165-39"><a href="fitness-model.html#cb165-39" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb165-40"><a href="fitness-model.html#cb165-40" aria-hidden="true" tabindex="-1"></a>            Beta_alpha[[j]] <span class="ot">=</span> Beta_mat</span>
<span id="cb165-41"><a href="fitness-model.html#cb165-41" aria-hidden="true" tabindex="-1"></a>    } </span>
<span id="cb165-42"><a href="fitness-model.html#cb165-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb165-43"><a href="fitness-model.html#cb165-43" aria-hidden="true" tabindex="-1"></a><span class="co">#extract beta_mu&#39;mu (assortment on SRN intercepts)</span></span>
<span id="cb165-44"><a href="fitness-model.html#cb165-44" aria-hidden="true" tabindex="-1"></a>Beta_psi <span class="ot">=</span> <span class="fu">unlist</span>(<span class="fu">lapply</span>(Beta_alpha, <span class="cf">function</span>(x) x[<span class="dv">2</span>,<span class="dv">2</span>]))</span>
<span id="cb165-45"><a href="fitness-model.html#cb165-45" aria-hidden="true" tabindex="-1"></a><span class="fu">median</span>(Beta_psi); <span class="fu">sum</span>(Beta_psi <span class="sc">&gt;</span> <span class="dv">0</span>)<span class="sc">/</span><span class="fu">length</span>(Beta_psi)</span></code></pre></div>
<pre><code>## [1] 0.2270953</code></pre>
<pre><code>## [1] 1</code></pre>
<p>Positive assortment of moderate effect size is detected.</p>
</div>
<div id="estimating-selection-differentials-and-genetic-responses" class="section level2" number="5.4">
<h2><span class="header-section-number">5.4</span> Estimating selection differentials and genetic responses</h2>
<p>We’re now in a position to estimate the effects of selection. First, we should calculate the ‘true’ selection differential and response to gauge the degree of bias and uncertainty in our empirical estimates. Following <strong>Eq6-8</strong>, the selection differentials for SRN parameters are given by</p>
<p><span class="math display">\[\boldsymbol{s}=\begin{Bmatrix} s_{\bar{\mu}} \\ s_{{\bar{\psi}}} \end{Bmatrix} = \boldsymbol{P}\boldsymbol{\beta_N}+\boldsymbol{C}\boldsymbol{\beta_{S}}\]</span></p>
<p>where <span class="math inline">\(\boldsymbol{P}=\boldsymbol{G}+\boldsymbol{E}\)</span> is the phenotypic covariance of individuals’ SRN parameters and <span class="math inline">\(\boldsymbol{C}\)</span> is the covariance between individuals’ SRN parameters and the mean SRN parameters of their social partners. As noted above, we have assumed for simplicity that selection effects are constant across breeding seasons, which could be tested in an empirical dataset by including interactions between the basic SAM fitness model coefficients and a variable for the season (or selection event more generally). In this case, we use the repeated fitness measures to estimate the expected selection effects across seasons. Then using our information on the assortment among social partners within a season, we can estimate the expected selection differential within a season. In particular, we can calculate <span class="math inline">\(\boldsymbol{C}\)</span> by</p>
<p><span class="math display">\[\mathrm{diag}(\boldsymbol{P})\boldsymbol{B_{\alpha}}\]</span>
where <span class="math inline">\(\mathrm{diag}(\boldsymbol{P})\)</span> is a matrix with the variances of SRN parameters on the diagonal and <span class="math inline">\(\boldsymbol{B_{\alpha}}\)</span> is the assortment matrix calculated above. With this information, as well as the simulated values fixed above, we can derive the expected selection gradient within any particular season. Note that because we’ve used zero-centered SRN parameters in the fitness model, the expected response is not influenced by the interaction coefficients for intercepts and slopes. See Appendix S1 of <span class="citation"><a href="#ref-SAM" role="doc-biblioref">Martin and Jaeggi</a> (<a href="#ref-SAM" role="doc-biblioref">2021</a>)</span> for further discussion. As noted above, this assumption can be removed from the fitness model by modifying the SAM code e.g. to use absolute (population + individual) values or season-specific covariates to account for between-season variation in the population mean.</p>
<div class="sourceCode" id="cb168"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb168-1"><a href="fitness-model.html#cb168-1" aria-hidden="true" tabindex="-1"></a><span class="co">#selection differentials and response</span></span>
<span id="cb168-2"><a href="fitness-model.html#cb168-2" aria-hidden="true" tabindex="-1"></a>P_cov <span class="ot">=</span> G_cov <span class="sc">+</span> E_cov</span>
<span id="cb168-3"><a href="fitness-model.html#cb168-3" aria-hidden="true" tabindex="-1"></a>Beta_N <span class="ot">=</span> <span class="fu">matrix</span>(<span class="fu">c</span>(beta_n1,beta_n2),<span class="dv">2</span>,<span class="dv">1</span>)</span>
<span id="cb168-4"><a href="fitness-model.html#cb168-4" aria-hidden="true" tabindex="-1"></a>Beta_S <span class="ot">=</span> <span class="fu">matrix</span>(<span class="fu">c</span>(beta_s1,beta_s2),<span class="dv">2</span>,<span class="dv">1</span>)</span>
<span id="cb168-5"><a href="fitness-model.html#cb168-5" aria-hidden="true" tabindex="-1"></a>B_alpha <span class="ot">=</span> <span class="fu">matrix</span>(<span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">0</span>,r_alpha),<span class="dv">2</span>,<span class="dv">2</span>) <span class="co">#lower right corner, psi&#39;~psi</span></span>
<span id="cb168-6"><a href="fitness-model.html#cb168-6" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb168-7"><a href="fitness-model.html#cb168-7" aria-hidden="true" tabindex="-1"></a>true_differential <span class="ot">=</span> P_cov <span class="sc">%*%</span> Beta_N <span class="sc">+</span> <span class="fu">diag</span>(<span class="fu">diag</span>(P_cov),<span class="dv">2</span>) <span class="sc">%*%</span> B_alpha <span class="sc">%*%</span> Beta_S</span>
<span id="cb168-8"><a href="fitness-model.html#cb168-8" aria-hidden="true" tabindex="-1"></a>true_differential</span></code></pre></div>
<pre><code>##        [,1]
## [1,]  0.126
## [2,] -0.180</code></pre>
<div class="sourceCode" id="cb170"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb170-1"><a href="fitness-model.html#cb170-1" aria-hidden="true" tabindex="-1"></a>true_response <span class="ot">=</span> G_cov <span class="sc">%*%</span> Beta_N <span class="sc">+</span> <span class="fu">diag</span>(<span class="fu">diag</span>(G_cov),<span class="dv">2</span>) <span class="sc">%*%</span> B_alpha <span class="sc">%*%</span> Beta_S</span>
<span id="cb170-2"><a href="fitness-model.html#cb170-2" aria-hidden="true" tabindex="-1"></a>true_response</span></code></pre></div>
<pre><code>##        [,1]
## [1,]  0.063
## [2,] -0.090</code></pre>
<p>Now we can calculate our empirical prediction and compare.</p>
<div class="sourceCode" id="cb172"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb172-1"><a href="fitness-model.html#cb172-1" aria-hidden="true" tabindex="-1"></a><span class="co">#generate other relevant matrices</span></span>
<span id="cb172-2"><a href="fitness-model.html#cb172-2" aria-hidden="true" tabindex="-1"></a>  Beta_N <span class="ot">=</span> <span class="fu">matrix</span>(<span class="fu">c</span>(post<span class="sc">$</span>beta_N1,post<span class="sc">$</span>beta_N2),<span class="at">ncol=</span><span class="dv">2</span>)</span>
<span id="cb172-3"><a href="fitness-model.html#cb172-3" aria-hidden="true" tabindex="-1"></a>  Beta_S <span class="ot">=</span> <span class="fu">matrix</span>(<span class="fu">c</span>(post<span class="sc">$</span>beta_S1,post<span class="sc">$</span>beta_S2),<span class="at">ncol=</span><span class="dv">2</span>)</span>
<span id="cb172-4"><a href="fitness-model.html#cb172-4" aria-hidden="true" tabindex="-1"></a>  P <span class="ot">=</span> post<span class="sc">$</span>Pcov</span>
<span id="cb172-5"><a href="fitness-model.html#cb172-5" aria-hidden="true" tabindex="-1"></a>  G <span class="ot">=</span> post<span class="sc">$</span>Gcov</span>
<span id="cb172-6"><a href="fitness-model.html#cb172-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb172-7"><a href="fitness-model.html#cb172-7" aria-hidden="true" tabindex="-1"></a><span class="co">#selection differential</span></span>
<span id="cb172-8"><a href="fitness-model.html#cb172-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb172-9"><a href="fitness-model.html#cb172-9" aria-hidden="true" tabindex="-1"></a>  <span class="co">#initialize dataframe</span></span>
<span id="cb172-10"><a href="fitness-model.html#cb172-10" aria-hidden="true" tabindex="-1"></a>  s_SRN <span class="ot">=</span> <span class="fu">data.frame</span>(<span class="at">s_mu =</span> <span class="fu">rep</span>(<span class="cn">NA</span>,<span class="fu">nrow</span>(Beta_N)), <span class="at">s_psi =</span> <span class="fu">rep</span>(<span class="cn">NA</span>,<span class="fu">nrow</span>(Beta_N)))</span>
<span id="cb172-11"><a href="fitness-model.html#cb172-11" aria-hidden="true" tabindex="-1"></a>   </span>
<span id="cb172-12"><a href="fitness-model.html#cb172-12" aria-hidden="true" tabindex="-1"></a>  <span class="co">#populate with selection differentials</span></span>
<span id="cb172-13"><a href="fitness-model.html#cb172-13" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(j <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(P)){</span>
<span id="cb172-14"><a href="fitness-model.html#cb172-14" aria-hidden="true" tabindex="-1"></a>      s_SRN[j,] <span class="ot">=</span> P[j,,] <span class="sc">%*%</span> <span class="fu">t</span>(<span class="fu">t</span>(Beta_N[j,])) <span class="sc">+</span> <span class="fu">diag</span>(<span class="fu">diag</span>(P[j,,]),<span class="dv">2</span>,) <span class="sc">%*%</span> Beta_alpha[[j]] <span class="sc">%*%</span> <span class="fu">t</span>(<span class="fu">t</span>(Beta_S[j,])) }</span>
<span id="cb172-15"><a href="fitness-model.html#cb172-15" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb172-16"><a href="fitness-model.html#cb172-16" aria-hidden="true" tabindex="-1"></a>  <span class="co">#median</span></span>
<span id="cb172-17"><a href="fitness-model.html#cb172-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">apply</span>(s_SRN,<span class="dv">2</span>,median)</span></code></pre></div>
<pre><code>##       s_mu      s_psi 
##  0.1590266 -0.1388207</code></pre>
<div class="sourceCode" id="cb174"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb174-1"><a href="fitness-model.html#cb174-1" aria-hidden="true" tabindex="-1"></a>  <span class="co">#absolute bias for true value</span></span>
<span id="cb174-2"><a href="fitness-model.html#cb174-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">apply</span>(s_SRN,<span class="dv">2</span>,median) <span class="sc">-</span> true_differential</span></code></pre></div>
<pre><code>##            [,1]
## [1,] 0.03302660
## [2,] 0.04117927</code></pre>
<div class="sourceCode" id="cb176"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb176-1"><a href="fitness-model.html#cb176-1" aria-hidden="true" tabindex="-1"></a><span class="co">#response to selection</span></span>
<span id="cb176-2"><a href="fitness-model.html#cb176-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb176-3"><a href="fitness-model.html#cb176-3" aria-hidden="true" tabindex="-1"></a>  <span class="co">#initialize dataframe</span></span>
<span id="cb176-4"><a href="fitness-model.html#cb176-4" aria-hidden="true" tabindex="-1"></a>  response_SRN <span class="ot">=</span> <span class="fu">data.frame</span>(<span class="at">delta_mu=</span> <span class="fu">rep</span>(<span class="cn">NA</span>,<span class="fu">nrow</span>(Beta_N)), <span class="at">delta_psi =</span> <span class="fu">rep</span>(<span class="cn">NA</span>,<span class="fu">nrow</span>(Beta_N)))</span>
<span id="cb176-5"><a href="fitness-model.html#cb176-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb176-6"><a href="fitness-model.html#cb176-6" aria-hidden="true" tabindex="-1"></a>  <span class="co">#populate with response to selection</span></span>
<span id="cb176-7"><a href="fitness-model.html#cb176-7" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(j <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(G)){</span>
<span id="cb176-8"><a href="fitness-model.html#cb176-8" aria-hidden="true" tabindex="-1"></a>  response_SRN[j,] <span class="ot">=</span> G[j,,] <span class="sc">%*%</span> <span class="fu">t</span>(<span class="fu">t</span>(Beta_N[j,])) <span class="sc">+</span> <span class="fu">diag</span>(<span class="fu">diag</span>(G[j,,]),<span class="dv">2</span>,) <span class="sc">%*%</span> Beta_alpha[[j]] <span class="sc">%*%</span> <span class="fu">t</span>(<span class="fu">t</span>(Beta_S[j,]))  }</span>
<span id="cb176-9"><a href="fitness-model.html#cb176-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb176-10"><a href="fitness-model.html#cb176-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">apply</span>(response_SRN,<span class="dv">2</span>,median)</span></code></pre></div>
<pre><code>##    delta_mu   delta_psi 
##  0.08024632 -0.05399714</code></pre>
<div class="sourceCode" id="cb178"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb178-1"><a href="fitness-model.html#cb178-1" aria-hidden="true" tabindex="-1"></a>  <span class="co">#absolute bias for true value</span></span>
<span id="cb178-2"><a href="fitness-model.html#cb178-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">apply</span>(response_SRN,<span class="dv">2</span>,median) <span class="sc">-</span> true_response</span></code></pre></div>
<pre><code>##            [,1]
## [1,] 0.01724632
## [2,] 0.03600286</code></pre>
<p>As shown in Figure 2 of <span class="citation"><a href="#ref-SAM" role="doc-biblioref">Martin and Jaeggi</a> (<a href="#ref-SAM" role="doc-biblioref">2021</a>)</span>, we expect desirable performance at this sample size for accurately predicting the selection differentials and responses.</p>

</div>
</div>
<h3>Resources</h3>
<div id="refs" class="references csl-bib-body hanging-indent">
<div id="ref-SAM" class="csl-entry">
Martin, J. S., and A. V. Jaeggi. 2021. <span>“Social Animal Models for Quantifying Plasticity, Assortment, and Selection on Interacting Phenotypes.”</span> <em>Journal of Evolutionary Biology</em>. <a href="https://doi.org/10.1111/jeb.13900">https://doi.org/10.1111/jeb.13900</a>.
</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="within-and-between-partner-sam.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="extending-sams.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"whatsapp": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": null,
"text": null
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": null,
"toc": {
"collapse": "subsection"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
