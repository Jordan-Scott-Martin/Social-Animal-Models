<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>2 Within partner SAM | Estimating Social Animal Models in Stan</title>
  <meta name="description" content="2 Within partner SAM | Estimating Social Animal Models in Stan" />
  <meta name="generator" content="bookdown 0.21 and GitBook 2.6.7" />

  <meta property="og:title" content="2 Within partner SAM | Estimating Social Animal Models in Stan" />
  <meta property="og:type" content="book" />
  
  
  
  

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="2 Within partner SAM | Estimating Social Animal Models in Stan" />
  
  
  

<meta name="author" content="Jordan S. Martin &amp; Adrian V. Jaeggi" />


<meta name="date" content="2021-05-21" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="using-stan-in-r.html"/>
<link rel="next" href="between-partner-sam.html"/>
<script src="libs/header-attrs-2.6/header-attrs.js"></script>
<script src="libs/jquery-2.2.3/jquery.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />











<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li class="chapter" data-level="" data-path="introduction.html"><a href="introduction.html"><i class="fa fa-check"></i>Introduction</a></li>
<li class="chapter" data-level="1" data-path="using-stan-in-r.html"><a href="using-stan-in-r.html"><i class="fa fa-check"></i><b>1</b> Using Stan in R</a>
<ul>
<li class="chapter" data-level="1.1" data-path="using-stan-in-r.html"><a href="using-stan-in-r.html#why-stan"><i class="fa fa-check"></i><b>1.1</b> Why Stan?</a></li>
<li class="chapter" data-level="1.2" data-path="using-stan-in-r.html"><a href="using-stan-in-r.html#getting-started"><i class="fa fa-check"></i><b>1.2</b> Getting Started</a></li>
<li class="chapter" data-level="1.3" data-path="using-stan-in-r.html"><a href="using-stan-in-r.html#bayesian-inference"><i class="fa fa-check"></i><b>1.3</b> Bayesian inference</a></li>
<li class="chapter" data-level="1.4" data-path="using-stan-in-r.html"><a href="using-stan-in-r.html#basic-coding-tutorial"><i class="fa fa-check"></i><b>1.4</b> Basic coding tutorial</a>
<ul>
<li class="chapter" data-level="1.4.1" data-path="using-stan-in-r.html"><a href="using-stan-in-r.html#cholesky-decompositions"><i class="fa fa-check"></i><b>1.4.1</b> Cholesky decompositions</a></li>
<li class="chapter" data-level="1.4.2" data-path="using-stan-in-r.html"><a href="using-stan-in-r.html#non-centered-random-effects"><i class="fa fa-check"></i><b>1.4.2</b> Non-centered random effects</a></li>
</ul></li>
<li class="chapter" data-level="1.5" data-path="using-stan-in-r.html"><a href="using-stan-in-r.html#animal-models"><i class="fa fa-check"></i><b>1.5</b> Animal models</a>
<ul>
<li class="chapter" data-level="1.5.1" data-path="using-stan-in-r.html"><a href="using-stan-in-r.html#kronecker-products"><i class="fa fa-check"></i><b>1.5.1</b> Kronecker products</a></li>
<li class="chapter" data-level="1.5.2" data-path="using-stan-in-r.html"><a href="using-stan-in-r.html#identifying-genetic-effects"><i class="fa fa-check"></i><b>1.5.2</b> Identifying genetic effects</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="2" data-path="within-partner-sam.html"><a href="within-partner-sam.html"><i class="fa fa-check"></i><b>2</b> Within partner SAM</a>
<ul>
<li class="chapter" data-level="2.1" data-path="within-partner-sam.html"><a href="within-partner-sam.html#formal-overview"><i class="fa fa-check"></i><b>2.1</b> Formal overview</a></li>
<li class="chapter" data-level="2.2" data-path="within-partner-sam.html"><a href="within-partner-sam.html#computational-approach"><i class="fa fa-check"></i><b>2.2</b> Computational approach</a></li>
<li class="chapter" data-level="2.3" data-path="within-partner-sam.html"><a href="within-partner-sam.html#simulate-data"><i class="fa fa-check"></i><b>2.3</b> Simulate data</a></li>
<li class="chapter" data-level="2.4" data-path="within-partner-sam.html"><a href="within-partner-sam.html#coding-the-model"><i class="fa fa-check"></i><b>2.4</b> Coding the model</a></li>
</ul></li>
<li class="chapter" data-level="3" data-path="between-partner-sam.html"><a href="between-partner-sam.html"><i class="fa fa-check"></i><b>3</b> Between partner SAM</a></li>
<li class="chapter" data-level="4" data-path="between-and-within-partner-sam.html"><a href="between-and-within-partner-sam.html"><i class="fa fa-check"></i><b>4</b> Between-and-within partner SAM</a></li>
<li class="chapter" data-level="5" data-path="extending-sams.html"><a href="extending-sams.html"><i class="fa fa-check"></i><b>5</b> Extending SAMs</a></li>
<li class="chapter" data-level="" data-path="resources.html"><a href="resources.html"><i class="fa fa-check"></i>Resources</a></li>
</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Estimating Social Animal Models in Stan</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="within-partner-sam" class="section level1" number="2">
<h1><span class="header-section-number">2</span> Within partner SAM</h1>
<p>SAMs build on the Stan code we used for a basic animal model (Chapter 1) in three key ways: (i) by implementing an autoregressive moving average (ARMA) function between the social reaction norms (SRNs) of individuals and their partners, (ii) within-individual centering of SRNs, and (iii) estimating selection gradients on SRN parameters. Note that (ii) is only applicable to study designs in which individuals are measured across multiple partners, and thus does not apply to the model presented below, while (iii) is handled in the fitness model chapter. The theoretical and statistical motivation behind each of these extensions is explained in detail by <span class="citation"><a href="resources.html#ref-SAM" role="doc-biblioref">Martin and Jaeggi</a> (<a href="resources.html#ref-SAM" role="doc-biblioref">2021</a>)</span>. After estimating a SAM, we also want to extract the model posteriors and subsequently estimate the assortment matrix <span class="math inline">\(\boldsymbol{\mathrm{B_{\alpha}}}\)</span>, the selection gradients <span class="math inline">\(\mathrm{s_{\mu}}\)</span> and <span class="math inline">\(\mathrm{s_{\psi}}\)</span>, and the responses to selection <span class="math inline">\(\Delta \bar{\mathrm{\mu}}\)</span> and <span class="math inline">\(\Delta \bar{\mathrm{\psi}}\)</span>.</p>
<p>Here we provide a tutorial for the within-partner SAM, presented as <strong>Eq 3.1</strong> in <span class="citation"><a href="resources.html#ref-SAM" role="doc-biblioref">Martin and Jaeggi</a> (<a href="resources.html#ref-SAM" role="doc-biblioref">2021</a>)</span>, which is appropriate for sampling designs where each individual is measured interacting with a single partner over multiple time intervals, e.g. <span class="math inline">\(t= \left \{ 1,2,3 \right \}\)</span> to index the first, second, and third observation of a focal individual with the same social partner. We ignore the fitness model proposed in <strong>Eq 5</strong> until the fitness model chapter to focus attention on coding the basic SAM. For clarity, we focus on the simple linear models presented in the paper, largely ignoring complications such as the inclusion of additional random and fixed effects for adjusting estimates, which can be accomplished using basic approaches for any Stan model. See the <a href="https://mc-stan.org/docs/2_25/reference-manual/index.html">Stan Reference Manual</a> and <a href="https://mc-stan.org/users/documentation/case-studies">Stan Case Studies</a> for further details. The detailed coding tutorials in Chapter 1 are also crucial for understanding the Cholesky decompositions, reaction norm heritabilities, and non-centered and matrix normal parametrizations used below, which we do not review again in detail.</p>
<div id="formal-overview" class="section level2" number="2.1">
<h2><span class="header-section-number">2.1</span> Formal overview</h2>
<p>The formal model for the focal individual is given by</p>
<p><span class="math display">\[z_{jt} = \mu_0 + \eta_{jt} + \xi_{jt}\]</span>
<span class="math display">\[\eta_{jt} = \begin{Bmatrix}
\mu_j + \left( \psi_1 + \psi_j \right)\mu_k&#39; &amp; \mathrm{if} \ t = 1 \\ 
\mu_j + \left( \psi_1 + \psi_j \right)\eta_{kt-1}&#39; &amp; \mathrm{else}
\end{Bmatrix} \]</span></p>
<p><span class="math display">\[\xi_{jt} = \begin{Bmatrix}
\epsilon_j &amp; \mathrm{if} \ t = 1 \\ 
\epsilon_j + \phi\epsilon_{kt-1}&#39; &amp; \mathrm{else}
\end{Bmatrix} \]</span></p>
<p><span class="math display">\[\mu_j = \mu_{\mathrm{A}j} + \mu_{\mathrm{E}j}, \quad  \psi_j = \psi_{\mathrm{A}j} + \psi_{\mathrm{E}j}\]</span>
with the equivalent specification for the social partner</p>
<p><span class="math display">\[z_{kt}&#39; = \mu_0 + \eta_{kt}&#39; + \xi_{kt}&#39;\]</span>
<span class="math display">\[\eta_{kt}&#39; = \begin{Bmatrix}
\mu_k&#39; + \left( \psi_1 + \psi_k&#39; \right)\mu_j &amp; \mathrm{if} \ t = 1 \\ 
\mu_k&#39; + \left( \psi_1 + \psi_k&#39; \right)\eta_{jt-1} &amp; \mathrm{else}
\end{Bmatrix} \]</span></p>
<p><span class="math display">\[\xi_{kt}&#39; = \begin{Bmatrix}
\epsilon_k&#39; &amp; \mathrm{if} \ t = 1 \\ 
\epsilon_k&#39; + \phi\epsilon_{jt-1} &amp; \mathrm{else}
\end{Bmatrix} \]</span></p>
<p><span class="math display">\[\mu_k&#39; = \mu_{\mathrm{A}k}&#39; + \mu_{\mathrm{E}j}&#39;, \quad  \psi_k&#39; = \psi_{\mathrm{A}k}&#39; + \psi_{\mathrm{E}k}&#39;\]</span>
The random effects are assumed to be well-described by multivariate normal distributions.</p>
<p><span class="math display">\[\begin{bmatrix} \boldsymbol{\mu_{\mathrm{A}}}, \boldsymbol{\mu&#39;_{\mathrm{A}}},\boldsymbol{\psi_{\mathrm{A}}},\boldsymbol{\psi}&#39;_{\mathrm{A}}  \end{bmatrix}^{\mathrm{T}} \sim \mathrm{MVNormal}(\boldsymbol{0}, \boldsymbol{\mathrm{G}} \otimes \boldsymbol{\mathrm{A}} ) \]</span>
<span class="math display">\[\begin{bmatrix} \boldsymbol{\mu_{\mathrm{E}}}, \boldsymbol{\mu&#39;_{\mathrm{E}}},\boldsymbol{\psi_{\mathrm{E}}},\boldsymbol{\psi}&#39;_{\mathrm{E}}  \end{bmatrix}^{\mathrm{T}} \sim \mathrm{MVNormal}(\boldsymbol{0}, \boldsymbol{\mathrm{E}} \otimes \boldsymbol{\mathrm{I}} ) \]</span>
<span class="math display">\[\begin{bmatrix} \boldsymbol{\epsilon}, \boldsymbol{\epsilon}&#39; \end{bmatrix}^{\mathrm{T}} \sim \mathrm{MVNormal}(\boldsymbol{0}, \boldsymbol{\mathrm{\Sigma}} ) \]</span>
We also assume that the social reaction norm (SRN) intercept and slope (co)variances are equivalent for focal (<span class="math inline">\(\boldsymbol{\mu},\boldsymbol{\psi}\)</span>) and social partners (<span class="math inline">\(\boldsymbol{\mu}&#39;,\boldsymbol{\psi}&#39;\)</span>). The G matrix can therefore be reduced to a 2x2 matrix for all individuals in the population</p>
<p><span class="math display">\[\boldsymbol{\mathrm{G}}= \begin{bmatrix} \mathrm{var([\boldsymbol{\mu},\boldsymbol{\mu}&#39;])} &amp; \mathrm{cov([\boldsymbol{\mu},\boldsymbol{\mu}&#39;],[\boldsymbol{\psi},\boldsymbol{\psi}&#39;])} \\ \mathrm{cov([\boldsymbol{\psi},\boldsymbol{\psi}&#39;],[\boldsymbol{\mu},\boldsymbol{\mu}&#39;])} &amp;
\mathrm{var([\boldsymbol{\psi},\boldsymbol{\psi}&#39;])} \end{bmatrix}\]</span></p>
<p>The residual matrix <span class="math inline">\(\boldsymbol{\Sigma}\)</span>, however, estimates separate variances and covariances for the focal and partner residuals, which allows the model to account for residual covariance and feedback effects (collectively referred to as SRN measurement errors <span class="math inline">\(\boldsymbol{\xi}\)</span> and <span class="math inline">\(\boldsymbol{\xi}&#39;\)</span>).</p>
<p><span class="math display">\[\boldsymbol{\Sigma}= \begin{bmatrix} \mathrm{var(\boldsymbol{\epsilon})} &amp; \mathrm{cov}(\boldsymbol{\epsilon},\boldsymbol{\epsilon}&#39;) \\ 
\mathrm{cov}(\boldsymbol{\epsilon}&#39;,\boldsymbol{\epsilon}) &amp;
\mathrm{var(\boldsymbol{\epsilon&#39;})}     \end{bmatrix}\]</span>
This model is, therefore, appropriate for situations where the distinction between focal and partner is semi-arbitrary, e.g. when measuring within-sex interactions or when males and females exhibit similar patterns of phenotypic variation. In this case, we make the latter assumption for simplicity. To account for differences between the responses of focal individuals and social partners, the model can simply be extended with additional parameters, e.g. specifying separate <span class="math inline">\(G_M\)</span> and <span class="math inline">\(G_F\)</span> matrices for males and female respective genetic (co)variances and so on.</p>
</div>
<div id="computational-approach" class="section level2" number="2.2">
<h2><span class="header-section-number">2.2</span> Computational approach</h2>
<p>As shown in Chapter 1, we can express the formal model above in a mathematically equivalent but more computationally efficient manner by decomposing the covariance matrices into matrices of correlations and SDs, using lower triangular Cholesky decompositions on the correlation matrices. For example, the genetic covariance is given by</p>
<p><span class="math display">\[\boldsymbol{\mathrm{G}}_{cov}=
\boldsymbol{\mathrm{G}_{sd}}
\boldsymbol{\mathrm{G}}_{cor}
\boldsymbol{\mathrm{G}_{sd}}\]</span></p>
<p><span class="math display">\[\boldsymbol{\mathrm{G}}_{cor} = 
\boldsymbol{\mathrm{L}}_{Gcor} \boldsymbol{\mathrm{L}}_{Gcor}^{\mathrm{T}} 
=
\begin{bmatrix}
1
&amp; \mathrm{cor}([\boldsymbol{\mu},\boldsymbol{\mu&#39;}],[\boldsymbol{\psi},\boldsymbol{\psi&#39;}] ) \\ 
 \mathrm{cor}([\boldsymbol{\psi},\boldsymbol{\psi&#39;}], [\boldsymbol{\mu},\boldsymbol{\mu&#39;}] ) &amp;
1
\end{bmatrix}\]</span></p>
<p><span class="math display">\[\boldsymbol{\mathrm{G}_{sd}}=\begin{bmatrix}
\mathrm{sd}([\boldsymbol{\mu},\boldsymbol{\mu&#39;}])
&amp; 0 \\ 0 &amp;
\mathrm{sd}([\boldsymbol{\psi},\boldsymbol{\psi&#39;}])
\end{bmatrix}\]</span></p>
<p>The estimation of the Kronecker product <span class="math inline">\(\boldsymbol{\mathrm{G}} \otimes \boldsymbol{\mathrm{A}}\)</span> is achieved through sampling of a non-centered matrix normal distribution</p>
<p><span class="math display">\[\begin{bmatrix}
[\boldsymbol{\mu_{\mathrm{A}}}, \boldsymbol{\mu_{\mathrm{A}}}&#39;]^{\mathrm{T}} &amp;
[\boldsymbol{\psi_{\mathrm{A}}}, \boldsymbol{\psi_{\mathrm{A}}}&#39;]^{\mathrm{T}}
\end{bmatrix} = \boldsymbol{L_{\mathrm{A}}} \begin{bmatrix}
[\boldsymbol{\mu_{\mathrm{A.std}}}, \boldsymbol{\mu_{\mathrm{A.std}}}&#39;]^{\mathrm{T}} &amp;
[\boldsymbol{\psi_{\mathrm{A.std}}}, \boldsymbol{\psi_{\mathrm{A.std}}}&#39;]^{\mathrm{T}}
\end{bmatrix} (\boldsymbol{\mathrm{G}_{sd}}\boldsymbol{\mathrm{L}_{Gcor}})^{\mathrm{T}} \]</span></p>
<p>which is appropriate for estimating values drawn from</p>
<p><span class="math display">\[\begin{bmatrix}[\boldsymbol{\mu_{\mathrm{A}}}, \boldsymbol{\mu_{\mathrm{A}}}&#39;]^{\mathrm{T}} &amp;
[\boldsymbol{\psi_{\mathrm{A}}}, \boldsymbol{\psi_{\mathrm{A}}}&#39;]^{\mathrm{T}}
\end{bmatrix}
\sim  \mathrm{Matrix\ Normal}(\boldsymbol{0},
\boldsymbol{\mathrm{L_A}} \boldsymbol{\mathrm{L_A}}^{\mathrm{T}},
\boldsymbol{\mathrm{L_{Gcov}}} \boldsymbol{\mathrm{L_{Gcov}}}^{\mathrm{T}} ) \equiv \\
\mathrm{vec}( 
\begin{bmatrix}
[\boldsymbol{\mu_{\mathrm{A}}}, \boldsymbol{\mu_{\mathrm{A}}}&#39;]^{\mathrm{T}} &amp;
[\boldsymbol{\psi_{\mathrm{A}}}, \boldsymbol{\psi_{\mathrm{A}}}&#39;]^{\mathrm{T}}
\end{bmatrix})
\sim \mathrm{MVNormal}(\mathrm{vec}(\boldsymbol{\mathrm{0}}),  \boldsymbol{\mathrm{G_{cov}}} \otimes \boldsymbol{\mathrm{A}} ) \]</span></p>
<p>The environmental effects are estimated with a standard non-centered multivariate matrix normal parametrization</p>
<p><span class="math display">\[\mathrm{SRN}_{\mathrm{E}}=\left[ \boldsymbol{\mu_{\mathrm{E}}} \ \boldsymbol{\mu_{\mathrm{E}}}&#39; \right]=\left[ \boldsymbol{\mu_{\mathrm{E.std}}} \ \boldsymbol{\mu_{\mathrm{E.std}}}&#39; \right] 
(\boldsymbol{\mathrm{E}_{sd}}\boldsymbol{\mathrm{L}_{Ecor}})^{\mathrm{T}} \]</span>
The <span class="math inline">\(\mathrm{std}\)</span> values are standard normal deviates, i.e. <span class="math inline">\(\mathrm{std~\sim Normal}(0, 1)\)</span>, that are scaled to appropriate (co)variance through the separated SD and correlation parameters.</p>
<p>For Bayesian estimation, we place very weakly regularizing priors on the fixed population intercept, slope, and residual feedback parameters.</p>
<p><span class="math display">\[\mu_0, \psi_1, \phi \sim \mathrm{Normal}(0, 1)\]</span>
As explained in Chapter 1, we also place priors on the total phenotypic variance of the SRN intercepts and slopes, as well as SRN heritability parameters that are used to derive the additive genetic and permanent environmental variance.</p>
<p><span class="math display">\[\mathrm{sd}([\boldsymbol{\mu},\boldsymbol{\mu&#39;}]), \mathrm{sd}([\boldsymbol{\psi},\boldsymbol{\psi&#39;}])\sim \mathrm{Half-Cauchy}(0,1)\]</span>
<span class="math display">\[h_{\mu}^{2}, h_{\psi}^{2} \sim \mathrm{Beta}(1.2,1.2) \]</span>
where</p>
<p><span class="math display">\[\mathrm{Var}(\boldsymbol{\mu_\mathrm{A}}) = h_{\mu}^{2} \mathrm{Var}(\boldsymbol{\mu_\mathrm{ }}) \\ 
\mathrm{Var}(\boldsymbol{\mu_\mathrm{E}}) = (1-h_{\mu}^{2})\mathrm{Var}(\boldsymbol{\mu_\mathrm{ }})\]</span></p>
<p><span class="math display">\[\mathrm{Var}(\boldsymbol{\psi_\mathrm{A}}) = h_{\psi}^{2} \mathrm{Var}(\boldsymbol{\psi_\mathrm{ }}) \\ 
\mathrm{Var}(\boldsymbol{\psi_\mathrm{E}}) = (1-h_{\psi}^{2})\mathrm{Var}(\boldsymbol{\psi_\mathrm{ }})\]</span>
Priors can also be placed on the genetic and permanent environmental correlations</p>
<p><span class="math display">\[\boldsymbol{\mathrm{G}_{cor}},\boldsymbol{\mathrm{E}_{cor}} \sim \mathrm{LKJ}(2)\]</span></p>
<p>The same approach is used for decomposing the residual covariance matrix <span class="math inline">\(\boldsymbol{\Sigma}\)</span>.</p>
<p><span class="math display">\[\mathrm{sd}([\boldsymbol{\epsilon},\boldsymbol{\epsilon&#39;}]) \sim \mathrm{Half-Cauchy}(0,1)\]</span>
<span class="math display">\[\boldsymbol{\mathrm{\Sigma}_{cor}} \sim \mathrm{LKJ}(2)\]</span></p>
</div>
<div id="simulate-data" class="section level2" number="2.3">
<h2><span class="header-section-number">2.3</span> Simulate data</h2>
<p>Here we rely on the custom <code>pedfun()</code> function introduced in Chapter 1 to generate an <span class="math inline">\(\boldsymbol{\mathrm{A}}\)</span> matrix. We begin by setting the population parameters and simulating the SRN intercepts and slopes of males and females, assuming as stated above that their SRN parameters are characterized by equivalent covariance matrices.</p>
<div class="sourceCode" id="cb71"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb71-1"><a href="within-partner-sam.html#cb71-1" aria-hidden="true" tabindex="-1"></a><span class="co">#population properties</span></span>
<span id="cb71-2"><a href="within-partner-sam.html#cb71-2" aria-hidden="true" tabindex="-1"></a>I<span class="ot">=</span><span class="dv">300</span> <span class="co">#total individuals for simulation</span></span>
<span id="cb71-3"><a href="within-partner-sam.html#cb71-3" aria-hidden="true" tabindex="-1"></a>popmin<span class="ot">=</span><span class="dv">400</span></span>
<span id="cb71-4"><a href="within-partner-sam.html#cb71-4" aria-hidden="true" tabindex="-1"></a>popmax<span class="ot">=</span><span class="dv">600</span></span>
<span id="cb71-5"><a href="within-partner-sam.html#cb71-5" aria-hidden="true" tabindex="-1"></a>ngenerations <span class="ot">=</span> <span class="dv">10</span></span>
<span id="cb71-6"><a href="within-partner-sam.html#cb71-6" aria-hidden="true" tabindex="-1"></a>nids<span class="ot">&lt;-</span><span class="fu">sample</span>(popmin<span class="sc">:</span>popmax, ngenerations, <span class="at">replace=</span><span class="cn">TRUE</span>) <span class="co">#N / generation</span></span>
<span id="cb71-7"><a href="within-partner-sam.html#cb71-7" aria-hidden="true" tabindex="-1"></a>epm <span class="ot">=</span> <span class="fu">sample</span>(<span class="fu">seq</span>(<span class="fl">0.15</span>, <span class="fl">0.25</span>,<span class="at">by=</span><span class="fl">0.05</span>),<span class="dv">1</span>) <span class="co">#extra-pair mating</span></span>
<span id="cb71-8"><a href="within-partner-sam.html#cb71-8" aria-hidden="true" tabindex="-1"></a>nonb <span class="ot">=</span> <span class="fu">sample</span>(<span class="fu">seq</span>(<span class="fl">0.4</span>,<span class="fl">0.6</span>,<span class="at">by=</span><span class="fl">0.05</span>),<span class="dv">1</span>) <span class="co">#proportion of non-breeding / generation</span></span>
<span id="cb71-9"><a href="within-partner-sam.html#cb71-9" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb71-10"><a href="within-partner-sam.html#cb71-10" aria-hidden="true" tabindex="-1"></a><span class="co">#relatedness matrix</span></span>
<span id="cb71-11"><a href="within-partner-sam.html#cb71-11" aria-hidden="true" tabindex="-1"></a>A_mat <span class="ot">&lt;-</span> <span class="fu">pedfun</span>(<span class="at">popmin=</span>popmin, <span class="at">popmax=</span>popmax, <span class="at">ngenerations=</span>ngenerations,</span>
<span id="cb71-12"><a href="within-partner-sam.html#cb71-12" aria-hidden="true" tabindex="-1"></a>                  <span class="at">epm=</span>epm, <span class="at">nonb=</span>nonb, <span class="at">nids=</span>nids, <span class="at">I=</span>I, <span class="at">missing=</span><span class="cn">FALSE</span>)</span>
<span id="cb71-13"><a href="within-partner-sam.html#cb71-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-14"><a href="within-partner-sam.html#cb71-14" aria-hidden="true" tabindex="-1"></a><span class="do">#####################################################################</span></span>
<span id="cb71-15"><a href="within-partner-sam.html#cb71-15" aria-hidden="true" tabindex="-1"></a><span class="co">#Parameter values</span></span>
<span id="cb71-16"><a href="within-partner-sam.html#cb71-16" aria-hidden="true" tabindex="-1"></a><span class="do">#####################################################################</span></span>
<span id="cb71-17"><a href="within-partner-sam.html#cb71-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-18"><a href="within-partner-sam.html#cb71-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-19"><a href="within-partner-sam.html#cb71-19" aria-hidden="true" tabindex="-1"></a>N <span class="ot">=</span> <span class="dv">900</span> <span class="co">#total observations (3x/individual)</span></span>
<span id="cb71-20"><a href="within-partner-sam.html#cb71-20" aria-hidden="true" tabindex="-1"></a>I <span class="ot">=</span> <span class="dv">300</span> <span class="co">#total individuals</span></span>
<span id="cb71-21"><a href="within-partner-sam.html#cb71-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-22"><a href="within-partner-sam.html#cb71-22" aria-hidden="true" tabindex="-1"></a>intercept <span class="ot">=</span> <span class="dv">1</span> <span class="co">#global intercept</span></span>
<span id="cb71-23"><a href="within-partner-sam.html#cb71-23" aria-hidden="true" tabindex="-1"></a>beta1 <span class="ot">=</span> <span class="fl">0.3</span> <span class="co">#fixed effect regression coefficient</span></span>
<span id="cb71-24"><a href="within-partner-sam.html#cb71-24" aria-hidden="true" tabindex="-1"></a>SD_intercept <span class="ot">=</span> <span class="fl">0.3</span> <span class="co">#standard deviation of random intercepts</span></span>
<span id="cb71-25"><a href="within-partner-sam.html#cb71-25" aria-hidden="true" tabindex="-1"></a>SD_slope <span class="ot">=</span> <span class="fl">0.3</span></span>
<span id="cb71-26"><a href="within-partner-sam.html#cb71-26" aria-hidden="true" tabindex="-1"></a>SD_residual <span class="ot">=</span> <span class="dv">1</span></span>
<span id="cb71-27"><a href="within-partner-sam.html#cb71-27" aria-hidden="true" tabindex="-1"></a>r_G <span class="ot">=</span> <span class="fl">0.5</span> <span class="co">#genetic correlation of random intercepts and slopes</span></span>
<span id="cb71-28"><a href="within-partner-sam.html#cb71-28" aria-hidden="true" tabindex="-1"></a>r_E <span class="ot">=</span> <span class="sc">-</span><span class="fl">0.5</span> <span class="co">#environmental correlation</span></span>
<span id="cb71-29"><a href="within-partner-sam.html#cb71-29" aria-hidden="true" tabindex="-1"></a>V_G <span class="ot">=</span> <span class="fl">0.3</span> <span class="co">#genetic variance of REs</span></span>
<span id="cb71-30"><a href="within-partner-sam.html#cb71-30" aria-hidden="true" tabindex="-1"></a>V_E <span class="ot">=</span> <span class="fl">0.3</span> <span class="co">#genetic variance of REs</span></span>
<span id="cb71-31"><a href="within-partner-sam.html#cb71-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-32"><a href="within-partner-sam.html#cb71-32" aria-hidden="true" tabindex="-1"></a><span class="co">#Random effect correlations</span></span>
<span id="cb71-33"><a href="within-partner-sam.html#cb71-33" aria-hidden="true" tabindex="-1"></a>G_cor <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">c</span>(<span class="dv">1</span>,r_G,r_G,<span class="dv">1</span>), <span class="at">nrow=</span><span class="dv">2</span>, <span class="at">ncol=</span><span class="dv">2</span>) <span class="co">#mu_A, beta_A</span></span>
<span id="cb71-34"><a href="within-partner-sam.html#cb71-34" aria-hidden="true" tabindex="-1"></a>G_sd  <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fu">sqrt</span>(V_G),<span class="fu">sqrt</span>(V_G)) <span class="co">#G effect sds</span></span>
<span id="cb71-35"><a href="within-partner-sam.html#cb71-35" aria-hidden="true" tabindex="-1"></a>G_cov <span class="ot">&lt;-</span> <span class="fu">diag</span>(G_sd) <span class="sc">%*%</span> G_cor <span class="sc">%*%</span> <span class="fu">diag</span>(G_sd)</span>
<span id="cb71-36"><a href="within-partner-sam.html#cb71-36" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb71-37"><a href="within-partner-sam.html#cb71-37" aria-hidden="true" tabindex="-1"></a>E_cor <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">c</span>(<span class="dv">1</span>,r_E,r_E,<span class="dv">1</span>), <span class="at">nrow=</span><span class="dv">2</span>, <span class="at">ncol=</span><span class="dv">2</span>) <span class="co">#mu_E, beta_E</span></span>
<span id="cb71-38"><a href="within-partner-sam.html#cb71-38" aria-hidden="true" tabindex="-1"></a>E_sd  <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fu">sqrt</span>(V_E),<span class="fu">sqrt</span>(V_E)) <span class="co">#E effect sds</span></span>
<span id="cb71-39"><a href="within-partner-sam.html#cb71-39" aria-hidden="true" tabindex="-1"></a>E_cov <span class="ot">&lt;-</span> <span class="fu">diag</span>(E_sd) <span class="sc">%*%</span> E_cor <span class="sc">%*%</span> <span class="fu">diag</span>(E_sd)</span>
<span id="cb71-40"><a href="within-partner-sam.html#cb71-40" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb71-41"><a href="within-partner-sam.html#cb71-41" aria-hidden="true" tabindex="-1"></a><span class="co">#matrices</span></span>
<span id="cb71-42"><a href="within-partner-sam.html#cb71-42" aria-hidden="true" tabindex="-1"></a>G_block <span class="ot">&lt;-</span> G_cov <span class="sc">%x%</span> A_mat</span>
<span id="cb71-43"><a href="within-partner-sam.html#cb71-43" aria-hidden="true" tabindex="-1"></a>E_block <span class="ot">&lt;-</span> E_cov <span class="sc">%x%</span> <span class="fu">diag</span>(<span class="dv">1</span>,I)</span>
<span id="cb71-44"><a href="within-partner-sam.html#cb71-44" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb71-45"><a href="within-partner-sam.html#cb71-45" aria-hidden="true" tabindex="-1"></a><span class="co">#generate correlated REs</span></span>
<span id="cb71-46"><a href="within-partner-sam.html#cb71-46" aria-hidden="true" tabindex="-1"></a>Gvalues <span class="ot">&lt;-</span> <span class="fu">rmvnorm</span>(<span class="dv">1</span>, <span class="at">mean=</span><span class="fu">rep</span>(<span class="dv">0</span>,I<span class="sc">*</span><span class="dv">2</span>), <span class="at">sigma=</span>G_block)</span>
<span id="cb71-47"><a href="within-partner-sam.html#cb71-47" aria-hidden="true" tabindex="-1"></a>G_val <span class="ot">=</span> <span class="fu">data.frame</span>(<span class="fu">matrix</span>(Gvalues, <span class="at">nrow=</span>I, <span class="at">ncol=</span><span class="dv">2</span>))</span>
<span id="cb71-48"><a href="within-partner-sam.html#cb71-48" aria-hidden="true" tabindex="-1"></a><span class="fu">cor</span>(G_val)</span>
<span id="cb71-49"><a href="within-partner-sam.html#cb71-49" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb71-50"><a href="within-partner-sam.html#cb71-50" aria-hidden="true" tabindex="-1"></a>Evalues <span class="ot">&lt;-</span> <span class="fu">rmvnorm</span>(<span class="dv">1</span>, <span class="at">mean=</span><span class="fu">rep</span>(<span class="dv">0</span>,I<span class="sc">*</span><span class="dv">2</span>), <span class="at">sigma=</span>E_block)</span>
<span id="cb71-51"><a href="within-partner-sam.html#cb71-51" aria-hidden="true" tabindex="-1"></a>E_val <span class="ot">=</span> <span class="fu">data.frame</span>(<span class="fu">matrix</span>(Evalues, <span class="at">nrow=</span>I, <span class="at">ncol=</span><span class="dv">2</span>))</span>
<span id="cb71-52"><a href="within-partner-sam.html#cb71-52" aria-hidden="true" tabindex="-1"></a><span class="fu">cor</span>(E_val)</span>
<span id="cb71-53"><a href="within-partner-sam.html#cb71-53" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb71-54"><a href="within-partner-sam.html#cb71-54" aria-hidden="true" tabindex="-1"></a><span class="co">#combine</span></span>
<span id="cb71-55"><a href="within-partner-sam.html#cb71-55" aria-hidden="true" tabindex="-1"></a>re_P <span class="ot">=</span> <span class="fu">cbind</span>(G_val,E_val)</span>
<span id="cb71-56"><a href="within-partner-sam.html#cb71-56" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(re_P) <span class="ot">=</span> <span class="fu">c</span>(<span class="st">&quot;mu_A&quot;</span>, <span class="st">&quot;beta_A&quot;</span>, <span class="st">&quot;mu_E&quot;</span>, <span class="st">&quot;beta_E&quot;</span>)</span>
<span id="cb71-57"><a href="within-partner-sam.html#cb71-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-58"><a href="within-partner-sam.html#cb71-58" aria-hidden="true" tabindex="-1"></a><span class="co">#individual phenotypic REs</span></span>
<span id="cb71-59"><a href="within-partner-sam.html#cb71-59" aria-hidden="true" tabindex="-1"></a>mu <span class="ot">=</span> re_P<span class="sc">$</span>mu_A <span class="sc">+</span> re_P<span class="sc">$</span>mu_E</span>
<span id="cb71-60"><a href="within-partner-sam.html#cb71-60" aria-hidden="true" tabindex="-1"></a>beta <span class="ot">=</span> re_P<span class="sc">$</span>beta_A <span class="sc">+</span> re_P<span class="sc">$</span>beta_E</span></code></pre></div>
<p>We can now split the generated values into male and female values, assuming both sexes are evenly sampled so that <span class="math inline">\(N_M = N_F=N/2\)</span>.</p>
<p>…work in progress</p>
</div>
<div id="coding-the-model" class="section level2" number="2.4">
<h2><span class="header-section-number">2.4</span> Coding the model</h2>
<p>The complete <code>.stan</code> file for the SAM can be quite long and may at first be overwhelming to consider in its entirety. However, when broken into its constituent programming blocks, the model’s apparent complexity can be much more easily digested. We therefore consider each block in turn</p>
<pre class="stan"><code>data {
  
  //indices and scalars used for model specification
  int&lt;lower=1&gt; N_sex; //total AG observations per sex
  int&lt;lower=0&gt; I; //total individuals
  int&lt;lower=0&gt; Im; //number of males
  int&lt;lower=0&gt; If; //number of females
  int&lt;lower=1&gt; Idyad; //number of dyads
  int&lt;lower=1&gt; idm[N_sex]; //index of male AG observations
  int&lt;lower=1&gt; idf[N_sex]; //index of female AG observations
  int&lt;lower=1&gt; idmw[Idyad]; //index of male FS observations
  int&lt;lower=1&gt; idfw[Idyad]; //index of female FS observations
  int&lt;lower=1&gt; dyadw[Idyad]; //index of dyads for FS
  int&lt;lower=1&gt; partners_m [Im,5]; //index of male partner IDs, first column is focal ID
  int&lt;lower=1&gt; partners_f [If,5]; //index of female partner IDs, first column is focal ID
  
  //empirical data
  matrix[I,I] A; //relatedness matrix
  real AG_m[N_sex]; //male aggression measurements
  real AG_f[N_sex]; //female aggression measurements
  real w[Idyad]; //FS dyad response
  real time[N_sex];
}

transformed data{
  matrix[I,I] LA = cholesky_decompose(A); //lower-triangle A matrix
}

parameters {
  //population effects
  real alpha_0; //aggression global intercept
  real nu_0; //fitness global intercept
  real psi_1; //expected interaction coefficient
  real beta_B1; //average partner SRN intercept
  real beta_B2; //average partner SRN slopes
  real beta_N1; //selection gradients
  real beta_N2;
  real beta_S1;
  real beta_S2;
  real beta_D1;
  real beta_D2;
  real&lt;lower=-1,upper=1&gt; phi; //(-1,1) ensures unique solution
  
  //random effects (standard deviations)
  vector&lt;lower=0, upper = 1&gt;[2] sd_P; //phenotypic SRN mu &amp; psi SDs
  vector&lt;lower=0, upper = 1&gt;[2] sd_R; //male &amp; female residual SDs
  real&lt;lower=0, upper = 1&gt;sd_delta; //residual of fitness

  cholesky_factor_corr[2] LG; //genetic SRN correlations
  cholesky_factor_corr[2] LE; //permanent environmental SRN correlations
  cholesky_factor_corr[2] LR; //sex-specific residual correlations
  
  matrix[I,2] std_devG; //individual-level unscaled G SRN deviations
  matrix[I,2] std_devE; //individual-level unscaled E SRN deviations
  
  //SRN heritability parmameters, i.e. Var(G_RN) / Var(P_RN) 
  //see supplementary appendix SI for further explanation of this parameter
  vector&lt;lower=0,upper=1&gt;[2] SRN_h2;
  
}

transformed parameters {
  vector&lt;lower=0&gt;[2] sd_G; //SDs of G effects (derived from sd_P)
  vector&lt;lower=0&gt;[2] sd_E; //SDs of E effects (derived from sd_P)
  
  matrix[I,2] SRN_P; //scaled P SRN parameter deviations
  matrix[I,2] SRN_G; //scaled G SRN parameter deviations
  matrix[I,2] SRN_E; //scaled E SRN parameter deviations
  
  matrix[If, 2] partner_meanm; //average SRN parameters of males&#39; partners
  matrix[Im, 2] partner_meanf; //average SRN parameters of females&#39; partners
  
  //standard deviations of genetic effects
  //simplified from sqrt ( total RN phenotype variance * h2 )
  sd_G[1] = sd_P[1] * sqrt(SRN_h2[1]); //genetic SD for RN intercepts 
  sd_G[2] = sd_P[2] * sqrt(SRN_h2[2]);  //genetic SD for RN slopes
  
  //standard deviations of environmental effects (total phenotype SD * proportion environment SD)
  sd_E[1] = sd_P[1] * sqrt(1 - SRN_h2[1]); //environment SD for RN intercepts 
  sd_E[2] = sd_P[2] * sqrt(1 - SRN_h2[2]); //environment SD for RN slopes 
  
  //matrix normal parameterization of Kronecker product between G and A
  SRN_G =  LA * std_devG  * diag_pre_multiply(sd_G, LG)&#39; ; 
  
  //non-centered parameterization of permanent environmental effects
  SRN_E = std_devE * diag_pre_multiply(sd_E, LE)&#39;;
  
  //phenotypic RN effects (P = G + E); here G = additive genetic effects
  SRN_P = SRN_G + SRN_E;

  //calculate the mean SRN parameters of each male&#39;s lifetime partners
  for(i in 1:Im) partner_meanm[i] = [mean(col(SRN_P[partners_m[i,2:5]],1)),
                                mean(col(SRN_P[partners_m[i,2:5]],2))];
  
  //calculate the mean SRN parameters of each female&#39;s lifetime partners
  for(i in 1:If) partner_meanf[i] = [mean(col(SRN_P[partners_f[i,2:5]],1)),
                                mean(col(SRN_P[partners_f[i,2:5]],2))];
}

model{
  
  //separate male and female vectors for efficiency
  matrix[Im,2] SRN_Pm = SRN_P[1:Im]; //male SRN phenotypic deviations
  matrix[If,2] SRN_Pf = SRN_P[(Im+1):I]; //female SRN phenotypic deviations
  
  //separate SRN intercepts and slopes (phenotypic deviations)
  vector[Im] mu_m = col(SRN_Pm,1); //SRN intercepts
  vector[If] mu_f = col(SRN_Pf,1); 
  vector[Im] psi_m = col(SRN_Pm,2); //SRN slopes
  vector[If] psi_f = col(SRN_Pf,2); 
  
  //separate mean partner SRN intercepts and slopes (deviations)
  vector[Im] mu_meanm = col(partner_meanm,1); //mean partner SRN intercept for males
  vector[If] mu_meanf = col(partner_meanf,1); //...for females
  vector[Im] psi_meanm = col(partner_meanm,2); //mean partner SRN slope for males
  vector[If] psi_meanf = col(partner_meanf,2); //...for females 
  
  //initialize vectors for constructing individual-centered linear predictors
  vector[N_sex] eta_Wm; //within-individual centered male SRN trait value 
  vector[N_sex] eta_Wf; //within-individual centered female SRN trait value
  
  vector[N_sex] meaneta_m; //individual male SRN trait value toward average partner 
  vector[N_sex] meaneta_f; //individual female SRN trait toward average partner
  vector[N_sex] eta_meanm; //average SRN partner values for males
  vector[N_sex] eta_meanf; //average SRN partner values for females
  
  vector[N_sex] linpred_m; //expected value for male responses
  vector[N_sex] linpred_f; //expected value for female responses
  vector[N_sex] zeta_m; //residuals for male responses
  vector[N_sex] zeta_f; //residuals for male responses
  vector[Idyad] w_pred; //linear predictor of fitness
  
  //Male and female aggression response model
  for (n in 1:N_sex) {
    
    //SRN trait values
    //assumes that n = 1 in the context of an ongoing social interaction
    //if n = 1 prior to social context, then specify eta[t=1] = mu_j instead
    if (time[n]==1)
      {
        //within-individual centered eta
        //male eta[t=1] = mu_j + psi_j*(mu_k - mu_meanK)
        eta_Wm[n] = mu_m[idm[n]] +  (psi_1 + psi_m[idm[n]])*(mu_f[idf[n]] - mu_meanm[idm[n]]) ;
        
        //female eta[t=1] = mu_k + psi_k*(mu_j - mu_meanJ)
        eta_Wf[n] = mu_f[idf[n]] +   (psi_1 + psi_f[idf[n]])*(mu_m[idm[n]] - mu_meanf[idf[n]]);
        
        //average individual eta
        //male eta[t=1] = mu_j + psi_j*mu_k
        meaneta_m[n] = mu_m[idm[n]] +    (psi_1 + psi_m[idm[n]])*mu_meanm[idm[n]];
        
        //female eta[t=1] = mu_k + psi_k*mu_j
        meaneta_f[n] = mu_f[idf[n]] +   (psi_1 + psi_f[idf[n]])*mu_meanf[idf[n]];
        
        //average partner eta[t=1]
        //average eta males&#39; partners [t=1] = mu_meanK + psi_meanK*mu_j
        eta_meanm[n] = mu_meanm[idm[n]] +   (psi_1 + psi_meanm[idm[n]])*mu_m[idm[n]];
        
        //average eta females&#39; partners [t=1] = mu_meanJ + psi_meanJ*mu_k
        eta_meanf[n] = mu_meanf[idf[n]] +   (psi_1 + psi_meanf[idf[n]])*mu_f[idf[n]];
      }    
    else
      {
        //within-individual centered eta
        //male eta[t=2] = mu_j + psi_j*(eta_k[t=1] - eta_meanK[t=1])
        eta_Wm[n] = mu_m[idm[n]] +   (psi_1 + psi_m[idm[n]])*(eta_Wf[n-1] - eta_meanm[n-1]);
        
        //female eta[t=2] = mu_k + psi_k*(eta_j[t=1] - eta_meanJ[t=1])
        eta_Wf[n] = mu_f[idf[n]] +   (psi_1 + psi_f[idf[n]])*(eta_Wm[n-1] - eta_meanf[n-1]);
        
        //average individual eta
        //male average eta[t=2] = mu_j + psi_j*eta_meanK[t=1]
        meaneta_m[n] = mu_m[idm[n]] +    (psi_1 + psi_m[idm[n]])*eta_meanm[n-1];
        
        //female average eta[t=2] = mu_k + psi_k*eta_meanJ[t=1]
        meaneta_f[n] = mu_f[idf[n]] +   (psi_1 + psi_f[idf[n]])*eta_meanf[n-1];
        
        //average eta males&#39; partners [t=1] = mu_meanK + psi_meanK*mean eta_j[t-1]
        eta_meanm[n] = mu_meanm[idm[n]] +  (psi_1 + psi_meanm[idm[n]])*meaneta_m[n-1];
        
        //female average partner eta
        eta_meanf[n] = mu_meanf[idf[n]] +  (psi_1 + psi_meanf[idf[n]])*meaneta_f[n-1]; 
      }
    
    //add global intercept and between-individual parameters to linear predictor
    //other fixed effects can also be added here
    linpred_m[n] = alpha_0 + eta_Wm[n] + beta_B1*mu_meanm[idm[n]] + beta_B2*psi_meanm[idm[n]];
    linpred_f[n] = alpha_0 + eta_Wf[n] + beta_B1*mu_meanf[idf[n]] + beta_B2*psi_meanf[idf[n]];

    //residual trait values
    if(time[n]==1)
      {
        zeta_m [n] = AG_m[n] - linpred_m[n];
        zeta_f [n] = AG_f[n] - linpred_f[n];
      }
    else
      {
       linpred_m[n] = linpred_m[n] + phi * zeta_f[n-1];
       zeta_m[n] = AG_m[n] - linpred_m[n]; 
       
       linpred_f[n] = linpred_f[n] + phi * zeta_m[n-1];
       zeta_f[n] = AG_f[n] - linpred_f[n]; 
      }
  
    //correlated residuals between partners
    [zeta_m[n],zeta_f[n]]&#39; ~ multi_normal_cholesky([0,0], diag_pre_multiply(sd_R, LR));
  }
    
  //fitness response model
  w_pred = nu_0 + beta_N1*mu_m[idmw] + beta_N2*psi_m[idmw] + beta_S1*mu_f[idfw] + beta_S2*psi_f[idfw] + 
                  beta_D1*(mu_m[idmw].*mu_f[idfw]) + beta_D2*(psi_m[idmw].*psi_f[idfw]);
  
  w ~ normal(w_pred, sd_delta);

  //model priors
  
  //fixed effects
  alpha_0 ~ std_normal();
  nu_0 ~ std_normal();
  psi_1 ~ std_normal();
  beta_B1 ~ std_normal();
  beta_B2 ~ std_normal();
  beta_N1 ~ std_normal();
  beta_N2 ~ std_normal();
  beta_S1 ~ std_normal();
  beta_S2 ~ std_normal();
  beta_D1 ~ std_normal();
  beta_D2 ~ std_normal();
  phi ~ std_normal();
  
  //random effects
  to_vector(sd_P) ~ cauchy(0,1);
  to_vector(sd_R) ~ cauchy(0,1);
  sd_delta ~ cauchy(0,1);
  
  LG ~ lkj_corr_cholesky(2);
  LE ~ lkj_corr_cholesky(2);
  LR ~ lkj_corr_cholesky(2);
  
  to_vector(std_devG) ~ std_normal();
  to_vector(std_devE) ~ std_normal();
  
  //reaction norm heritability
  to_vector(SRN_h2) ~ beta(1.2,1.2);
  
}


generated quantities{
//cor and cov matrices of SRN parameters and residuals
matrix[2,2] Gcor = LG * LG&#39;; //G SRN correlation matric
matrix[2,2] Ecor = LE * LG&#39;; //E SRN correlation matric
matrix[2,2] Rcor = LR * LR&#39;; //residual correlation matrix

matrix[2,2] Rcov = diag_matrix(sd_R)*Rcor*diag_matrix(sd_R); //residual covariance
matrix[2,2] Gcov = diag_matrix(sd_G)*Gcor*diag_matrix(sd_G); //G SRN covariance
matrix[2,2] Ecov = diag_matrix(sd_E)*Ecor*diag_matrix(sd_E); //E SRN covariance
matrix[2,2] Pcov = Gcov + Ecov; //P SRN covariance
matrix[2,2] Pcor = inverse(diag_matrix(sd_P))*Pcov*inverse(diag_matrix(sd_P)); //P SRN correlation

//variances
vector&lt;lower=0&gt;[2] V_P = sd_P .* sd_P;
vector&lt;lower=0&gt;[2] V_G = sd_G .* sd_G;
vector&lt;lower=0&gt;[2] V_E = sd_E .* sd_E;
vector&lt;lower=0&gt;[2] V_R = sd_R .* sd_R;
}
</code></pre>

</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="using-stan-in-r.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="between-partner-sam.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": null,
"text": null
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": ["SAMs.pdf", "SAMs.epub"],
"toc": {
"collapse": "subsection"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
