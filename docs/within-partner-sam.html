<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>2 Within partner SAM | Estimating Social Animal Models in Stan</title>
  <meta name="description" content="2 Within partner SAM | Estimating Social Animal Models in Stan" />
  <meta name="generator" content="bookdown 0.22 and GitBook 2.6.7" />

  <meta property="og:title" content="2 Within partner SAM | Estimating Social Animal Models in Stan" />
  <meta property="og:type" content="book" />
  
  
  
  

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="2 Within partner SAM | Estimating Social Animal Models in Stan" />
  
  
  

<meta name="author" content="Jordan S. Martin &amp; Adrian V. Jaeggi" />


<meta name="date" content="2021-07-07" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="using-stan-in-r.html"/>
<link rel="next" href="between-partner-sam.html"/>
<script src="libs/header-attrs-2.8/header-attrs.js"></script>
<script src="libs/jquery-2.2.3/jquery.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />









<link href="libs/anchor-sections-1.0.1/anchor-sections.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.0.1/anchor-sections.js"></script>


<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<style type="text/css">
/* Used with Pandoc 2.11+ new --citeproc when CSL is used */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
}
.hanging div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}
</style>

<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li class="chapter" data-level="" data-path="introduction.html"><a href="introduction.html"><i class="fa fa-check"></i>Introduction</a></li>
<li class="chapter" data-level="1" data-path="using-stan-in-r.html"><a href="using-stan-in-r.html"><i class="fa fa-check"></i><b>1</b> Using Stan in R</a>
<ul>
<li class="chapter" data-level="1.1" data-path="using-stan-in-r.html"><a href="using-stan-in-r.html#why-stan"><i class="fa fa-check"></i><b>1.1</b> Why Stan?</a></li>
<li class="chapter" data-level="1.2" data-path="using-stan-in-r.html"><a href="using-stan-in-r.html#getting-started"><i class="fa fa-check"></i><b>1.2</b> Getting Started</a></li>
<li class="chapter" data-level="1.3" data-path="using-stan-in-r.html"><a href="using-stan-in-r.html#bayesian-inference"><i class="fa fa-check"></i><b>1.3</b> Bayesian inference</a></li>
<li class="chapter" data-level="1.4" data-path="using-stan-in-r.html"><a href="using-stan-in-r.html#basic-coding-tutorial"><i class="fa fa-check"></i><b>1.4</b> Basic coding tutorial</a>
<ul>
<li class="chapter" data-level="1.4.1" data-path="using-stan-in-r.html"><a href="using-stan-in-r.html#cholesky-decompositions"><i class="fa fa-check"></i><b>1.4.1</b> Cholesky decompositions</a></li>
<li class="chapter" data-level="1.4.2" data-path="using-stan-in-r.html"><a href="using-stan-in-r.html#non-centered-random-effects"><i class="fa fa-check"></i><b>1.4.2</b> Non-centered random effects</a></li>
</ul></li>
<li class="chapter" data-level="1.5" data-path="using-stan-in-r.html"><a href="using-stan-in-r.html#animal-models"><i class="fa fa-check"></i><b>1.5</b> Animal models</a>
<ul>
<li class="chapter" data-level="1.5.1" data-path="using-stan-in-r.html"><a href="using-stan-in-r.html#simulate-data"><i class="fa fa-check"></i><b>1.5.1</b> Simulate data</a></li>
<li class="chapter" data-level="1.5.2" data-path="using-stan-in-r.html"><a href="using-stan-in-r.html#kronecker-products"><i class="fa fa-check"></i><b>1.5.2</b> Kronecker products</a></li>
<li class="chapter" data-level="1.5.3" data-path="using-stan-in-r.html"><a href="using-stan-in-r.html#identifying-genetic-effects"><i class="fa fa-check"></i><b>1.5.3</b> Identifying genetic effects</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="2" data-path="within-partner-sam.html"><a href="within-partner-sam.html"><i class="fa fa-check"></i><b>2</b> Within partner SAM</a>
<ul>
<li class="chapter" data-level="2.1" data-path="within-partner-sam.html"><a href="within-partner-sam.html#formal-overview"><i class="fa fa-check"></i><b>2.1</b> Formal overview</a></li>
<li class="chapter" data-level="2.2" data-path="within-partner-sam.html"><a href="within-partner-sam.html#computational-approach"><i class="fa fa-check"></i><b>2.2</b> Computational approach</a></li>
<li class="chapter" data-level="2.3" data-path="within-partner-sam.html"><a href="within-partner-sam.html#simulate-data-1"><i class="fa fa-check"></i><b>2.3</b> Simulate data</a>
<ul>
<li class="chapter" data-level="2.3.1" data-path="within-partner-sam.html"><a href="within-partner-sam.html#srn-parameters"><i class="fa fa-check"></i><b>2.3.1</b> SRN parameters</a></li>
<li class="chapter" data-level="2.3.2" data-path="within-partner-sam.html"><a href="within-partner-sam.html#assortment"><i class="fa fa-check"></i><b>2.3.2</b> Assortment</a></li>
<li class="chapter" data-level="2.3.3" data-path="within-partner-sam.html"><a href="within-partner-sam.html#repeated-measurements-within-the-partner"><i class="fa fa-check"></i><b>2.3.3</b> Repeated measurements within the partner</a></li>
</ul></li>
<li class="chapter" data-level="2.4" data-path="within-partner-sam.html"><a href="within-partner-sam.html#coding-the-model"><i class="fa fa-check"></i><b>2.4</b> Coding the model</a></li>
<li class="chapter" data-level="2.5" data-path="within-partner-sam.html"><a href="within-partner-sam.html#estimating-the-model"><i class="fa fa-check"></i><b>2.5</b> Estimating the model</a></li>
<li class="chapter" data-level="2.6" data-path="within-partner-sam.html"><a href="within-partner-sam.html#failure-to-detect-assortment"><i class="fa fa-check"></i><b>2.6</b> Failure to detect assortment</a></li>
<li class="chapter" data-level="2.7" data-path="within-partner-sam.html"><a href="within-partner-sam.html#phenotypic-model"><i class="fa fa-check"></i><b>2.7</b> Phenotypic model</a></li>
</ul></li>
<li class="chapter" data-level="3" data-path="between-partner-sam.html"><a href="between-partner-sam.html"><i class="fa fa-check"></i><b>3</b> Between partner SAM</a>
<ul>
<li class="chapter" data-level="3.1" data-path="between-partner-sam.html"><a href="between-partner-sam.html#simulate-data-2"><i class="fa fa-check"></i><b>3.1</b> Simulate data</a></li>
<li class="chapter" data-level="3.2" data-path="between-partner-sam.html"><a href="between-partner-sam.html#estimate-the-model"><i class="fa fa-check"></i><b>3.2</b> Estimate the model</a></li>
<li class="chapter" data-level="3.3" data-path="between-partner-sam.html"><a href="between-partner-sam.html#estimating-assortment"><i class="fa fa-check"></i><b>3.3</b> Estimating assortment</a></li>
<li class="chapter" data-level="3.4" data-path="between-partner-sam.html"><a href="between-partner-sam.html#phenotypic-model-1"><i class="fa fa-check"></i><b>3.4</b> Phenotypic model</a></li>
</ul></li>
<li class="chapter" data-level="4" data-path="within-and-between-partner-sam.html"><a href="within-and-between-partner-sam.html"><i class="fa fa-check"></i><b>4</b> Within-and-between partner SAM</a>
<ul>
<li class="chapter" data-level="4.1" data-path="within-and-between-partner-sam.html"><a href="within-and-between-partner-sam.html#simulate-data-3"><i class="fa fa-check"></i><b>4.1</b> Simulate data</a></li>
<li class="chapter" data-level="4.2" data-path="within-and-between-partner-sam.html"><a href="within-and-between-partner-sam.html#estimate-the-model-1"><i class="fa fa-check"></i><b>4.2</b> Estimate the model</a></li>
<li class="chapter" data-level="4.3" data-path="within-and-between-partner-sam.html"><a href="within-and-between-partner-sam.html#estimating-assortment-1"><i class="fa fa-check"></i><b>4.3</b> Estimating assortment</a></li>
<li class="chapter" data-level="4.4" data-path="within-and-between-partner-sam.html"><a href="within-and-between-partner-sam.html#phenotypic-model-2"><i class="fa fa-check"></i><b>4.4</b> Phenotypic model</a></li>
</ul></li>
<li class="chapter" data-level="5" data-path="extending-sams.html"><a href="extending-sams.html"><i class="fa fa-check"></i><b>5</b> Extending SAMs</a></li>
<li class="chapter" data-level="" data-path="resources.html"><a href="resources.html"><i class="fa fa-check"></i>Resources</a></li>
</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Estimating Social Animal Models in Stan</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="within-partner-sam" class="section level1" number="2">
<h1><span class="header-section-number">2</span> Within partner SAM</h1>
<p>SAMs build on the Stan code we used for a basic animal model (<a href="using-stan-in-r.html#animal-models">1.5</a>) in three key ways: (i) by implementing an autoregressive moving average (ARMA) function between the social reaction norms (SRNs) of individuals and their partners, (ii) within-individual centering of SRNs, and (iii) estimating selection gradients on SRN parameters. Note that (ii) is only applicable to study designs in which individuals are measured across multiple partners, and thus does not apply to the within partner model presented here. As is explained below, this model can effectively estimate social plasticity (SRN slopes) but does not effectively estimate assortment, due to confounding in the absence of multiple partners (<a href="within-partner-sam.html#failure-to-detect-assortment">2.6</a>). The fitness model addressing (iii) is handled in a subsequent chapter ((<a href="#fitness-model"><strong>??</strong></a>)). The theoretical and statistical motivation behind each of these extensions is explained in detail by <span class="citation"><a href="#ref-SAM" role="doc-biblioref">Martin and Jaeggi</a> (<a href="#ref-SAM" role="doc-biblioref">2021</a>)</span>. After estimating a SAM, we also want to extract the model posteriors and subsequently estimate the assortment matrix <span class="math inline">\(\boldsymbol{\mathrm{B_{\alpha}}}\)</span>, the selection gradients <span class="math inline">\(\mathrm{s_{\mu}}\)</span> and <span class="math inline">\(\mathrm{s_{\psi}}\)</span>, and the responses to selection <span class="math inline">\(\Delta \bar{\mathrm{\mu}}\)</span> and <span class="math inline">\(\Delta \bar{\mathrm{\psi}}\)</span>.</p>
<p>Here we provide a tutorial for the within-partner SAM, presented as <strong>Eq 3.1</strong> in <span class="citation"><a href="#ref-SAM" role="doc-biblioref">Martin and Jaeggi</a> (<a href="#ref-SAM" role="doc-biblioref">2021</a>)</span>, which is appropriate for sampling designs where each individual is measured interacting with a single partner over multiple time intervals, e.g. <span class="math inline">\(t= \left \{ 1,2,3 \right \}\)</span> to index the first, second, and third observation of a focal individual with the same social partner. For clarity, we focus on the simple linear models presented in the paper, largely ignoring complications such as the inclusion of additional random and fixed effects for adjusting estimates, which can be accomplished using basic approaches for any Stan model. See the <a href="https://mc-stan.org/docs/2_25/reference-manual/index.html">Stan Reference Manual</a> and <a href="https://mc-stan.org/users/documentation/case-studies">Stan Case Studies</a> for further details. The detailed coding tutorials in Chapter 1 are also crucial for understanding the Cholesky decompositions, reaction norm heritabilities, and non-centered and matrix normal parametrizations used below, which we do not review again in detail.</p>
<div id="formal-overview" class="section level2" number="2.1">
<h2><span class="header-section-number">2.1</span> Formal overview</h2>
<p>The formal model for a measurement of aggression <span class="math inline">\(z_{jt}\)</span> in focal individual <span class="math inline">\(j\)</span> at time <span class="math inline">\(t\)</span> is given by</p>
<p><span class="math display">\[z_{jt} = \mu_0 + \eta_{jt} + \xi_{jt}\]</span>
<span class="math display">\[\eta_{jt} = \begin{Bmatrix}
\mu_j + \left( \psi_1 + \psi_j \right)\mu_k&#39; &amp; \mathrm{if} \ t = 1 \\ 
\mu_j + \left( \psi_1 + \psi_j \right)\eta_{kt-1}&#39; &amp; \mathrm{else}
\end{Bmatrix} \]</span></p>
<p><span class="math display">\[\xi_{jt} = \begin{Bmatrix}
\epsilon_{jt} &amp; \mathrm{if} \ t = 1 \\ 
\epsilon_{jt} + \phi\epsilon_{kt-1}&#39; &amp; \mathrm{else}
\end{Bmatrix} \]</span></p>
<p><span class="math display">\[\mu_j = \mu_{\mathrm{A}j} + \mu_{\mathrm{E}j}, \quad  \psi_j = \psi_{\mathrm{A}j} + \psi_{\mathrm{E}j}\]</span>
with the equivalent specification for the social partner’s aggression measure <span class="math inline">\(z_{kt}&#39;\)</span></p>
<p><span class="math display">\[z_{kt}&#39; = \mu_0 + \eta_{kt}&#39; + \xi_{kt}&#39;\]</span>
<span class="math display">\[\eta_{kt}&#39; = \begin{Bmatrix}
\mu_k&#39; + \left( \psi_1 + \psi_k&#39; \right)\mu_j &amp; \mathrm{if} \ t = 1 \\ 
\mu_k&#39; + \left( \psi_1 + \psi_k&#39; \right)\eta_{jt-1} &amp; \mathrm{else}
\end{Bmatrix} \]</span></p>
<p><span class="math display">\[\xi_{kt}&#39; = \begin{Bmatrix}
\epsilon_{kt}&#39; &amp; \mathrm{if} \ t = 1 \\ 
\epsilon_{kt}&#39; + \phi\epsilon_{jt-1} &amp; \mathrm{else}
\end{Bmatrix} \]</span></p>
<p><span class="math display">\[\mu_k&#39; = \mu_{\mathrm{A}k}&#39; + \mu_{\mathrm{E}j}&#39;, \quad  \psi_k&#39; = \psi_{\mathrm{A}k}&#39; + \psi_{\mathrm{E}k}&#39;\]</span>
The random effects are assumed to be well-described by multivariate normal distributions.</p>
<p><span class="math display">\[\begin{bmatrix} \boldsymbol{\mu_{\mathrm{A}}}, \boldsymbol{\mu&#39;_{\mathrm{A}}},\boldsymbol{\psi_{\mathrm{A}}},\boldsymbol{\psi}&#39;_{\mathrm{A}}  \end{bmatrix}^{\mathrm{T}} \sim \mathrm{MVNormal}(\boldsymbol{0}, \boldsymbol{\mathrm{G}} \otimes \boldsymbol{\mathrm{A}} ) \]</span>
<span class="math display">\[\begin{bmatrix} \boldsymbol{\mu_{\mathrm{E}}}, \boldsymbol{\mu&#39;_{\mathrm{E}}},\boldsymbol{\psi_{\mathrm{E}}},\boldsymbol{\psi}&#39;_{\mathrm{E}}  \end{bmatrix}^{\mathrm{T}} \sim \mathrm{MVNormal}(\boldsymbol{0}, \boldsymbol{\mathrm{E}} \otimes \boldsymbol{\mathrm{I}} ) \]</span>
<span class="math display">\[\begin{bmatrix} \boldsymbol{\epsilon}, \boldsymbol{\epsilon}&#39; \end{bmatrix}^{\mathrm{T}} \sim \mathrm{MVNormal}(\boldsymbol{0}, \boldsymbol{\mathrm{\Sigma}} ) \]</span>
We also assume that the social reaction norm (SRN) intercept and slope (co)variances are equivalent for focal (<span class="math inline">\(\boldsymbol{\mu},\boldsymbol{\psi}\)</span>) and social partners (<span class="math inline">\(\boldsymbol{\mu}&#39;,\boldsymbol{\psi}&#39;\)</span>). The G matrix can therefore be reduced to a 2x2 matrix for all individuals in the population</p>
<p><span class="math display">\[\boldsymbol{\mathrm{G}}= \begin{bmatrix} \mathrm{var([\boldsymbol{\mu},\boldsymbol{\mu}&#39;])} &amp; \mathrm{cov([\boldsymbol{\mu},\boldsymbol{\mu}&#39;],[\boldsymbol{\psi},\boldsymbol{\psi}&#39;])} \\ \mathrm{cov([\boldsymbol{\psi},\boldsymbol{\psi}&#39;],[\boldsymbol{\mu},\boldsymbol{\mu}&#39;])} &amp;
\mathrm{var([\boldsymbol{\psi},\boldsymbol{\psi}&#39;])} \end{bmatrix}\]</span></p>
<p>The residual matrix <span class="math inline">\(\boldsymbol{\Sigma}\)</span>, however, estimates separate variances and covariances for the focal and partner residuals, which allows the model to account for residual covariance and feedback effects (collectively referred to as SRN measurement errors <span class="math inline">\(\boldsymbol{\xi}\)</span> and <span class="math inline">\(\boldsymbol{\xi}&#39;\)</span>).</p>
<p><span class="math display">\[\boldsymbol{\Sigma}= \begin{bmatrix} \mathrm{var(\boldsymbol{\epsilon})} &amp; \mathrm{cov}(\boldsymbol{\epsilon},\boldsymbol{\epsilon}&#39;) \\ 
\mathrm{cov}(\boldsymbol{\epsilon}&#39;,\boldsymbol{\epsilon}) &amp;
\mathrm{var(\boldsymbol{\epsilon&#39;})}     \end{bmatrix}\]</span>
This model is, therefore, appropriate for situations where the distinction between focal and partner is semi-arbitrary, e.g. when measuring within-sex interactions or when males and females exhibit similar patterns of phenotypic variation. In this case, we make the latter assumption for simplicity. To account for differences between the responses of focal individuals and social partners, the model can simply be extended with additional parameters, e.g. specifying separate <span class="math inline">\(G_M\)</span> and <span class="math inline">\(G_F\)</span> matrices for males and female respective genetic (co)variances and so on.</p>
</div>
<div id="computational-approach" class="section level2" number="2.2">
<h2><span class="header-section-number">2.2</span> Computational approach</h2>
<p>As shown in Chapter 1, we can express the formal model above in a mathematically equivalent but more computationally efficient manner by decomposing the covariance matrices into matrices of correlations and SDs, using lower triangular Cholesky decompositions on the correlation matrices. For example, the genetic covariance is given by</p>
<p><span class="math display">\[\boldsymbol{\mathrm{G}}_{cov}=
\boldsymbol{\mathrm{G}_{sd}}
\boldsymbol{\mathrm{G}}_{cor}
\boldsymbol{\mathrm{G}_{sd}}\]</span></p>
<p><span class="math display">\[\boldsymbol{\mathrm{G}}_{cor} = 
\boldsymbol{\mathrm{L}}_{Gcor} \boldsymbol{\mathrm{L}}_{Gcor}^{\mathrm{T}} 
=
\begin{bmatrix}
1
&amp; \mathrm{cor}([\boldsymbol{\mu},\boldsymbol{\mu&#39;}],[\boldsymbol{\psi},\boldsymbol{\psi&#39;}] ) \\ 
 \mathrm{cor}([\boldsymbol{\psi},\boldsymbol{\psi&#39;}], [\boldsymbol{\mu},\boldsymbol{\mu&#39;}] ) &amp;
1
\end{bmatrix}\]</span></p>
<p><span class="math display">\[\boldsymbol{\mathrm{G}_{sd}}=\begin{bmatrix}
\mathrm{sd}([\boldsymbol{\mu},\boldsymbol{\mu&#39;}])
&amp; 0 \\ 0 &amp;
\mathrm{sd}([\boldsymbol{\psi},\boldsymbol{\psi&#39;}])
\end{bmatrix}\]</span></p>
<p>The estimation of the Kronecker product <span class="math inline">\(\boldsymbol{\mathrm{G}} \otimes \boldsymbol{\mathrm{A}}\)</span> is achieved through sampling of a non-centered matrix normal distribution</p>
<p><span class="math display">\[\begin{bmatrix}
[\boldsymbol{\mu_{\mathrm{A}}}, \boldsymbol{\mu_{\mathrm{A}}}&#39;]^{\mathrm{T}} &amp;
[\boldsymbol{\psi_{\mathrm{A}}}, \boldsymbol{\psi_{\mathrm{A}}}&#39;]^{\mathrm{T}}
\end{bmatrix} = \boldsymbol{L_{\mathrm{A}}} \begin{bmatrix}
[\boldsymbol{\mu_{\mathrm{A.std}}}, \boldsymbol{\mu_{\mathrm{A.std}}}&#39;]^{\mathrm{T}} &amp;
[\boldsymbol{\psi_{\mathrm{A.std}}}, \boldsymbol{\psi_{\mathrm{A.std}}}&#39;]^{\mathrm{T}}
\end{bmatrix} (\boldsymbol{\mathrm{G}_{sd}}\boldsymbol{\mathrm{L}_{Gcor}})^{\mathrm{T}} \]</span></p>
<p>which is appropriate for estimating values drawn from</p>
<p><span class="math display">\[\begin{bmatrix}[\boldsymbol{\mu_{\mathrm{A}}}, \boldsymbol{\mu_{\mathrm{A}}}&#39;]^{\mathrm{T}} &amp;
[\boldsymbol{\psi_{\mathrm{A}}}, \boldsymbol{\psi_{\mathrm{A}}}&#39;]^{\mathrm{T}}
\end{bmatrix}
\sim  \mathrm{Matrix\ Normal}(\boldsymbol{0},
\boldsymbol{\mathrm{L_A}} \boldsymbol{\mathrm{L_A}}^{\mathrm{T}},
\boldsymbol{\mathrm{L_{Gcov}}} \boldsymbol{\mathrm{L_{Gcov}}}^{\mathrm{T}} ) \equiv \\
\mathrm{vec}( 
\begin{bmatrix}
[\boldsymbol{\mu_{\mathrm{A}}}, \boldsymbol{\mu_{\mathrm{A}}}&#39;]^{\mathrm{T}} &amp;
[\boldsymbol{\psi_{\mathrm{A}}}, \boldsymbol{\psi_{\mathrm{A}}}&#39;]^{\mathrm{T}}
\end{bmatrix})
\sim \mathrm{MVNormal}(\mathrm{vec}(\boldsymbol{\mathrm{0}}),  \boldsymbol{\mathrm{G_{cov}}} \otimes \boldsymbol{\mathrm{A}} ) \]</span></p>
<p>The environmental effects are estimated with a standard non-centered multivariate normal parametrization</p>
<p><span class="math display">\[\mathrm{SRN}_{\mathrm{E}}=\left[ \boldsymbol{\mu_{\mathrm{E}}} \ \boldsymbol{\mu_{\mathrm{E}}}&#39; \right]=\left[ \boldsymbol{\mu_{\mathrm{E.std}}} \ \boldsymbol{\mu_{\mathrm{E.std}}}&#39; \right] 
(\boldsymbol{\mathrm{E}_{sd}}\boldsymbol{\mathrm{L}_{Ecor}})^{\mathrm{T}} \]</span>
The <span class="math inline">\(\mathrm{std}\)</span> values are standard normal deviates, i.e. <span class="math inline">\(\mathrm{std~\sim Normal}(0, 1)\)</span>, that are scaled to appropriate (co)variance through the separated SD and correlation parameters.</p>
<p>For Bayesian estimation, we place very weakly regularizing priors on the fixed population intercept, slope, and residual feedback parameters.</p>
<p><span class="math display">\[\mu_0, \psi_1, \phi \sim \mathrm{Normal}(0, 1)\]</span>
As explained in Chapter 1 (<a href="using-stan-in-r.html#animal-models">1.5</a>), we also place priors on the total phenotypic variance of the SRN intercepts and slopes, as well as SRN heritability parameters that are used to derive the additive genetic and permanent environmental variance.</p>
<p><span class="math display">\[\mathrm{sd}([\boldsymbol{\mu},\boldsymbol{\mu&#39;}]), \mathrm{sd}([\boldsymbol{\psi},\boldsymbol{\psi&#39;}])\sim \mathrm{Half-Cauchy}(0,1)\]</span>
<span class="math display">\[h_{\mu}^{2}, h_{\psi}^{2} \sim \mathrm{Beta}(1.2,1.2) \]</span>
where</p>
<p><span class="math display">\[\mathrm{Var}(\boldsymbol{\mu_\mathrm{A}}) = h_{\mu}^{2} \mathrm{Var}(\boldsymbol{\mu_\mathrm{ }}) \\ 
\mathrm{Var}(\boldsymbol{\mu_\mathrm{E}}) = (1-h_{\mu}^{2})\mathrm{Var}(\boldsymbol{\mu_\mathrm{ }})\]</span></p>
<p><span class="math display">\[\mathrm{Var}(\boldsymbol{\psi_\mathrm{A}}) = h_{\psi}^{2} \mathrm{Var}(\boldsymbol{\psi_\mathrm{ }}) \\ 
\mathrm{Var}(\boldsymbol{\psi_\mathrm{E}}) = (1-h_{\psi}^{2})\mathrm{Var}(\boldsymbol{\psi_\mathrm{ }})\]</span>
Priors can also be placed on the genetic and permanent environmental correlations</p>
<p><span class="math display">\[\boldsymbol{\mathrm{G}_{cor}},\boldsymbol{\mathrm{E}_{cor}} \sim \mathrm{LKJ}(2)\]</span></p>
<p>The same approach is used for decomposing the residual covariance matrix <span class="math inline">\(\boldsymbol{\Sigma}\)</span>.</p>
<p><span class="math display">\[\mathrm{sd}([\boldsymbol{\epsilon},\boldsymbol{\epsilon&#39;}]) \sim \mathrm{Half-Cauchy}(0,1)\]</span>
<span class="math display">\[\boldsymbol{\mathrm{\Sigma}_{cor}} \sim \mathrm{LKJ}(2)\]</span></p>
</div>
<div id="simulate-data-1" class="section level2" number="2.3">
<h2><span class="header-section-number">2.3</span> Simulate data</h2>
<div id="srn-parameters" class="section level3" number="2.3.1">
<h3><span class="header-section-number">2.3.1</span> SRN parameters</h3>
<p>Here we rely on the custom <code>pedfun()</code> function introduced in Chapter 1 to generate an <span class="math inline">\(\boldsymbol{\mathrm{A}}\)</span> matrix. We begin by setting the population parameters and simulating the SRN intercepts and slopes of males and females, assuming as stated above that their SRN parameters are characterized by equivalent covariance matrices.</p>
<div class="sourceCode" id="cb71"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb71-1"><a href="within-partner-sam.html#cb71-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(mvtnorm)</span>
<span id="cb71-2"><a href="within-partner-sam.html#cb71-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-3"><a href="within-partner-sam.html#cb71-3" aria-hidden="true" tabindex="-1"></a><span class="co">#population properties</span></span>
<span id="cb71-4"><a href="within-partner-sam.html#cb71-4" aria-hidden="true" tabindex="-1"></a>I<span class="ot">=</span><span class="dv">300</span> <span class="co">#total individuals for simulation</span></span>
<span id="cb71-5"><a href="within-partner-sam.html#cb71-5" aria-hidden="true" tabindex="-1"></a>popmin<span class="ot">=</span><span class="dv">400</span></span>
<span id="cb71-6"><a href="within-partner-sam.html#cb71-6" aria-hidden="true" tabindex="-1"></a>popmax<span class="ot">=</span><span class="dv">600</span></span>
<span id="cb71-7"><a href="within-partner-sam.html#cb71-7" aria-hidden="true" tabindex="-1"></a>ngenerations <span class="ot">=</span> <span class="dv">10</span></span>
<span id="cb71-8"><a href="within-partner-sam.html#cb71-8" aria-hidden="true" tabindex="-1"></a>nids<span class="ot">&lt;-</span><span class="fu">sample</span>(popmin<span class="sc">:</span>popmax, ngenerations, <span class="at">replace=</span><span class="cn">TRUE</span>) <span class="co">#N / generation</span></span>
<span id="cb71-9"><a href="within-partner-sam.html#cb71-9" aria-hidden="true" tabindex="-1"></a>epm <span class="ot">=</span> <span class="fu">sample</span>(<span class="fu">seq</span>(<span class="fl">0.15</span>, <span class="fl">0.25</span>,<span class="at">by=</span><span class="fl">0.05</span>),<span class="dv">1</span>) <span class="co">#extra-pair mating</span></span>
<span id="cb71-10"><a href="within-partner-sam.html#cb71-10" aria-hidden="true" tabindex="-1"></a>nonb <span class="ot">=</span> <span class="fu">sample</span>(<span class="fu">seq</span>(<span class="fl">0.4</span>,<span class="fl">0.6</span>,<span class="at">by=</span><span class="fl">0.05</span>),<span class="dv">1</span>) <span class="co">#proportion of non-breeding / generation</span></span>
<span id="cb71-11"><a href="within-partner-sam.html#cb71-11" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb71-12"><a href="within-partner-sam.html#cb71-12" aria-hidden="true" tabindex="-1"></a><span class="co">#relatedness matrix</span></span>
<span id="cb71-13"><a href="within-partner-sam.html#cb71-13" aria-hidden="true" tabindex="-1"></a>A_mat <span class="ot">&lt;-</span> <span class="fu">pedfun</span>(<span class="at">popmin=</span>popmin, <span class="at">popmax=</span>popmax, <span class="at">ngenerations=</span>ngenerations,</span>
<span id="cb71-14"><a href="within-partner-sam.html#cb71-14" aria-hidden="true" tabindex="-1"></a>                  <span class="at">epm=</span>epm, <span class="at">nonb=</span>nonb, <span class="at">nids=</span>nids, <span class="at">I=</span>I, <span class="at">missing=</span><span class="cn">FALSE</span>)</span>
<span id="cb71-15"><a href="within-partner-sam.html#cb71-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-16"><a href="within-partner-sam.html#cb71-16" aria-hidden="true" tabindex="-1"></a><span class="do">#####################################################################</span></span>
<span id="cb71-17"><a href="within-partner-sam.html#cb71-17" aria-hidden="true" tabindex="-1"></a><span class="co">#Parameter values</span></span>
<span id="cb71-18"><a href="within-partner-sam.html#cb71-18" aria-hidden="true" tabindex="-1"></a><span class="do">#####################################################################</span></span>
<span id="cb71-19"><a href="within-partner-sam.html#cb71-19" aria-hidden="true" tabindex="-1"></a>alpha_0 <span class="ot">=</span> <span class="dv">0</span> <span class="co">#global intercept</span></span>
<span id="cb71-20"><a href="within-partner-sam.html#cb71-20" aria-hidden="true" tabindex="-1"></a>psi_1 <span class="ot">=</span> <span class="sc">-</span><span class="fl">0.5</span> <span class="co">#population interaction coefficient</span></span>
<span id="cb71-21"><a href="within-partner-sam.html#cb71-21" aria-hidden="true" tabindex="-1"></a>phi <span class="ot">=</span>  <span class="fl">0.5</span> <span class="co">#residual feedback coefficient (epsilon_j ~ epsilon_t-1k)</span></span>
<span id="cb71-22"><a href="within-partner-sam.html#cb71-22" aria-hidden="true" tabindex="-1"></a>SD_intercept <span class="ot">=</span> <span class="fl">0.3</span> <span class="co">#standard deviation of SRN intercepts</span></span>
<span id="cb71-23"><a href="within-partner-sam.html#cb71-23" aria-hidden="true" tabindex="-1"></a>SD_slope <span class="ot">=</span> <span class="fl">0.3</span> <span class="co">#SD of SRN slopes</span></span>
<span id="cb71-24"><a href="within-partner-sam.html#cb71-24" aria-hidden="true" tabindex="-1"></a>r_alpha <span class="ot">=</span> <span class="fl">0.3</span> <span class="co">#assortment coefficient (expressed as correlation)</span></span>
<span id="cb71-25"><a href="within-partner-sam.html#cb71-25" aria-hidden="true" tabindex="-1"></a>r_G <span class="ot">=</span> <span class="fl">0.3</span> <span class="co">#genetic correlation of random intercepts and slopes</span></span>
<span id="cb71-26"><a href="within-partner-sam.html#cb71-26" aria-hidden="true" tabindex="-1"></a>r_E <span class="ot">=</span> <span class="fl">0.3</span> <span class="co">#environmental correlation</span></span>
<span id="cb71-27"><a href="within-partner-sam.html#cb71-27" aria-hidden="true" tabindex="-1"></a>r_R <span class="ot">=</span> <span class="sc">-</span><span class="fl">0.3</span> <span class="co">#residual effect correlation (epsilon_tj = epsilon_tk)</span></span>
<span id="cb71-28"><a href="within-partner-sam.html#cb71-28" aria-hidden="true" tabindex="-1"></a>V_G <span class="ot">=</span> <span class="fl">0.3</span> <span class="co">#genetic variance of REs</span></span>
<span id="cb71-29"><a href="within-partner-sam.html#cb71-29" aria-hidden="true" tabindex="-1"></a>V_E <span class="ot">=</span> <span class="fl">0.3</span> <span class="co">#genetic variance of REs</span></span>
<span id="cb71-30"><a href="within-partner-sam.html#cb71-30" aria-hidden="true" tabindex="-1"></a>res_V <span class="ot">=</span> <span class="dv">1</span></span>
<span id="cb71-31"><a href="within-partner-sam.html#cb71-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-32"><a href="within-partner-sam.html#cb71-32" aria-hidden="true" tabindex="-1"></a><span class="co">#Random effect correlations</span></span>
<span id="cb71-33"><a href="within-partner-sam.html#cb71-33" aria-hidden="true" tabindex="-1"></a>G_cor <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">c</span>(<span class="dv">1</span>,r_G,r_G,<span class="dv">1</span>), <span class="at">nrow=</span><span class="dv">2</span>, <span class="at">ncol=</span><span class="dv">2</span>) <span class="co">#mu_A, beta_A</span></span>
<span id="cb71-34"><a href="within-partner-sam.html#cb71-34" aria-hidden="true" tabindex="-1"></a>G_sd  <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fu">sqrt</span>(V_G),<span class="fu">sqrt</span>(V_G)) <span class="co">#G effect sds</span></span>
<span id="cb71-35"><a href="within-partner-sam.html#cb71-35" aria-hidden="true" tabindex="-1"></a>G_cov <span class="ot">&lt;-</span> <span class="fu">diag</span>(G_sd) <span class="sc">%*%</span> G_cor <span class="sc">%*%</span> <span class="fu">diag</span>(G_sd)</span>
<span id="cb71-36"><a href="within-partner-sam.html#cb71-36" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb71-37"><a href="within-partner-sam.html#cb71-37" aria-hidden="true" tabindex="-1"></a>E_cor <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">c</span>(<span class="dv">1</span>,r_E,r_E,<span class="dv">1</span>), <span class="at">nrow=</span><span class="dv">2</span>, <span class="at">ncol=</span><span class="dv">2</span>) <span class="co">#mu_E, beta_E</span></span>
<span id="cb71-38"><a href="within-partner-sam.html#cb71-38" aria-hidden="true" tabindex="-1"></a>E_sd  <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fu">sqrt</span>(V_E),<span class="fu">sqrt</span>(V_E)) <span class="co">#E effect sds</span></span>
<span id="cb71-39"><a href="within-partner-sam.html#cb71-39" aria-hidden="true" tabindex="-1"></a>E_cov <span class="ot">&lt;-</span> <span class="fu">diag</span>(E_sd) <span class="sc">%*%</span> E_cor <span class="sc">%*%</span> <span class="fu">diag</span>(E_sd)</span>
<span id="cb71-40"><a href="within-partner-sam.html#cb71-40" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb71-41"><a href="within-partner-sam.html#cb71-41" aria-hidden="true" tabindex="-1"></a><span class="co">#matrices</span></span>
<span id="cb71-42"><a href="within-partner-sam.html#cb71-42" aria-hidden="true" tabindex="-1"></a>G_block <span class="ot">&lt;-</span> G_cov <span class="sc">%x%</span> A_mat</span>
<span id="cb71-43"><a href="within-partner-sam.html#cb71-43" aria-hidden="true" tabindex="-1"></a>E_block <span class="ot">&lt;-</span> E_cov <span class="sc">%x%</span> <span class="fu">diag</span>(<span class="dv">1</span>,I)</span>
<span id="cb71-44"><a href="within-partner-sam.html#cb71-44" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb71-45"><a href="within-partner-sam.html#cb71-45" aria-hidden="true" tabindex="-1"></a><span class="co">#generate correlated REs</span></span>
<span id="cb71-46"><a href="within-partner-sam.html#cb71-46" aria-hidden="true" tabindex="-1"></a>Gvalues <span class="ot">&lt;-</span> <span class="fu">rmvnorm</span>(<span class="dv">1</span>, <span class="at">mean=</span><span class="fu">rep</span>(<span class="dv">0</span>,I<span class="sc">*</span><span class="dv">2</span>), <span class="at">sigma=</span>G_block)</span>
<span id="cb71-47"><a href="within-partner-sam.html#cb71-47" aria-hidden="true" tabindex="-1"></a>G_val <span class="ot">=</span> <span class="fu">data.frame</span>(<span class="fu">matrix</span>(Gvalues, <span class="at">nrow=</span>I, <span class="at">ncol=</span><span class="dv">2</span>))</span>
<span id="cb71-48"><a href="within-partner-sam.html#cb71-48" aria-hidden="true" tabindex="-1"></a><span class="fu">cor</span>(G_val)</span></code></pre></div>
<pre><code>##           X1        X2
## X1 1.0000000 0.3501241
## X2 0.3501241 1.0000000</code></pre>
<div class="sourceCode" id="cb73"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb73-1"><a href="within-partner-sam.html#cb73-1" aria-hidden="true" tabindex="-1"></a>Evalues <span class="ot">&lt;-</span> <span class="fu">rmvnorm</span>(<span class="dv">1</span>, <span class="at">mean=</span><span class="fu">rep</span>(<span class="dv">0</span>,I<span class="sc">*</span><span class="dv">2</span>), <span class="at">sigma=</span>E_block)</span>
<span id="cb73-2"><a href="within-partner-sam.html#cb73-2" aria-hidden="true" tabindex="-1"></a>E_val <span class="ot">=</span> <span class="fu">data.frame</span>(<span class="fu">matrix</span>(Evalues, <span class="at">nrow=</span>I, <span class="at">ncol=</span><span class="dv">2</span>))</span>
<span id="cb73-3"><a href="within-partner-sam.html#cb73-3" aria-hidden="true" tabindex="-1"></a><span class="fu">cor</span>(E_val)</span></code></pre></div>
<pre><code>##           X1        X2
## X1 1.0000000 0.3753003
## X2 0.3753003 1.0000000</code></pre>
<div class="sourceCode" id="cb75"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb75-1"><a href="within-partner-sam.html#cb75-1" aria-hidden="true" tabindex="-1"></a><span class="co">#combine temporary object for all SRN parameters</span></span>
<span id="cb75-2"><a href="within-partner-sam.html#cb75-2" aria-hidden="true" tabindex="-1"></a><span class="co">#use shorthand mu = 0, psi = 1</span></span>
<span id="cb75-3"><a href="within-partner-sam.html#cb75-3" aria-hidden="true" tabindex="-1"></a>P <span class="ot">=</span> <span class="fu">cbind</span>(G_val,E_val)</span>
<span id="cb75-4"><a href="within-partner-sam.html#cb75-4" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(P) <span class="ot">=</span> <span class="fu">c</span>(<span class="st">&quot;A0&quot;</span>, <span class="st">&quot;A1&quot;</span>, <span class="st">&quot;E0&quot;</span>, <span class="st">&quot;E1&quot;</span>)</span>
<span id="cb75-5"><a href="within-partner-sam.html#cb75-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-6"><a href="within-partner-sam.html#cb75-6" aria-hidden="true" tabindex="-1"></a><span class="co">#individual phenotypic REs</span></span>
<span id="cb75-7"><a href="within-partner-sam.html#cb75-7" aria-hidden="true" tabindex="-1"></a><span class="co">#use shorthand mu = 0, psi = 1</span></span>
<span id="cb75-8"><a href="within-partner-sam.html#cb75-8" aria-hidden="true" tabindex="-1"></a>P<span class="sc">$</span>P0 <span class="ot">=</span> P<span class="sc">$</span>A0 <span class="sc">+</span> P<span class="sc">$</span>E0 </span>
<span id="cb75-9"><a href="within-partner-sam.html#cb75-9" aria-hidden="true" tabindex="-1"></a>P<span class="sc">$</span>P1 <span class="ot">=</span> P<span class="sc">$</span>A1 <span class="sc">+</span> P<span class="sc">$</span>E1</span>
<span id="cb75-10"><a href="within-partner-sam.html#cb75-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-11"><a href="within-partner-sam.html#cb75-11" aria-hidden="true" tabindex="-1"></a><span class="co">#add ID</span></span>
<span id="cb75-12"><a href="within-partner-sam.html#cb75-12" aria-hidden="true" tabindex="-1"></a>P<span class="sc">$</span>ID <span class="ot">=</span> <span class="fu">seq</span>(<span class="dv">1</span><span class="sc">:</span>I)</span></code></pre></div>
</div>
<div id="assortment" class="section level3" number="2.3.2">
<h3><span class="header-section-number">2.3.2</span> Assortment</h3>
<p>We can now split the generated values into male and female values, assuming both sexes are evenly sampled so that <span class="math inline">\(N_M = N_F=N/2\)</span>. As is explained in <strong>Appendix S1</strong> of <span class="citation"><a href="#ref-SAM" role="doc-biblioref">Martin and Jaeggi</a> (<a href="#ref-SAM" role="doc-biblioref">2021</a>)</span>, we can then use a simple sorting procedure to assortment individuals on a single SRN parameter. In this case, we use the SRN intercepts <span class="math inline">\(\boldsymbol{\mu}\)</span>. A more general approach would be use to an additional social matrix <span class="math inline">\(\boldsymbol{\mathrm{S}}\)</span> to add to the relatedness matrix <span class="math inline">\(\boldsymbol{\mathrm{A}}\)</span> prior to scaling the additive genetic values.</p>
<div class="sourceCode" id="cb76"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb76-1"><a href="within-partner-sam.html#cb76-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(MASS)</span>
<span id="cb76-2"><a href="within-partner-sam.html#cb76-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-3"><a href="within-partner-sam.html#cb76-3" aria-hidden="true" tabindex="-1"></a><span class="co">#split male and female values + add arbitrary ID</span></span>
<span id="cb76-4"><a href="within-partner-sam.html#cb76-4" aria-hidden="true" tabindex="-1"></a><span class="co">#use P0=mu and P1=psi for shorthand</span></span>
<span id="cb76-5"><a href="within-partner-sam.html#cb76-5" aria-hidden="true" tabindex="-1"></a>sort.m <span class="ot">=</span> <span class="fu">data.frame</span>(<span class="at">P0_m =</span> P<span class="sc">$</span>P0[<span class="dv">1</span><span class="sc">:</span>(I<span class="sc">/</span><span class="dv">2</span>)], <span class="at">ID_m =</span> <span class="dv">1</span><span class="sc">:</span>(I<span class="sc">/</span><span class="dv">2</span>) ) </span>
<span id="cb76-6"><a href="within-partner-sam.html#cb76-6" aria-hidden="true" tabindex="-1"></a>sort.f <span class="ot">=</span> <span class="fu">data.frame</span>(<span class="at">P0_f =</span> P<span class="sc">$</span>P0[(I<span class="sc">/</span><span class="dv">2</span><span class="sc">+</span><span class="dv">1</span>)<span class="sc">:</span>I], <span class="at">ID_f =</span> (I<span class="sc">/</span><span class="dv">2</span><span class="sc">+</span><span class="dv">1</span>)<span class="sc">:</span>I)</span>
<span id="cb76-7"><a href="within-partner-sam.html#cb76-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-8"><a href="within-partner-sam.html#cb76-8" aria-hidden="true" tabindex="-1"></a><span class="co">#sort by SRN intercept value</span></span>
<span id="cb76-9"><a href="within-partner-sam.html#cb76-9" aria-hidden="true" tabindex="-1"></a>sort.m<span class="ot">&lt;-</span>sort.m[<span class="fu">order</span>(sort.m[,<span class="st">&quot;P0_m&quot;</span>]),]</span>
<span id="cb76-10"><a href="within-partner-sam.html#cb76-10" aria-hidden="true" tabindex="-1"></a>sort.f<span class="ot">&lt;-</span>sort.f[<span class="fu">order</span>(sort.f[,<span class="st">&quot;P0_f&quot;</span>]),]</span>
<span id="cb76-11"><a href="within-partner-sam.html#cb76-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-12"><a href="within-partner-sam.html#cb76-12" aria-hidden="true" tabindex="-1"></a><span class="co">#generate random dataset with desired rank-order correlation</span></span>
<span id="cb76-13"><a href="within-partner-sam.html#cb76-13" aria-hidden="true" tabindex="-1"></a>temp_mat <span class="ot">&lt;-</span> <span class="fu">matrix</span>(r_alpha, <span class="at">ncol =</span> <span class="dv">2</span>, <span class="at">nrow =</span> <span class="dv">2</span>) <span class="co">#cor of male and female values</span></span>
<span id="cb76-14"><a href="within-partner-sam.html#cb76-14" aria-hidden="true" tabindex="-1"></a><span class="fu">diag</span>(temp_mat) <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="co">#cor matrix</span></span>
<span id="cb76-15"><a href="within-partner-sam.html#cb76-15" aria-hidden="true" tabindex="-1"></a>temp_data1<span class="ot">&lt;-</span><span class="fu">mvrnorm</span>(<span class="at">n =</span> I<span class="sc">/</span><span class="dv">2</span>, <span class="at">mu =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">0</span>), <span class="at">Sigma =</span> temp_mat, <span class="at">empirical=</span><span class="cn">TRUE</span>)</span>
<span id="cb76-16"><a href="within-partner-sam.html#cb76-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-17"><a href="within-partner-sam.html#cb76-17" aria-hidden="true" tabindex="-1"></a><span class="co">#ranks of random data</span></span>
<span id="cb76-18"><a href="within-partner-sam.html#cb76-18" aria-hidden="true" tabindex="-1"></a>rm <span class="ot">&lt;-</span> <span class="fu">rank</span>(temp_data1[ , <span class="dv">1</span>], <span class="at">ties.method =</span> <span class="st">&quot;first&quot;</span>)</span>
<span id="cb76-19"><a href="within-partner-sam.html#cb76-19" aria-hidden="true" tabindex="-1"></a>rf <span class="ot">&lt;-</span> <span class="fu">rank</span>(temp_data1[ , <span class="dv">2</span>], <span class="at">ties.method =</span> <span class="st">&quot;first&quot;</span>)</span>
<span id="cb76-20"><a href="within-partner-sam.html#cb76-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-21"><a href="within-partner-sam.html#cb76-21" aria-hidden="true" tabindex="-1"></a><span class="co">#induce cor through rank-ordering of RN vectors</span></span>
<span id="cb76-22"><a href="within-partner-sam.html#cb76-22" aria-hidden="true" tabindex="-1"></a><span class="fu">cor</span>(sort.m<span class="sc">$</span>P0_m[rm], sort.f<span class="sc">$</span>P0_f[rf])</span></code></pre></div>
<pre><code>## [1] 0.3052259</code></pre>
<div class="sourceCode" id="cb78"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb78-1"><a href="within-partner-sam.html#cb78-1" aria-hidden="true" tabindex="-1"></a><span class="co">#sort partner ids into dataframe (order on male ID)</span></span>
<span id="cb78-2"><a href="within-partner-sam.html#cb78-2" aria-hidden="true" tabindex="-1"></a>partner.id <span class="ot">=</span> <span class="fu">data.frame</span>(<span class="at">ID_m =</span> sort.m<span class="sc">$</span>ID_m[rm], <span class="at">ID_f =</span> sort.f<span class="sc">$</span>ID_f[rf])</span>
<span id="cb78-3"><a href="within-partner-sam.html#cb78-3" aria-hidden="true" tabindex="-1"></a>partner.id <span class="ot">=</span> partner.id[<span class="fu">order</span>(partner.id[,<span class="st">&quot;ID_m&quot;</span>]),]</span></code></pre></div>
<p>With the assorted ranks in <code>partner.id</code>, we can then structure the dataframe appropriately to match male and female partners with the desired correlation in SRN intercepts.</p>
<div class="sourceCode" id="cb79"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb79-1"><a href="within-partner-sam.html#cb79-1" aria-hidden="true" tabindex="-1"></a><span class="co">#put all dyads together</span></span>
<span id="cb79-2"><a href="within-partner-sam.html#cb79-2" aria-hidden="true" tabindex="-1"></a>  partner.id<span class="sc">$</span>dyadn <span class="ot">=</span> <span class="fu">seq</span>(<span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(partner.id))</span>
<span id="cb79-3"><a href="within-partner-sam.html#cb79-3" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb79-4"><a href="within-partner-sam.html#cb79-4" aria-hidden="true" tabindex="-1"></a>  <span class="co">#add values back to dataframe (male and joint)</span></span>
<span id="cb79-5"><a href="within-partner-sam.html#cb79-5" aria-hidden="true" tabindex="-1"></a>  partner.id<span class="sc">$</span>P0m <span class="ot">&lt;-</span> P<span class="sc">$</span>P0[<span class="fu">match</span>(partner.id<span class="sc">$</span>ID_m,P<span class="sc">$</span>ID)]</span>
<span id="cb79-6"><a href="within-partner-sam.html#cb79-6" aria-hidden="true" tabindex="-1"></a>  partner.id<span class="sc">$</span>P0f <span class="ot">&lt;-</span> P<span class="sc">$</span>P0[<span class="fu">match</span>(partner.id<span class="sc">$</span>ID_f,P<span class="sc">$</span>ID)]</span>
<span id="cb79-7"><a href="within-partner-sam.html#cb79-7" aria-hidden="true" tabindex="-1"></a>  partner.id<span class="sc">$</span>P1m <span class="ot">&lt;-</span> P<span class="sc">$</span>P1[<span class="fu">match</span>(partner.id<span class="sc">$</span>ID_m,P<span class="sc">$</span>ID)]</span>
<span id="cb79-8"><a href="within-partner-sam.html#cb79-8" aria-hidden="true" tabindex="-1"></a>  partner.id<span class="sc">$</span>P1f <span class="ot">&lt;-</span> P<span class="sc">$</span>P1[<span class="fu">match</span>(partner.id<span class="sc">$</span>ID_f,P<span class="sc">$</span>ID)]</span>
<span id="cb79-9"><a href="within-partner-sam.html#cb79-9" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb79-10"><a href="within-partner-sam.html#cb79-10" aria-hidden="true" tabindex="-1"></a>  partner.id<span class="sc">$</span>A0m <span class="ot">&lt;-</span> P<span class="sc">$</span>A0[<span class="fu">match</span>(partner.id<span class="sc">$</span>ID_m,P<span class="sc">$</span>ID)]</span>
<span id="cb79-11"><a href="within-partner-sam.html#cb79-11" aria-hidden="true" tabindex="-1"></a>  partner.id<span class="sc">$</span>A0f <span class="ot">&lt;-</span> P<span class="sc">$</span>A0[<span class="fu">match</span>(partner.id<span class="sc">$</span>ID_f,P<span class="sc">$</span>ID)]</span>
<span id="cb79-12"><a href="within-partner-sam.html#cb79-12" aria-hidden="true" tabindex="-1"></a>  partner.id<span class="sc">$</span>A1m <span class="ot">&lt;-</span> P<span class="sc">$</span>A1[<span class="fu">match</span>(partner.id<span class="sc">$</span>ID_m,P<span class="sc">$</span>ID)]</span>
<span id="cb79-13"><a href="within-partner-sam.html#cb79-13" aria-hidden="true" tabindex="-1"></a>  partner.id<span class="sc">$</span>A1f <span class="ot">&lt;-</span> P<span class="sc">$</span>A1[<span class="fu">match</span>(partner.id<span class="sc">$</span>ID_f,P<span class="sc">$</span>ID)]</span>
<span id="cb79-14"><a href="within-partner-sam.html#cb79-14" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb79-15"><a href="within-partner-sam.html#cb79-15" aria-hidden="true" tabindex="-1"></a>  partner.id<span class="sc">$</span>E0m <span class="ot">&lt;-</span> P<span class="sc">$</span>E0[<span class="fu">match</span>(partner.id<span class="sc">$</span>ID_m,P<span class="sc">$</span>ID)]</span>
<span id="cb79-16"><a href="within-partner-sam.html#cb79-16" aria-hidden="true" tabindex="-1"></a>  partner.id<span class="sc">$</span>E0f <span class="ot">&lt;-</span> P<span class="sc">$</span>E0[<span class="fu">match</span>(partner.id<span class="sc">$</span>ID_f,P<span class="sc">$</span>ID)]</span>
<span id="cb79-17"><a href="within-partner-sam.html#cb79-17" aria-hidden="true" tabindex="-1"></a>  partner.id<span class="sc">$</span>E1m <span class="ot">&lt;-</span> P<span class="sc">$</span>E1[<span class="fu">match</span>(partner.id<span class="sc">$</span>ID_m,P<span class="sc">$</span>ID)]</span>
<span id="cb79-18"><a href="within-partner-sam.html#cb79-18" aria-hidden="true" tabindex="-1"></a>  partner.id<span class="sc">$</span>E1f <span class="ot">&lt;-</span> P<span class="sc">$</span>E1[<span class="fu">match</span>(partner.id<span class="sc">$</span>ID_f,P<span class="sc">$</span>ID)]</span>
<span id="cb79-19"><a href="within-partner-sam.html#cb79-19" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb79-20"><a href="within-partner-sam.html#cb79-20" aria-hidden="true" tabindex="-1"></a>  <span class="co">#check correlation again</span></span>
<span id="cb79-21"><a href="within-partner-sam.html#cb79-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cor</span>(partner.id<span class="sc">$</span>P0m, partner.id<span class="sc">$</span>P0f)</span></code></pre></div>
<pre><code>## [1] 0.3052259</code></pre>
<div class="sourceCode" id="cb81"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb81-1"><a href="within-partner-sam.html#cb81-1" aria-hidden="true" tabindex="-1"></a>  <span class="co">#check data structure</span></span>
<span id="cb81-2"><a href="within-partner-sam.html#cb81-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">head</span>(partner.id)</span></code></pre></div>
<pre><code>##     ID_m ID_f dyadn         P0m        P0f        P1m        P1f         A0m         A0f         A1m        A1f        E0m        E0f         E1m        E1f
## 83     1  158     1 -0.60447737  0.3002294  0.1381750  0.9197807  0.08242542  0.42929926  0.07483432  0.7503359 -0.6869028 -0.1290699  0.06334066  0.1694448
## 128    2  234     2  0.44516978 -0.1251509  0.4758293 -0.8039042  0.14478761 -1.23563991 -0.09839661 -0.4920228  0.3003822  1.1104890  0.57422587 -0.3118813
## 79     3  272     3  0.29663393 -1.3752583 -0.1079828 -0.9338810  0.46308917 -0.99745270  0.67619892 -0.8060799 -0.1664552 -0.3778056 -0.78418171 -0.1278011
## 130    4  215     4  0.65868965  2.0620621  0.7574922  1.1235457  0.02848557  0.78063584  0.58771664 -0.2054451  0.6302041  1.2814263  0.16977559  1.3289908
## 119    5  206     5  0.95374875  0.2837430  1.2076925  0.9229270  1.22823523  0.48233291  1.06921250  0.3376829 -0.2744865 -0.1985899  0.13847997  0.5852441
## 62     6  190     6  0.07910526  1.0907414 -0.4165885  0.3179899 -0.04883328  0.07890664 -0.58289345 -0.5501955  0.1279385  1.0118348  0.16630497  0.8681854</code></pre>
</div>
<div id="repeated-measurements-within-the-partner" class="section level3" number="2.3.3">
<h3><span class="header-section-number">2.3.3</span> Repeated measurements within the partner</h3>
<p>For simplicity we consider a case with measurements of focal individuals and social partners taken over two discrete sampling periods, so that the time index <span class="math inline">\(t= \left \{ 1,2 \right \}\)</span>. We begin by expanding the dataframe for two measurements.</p>
<div class="sourceCode" id="cb83"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb83-1"><a href="within-partner-sam.html#cb83-1" aria-hidden="true" tabindex="-1"></a><span class="co">#number of dyads</span></span>
<span id="cb83-2"><a href="within-partner-sam.html#cb83-2" aria-hidden="true" tabindex="-1"></a>ndyad <span class="ot">=</span> <span class="fu">nrow</span>(partner.id)</span>
<span id="cb83-3"><a href="within-partner-sam.html#cb83-3" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb83-4"><a href="within-partner-sam.html#cb83-4" aria-hidden="true" tabindex="-1"></a><span class="co">#expand for repeated measures</span></span>
<span id="cb83-5"><a href="within-partner-sam.html#cb83-5" aria-hidden="true" tabindex="-1"></a>partner.id<span class="sc">$</span>rep <span class="ot">&lt;-</span> <span class="dv">2</span> <span class="co">#two repeated measurements</span></span>
<span id="cb83-6"><a href="within-partner-sam.html#cb83-6" aria-hidden="true" tabindex="-1"></a>pair_df <span class="ot">&lt;-</span> partner.id[<span class="fu">rep</span>(<span class="fu">row.names</span>(partner.id), partner.id<span class="sc">$</span>rep),]</span></code></pre></div>
<p>We can first calculate the partner residuals for each observation, which will be used in the residual feedback component of the autoregressive moving average (ARMA) function specified in the next step.</p>
<div class="sourceCode" id="cb84"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb84-1"><a href="within-partner-sam.html#cb84-1" aria-hidden="true" tabindex="-1"></a><span class="co">#correlated  residuals between male and females</span></span>
<span id="cb84-2"><a href="within-partner-sam.html#cb84-2" aria-hidden="true" tabindex="-1"></a>R_cor <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">c</span>(<span class="dv">1</span>,r_R,r_R,<span class="dv">1</span>), <span class="at">nrow=</span><span class="dv">2</span>, <span class="at">ncol=</span><span class="dv">2</span>)</span>
<span id="cb84-3"><a href="within-partner-sam.html#cb84-3" aria-hidden="true" tabindex="-1"></a>res_sd <span class="ot">&lt;-</span> <span class="fu">sqrt</span>(res_V) </span>
<span id="cb84-4"><a href="within-partner-sam.html#cb84-4" aria-hidden="true" tabindex="-1"></a>R_cov <span class="ot">&lt;-</span> <span class="fu">diag</span>(<span class="fu">c</span>(res_sd,res_sd)) <span class="sc">%*%</span> R_cor <span class="sc">%*%</span> <span class="fu">diag</span>(<span class="fu">c</span>(res_sd,res_sd))</span>
<span id="cb84-5"><a href="within-partner-sam.html#cb84-5" aria-hidden="true" tabindex="-1"></a>res_ind<span class="ot">&lt;-</span><span class="fu">data.frame</span>(<span class="fu">rmvnorm</span>(<span class="fu">nrow</span>(pair_df), <span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">0</span>), R_cov))</span>
<span id="cb84-6"><a href="within-partner-sam.html#cb84-6" aria-hidden="true" tabindex="-1"></a>pair_df<span class="sc">$</span>resAGm <span class="ot">=</span> res_ind<span class="sc">$</span>X1</span>
<span id="cb84-7"><a href="within-partner-sam.html#cb84-7" aria-hidden="true" tabindex="-1"></a>pair_df<span class="sc">$</span>resAGf <span class="ot">=</span> res_ind<span class="sc">$</span>X2</span></code></pre></div>
<p>We can now specify our ARMA process across measurement time 1 and 2 for the latent SRN trait values for males <span class="math inline">\(\boldsymbol{\eta}\)</span> and females <span class="math inline">\(\boldsymbol{\eta&#39;}\)</span>, as well as the SRN measurement errors <span class="math inline">\(\boldsymbol{\xi}\)</span> and <span class="math inline">\(\boldsymbol{\xi&#39;}\)</span>.</p>
<div class="sourceCode" id="cb85"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb85-1"><a href="within-partner-sam.html#cb85-1" aria-hidden="true" tabindex="-1"></a><span class="do">#####################################################################</span></span>
<span id="cb85-2"><a href="within-partner-sam.html#cb85-2" aria-hidden="true" tabindex="-1"></a><span class="co">#Simulate responses over t = {1,2} per partner</span></span>
<span id="cb85-3"><a href="within-partner-sam.html#cb85-3" aria-hidden="true" tabindex="-1"></a><span class="do">#####################################################################</span></span>
<span id="cb85-4"><a href="within-partner-sam.html#cb85-4" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb85-5"><a href="within-partner-sam.html#cb85-5" aria-hidden="true" tabindex="-1"></a><span class="co">#add interaction number</span></span>
<span id="cb85-6"><a href="within-partner-sam.html#cb85-6" aria-hidden="true" tabindex="-1"></a>pair_df<span class="sc">$</span>turn <span class="ot">=</span> <span class="fu">rep</span>(<span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">2</span>),ndyad) </span>
<span id="cb85-7"><a href="within-partner-sam.html#cb85-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-8"><a href="within-partner-sam.html#cb85-8" aria-hidden="true" tabindex="-1"></a><span class="co">#individual prediction at t = 1</span></span>
<span id="cb85-9"><a href="within-partner-sam.html#cb85-9" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb85-10"><a href="within-partner-sam.html#cb85-10" aria-hidden="true" tabindex="-1"></a><span class="co">#males</span></span>
<span id="cb85-11"><a href="within-partner-sam.html#cb85-11" aria-hidden="true" tabindex="-1"></a><span class="co">#eta_j{t=1} = mu_j + (psi + psi_j)*mu_k</span></span>
<span id="cb85-12"><a href="within-partner-sam.html#cb85-12" aria-hidden="true" tabindex="-1"></a>pair_df[pair_df<span class="sc">$</span>turn<span class="sc">==</span><span class="dv">1</span>,<span class="st">&quot;eta_m&quot;</span>] <span class="ot">=</span> pair_df[pair_df<span class="sc">$</span>turn<span class="sc">==</span><span class="dv">1</span>,<span class="st">&quot;P0m&quot;</span>] <span class="sc">+</span> </span>
<span id="cb85-13"><a href="within-partner-sam.html#cb85-13" aria-hidden="true" tabindex="-1"></a>                                       (psi_1 <span class="sc">+</span> pair_df[pair_df<span class="sc">$</span>turn<span class="sc">==</span><span class="dv">1</span>,<span class="st">&quot;P1m&quot;</span>])<span class="sc">*</span>(pair_df[pair_df<span class="sc">$</span>turn<span class="sc">==</span><span class="dv">1</span>,<span class="st">&quot;P0f&quot;</span>])</span>
<span id="cb85-14"><a href="within-partner-sam.html#cb85-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-15"><a href="within-partner-sam.html#cb85-15" aria-hidden="true" tabindex="-1"></a><span class="co">#females</span></span>
<span id="cb85-16"><a href="within-partner-sam.html#cb85-16" aria-hidden="true" tabindex="-1"></a><span class="co">#eta_k{t=1} = mu_k +(psi + psi_k)*mu_j                                                                                              </span></span>
<span id="cb85-17"><a href="within-partner-sam.html#cb85-17" aria-hidden="true" tabindex="-1"></a>pair_df[pair_df<span class="sc">$</span>turn<span class="sc">==</span><span class="dv">1</span>,<span class="st">&quot;eta_f&quot;</span>] <span class="ot">=</span> pair_df[pair_df<span class="sc">$</span>turn<span class="sc">==</span><span class="dv">1</span>,<span class="st">&quot;P0f&quot;</span>] <span class="sc">+</span> </span>
<span id="cb85-18"><a href="within-partner-sam.html#cb85-18" aria-hidden="true" tabindex="-1"></a>                                        (psi_1 <span class="sc">+</span> pair_df[pair_df<span class="sc">$</span>turn<span class="sc">==</span><span class="dv">1</span>,<span class="st">&quot;P1f&quot;</span>])<span class="sc">*</span>(pair_df[pair_df<span class="sc">$</span>turn<span class="sc">==</span><span class="dv">1</span>,<span class="st">&quot;P0m&quot;</span>])</span>
<span id="cb85-19"><a href="within-partner-sam.html#cb85-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-20"><a href="within-partner-sam.html#cb85-20" aria-hidden="true" tabindex="-1"></a><span class="co">#individual prediction at t = 2</span></span>
<span id="cb85-21"><a href="within-partner-sam.html#cb85-21" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb85-22"><a href="within-partner-sam.html#cb85-22" aria-hidden="true" tabindex="-1"></a><span class="co">#males</span></span>
<span id="cb85-23"><a href="within-partner-sam.html#cb85-23" aria-hidden="true" tabindex="-1"></a><span class="co">#eta_j{t=2} = mu_j + (psi + psi_j)*(eta_k{t=1})</span></span>
<span id="cb85-24"><a href="within-partner-sam.html#cb85-24" aria-hidden="true" tabindex="-1"></a>pair_df[pair_df<span class="sc">$</span>turn<span class="sc">==</span><span class="dv">2</span>,<span class="st">&quot;eta_m&quot;</span>] <span class="ot">=</span> pair_df[pair_df<span class="sc">$</span>turn<span class="sc">==</span><span class="dv">2</span>,<span class="st">&quot;P0m&quot;</span>] <span class="sc">+</span></span>
<span id="cb85-25"><a href="within-partner-sam.html#cb85-25" aria-hidden="true" tabindex="-1"></a>                                        (psi_1 <span class="sc">+</span> pair_df[pair_df<span class="sc">$</span>turn<span class="sc">==</span><span class="dv">2</span>,<span class="st">&quot;P1m&quot;</span>])<span class="sc">*</span>(pair_df[pair_df<span class="sc">$</span>turn<span class="sc">==</span><span class="dv">1</span>,<span class="st">&quot;eta_f&quot;</span>])</span>
<span id="cb85-26"><a href="within-partner-sam.html#cb85-26" aria-hidden="true" tabindex="-1"></a>                                     </span>
<span id="cb85-27"><a href="within-partner-sam.html#cb85-27" aria-hidden="true" tabindex="-1"></a><span class="co">#females</span></span>
<span id="cb85-28"><a href="within-partner-sam.html#cb85-28" aria-hidden="true" tabindex="-1"></a><span class="co">#eta_k{t=2} = mu_k + (psi + psi_k)*(eta_j{t=1})</span></span>
<span id="cb85-29"><a href="within-partner-sam.html#cb85-29" aria-hidden="true" tabindex="-1"></a>pair_df[pair_df<span class="sc">$</span>turn<span class="sc">==</span><span class="dv">2</span>,<span class="st">&quot;eta_f&quot;</span>] <span class="ot">=</span> pair_df[pair_df<span class="sc">$</span>turn<span class="sc">==</span><span class="dv">2</span>,<span class="st">&quot;P0f&quot;</span>] <span class="sc">+</span> </span>
<span id="cb85-30"><a href="within-partner-sam.html#cb85-30" aria-hidden="true" tabindex="-1"></a>                                        (psi_1 <span class="sc">+</span> pair_df[pair_df<span class="sc">$</span>turn<span class="sc">==</span><span class="dv">2</span>,<span class="st">&quot;P1f&quot;</span>])<span class="sc">*</span>(pair_df[pair_df<span class="sc">$</span>turn<span class="sc">==</span><span class="dv">1</span>,<span class="st">&quot;eta_m&quot;</span>])</span>
<span id="cb85-31"><a href="within-partner-sam.html#cb85-31" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb85-32"><a href="within-partner-sam.html#cb85-32" aria-hidden="true" tabindex="-1"></a><span class="co">#add intercept and residuals (other fixed effects could be added here as well)</span></span>
<span id="cb85-33"><a href="within-partner-sam.html#cb85-33" aria-hidden="true" tabindex="-1"></a>pair_df<span class="sc">$</span>AG_m <span class="ot">=</span> alpha_0 <span class="sc">+</span> pair_df<span class="sc">$</span>eta_m <span class="sc">+</span> pair_df<span class="sc">$</span>resAGm</span>
<span id="cb85-34"><a href="within-partner-sam.html#cb85-34" aria-hidden="true" tabindex="-1"></a>pair_df<span class="sc">$</span>AG_f <span class="ot">=</span> alpha_0 <span class="sc">+</span> pair_df<span class="sc">$</span>eta_f <span class="sc">+</span> pair_df<span class="sc">$</span>resAGf</span>
<span id="cb85-35"><a href="within-partner-sam.html#cb85-35" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb85-36"><a href="within-partner-sam.html#cb85-36" aria-hidden="true" tabindex="-1"></a><span class="co">#add residual feedback process</span></span>
<span id="cb85-37"><a href="within-partner-sam.html#cb85-37" aria-hidden="true" tabindex="-1"></a>pair_df[pair_df<span class="sc">$</span>turn<span class="sc">==</span><span class="dv">2</span>,<span class="st">&quot;AG_m&quot;</span>] <span class="ot">=</span> pair_df[pair_df<span class="sc">$</span>turn<span class="sc">==</span><span class="dv">2</span>,<span class="st">&quot;AG_m&quot;</span>] <span class="sc">+</span> phi <span class="sc">*</span> pair_df[pair_df<span class="sc">$</span>turn<span class="sc">==</span><span class="dv">1</span>,<span class="st">&quot;resAGf&quot;</span>]</span>
<span id="cb85-38"><a href="within-partner-sam.html#cb85-38" aria-hidden="true" tabindex="-1"></a>pair_df[pair_df<span class="sc">$</span>turn<span class="sc">==</span><span class="dv">2</span>,<span class="st">&quot;AG_f&quot;</span>] <span class="ot">=</span> pair_df[pair_df<span class="sc">$</span>turn<span class="sc">==</span><span class="dv">2</span>,<span class="st">&quot;AG_f&quot;</span>] <span class="sc">+</span> phi <span class="sc">*</span> pair_df[pair_df<span class="sc">$</span>turn<span class="sc">==</span><span class="dv">1</span>,<span class="st">&quot;resAGm&quot;</span>]</span></code></pre></div>
<p>By adding together the SRN and residual feedback processes, we finally get the measured aggression trait values for males <code>AG_m</code> and females <code>AG_f</code>. Note that, because of the feedback process, it is more straightforward to specify these Gaussian responses by adding together their constitutive components, than by trying to sample responses directly from a distribution, e.g. such as <span class="math inline">\(z_{jt} \sim \mathrm{MVNormal}(\eta_{jt}+\xi_{jt}, \boldsymbol{\Sigma})\)</span>. We will similarly modify our basic animal model code in Stan when accounting for this ARMA process.</p>
<p>To aid in structuring our Stan model, we can also create some additional values and indices for males and females, which can be used to pull the appropriate focal and partner trait values from the vectors SRN parameters. The data can then be collected together in a list for Stan.</p>
<div class="sourceCode" id="cb86"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb86-1"><a href="within-partner-sam.html#cb86-1" aria-hidden="true" tabindex="-1"></a><span class="co">#individual indices</span></span>
<span id="cb86-2"><a href="within-partner-sam.html#cb86-2" aria-hidden="true" tabindex="-1"></a>Im <span class="ot">=</span> I<span class="sc">/</span><span class="dv">2</span> <span class="co">#number of males</span></span>
<span id="cb86-3"><a href="within-partner-sam.html#cb86-3" aria-hidden="true" tabindex="-1"></a>If <span class="ot">=</span> I<span class="sc">/</span><span class="dv">2</span> <span class="co">#number of females</span></span>
<span id="cb86-4"><a href="within-partner-sam.html#cb86-4" aria-hidden="true" tabindex="-1"></a>N_sex <span class="ot">=</span> (I<span class="sc">/</span><span class="dv">2</span>)<span class="sc">*</span><span class="dv">2</span> <span class="co">#total observations per sex</span></span>
<span id="cb86-5"><a href="within-partner-sam.html#cb86-5" aria-hidden="true" tabindex="-1"></a>idm<span class="ot">&lt;-</span>pair_df<span class="sc">$</span>ID_m <span class="co">#male ID</span></span>
<span id="cb86-6"><a href="within-partner-sam.html#cb86-6" aria-hidden="true" tabindex="-1"></a>idf<span class="ot">&lt;-</span>pair_df<span class="sc">$</span>ID_f <span class="co">#female ID</span></span>
<span id="cb86-7"><a href="within-partner-sam.html#cb86-7" aria-hidden="true" tabindex="-1"></a>idf<span class="ot">&lt;-</span>idf <span class="sc">-</span> Im <span class="co">#within female vector</span></span>
<span id="cb86-8"><a href="within-partner-sam.html#cb86-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-9"><a href="within-partner-sam.html#cb86-9" aria-hidden="true" tabindex="-1"></a><span class="co">#data prep for Stan</span></span>
<span id="cb86-10"><a href="within-partner-sam.html#cb86-10" aria-hidden="true" tabindex="-1"></a>stan_data <span class="ot">&lt;-</span></span>
<span id="cb86-11"><a href="within-partner-sam.html#cb86-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">list</span>(<span class="at">N_sex =</span> N_sex, <span class="at">I =</span> I, <span class="at">Im=</span>Im, <span class="at">If =</span> If, <span class="at">idm =</span> idm, <span class="at">idf =</span> idf,</span>
<span id="cb86-12"><a href="within-partner-sam.html#cb86-12" aria-hidden="true" tabindex="-1"></a>         <span class="at">AG_m =</span> pair_df<span class="sc">$</span>AG_m, <span class="at">AG_f =</span> pair_df<span class="sc">$</span>AG_f, <span class="at">time =</span> pair_df<span class="sc">$</span>turn, <span class="at">A =</span> A_mat)</span></code></pre></div>
</div>
</div>
<div id="coding-the-model" class="section level2" number="2.4">
<h2><span class="header-section-number">2.4</span> Coding the model</h2>
<p>We’re now prepared to code up our formal model in Stan. The basic structure builds on the animal model presented in Chapter 1 ((<a href="using-stan-in-r.html#animal-models">1.5</a>)) with some small changes in labels, so we only direct attention toward new features of the social animal model code. Firstly, we need to declare the new data we’re passing into the model</p>
<pre class="stan"><code>data {
  
  //indices and scalars used for model specification
  int&lt;lower=1&gt; N_sex; //total aggression observations per sex (I/2 * 2 repeated measures)
  int&lt;lower=0&gt; I; //total individuals (M + F)
  int&lt;lower=0&gt; Im; //number of males
  int&lt;lower=0&gt; If; //number of females
  int&lt;lower=1&gt; idm[N_sex]; //index of male AG observations (of length N_sex)
  int&lt;lower=1&gt; idf[N_sex]; //index of female AG observations

  //empirical data
  matrix[I,I] A; //relatedness matrix
  real AG_m[N_sex]; //male aggression measurements
  real AG_f[N_sex]; //female aggression measurements
  real time[N_sex]; //time index (1,2 per individual)
}

transformed data{
  matrix[I,I] LA = cholesky_decompose(A); //lower-triangle A matrix
}</code></pre>
<p>Then we adjust the parameters and transformed parameters. For the parameters, all we need to do is change the population regression coefficient <span class="math inline">\(\beta_1\)</span> to the population interaction coefficient <span class="math inline">\(\psi_1\)</span> and add a new residual feedback coefficient <span class="math inline">\(\phi\)</span>. To facilitate identification, we set <span class="math inline">\(-1 &lt;\phi &lt; 1\)</span>. Note that for efficiency we’ve dropped the previous <code>cor</code> labels from the lower Cholesky correlation matrices. The transformed parameters can otherwise be left as they previously were. Note that separate (co)variances could instead be estimated here for males and females here by declaring duplicate objects with sex-specific labels (and appropriately scaled relatedness matrices).</p>
<pre class="stan"><code>parameters {
  //population effects
  real alpha_0; //aggression global intercept
  real psi_1; //expected interaction coefficient
  real&lt;lower=-1,upper=1&gt; phi; //(-1,1) ensures unique solution
  
  //random effects (standard deviations)
  vector&lt;lower=0, upper = 1&gt;[2] sd_P; //phenotypic SRN mu &amp; psi SDs
  vector&lt;lower=0, upper = 1&gt;[2] sd_R; //male &amp; female residual SDs

  cholesky_factor_corr[2] LG; //genetic SRN correlations
  cholesky_factor_corr[2] LE; //permanent environmental SRN correlations
  cholesky_factor_corr[2] LR; //sex-specific residual correlations
  
  matrix[I,2] std_devG; //individual-level unscaled G SRN deviations
  matrix[I,2] std_devE; //individual-level unscaled E SRN deviations
  
  //SRN heritability parmameters, i.e. Var(G_RN) / Var(P_RN) 
  //see supplementary appendix SI for further explanation of this parameter
  vector&lt;lower=0,upper=1&gt;[2] SRN_h2;
}

transformed parameters {
  vector&lt;lower=0&gt;[2] sd_G; //SDs of G effects (derived from sd_P)
  vector&lt;lower=0&gt;[2] sd_E; //SDs of E effects (derived from sd_P)
  
  matrix[I,2] SRN_P; //scaled P SRN parameter deviations
  matrix[I,2] SRN_G; //scaled G SRN parameter deviations
  matrix[I,2] SRN_E; //scaled E SRN parameter deviations

  //standard deviations of genetic effects
  //simplified from sqrt ( total RN phenotype variance * h2 )
  sd_G[1] = sd_P[1] * sqrt(SRN_h2[1]); //genetic SD for RN intercepts 
  sd_G[2] = sd_P[2] * sqrt(SRN_h2[2]);  //genetic SD for RN slopes
  
  //standard deviations of environmental effects (total phenotype SD * proportion environment SD)
  sd_E[1] = sd_P[1] * sqrt(1 - SRN_h2[1]); //environment SD for RN intercepts 
  sd_E[2] = sd_P[2] * sqrt(1 - SRN_h2[2]); //environment SD for RN slopes 
  
  //matrix normal parameterization of Kronecker product between G and A
  SRN_G =  LA * std_devG  * diag_pre_multiply(sd_G, LG)&#39; ; 
  
  //non-centered parameterization of permanent environmental effects
  SRN_E = std_devE * diag_pre_multiply(sd_E, LE)&#39;;
  
  //phenotypic RN effects (P = G + E); here G = additive genetic effects
  SRN_P = SRN_G + SRN_E;
}</code></pre>
<p>We could separate the male and female SRN parameters in the transformed parameters block and save them along with the other estimated parameters, but this would be redundant. Instead, we aid coding by creating temporary sex-specific vectors in the model block. We also create temporary vectors for defining the time-specific SRN trait values and residuals. As noted above, we declare the residual vectors explicitly in the model, rather than using a standard generative distribution, because we need to flexibly specify the time-lagged associations among focal and social partner residuals.</p>
<pre class="stan"><code>model{
  //separate male and female vectors for efficiency
  matrix[Im,2] SRN_Pm = SRN_P[1:Im]; //male SRN phenotypic deviations
  matrix[If,2] SRN_Pf = SRN_P[(Im+1):I]; //female SRN phenotypic deviations
  
  //separate SRN intercepts and slopes (phenotypic deviations)
  vector[Im] mu_m = col(SRN_Pm,1); //SRN intercepts
  vector[If] mu_f = col(SRN_Pf,1); 
  vector[Im] psi_m = col(SRN_Pm,2); //SRN slopes
  vector[If] psi_f = col(SRN_Pf,2); 

  //initialize vectors for constructing individual-centered linear predictors
  vector[N_sex] eta_m; //male SRN trait value 
  vector[N_sex] eta_f; //female SRN trait value
  vector[N_sex] linpred_m; //total expected value for male responses
  vector[N_sex] linpred_f; //total expected value for female responses
  vector[N_sex] epsilon_m; //residual for male responses
  vector[N_sex] epsilon_f; //residual for female responses
//...
</code></pre>
<p>We can now use a conditional statement in Stan to first calculate the SRN trait values <span class="math inline">\(\boldsymbol{\eta}\)</span> and <span class="math inline">\(\boldsymbol{\eta}&#39;\)</span>. Here we use the previously created indices of IDs and time stamps to ensure that each observation is appropriately matched between focal individual and social partners.</p>
<pre class="stan"><code>//Male and female aggression response model
for (n in 1:N_sex) {

//SRN trait values
  //assumes that n = 1 in the context of an ongoing social interaction
  //if n = 1 prior to social context, then specify eta[t=1] = mu_j instead
  if (time[n]==1)
      {
        //male eta[t=1] = mu_j + (psi + psi_j)*(mu_k)
        eta_m[n] = mu_m[idm[n]] +  (psi_1 + psi_m[idm[n]])*(mu_f[idf[n]]) ;
        
        //female eta[t=1] = mu_k + (psi + psi_k)*(mu_j)
        eta_f[n] = mu_f[idf[n]] +   (psi_1 + psi_f[idf[n]])*(mu_m[idm[n]]);
      }    
    else
      {
        //male eta[t=2] = mu_j + (psi + psi_j)*(eta_k[t=1])
        eta_m[n] = mu_m[idm[n]] +   (psi_1 + psi_m[idm[n]])*(eta_Wf[n-1]);
        
        //female eta[t=2] = mu_k + (psi + psi_k)*(eta_j[t=1])
        eta_f[n] = mu_f[idf[n]] +   (psi_1 + psi_f[idf[n]])*(eta_Wm[n-1]);
      }
//...</code></pre>
<p>The global intercept <span class="math inline">\(\mu_0\)</span> and any other fixed or random effects of interest can then be added along with the SRN trait value subject to feedback.</p>
<pre class="stan"><code>//add global intercept and between-individual parameters to linear predictor
  //other fixed effects can also be added here
   linpred_m[n] = alpha_0 + eta_m[n];
   linpred_f[n] = alpha_0 + eta_f[n];
//...</code></pre>
<p>With these values in place, the initial residual value for each male and female partner at time <span class="math inline">\(t=1\)</span> can be calculated and subsequently used to estimate residual feedback at <span class="math inline">\(t=2\)</span>, as well as to specify any remaining correlation between the focal and partner residual trait values. The parameter priors are also placed below to finish off the model block.</p>
<pre class="stan"><code>//residual trait values
    if(time[n]==1)
      {
        epsilon_m [n] = AG_m[n] - linpred_m[n];
        epsilon_f [n] = AG_f[n] - linpred_f[n];
      }
    else
      {
       linpred_m[n] = linpred_m[n] + phi * epsilon_f[n-1];
       epsilon_m[n] = AG_m[n] - linpred_m[n]; 
       
       linpred_f[n] = linpred_f[n] + phi * epsilon_m[n-1];
       epsilon_f[n] = AG_f[n] - linpred_f[n]; 
      }
  
//correlated residuals between partners
   [epsilon_m[n],epsilon_f[n]]&#39; ~ multi_normal_cholesky([0,0], diag_pre_multiply(sd_R, LR));
} //end of for (n in 1:N_sex)

//model priors

  //fixed effects
  alpha_0 ~ std_normal();
  psi_1 ~ std_normal();
  phi ~ std_normal();
  
  //random effects
  to_vector(sd_P) ~ cauchy(0,1);
  to_vector(sd_R) ~ cauchy(0,1);
  
  LG ~ lkj_corr_cholesky(2);
  LE ~ lkj_corr_cholesky(2);
  LR ~ lkj_corr_cholesky(2);
  
  to_vector(std_devG) ~ std_normal();
  to_vector(std_devE) ~ std_normal();
  
  //reaction norm heritability
  to_vector(SRN_h2) ~ beta(1.2,1.2);
}</code></pre>
<p>Things can be finished off by declaring the relevant generated quantities.</p>
<pre class="stan"><code>generated quantities{
//cor and cov matrices of SRN parameters and residuals
matrix[2,2] Gcor = LG * LG&#39;; //G SRN correlation matric
matrix[2,2] Ecor = LE * LE&#39;; //E SRN correlation matric
matrix[2,2] Rcor = LR * LR&#39;; //residual correlation matrix

matrix[2,2] Rcov = diag_matrix(sd_R)*Rcor*diag_matrix(sd_R); //residual covariance
matrix[2,2] Gcov = diag_matrix(sd_G)*Gcor*diag_matrix(sd_G); //G SRN covariance
matrix[2,2] Ecov = diag_matrix(sd_E)*Ecor*diag_matrix(sd_E); //E SRN covariance
matrix[2,2] Pcov = Gcov + Ecov; //P SRN covariance
matrix[2,2] Pcor = inverse(diag_matrix(sd_P))*Pcov*inverse(diag_matrix(sd_P)); //P SRN correlation

//variances
vector&lt;lower=0&gt;[2] V_P = sd_P .* sd_P;
vector&lt;lower=0&gt;[2] V_G = sd_G .* sd_G;
vector&lt;lower=0&gt;[2] V_E = sd_E .* sd_E;
vector&lt;lower=0&gt;[2] V_R = sd_R .* sd_R;
}</code></pre>
<p>Putting everything together now.</p>
<div class="sourceCode" id="cb94"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb94-1"><a href="within-partner-sam.html#cb94-1" aria-hidden="true" tabindex="-1"></a><span class="fu">write</span>(<span class="st">&quot;</span></span>
<span id="cb94-2"><a href="within-partner-sam.html#cb94-2" aria-hidden="true" tabindex="-1"></a><span class="st">data {</span></span>
<span id="cb94-3"><a href="within-partner-sam.html#cb94-3" aria-hidden="true" tabindex="-1"></a><span class="st">  </span></span>
<span id="cb94-4"><a href="within-partner-sam.html#cb94-4" aria-hidden="true" tabindex="-1"></a><span class="st">  //indices and scalars used for model specification</span></span>
<span id="cb94-5"><a href="within-partner-sam.html#cb94-5" aria-hidden="true" tabindex="-1"></a><span class="st">  int&lt;lower=1&gt; N_sex; //total aggression observations per sex (I/2 * 2 repeated measures)</span></span>
<span id="cb94-6"><a href="within-partner-sam.html#cb94-6" aria-hidden="true" tabindex="-1"></a><span class="st">  int&lt;lower=0&gt; I; //total individuals (M + F)</span></span>
<span id="cb94-7"><a href="within-partner-sam.html#cb94-7" aria-hidden="true" tabindex="-1"></a><span class="st">  int&lt;lower=0&gt; Im; //number of males</span></span>
<span id="cb94-8"><a href="within-partner-sam.html#cb94-8" aria-hidden="true" tabindex="-1"></a><span class="st">  int&lt;lower=0&gt; If; //number of females</span></span>
<span id="cb94-9"><a href="within-partner-sam.html#cb94-9" aria-hidden="true" tabindex="-1"></a><span class="st">  int&lt;lower=1&gt; idm[N_sex]; //index of male AG observations (of length N_sex)</span></span>
<span id="cb94-10"><a href="within-partner-sam.html#cb94-10" aria-hidden="true" tabindex="-1"></a><span class="st">  int&lt;lower=1&gt; idf[N_sex]; //index of female AG observations</span></span>
<span id="cb94-11"><a href="within-partner-sam.html#cb94-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb94-12"><a href="within-partner-sam.html#cb94-12" aria-hidden="true" tabindex="-1"></a><span class="st">  //empirical data</span></span>
<span id="cb94-13"><a href="within-partner-sam.html#cb94-13" aria-hidden="true" tabindex="-1"></a><span class="st">  matrix[I,I] A; //relatedness matrix</span></span>
<span id="cb94-14"><a href="within-partner-sam.html#cb94-14" aria-hidden="true" tabindex="-1"></a><span class="st">  real AG_m[N_sex]; //male aggression measurements</span></span>
<span id="cb94-15"><a href="within-partner-sam.html#cb94-15" aria-hidden="true" tabindex="-1"></a><span class="st">  real AG_f[N_sex]; //female aggression measurements</span></span>
<span id="cb94-16"><a href="within-partner-sam.html#cb94-16" aria-hidden="true" tabindex="-1"></a><span class="st">  real time[N_sex]; //time index (1,2 per individual)</span></span>
<span id="cb94-17"><a href="within-partner-sam.html#cb94-17" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb94-18"><a href="within-partner-sam.html#cb94-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb94-19"><a href="within-partner-sam.html#cb94-19" aria-hidden="true" tabindex="-1"></a><span class="st">transformed data{</span></span>
<span id="cb94-20"><a href="within-partner-sam.html#cb94-20" aria-hidden="true" tabindex="-1"></a><span class="st">  matrix[I,I] LA = cholesky_decompose(A); //lower-triangle A matrix</span></span>
<span id="cb94-21"><a href="within-partner-sam.html#cb94-21" aria-hidden="true" tabindex="-1"></a><span class="st">  </span></span>
<span id="cb94-22"><a href="within-partner-sam.html#cb94-22" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb94-23"><a href="within-partner-sam.html#cb94-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb94-24"><a href="within-partner-sam.html#cb94-24" aria-hidden="true" tabindex="-1"></a><span class="st">parameters {</span></span>
<span id="cb94-25"><a href="within-partner-sam.html#cb94-25" aria-hidden="true" tabindex="-1"></a><span class="st">  //population effects</span></span>
<span id="cb94-26"><a href="within-partner-sam.html#cb94-26" aria-hidden="true" tabindex="-1"></a><span class="st">  real alpha_0; //aggression global intercept</span></span>
<span id="cb94-27"><a href="within-partner-sam.html#cb94-27" aria-hidden="true" tabindex="-1"></a><span class="st">  real psi_1; //expected interaction coefficient</span></span>
<span id="cb94-28"><a href="within-partner-sam.html#cb94-28" aria-hidden="true" tabindex="-1"></a><span class="st">  real&lt;lower=-1,upper=1&gt; phi; //(-1,1) ensures unique solution</span></span>
<span id="cb94-29"><a href="within-partner-sam.html#cb94-29" aria-hidden="true" tabindex="-1"></a><span class="st">  </span></span>
<span id="cb94-30"><a href="within-partner-sam.html#cb94-30" aria-hidden="true" tabindex="-1"></a><span class="st">  //random effects (standard deviations)</span></span>
<span id="cb94-31"><a href="within-partner-sam.html#cb94-31" aria-hidden="true" tabindex="-1"></a><span class="st">  vector&lt;lower=0, upper = 1&gt;[2] sd_P; //phenotypic SRN mu &amp; psi SDs</span></span>
<span id="cb94-32"><a href="within-partner-sam.html#cb94-32" aria-hidden="true" tabindex="-1"></a><span class="st">  vector&lt;lower=0, upper = 1&gt;[2] sd_R; //male &amp; female residual SDs</span></span>
<span id="cb94-33"><a href="within-partner-sam.html#cb94-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb94-34"><a href="within-partner-sam.html#cb94-34" aria-hidden="true" tabindex="-1"></a><span class="st">  cholesky_factor_corr[2] LG; //genetic SRN correlations</span></span>
<span id="cb94-35"><a href="within-partner-sam.html#cb94-35" aria-hidden="true" tabindex="-1"></a><span class="st">  cholesky_factor_corr[2] LE; //permanent environmental SRN correlations</span></span>
<span id="cb94-36"><a href="within-partner-sam.html#cb94-36" aria-hidden="true" tabindex="-1"></a><span class="st">  cholesky_factor_corr[2] LR; //sex-specific residual correlations</span></span>
<span id="cb94-37"><a href="within-partner-sam.html#cb94-37" aria-hidden="true" tabindex="-1"></a><span class="st">  </span></span>
<span id="cb94-38"><a href="within-partner-sam.html#cb94-38" aria-hidden="true" tabindex="-1"></a><span class="st">  matrix[I,2] std_devG; //individual-level unscaled G SRN deviations</span></span>
<span id="cb94-39"><a href="within-partner-sam.html#cb94-39" aria-hidden="true" tabindex="-1"></a><span class="st">  matrix[I,2] std_devE; //individual-level unscaled E SRN deviations</span></span>
<span id="cb94-40"><a href="within-partner-sam.html#cb94-40" aria-hidden="true" tabindex="-1"></a><span class="st">  </span></span>
<span id="cb94-41"><a href="within-partner-sam.html#cb94-41" aria-hidden="true" tabindex="-1"></a><span class="st">  //SRN heritability parmameters, i.e. Var(G_RN) / Var(P_RN) </span></span>
<span id="cb94-42"><a href="within-partner-sam.html#cb94-42" aria-hidden="true" tabindex="-1"></a><span class="st">  //see supplementary appendix SI for further explanation of this parameter</span></span>
<span id="cb94-43"><a href="within-partner-sam.html#cb94-43" aria-hidden="true" tabindex="-1"></a><span class="st">  vector&lt;lower=0,upper=1&gt;[2] SRN_h2;</span></span>
<span id="cb94-44"><a href="within-partner-sam.html#cb94-44" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb94-45"><a href="within-partner-sam.html#cb94-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb94-46"><a href="within-partner-sam.html#cb94-46" aria-hidden="true" tabindex="-1"></a><span class="st">transformed parameters {</span></span>
<span id="cb94-47"><a href="within-partner-sam.html#cb94-47" aria-hidden="true" tabindex="-1"></a><span class="st">  vector&lt;lower=0&gt;[2] sd_G; //SDs of G effects (derived from sd_P)</span></span>
<span id="cb94-48"><a href="within-partner-sam.html#cb94-48" aria-hidden="true" tabindex="-1"></a><span class="st">  vector&lt;lower=0&gt;[2] sd_E; //SDs of E effects (derived from sd_P)</span></span>
<span id="cb94-49"><a href="within-partner-sam.html#cb94-49" aria-hidden="true" tabindex="-1"></a><span class="st">  </span></span>
<span id="cb94-50"><a href="within-partner-sam.html#cb94-50" aria-hidden="true" tabindex="-1"></a><span class="st">  matrix[I,2] SRN_P; //scaled P SRN parameter deviations</span></span>
<span id="cb94-51"><a href="within-partner-sam.html#cb94-51" aria-hidden="true" tabindex="-1"></a><span class="st">  matrix[I,2] SRN_G; //scaled G SRN parameter deviations</span></span>
<span id="cb94-52"><a href="within-partner-sam.html#cb94-52" aria-hidden="true" tabindex="-1"></a><span class="st">  matrix[I,2] SRN_E; //scaled E SRN parameter deviations</span></span>
<span id="cb94-53"><a href="within-partner-sam.html#cb94-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb94-54"><a href="within-partner-sam.html#cb94-54" aria-hidden="true" tabindex="-1"></a><span class="st">  //standard deviations of genetic effects</span></span>
<span id="cb94-55"><a href="within-partner-sam.html#cb94-55" aria-hidden="true" tabindex="-1"></a><span class="st">  //simplified from sqrt ( total RN phenotype variance * h2 )</span></span>
<span id="cb94-56"><a href="within-partner-sam.html#cb94-56" aria-hidden="true" tabindex="-1"></a><span class="st">  sd_G[1] = sd_P[1] * sqrt(SRN_h2[1]); //genetic SD for RN intercepts </span></span>
<span id="cb94-57"><a href="within-partner-sam.html#cb94-57" aria-hidden="true" tabindex="-1"></a><span class="st">  sd_G[2] = sd_P[2] * sqrt(SRN_h2[2]);  //genetic SD for RN slopes</span></span>
<span id="cb94-58"><a href="within-partner-sam.html#cb94-58" aria-hidden="true" tabindex="-1"></a><span class="st">  </span></span>
<span id="cb94-59"><a href="within-partner-sam.html#cb94-59" aria-hidden="true" tabindex="-1"></a><span class="st">  //standard deviations of environmental effects (total phenotype SD * proportion environment SD)</span></span>
<span id="cb94-60"><a href="within-partner-sam.html#cb94-60" aria-hidden="true" tabindex="-1"></a><span class="st">  sd_E[1] = sd_P[1] * sqrt(1 - SRN_h2[1]); //environment SD for RN intercepts </span></span>
<span id="cb94-61"><a href="within-partner-sam.html#cb94-61" aria-hidden="true" tabindex="-1"></a><span class="st">  sd_E[2] = sd_P[2] * sqrt(1 - SRN_h2[2]); //environment SD for RN slopes </span></span>
<span id="cb94-62"><a href="within-partner-sam.html#cb94-62" aria-hidden="true" tabindex="-1"></a><span class="st">  </span></span>
<span id="cb94-63"><a href="within-partner-sam.html#cb94-63" aria-hidden="true" tabindex="-1"></a><span class="st">  //matrix normal parameterization of Kronecker product between G and A</span></span>
<span id="cb94-64"><a href="within-partner-sam.html#cb94-64" aria-hidden="true" tabindex="-1"></a><span class="st">  SRN_G =  LA * std_devG  * diag_pre_multiply(sd_G, LG)&#39; ; </span></span>
<span id="cb94-65"><a href="within-partner-sam.html#cb94-65" aria-hidden="true" tabindex="-1"></a><span class="st">  </span></span>
<span id="cb94-66"><a href="within-partner-sam.html#cb94-66" aria-hidden="true" tabindex="-1"></a><span class="st">  //non-centered parameterization of permanent environmental effects</span></span>
<span id="cb94-67"><a href="within-partner-sam.html#cb94-67" aria-hidden="true" tabindex="-1"></a><span class="st">  SRN_E = std_devE * diag_pre_multiply(sd_E, LE)&#39;;</span></span>
<span id="cb94-68"><a href="within-partner-sam.html#cb94-68" aria-hidden="true" tabindex="-1"></a><span class="st">  </span></span>
<span id="cb94-69"><a href="within-partner-sam.html#cb94-69" aria-hidden="true" tabindex="-1"></a><span class="st">  //phenotypic RN effects (P = G + E); here G = additive genetic effects</span></span>
<span id="cb94-70"><a href="within-partner-sam.html#cb94-70" aria-hidden="true" tabindex="-1"></a><span class="st">  SRN_P = SRN_G + SRN_E;</span></span>
<span id="cb94-71"><a href="within-partner-sam.html#cb94-71" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb94-72"><a href="within-partner-sam.html#cb94-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb94-73"><a href="within-partner-sam.html#cb94-73" aria-hidden="true" tabindex="-1"></a><span class="st">model{</span></span>
<span id="cb94-74"><a href="within-partner-sam.html#cb94-74" aria-hidden="true" tabindex="-1"></a><span class="st">  //separate male and female vectors for efficiency</span></span>
<span id="cb94-75"><a href="within-partner-sam.html#cb94-75" aria-hidden="true" tabindex="-1"></a><span class="st">  matrix[Im,2] SRN_Pm = SRN_P[1:Im]; //male SRN phenotypic deviations</span></span>
<span id="cb94-76"><a href="within-partner-sam.html#cb94-76" aria-hidden="true" tabindex="-1"></a><span class="st">  matrix[If,2] SRN_Pf = SRN_P[(Im+1):I]; //female SRN phenotypic deviations</span></span>
<span id="cb94-77"><a href="within-partner-sam.html#cb94-77" aria-hidden="true" tabindex="-1"></a><span class="st">  </span></span>
<span id="cb94-78"><a href="within-partner-sam.html#cb94-78" aria-hidden="true" tabindex="-1"></a><span class="st">  //separate SRN intercepts and slopes (phenotypic deviations)</span></span>
<span id="cb94-79"><a href="within-partner-sam.html#cb94-79" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[Im] mu_m = col(SRN_Pm,1); //SRN intercepts</span></span>
<span id="cb94-80"><a href="within-partner-sam.html#cb94-80" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[If] mu_f = col(SRN_Pf,1); </span></span>
<span id="cb94-81"><a href="within-partner-sam.html#cb94-81" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[Im] psi_m = col(SRN_Pm,2); //SRN slopes</span></span>
<span id="cb94-82"><a href="within-partner-sam.html#cb94-82" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[If] psi_f = col(SRN_Pf,2); </span></span>
<span id="cb94-83"><a href="within-partner-sam.html#cb94-83" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb94-84"><a href="within-partner-sam.html#cb94-84" aria-hidden="true" tabindex="-1"></a><span class="st">  //initialize vectors for constructing individual-centered linear predictors</span></span>
<span id="cb94-85"><a href="within-partner-sam.html#cb94-85" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[N_sex] eta_m; //male SRN trait value </span></span>
<span id="cb94-86"><a href="within-partner-sam.html#cb94-86" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[N_sex] eta_f; //female SRN trait value</span></span>
<span id="cb94-87"><a href="within-partner-sam.html#cb94-87" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[N_sex] linpred_m; //total expected value for male responses</span></span>
<span id="cb94-88"><a href="within-partner-sam.html#cb94-88" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[N_sex] linpred_f; //total expected value for female responses</span></span>
<span id="cb94-89"><a href="within-partner-sam.html#cb94-89" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[N_sex] epsilon_m; //residual for male responses</span></span>
<span id="cb94-90"><a href="within-partner-sam.html#cb94-90" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[N_sex] epsilon_f; //residual for female responses</span></span>
<span id="cb94-91"><a href="within-partner-sam.html#cb94-91" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb94-92"><a href="within-partner-sam.html#cb94-92" aria-hidden="true" tabindex="-1"></a><span class="st">  //Male and female aggression response model</span></span>
<span id="cb94-93"><a href="within-partner-sam.html#cb94-93" aria-hidden="true" tabindex="-1"></a><span class="st">  for (n in 1:N_sex) {</span></span>
<span id="cb94-94"><a href="within-partner-sam.html#cb94-94" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb94-95"><a href="within-partner-sam.html#cb94-95" aria-hidden="true" tabindex="-1"></a><span class="st">  //SRN trait values</span></span>
<span id="cb94-96"><a href="within-partner-sam.html#cb94-96" aria-hidden="true" tabindex="-1"></a><span class="st">  //assumes that n = 1 in the context of an ongoing social interaction</span></span>
<span id="cb94-97"><a href="within-partner-sam.html#cb94-97" aria-hidden="true" tabindex="-1"></a><span class="st">  //if n = 1 prior to social context, then specify eta[t=1] = mu_j instead</span></span>
<span id="cb94-98"><a href="within-partner-sam.html#cb94-98" aria-hidden="true" tabindex="-1"></a><span class="st">  if (time[n]==1)</span></span>
<span id="cb94-99"><a href="within-partner-sam.html#cb94-99" aria-hidden="true" tabindex="-1"></a><span class="st">      {</span></span>
<span id="cb94-100"><a href="within-partner-sam.html#cb94-100" aria-hidden="true" tabindex="-1"></a><span class="st">        //male eta[t=1] = mu_j + (psi + psi_j)*(mu_k)</span></span>
<span id="cb94-101"><a href="within-partner-sam.html#cb94-101" aria-hidden="true" tabindex="-1"></a><span class="st">        eta_m[n] = mu_m[idm[n]] +  (psi_1 + psi_m[idm[n]])*(mu_f[idf[n]]) ;</span></span>
<span id="cb94-102"><a href="within-partner-sam.html#cb94-102" aria-hidden="true" tabindex="-1"></a><span class="st">        </span></span>
<span id="cb94-103"><a href="within-partner-sam.html#cb94-103" aria-hidden="true" tabindex="-1"></a><span class="st">        //female eta[t=1] = mu_k + (psi + psi_k)*(mu_j)</span></span>
<span id="cb94-104"><a href="within-partner-sam.html#cb94-104" aria-hidden="true" tabindex="-1"></a><span class="st">        eta_f[n] = mu_f[idf[n]] +   (psi_1 + psi_f[idf[n]])*(mu_m[idm[n]]);</span></span>
<span id="cb94-105"><a href="within-partner-sam.html#cb94-105" aria-hidden="true" tabindex="-1"></a><span class="st">      }    </span></span>
<span id="cb94-106"><a href="within-partner-sam.html#cb94-106" aria-hidden="true" tabindex="-1"></a><span class="st">    else</span></span>
<span id="cb94-107"><a href="within-partner-sam.html#cb94-107" aria-hidden="true" tabindex="-1"></a><span class="st">      {</span></span>
<span id="cb94-108"><a href="within-partner-sam.html#cb94-108" aria-hidden="true" tabindex="-1"></a><span class="st">        //male eta[t=2] = mu_j + (psi + psi_j)*(eta_k[t=1])</span></span>
<span id="cb94-109"><a href="within-partner-sam.html#cb94-109" aria-hidden="true" tabindex="-1"></a><span class="st">        eta_m[n] = mu_m[idm[n]] +   (psi_1 + psi_m[idm[n]])*(eta_f[n-1]);</span></span>
<span id="cb94-110"><a href="within-partner-sam.html#cb94-110" aria-hidden="true" tabindex="-1"></a><span class="st">        </span></span>
<span id="cb94-111"><a href="within-partner-sam.html#cb94-111" aria-hidden="true" tabindex="-1"></a><span class="st">        //female eta[t=2] = mu_k + (psi + psi_k)*(eta_j[t=1])</span></span>
<span id="cb94-112"><a href="within-partner-sam.html#cb94-112" aria-hidden="true" tabindex="-1"></a><span class="st">        eta_f[n] = mu_f[idf[n]] +   (psi_1 + psi_f[idf[n]])*(eta_m[n-1]);</span></span>
<span id="cb94-113"><a href="within-partner-sam.html#cb94-113" aria-hidden="true" tabindex="-1"></a><span class="st">      }</span></span>
<span id="cb94-114"><a href="within-partner-sam.html#cb94-114" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb94-115"><a href="within-partner-sam.html#cb94-115" aria-hidden="true" tabindex="-1"></a><span class="st">  //add global intercept and between-individual parameters to linear predictor</span></span>
<span id="cb94-116"><a href="within-partner-sam.html#cb94-116" aria-hidden="true" tabindex="-1"></a><span class="st">  //other fixed effects can also be added here</span></span>
<span id="cb94-117"><a href="within-partner-sam.html#cb94-117" aria-hidden="true" tabindex="-1"></a><span class="st">   linpred_m[n] = alpha_0 + eta_m[n];</span></span>
<span id="cb94-118"><a href="within-partner-sam.html#cb94-118" aria-hidden="true" tabindex="-1"></a><span class="st">   linpred_f[n] = alpha_0 + eta_f[n];</span></span>
<span id="cb94-119"><a href="within-partner-sam.html#cb94-119" aria-hidden="true" tabindex="-1"></a><span class="st">   </span></span>
<span id="cb94-120"><a href="within-partner-sam.html#cb94-120" aria-hidden="true" tabindex="-1"></a><span class="st">  //residual trait values</span></span>
<span id="cb94-121"><a href="within-partner-sam.html#cb94-121" aria-hidden="true" tabindex="-1"></a><span class="st">    if(time[n]==1)</span></span>
<span id="cb94-122"><a href="within-partner-sam.html#cb94-122" aria-hidden="true" tabindex="-1"></a><span class="st">      {</span></span>
<span id="cb94-123"><a href="within-partner-sam.html#cb94-123" aria-hidden="true" tabindex="-1"></a><span class="st">        epsilon_m [n] = AG_m[n] - linpred_m[n];</span></span>
<span id="cb94-124"><a href="within-partner-sam.html#cb94-124" aria-hidden="true" tabindex="-1"></a><span class="st">        epsilon_f [n] = AG_f[n] - linpred_f[n];</span></span>
<span id="cb94-125"><a href="within-partner-sam.html#cb94-125" aria-hidden="true" tabindex="-1"></a><span class="st">      }</span></span>
<span id="cb94-126"><a href="within-partner-sam.html#cb94-126" aria-hidden="true" tabindex="-1"></a><span class="st">    else</span></span>
<span id="cb94-127"><a href="within-partner-sam.html#cb94-127" aria-hidden="true" tabindex="-1"></a><span class="st">      {</span></span>
<span id="cb94-128"><a href="within-partner-sam.html#cb94-128" aria-hidden="true" tabindex="-1"></a><span class="st">       linpred_m[n] = linpred_m[n] + phi * epsilon_f[n-1];</span></span>
<span id="cb94-129"><a href="within-partner-sam.html#cb94-129" aria-hidden="true" tabindex="-1"></a><span class="st">       epsilon_m[n] = AG_m[n] - linpred_m[n]; </span></span>
<span id="cb94-130"><a href="within-partner-sam.html#cb94-130" aria-hidden="true" tabindex="-1"></a><span class="st">       </span></span>
<span id="cb94-131"><a href="within-partner-sam.html#cb94-131" aria-hidden="true" tabindex="-1"></a><span class="st">       linpred_f[n] = linpred_f[n] + phi * epsilon_m[n-1];</span></span>
<span id="cb94-132"><a href="within-partner-sam.html#cb94-132" aria-hidden="true" tabindex="-1"></a><span class="st">       epsilon_f[n] = AG_f[n] - linpred_f[n]; </span></span>
<span id="cb94-133"><a href="within-partner-sam.html#cb94-133" aria-hidden="true" tabindex="-1"></a><span class="st">      }</span></span>
<span id="cb94-134"><a href="within-partner-sam.html#cb94-134" aria-hidden="true" tabindex="-1"></a><span class="st">  </span></span>
<span id="cb94-135"><a href="within-partner-sam.html#cb94-135" aria-hidden="true" tabindex="-1"></a><span class="st">  //correlated residuals between partners</span></span>
<span id="cb94-136"><a href="within-partner-sam.html#cb94-136" aria-hidden="true" tabindex="-1"></a><span class="st">   [epsilon_m[n],epsilon_f[n]]&#39; ~ multi_normal_cholesky([0,0], diag_pre_multiply(sd_R, LR));</span></span>
<span id="cb94-137"><a href="within-partner-sam.html#cb94-137" aria-hidden="true" tabindex="-1"></a><span class="st">  }</span></span>
<span id="cb94-138"><a href="within-partner-sam.html#cb94-138" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb94-139"><a href="within-partner-sam.html#cb94-139" aria-hidden="true" tabindex="-1"></a><span class="st">//model priors</span></span>
<span id="cb94-140"><a href="within-partner-sam.html#cb94-140" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb94-141"><a href="within-partner-sam.html#cb94-141" aria-hidden="true" tabindex="-1"></a><span class="st">  //fixed effects</span></span>
<span id="cb94-142"><a href="within-partner-sam.html#cb94-142" aria-hidden="true" tabindex="-1"></a><span class="st">  alpha_0 ~ std_normal();</span></span>
<span id="cb94-143"><a href="within-partner-sam.html#cb94-143" aria-hidden="true" tabindex="-1"></a><span class="st">  psi_1 ~ std_normal();</span></span>
<span id="cb94-144"><a href="within-partner-sam.html#cb94-144" aria-hidden="true" tabindex="-1"></a><span class="st">  phi ~ std_normal();</span></span>
<span id="cb94-145"><a href="within-partner-sam.html#cb94-145" aria-hidden="true" tabindex="-1"></a><span class="st">  </span></span>
<span id="cb94-146"><a href="within-partner-sam.html#cb94-146" aria-hidden="true" tabindex="-1"></a><span class="st">  //random effects</span></span>
<span id="cb94-147"><a href="within-partner-sam.html#cb94-147" aria-hidden="true" tabindex="-1"></a><span class="st">  to_vector(sd_P) ~ cauchy(0,1);</span></span>
<span id="cb94-148"><a href="within-partner-sam.html#cb94-148" aria-hidden="true" tabindex="-1"></a><span class="st">  to_vector(sd_R) ~ cauchy(0,1);</span></span>
<span id="cb94-149"><a href="within-partner-sam.html#cb94-149" aria-hidden="true" tabindex="-1"></a><span class="st">  </span></span>
<span id="cb94-150"><a href="within-partner-sam.html#cb94-150" aria-hidden="true" tabindex="-1"></a><span class="st">  LG ~ lkj_corr_cholesky(2);</span></span>
<span id="cb94-151"><a href="within-partner-sam.html#cb94-151" aria-hidden="true" tabindex="-1"></a><span class="st">  LE ~ lkj_corr_cholesky(2);</span></span>
<span id="cb94-152"><a href="within-partner-sam.html#cb94-152" aria-hidden="true" tabindex="-1"></a><span class="st">  LR ~ lkj_corr_cholesky(2);</span></span>
<span id="cb94-153"><a href="within-partner-sam.html#cb94-153" aria-hidden="true" tabindex="-1"></a><span class="st">  </span></span>
<span id="cb94-154"><a href="within-partner-sam.html#cb94-154" aria-hidden="true" tabindex="-1"></a><span class="st">  to_vector(std_devG) ~ std_normal();</span></span>
<span id="cb94-155"><a href="within-partner-sam.html#cb94-155" aria-hidden="true" tabindex="-1"></a><span class="st">  to_vector(std_devE) ~ std_normal();</span></span>
<span id="cb94-156"><a href="within-partner-sam.html#cb94-156" aria-hidden="true" tabindex="-1"></a><span class="st">  </span></span>
<span id="cb94-157"><a href="within-partner-sam.html#cb94-157" aria-hidden="true" tabindex="-1"></a><span class="st">  //reaction norm heritability</span></span>
<span id="cb94-158"><a href="within-partner-sam.html#cb94-158" aria-hidden="true" tabindex="-1"></a><span class="st">  to_vector(SRN_h2) ~ beta(1.2,1.2);</span></span>
<span id="cb94-159"><a href="within-partner-sam.html#cb94-159" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb94-160"><a href="within-partner-sam.html#cb94-160" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb94-161"><a href="within-partner-sam.html#cb94-161" aria-hidden="true" tabindex="-1"></a><span class="st">generated quantities{</span></span>
<span id="cb94-162"><a href="within-partner-sam.html#cb94-162" aria-hidden="true" tabindex="-1"></a><span class="st">//cor and cov matrices of SRN parameters and residuals</span></span>
<span id="cb94-163"><a href="within-partner-sam.html#cb94-163" aria-hidden="true" tabindex="-1"></a><span class="st">matrix[2,2] Gcor = LG * LG&#39;; //G SRN correlation matric</span></span>
<span id="cb94-164"><a href="within-partner-sam.html#cb94-164" aria-hidden="true" tabindex="-1"></a><span class="st">matrix[2,2] Ecor = LE * LE&#39;; //E SRN correlation matric</span></span>
<span id="cb94-165"><a href="within-partner-sam.html#cb94-165" aria-hidden="true" tabindex="-1"></a><span class="st">matrix[2,2] Rcor = LR * LR&#39;; //residual correlation matrix</span></span>
<span id="cb94-166"><a href="within-partner-sam.html#cb94-166" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb94-167"><a href="within-partner-sam.html#cb94-167" aria-hidden="true" tabindex="-1"></a><span class="st">matrix[2,2] Rcov = diag_matrix(sd_R)*Rcor*diag_matrix(sd_R); //residual covariance</span></span>
<span id="cb94-168"><a href="within-partner-sam.html#cb94-168" aria-hidden="true" tabindex="-1"></a><span class="st">matrix[2,2] Gcov = diag_matrix(sd_G)*Gcor*diag_matrix(sd_G); //G SRN covariance</span></span>
<span id="cb94-169"><a href="within-partner-sam.html#cb94-169" aria-hidden="true" tabindex="-1"></a><span class="st">matrix[2,2] Ecov = diag_matrix(sd_E)*Ecor*diag_matrix(sd_E); //E SRN covariance</span></span>
<span id="cb94-170"><a href="within-partner-sam.html#cb94-170" aria-hidden="true" tabindex="-1"></a><span class="st">matrix[2,2] Pcov = Gcov + Ecov; //P SRN covariance</span></span>
<span id="cb94-171"><a href="within-partner-sam.html#cb94-171" aria-hidden="true" tabindex="-1"></a><span class="st">matrix[2,2] Pcor = inverse(diag_matrix(sd_P))*Pcov*inverse(diag_matrix(sd_P)); //P SRN correlation</span></span>
<span id="cb94-172"><a href="within-partner-sam.html#cb94-172" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb94-173"><a href="within-partner-sam.html#cb94-173" aria-hidden="true" tabindex="-1"></a><span class="st">//variances</span></span>
<span id="cb94-174"><a href="within-partner-sam.html#cb94-174" aria-hidden="true" tabindex="-1"></a><span class="st">vector&lt;lower=0&gt;[2] V_P = sd_P .* sd_P;</span></span>
<span id="cb94-175"><a href="within-partner-sam.html#cb94-175" aria-hidden="true" tabindex="-1"></a><span class="st">vector&lt;lower=0&gt;[2] V_G = sd_G .* sd_G;</span></span>
<span id="cb94-176"><a href="within-partner-sam.html#cb94-176" aria-hidden="true" tabindex="-1"></a><span class="st">vector&lt;lower=0&gt;[2] V_E = sd_E .* sd_E;</span></span>
<span id="cb94-177"><a href="within-partner-sam.html#cb94-177" aria-hidden="true" tabindex="-1"></a><span class="st">vector&lt;lower=0&gt;[2] V_R = sd_R .* sd_R;</span></span>
<span id="cb94-178"><a href="within-partner-sam.html#cb94-178" aria-hidden="true" tabindex="-1"></a><span class="st">}&quot;</span>, <span class="st">&quot;sam3_1.stan&quot;</span>)</span></code></pre></div>
</div>
<div id="estimating-the-model" class="section level2" number="2.5">
<h2><span class="header-section-number">2.5</span> Estimating the model</h2>
<p>We can now use our simulated random sample to estimate the full quantitative genetic SAM, and we’ll run the the model for additional iterations to promote sufficient sampling of the individual-level parameters. A quick plot of the model results can give us an indication of whether the converse directions of the true SRN feedback (-0.5) and residual feedback (+0.5) processes are being appropriately estimated, as well the accuracy of recovering the total phenotypic variance (V = 0.6) and the genetic (r = 0.3), permanent environmental (r = 0.3), and residual (r = -0.3) correlations.</p>
<div class="sourceCode" id="cb95"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb95-1"><a href="within-partner-sam.html#cb95-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(rstan)</span>
<span id="cb95-2"><a href="within-partner-sam.html#cb95-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-3"><a href="within-partner-sam.html#cb95-3" aria-hidden="true" tabindex="-1"></a>sam_3<span class="fl">.1</span> <span class="ot">=</span> <span class="fu">stan_model</span>(<span class="st">&quot;sam3_1.stan&quot;</span>)</span></code></pre></div>
<pre><code>## Warning in system(paste(CXX, ARGS), ignore.stdout = TRUE, ignore.stderr = TRUE): &#39;C:/rtools40/usr/mingw_/bin/g++&#39; not found</code></pre>
<div class="sourceCode" id="cb97"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb97-1"><a href="within-partner-sam.html#cb97-1" aria-hidden="true" tabindex="-1"></a>stan_results3<span class="fl">.1</span> <span class="ot">&lt;-</span> <span class="fu">sampling</span>(sam_3<span class="fl">.1</span>, <span class="at">data=</span>stan_data, <span class="at">init =</span> <span class="dv">0</span>, <span class="at">warmup=</span><span class="dv">1500</span>, <span class="at">iter =</span> <span class="dv">6000</span>,</span>
<span id="cb97-2"><a href="within-partner-sam.html#cb97-2" aria-hidden="true" tabindex="-1"></a>                         <span class="at">chains=</span><span class="dv">4</span>, <span class="at">cores=</span><span class="dv">4</span>, <span class="at">control=</span><span class="fu">list</span>(<span class="at">adapt_delta=</span><span class="fl">0.90</span>) )</span>
<span id="cb97-3"><a href="within-partner-sam.html#cb97-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb97-4"><a href="within-partner-sam.html#cb97-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(bayesplot)</span></code></pre></div>
<pre><code>## This is bayesplot version 1.8.0</code></pre>
<pre><code>## - Online documentation and vignettes at mc-stan.org/bayesplot</code></pre>
<pre><code>## - bayesplot theme set to bayesplot::theme_default()</code></pre>
<pre><code>##    * Does _not_ affect other ggplot2 plots</code></pre>
<pre><code>##    * See ?bayesplot_theme_set for details on theme setting</code></pre>
<div class="sourceCode" id="cb103"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb103-1"><a href="within-partner-sam.html#cb103-1" aria-hidden="true" tabindex="-1"></a><span class="fu">mcmc_areas</span>(stan_results3<span class="fl">.1</span>, <span class="at">pars =</span> <span class="fu">c</span>( <span class="st">&quot;psi_1&quot;</span>, <span class="st">&quot;phi&quot;</span>, <span class="st">&quot;V_P[1]&quot;</span>, <span class="st">&quot;V_P[2]&quot;</span>, <span class="st">&quot;Gcor[2,1]&quot;</span>, <span class="st">&quot;Ecor[2,1]&quot;</span>, <span class="st">&quot;Rcor[2,1]&quot;</span>,  <span class="st">&quot;Pcor[2,1]&quot;</span> ), <span class="at">prob =</span> <span class="fl">0.9</span> )</span></code></pre></div>
<p><img src="SAMs_files/figure-html/unnamed-chunk-44-1.png" width="672" /></p>
<p>Despite the modest sample size for a quantitative genetic study, the SAM does a good job of detecting the opposing directional effects of SRN and residual feedback, as well as of residual and intrinsic trait value correlations. It is also noticeable that, despite the greater uncertainty in the genetic and permanent environmental correlations, the overall phenotypic variance is more precisely estimated. Thus, even when pedigrees are not sufficiently informative to confidently infer genetic effects, SAMs can still be used to estimate evolutionary parameters on phenotypes.</p>
</div>
<div id="failure-to-detect-assortment" class="section level2" number="2.6">
<h2><span class="header-section-number">2.6</span> Failure to detect assortment</h2>
<p>We can attempt to estimate the assortment coefficient matrix, following <strong>Eq. 4</strong> of <span class="citation"><a href="#ref-SAM" role="doc-biblioref">Martin and Jaeggi</a> (<a href="#ref-SAM" role="doc-biblioref">2021</a>)</span>, with posterior distributions for the assortment coefficients for SRN intercepts and slopes given by</p>
<p><span class="math display">\[ \beta_{\bar{\mu&#39;}\mu} = \Pr \left ( \frac{ \mathrm{cov}( \boldsymbol{\mu}, \boldsymbol{\bar{\mu}&#39;}) } {\mathrm{var}(\boldsymbol{\mu})} \mid \boldsymbol{z},  \boldsymbol{z&#39;},  \boldsymbol{\Theta}  \right ) \]</span>
<span class="math display">\[ \beta_{\bar{\psi&#39;}\psi} = \Pr \left ( \frac{ \mathrm{cov}( \boldsymbol{\psi}, \boldsymbol{\bar{\psi}&#39;}) } {\mathrm{var}(\boldsymbol{\psi})} \mid \boldsymbol{z},  \boldsymbol{z&#39;},  \boldsymbol{\Theta}  \right ) \]</span>
The posterior of the full assortment coefficient matrix is</p>
<p><span class="math display">\[\boldsymbol{ \mathrm{B}_{\alpha}} = \Pr \left (  \begin{bmatrix}  \beta_{\bar{\mu&#39;}\mu} &amp;  \beta_{\bar{\psi&#39;}\mu} \\  \beta_{\bar{\mu&#39;}\psi} &amp;  \beta_{\bar{\psi&#39;}\psi} \end{bmatrix}
\mid \boldsymbol{z},  \boldsymbol{z&#39;},  \boldsymbol{\Theta}  \right ) \]</span></p>
<p>We can manually calculate this posterior matrix by post-processing the MCMC samples from our model. In this case, we only need to organize the male and female responses together and calculate the appropriate (co)variances, as each individual has a single partner. We therefore arbitrarily treat males as focal individuals, as the coefficient is equivalent in this case for both sexes.</p>
<div class="sourceCode" id="cb104"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb104-1"><a href="within-partner-sam.html#cb104-1" aria-hidden="true" tabindex="-1"></a><span class="co">#extract posteriors</span></span>
<span id="cb104-2"><a href="within-partner-sam.html#cb104-2" aria-hidden="true" tabindex="-1"></a>post <span class="ot">&lt;-</span> rstan<span class="sc">::</span><span class="fu">extract</span>(stan_results3<span class="fl">.1</span>)</span>
<span id="cb104-3"><a href="within-partner-sam.html#cb104-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb104-4"><a href="within-partner-sam.html#cb104-4" aria-hidden="true" tabindex="-1"></a>SRN_focal1 <span class="ot">&lt;-</span> post<span class="sc">$</span>SRN_P[,(<span class="dv">1</span><span class="sc">:</span>Im),<span class="dv">1</span>] <span class="co">#male intercepts</span></span>
<span id="cb104-5"><a href="within-partner-sam.html#cb104-5" aria-hidden="true" tabindex="-1"></a>SRN_focal2 <span class="ot">&lt;-</span> post<span class="sc">$</span>SRN_P[,(<span class="dv">1</span><span class="sc">:</span>Im),<span class="dv">2</span>] <span class="co">#male slopes</span></span>
<span id="cb104-6"><a href="within-partner-sam.html#cb104-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb104-7"><a href="within-partner-sam.html#cb104-7" aria-hidden="true" tabindex="-1"></a>SRN_partner1 <span class="ot">&lt;-</span>  post<span class="sc">$</span>SRN_P[,(Im <span class="sc">+</span> <span class="fu">unique</span>(idf)),<span class="dv">1</span>] <span class="co">#female intercepts </span></span>
<span id="cb104-8"><a href="within-partner-sam.html#cb104-8" aria-hidden="true" tabindex="-1"></a>SRN_partner2 <span class="ot">&lt;-</span>  post<span class="sc">$</span>SRN_P[,(Im <span class="sc">+</span> <span class="fu">unique</span>(idf)),<span class="dv">2</span>] <span class="co">#female intercepts</span></span>
<span id="cb104-9"><a href="within-partner-sam.html#cb104-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb104-10"><a href="within-partner-sam.html#cb104-10" aria-hidden="true" tabindex="-1"></a><span class="co">#assortment matrix</span></span>
<span id="cb104-11"><a href="within-partner-sam.html#cb104-11" aria-hidden="true" tabindex="-1"></a>Beta_alpha <span class="ot">=</span> <span class="fu">list</span>()</span>
<span id="cb104-12"><a href="within-partner-sam.html#cb104-12" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb104-13"><a href="within-partner-sam.html#cb104-13" aria-hidden="true" tabindex="-1"></a><span class="co">#generate matrices across each posterior sample</span></span>
<span id="cb104-14"><a href="within-partner-sam.html#cb104-14" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(j <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(SRN_focal1))</span>
<span id="cb104-15"><a href="within-partner-sam.html#cb104-15" aria-hidden="true" tabindex="-1"></a>    {</span>
<span id="cb104-16"><a href="within-partner-sam.html#cb104-16" aria-hidden="true" tabindex="-1"></a>            Beta_mat <span class="ot">=</span> <span class="fu">matrix</span>(<span class="cn">NA</span>,<span class="dv">2</span>,<span class="dv">2</span>)</span>
<span id="cb104-17"><a href="within-partner-sam.html#cb104-17" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb104-18"><a href="within-partner-sam.html#cb104-18" aria-hidden="true" tabindex="-1"></a>            <span class="co">#mu&#39; ~ mu</span></span>
<span id="cb104-19"><a href="within-partner-sam.html#cb104-19" aria-hidden="true" tabindex="-1"></a>            Beta_mat[<span class="dv">1</span>,<span class="dv">1</span>] <span class="ot">=</span>  <span class="fu">cov</span>(SRN_focal1[j,], SRN_partner1[j,])<span class="sc">/</span><span class="fu">var</span>(SRN_focal1[j,])</span>
<span id="cb104-20"><a href="within-partner-sam.html#cb104-20" aria-hidden="true" tabindex="-1"></a>            <span class="co">#mu&#39; ~ psi</span></span>
<span id="cb104-21"><a href="within-partner-sam.html#cb104-21" aria-hidden="true" tabindex="-1"></a>            Beta_mat[<span class="dv">2</span>,<span class="dv">1</span>] <span class="ot">=</span>  <span class="fu">cov</span>(SRN_focal2[j,], SRN_partner1[j,])<span class="sc">/</span><span class="fu">var</span>(SRN_focal2[j,])</span>
<span id="cb104-22"><a href="within-partner-sam.html#cb104-22" aria-hidden="true" tabindex="-1"></a>            <span class="co">#psi&#39; ~ mu                                                        </span></span>
<span id="cb104-23"><a href="within-partner-sam.html#cb104-23" aria-hidden="true" tabindex="-1"></a>            Beta_mat[<span class="dv">1</span>,<span class="dv">2</span>] <span class="ot">=</span>  <span class="fu">cov</span>(SRN_focal1[j,], SRN_partner2[j,])<span class="sc">/</span><span class="fu">var</span>(SRN_focal1[j,])</span>
<span id="cb104-24"><a href="within-partner-sam.html#cb104-24" aria-hidden="true" tabindex="-1"></a>            <span class="co">#psi&#39; ~ psi</span></span>
<span id="cb104-25"><a href="within-partner-sam.html#cb104-25" aria-hidden="true" tabindex="-1"></a>            Beta_mat[<span class="dv">2</span>,<span class="dv">2</span>] <span class="ot">=</span>  <span class="fu">cov</span>(SRN_focal2[j,], SRN_partner2[j,])<span class="sc">/</span><span class="fu">var</span>(SRN_focal2[j,])</span>
<span id="cb104-26"><a href="within-partner-sam.html#cb104-26" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb104-27"><a href="within-partner-sam.html#cb104-27" aria-hidden="true" tabindex="-1"></a>            Beta_alpha[[j]] <span class="ot">=</span> Beta_mat</span>
<span id="cb104-28"><a href="within-partner-sam.html#cb104-28" aria-hidden="true" tabindex="-1"></a>    } </span>
<span id="cb104-29"><a href="within-partner-sam.html#cb104-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb104-30"><a href="within-partner-sam.html#cb104-30" aria-hidden="true" tabindex="-1"></a><span class="co">#extract beta_mu&#39;mu (assortment on RN intercepts)</span></span>
<span id="cb104-31"><a href="within-partner-sam.html#cb104-31" aria-hidden="true" tabindex="-1"></a>Beta_mu <span class="ot">=</span> <span class="fu">unlist</span>(<span class="fu">lapply</span>(Beta_alpha, <span class="cf">function</span>(x) x[<span class="dv">1</span>,<span class="dv">1</span>]))</span>
<span id="cb104-32"><a href="within-partner-sam.html#cb104-32" aria-hidden="true" tabindex="-1"></a><span class="fu">mean</span>(Beta_mu)</span></code></pre></div>
<pre><code>## [1] 0.06894314</code></pre>
<div class="sourceCode" id="cb106"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb106-1"><a href="within-partner-sam.html#cb106-1" aria-hidden="true" tabindex="-1"></a><span class="fu">hist</span>(Beta_mu)</span></code></pre></div>
<p><img src="SAMs_files/figure-html/unnamed-chunk-45-1.png" width="672" /></p>
<p>Perhaps surprisingly, we see that the model is not doing a good job of detecting the positive assortment between partners’ SRN intercepts (r = 0.3), instead centering the assortment coefficient on zero. Given our sample and effect size, it is unlikely that this would be caused by conservative model priors, and we’ve seen above that the model is doing a good job of estimating the other population parameters such as the interaction coefficient/SRN slope. Why would this be the case, given that this same approach is effective for estimating assortment in the between partner (<strong>??</strong>) and within-and-between partner SAMs (<strong>??</strong>)? In these latter models, variation across partners can be used to differentiate within-partner plasticity (SRN slopes) from between-partner assortment using within-individual centering. This leads to appropriate recovery of the assortment coefficient from the posterior SRN parameters, as individuals’ SRN parameters are accurately adjusted for between-individual heterogeneity in the social environment. However, in the within partner model, individuals only have a single social partner, and we’re unable to partition and adjust the random effect accordingly. For this reason, although the within partner model can provide accurate estimates of social plasticity and other population parameters, assortment is better estimated with multiple partner designs and within-individual centering.</p>
</div>
<div id="phenotypic-model" class="section level2" number="2.7">
<h2><span class="header-section-number">2.7</span> Phenotypic model</h2>
<p>Note that a phenotypic version of this within partner model can easily be specified by simplifying the random effects to a single set of phenotypic SRN intercepts and slopes.</p>
<div class="sourceCode" id="cb107"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb107-1"><a href="within-partner-sam.html#cb107-1" aria-hidden="true" tabindex="-1"></a><span class="fu">write</span>(<span class="st">&quot;</span></span>
<span id="cb107-2"><a href="within-partner-sam.html#cb107-2" aria-hidden="true" tabindex="-1"></a><span class="st">data {</span></span>
<span id="cb107-3"><a href="within-partner-sam.html#cb107-3" aria-hidden="true" tabindex="-1"></a><span class="st">  </span></span>
<span id="cb107-4"><a href="within-partner-sam.html#cb107-4" aria-hidden="true" tabindex="-1"></a><span class="st">  //indices and scalars used for model specification</span></span>
<span id="cb107-5"><a href="within-partner-sam.html#cb107-5" aria-hidden="true" tabindex="-1"></a><span class="st">  int&lt;lower=1&gt; N_sex; //total aggression observations per sex (I/2 * 2 repeated measures)</span></span>
<span id="cb107-6"><a href="within-partner-sam.html#cb107-6" aria-hidden="true" tabindex="-1"></a><span class="st">  int&lt;lower=0&gt; I; //total individuals (M + F)</span></span>
<span id="cb107-7"><a href="within-partner-sam.html#cb107-7" aria-hidden="true" tabindex="-1"></a><span class="st">  int&lt;lower=0&gt; Im; //number of males</span></span>
<span id="cb107-8"><a href="within-partner-sam.html#cb107-8" aria-hidden="true" tabindex="-1"></a><span class="st">  int&lt;lower=0&gt; If; //number of females</span></span>
<span id="cb107-9"><a href="within-partner-sam.html#cb107-9" aria-hidden="true" tabindex="-1"></a><span class="st">  int&lt;lower=1&gt; idm[N_sex]; //index of male AG observations (of length N_sex)</span></span>
<span id="cb107-10"><a href="within-partner-sam.html#cb107-10" aria-hidden="true" tabindex="-1"></a><span class="st">  int&lt;lower=1&gt; idf[N_sex]; //index of female AG observations</span></span>
<span id="cb107-11"><a href="within-partner-sam.html#cb107-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb107-12"><a href="within-partner-sam.html#cb107-12" aria-hidden="true" tabindex="-1"></a><span class="st">  //empirical data</span></span>
<span id="cb107-13"><a href="within-partner-sam.html#cb107-13" aria-hidden="true" tabindex="-1"></a><span class="st">  real AG_m[N_sex]; //male aggression measurements</span></span>
<span id="cb107-14"><a href="within-partner-sam.html#cb107-14" aria-hidden="true" tabindex="-1"></a><span class="st">  real AG_f[N_sex]; //female aggression measurements</span></span>
<span id="cb107-15"><a href="within-partner-sam.html#cb107-15" aria-hidden="true" tabindex="-1"></a><span class="st">  real time[N_sex]; //time index (1,2 per individual)</span></span>
<span id="cb107-16"><a href="within-partner-sam.html#cb107-16" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb107-17"><a href="within-partner-sam.html#cb107-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb107-18"><a href="within-partner-sam.html#cb107-18" aria-hidden="true" tabindex="-1"></a><span class="st">parameters {</span></span>
<span id="cb107-19"><a href="within-partner-sam.html#cb107-19" aria-hidden="true" tabindex="-1"></a><span class="st">  //population effects</span></span>
<span id="cb107-20"><a href="within-partner-sam.html#cb107-20" aria-hidden="true" tabindex="-1"></a><span class="st">  real alpha_0; //aggression global intercept</span></span>
<span id="cb107-21"><a href="within-partner-sam.html#cb107-21" aria-hidden="true" tabindex="-1"></a><span class="st">  real psi_1; //expected interaction coefficient</span></span>
<span id="cb107-22"><a href="within-partner-sam.html#cb107-22" aria-hidden="true" tabindex="-1"></a><span class="st">  real&lt;lower=-1,upper=1&gt; phi; //(-1,1) ensures unique solution</span></span>
<span id="cb107-23"><a href="within-partner-sam.html#cb107-23" aria-hidden="true" tabindex="-1"></a><span class="st">  </span></span>
<span id="cb107-24"><a href="within-partner-sam.html#cb107-24" aria-hidden="true" tabindex="-1"></a><span class="st">  //random effects (standard deviations)</span></span>
<span id="cb107-25"><a href="within-partner-sam.html#cb107-25" aria-hidden="true" tabindex="-1"></a><span class="st">  vector&lt;lower=0, upper = 1&gt;[2] sd_P; //phenotypic SRN mu &amp; psi SDs</span></span>
<span id="cb107-26"><a href="within-partner-sam.html#cb107-26" aria-hidden="true" tabindex="-1"></a><span class="st">  vector&lt;lower=0, upper = 1&gt;[2] sd_R; //male &amp; female residual SDs</span></span>
<span id="cb107-27"><a href="within-partner-sam.html#cb107-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb107-28"><a href="within-partner-sam.html#cb107-28" aria-hidden="true" tabindex="-1"></a><span class="st">  cholesky_factor_corr[2] LP; //P SRN correlations</span></span>
<span id="cb107-29"><a href="within-partner-sam.html#cb107-29" aria-hidden="true" tabindex="-1"></a><span class="st">  cholesky_factor_corr[2] LR; //sex-specific residual correlations</span></span>
<span id="cb107-30"><a href="within-partner-sam.html#cb107-30" aria-hidden="true" tabindex="-1"></a><span class="st">  </span></span>
<span id="cb107-31"><a href="within-partner-sam.html#cb107-31" aria-hidden="true" tabindex="-1"></a><span class="st">  matrix[I,2] std_devP; //individual-level unscaled P SRN deviations</span></span>
<span id="cb107-32"><a href="within-partner-sam.html#cb107-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb107-33"><a href="within-partner-sam.html#cb107-33" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb107-34"><a href="within-partner-sam.html#cb107-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb107-35"><a href="within-partner-sam.html#cb107-35" aria-hidden="true" tabindex="-1"></a><span class="st">transformed parameters {</span></span>
<span id="cb107-36"><a href="within-partner-sam.html#cb107-36" aria-hidden="true" tabindex="-1"></a><span class="st">  </span></span>
<span id="cb107-37"><a href="within-partner-sam.html#cb107-37" aria-hidden="true" tabindex="-1"></a><span class="st">  matrix[I,2] SRN_P; //scaled P SRN parameter deviations</span></span>
<span id="cb107-38"><a href="within-partner-sam.html#cb107-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb107-39"><a href="within-partner-sam.html#cb107-39" aria-hidden="true" tabindex="-1"></a><span class="st">  //non-centered parameterization of permanent environmental effects</span></span>
<span id="cb107-40"><a href="within-partner-sam.html#cb107-40" aria-hidden="true" tabindex="-1"></a><span class="st">  SRN_P = std_devP * diag_pre_multiply(sd_P, LP)&#39;;</span></span>
<span id="cb107-41"><a href="within-partner-sam.html#cb107-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb107-42"><a href="within-partner-sam.html#cb107-42" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb107-43"><a href="within-partner-sam.html#cb107-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb107-44"><a href="within-partner-sam.html#cb107-44" aria-hidden="true" tabindex="-1"></a><span class="st">model{</span></span>
<span id="cb107-45"><a href="within-partner-sam.html#cb107-45" aria-hidden="true" tabindex="-1"></a><span class="st">  //separate male and female vectors for efficiency</span></span>
<span id="cb107-46"><a href="within-partner-sam.html#cb107-46" aria-hidden="true" tabindex="-1"></a><span class="st">  matrix[Im,2] SRN_Pm = SRN_P[1:Im]; //male SRN phenotypic deviations</span></span>
<span id="cb107-47"><a href="within-partner-sam.html#cb107-47" aria-hidden="true" tabindex="-1"></a><span class="st">  matrix[If,2] SRN_Pf = SRN_P[(Im+1):I]; //female SRN phenotypic deviations</span></span>
<span id="cb107-48"><a href="within-partner-sam.html#cb107-48" aria-hidden="true" tabindex="-1"></a><span class="st">  </span></span>
<span id="cb107-49"><a href="within-partner-sam.html#cb107-49" aria-hidden="true" tabindex="-1"></a><span class="st">  //separate SRN intercepts and slopes (phenotypic deviations)</span></span>
<span id="cb107-50"><a href="within-partner-sam.html#cb107-50" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[Im] mu_m = col(SRN_Pm,1); //SRN intercepts</span></span>
<span id="cb107-51"><a href="within-partner-sam.html#cb107-51" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[If] mu_f = col(SRN_Pf,1); </span></span>
<span id="cb107-52"><a href="within-partner-sam.html#cb107-52" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[Im] psi_m = col(SRN_Pm,2); //SRN slopes</span></span>
<span id="cb107-53"><a href="within-partner-sam.html#cb107-53" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[If] psi_f = col(SRN_Pf,2); </span></span>
<span id="cb107-54"><a href="within-partner-sam.html#cb107-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb107-55"><a href="within-partner-sam.html#cb107-55" aria-hidden="true" tabindex="-1"></a><span class="st">  //initialize vectors for constructing individual-centered linear predictors</span></span>
<span id="cb107-56"><a href="within-partner-sam.html#cb107-56" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[N_sex] eta_m; //male SRN trait value </span></span>
<span id="cb107-57"><a href="within-partner-sam.html#cb107-57" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[N_sex] eta_f; //female SRN trait value</span></span>
<span id="cb107-58"><a href="within-partner-sam.html#cb107-58" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[N_sex] linpred_m; //total expected value for male responses</span></span>
<span id="cb107-59"><a href="within-partner-sam.html#cb107-59" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[N_sex] linpred_f; //total expected value for female responses</span></span>
<span id="cb107-60"><a href="within-partner-sam.html#cb107-60" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[N_sex] epsilon_m; //residual for male responses</span></span>
<span id="cb107-61"><a href="within-partner-sam.html#cb107-61" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[N_sex] epsilon_f; //residual for female responses</span></span>
<span id="cb107-62"><a href="within-partner-sam.html#cb107-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb107-63"><a href="within-partner-sam.html#cb107-63" aria-hidden="true" tabindex="-1"></a><span class="st">  //Male and female aggression response model</span></span>
<span id="cb107-64"><a href="within-partner-sam.html#cb107-64" aria-hidden="true" tabindex="-1"></a><span class="st">  for (n in 1:N_sex) {</span></span>
<span id="cb107-65"><a href="within-partner-sam.html#cb107-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb107-66"><a href="within-partner-sam.html#cb107-66" aria-hidden="true" tabindex="-1"></a><span class="st">  //SRN trait values</span></span>
<span id="cb107-67"><a href="within-partner-sam.html#cb107-67" aria-hidden="true" tabindex="-1"></a><span class="st">  //assumes that n = 1 in the context of an ongoing social interaction</span></span>
<span id="cb107-68"><a href="within-partner-sam.html#cb107-68" aria-hidden="true" tabindex="-1"></a><span class="st">  //if n = 1 prior to social context, then specify eta[t=1] = mu_j instead</span></span>
<span id="cb107-69"><a href="within-partner-sam.html#cb107-69" aria-hidden="true" tabindex="-1"></a><span class="st">  if (time[n]==1)</span></span>
<span id="cb107-70"><a href="within-partner-sam.html#cb107-70" aria-hidden="true" tabindex="-1"></a><span class="st">      {</span></span>
<span id="cb107-71"><a href="within-partner-sam.html#cb107-71" aria-hidden="true" tabindex="-1"></a><span class="st">        //male eta[t=1] = mu_j + (psi + psi_j)*(mu_k)</span></span>
<span id="cb107-72"><a href="within-partner-sam.html#cb107-72" aria-hidden="true" tabindex="-1"></a><span class="st">        eta_m[n] = mu_m[idm[n]] +  (psi_1 + psi_m[idm[n]])*(mu_f[idf[n]]) ;</span></span>
<span id="cb107-73"><a href="within-partner-sam.html#cb107-73" aria-hidden="true" tabindex="-1"></a><span class="st">        </span></span>
<span id="cb107-74"><a href="within-partner-sam.html#cb107-74" aria-hidden="true" tabindex="-1"></a><span class="st">        //female eta[t=1] = mu_k + (psi + psi_k)*(mu_j)</span></span>
<span id="cb107-75"><a href="within-partner-sam.html#cb107-75" aria-hidden="true" tabindex="-1"></a><span class="st">        eta_f[n] = mu_f[idf[n]] +   (psi_1 + psi_f[idf[n]])*(mu_m[idm[n]]);</span></span>
<span id="cb107-76"><a href="within-partner-sam.html#cb107-76" aria-hidden="true" tabindex="-1"></a><span class="st">      }    </span></span>
<span id="cb107-77"><a href="within-partner-sam.html#cb107-77" aria-hidden="true" tabindex="-1"></a><span class="st">    else</span></span>
<span id="cb107-78"><a href="within-partner-sam.html#cb107-78" aria-hidden="true" tabindex="-1"></a><span class="st">      {</span></span>
<span id="cb107-79"><a href="within-partner-sam.html#cb107-79" aria-hidden="true" tabindex="-1"></a><span class="st">        //male eta[t=2] = mu_j + (psi + psi_j)*(eta_k[t=1])</span></span>
<span id="cb107-80"><a href="within-partner-sam.html#cb107-80" aria-hidden="true" tabindex="-1"></a><span class="st">        eta_m[n] = mu_m[idm[n]] +   (psi_1 + psi_m[idm[n]])*(eta_f[n-1]);</span></span>
<span id="cb107-81"><a href="within-partner-sam.html#cb107-81" aria-hidden="true" tabindex="-1"></a><span class="st">        </span></span>
<span id="cb107-82"><a href="within-partner-sam.html#cb107-82" aria-hidden="true" tabindex="-1"></a><span class="st">        //female eta[t=2] = mu_k + (psi + psi_k)*(eta_j[t=1])</span></span>
<span id="cb107-83"><a href="within-partner-sam.html#cb107-83" aria-hidden="true" tabindex="-1"></a><span class="st">        eta_f[n] = mu_f[idf[n]] +   (psi_1 + psi_f[idf[n]])*(eta_m[n-1]);</span></span>
<span id="cb107-84"><a href="within-partner-sam.html#cb107-84" aria-hidden="true" tabindex="-1"></a><span class="st">      }</span></span>
<span id="cb107-85"><a href="within-partner-sam.html#cb107-85" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb107-86"><a href="within-partner-sam.html#cb107-86" aria-hidden="true" tabindex="-1"></a><span class="st">  //add global intercept and between-individual parameters to linear predictor</span></span>
<span id="cb107-87"><a href="within-partner-sam.html#cb107-87" aria-hidden="true" tabindex="-1"></a><span class="st">  //other fixed effects can also be added here</span></span>
<span id="cb107-88"><a href="within-partner-sam.html#cb107-88" aria-hidden="true" tabindex="-1"></a><span class="st">   linpred_m[n] = alpha_0 + eta_m[n];</span></span>
<span id="cb107-89"><a href="within-partner-sam.html#cb107-89" aria-hidden="true" tabindex="-1"></a><span class="st">   linpred_f[n] = alpha_0 + eta_f[n];</span></span>
<span id="cb107-90"><a href="within-partner-sam.html#cb107-90" aria-hidden="true" tabindex="-1"></a><span class="st">   </span></span>
<span id="cb107-91"><a href="within-partner-sam.html#cb107-91" aria-hidden="true" tabindex="-1"></a><span class="st">  //residual trait values</span></span>
<span id="cb107-92"><a href="within-partner-sam.html#cb107-92" aria-hidden="true" tabindex="-1"></a><span class="st">    if(time[n]==1)</span></span>
<span id="cb107-93"><a href="within-partner-sam.html#cb107-93" aria-hidden="true" tabindex="-1"></a><span class="st">      {</span></span>
<span id="cb107-94"><a href="within-partner-sam.html#cb107-94" aria-hidden="true" tabindex="-1"></a><span class="st">        epsilon_m [n] = AG_m[n] - linpred_m[n];</span></span>
<span id="cb107-95"><a href="within-partner-sam.html#cb107-95" aria-hidden="true" tabindex="-1"></a><span class="st">        epsilon_f [n] = AG_f[n] - linpred_f[n];</span></span>
<span id="cb107-96"><a href="within-partner-sam.html#cb107-96" aria-hidden="true" tabindex="-1"></a><span class="st">      }</span></span>
<span id="cb107-97"><a href="within-partner-sam.html#cb107-97" aria-hidden="true" tabindex="-1"></a><span class="st">    else</span></span>
<span id="cb107-98"><a href="within-partner-sam.html#cb107-98" aria-hidden="true" tabindex="-1"></a><span class="st">      {</span></span>
<span id="cb107-99"><a href="within-partner-sam.html#cb107-99" aria-hidden="true" tabindex="-1"></a><span class="st">       linpred_m[n] = linpred_m[n] + phi * epsilon_f[n-1];</span></span>
<span id="cb107-100"><a href="within-partner-sam.html#cb107-100" aria-hidden="true" tabindex="-1"></a><span class="st">       epsilon_m[n] = AG_m[n] - linpred_m[n]; </span></span>
<span id="cb107-101"><a href="within-partner-sam.html#cb107-101" aria-hidden="true" tabindex="-1"></a><span class="st">       </span></span>
<span id="cb107-102"><a href="within-partner-sam.html#cb107-102" aria-hidden="true" tabindex="-1"></a><span class="st">       linpred_f[n] = linpred_f[n] + phi * epsilon_m[n-1];</span></span>
<span id="cb107-103"><a href="within-partner-sam.html#cb107-103" aria-hidden="true" tabindex="-1"></a><span class="st">       epsilon_f[n] = AG_f[n] - linpred_f[n]; </span></span>
<span id="cb107-104"><a href="within-partner-sam.html#cb107-104" aria-hidden="true" tabindex="-1"></a><span class="st">      }</span></span>
<span id="cb107-105"><a href="within-partner-sam.html#cb107-105" aria-hidden="true" tabindex="-1"></a><span class="st">  </span></span>
<span id="cb107-106"><a href="within-partner-sam.html#cb107-106" aria-hidden="true" tabindex="-1"></a><span class="st">  //correlated residuals between partners</span></span>
<span id="cb107-107"><a href="within-partner-sam.html#cb107-107" aria-hidden="true" tabindex="-1"></a><span class="st">   [epsilon_m[n],epsilon_f[n]]&#39; ~ multi_normal_cholesky([0,0], diag_pre_multiply(sd_R, LR));</span></span>
<span id="cb107-108"><a href="within-partner-sam.html#cb107-108" aria-hidden="true" tabindex="-1"></a><span class="st">  }</span></span>
<span id="cb107-109"><a href="within-partner-sam.html#cb107-109" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb107-110"><a href="within-partner-sam.html#cb107-110" aria-hidden="true" tabindex="-1"></a><span class="st">//model priors</span></span>
<span id="cb107-111"><a href="within-partner-sam.html#cb107-111" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb107-112"><a href="within-partner-sam.html#cb107-112" aria-hidden="true" tabindex="-1"></a><span class="st">  //fixed effects</span></span>
<span id="cb107-113"><a href="within-partner-sam.html#cb107-113" aria-hidden="true" tabindex="-1"></a><span class="st">  alpha_0 ~ std_normal();</span></span>
<span id="cb107-114"><a href="within-partner-sam.html#cb107-114" aria-hidden="true" tabindex="-1"></a><span class="st">  psi_1 ~ std_normal();</span></span>
<span id="cb107-115"><a href="within-partner-sam.html#cb107-115" aria-hidden="true" tabindex="-1"></a><span class="st">  phi ~ std_normal();</span></span>
<span id="cb107-116"><a href="within-partner-sam.html#cb107-116" aria-hidden="true" tabindex="-1"></a><span class="st">  </span></span>
<span id="cb107-117"><a href="within-partner-sam.html#cb107-117" aria-hidden="true" tabindex="-1"></a><span class="st">  //random effects</span></span>
<span id="cb107-118"><a href="within-partner-sam.html#cb107-118" aria-hidden="true" tabindex="-1"></a><span class="st">  to_vector(sd_P) ~ cauchy(0,1);</span></span>
<span id="cb107-119"><a href="within-partner-sam.html#cb107-119" aria-hidden="true" tabindex="-1"></a><span class="st">  to_vector(sd_R) ~ cauchy(0,1);</span></span>
<span id="cb107-120"><a href="within-partner-sam.html#cb107-120" aria-hidden="true" tabindex="-1"></a><span class="st">  </span></span>
<span id="cb107-121"><a href="within-partner-sam.html#cb107-121" aria-hidden="true" tabindex="-1"></a><span class="st">  LP ~ lkj_corr_cholesky(2);</span></span>
<span id="cb107-122"><a href="within-partner-sam.html#cb107-122" aria-hidden="true" tabindex="-1"></a><span class="st">  LR ~ lkj_corr_cholesky(2);</span></span>
<span id="cb107-123"><a href="within-partner-sam.html#cb107-123" aria-hidden="true" tabindex="-1"></a><span class="st">  </span></span>
<span id="cb107-124"><a href="within-partner-sam.html#cb107-124" aria-hidden="true" tabindex="-1"></a><span class="st">  to_vector(std_devP) ~ std_normal();</span></span>
<span id="cb107-125"><a href="within-partner-sam.html#cb107-125" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb107-126"><a href="within-partner-sam.html#cb107-126" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb107-127"><a href="within-partner-sam.html#cb107-127" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb107-128"><a href="within-partner-sam.html#cb107-128" aria-hidden="true" tabindex="-1"></a><span class="st">generated quantities{</span></span>
<span id="cb107-129"><a href="within-partner-sam.html#cb107-129" aria-hidden="true" tabindex="-1"></a><span class="st">//cor and cov matrices of SRN parameters and residuals</span></span>
<span id="cb107-130"><a href="within-partner-sam.html#cb107-130" aria-hidden="true" tabindex="-1"></a><span class="st">matrix[2,2] Gcor = LP * LP&#39;; //P SRN correlation matric</span></span>
<span id="cb107-131"><a href="within-partner-sam.html#cb107-131" aria-hidden="true" tabindex="-1"></a><span class="st">matrix[2,2] Rcor = LR * LR&#39;; //residual correlation matrix</span></span>
<span id="cb107-132"><a href="within-partner-sam.html#cb107-132" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb107-133"><a href="within-partner-sam.html#cb107-133" aria-hidden="true" tabindex="-1"></a><span class="st">matrix[2,2] Rcov = diag_matrix(sd_R)*Rcor*diag_matrix(sd_R); //residual covariance</span></span>
<span id="cb107-134"><a href="within-partner-sam.html#cb107-134" aria-hidden="true" tabindex="-1"></a><span class="st">matrix[2,2] Gcov = diag_matrix(sd_P)*Pcor*diag_matrix(sd_P); //P SRN covariance</span></span>
<span id="cb107-135"><a href="within-partner-sam.html#cb107-135" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb107-136"><a href="within-partner-sam.html#cb107-136" aria-hidden="true" tabindex="-1"></a><span class="st">//variances</span></span>
<span id="cb107-137"><a href="within-partner-sam.html#cb107-137" aria-hidden="true" tabindex="-1"></a><span class="st">vector&lt;lower=0&gt;[2] V_P = sd_P .* sd_P</span></span>
<span id="cb107-138"><a href="within-partner-sam.html#cb107-138" aria-hidden="true" tabindex="-1"></a><span class="st">vector&lt;lower=0&gt;[2] V_R = sd_R .* sd_R;</span></span>
<span id="cb107-139"><a href="within-partner-sam.html#cb107-139" aria-hidden="true" tabindex="-1"></a><span class="st">}&quot;</span>, <span class="st">&quot;sam3_1P.stan&quot;</span>)</span></code></pre></div>

</div>
</div>
<h3>Resources</h3>
<div id="refs" class="references csl-bib-body hanging-indent">
<div id="ref-SAM" class="csl-entry">
Martin, J. S., and A. V. Jaeggi. 2021. <span>“Social Animal Models for Quantifying Plasticity, Assortment, and Selection on Interacting Phenotypes.”</span> <em>Under Review</em> XX. <a href="https://XX">XX</a>.
</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="using-stan-in-r.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="between-partner-sam.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"whatsapp": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": null,
"text": null
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": null,
"toc": {
"collapse": "subsection"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
