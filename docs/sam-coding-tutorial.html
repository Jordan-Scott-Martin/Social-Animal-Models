<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>2 SAM coding tutorial | Estimating Social Animal Models in Stan</title>
  <meta name="description" content="2 SAM coding tutorial | Estimating Social Animal Models in Stan" />
  <meta name="generator" content="bookdown 0.21 and GitBook 2.6.7" />

  <meta property="og:title" content="2 SAM coding tutorial | Estimating Social Animal Models in Stan" />
  <meta property="og:type" content="book" />
  
  
  
  

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="2 SAM coding tutorial | Estimating Social Animal Models in Stan" />
  
  
  

<meta name="author" content="Jordan S. Martin &amp; Adrian V. Jaeggi" />


<meta name="date" content="2021-01-08" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="using-stan-in-r.html"/>
<link rel="next" href="extending-sams.html"/>
<script src="libs/jquery-2.2.3/jquery.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />









<script src="libs/accessible-code-block-0.0.1/empty-anchor.js"></script>
<link href="libs/anchor-sections-1.0/anchor-sections.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.0/anchor-sections.js"></script>


<style type="text/css">
code.sourceCode > span { display: inline-block; line-height: 1.25; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li class="chapter" data-level="" data-path="introduction.html"><a href="introduction.html"><i class="fa fa-check"></i>Introduction</a></li>
<li class="chapter" data-level="1" data-path="using-stan-in-r.html"><a href="using-stan-in-r.html"><i class="fa fa-check"></i><b>1</b> Using Stan in R</a><ul>
<li class="chapter" data-level="1.1" data-path="using-stan-in-r.html"><a href="using-stan-in-r.html#why-stan"><i class="fa fa-check"></i><b>1.1</b> Why Stan?</a></li>
<li class="chapter" data-level="1.2" data-path="using-stan-in-r.html"><a href="using-stan-in-r.html#getting-started"><i class="fa fa-check"></i><b>1.2</b> Getting Started</a></li>
<li class="chapter" data-level="1.3" data-path="using-stan-in-r.html"><a href="using-stan-in-r.html#bayesian-inference"><i class="fa fa-check"></i><b>1.3</b> Bayesian inference</a></li>
<li class="chapter" data-level="1.4" data-path="using-stan-in-r.html"><a href="using-stan-in-r.html#basic-coding-tutorial"><i class="fa fa-check"></i><b>1.4</b> Basic coding tutorial</a><ul>
<li class="chapter" data-level="1.4.1" data-path="using-stan-in-r.html"><a href="using-stan-in-r.html#cholesky-decompositions"><i class="fa fa-check"></i><b>1.4.1</b> Cholesky decompositions</a></li>
<li class="chapter" data-level="1.4.2" data-path="using-stan-in-r.html"><a href="using-stan-in-r.html#non-centered-random-effects"><i class="fa fa-check"></i><b>1.4.2</b> Non-centered random effects</a></li>
</ul></li>
<li class="chapter" data-level="1.5" data-path="using-stan-in-r.html"><a href="using-stan-in-r.html#animal-models"><i class="fa fa-check"></i><b>1.5</b> Animal models</a><ul>
<li class="chapter" data-level="1.5.1" data-path="using-stan-in-r.html"><a href="using-stan-in-r.html#kronecker-products"><i class="fa fa-check"></i><b>1.5.1</b> Kronecker products</a></li>
<li class="chapter" data-level="1.5.2" data-path="using-stan-in-r.html"><a href="using-stan-in-r.html#identifying-genetic-effects"><i class="fa fa-check"></i><b>1.5.2</b> Identifying genetic effects</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="2" data-path="sam-coding-tutorial.html"><a href="sam-coding-tutorial.html"><i class="fa fa-check"></i><b>2</b> SAM coding tutorial</a><ul>
<li class="chapter" data-level="2.1" data-path="sam-coding-tutorial.html"><a href="sam-coding-tutorial.html#coding-the-model"><i class="fa fa-check"></i><b>2.1</b> Coding the model</a></li>
<li class="chapter" data-level="2.2" data-path="sam-coding-tutorial.html"><a href="sam-coding-tutorial.html#quantifying-assortment"><i class="fa fa-check"></i><b>2.2</b> Quantifying assortment</a></li>
<li class="chapter" data-level="2.3" data-path="sam-coding-tutorial.html"><a href="sam-coding-tutorial.html#selection-differentials"><i class="fa fa-check"></i><b>2.3</b> Selection differentials</a></li>
<li class="chapter" data-level="2.4" data-path="sam-coding-tutorial.html"><a href="sam-coding-tutorial.html#the-response-to-selection"><i class="fa fa-check"></i><b>2.4</b> The response to selection</a></li>
</ul></li>
<li class="chapter" data-level="3" data-path="extending-sams.html"><a href="extending-sams.html"><i class="fa fa-check"></i><b>3</b> Extending SAMs</a></li>
<li class="chapter" data-level="" data-path="resources.html"><a href="resources.html"><i class="fa fa-check"></i>Resources</a></li>
</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Estimating Social Animal Models in Stan</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="sam-coding-tutorial" class="section level1">
<h1><span class="header-section-number">2</span> SAM coding tutorial</h1>
<p>Please note that this section is a work in progress. Further details will be added in the coming weeks.</p>
<div id="coding-the-model" class="section level2">
<h2><span class="header-section-number">2.1</span> Coding the model</h2>
<p>Explain code in detail…</p>
<pre class="stan"><code>data {
  
  //indices and scalars used for model specification
  int&lt;lower=1&gt; N_sex; //total AG observations per sex
  int&lt;lower=0&gt; I; //total individuals
  int&lt;lower=0&gt; Im; //number of males
  int&lt;lower=0&gt; If; //number of females
  int&lt;lower=1&gt; Idyad; //number of dyads
  int&lt;lower=1&gt; idm[N_sex]; //index of male AG observations
  int&lt;lower=1&gt; idf[N_sex]; //index of female AG observations
  int&lt;lower=1&gt; idmw[Idyad]; //index of male FS observations
  int&lt;lower=1&gt; idfw[Idyad]; //index of female FS observations
  int&lt;lower=1&gt; dyadw[Idyad]; //index of dyads for FS
  int&lt;lower=1&gt; partners_m [Im,5]; //index of male partner IDs, first column is focal ID
  int&lt;lower=1&gt; partners_f [If,5]; //index of female partner IDs, first column is focal ID
  
  //empirical data
  matrix[I,I] A; //relatedness matrix
  vector[2] AG[N_sex]; //combined male and female AG responses
  real w[Idyad]; //FS dyad response
  real time[N_sex];
}

transformed data{
  matrix[I,I] LA = cholesky_decompose(A); //lower-triangle A matrix
}

parameters {
  //population effects
  real alpha_0; //aggression global intercept
  real nu_0; //fitness global intercept
  real psi_1; //expected interaction coefficient
  real beta_B1; //average partner SRN intercept
  real beta_B2; //average partner SRN slopes
  real beta_N1; //selection gradients
  real beta_N2;
  real beta_S1;
  real beta_S2;
  real beta_D1;
  real beta_D2;
  
  
  //random effects (standard deviations)
  vector&lt;lower=0, upper = 1&gt;[2] sd_P; //phenotypic SRN mu &amp; psi SDs
  vector&lt;lower=0, upper = 1&gt;[2] sd_R; //male &amp; female residual SDs
  real&lt;lower=0, upper = 1&gt;sd_delta; //residual of fitness

  cholesky_factor_corr[2] LG; //genetic SRN correlations
  cholesky_factor_corr[2] LE; //permanent environmental SRN correlations
  cholesky_factor_corr[2] LR; //sex-specific residual correlations
  
  matrix[I,2] std_devG; //individual-level unscaled G SRN deviations
  matrix[I,2] std_devE; //individual-level unscaled E SRN deviations
  
  //SRN heritability parmameters, i.e. Var(G_RN) / Var(P_RN) 
  //see supplementary appendix SI for further explanation of this parameter
  vector&lt;lower=0,upper=1&gt;[2] SRN_h2;
  
}

transformed parameters {
  vector&lt;lower=0&gt;[2] sd_G; //SDs of G effects (derived from sd_P)
  vector&lt;lower=0&gt;[2] sd_E; //SDs of E effects (derived from sd_P)
  
  matrix[I,2] SRN_P; //scaled P SRN parameter deviations
  matrix[I,2] SRN_G; //scaled G SRN parameter deviations
  matrix[I,2] SRN_E; //scaled E SRN parameter deviations
  
  matrix[If, 2] partner_meanm; //average SRN parameters of males&#39; partners
  matrix[Im, 2] partner_meanf; //average SRN parameters of females&#39; partners
  
  //standard deviations of genetic effects
  //simplified from sqrt ( total RN phenotype variance * h2 )
  sd_G[1] = sd_P[1] * sqrt(SRN_h2[1]); //genetic SD for RN intercepts 
  sd_G[2] = sd_P[2] * sqrt(SRN_h2[2]);  //genetic SD for RN slopes
  
  //standard deviations of environmental effects (total phenotype SD * proportion environment SD)
  sd_E[1] = sd_P[1] * sqrt(1 - SRN_h2[1]); //environment SD for RN intercepts 
  sd_E[2] = sd_P[2] * sqrt(1 - SRN_h2[2]); //environment SD for RN slopes 
  
  //matrix normal parameterization of Kronecker product between G and A
  SRN_G =  LA * std_devG  * diag_pre_multiply(sd_G, LG)&#39; ; 
  
  //non-centered parameterization of permanent environmental effects
  SRN_E = std_devE * diag_pre_multiply(sd_E, LE);
  
  //phenotypic RN effects (P = G + E); here G = additive genetic effects
  SRN_P = SRN_G + SRN_E;

  //calculate the mean SRN parameters of each male&#39;s lifetime partners
  for(i in 1:Im) partner_meanm[i] = [mean(col(SRN_P[partners_m[i,2:5]],1)),
                                mean(col(SRN_P[partners_m[i,2:5]],2))];
  
  //calculate the mean SRN parameters of each female&#39;s lifetime partners
  for(i in 1:If) partner_meanf[i] = [mean(col(SRN_P[partners_f[i,2:5]],1)),
                                mean(col(SRN_P[partners_f[i,2:5]],2))];
}

model{
  
  //separate male and female vectors for efficiency
  matrix[Im,2] SRN_Pm = SRN_P[1:Im]; //male SRN phenotypic deviations
  matrix[If,2] SRN_Pf = SRN_P[(Im+1):I]; //female SRN phenotypic deviations
  
  //separate SRN intercepts and slopes (phenotypic deviations)
  vector[Im] mu_Pm = col(SRN_Pm,1); //SRN intercepts
  vector[If] mu_Pf = col(SRN_Pf,1); 
  vector[Im] psi_Pm = col(SRN_Pm,2); //SRN slopes
  vector[If] psi_Pf = col(SRN_Pf,2); 
  
  //total SRN values (population average + deviation)
  vector[Im] mu_m = alpha_0 + mu_Pm;
  vector[If] mu_f = alpha_0 + mu_Pf; 
  vector[Im] psi_m = psi_1 + psi_Pm; 
  vector[If] psi_f = psi_1 + psi_Pf; 
  
  //separate mean partner SRN intercepts and slopes (deviations)
  vector[Im] mu_meanPm = col(partner_meanm,1); //mean partner SRN intercept for males
  vector[If] mu_meanPf = col(partner_meanf,1); //...for females
  vector[Im] psi_meanPm = col(partner_meanm,2); //mean partner SRN slope for males
  vector[If] psi_meanPf = col(partner_meanf,2); //...for females
  
  //mean partner total SRN values (population average + deviation)
  vector[Im] mu_meanm = alpha_0 + mu_meanPm;
  vector[If] mu_meanf = alpha_0 + mu_meanPf;
  vector[Im] psi_meanm = psi_1 + psi_meanPm; 
  vector[If] psi_meanf = psi_1 + psi_meanPf; 
  
  //initialize vectors for constructing individual-centered linear predictors
  vector[N_sex] eta_Wm; //within-individual centered male SRN trait value 
  vector[N_sex] eta_Wf; //within-individual centered female SRN trait value
  
  vector[N_sex] meaneta_m; //individual male SRN trait value toward average partner 
  vector[N_sex] meaneta_f; //individual female SRN trait toward average partner
  vector[N_sex] eta_meanm; //average SRN partner values for males
  vector[N_sex] eta_meanf; //average SRN partner values for females
  
  vector[N_sex] linpred_m; //expected value for male responses
  vector[N_sex] linpred_f; //expected value for female responses
  vector[2] linpred[N_sex]; //combined vector of male and female linear predictors
  vector[Idyad] w_pred; //linear predictor of fitness
  
  //predict unbiased SRN trait values at t=1 and t=2
  for (n in 1:N_sex) {
    
    //assumes that n = 1 in the context of an ongoing social interaction
    //if n = 1 prior to social context, then specify eta[t=1] = mu_j instead
    if (time[n]==1)
      {
        //within-individual centered eta
        //male eta[t=1] = mu_j + psi_j*(mu_k - mu_meanK)
        eta_Wm[n] = mu_m[idm[n]] +  psi_m[idm[n]]*(mu_f[idf[n]] - mu_meanm[idm[n]]) ;
        
        //female eta[t=1] = mu_k + psi_k*(mu_j - mu_meanJ)
        eta_Wf[n] = mu_f[idf[n]] + psi_f[idf[n]]*(mu_m[idm[n]] - mu_meanf[idf[n]]);
        
        //average individual eta
        //male eta[t=1] = mu_j + psi_j*mu_k
        meaneta_m[n] = mu_m[idm[n]] +  psi_m[idm[n]]*mu_meanm[idm[n]];
        
        //female eta[t=1] = mu_k + psi_k*mu_j
        meaneta_f[n] = mu_f[idf[n]] + psi_f[idf[n]]*mu_meanf[idf[n]];
        
        //average partner eta[t=1]
        //average eta males&#39; partners [t=1] = mu_meanK + psi_meanK*mu_j
        eta_meanm[n] = mu_meanm[idm[n]] + psi_meanm[idm[n]]*mu_m[idm[n]];
        
        //average eta females&#39; partners [t=1] = mu_meanJ + psi_meanJ*mu_k
        eta_meanf[n] = mu_meanf[idf[n]] + psi_meanf[idf[n]]*mu_f[idf[n]];
      }    
    else
      {
        //within-individual centered eta
        //male eta[t=2] = mu_j + psi_j*(eta_k[t=1] - eta_meanK[t=1])
        eta_Wm[n] = mu_m[idm[n]] + psi_m[idm[n]]*(eta_Wf[n-1] - eta_meanm[n-1]);
        
        //female eta[t=2] = mu_k + psi_k*(eta_j[t=1] - eta_meanJ[t=1])
        eta_Wf[n] = mu_f[idf[n]] + psi_f[idf[n]]*(eta_Wm[n-1] - eta_meanf[n-1]);
        
        //average individual eta
        //male average eta[t=2] = mu_j + psi_j*eta_meanK[t=1]
        meaneta_m[n] = mu_m[idm[n]] +  psi_m[idm[n]]*eta_meanm[n-1];
        
        //female average eta[t=2] = mu_k + psi_k*eta_meanJ[t=1]
        meaneta_f[n] = mu_f[idf[n]] + psi_f[idf[n]]*eta_meanf[n-1];
        
        //average eta males&#39; partners [t=1] = mu_meanK + psi_meanK*mean eta_j[t-1]
        eta_meanm[n] = mu_meanm[idm[n]] + psi_meanm[idm[n]]*meaneta_m[n-1];
        
        //female average partner eta
        eta_meanf[n] = mu_meanf[idf[n]] + psi_meanf[idf[n]]*meaneta_f[n-1]; 
      }
    
    //add between-individual parameters to linear predictor
    linpred_m[n] = eta_Wm[n] + beta_B1*mu_meanPm[idm[n]] + beta_B2*psi_meanPm[idm[n]];
    linpred_f[n] = eta_Wf[n] + beta_B1*mu_meanPf[idf[n]] + beta_B2*psi_meanPf[idf[n]];
    
    //put male and female linear predictors together
    linpred[n] = [linpred_m[n], linpred_f[n]]&#39;;
    }
  
  //aggression response model with correlated residuals
  AG ~ multi_normal_cholesky(linpred, diag_pre_multiply(sd_R, LR));
    
  //fitness response model
  w_pred = nu_0 + beta_N1*mu_Pm[idmw] + beta_N2*psi_Pm[idmw] + beta_S1*mu_Pf[idfw] + beta_S2*psi_Pf[idfw] + 
                  beta_D1*(mu_Pm[idmw].*mu_Pf[idfw]) + beta_D2*(psi_Pm[idmw].*psi_Pf[idfw]);
  
  w ~ normal(w_pred, sd_delta);

  //model priors
  
  //fixed effects
  alpha_0 ~ std_normal();
  nu_0 ~ std_normal();
  psi_1 ~ std_normal();
  beta_B1 ~ std_normal();
  beta_B2 ~ std_normal();
  beta_N1 ~ std_normal();
  beta_N2 ~ std_normal();
  beta_S1 ~ std_normal();
  beta_S2 ~ std_normal();
  beta_D1 ~ std_normal();
  beta_D2 ~ std_normal();
  
  //random effects
  to_vector(sd_P) ~ cauchy(0,1);
  to_vector(sd_R) ~ cauchy(0,1);
  sd_delta ~ cauchy(0,1);
  
  LG ~ lkj_corr_cholesky(2);
  LE ~ lkj_corr_cholesky(2);
  LR ~ lkj_corr_cholesky(2);
  
  to_vector(std_devG) ~ std_normal();
  to_vector(std_devE) ~ std_normal();
  
  //reaction norm heritability
  to_vector(SRN_h2) ~ beta(1.2,1.2);
  
}


generated quantities{
//cor and cov matrices of SRN parameters and residuals
matrix[2,2] Gcor = LG * LG&#39;; //G SRN correlation matric
matrix[2,2] Ecor = LE * LG&#39;; //E SRN correlation matric
matrix[2,2] Rcor = LR * LR&#39;; //residual correlation matrix

matrix[2,2] Rcov = diag_matrix(sd_R)*Rcor*diag_matrix(sd_R); //residual covariance
matrix[2,2] Gcov = diag_matrix(sd_G)*Gcor*diag_matrix(sd_G); //G SRN covariance
matrix[2,2] Ecov = diag_matrix(sd_E)*Ecor*diag_matrix(sd_E); //E SRN covariance
matrix[2,2] Pcov = Gcov + Ecov; //P SRN covariance
matrix[2,2] Pcor = inverse(diag_matrix(sd_P))*Pcov*inverse(diag_matrix(sd_P)); //P SRN correlation

//variances
vector&lt;lower=0&gt;[2] V_P = sd_P .* sd_P;
vector&lt;lower=0&gt;[2] V_G = sd_G .* sd_G;
vector&lt;lower=0&gt;[2] V_E = sd_E .* sd_E;
vector&lt;lower=0&gt;[2] V_R = sd_R .* sd_R;
}
</code></pre>
</div>
<div id="quantifying-assortment" class="section level2">
<h2><span class="header-section-number">2.2</span> Quantifying assortment</h2>
<p>…</p>
<div class="sourceCode" id="cb24"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb24-1"><a href="sam-coding-tutorial.html#cb24-1"></a>    <span class="co">#extract posteriors</span></span>
<span id="cb24-2"><a href="sam-coding-tutorial.html#cb24-2"></a>    post &lt;-<span class="st"> </span>rstan<span class="op">::</span><span class="kw">extract</span>(SAM_m)</span>
<span id="cb24-3"><a href="sam-coding-tutorial.html#cb24-3"></a>    </span>
<span id="cb24-4"><a href="sam-coding-tutorial.html#cb24-4"></a>    <span class="co">#temporary vectors for assortment coefficients</span></span>
<span id="cb24-5"><a href="sam-coding-tutorial.html#cb24-5"></a>    SRN_PV =<span class="st"> </span>post<span class="op">$</span>V_P</span>
<span id="cb24-6"><a href="sam-coding-tutorial.html#cb24-6"></a>    SRN_Psd =<span class="st"> </span>post<span class="op">$</span>sd_P</span>
<span id="cb24-7"><a href="sam-coding-tutorial.html#cb24-7"></a>    SRN_PVmean =<span class="st"> </span>post<span class="op">$</span>V_P <span class="op">/</span><span class="st"> </span>I_partner <span class="co">#expected variance for mean of partners</span></span>
<span id="cb24-8"><a href="sam-coding-tutorial.html#cb24-8"></a>    SRN_Psdmean =<span class="st"> </span><span class="kw">sqrt</span>(SRN_PVmean) <span class="co">#expected SD for mean of partners</span></span>
<span id="cb24-9"><a href="sam-coding-tutorial.html#cb24-9"></a>    SRN_focal1 &lt;-<span class="st"> </span>post<span class="op">$</span>SRN_P[,,<span class="dv">1</span>] <span class="co">#individual intercepts</span></span>
<span id="cb24-10"><a href="sam-coding-tutorial.html#cb24-10"></a>    SRN_focal2 &lt;-<span class="st"> </span>post<span class="op">$</span>SRN_P[,,<span class="dv">2</span>] <span class="co">#individual slopes</span></span>
<span id="cb24-11"><a href="sam-coding-tutorial.html#cb24-11"></a>    SRN_partner1 &lt;-<span class="st"> </span><span class="kw">cbind</span>(post<span class="op">$</span>partner_meanm[,,<span class="dv">1</span>], post<span class="op">$</span>partner_meanf[,,<span class="dv">1</span>])</span>
<span id="cb24-12"><a href="sam-coding-tutorial.html#cb24-12"></a>    SRN_partner2 &lt;-<span class="st"> </span><span class="kw">cbind</span>(post<span class="op">$</span>partner_meanm[,,<span class="dv">2</span>], post<span class="op">$</span>partner_meanf[,,<span class="dv">2</span>])</span>
<span id="cb24-13"><a href="sam-coding-tutorial.html#cb24-13"></a>    </span>
<span id="cb24-14"><a href="sam-coding-tutorial.html#cb24-14"></a>    <span class="co">#scale mean partner variance to variance of single partner</span></span>
<span id="cb24-15"><a href="sam-coding-tutorial.html#cb24-15"></a>    <span class="co">#see appendix SI for details</span></span>
<span id="cb24-16"><a href="sam-coding-tutorial.html#cb24-16"></a>    </span>
<span id="cb24-17"><a href="sam-coding-tutorial.html#cb24-17"></a>    SRN_partner1s =<span class="st"> </span>SRN_partner1</span>
<span id="cb24-18"><a href="sam-coding-tutorial.html#cb24-18"></a>    <span class="cf">for</span>(j <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span><span class="kw">nrow</span>(SRN_partner1))</span>
<span id="cb24-19"><a href="sam-coding-tutorial.html#cb24-19"></a>    {SRN_partner1s[j,] =<span class="st"> </span>( SRN_partner1[j,] <span class="op">/</span><span class="st"> </span>SRN_Psdmean[j,<span class="dv">1</span>] ) <span class="op">*</span><span class="st"> </span>SRN_Psd[j,<span class="dv">1</span>] }</span>
<span id="cb24-20"><a href="sam-coding-tutorial.html#cb24-20"></a>   </span>
<span id="cb24-21"><a href="sam-coding-tutorial.html#cb24-21"></a>    SRN_partner2s =<span class="st"> </span>SRN_partner2</span>
<span id="cb24-22"><a href="sam-coding-tutorial.html#cb24-22"></a>    <span class="cf">for</span>(j <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span><span class="kw">nrow</span>(SRN_partner2))</span>
<span id="cb24-23"><a href="sam-coding-tutorial.html#cb24-23"></a>    {SRN_partner2s[j,] =<span class="st"> </span>( SRN_partner2[j,] <span class="op">/</span><span class="st"> </span>SRN_Psdmean[j,<span class="dv">2</span>] ) <span class="op">*</span><span class="st"> </span>SRN_Psd[j,<span class="dv">2</span>] }</span>
<span id="cb24-24"><a href="sam-coding-tutorial.html#cb24-24"></a>    </span>
<span id="cb24-25"><a href="sam-coding-tutorial.html#cb24-25"></a>    <span class="co">#assortment matrix</span></span>
<span id="cb24-26"><a href="sam-coding-tutorial.html#cb24-26"></a>    Beta_alpha =<span class="st"> </span><span class="kw">list</span>()</span>
<span id="cb24-27"><a href="sam-coding-tutorial.html#cb24-27"></a>    </span>
<span id="cb24-28"><a href="sam-coding-tutorial.html#cb24-28"></a>    <span class="co">#generate matrices across each posterior sample</span></span>
<span id="cb24-29"><a href="sam-coding-tutorial.html#cb24-29"></a>    <span class="cf">for</span>(j <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span><span class="kw">nrow</span>(SRN_focal1))</span>
<span id="cb24-30"><a href="sam-coding-tutorial.html#cb24-30"></a>    {</span>
<span id="cb24-31"><a href="sam-coding-tutorial.html#cb24-31"></a>            Beta_mat =<span class="st"> </span><span class="kw">matrix</span>(<span class="ot">NA</span>,<span class="dv">2</span>,<span class="dv">2</span>)</span>
<span id="cb24-32"><a href="sam-coding-tutorial.html#cb24-32"></a>            </span>
<span id="cb24-33"><a href="sam-coding-tutorial.html#cb24-33"></a>            <span class="co">#mu&#39; ~ mu</span></span>
<span id="cb24-34"><a href="sam-coding-tutorial.html#cb24-34"></a>            Beta_mat[<span class="dv">1</span>,<span class="dv">1</span>] =<span class="st">  </span><span class="kw">cov</span>(SRN_focal1[j,], SRN_partner1s[j,])<span class="op">/</span><span class="kw">var</span>(SRN_focal1[j,])</span>
<span id="cb24-35"><a href="sam-coding-tutorial.html#cb24-35"></a>            <span class="co">#mu&#39; ~ psi</span></span>
<span id="cb24-36"><a href="sam-coding-tutorial.html#cb24-36"></a>            Beta_mat[<span class="dv">2</span>,<span class="dv">1</span>] =<span class="st">  </span><span class="kw">cov</span>(SRN_focal2[j,], SRN_partner1s[j,])<span class="op">/</span><span class="kw">var</span>(SRN_focal2[j,])</span>
<span id="cb24-37"><a href="sam-coding-tutorial.html#cb24-37"></a>            <span class="co">#psi&#39; ~ mu                                                        </span></span>
<span id="cb24-38"><a href="sam-coding-tutorial.html#cb24-38"></a>            Beta_mat[<span class="dv">1</span>,<span class="dv">2</span>] =<span class="st">  </span><span class="kw">cov</span>(SRN_focal1[j,], SRN_partner2s[j,])<span class="op">/</span><span class="kw">var</span>(SRN_focal1[j,])</span>
<span id="cb24-39"><a href="sam-coding-tutorial.html#cb24-39"></a>            <span class="co">#psi&#39; ~ psi</span></span>
<span id="cb24-40"><a href="sam-coding-tutorial.html#cb24-40"></a>            Beta_mat[<span class="dv">2</span>,<span class="dv">2</span>] =<span class="st">  </span><span class="kw">cov</span>(SRN_focal2[j,], SRN_partner2s[j,])<span class="op">/</span><span class="kw">var</span>(SRN_focal2[j,])</span>
<span id="cb24-41"><a href="sam-coding-tutorial.html#cb24-41"></a>            </span>
<span id="cb24-42"><a href="sam-coding-tutorial.html#cb24-42"></a>            Beta_alpha[[j]] =<span class="st"> </span>Beta_mat</span>
<span id="cb24-43"><a href="sam-coding-tutorial.html#cb24-43"></a>    } </span>
<span id="cb24-44"><a href="sam-coding-tutorial.html#cb24-44"></a></span>
<span id="cb24-45"><a href="sam-coding-tutorial.html#cb24-45"></a>    <span class="co">#extract beta_psi&#39;psi (assortment on social plasticity)</span></span>
<span id="cb24-46"><a href="sam-coding-tutorial.html#cb24-46"></a>    Beta_psi =<span class="st"> </span><span class="kw">unlist</span>(<span class="kw">lapply</span>(Beta_alpha, <span class="cf">function</span>(x) x[<span class="dv">2</span>,<span class="dv">2</span>]))</span></code></pre></div>
</div>
<div id="selection-differentials" class="section level2">
<h2><span class="header-section-number">2.3</span> Selection differentials</h2>
<p>…</p>
<div class="sourceCode" id="cb25"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb25-1"><a href="sam-coding-tutorial.html#cb25-1"></a><span class="co">#generate other relevant matrices</span></span>
<span id="cb25-2"><a href="sam-coding-tutorial.html#cb25-2"></a>    Beta_N =<span class="st"> </span><span class="kw">matrix</span>(<span class="kw">c</span>(post<span class="op">$</span>beta_N1,post<span class="op">$</span>beta_N2),<span class="dt">ncol=</span><span class="dv">2</span>)</span>
<span id="cb25-3"><a href="sam-coding-tutorial.html#cb25-3"></a>    Beta_S =<span class="st"> </span><span class="kw">matrix</span>(<span class="kw">c</span>(post<span class="op">$</span>beta_S1,post<span class="op">$</span>beta_S2),<span class="dt">ncol=</span><span class="dv">2</span>)</span>
<span id="cb25-4"><a href="sam-coding-tutorial.html#cb25-4"></a>    P =<span class="st"> </span>post<span class="op">$</span>Pcov</span>
<span id="cb25-5"><a href="sam-coding-tutorial.html#cb25-5"></a>    G =<span class="st"> </span>post<span class="op">$</span>Gcov</span>
<span id="cb25-6"><a href="sam-coding-tutorial.html#cb25-6"></a></span>
<span id="cb25-7"><a href="sam-coding-tutorial.html#cb25-7"></a>    <span class="co">#selection differential</span></span>
<span id="cb25-8"><a href="sam-coding-tutorial.html#cb25-8"></a></span>
<span id="cb25-9"><a href="sam-coding-tutorial.html#cb25-9"></a>    <span class="co">#initialize dataframe</span></span>
<span id="cb25-10"><a href="sam-coding-tutorial.html#cb25-10"></a>    s_SRN =<span class="st"> </span><span class="kw">data.frame</span>(<span class="dt">s_mu =</span> <span class="kw">rep</span>(<span class="ot">NA</span>,<span class="kw">nrow</span>(Beta_N)), <span class="dt">s_psi =</span> <span class="kw">rep</span>(<span class="ot">NA</span>,<span class="kw">nrow</span>(Beta_N)))</span>
<span id="cb25-11"><a href="sam-coding-tutorial.html#cb25-11"></a>   </span>
<span id="cb25-12"><a href="sam-coding-tutorial.html#cb25-12"></a>    <span class="co">#populate with selection differentials</span></span>
<span id="cb25-13"><a href="sam-coding-tutorial.html#cb25-13"></a>    <span class="cf">for</span>(j <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span><span class="kw">nrow</span>(P)){</span>
<span id="cb25-14"><a href="sam-coding-tutorial.html#cb25-14"></a>      s_SRN[j,] =<span class="st"> </span>P[j,,] <span class="op">%*%</span><span class="st"> </span><span class="kw">t</span>(<span class="kw">t</span>(Beta_N[j,])) <span class="op">+</span><span class="st"> </span><span class="kw">diag</span>(<span class="kw">diag</span>(P[j,,]),<span class="dv">2</span>,) <span class="op">%*%</span><span class="st"> </span>Beta_alpha[[j]] <span class="op">%*%</span><span class="st"> </span><span class="kw">t</span>(<span class="kw">t</span>(Beta_S[j,])) }</span></code></pre></div>
</div>
<div id="the-response-to-selection" class="section level2">
<h2><span class="header-section-number">2.4</span> The response to selection</h2>
<p>…</p>
<div class="sourceCode" id="cb26"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb26-1"><a href="sam-coding-tutorial.html#cb26-1"></a>    <span class="co">#response to selection</span></span>
<span id="cb26-2"><a href="sam-coding-tutorial.html#cb26-2"></a></span>
<span id="cb26-3"><a href="sam-coding-tutorial.html#cb26-3"></a>    <span class="co">#initialize dataframe</span></span>
<span id="cb26-4"><a href="sam-coding-tutorial.html#cb26-4"></a>    response_SRN =<span class="st"> </span><span class="kw">data.frame</span>(<span class="dt">delta_mu=</span> <span class="kw">rep</span>(<span class="ot">NA</span>,<span class="kw">nrow</span>(Beta_N)), <span class="dt">delta_psi =</span> <span class="kw">rep</span>(<span class="ot">NA</span>,<span class="kw">nrow</span>(Beta_N)))</span>
<span id="cb26-5"><a href="sam-coding-tutorial.html#cb26-5"></a></span>
<span id="cb26-6"><a href="sam-coding-tutorial.html#cb26-6"></a>    <span class="co">#populate with response to selection</span></span>
<span id="cb26-7"><a href="sam-coding-tutorial.html#cb26-7"></a>    <span class="cf">for</span>(j <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span><span class="kw">nrow</span>(G)){</span>
<span id="cb26-8"><a href="sam-coding-tutorial.html#cb26-8"></a>    response_SRN[j,] =<span class="st"> </span>G[j,,] <span class="op">%*%</span><span class="st"> </span><span class="kw">t</span>(<span class="kw">t</span>(Beta_N[j,])) <span class="op">+</span><span class="st"> </span><span class="kw">diag</span>(<span class="kw">diag</span>(G[j,,]),<span class="dv">2</span>,) <span class="op">%*%</span><span class="st"> </span>Beta_alpha[[j]] <span class="op">%*%</span><span class="st"> </span><span class="kw">t</span>(<span class="kw">t</span>(Beta_S[j,]))  }</span></code></pre></div>

</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="using-stan-in-r.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="extending-sams.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": null,
"text": null
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": ["SAMs.pdf", "SAMs.epub"],
"toc": {
"collapse": "subsection"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
