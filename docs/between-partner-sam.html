<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>3 Between partner SAM | Estimating Social Animal Models in Stan</title>
  <meta name="description" content="3 Between partner SAM | Estimating Social Animal Models in Stan" />
  <meta name="generator" content="bookdown 0.22 and GitBook 2.6.7" />

  <meta property="og:title" content="3 Between partner SAM | Estimating Social Animal Models in Stan" />
  <meta property="og:type" content="book" />
  
  
  
  

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="3 Between partner SAM | Estimating Social Animal Models in Stan" />
  
  
  

<meta name="author" content="Jordan S. Martin &amp; Adrian V. Jaeggi" />


<meta name="date" content="2021-07-10" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="within-partner-sam.html"/>
<link rel="next" href="within-and-between-partner-sam.html"/>
<script src="libs/header-attrs-2.8/header-attrs.js"></script>
<script src="libs/jquery-2.2.3/jquery.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />









<link href="libs/anchor-sections-1.0.1/anchor-sections.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.0.1/anchor-sections.js"></script>


<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<style type="text/css">
/* Used with Pandoc 2.11+ new --citeproc when CSL is used */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
}
.hanging div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}
</style>

<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li class="chapter" data-level="" data-path="introduction.html"><a href="introduction.html"><i class="fa fa-check"></i>Introduction</a></li>
<li class="chapter" data-level="1" data-path="using-stan-in-r.html"><a href="using-stan-in-r.html"><i class="fa fa-check"></i><b>1</b> Using Stan in R</a>
<ul>
<li class="chapter" data-level="1.1" data-path="using-stan-in-r.html"><a href="using-stan-in-r.html#why-stan"><i class="fa fa-check"></i><b>1.1</b> Why Stan?</a></li>
<li class="chapter" data-level="1.2" data-path="using-stan-in-r.html"><a href="using-stan-in-r.html#getting-started"><i class="fa fa-check"></i><b>1.2</b> Getting Started</a></li>
<li class="chapter" data-level="1.3" data-path="using-stan-in-r.html"><a href="using-stan-in-r.html#bayesian-inference"><i class="fa fa-check"></i><b>1.3</b> Bayesian inference</a></li>
<li class="chapter" data-level="1.4" data-path="using-stan-in-r.html"><a href="using-stan-in-r.html#basic-coding-tutorial"><i class="fa fa-check"></i><b>1.4</b> Basic coding tutorial</a>
<ul>
<li class="chapter" data-level="1.4.1" data-path="using-stan-in-r.html"><a href="using-stan-in-r.html#cholesky-decompositions"><i class="fa fa-check"></i><b>1.4.1</b> Cholesky decompositions</a></li>
<li class="chapter" data-level="1.4.2" data-path="using-stan-in-r.html"><a href="using-stan-in-r.html#non-centered-random-effects"><i class="fa fa-check"></i><b>1.4.2</b> Non-centered random effects</a></li>
</ul></li>
<li class="chapter" data-level="1.5" data-path="using-stan-in-r.html"><a href="using-stan-in-r.html#animal-models"><i class="fa fa-check"></i><b>1.5</b> Animal models</a>
<ul>
<li class="chapter" data-level="1.5.1" data-path="using-stan-in-r.html"><a href="using-stan-in-r.html#simulate-data"><i class="fa fa-check"></i><b>1.5.1</b> Simulate data</a></li>
<li class="chapter" data-level="1.5.2" data-path="using-stan-in-r.html"><a href="using-stan-in-r.html#kronecker-products"><i class="fa fa-check"></i><b>1.5.2</b> Kronecker products</a></li>
<li class="chapter" data-level="1.5.3" data-path="using-stan-in-r.html"><a href="using-stan-in-r.html#identifying-genetic-effects"><i class="fa fa-check"></i><b>1.5.3</b> Identifying genetic effects</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="2" data-path="within-partner-sam.html"><a href="within-partner-sam.html"><i class="fa fa-check"></i><b>2</b> Within partner SAM</a>
<ul>
<li class="chapter" data-level="2.1" data-path="within-partner-sam.html"><a href="within-partner-sam.html#formal-overview"><i class="fa fa-check"></i><b>2.1</b> Formal overview</a></li>
<li class="chapter" data-level="2.2" data-path="within-partner-sam.html"><a href="within-partner-sam.html#computational-approach"><i class="fa fa-check"></i><b>2.2</b> Computational approach</a></li>
<li class="chapter" data-level="2.3" data-path="within-partner-sam.html"><a href="within-partner-sam.html#simulate-data-1"><i class="fa fa-check"></i><b>2.3</b> Simulate data</a>
<ul>
<li class="chapter" data-level="2.3.1" data-path="within-partner-sam.html"><a href="within-partner-sam.html#srn-parameters"><i class="fa fa-check"></i><b>2.3.1</b> SRN parameters</a></li>
<li class="chapter" data-level="2.3.2" data-path="within-partner-sam.html"><a href="within-partner-sam.html#assortment"><i class="fa fa-check"></i><b>2.3.2</b> Assortment</a></li>
<li class="chapter" data-level="2.3.3" data-path="within-partner-sam.html"><a href="within-partner-sam.html#repeated-measurements-within-the-partner"><i class="fa fa-check"></i><b>2.3.3</b> Repeated measurements within the partner</a></li>
</ul></li>
<li class="chapter" data-level="2.4" data-path="within-partner-sam.html"><a href="within-partner-sam.html#coding-the-model"><i class="fa fa-check"></i><b>2.4</b> Coding the model</a></li>
<li class="chapter" data-level="2.5" data-path="within-partner-sam.html"><a href="within-partner-sam.html#estimating-the-model"><i class="fa fa-check"></i><b>2.5</b> Estimating the model</a></li>
<li class="chapter" data-level="2.6" data-path="within-partner-sam.html"><a href="within-partner-sam.html#failure-to-detect-assortment"><i class="fa fa-check"></i><b>2.6</b> Failure to detect assortment</a></li>
<li class="chapter" data-level="2.7" data-path="within-partner-sam.html"><a href="within-partner-sam.html#phenotypic-model"><i class="fa fa-check"></i><b>2.7</b> Phenotypic model</a></li>
</ul></li>
<li class="chapter" data-level="3" data-path="between-partner-sam.html"><a href="between-partner-sam.html"><i class="fa fa-check"></i><b>3</b> Between partner SAM</a>
<ul>
<li class="chapter" data-level="3.1" data-path="between-partner-sam.html"><a href="between-partner-sam.html#simulate-data-2"><i class="fa fa-check"></i><b>3.1</b> Simulate data</a></li>
<li class="chapter" data-level="3.2" data-path="between-partner-sam.html"><a href="between-partner-sam.html#estimate-the-model"><i class="fa fa-check"></i><b>3.2</b> Estimate the model</a></li>
<li class="chapter" data-level="3.3" data-path="between-partner-sam.html"><a href="between-partner-sam.html#estimating-assortment"><i class="fa fa-check"></i><b>3.3</b> Estimating assortment</a></li>
<li class="chapter" data-level="3.4" data-path="between-partner-sam.html"><a href="between-partner-sam.html#phenotypic-model-1"><i class="fa fa-check"></i><b>3.4</b> Phenotypic model</a></li>
</ul></li>
<li class="chapter" data-level="4" data-path="within-and-between-partner-sam.html"><a href="within-and-between-partner-sam.html"><i class="fa fa-check"></i><b>4</b> Within-and-between partner SAM</a>
<ul>
<li class="chapter" data-level="4.1" data-path="within-and-between-partner-sam.html"><a href="within-and-between-partner-sam.html#simulate-data-3"><i class="fa fa-check"></i><b>4.1</b> Simulate data</a></li>
<li class="chapter" data-level="4.2" data-path="within-and-between-partner-sam.html"><a href="within-and-between-partner-sam.html#estimate-the-model-1"><i class="fa fa-check"></i><b>4.2</b> Estimate the model</a></li>
<li class="chapter" data-level="4.3" data-path="within-and-between-partner-sam.html"><a href="within-and-between-partner-sam.html#estimating-assortment-1"><i class="fa fa-check"></i><b>4.3</b> Estimating assortment</a></li>
<li class="chapter" data-level="4.4" data-path="within-and-between-partner-sam.html"><a href="within-and-between-partner-sam.html#phenotypic-model-2"><i class="fa fa-check"></i><b>4.4</b> Phenotypic model</a></li>
</ul></li>
<li class="chapter" data-level="5" data-path="fitness-model.html"><a href="fitness-model.html"><i class="fa fa-check"></i><b>5</b> Fitness model</a>
<ul>
<li class="chapter" data-level="5.1" data-path="fitness-model.html"><a href="fitness-model.html#simulate-data-4"><i class="fa fa-check"></i><b>5.1</b> Simulate data</a></li>
<li class="chapter" data-level="5.2" data-path="fitness-model.html"><a href="fitness-model.html#estimating-the-model-1"><i class="fa fa-check"></i><b>5.2</b> Estimating the model</a></li>
<li class="chapter" data-level="5.3" data-path="fitness-model.html"><a href="fitness-model.html#estimating-assortment-2"><i class="fa fa-check"></i><b>5.3</b> Estimating assortment</a></li>
<li class="chapter" data-level="5.4" data-path="fitness-model.html"><a href="fitness-model.html#estimating-selection-differentials-and-genetic-responses"><i class="fa fa-check"></i><b>5.4</b> Estimating selection differentials and genetic responses</a></li>
</ul></li>
<li class="chapter" data-level="6" data-path="extending-sams.html"><a href="extending-sams.html"><i class="fa fa-check"></i><b>6</b> Extending SAMs</a></li>
<li class="chapter" data-level="" data-path="resources.html"><a href="resources.html"><i class="fa fa-check"></i>Resources</a></li>
</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Estimating Social Animal Models in Stan</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="between-partner-sam" class="section level1" number="3">
<h1><span class="header-section-number">3</span> Between partner SAM</h1>
<p>Here we modify the within partner SAM for a between partner study design without repeated measures within partners. As explained in the main text [<span class="citation"><a href="#ref-SAM" role="doc-biblioref">Martin and Jaeggi</a> (<a href="#ref-SAM" role="doc-biblioref">2021</a>)</span>; see <strong>Eq 3.2</strong>], this model can be considered as a simplification of the within partner model to remove feedback effects within partners (i.e. <span class="math inline">\(t=1\)</span>). We therefore avoid repeating the detailed commentary on the formal and computational aspects of the model provided in the previous chapter. In contrast to within partner SAM, which fails to properly estimate assortment (<a href="within-partner-sam.html#failure-to-detect-assortment">2.6</a>), a between partner SAM can be used to effectively partition assortment on SRN parameters using within-individual centering.</p>
<p>The between partner SAM for a measurement <span class="math inline">\(i\)</span> of aggression <span class="math inline">\(z_{ijt=1}\)</span> in focal individual <span class="math inline">\(j\)</span> during a single interaction period <span class="math inline">\(t=1\)</span> is given by</p>
<p><span class="math display">\[z_{ijt=1} = \mu_0 + \eta_{ijt=1} + \epsilon_{ijt=1}\]</span>
<span class="math display">\[\eta_{ijt=1} = \mu_j + \left( \psi_1 + \psi_j \right)\mu_k&#39;\]</span>
<span class="math display">\[\mu_j = \mu_{\mathrm{A}j} + \mu_{\mathrm{E}j}, \quad  \psi_j = \psi_{\mathrm{A}j} + \psi_{\mathrm{E}j}\]</span>
Note that the SRN measurement simply reduces to the residual trait value <span class="math inline">\(\epsilon_{ijt=1}\)</span> because there is no temporal information for partitioning residual feedback effects. When there individuals are non-randomly distributed across social partners (e.g. due to assortment), the SRN trait value should instead be decomposed into within <span class="math inline">\(\eta_{W}\)</span> and between <span class="math inline">\(\eta_{B}\)</span> partner components to adjust for unbalanced sampling</p>
<p><span class="math display">\[\eta_{Wijt=1} = \mu_j + \left( \psi_1 + \psi_j \right) \left( \mu_k&#39; - \bar{\mu}&#39;_K \right)\]</span>
<span class="math display">\[\eta_{Bijt=1} =\left( \psi_1 + \psi_j \right) \bar{\mu}&#39;_K \]</span>
where <span class="math inline">\(\bar{\mu}&#39;_K\)</span> is the average SRN intercept of an individual’s social partners. To appropriately adjust the intrinsic SRN parameters for the between-partner component, we need to introduce an additional regression parameter <span class="math inline">\(\beta_{B}\)</span> so that</p>
<p><span class="math display">\[z_{ijt=1} = \mu_0 + \eta_{Wijt=1} + \beta_{B}\eta_{Bijt=1} + \epsilon_{ijt=1}\]</span></p>
<p>The equivalent specification can be given for the social partner’s aggression measure <span class="math inline">\(z_{ikt=1}&#39;\)</span></p>
<p><span class="math display">\[z_{ikt=1}&#39; = \mu_0 + \eta_{Wikt=1}&#39; +  \beta_{B}\eta_{Bikt=1}&#39; + \epsilon_{ikt=1}&#39;\]</span>
<span class="math display">\[\eta_{Wikt=1}&#39; = \mu_k&#39; + \left( \psi_1 + \psi_k&#39; \right) \left( \mu_j - \bar{\mu}_J \right) \]</span>
<span class="math display">\[\eta_{Bikt=1}&#39; = \mu_k&#39; + \left( \psi_1 + \psi_k&#39; \right) \bar{\mu}_J\]</span>
<span class="math display">\[\mu_k&#39; = \mu_{\mathrm{A}k}&#39; + \mu_{\mathrm{E}j}&#39;, \quad  \psi_k&#39; = \psi_{\mathrm{A}k}&#39; + \psi_{\mathrm{E}k}&#39;\]</span>
The random effects are assumed to be well-described by multivariate normal distributions.</p>
<p><span class="math display">\[\begin{bmatrix} \boldsymbol{\mu_{\mathrm{A}}}, \boldsymbol{\mu&#39;_{\mathrm{A}}},\boldsymbol{\psi_{\mathrm{A}}},\boldsymbol{\psi}&#39;_{\mathrm{A}}  \end{bmatrix}^{\mathrm{T}} \sim \mathrm{MVNormal}(\boldsymbol{0}, \boldsymbol{\mathrm{G}} \otimes \boldsymbol{\mathrm{A}} ) \]</span>
<span class="math display">\[\begin{bmatrix} \boldsymbol{\mu_{\mathrm{E}}}, \boldsymbol{\mu&#39;_{\mathrm{E}}},\boldsymbol{\psi_{\mathrm{E}}},\boldsymbol{\psi}&#39;_{\mathrm{E}}  \end{bmatrix}^{\mathrm{T}} \sim \mathrm{MVNormal}(\boldsymbol{0}, \boldsymbol{\mathrm{E}} \otimes \boldsymbol{\mathrm{I}} ) \]</span>
<span class="math display">\[\begin{bmatrix} \boldsymbol{\epsilon}, \boldsymbol{\epsilon}&#39; \end{bmatrix}^{\mathrm{T}} \sim \mathrm{MVNormal}(\boldsymbol{0}, \boldsymbol{\mathrm{\Sigma}} ) \]</span>
We also assume that the social reaction norm (SRN) intercept and slope (co)variances are equivalent for focal (<span class="math inline">\(\boldsymbol{\mu},\boldsymbol{\psi}\)</span>) and social partners (<span class="math inline">\(\boldsymbol{\mu}&#39;,\boldsymbol{\psi}&#39;\)</span>). The <span class="math inline">\(\boldsymbol{G}\)</span> matrix can therefore be reduced to a 2x2 matrix for all individuals in the population</p>
<p><span class="math display">\[\boldsymbol{\mathrm{G}}= \begin{bmatrix} \mathrm{var([\boldsymbol{\mu},\boldsymbol{\mu}&#39;])} &amp; \mathrm{cov([\boldsymbol{\mu},\boldsymbol{\mu}&#39;],[\boldsymbol{\psi},\boldsymbol{\psi}&#39;])} \\ \mathrm{cov([\boldsymbol{\psi},\boldsymbol{\psi}&#39;],[\boldsymbol{\mu},\boldsymbol{\mu}&#39;])} &amp;
\mathrm{var([\boldsymbol{\psi},\boldsymbol{\psi}&#39;])} \end{bmatrix}\]</span></p>
<p>The residual matrix <span class="math inline">\(\boldsymbol{\Sigma}\)</span> estimates the association among focal and social partners’ residuals.</p>
<p><span class="math display">\[\boldsymbol{\Sigma}= \begin{bmatrix} \mathrm{var(\boldsymbol{\epsilon})} &amp; \mathrm{cov}(\boldsymbol{\epsilon},\boldsymbol{\epsilon}&#39;) \\ 
\mathrm{cov}(\boldsymbol{\epsilon}&#39;,\boldsymbol{\epsilon}) &amp;
\mathrm{var(\boldsymbol{\epsilon&#39;})}     \end{bmatrix}\]</span>
This model is, therefore, appropriate for situations where the distinction between focal and partner is semi-arbitrary, e.g. when measuring within-sex interactions or when males and females exhibit similar patterns of phenotypic variation. In this case, we make the latter assumption for simplicity. To account for differences between the responses of focal individuals and social partners, the model can simply be extended with additional parameters, e.g. specifying separate <span class="math inline">\(G_M\)</span> and <span class="math inline">\(G_F\)</span> matrices for males and female respective genetic (co)variances and so on.</p>
<div id="simulate-data-2" class="section level2" number="3.1">
<h2><span class="header-section-number">3.1</span> Simulate data</h2>
<p>We now need to simulate interactions across multiple partners. Fortunately, we follow the same basic approach as the previous chapter, including use of the the custom <code>pedfun()</code> function introduced in Ch. <a href="using-stan-in-r.html#animal-models">1.5</a> for generating a genetic VCV. For heuristic purposes, we can consider our simulation as capturing interactions and assortment of each individual with four lifetime partners.</p>
<div class="sourceCode" id="cb111"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb111-1"><a href="between-partner-sam.html#cb111-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(mvtnorm)</span>
<span id="cb111-2"><a href="between-partner-sam.html#cb111-2" aria-hidden="true" tabindex="-1"></a><span class="co">#common settings</span></span>
<span id="cb111-3"><a href="between-partner-sam.html#cb111-3" aria-hidden="true" tabindex="-1"></a>I_partner <span class="ot">=</span> <span class="dv">4</span> <span class="co">#partners/individual</span></span>
<span id="cb111-4"><a href="between-partner-sam.html#cb111-4" aria-hidden="true" tabindex="-1"></a>I_obs <span class="ot">=</span> <span class="dv">1</span> <span class="co">#observations/individual/seasonal partner</span></span>
<span id="cb111-5"><a href="between-partner-sam.html#cb111-5" aria-hidden="true" tabindex="-1"></a>I_sample <span class="ot">=</span> I_partner<span class="sc">*</span>I_obs <span class="co">#samples/individual</span></span>
<span id="cb111-6"><a href="between-partner-sam.html#cb111-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb111-7"><a href="between-partner-sam.html#cb111-7" aria-hidden="true" tabindex="-1"></a><span class="co">#population properties</span></span>
<span id="cb111-8"><a href="between-partner-sam.html#cb111-8" aria-hidden="true" tabindex="-1"></a>I <span class="ot">=</span> <span class="dv">300</span> <span class="co">#total individuals for simulation</span></span>
<span id="cb111-9"><a href="between-partner-sam.html#cb111-9" aria-hidden="true" tabindex="-1"></a>popmin<span class="ot">=</span><span class="dv">400</span></span>
<span id="cb111-10"><a href="between-partner-sam.html#cb111-10" aria-hidden="true" tabindex="-1"></a>popmax<span class="ot">=</span><span class="dv">600</span></span>
<span id="cb111-11"><a href="between-partner-sam.html#cb111-11" aria-hidden="true" tabindex="-1"></a>ngenerations <span class="ot">=</span> <span class="dv">10</span></span>
<span id="cb111-12"><a href="between-partner-sam.html#cb111-12" aria-hidden="true" tabindex="-1"></a>nids<span class="ot">&lt;-</span><span class="fu">sample</span>(popmin<span class="sc">:</span>popmax, ngenerations, <span class="at">replace=</span><span class="cn">TRUE</span>) <span class="co">#N / generation</span></span>
<span id="cb111-13"><a href="between-partner-sam.html#cb111-13" aria-hidden="true" tabindex="-1"></a>epm <span class="ot">=</span> <span class="fu">sample</span>(<span class="fu">seq</span>(<span class="fl">0.15</span>, <span class="fl">0.25</span>,<span class="at">by=</span><span class="fl">0.05</span>),<span class="dv">1</span>) <span class="co">#extra-pair mating</span></span>
<span id="cb111-14"><a href="between-partner-sam.html#cb111-14" aria-hidden="true" tabindex="-1"></a>nonb <span class="ot">=</span> <span class="fu">sample</span>(<span class="fu">seq</span>(<span class="fl">0.4</span>,<span class="fl">0.6</span>,<span class="at">by=</span><span class="fl">0.05</span>),<span class="dv">1</span>) <span class="co">#proportion of non-breeding / generation</span></span>
<span id="cb111-15"><a href="between-partner-sam.html#cb111-15" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb111-16"><a href="between-partner-sam.html#cb111-16" aria-hidden="true" tabindex="-1"></a><span class="co">#relatedness matrix</span></span>
<span id="cb111-17"><a href="between-partner-sam.html#cb111-17" aria-hidden="true" tabindex="-1"></a>A_mat <span class="ot">&lt;-</span> <span class="fu">pedfun</span>(<span class="at">popmin=</span>popmin, <span class="at">popmax=</span>popmax, <span class="at">ngenerations=</span>ngenerations,</span>
<span id="cb111-18"><a href="between-partner-sam.html#cb111-18" aria-hidden="true" tabindex="-1"></a>                  <span class="at">epm=</span>epm, <span class="at">nonb=</span>nonb, <span class="at">nids=</span>nids, <span class="at">I=</span>I, <span class="at">missing=</span><span class="cn">FALSE</span>)</span>
<span id="cb111-19"><a href="between-partner-sam.html#cb111-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb111-20"><a href="between-partner-sam.html#cb111-20" aria-hidden="true" tabindex="-1"></a><span class="do">#####################################################################</span></span>
<span id="cb111-21"><a href="between-partner-sam.html#cb111-21" aria-hidden="true" tabindex="-1"></a><span class="co">#Parameter values</span></span>
<span id="cb111-22"><a href="between-partner-sam.html#cb111-22" aria-hidden="true" tabindex="-1"></a><span class="do">#####################################################################</span></span>
<span id="cb111-23"><a href="between-partner-sam.html#cb111-23" aria-hidden="true" tabindex="-1"></a>alpha_0 <span class="ot">=</span> <span class="dv">0</span> <span class="co">#global intercept</span></span>
<span id="cb111-24"><a href="between-partner-sam.html#cb111-24" aria-hidden="true" tabindex="-1"></a>psi_1 <span class="ot">=</span> <span class="sc">-</span><span class="fl">0.5</span> <span class="co">#population interaction coefficient</span></span>
<span id="cb111-25"><a href="between-partner-sam.html#cb111-25" aria-hidden="true" tabindex="-1"></a>phi <span class="ot">=</span>  <span class="fl">0.5</span> <span class="co">#residual feedback coefficient (epsilon_j ~ epsilon_t-1k)</span></span>
<span id="cb111-26"><a href="between-partner-sam.html#cb111-26" aria-hidden="true" tabindex="-1"></a>SD_intercept <span class="ot">=</span> <span class="fl">0.3</span> <span class="co">#standard deviation of SRN intercepts</span></span>
<span id="cb111-27"><a href="between-partner-sam.html#cb111-27" aria-hidden="true" tabindex="-1"></a>SD_slope <span class="ot">=</span> <span class="fl">0.3</span> <span class="co">#SD of SRN slopes</span></span>
<span id="cb111-28"><a href="between-partner-sam.html#cb111-28" aria-hidden="true" tabindex="-1"></a>r_alpha <span class="ot">=</span> <span class="fl">0.3</span> <span class="co">#assortment coefficient (expressed as correlation)</span></span>
<span id="cb111-29"><a href="between-partner-sam.html#cb111-29" aria-hidden="true" tabindex="-1"></a>r_G <span class="ot">=</span> <span class="fl">0.3</span> <span class="co">#genetic correlation of random intercepts and slopes</span></span>
<span id="cb111-30"><a href="between-partner-sam.html#cb111-30" aria-hidden="true" tabindex="-1"></a>r_E <span class="ot">=</span> <span class="fl">0.3</span> <span class="co">#environmental correlation</span></span>
<span id="cb111-31"><a href="between-partner-sam.html#cb111-31" aria-hidden="true" tabindex="-1"></a>r_R <span class="ot">=</span> <span class="sc">-</span><span class="fl">0.3</span> <span class="co">#residual effect correlation (epsilon_tj = epsilon_tk)</span></span>
<span id="cb111-32"><a href="between-partner-sam.html#cb111-32" aria-hidden="true" tabindex="-1"></a>V_G <span class="ot">=</span> <span class="fl">0.3</span> <span class="co">#genetic variance of REs</span></span>
<span id="cb111-33"><a href="between-partner-sam.html#cb111-33" aria-hidden="true" tabindex="-1"></a>V_E <span class="ot">=</span> <span class="fl">0.3</span> <span class="co">#genetic variance of REs</span></span>
<span id="cb111-34"><a href="between-partner-sam.html#cb111-34" aria-hidden="true" tabindex="-1"></a>res_V <span class="ot">=</span> <span class="dv">1</span></span>
<span id="cb111-35"><a href="between-partner-sam.html#cb111-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb111-36"><a href="between-partner-sam.html#cb111-36" aria-hidden="true" tabindex="-1"></a><span class="co">#Random effect correlations</span></span>
<span id="cb111-37"><a href="between-partner-sam.html#cb111-37" aria-hidden="true" tabindex="-1"></a>G_cor <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">c</span>(<span class="dv">1</span>,r_G,r_G,<span class="dv">1</span>), <span class="at">nrow=</span><span class="dv">2</span>, <span class="at">ncol=</span><span class="dv">2</span>) <span class="co">#mu_A, beta_A</span></span>
<span id="cb111-38"><a href="between-partner-sam.html#cb111-38" aria-hidden="true" tabindex="-1"></a>G_sd  <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fu">sqrt</span>(V_G),<span class="fu">sqrt</span>(V_G)) <span class="co">#G effect sds</span></span>
<span id="cb111-39"><a href="between-partner-sam.html#cb111-39" aria-hidden="true" tabindex="-1"></a>G_cov <span class="ot">&lt;-</span> <span class="fu">diag</span>(G_sd) <span class="sc">%*%</span> G_cor <span class="sc">%*%</span> <span class="fu">diag</span>(G_sd)</span>
<span id="cb111-40"><a href="between-partner-sam.html#cb111-40" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb111-41"><a href="between-partner-sam.html#cb111-41" aria-hidden="true" tabindex="-1"></a>E_cor <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">c</span>(<span class="dv">1</span>,r_E,r_E,<span class="dv">1</span>), <span class="at">nrow=</span><span class="dv">2</span>, <span class="at">ncol=</span><span class="dv">2</span>) <span class="co">#mu_E, beta_E</span></span>
<span id="cb111-42"><a href="between-partner-sam.html#cb111-42" aria-hidden="true" tabindex="-1"></a>E_sd  <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fu">sqrt</span>(V_E),<span class="fu">sqrt</span>(V_E)) <span class="co">#E effect sds</span></span>
<span id="cb111-43"><a href="between-partner-sam.html#cb111-43" aria-hidden="true" tabindex="-1"></a>E_cov <span class="ot">&lt;-</span> <span class="fu">diag</span>(E_sd) <span class="sc">%*%</span> E_cor <span class="sc">%*%</span> <span class="fu">diag</span>(E_sd)</span>
<span id="cb111-44"><a href="between-partner-sam.html#cb111-44" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb111-45"><a href="between-partner-sam.html#cb111-45" aria-hidden="true" tabindex="-1"></a><span class="co">#matrices</span></span>
<span id="cb111-46"><a href="between-partner-sam.html#cb111-46" aria-hidden="true" tabindex="-1"></a>G_block <span class="ot">&lt;-</span> G_cov <span class="sc">%x%</span> A_mat</span>
<span id="cb111-47"><a href="between-partner-sam.html#cb111-47" aria-hidden="true" tabindex="-1"></a>E_block <span class="ot">&lt;-</span> E_cov <span class="sc">%x%</span> <span class="fu">diag</span>(<span class="dv">1</span>,I)</span>
<span id="cb111-48"><a href="between-partner-sam.html#cb111-48" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb111-49"><a href="between-partner-sam.html#cb111-49" aria-hidden="true" tabindex="-1"></a><span class="co">#generate correlated REs</span></span>
<span id="cb111-50"><a href="between-partner-sam.html#cb111-50" aria-hidden="true" tabindex="-1"></a>Gvalues <span class="ot">&lt;-</span> <span class="fu">rmvnorm</span>(<span class="dv">1</span>, <span class="at">mean=</span><span class="fu">rep</span>(<span class="dv">0</span>,I<span class="sc">*</span><span class="dv">2</span>), <span class="at">sigma=</span>G_block)</span>
<span id="cb111-51"><a href="between-partner-sam.html#cb111-51" aria-hidden="true" tabindex="-1"></a>G_val <span class="ot">=</span> <span class="fu">data.frame</span>(<span class="fu">matrix</span>(Gvalues, <span class="at">nrow=</span>I, <span class="at">ncol=</span><span class="dv">2</span>))</span>
<span id="cb111-52"><a href="between-partner-sam.html#cb111-52" aria-hidden="true" tabindex="-1"></a><span class="fu">cor</span>(G_val)</span></code></pre></div>
<pre><code>##           X1        X2
## X1 1.0000000 0.2393461
## X2 0.2393461 1.0000000</code></pre>
<div class="sourceCode" id="cb113"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb113-1"><a href="between-partner-sam.html#cb113-1" aria-hidden="true" tabindex="-1"></a>Evalues <span class="ot">&lt;-</span> <span class="fu">rmvnorm</span>(<span class="dv">1</span>, <span class="at">mean=</span><span class="fu">rep</span>(<span class="dv">0</span>,I<span class="sc">*</span><span class="dv">2</span>), <span class="at">sigma=</span>E_block)</span>
<span id="cb113-2"><a href="between-partner-sam.html#cb113-2" aria-hidden="true" tabindex="-1"></a>E_val <span class="ot">=</span> <span class="fu">data.frame</span>(<span class="fu">matrix</span>(Evalues, <span class="at">nrow=</span>I, <span class="at">ncol=</span><span class="dv">2</span>))</span>
<span id="cb113-3"><a href="between-partner-sam.html#cb113-3" aria-hidden="true" tabindex="-1"></a><span class="fu">cor</span>(E_val)</span></code></pre></div>
<pre><code>##          X1       X2
## X1 1.000000 0.237784
## X2 0.237784 1.000000</code></pre>
<div class="sourceCode" id="cb115"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb115-1"><a href="between-partner-sam.html#cb115-1" aria-hidden="true" tabindex="-1"></a><span class="co">#combine temporary object for all SRN parameters</span></span>
<span id="cb115-2"><a href="between-partner-sam.html#cb115-2" aria-hidden="true" tabindex="-1"></a><span class="co">#use shorthand mu = 0, psi = 1</span></span>
<span id="cb115-3"><a href="between-partner-sam.html#cb115-3" aria-hidden="true" tabindex="-1"></a>P <span class="ot">=</span> <span class="fu">cbind</span>(G_val,E_val)</span>
<span id="cb115-4"><a href="between-partner-sam.html#cb115-4" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(P) <span class="ot">=</span> <span class="fu">c</span>(<span class="st">&quot;A0&quot;</span>, <span class="st">&quot;A1&quot;</span>, <span class="st">&quot;E0&quot;</span>, <span class="st">&quot;E1&quot;</span>)</span>
<span id="cb115-5"><a href="between-partner-sam.html#cb115-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-6"><a href="between-partner-sam.html#cb115-6" aria-hidden="true" tabindex="-1"></a><span class="co">#individual phenotypic REs</span></span>
<span id="cb115-7"><a href="between-partner-sam.html#cb115-7" aria-hidden="true" tabindex="-1"></a><span class="co">#use shorthand mu = 0, psi = 1</span></span>
<span id="cb115-8"><a href="between-partner-sam.html#cb115-8" aria-hidden="true" tabindex="-1"></a>P<span class="sc">$</span>P0 <span class="ot">=</span> P<span class="sc">$</span>A0 <span class="sc">+</span> P<span class="sc">$</span>E0 </span>
<span id="cb115-9"><a href="between-partner-sam.html#cb115-9" aria-hidden="true" tabindex="-1"></a>P<span class="sc">$</span>P1 <span class="ot">=</span> P<span class="sc">$</span>A1 <span class="sc">+</span> P<span class="sc">$</span>E1</span>
<span id="cb115-10"><a href="between-partner-sam.html#cb115-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-11"><a href="between-partner-sam.html#cb115-11" aria-hidden="true" tabindex="-1"></a><span class="co">#add ID</span></span>
<span id="cb115-12"><a href="between-partner-sam.html#cb115-12" aria-hidden="true" tabindex="-1"></a>P<span class="sc">$</span>ID <span class="ot">=</span> <span class="fu">seq</span>(<span class="dv">1</span><span class="sc">:</span>I)</span></code></pre></div>
<p>The assortment procedure is fundamentally the same but now considers multiple partners.</p>
<div class="sourceCode" id="cb116"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb116-1"><a href="between-partner-sam.html#cb116-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb116-2"><a href="between-partner-sam.html#cb116-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(MASS)</span>
<span id="cb116-3"><a href="between-partner-sam.html#cb116-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb116-4"><a href="between-partner-sam.html#cb116-4" aria-hidden="true" tabindex="-1"></a>pairs <span class="ot">=</span> <span class="fu">list</span>()</span>
<span id="cb116-5"><a href="between-partner-sam.html#cb116-5" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (j <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>I_partner){</span>
<span id="cb116-6"><a href="between-partner-sam.html#cb116-6" aria-hidden="true" tabindex="-1"></a>    <span class="co">#male RN intercept (x I_partner for multiple lifetime partners)</span></span>
<span id="cb116-7"><a href="between-partner-sam.html#cb116-7" aria-hidden="true" tabindex="-1"></a>    sort.m <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">P0_m =</span> P<span class="sc">$</span>P0[<span class="dv">1</span><span class="sc">:</span>(I<span class="sc">/</span><span class="dv">2</span>)], <span class="at">ID_m =</span> (<span class="dv">1</span><span class="sc">:</span>(I<span class="sc">/</span><span class="dv">2</span>)) )</span>
<span id="cb116-8"><a href="between-partner-sam.html#cb116-8" aria-hidden="true" tabindex="-1"></a>    sort.m<span class="ot">&lt;-</span>sort.m[<span class="fu">order</span>(sort.m[,<span class="st">&quot;P0_m&quot;</span>]),]</span>
<span id="cb116-9"><a href="between-partner-sam.html#cb116-9" aria-hidden="true" tabindex="-1"></a>    <span class="co">#female phenotypic RN slopes</span></span>
<span id="cb116-10"><a href="between-partner-sam.html#cb116-10" aria-hidden="true" tabindex="-1"></a>    sort.f <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">P0_f =</span> P<span class="sc">$</span>P0[(I<span class="sc">/</span><span class="dv">2</span> <span class="sc">+</span> <span class="dv">1</span>)<span class="sc">:</span>I], <span class="at">ID_f =</span> ((I<span class="sc">/</span><span class="dv">2</span><span class="sc">+</span><span class="dv">1</span>)<span class="sc">:</span>I) )</span>
<span id="cb116-11"><a href="between-partner-sam.html#cb116-11" aria-hidden="true" tabindex="-1"></a>    sort.f<span class="ot">&lt;-</span>sort.f[<span class="fu">order</span>(sort.f[,<span class="st">&quot;P0_f&quot;</span>]),]</span>
<span id="cb116-12"><a href="between-partner-sam.html#cb116-12" aria-hidden="true" tabindex="-1"></a>    <span class="co">#generate random dataset with desired rank-order correlation</span></span>
<span id="cb116-13"><a href="between-partner-sam.html#cb116-13" aria-hidden="true" tabindex="-1"></a>    temp_mat <span class="ot">&lt;-</span> <span class="fu">matrix</span>(r_alpha, <span class="at">ncol =</span> <span class="dv">2</span>, <span class="at">nrow =</span> <span class="dv">2</span>) <span class="co">#cor of male and female values</span></span>
<span id="cb116-14"><a href="between-partner-sam.html#cb116-14" aria-hidden="true" tabindex="-1"></a>    <span class="fu">diag</span>(temp_mat) <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="co">#cor matrix</span></span>
<span id="cb116-15"><a href="between-partner-sam.html#cb116-15" aria-hidden="true" tabindex="-1"></a>    <span class="co">#sim values</span></span>
<span id="cb116-16"><a href="between-partner-sam.html#cb116-16" aria-hidden="true" tabindex="-1"></a>    temp_data1<span class="ot">&lt;-</span> <span class="fu">mvrnorm</span>(<span class="at">n =</span> I<span class="sc">/</span><span class="dv">2</span>, <span class="at">mu =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">0</span>), <span class="at">Sigma =</span> temp_mat, <span class="at">empirical=</span><span class="cn">TRUE</span>)</span>
<span id="cb116-17"><a href="between-partner-sam.html#cb116-17" aria-hidden="true" tabindex="-1"></a>    <span class="co">#ranks of random data</span></span>
<span id="cb116-18"><a href="between-partner-sam.html#cb116-18" aria-hidden="true" tabindex="-1"></a>    rm <span class="ot">&lt;-</span> <span class="fu">rank</span>(temp_data1[ , <span class="dv">1</span>], <span class="at">ties.method =</span> <span class="st">&quot;first&quot;</span>)</span>
<span id="cb116-19"><a href="between-partner-sam.html#cb116-19" aria-hidden="true" tabindex="-1"></a>    rf <span class="ot">&lt;-</span> <span class="fu">rank</span>(temp_data1[ , <span class="dv">2</span>], <span class="at">ties.method =</span> <span class="st">&quot;first&quot;</span>)</span>
<span id="cb116-20"><a href="between-partner-sam.html#cb116-20" aria-hidden="true" tabindex="-1"></a>    <span class="co">#induce cor through rank-ordering of RN vectors</span></span>
<span id="cb116-21"><a href="between-partner-sam.html#cb116-21" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cor</span>(sort.m<span class="sc">$</span>P0_m[rm], sort.f<span class="sc">$</span>P0_f[rf])</span>
<span id="cb116-22"><a href="between-partner-sam.html#cb116-22" aria-hidden="true" tabindex="-1"></a>    <span class="co">#sort partner ids into dataframe</span></span>
<span id="cb116-23"><a href="between-partner-sam.html#cb116-23" aria-hidden="true" tabindex="-1"></a>    partner.id <span class="ot">=</span> <span class="fu">data.frame</span>(<span class="at">ID_m =</span> sort.m<span class="sc">$</span>ID_m[rm], <span class="at">ID_f =</span> sort.f<span class="sc">$</span>ID_f[rf])</span>
<span id="cb116-24"><a href="between-partner-sam.html#cb116-24" aria-hidden="true" tabindex="-1"></a>    partner.id <span class="ot">=</span> partner.id[<span class="fu">order</span>(partner.id[,<span class="st">&quot;ID_m&quot;</span>]),]</span>
<span id="cb116-25"><a href="between-partner-sam.html#cb116-25" aria-hidden="true" tabindex="-1"></a>    <span class="co">#add to list</span></span>
<span id="cb116-26"><a href="between-partner-sam.html#cb116-26" aria-hidden="true" tabindex="-1"></a>    pairs[[j]] <span class="ot">=</span> partner.id</span>
<span id="cb116-27"><a href="between-partner-sam.html#cb116-27" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb116-28"><a href="between-partner-sam.html#cb116-28" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb116-29"><a href="between-partner-sam.html#cb116-29" aria-hidden="true" tabindex="-1"></a>partner.id <span class="ot">=</span> <span class="fu">bind_rows</span>(pairs)</span>
<span id="cb116-30"><a href="between-partner-sam.html#cb116-30" aria-hidden="true" tabindex="-1"></a>partner.id <span class="ot">=</span> partner.id[<span class="fu">order</span>(partner.id<span class="sc">$</span>ID_m),]</span>
<span id="cb116-31"><a href="between-partner-sam.html#cb116-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb116-32"><a href="between-partner-sam.html#cb116-32" aria-hidden="true" tabindex="-1"></a><span class="co">#put all dyads together</span></span>
<span id="cb116-33"><a href="between-partner-sam.html#cb116-33" aria-hidden="true" tabindex="-1"></a>partner.id<span class="sc">$</span>dyadn <span class="ot">=</span> <span class="fu">seq</span>(<span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(partner.id))</span>
<span id="cb116-34"><a href="between-partner-sam.html#cb116-34" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb116-35"><a href="between-partner-sam.html#cb116-35" aria-hidden="true" tabindex="-1"></a><span class="co">#add values back to dataframe (male and joint)</span></span>
<span id="cb116-36"><a href="between-partner-sam.html#cb116-36" aria-hidden="true" tabindex="-1"></a>partner.id<span class="sc">$</span>P0m <span class="ot">&lt;-</span> P<span class="sc">$</span>P0[<span class="fu">match</span>(partner.id<span class="sc">$</span>ID_m,P<span class="sc">$</span>ID)]</span>
<span id="cb116-37"><a href="between-partner-sam.html#cb116-37" aria-hidden="true" tabindex="-1"></a>partner.id<span class="sc">$</span>P0f <span class="ot">&lt;-</span> P<span class="sc">$</span>P0[<span class="fu">match</span>(partner.id<span class="sc">$</span>ID_f,P<span class="sc">$</span>ID)]</span>
<span id="cb116-38"><a href="between-partner-sam.html#cb116-38" aria-hidden="true" tabindex="-1"></a>partner.id<span class="sc">$</span>P1m <span class="ot">&lt;-</span> P<span class="sc">$</span>P1[<span class="fu">match</span>(partner.id<span class="sc">$</span>ID_m,P<span class="sc">$</span>ID)]</span>
<span id="cb116-39"><a href="between-partner-sam.html#cb116-39" aria-hidden="true" tabindex="-1"></a>partner.id<span class="sc">$</span>P1f <span class="ot">&lt;-</span> P<span class="sc">$</span>P1[<span class="fu">match</span>(partner.id<span class="sc">$</span>ID_f,P<span class="sc">$</span>ID)]</span>
<span id="cb116-40"><a href="between-partner-sam.html#cb116-40" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb116-41"><a href="between-partner-sam.html#cb116-41" aria-hidden="true" tabindex="-1"></a>partner.id<span class="sc">$</span>A0m <span class="ot">&lt;-</span> P<span class="sc">$</span>A0[<span class="fu">match</span>(partner.id<span class="sc">$</span>ID_m,P<span class="sc">$</span>ID)]</span>
<span id="cb116-42"><a href="between-partner-sam.html#cb116-42" aria-hidden="true" tabindex="-1"></a>partner.id<span class="sc">$</span>A0f <span class="ot">&lt;-</span> P<span class="sc">$</span>A0[<span class="fu">match</span>(partner.id<span class="sc">$</span>ID_f,P<span class="sc">$</span>ID)]</span>
<span id="cb116-43"><a href="between-partner-sam.html#cb116-43" aria-hidden="true" tabindex="-1"></a>partner.id<span class="sc">$</span>A1m <span class="ot">&lt;-</span> P<span class="sc">$</span>A1[<span class="fu">match</span>(partner.id<span class="sc">$</span>ID_m,P<span class="sc">$</span>ID)]</span>
<span id="cb116-44"><a href="between-partner-sam.html#cb116-44" aria-hidden="true" tabindex="-1"></a>partner.id<span class="sc">$</span>A1f <span class="ot">&lt;-</span> P<span class="sc">$</span>A1[<span class="fu">match</span>(partner.id<span class="sc">$</span>ID_f,P<span class="sc">$</span>ID)]</span>
<span id="cb116-45"><a href="between-partner-sam.html#cb116-45" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb116-46"><a href="between-partner-sam.html#cb116-46" aria-hidden="true" tabindex="-1"></a>partner.id<span class="sc">$</span>E0m <span class="ot">&lt;-</span> P<span class="sc">$</span>E0[<span class="fu">match</span>(partner.id<span class="sc">$</span>ID_m,P<span class="sc">$</span>ID)]</span>
<span id="cb116-47"><a href="between-partner-sam.html#cb116-47" aria-hidden="true" tabindex="-1"></a>partner.id<span class="sc">$</span>E0f <span class="ot">&lt;-</span> P<span class="sc">$</span>E0[<span class="fu">match</span>(partner.id<span class="sc">$</span>ID_f,P<span class="sc">$</span>ID)]</span>
<span id="cb116-48"><a href="between-partner-sam.html#cb116-48" aria-hidden="true" tabindex="-1"></a>partner.id<span class="sc">$</span>E1m <span class="ot">&lt;-</span> P<span class="sc">$</span>E1[<span class="fu">match</span>(partner.id<span class="sc">$</span>ID_m,P<span class="sc">$</span>ID)]</span>
<span id="cb116-49"><a href="between-partner-sam.html#cb116-49" aria-hidden="true" tabindex="-1"></a>partner.id<span class="sc">$</span>E1f <span class="ot">&lt;-</span> P<span class="sc">$</span>E1[<span class="fu">match</span>(partner.id<span class="sc">$</span>ID_f,P<span class="sc">$</span>ID)]</span>
<span id="cb116-50"><a href="between-partner-sam.html#cb116-50" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb116-51"><a href="between-partner-sam.html#cb116-51" aria-hidden="true" tabindex="-1"></a><span class="co">#check correlation again</span></span>
<span id="cb116-52"><a href="between-partner-sam.html#cb116-52" aria-hidden="true" tabindex="-1"></a><span class="fu">cor</span>(partner.id<span class="sc">$</span>P0m, partner.id<span class="sc">$</span>P0f)</span></code></pre></div>
<pre><code>## [1] 0.2906294</code></pre>
<p>We can now calculate observed aggression measures for a single observation within each dyad.</p>
<div class="sourceCode" id="cb118"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb118-1"><a href="between-partner-sam.html#cb118-1" aria-hidden="true" tabindex="-1"></a><span class="co">#number of dyads</span></span>
<span id="cb118-2"><a href="between-partner-sam.html#cb118-2" aria-hidden="true" tabindex="-1"></a>ndyad <span class="ot">=</span> <span class="fu">nrow</span>(partner.id)</span>
<span id="cb118-3"><a href="between-partner-sam.html#cb118-3" aria-hidden="true" tabindex="-1"></a>pair_df <span class="ot">=</span> partner.id <span class="co">#congruent with repeated measures code</span></span>
<span id="cb118-4"><a href="between-partner-sam.html#cb118-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb118-5"><a href="between-partner-sam.html#cb118-5" aria-hidden="true" tabindex="-1"></a><span class="co">#correlated  residuals between male and females</span></span>
<span id="cb118-6"><a href="between-partner-sam.html#cb118-6" aria-hidden="true" tabindex="-1"></a>R_cor <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">c</span>(<span class="dv">1</span>,r_R,r_R,<span class="dv">1</span>), <span class="at">nrow=</span><span class="dv">2</span>, <span class="at">ncol=</span><span class="dv">2</span>)</span>
<span id="cb118-7"><a href="between-partner-sam.html#cb118-7" aria-hidden="true" tabindex="-1"></a>res_sd <span class="ot">&lt;-</span> <span class="fu">sqrt</span>(res_V) </span>
<span id="cb118-8"><a href="between-partner-sam.html#cb118-8" aria-hidden="true" tabindex="-1"></a>R_cov <span class="ot">&lt;-</span> <span class="fu">diag</span>(<span class="fu">c</span>(res_sd,res_sd)) <span class="sc">%*%</span> R_cor <span class="sc">%*%</span> <span class="fu">diag</span>(<span class="fu">c</span>(res_sd,res_sd))</span>
<span id="cb118-9"><a href="between-partner-sam.html#cb118-9" aria-hidden="true" tabindex="-1"></a>res_ind<span class="ot">&lt;-</span><span class="fu">data.frame</span>(<span class="fu">rmvnorm</span>(<span class="fu">nrow</span>(pair_df), <span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">0</span>), R_cov))</span>
<span id="cb118-10"><a href="between-partner-sam.html#cb118-10" aria-hidden="true" tabindex="-1"></a>pair_df<span class="sc">$</span>resAGm <span class="ot">=</span> res_ind<span class="sc">$</span>X1</span>
<span id="cb118-11"><a href="between-partner-sam.html#cb118-11" aria-hidden="true" tabindex="-1"></a>pair_df<span class="sc">$</span>resAGf <span class="ot">=</span> res_ind<span class="sc">$</span>X2</span>
<span id="cb118-12"><a href="between-partner-sam.html#cb118-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb118-13"><a href="between-partner-sam.html#cb118-13" aria-hidden="true" tabindex="-1"></a><span class="co">#add interaction number</span></span>
<span id="cb118-14"><a href="between-partner-sam.html#cb118-14" aria-hidden="true" tabindex="-1"></a>pair_df<span class="sc">$</span>turn <span class="ot">=</span> <span class="fu">rep</span>(<span class="dv">1</span>,ndyad) </span>
<span id="cb118-15"><a href="between-partner-sam.html#cb118-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb118-16"><a href="between-partner-sam.html#cb118-16" aria-hidden="true" tabindex="-1"></a><span class="co">#males</span></span>
<span id="cb118-17"><a href="between-partner-sam.html#cb118-17" aria-hidden="true" tabindex="-1"></a><span class="co">#eta_j{t=1} = mu_j + (psi + psi_j)*mu_k</span></span>
<span id="cb118-18"><a href="between-partner-sam.html#cb118-18" aria-hidden="true" tabindex="-1"></a>pair_df[pair_df<span class="sc">$</span>turn<span class="sc">==</span><span class="dv">1</span>,<span class="st">&quot;eta_m&quot;</span>] <span class="ot">=</span> pair_df[pair_df<span class="sc">$</span>turn<span class="sc">==</span><span class="dv">1</span>,<span class="st">&quot;P0m&quot;</span>] <span class="sc">+</span> </span>
<span id="cb118-19"><a href="between-partner-sam.html#cb118-19" aria-hidden="true" tabindex="-1"></a>                                       (psi_1 <span class="sc">+</span> pair_df[pair_df<span class="sc">$</span>turn<span class="sc">==</span><span class="dv">1</span>,<span class="st">&quot;P1m&quot;</span>])<span class="sc">*</span>(pair_df[pair_df<span class="sc">$</span>turn<span class="sc">==</span><span class="dv">1</span>,<span class="st">&quot;P0f&quot;</span>])</span>
<span id="cb118-20"><a href="between-partner-sam.html#cb118-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb118-21"><a href="between-partner-sam.html#cb118-21" aria-hidden="true" tabindex="-1"></a><span class="co">#females</span></span>
<span id="cb118-22"><a href="between-partner-sam.html#cb118-22" aria-hidden="true" tabindex="-1"></a><span class="co">#eta_k{t=1} = mu_k +(psi + psi_k)*mu_j                                                                                              </span></span>
<span id="cb118-23"><a href="between-partner-sam.html#cb118-23" aria-hidden="true" tabindex="-1"></a>pair_df[pair_df<span class="sc">$</span>turn<span class="sc">==</span><span class="dv">1</span>,<span class="st">&quot;eta_f&quot;</span>] <span class="ot">=</span> pair_df[pair_df<span class="sc">$</span>turn<span class="sc">==</span><span class="dv">1</span>,<span class="st">&quot;P0f&quot;</span>] <span class="sc">+</span> </span>
<span id="cb118-24"><a href="between-partner-sam.html#cb118-24" aria-hidden="true" tabindex="-1"></a>                                        (psi_1 <span class="sc">+</span> pair_df[pair_df<span class="sc">$</span>turn<span class="sc">==</span><span class="dv">1</span>,<span class="st">&quot;P1f&quot;</span>])<span class="sc">*</span>(pair_df[pair_df<span class="sc">$</span>turn<span class="sc">==</span><span class="dv">1</span>,<span class="st">&quot;P0m&quot;</span>])</span>
<span id="cb118-25"><a href="between-partner-sam.html#cb118-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb118-26"><a href="between-partner-sam.html#cb118-26" aria-hidden="true" tabindex="-1"></a><span class="co">#add intercept and residuals (other fixed effects could be added here as well)</span></span>
<span id="cb118-27"><a href="between-partner-sam.html#cb118-27" aria-hidden="true" tabindex="-1"></a>pair_df<span class="sc">$</span>AG_m <span class="ot">=</span> alpha_0 <span class="sc">+</span> pair_df<span class="sc">$</span>eta_m <span class="sc">+</span> pair_df<span class="sc">$</span>resAGm</span>
<span id="cb118-28"><a href="between-partner-sam.html#cb118-28" aria-hidden="true" tabindex="-1"></a>pair_df<span class="sc">$</span>AG_f <span class="ot">=</span> alpha_0 <span class="sc">+</span> pair_df<span class="sc">$</span>eta_f <span class="sc">+</span> pair_df<span class="sc">$</span>resAGf</span>
<span id="cb118-29"><a href="between-partner-sam.html#cb118-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb118-30"><a href="between-partner-sam.html#cb118-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb118-31"><a href="between-partner-sam.html#cb118-31" aria-hidden="true" tabindex="-1"></a><span class="co">#create indices for STan</span></span>
<span id="cb118-32"><a href="between-partner-sam.html#cb118-32" aria-hidden="true" tabindex="-1"></a>Im <span class="ot">=</span> I<span class="sc">/</span><span class="dv">2</span> <span class="co">#number of males</span></span>
<span id="cb118-33"><a href="between-partner-sam.html#cb118-33" aria-hidden="true" tabindex="-1"></a>If <span class="ot">=</span> I<span class="sc">/</span><span class="dv">2</span> <span class="co">#number of females</span></span>
<span id="cb118-34"><a href="between-partner-sam.html#cb118-34" aria-hidden="true" tabindex="-1"></a>N_sex <span class="ot">=</span> (I<span class="sc">/</span><span class="dv">2</span>)<span class="sc">*</span>I_partner <span class="co">#total observations per sex</span></span>
<span id="cb118-35"><a href="between-partner-sam.html#cb118-35" aria-hidden="true" tabindex="-1"></a>idm<span class="ot">&lt;-</span>pair_df<span class="sc">$</span>ID_m <span class="co">#male ID</span></span>
<span id="cb118-36"><a href="between-partner-sam.html#cb118-36" aria-hidden="true" tabindex="-1"></a>idf<span class="ot">&lt;-</span>pair_df<span class="sc">$</span>ID_f <span class="co">#female ID</span></span>
<span id="cb118-37"><a href="between-partner-sam.html#cb118-37" aria-hidden="true" tabindex="-1"></a>idf<span class="ot">&lt;-</span>idf <span class="sc">-</span> Im <span class="co">#within female vector</span></span>
<span id="cb118-38"><a href="between-partner-sam.html#cb118-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb118-39"><a href="between-partner-sam.html#cb118-39" aria-hidden="true" tabindex="-1"></a><span class="co">#all partners for each individual</span></span>
<span id="cb118-40"><a href="between-partner-sam.html#cb118-40" aria-hidden="true" tabindex="-1"></a><span class="co">#partner IDs for male individuals</span></span>
<span id="cb118-41"><a href="between-partner-sam.html#cb118-41" aria-hidden="true" tabindex="-1"></a>partners_m<span class="ot">&lt;-</span><span class="fu">data.frame</span>(<span class="at">idfocal =</span> <span class="fu">rep</span>(<span class="dv">1</span><span class="sc">:</span>(I<span class="sc">/</span><span class="dv">2</span>)), <span class="co">#all partners ID</span></span>
<span id="cb118-42"><a href="between-partner-sam.html#cb118-42" aria-hidden="true" tabindex="-1"></a>                   <span class="at">partner1 =</span> <span class="cn">NA</span>, <span class="at">partner2 =</span> <span class="cn">NA</span>, <span class="at">partner3 =</span> <span class="cn">NA</span>, <span class="at">partner4 =</span> <span class="cn">NA</span>)</span>
<span id="cb118-43"><a href="between-partner-sam.html#cb118-43" aria-hidden="true" tabindex="-1"></a>                   <span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>(I<span class="sc">/</span><span class="dv">2</span>)){partners_m[i,<span class="fu">c</span>(<span class="dv">2</span><span class="sc">:</span><span class="dv">5</span>)] <span class="ot">&lt;-</span>partner.id[partner.id<span class="sc">$</span>ID_m<span class="sc">==</span>i,<span class="st">&quot;ID_f&quot;</span>]}</span>
<span id="cb118-44"><a href="between-partner-sam.html#cb118-44" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb118-45"><a href="between-partner-sam.html#cb118-45" aria-hidden="true" tabindex="-1"></a><span class="co">#partner IDs for female individuals</span></span>
<span id="cb118-46"><a href="between-partner-sam.html#cb118-46" aria-hidden="true" tabindex="-1"></a>partners_f<span class="ot">&lt;-</span><span class="fu">data.frame</span>(<span class="at">idfocal =</span> <span class="fu">rep</span>((I<span class="sc">/</span><span class="dv">2</span><span class="sc">+</span><span class="dv">1</span>)<span class="sc">:</span>I), <span class="co">#all partners ID</span></span>
<span id="cb118-47"><a href="between-partner-sam.html#cb118-47" aria-hidden="true" tabindex="-1"></a>                   <span class="at">partner1 =</span> <span class="cn">NA</span>, <span class="at">partner2 =</span> <span class="cn">NA</span>, <span class="at">partner3 =</span> <span class="cn">NA</span>, <span class="at">partner4 =</span> <span class="cn">NA</span>)</span>
<span id="cb118-48"><a href="between-partner-sam.html#cb118-48" aria-hidden="true" tabindex="-1"></a>                   <span class="cf">for</span>(i <span class="cf">in</span> (I<span class="sc">/</span><span class="dv">2</span><span class="sc">+</span><span class="dv">1</span>)<span class="sc">:</span>I){partners_f[i<span class="sc">-</span>(I<span class="sc">/</span><span class="dv">2</span>),<span class="fu">c</span>(<span class="dv">2</span><span class="sc">:</span><span class="dv">5</span>)] <span class="ot">&lt;-</span>partner.id[partner.id<span class="sc">$</span>ID_f<span class="sc">==</span>i,<span class="st">&quot;ID_m&quot;</span>]}</span>
<span id="cb118-49"><a href="between-partner-sam.html#cb118-49" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb118-50"><a href="between-partner-sam.html#cb118-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb118-51"><a href="between-partner-sam.html#cb118-51" aria-hidden="true" tabindex="-1"></a><span class="co">#data prep for Stan</span></span>
<span id="cb118-52"><a href="between-partner-sam.html#cb118-52" aria-hidden="true" tabindex="-1"></a>stan_data <span class="ot">&lt;-</span></span>
<span id="cb118-53"><a href="between-partner-sam.html#cb118-53" aria-hidden="true" tabindex="-1"></a>    <span class="fu">list</span>(<span class="at">N_sex =</span> N_sex, <span class="at">I =</span> I, <span class="at">Im=</span>Im, <span class="at">If =</span> If, <span class="at">idm =</span> idm, <span class="at">idf =</span> idf, <span class="at">partners_m =</span> partners_m, <span class="at">partners_f =</span> partners_f,</span>
<span id="cb118-54"><a href="between-partner-sam.html#cb118-54" aria-hidden="true" tabindex="-1"></a>         <span class="at">AG_m =</span> pair_df<span class="sc">$</span>AG_m, <span class="at">AG_f =</span> pair_df<span class="sc">$</span>AG_f, <span class="at">time =</span> pair_df<span class="sc">$</span>turn, <span class="at">A =</span> A_mat)</span></code></pre></div>
<p>It may also be of interest to calculate the true average partner values that we’ll need to center the statistical model.</p>
<div class="sourceCode" id="cb119"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb119-1"><a href="between-partner-sam.html#cb119-1" aria-hidden="true" tabindex="-1"></a><span class="co">#calculate mean partner phenotype for each subject</span></span>
<span id="cb119-2"><a href="between-partner-sam.html#cb119-2" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb119-3"><a href="between-partner-sam.html#cb119-3" aria-hidden="true" tabindex="-1"></a><span class="co">#average female for male partners</span></span>
<span id="cb119-4"><a href="between-partner-sam.html#cb119-4" aria-hidden="true" tabindex="-1"></a>mean_0m <span class="ot">&lt;-</span> <span class="fu">aggregate</span>(P0f <span class="sc">~</span> ID_m, mean, <span class="at">data =</span> partner.id)</span>
<span id="cb119-5"><a href="between-partner-sam.html#cb119-5" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(mean_0m)[<span class="dv">2</span>] <span class="ot">&lt;-</span> <span class="st">&quot;meanP0m&quot;</span></span>
<span id="cb119-6"><a href="between-partner-sam.html#cb119-6" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb119-7"><a href="between-partner-sam.html#cb119-7" aria-hidden="true" tabindex="-1"></a>mean_1m <span class="ot">&lt;-</span> <span class="fu">aggregate</span>(P1f <span class="sc">~</span> ID_m, mean, <span class="at">data =</span> partner.id)</span>
<span id="cb119-8"><a href="between-partner-sam.html#cb119-8" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(mean_1m)[<span class="dv">2</span>] <span class="ot">&lt;-</span> <span class="st">&quot;meanP1m&quot;</span></span>
<span id="cb119-9"><a href="between-partner-sam.html#cb119-9" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb119-10"><a href="between-partner-sam.html#cb119-10" aria-hidden="true" tabindex="-1"></a>partner.id<span class="sc">$</span>meanP0m <span class="ot">&lt;-</span> mean_0m<span class="sc">$</span>meanP0m[<span class="fu">match</span>(partner.id<span class="sc">$</span>ID_m,mean_0m<span class="sc">$</span>ID_m)]</span>
<span id="cb119-11"><a href="between-partner-sam.html#cb119-11" aria-hidden="true" tabindex="-1"></a>partner.id<span class="sc">$</span>meanP1m <span class="ot">&lt;-</span> mean_1m<span class="sc">$</span>meanP1m[<span class="fu">match</span>(partner.id<span class="sc">$</span>ID_m,mean_1m<span class="sc">$</span>ID_m)]</span>
<span id="cb119-12"><a href="between-partner-sam.html#cb119-12" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb119-13"><a href="between-partner-sam.html#cb119-13" aria-hidden="true" tabindex="-1"></a><span class="co">#average male for female partners</span></span>
<span id="cb119-14"><a href="between-partner-sam.html#cb119-14" aria-hidden="true" tabindex="-1"></a>mean_0f <span class="ot">&lt;-</span> <span class="fu">aggregate</span>(P0m <span class="sc">~</span> ID_f, mean, <span class="at">data =</span> partner.id)</span>
<span id="cb119-15"><a href="between-partner-sam.html#cb119-15" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(mean_0f)[<span class="dv">2</span>] <span class="ot">&lt;-</span> <span class="st">&quot;meanP0f&quot;</span></span>
<span id="cb119-16"><a href="between-partner-sam.html#cb119-16" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb119-17"><a href="between-partner-sam.html#cb119-17" aria-hidden="true" tabindex="-1"></a>mean_1f <span class="ot">&lt;-</span> <span class="fu">aggregate</span>(P1m <span class="sc">~</span> ID_f, mean, <span class="at">data =</span> partner.id)</span>
<span id="cb119-18"><a href="between-partner-sam.html#cb119-18" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(mean_1f)[<span class="dv">2</span>] <span class="ot">&lt;-</span> <span class="st">&quot;meanP1f&quot;</span></span>
<span id="cb119-19"><a href="between-partner-sam.html#cb119-19" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb119-20"><a href="between-partner-sam.html#cb119-20" aria-hidden="true" tabindex="-1"></a>partner.id<span class="sc">$</span>meanP0f <span class="ot">&lt;-</span> mean_0f<span class="sc">$</span>meanP0f[<span class="fu">match</span>(partner.id<span class="sc">$</span>ID_f,mean_0f<span class="sc">$</span>ID_f)]</span>
<span id="cb119-21"><a href="between-partner-sam.html#cb119-21" aria-hidden="true" tabindex="-1"></a>partner.id<span class="sc">$</span>meanP1f <span class="ot">&lt;-</span> mean_1f<span class="sc">$</span>meanP1f[<span class="fu">match</span>(partner.id<span class="sc">$</span>ID_f,mean_1f<span class="sc">$</span>ID_f)]</span></code></pre></div>
<p>For empirical data where the true partner values are unknown, we won’t want to average raw partner values subject to measurement error, but instead estimate them directly in our Stan model.</p>
</div>
<div id="estimate-the-model" class="section level2" number="3.2">
<h2><span class="header-section-number">3.2</span> Estimate the model</h2>
<p>To code the model, we begin by simplifying the within partner model to remove SRN and residual feedback from the male and female responses, and then we expand it by adding new code for the within-individual centering procedure.</p>
<div class="sourceCode" id="cb120"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb120-1"><a href="between-partner-sam.html#cb120-1" aria-hidden="true" tabindex="-1"></a><span class="fu">write</span>(<span class="st">&quot;</span></span>
<span id="cb120-2"><a href="between-partner-sam.html#cb120-2" aria-hidden="true" tabindex="-1"></a><span class="st">data {</span></span>
<span id="cb120-3"><a href="between-partner-sam.html#cb120-3" aria-hidden="true" tabindex="-1"></a><span class="st">  </span></span>
<span id="cb120-4"><a href="between-partner-sam.html#cb120-4" aria-hidden="true" tabindex="-1"></a><span class="st">  //indices and scalars used for model specification</span></span>
<span id="cb120-5"><a href="between-partner-sam.html#cb120-5" aria-hidden="true" tabindex="-1"></a><span class="st">  int&lt;lower=1&gt; N_sex; //total aggression observations per sex (I/2 * 4 lifetime partners)</span></span>
<span id="cb120-6"><a href="between-partner-sam.html#cb120-6" aria-hidden="true" tabindex="-1"></a><span class="st">  int&lt;lower=0&gt; I; //total individuals (M + F)</span></span>
<span id="cb120-7"><a href="between-partner-sam.html#cb120-7" aria-hidden="true" tabindex="-1"></a><span class="st">  int&lt;lower=0&gt; Im; //number of males</span></span>
<span id="cb120-8"><a href="between-partner-sam.html#cb120-8" aria-hidden="true" tabindex="-1"></a><span class="st">  int&lt;lower=0&gt; If; //number of females</span></span>
<span id="cb120-9"><a href="between-partner-sam.html#cb120-9" aria-hidden="true" tabindex="-1"></a><span class="st">  int&lt;lower=1&gt; idm[N_sex]; //index of male AG observations (of length N_sex)</span></span>
<span id="cb120-10"><a href="between-partner-sam.html#cb120-10" aria-hidden="true" tabindex="-1"></a><span class="st">  int&lt;lower=1&gt; idf[N_sex]; //index of female AG observations</span></span>
<span id="cb120-11"><a href="between-partner-sam.html#cb120-11" aria-hidden="true" tabindex="-1"></a><span class="st">  int&lt;lower=1&gt; partners_m [Im,5]; //index of male partner IDs, first column is focal ID (1 + 4 IDs)</span></span>
<span id="cb120-12"><a href="between-partner-sam.html#cb120-12" aria-hidden="true" tabindex="-1"></a><span class="st">  int&lt;lower=1&gt; partners_f [If,5]; //index of female partner IDs, first column is focal ID (1 + 4 IDs)</span></span>
<span id="cb120-13"><a href="between-partner-sam.html#cb120-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb120-14"><a href="between-partner-sam.html#cb120-14" aria-hidden="true" tabindex="-1"></a><span class="st">  //empirical data</span></span>
<span id="cb120-15"><a href="between-partner-sam.html#cb120-15" aria-hidden="true" tabindex="-1"></a><span class="st">  matrix[I,I] A; //relatedness matrix</span></span>
<span id="cb120-16"><a href="between-partner-sam.html#cb120-16" aria-hidden="true" tabindex="-1"></a><span class="st">  real AG_m[N_sex]; //male aggression measurements</span></span>
<span id="cb120-17"><a href="between-partner-sam.html#cb120-17" aria-hidden="true" tabindex="-1"></a><span class="st">  real AG_f[N_sex]; //female aggression measurements</span></span>
<span id="cb120-18"><a href="between-partner-sam.html#cb120-18" aria-hidden="true" tabindex="-1"></a><span class="st">  real time[N_sex]; //time index (=1 for all measures)</span></span>
<span id="cb120-19"><a href="between-partner-sam.html#cb120-19" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb120-20"><a href="between-partner-sam.html#cb120-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb120-21"><a href="between-partner-sam.html#cb120-21" aria-hidden="true" tabindex="-1"></a><span class="st">transformed data{</span></span>
<span id="cb120-22"><a href="between-partner-sam.html#cb120-22" aria-hidden="true" tabindex="-1"></a><span class="st">  matrix[I,I] LA = cholesky_decompose(A); //lower-triangle A matrix</span></span>
<span id="cb120-23"><a href="between-partner-sam.html#cb120-23" aria-hidden="true" tabindex="-1"></a><span class="st">  </span></span>
<span id="cb120-24"><a href="between-partner-sam.html#cb120-24" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb120-25"><a href="between-partner-sam.html#cb120-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb120-26"><a href="between-partner-sam.html#cb120-26" aria-hidden="true" tabindex="-1"></a><span class="st">parameters {</span></span>
<span id="cb120-27"><a href="between-partner-sam.html#cb120-27" aria-hidden="true" tabindex="-1"></a><span class="st">  //population effects</span></span>
<span id="cb120-28"><a href="between-partner-sam.html#cb120-28" aria-hidden="true" tabindex="-1"></a><span class="st">  real alpha_0; //aggression global intercept</span></span>
<span id="cb120-29"><a href="between-partner-sam.html#cb120-29" aria-hidden="true" tabindex="-1"></a><span class="st">  real psi_1; //expected interaction coefficient</span></span>
<span id="cb120-30"><a href="between-partner-sam.html#cb120-30" aria-hidden="true" tabindex="-1"></a><span class="st">  real beta_B; //slope of between-partner component</span></span>
<span id="cb120-31"><a href="between-partner-sam.html#cb120-31" aria-hidden="true" tabindex="-1"></a><span class="st">  </span></span>
<span id="cb120-32"><a href="between-partner-sam.html#cb120-32" aria-hidden="true" tabindex="-1"></a><span class="st">  //no way to partition feedback when t=1</span></span>
<span id="cb120-33"><a href="between-partner-sam.html#cb120-33" aria-hidden="true" tabindex="-1"></a><span class="st">  //real&lt;lower=-1,upper=1&gt; phi; //(-1,1) ensures unique solution</span></span>
<span id="cb120-34"><a href="between-partner-sam.html#cb120-34" aria-hidden="true" tabindex="-1"></a><span class="st">  </span></span>
<span id="cb120-35"><a href="between-partner-sam.html#cb120-35" aria-hidden="true" tabindex="-1"></a><span class="st">  //random effects (standard deviations)</span></span>
<span id="cb120-36"><a href="between-partner-sam.html#cb120-36" aria-hidden="true" tabindex="-1"></a><span class="st">  vector&lt;lower=0, upper = 1&gt;[2] sd_P; //phenotypic SRN mu &amp; psi SDs</span></span>
<span id="cb120-37"><a href="between-partner-sam.html#cb120-37" aria-hidden="true" tabindex="-1"></a><span class="st">  vector&lt;lower=0, upper = 1&gt;[2] sd_R; //male &amp; female residual SDs</span></span>
<span id="cb120-38"><a href="between-partner-sam.html#cb120-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb120-39"><a href="between-partner-sam.html#cb120-39" aria-hidden="true" tabindex="-1"></a><span class="st">  cholesky_factor_corr[2] LG; //genetic SRN correlations</span></span>
<span id="cb120-40"><a href="between-partner-sam.html#cb120-40" aria-hidden="true" tabindex="-1"></a><span class="st">  cholesky_factor_corr[2] LE; //permanent environmental SRN correlations</span></span>
<span id="cb120-41"><a href="between-partner-sam.html#cb120-41" aria-hidden="true" tabindex="-1"></a><span class="st">  cholesky_factor_corr[2] LR; //sex-specific residual correlations</span></span>
<span id="cb120-42"><a href="between-partner-sam.html#cb120-42" aria-hidden="true" tabindex="-1"></a><span class="st">  </span></span>
<span id="cb120-43"><a href="between-partner-sam.html#cb120-43" aria-hidden="true" tabindex="-1"></a><span class="st">  matrix[I,2] std_devG; //individual-level unscaled G SRN deviations</span></span>
<span id="cb120-44"><a href="between-partner-sam.html#cb120-44" aria-hidden="true" tabindex="-1"></a><span class="st">  matrix[I,2] std_devE; //individual-level unscaled E SRN deviations</span></span>
<span id="cb120-45"><a href="between-partner-sam.html#cb120-45" aria-hidden="true" tabindex="-1"></a><span class="st">  </span></span>
<span id="cb120-46"><a href="between-partner-sam.html#cb120-46" aria-hidden="true" tabindex="-1"></a><span class="st">  //SRN heritability parmameters, i.e. Var(G_RN) / Var(P_RN) </span></span>
<span id="cb120-47"><a href="between-partner-sam.html#cb120-47" aria-hidden="true" tabindex="-1"></a><span class="st">  //see supplementary appendix SI for further explanation of this parameter</span></span>
<span id="cb120-48"><a href="between-partner-sam.html#cb120-48" aria-hidden="true" tabindex="-1"></a><span class="st">  vector&lt;lower=0,upper=1&gt;[2] SRN_h2;</span></span>
<span id="cb120-49"><a href="between-partner-sam.html#cb120-49" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb120-50"><a href="between-partner-sam.html#cb120-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb120-51"><a href="between-partner-sam.html#cb120-51" aria-hidden="true" tabindex="-1"></a><span class="st">transformed parameters {</span></span>
<span id="cb120-52"><a href="between-partner-sam.html#cb120-52" aria-hidden="true" tabindex="-1"></a><span class="st">  vector&lt;lower=0&gt;[2] sd_G; //SDs of G effects (derived from sd_P)</span></span>
<span id="cb120-53"><a href="between-partner-sam.html#cb120-53" aria-hidden="true" tabindex="-1"></a><span class="st">  vector&lt;lower=0&gt;[2] sd_E; //SDs of E effects (derived from sd_P)</span></span>
<span id="cb120-54"><a href="between-partner-sam.html#cb120-54" aria-hidden="true" tabindex="-1"></a><span class="st">  </span></span>
<span id="cb120-55"><a href="between-partner-sam.html#cb120-55" aria-hidden="true" tabindex="-1"></a><span class="st">  matrix[I,2] SRN_P; //scaled P SRN parameter deviations</span></span>
<span id="cb120-56"><a href="between-partner-sam.html#cb120-56" aria-hidden="true" tabindex="-1"></a><span class="st">  matrix[I,2] SRN_G; //scaled G SRN parameter deviations</span></span>
<span id="cb120-57"><a href="between-partner-sam.html#cb120-57" aria-hidden="true" tabindex="-1"></a><span class="st">  matrix[I,2] SRN_E; //scaled E SRN parameter deviations</span></span>
<span id="cb120-58"><a href="between-partner-sam.html#cb120-58" aria-hidden="true" tabindex="-1"></a><span class="st">  </span></span>
<span id="cb120-59"><a href="between-partner-sam.html#cb120-59" aria-hidden="true" tabindex="-1"></a><span class="st">  matrix[If, 2] partner_meanm; //average SRN parameters of males&#39; partners</span></span>
<span id="cb120-60"><a href="between-partner-sam.html#cb120-60" aria-hidden="true" tabindex="-1"></a><span class="st">  matrix[Im, 2] partner_meanf; //average SRN parameters of females&#39; partners</span></span>
<span id="cb120-61"><a href="between-partner-sam.html#cb120-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb120-62"><a href="between-partner-sam.html#cb120-62" aria-hidden="true" tabindex="-1"></a><span class="st">  //standard deviations of genetic effects</span></span>
<span id="cb120-63"><a href="between-partner-sam.html#cb120-63" aria-hidden="true" tabindex="-1"></a><span class="st">  //simplified from sqrt ( total RN phenotype variance * h2 )</span></span>
<span id="cb120-64"><a href="between-partner-sam.html#cb120-64" aria-hidden="true" tabindex="-1"></a><span class="st">  sd_G[1] = sd_P[1] * sqrt(SRN_h2[1]); //genetic SD for RN intercepts </span></span>
<span id="cb120-65"><a href="between-partner-sam.html#cb120-65" aria-hidden="true" tabindex="-1"></a><span class="st">  sd_G[2] = sd_P[2] * sqrt(SRN_h2[2]);  //genetic SD for RN slopes</span></span>
<span id="cb120-66"><a href="between-partner-sam.html#cb120-66" aria-hidden="true" tabindex="-1"></a><span class="st">  </span></span>
<span id="cb120-67"><a href="between-partner-sam.html#cb120-67" aria-hidden="true" tabindex="-1"></a><span class="st">  //standard deviations of environmental effects (total phenotype SD * proportion environment SD)</span></span>
<span id="cb120-68"><a href="between-partner-sam.html#cb120-68" aria-hidden="true" tabindex="-1"></a><span class="st">  sd_E[1] = sd_P[1] * sqrt(1 - SRN_h2[1]); //environment SD for RN intercepts </span></span>
<span id="cb120-69"><a href="between-partner-sam.html#cb120-69" aria-hidden="true" tabindex="-1"></a><span class="st">  sd_E[2] = sd_P[2] * sqrt(1 - SRN_h2[2]); //environment SD for RN slopes </span></span>
<span id="cb120-70"><a href="between-partner-sam.html#cb120-70" aria-hidden="true" tabindex="-1"></a><span class="st">  </span></span>
<span id="cb120-71"><a href="between-partner-sam.html#cb120-71" aria-hidden="true" tabindex="-1"></a><span class="st">  //matrix normal parameterization of Kronecker product between G and A</span></span>
<span id="cb120-72"><a href="between-partner-sam.html#cb120-72" aria-hidden="true" tabindex="-1"></a><span class="st">  SRN_G =  LA * std_devG  * diag_pre_multiply(sd_G, LG)&#39; ; </span></span>
<span id="cb120-73"><a href="between-partner-sam.html#cb120-73" aria-hidden="true" tabindex="-1"></a><span class="st">  </span></span>
<span id="cb120-74"><a href="between-partner-sam.html#cb120-74" aria-hidden="true" tabindex="-1"></a><span class="st">  //non-centered parameterization of permanent environmental effects</span></span>
<span id="cb120-75"><a href="between-partner-sam.html#cb120-75" aria-hidden="true" tabindex="-1"></a><span class="st">  SRN_E = std_devE * diag_pre_multiply(sd_E, LE)&#39;;</span></span>
<span id="cb120-76"><a href="between-partner-sam.html#cb120-76" aria-hidden="true" tabindex="-1"></a><span class="st">  </span></span>
<span id="cb120-77"><a href="between-partner-sam.html#cb120-77" aria-hidden="true" tabindex="-1"></a><span class="st">  //phenotypic RN effects (P = G + E); here G = additive genetic effects</span></span>
<span id="cb120-78"><a href="between-partner-sam.html#cb120-78" aria-hidden="true" tabindex="-1"></a><span class="st">  SRN_P = SRN_G + SRN_E;</span></span>
<span id="cb120-79"><a href="between-partner-sam.html#cb120-79" aria-hidden="true" tabindex="-1"></a><span class="st">  </span></span>
<span id="cb120-80"><a href="between-partner-sam.html#cb120-80" aria-hidden="true" tabindex="-1"></a><span class="st">  //calculate the mean SRN parameters of each male&#39;s lifetime partners</span></span>
<span id="cb120-81"><a href="between-partner-sam.html#cb120-81" aria-hidden="true" tabindex="-1"></a><span class="st">  for(i in 1:Im) partner_meanm[i] = [mean(col(SRN_P[partners_m[i,2:5]],1)),</span></span>
<span id="cb120-82"><a href="between-partner-sam.html#cb120-82" aria-hidden="true" tabindex="-1"></a><span class="st">                                mean(col(SRN_P[partners_m[i,2:5]],2))];</span></span>
<span id="cb120-83"><a href="between-partner-sam.html#cb120-83" aria-hidden="true" tabindex="-1"></a><span class="st">  </span></span>
<span id="cb120-84"><a href="between-partner-sam.html#cb120-84" aria-hidden="true" tabindex="-1"></a><span class="st">  //calculate the mean SRN parameters of each female&#39;s lifetime partners</span></span>
<span id="cb120-85"><a href="between-partner-sam.html#cb120-85" aria-hidden="true" tabindex="-1"></a><span class="st">  for(i in 1:If) partner_meanf[i] = [mean(col(SRN_P[partners_f[i,2:5]],1)),</span></span>
<span id="cb120-86"><a href="between-partner-sam.html#cb120-86" aria-hidden="true" tabindex="-1"></a><span class="st">                                mean(col(SRN_P[partners_f[i,2:5]],2))];</span></span>
<span id="cb120-87"><a href="between-partner-sam.html#cb120-87" aria-hidden="true" tabindex="-1"></a><span class="st">  </span></span>
<span id="cb120-88"><a href="between-partner-sam.html#cb120-88" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb120-89"><a href="between-partner-sam.html#cb120-89" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb120-90"><a href="between-partner-sam.html#cb120-90" aria-hidden="true" tabindex="-1"></a><span class="st">model{</span></span>
<span id="cb120-91"><a href="between-partner-sam.html#cb120-91" aria-hidden="true" tabindex="-1"></a><span class="st">  //separate male and female vectors for efficiency</span></span>
<span id="cb120-92"><a href="between-partner-sam.html#cb120-92" aria-hidden="true" tabindex="-1"></a><span class="st">  matrix[Im,2] SRN_Pm = SRN_P[1:Im]; //male SRN phenotypic deviations</span></span>
<span id="cb120-93"><a href="between-partner-sam.html#cb120-93" aria-hidden="true" tabindex="-1"></a><span class="st">  matrix[If,2] SRN_Pf = SRN_P[(Im+1):I]; //female SRN phenotypic deviations</span></span>
<span id="cb120-94"><a href="between-partner-sam.html#cb120-94" aria-hidden="true" tabindex="-1"></a><span class="st">  </span></span>
<span id="cb120-95"><a href="between-partner-sam.html#cb120-95" aria-hidden="true" tabindex="-1"></a><span class="st">  //separate SRN intercepts and slopes (phenotypic deviations)</span></span>
<span id="cb120-96"><a href="between-partner-sam.html#cb120-96" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[Im] mu_m = col(SRN_Pm,1); //SRN intercepts</span></span>
<span id="cb120-97"><a href="between-partner-sam.html#cb120-97" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[If] mu_f = col(SRN_Pf,1); </span></span>
<span id="cb120-98"><a href="between-partner-sam.html#cb120-98" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[Im] psi_m = col(SRN_Pm,2); //SRN slopes</span></span>
<span id="cb120-99"><a href="between-partner-sam.html#cb120-99" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[If] psi_f = col(SRN_Pf,2); </span></span>
<span id="cb120-100"><a href="between-partner-sam.html#cb120-100" aria-hidden="true" tabindex="-1"></a><span class="st">  </span></span>
<span id="cb120-101"><a href="between-partner-sam.html#cb120-101" aria-hidden="true" tabindex="-1"></a><span class="st">  //separate mean partner SRN intercepts and slopes</span></span>
<span id="cb120-102"><a href="between-partner-sam.html#cb120-102" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[Im] mu_meanm = col(partner_meanm,1); //mean partner SRN intercept for males</span></span>
<span id="cb120-103"><a href="between-partner-sam.html#cb120-103" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[If] mu_meanf = col(partner_meanf,1); //...for females</span></span>
<span id="cb120-104"><a href="between-partner-sam.html#cb120-104" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[Im] psi_meanm = col(partner_meanm,2); //mean partner SRN slope for males</span></span>
<span id="cb120-105"><a href="between-partner-sam.html#cb120-105" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[If] psi_meanf = col(partner_meanf,2); //...for females </span></span>
<span id="cb120-106"><a href="between-partner-sam.html#cb120-106" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb120-107"><a href="between-partner-sam.html#cb120-107" aria-hidden="true" tabindex="-1"></a><span class="st">  //add in new vectors for within-individual centering</span></span>
<span id="cb120-108"><a href="between-partner-sam.html#cb120-108" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[N_sex] eta_Wm; //male SRN trait value </span></span>
<span id="cb120-109"><a href="between-partner-sam.html#cb120-109" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[N_sex] eta_Wf; //female SRN trait value</span></span>
<span id="cb120-110"><a href="between-partner-sam.html#cb120-110" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[N_sex] eta_Bm; //individual male SRN trait value toward average partner </span></span>
<span id="cb120-111"><a href="between-partner-sam.html#cb120-111" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[N_sex] eta_Bf; //individual female SRN trait toward average partner</span></span>
<span id="cb120-112"><a href="between-partner-sam.html#cb120-112" aria-hidden="true" tabindex="-1"></a><span class="st">  </span></span>
<span id="cb120-113"><a href="between-partner-sam.html#cb120-113" aria-hidden="true" tabindex="-1"></a><span class="st">  //other components of linear predictor</span></span>
<span id="cb120-114"><a href="between-partner-sam.html#cb120-114" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[N_sex] linpred_m; //total expected value for male responses</span></span>
<span id="cb120-115"><a href="between-partner-sam.html#cb120-115" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[N_sex] linpred_f; //total expected value for female responses</span></span>
<span id="cb120-116"><a href="between-partner-sam.html#cb120-116" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[N_sex] epsilon_m; //residual for male responses</span></span>
<span id="cb120-117"><a href="between-partner-sam.html#cb120-117" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[N_sex] epsilon_f; //residual for female responses</span></span>
<span id="cb120-118"><a href="between-partner-sam.html#cb120-118" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb120-119"><a href="between-partner-sam.html#cb120-119" aria-hidden="true" tabindex="-1"></a><span class="st">  //Male and female aggression response model</span></span>
<span id="cb120-120"><a href="between-partner-sam.html#cb120-120" aria-hidden="true" tabindex="-1"></a><span class="st">  for (n in 1:N_sex) {</span></span>
<span id="cb120-121"><a href="between-partner-sam.html#cb120-121" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb120-122"><a href="between-partner-sam.html#cb120-122" aria-hidden="true" tabindex="-1"></a><span class="st">  //SRN trait values (within-individual centered)</span></span>
<span id="cb120-123"><a href="between-partner-sam.html#cb120-123" aria-hidden="true" tabindex="-1"></a><span class="st">  //there is no residual feedback, so only t = 1</span></span>
<span id="cb120-124"><a href="between-partner-sam.html#cb120-124" aria-hidden="true" tabindex="-1"></a><span class="st">        //within-male male eta[t=1] = mu_j + (psi + psi_j)*(mu_k - mean_mu_K)</span></span>
<span id="cb120-125"><a href="between-partner-sam.html#cb120-125" aria-hidden="true" tabindex="-1"></a><span class="st">        eta_Wm[n] = mu_m[idm[n]] +  (psi_1 + psi_m[idm[n]])*(mu_f[idf[n]] - mu_meanm[idm[n]]) ;</span></span>
<span id="cb120-126"><a href="between-partner-sam.html#cb120-126" aria-hidden="true" tabindex="-1"></a><span class="st">        </span></span>
<span id="cb120-127"><a href="between-partner-sam.html#cb120-127" aria-hidden="true" tabindex="-1"></a><span class="st">        //female eta[t=1] = mu_k + (psi + psi_k)*(mu_j - mean_mu_J)</span></span>
<span id="cb120-128"><a href="between-partner-sam.html#cb120-128" aria-hidden="true" tabindex="-1"></a><span class="st">        eta_Wf[n] = mu_f[idf[n]] +   (psi_1 + psi_f[idf[n]])*(mu_m[idm[n]] - mu_meanf[idf[n]]);</span></span>
<span id="cb120-129"><a href="between-partner-sam.html#cb120-129" aria-hidden="true" tabindex="-1"></a><span class="st">  </span></span>
<span id="cb120-130"><a href="between-partner-sam.html#cb120-130" aria-hidden="true" tabindex="-1"></a><span class="st">        //average time=1 individual eta (used for feedback process)</span></span>
<span id="cb120-131"><a href="between-partner-sam.html#cb120-131" aria-hidden="true" tabindex="-1"></a><span class="st">        //between male eta[t=1] = mu_j + psi_j*mean_mu_K</span></span>
<span id="cb120-132"><a href="between-partner-sam.html#cb120-132" aria-hidden="true" tabindex="-1"></a><span class="st">        eta_Bm[n] = (psi_1 + psi_m[idm[n]])*mu_meanm[idm[n]];</span></span>
<span id="cb120-133"><a href="between-partner-sam.html#cb120-133" aria-hidden="true" tabindex="-1"></a><span class="st">        </span></span>
<span id="cb120-134"><a href="between-partner-sam.html#cb120-134" aria-hidden="true" tabindex="-1"></a><span class="st">        //between female eta[t=1] = mu_k + psi_k*mean_mu_J</span></span>
<span id="cb120-135"><a href="between-partner-sam.html#cb120-135" aria-hidden="true" tabindex="-1"></a><span class="st">        eta_Bf[n] = (psi_1 + psi_f[idf[n]])*mu_meanf[idf[n]];</span></span>
<span id="cb120-136"><a href="between-partner-sam.html#cb120-136" aria-hidden="true" tabindex="-1"></a><span class="st">        </span></span>
<span id="cb120-137"><a href="between-partner-sam.html#cb120-137" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb120-138"><a href="between-partner-sam.html#cb120-138" aria-hidden="true" tabindex="-1"></a><span class="st">  //add global intercept and between-individual parameters to linear predictor</span></span>
<span id="cb120-139"><a href="between-partner-sam.html#cb120-139" aria-hidden="true" tabindex="-1"></a><span class="st">  //other fixed effects can also be added here</span></span>
<span id="cb120-140"><a href="between-partner-sam.html#cb120-140" aria-hidden="true" tabindex="-1"></a><span class="st">   linpred_m[n] = alpha_0 + eta_Wm[n] + beta_B*eta_Bm[n] ;</span></span>
<span id="cb120-141"><a href="between-partner-sam.html#cb120-141" aria-hidden="true" tabindex="-1"></a><span class="st">   linpred_f[n] = alpha_0 + eta_Wf[n] + beta_B*eta_Bf[n] ;</span></span>
<span id="cb120-142"><a href="between-partner-sam.html#cb120-142" aria-hidden="true" tabindex="-1"></a><span class="st">   </span></span>
<span id="cb120-143"><a href="between-partner-sam.html#cb120-143" aria-hidden="true" tabindex="-1"></a><span class="st">   //there is no residual feedback, so only t = 1</span></span>
<span id="cb120-144"><a href="between-partner-sam.html#cb120-144" aria-hidden="true" tabindex="-1"></a><span class="st">        epsilon_m [n] = AG_m[n] - linpred_m[n];</span></span>
<span id="cb120-145"><a href="between-partner-sam.html#cb120-145" aria-hidden="true" tabindex="-1"></a><span class="st">        epsilon_f [n] = AG_f[n] - linpred_f[n];</span></span>
<span id="cb120-146"><a href="between-partner-sam.html#cb120-146" aria-hidden="true" tabindex="-1"></a><span class="st">   </span></span>
<span id="cb120-147"><a href="between-partner-sam.html#cb120-147" aria-hidden="true" tabindex="-1"></a><span class="st">  //correlated residuals between partners</span></span>
<span id="cb120-148"><a href="between-partner-sam.html#cb120-148" aria-hidden="true" tabindex="-1"></a><span class="st">   [epsilon_m[n],epsilon_f[n]]&#39; ~ multi_normal_cholesky([0,0], diag_pre_multiply(sd_R, LR));</span></span>
<span id="cb120-149"><a href="between-partner-sam.html#cb120-149" aria-hidden="true" tabindex="-1"></a><span class="st">  }</span></span>
<span id="cb120-150"><a href="between-partner-sam.html#cb120-150" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb120-151"><a href="between-partner-sam.html#cb120-151" aria-hidden="true" tabindex="-1"></a><span class="st">//model priors</span></span>
<span id="cb120-152"><a href="between-partner-sam.html#cb120-152" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb120-153"><a href="between-partner-sam.html#cb120-153" aria-hidden="true" tabindex="-1"></a><span class="st">  //fixed effects</span></span>
<span id="cb120-154"><a href="between-partner-sam.html#cb120-154" aria-hidden="true" tabindex="-1"></a><span class="st">  alpha_0 ~ std_normal();</span></span>
<span id="cb120-155"><a href="between-partner-sam.html#cb120-155" aria-hidden="true" tabindex="-1"></a><span class="st">  psi_1 ~ std_normal();</span></span>
<span id="cb120-156"><a href="between-partner-sam.html#cb120-156" aria-hidden="true" tabindex="-1"></a><span class="st">  beta_B ~ std_normal();</span></span>
<span id="cb120-157"><a href="between-partner-sam.html#cb120-157" aria-hidden="true" tabindex="-1"></a><span class="st">  </span></span>
<span id="cb120-158"><a href="between-partner-sam.html#cb120-158" aria-hidden="true" tabindex="-1"></a><span class="st">  //random effects</span></span>
<span id="cb120-159"><a href="between-partner-sam.html#cb120-159" aria-hidden="true" tabindex="-1"></a><span class="st">  to_vector(sd_P) ~ cauchy(0,1);</span></span>
<span id="cb120-160"><a href="between-partner-sam.html#cb120-160" aria-hidden="true" tabindex="-1"></a><span class="st">  to_vector(sd_R) ~ cauchy(0,1);</span></span>
<span id="cb120-161"><a href="between-partner-sam.html#cb120-161" aria-hidden="true" tabindex="-1"></a><span class="st">  </span></span>
<span id="cb120-162"><a href="between-partner-sam.html#cb120-162" aria-hidden="true" tabindex="-1"></a><span class="st">  LG ~ lkj_corr_cholesky(2);</span></span>
<span id="cb120-163"><a href="between-partner-sam.html#cb120-163" aria-hidden="true" tabindex="-1"></a><span class="st">  LE ~ lkj_corr_cholesky(2);</span></span>
<span id="cb120-164"><a href="between-partner-sam.html#cb120-164" aria-hidden="true" tabindex="-1"></a><span class="st">  LR ~ lkj_corr_cholesky(2);</span></span>
<span id="cb120-165"><a href="between-partner-sam.html#cb120-165" aria-hidden="true" tabindex="-1"></a><span class="st">  </span></span>
<span id="cb120-166"><a href="between-partner-sam.html#cb120-166" aria-hidden="true" tabindex="-1"></a><span class="st">  to_vector(std_devG) ~ std_normal();</span></span>
<span id="cb120-167"><a href="between-partner-sam.html#cb120-167" aria-hidden="true" tabindex="-1"></a><span class="st">  to_vector(std_devE) ~ std_normal();</span></span>
<span id="cb120-168"><a href="between-partner-sam.html#cb120-168" aria-hidden="true" tabindex="-1"></a><span class="st">  </span></span>
<span id="cb120-169"><a href="between-partner-sam.html#cb120-169" aria-hidden="true" tabindex="-1"></a><span class="st">  //reaction norm heritability</span></span>
<span id="cb120-170"><a href="between-partner-sam.html#cb120-170" aria-hidden="true" tabindex="-1"></a><span class="st">  to_vector(SRN_h2) ~ beta(1.2,1.2);</span></span>
<span id="cb120-171"><a href="between-partner-sam.html#cb120-171" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb120-172"><a href="between-partner-sam.html#cb120-172" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb120-173"><a href="between-partner-sam.html#cb120-173" aria-hidden="true" tabindex="-1"></a><span class="st">generated quantities{</span></span>
<span id="cb120-174"><a href="between-partner-sam.html#cb120-174" aria-hidden="true" tabindex="-1"></a><span class="st">//cor and cov matrices of SRN parameters and residuals</span></span>
<span id="cb120-175"><a href="between-partner-sam.html#cb120-175" aria-hidden="true" tabindex="-1"></a><span class="st">matrix[2,2] Gcor = LG * LG&#39;; //G SRN correlation matric</span></span>
<span id="cb120-176"><a href="between-partner-sam.html#cb120-176" aria-hidden="true" tabindex="-1"></a><span class="st">matrix[2,2] Ecor = LE * LE&#39;; //E SRN correlation matric</span></span>
<span id="cb120-177"><a href="between-partner-sam.html#cb120-177" aria-hidden="true" tabindex="-1"></a><span class="st">matrix[2,2] Rcor = LR * LR&#39;; //residual correlation matrix</span></span>
<span id="cb120-178"><a href="between-partner-sam.html#cb120-178" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb120-179"><a href="between-partner-sam.html#cb120-179" aria-hidden="true" tabindex="-1"></a><span class="st">matrix[2,2] Rcov = diag_matrix(sd_R)*Rcor*diag_matrix(sd_R); //residual covariance</span></span>
<span id="cb120-180"><a href="between-partner-sam.html#cb120-180" aria-hidden="true" tabindex="-1"></a><span class="st">matrix[2,2] Gcov = diag_matrix(sd_G)*Gcor*diag_matrix(sd_G); //G SRN covariance</span></span>
<span id="cb120-181"><a href="between-partner-sam.html#cb120-181" aria-hidden="true" tabindex="-1"></a><span class="st">matrix[2,2] Ecov = diag_matrix(sd_E)*Ecor*diag_matrix(sd_E); //E SRN covariance</span></span>
<span id="cb120-182"><a href="between-partner-sam.html#cb120-182" aria-hidden="true" tabindex="-1"></a><span class="st">matrix[2,2] Pcov = Gcov + Ecov; //P SRN covariance</span></span>
<span id="cb120-183"><a href="between-partner-sam.html#cb120-183" aria-hidden="true" tabindex="-1"></a><span class="st">matrix[2,2] Pcor = inverse(diag_matrix(sd_P))*Pcov*inverse(diag_matrix(sd_P)); //P SRN correlation</span></span>
<span id="cb120-184"><a href="between-partner-sam.html#cb120-184" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb120-185"><a href="between-partner-sam.html#cb120-185" aria-hidden="true" tabindex="-1"></a><span class="st">//variances</span></span>
<span id="cb120-186"><a href="between-partner-sam.html#cb120-186" aria-hidden="true" tabindex="-1"></a><span class="st">vector&lt;lower=0&gt;[2] V_P = sd_P .* sd_P;</span></span>
<span id="cb120-187"><a href="between-partner-sam.html#cb120-187" aria-hidden="true" tabindex="-1"></a><span class="st">vector&lt;lower=0&gt;[2] V_G = sd_G .* sd_G;</span></span>
<span id="cb120-188"><a href="between-partner-sam.html#cb120-188" aria-hidden="true" tabindex="-1"></a><span class="st">vector&lt;lower=0&gt;[2] V_E = sd_E .* sd_E;</span></span>
<span id="cb120-189"><a href="between-partner-sam.html#cb120-189" aria-hidden="true" tabindex="-1"></a><span class="st">vector&lt;lower=0&gt;[2] V_R = sd_R .* sd_R;</span></span>
<span id="cb120-190"><a href="between-partner-sam.html#cb120-190" aria-hidden="true" tabindex="-1"></a><span class="st">}&quot;</span>, <span class="st">&quot;sam3_2.stan&quot;</span>)</span></code></pre></div>
<p>As a reminder, this is the structure of the data list necessary for estimating this model.</p>
<div class="sourceCode" id="cb121"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb121-1"><a href="between-partner-sam.html#cb121-1" aria-hidden="true" tabindex="-1"></a><span class="fu">str</span>(stan_data)</span></code></pre></div>
<pre><code>## List of 12
##  $ N_sex     : num 600
##  $ I         : num 300
##  $ Im        : num 150
##  $ If        : num 150
##  $ idm       : int [1:600] 1 1 1 1 2 2 2 2 3 3 ...
##  $ idf       : num [1:600] 11 20 119 21 78 26 69 61 41 131 ...
##  $ partners_m:&#39;data.frame&#39;:  150 obs. of  5 variables:
##   ..$ idfocal : int [1:150] 1 2 3 4 5 6 7 8 9 10 ...
##   ..$ partner1: int [1:150] 161 228 191 273 257 175 180 285 245 222 ...
##   ..$ partner2: int [1:150] 170 176 281 231 270 246 286 155 151 244 ...
##   ..$ partner3: int [1:150] 269 219 258 203 247 175 276 163 300 169 ...
##   ..$ partner4: int [1:150] 171 211 164 252 261 180 181 268 172 280 ...
##  $ partners_f:&#39;data.frame&#39;:  150 obs. of  5 variables:
##   ..$ idfocal : int [1:150] 151 152 153 154 155 156 157 158 159 160 ...
##   ..$ partner1: int [1:150] 9 51 12 77 8 11 24 85 13 11 ...
##   ..$ partner2: int [1:150] 76 76 15 101 43 17 80 109 38 26 ...
##   ..$ partner3: int [1:150] 114 92 142 105 103 27 92 133 113 96 ...
##   ..$ partner4: int [1:150] 140 106 145 135 150 28 119 141 128 139 ...
##  $ AG_m      : num [1:600] 1.308 0.328 0.425 1.512 2.092 ...
##  $ AG_f      : num [1:600] 0.148 1.536 -1.325 -0.575 -0.31 ...
##  $ time      : num [1:600] 1 1 1 1 1 1 1 1 1 1 ...
##  $ A         : num [1:300, 1:300] 1 0.0223 0.0236 0.0262 0.0181 ...
##   ..- attr(*, &quot;dimnames&quot;)=List of 2
##   .. ..$ : chr [1:300] &quot;ID4477&quot; &quot;ID4734&quot; &quot;ID4979&quot; &quot;ID4542&quot; ...
##   .. ..$ : chr [1:300] &quot;ID4477&quot; &quot;ID4734&quot; &quot;ID4979&quot; &quot;ID4542&quot; ...</code></pre>
<p>Let’s now estimate the model.</p>
<div class="sourceCode" id="cb123"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb123-1"><a href="between-partner-sam.html#cb123-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(rstan)</span>
<span id="cb123-2"><a href="between-partner-sam.html#cb123-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb123-3"><a href="between-partner-sam.html#cb123-3" aria-hidden="true" tabindex="-1"></a>sam_3<span class="fl">.2</span> <span class="ot">=</span> <span class="fu">stan_model</span>(<span class="st">&quot;sam3_2.stan&quot;</span>)</span></code></pre></div>
<pre><code>## Warning in system(paste(CXX, ARGS), ignore.stdout = TRUE, ignore.stderr = TRUE): &#39;C:/rtools40/usr/mingw_/bin/g++&#39; not found</code></pre>
<div class="sourceCode" id="cb125"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb125-1"><a href="between-partner-sam.html#cb125-1" aria-hidden="true" tabindex="-1"></a>stan_results3<span class="fl">.2</span> <span class="ot">&lt;-</span> <span class="fu">sampling</span>(sam_3<span class="fl">.2</span>, <span class="at">data=</span>stan_data, <span class="at">init =</span> <span class="dv">0</span>, <span class="at">warmup=</span><span class="dv">1500</span>, <span class="at">iter =</span> <span class="dv">6000</span>,</span>
<span id="cb125-2"><a href="between-partner-sam.html#cb125-2" aria-hidden="true" tabindex="-1"></a>                         <span class="at">chains=</span><span class="dv">4</span>, <span class="at">cores=</span><span class="dv">4</span>, <span class="at">control=</span><span class="fu">list</span>(<span class="at">adapt_delta=</span><span class="fl">0.90</span>) )</span>
<span id="cb125-3"><a href="between-partner-sam.html#cb125-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-4"><a href="between-partner-sam.html#cb125-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(bayesplot)</span>
<span id="cb125-5"><a href="between-partner-sam.html#cb125-5" aria-hidden="true" tabindex="-1"></a><span class="fu">mcmc_areas</span>(stan_results3<span class="fl">.2</span>, <span class="at">pars =</span> <span class="fu">c</span>( <span class="st">&quot;psi_1&quot;</span>, <span class="st">&quot;beta_B&quot;</span>, <span class="st">&quot;V_P[1]&quot;</span>, <span class="st">&quot;V_P[2]&quot;</span>, <span class="st">&quot;Gcor[2,1]&quot;</span>, <span class="st">&quot;Ecor[2,1]&quot;</span>, <span class="st">&quot;Rcor[2,1]&quot;</span>, </span>
<span id="cb125-6"><a href="between-partner-sam.html#cb125-6" aria-hidden="true" tabindex="-1"></a>                                      <span class="st">&quot;Pcor[2,1]&quot;</span>,  <span class="st">&quot;SRN_h2[1]&quot;</span>,  <span class="st">&quot;SRN_h2[2]&quot;</span>), <span class="at">prob =</span> <span class="fl">0.9</span> )</span></code></pre></div>
<p><img src="SAMs_files/figure-html/unnamed-chunk-54-1.png" width="672" /></p>
<p>Overall, it seems the model is doing a good job of detecting the population SRN slope (-0.5), albeit with some uncertainty, as well as the range of the phenotypic variance of SRN intercepts and slopes (0.6), the phenotypic correlation between SRN parameters (0.3), and the SRN heritability of intercepts and slopes (0.5).</p>
</div>
<div id="estimating-assortment" class="section level2" number="3.3">
<h2><span class="header-section-number">3.3</span> Estimating assortment</h2>
<p>We can also now use the mean partner values calculated in the new model to estimate the assortment coefficients of interest. We expect for this within-individual centered model to do a better job of detecting the known positive assortment between individual and social partners’ SRN intercepts.</p>
<div class="sourceCode" id="cb126"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb126-1"><a href="between-partner-sam.html#cb126-1" aria-hidden="true" tabindex="-1"></a><span class="co">#extract posteriors</span></span>
<span id="cb126-2"><a href="between-partner-sam.html#cb126-2" aria-hidden="true" tabindex="-1"></a>post <span class="ot">&lt;-</span> rstan<span class="sc">::</span><span class="fu">extract</span>(stan_results3<span class="fl">.2</span>)</span>
<span id="cb126-3"><a href="between-partner-sam.html#cb126-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-4"><a href="between-partner-sam.html#cb126-4" aria-hidden="true" tabindex="-1"></a><span class="co">#temporary vectors for assortment coefficients</span></span>
<span id="cb126-5"><a href="between-partner-sam.html#cb126-5" aria-hidden="true" tabindex="-1"></a>SRN_PV <span class="ot">=</span> post<span class="sc">$</span>V_P</span>
<span id="cb126-6"><a href="between-partner-sam.html#cb126-6" aria-hidden="true" tabindex="-1"></a>SRN_Psd <span class="ot">=</span> post<span class="sc">$</span>sd_P</span>
<span id="cb126-7"><a href="between-partner-sam.html#cb126-7" aria-hidden="true" tabindex="-1"></a>SRN_PVmean <span class="ot">=</span> post<span class="sc">$</span>V_P <span class="sc">/</span> I_partner <span class="co">#expected variance for mean of partners</span></span>
<span id="cb126-8"><a href="between-partner-sam.html#cb126-8" aria-hidden="true" tabindex="-1"></a>SRN_Psdmean <span class="ot">=</span> <span class="fu">sqrt</span>(SRN_PVmean) <span class="co">#expected SD for mean of partners</span></span>
<span id="cb126-9"><a href="between-partner-sam.html#cb126-9" aria-hidden="true" tabindex="-1"></a>SRN_focal1 <span class="ot">&lt;-</span> post<span class="sc">$</span>SRN_P[,,<span class="dv">1</span>] <span class="co">#individual intercepts</span></span>
<span id="cb126-10"><a href="between-partner-sam.html#cb126-10" aria-hidden="true" tabindex="-1"></a>SRN_focal2 <span class="ot">&lt;-</span> post<span class="sc">$</span>SRN_P[,,<span class="dv">2</span>] <span class="co">#individual slopes</span></span>
<span id="cb126-11"><a href="between-partner-sam.html#cb126-11" aria-hidden="true" tabindex="-1"></a>SRN_partner1 <span class="ot">&lt;-</span> <span class="fu">cbind</span>(post<span class="sc">$</span>partner_meanm[,,<span class="dv">1</span>], post<span class="sc">$</span>partner_meanf[,,<span class="dv">1</span>])</span>
<span id="cb126-12"><a href="between-partner-sam.html#cb126-12" aria-hidden="true" tabindex="-1"></a>SRN_partner2 <span class="ot">&lt;-</span> <span class="fu">cbind</span>(post<span class="sc">$</span>partner_meanm[,,<span class="dv">2</span>], post<span class="sc">$</span>partner_meanf[,,<span class="dv">2</span>])</span>
<span id="cb126-13"><a href="between-partner-sam.html#cb126-13" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb126-14"><a href="between-partner-sam.html#cb126-14" aria-hidden="true" tabindex="-1"></a><span class="co">#scale mean partner variance to variance of single partner</span></span>
<span id="cb126-15"><a href="between-partner-sam.html#cb126-15" aria-hidden="true" tabindex="-1"></a>SRN_partner1s <span class="ot">=</span> SRN_partner1</span>
<span id="cb126-16"><a href="between-partner-sam.html#cb126-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span>(j <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(SRN_partner1))</span>
<span id="cb126-17"><a href="between-partner-sam.html#cb126-17" aria-hidden="true" tabindex="-1"></a>    {SRN_partner1s[j,] <span class="ot">=</span> ( SRN_partner1[j,] <span class="sc">/</span> SRN_Psdmean[j,<span class="dv">1</span>] ) <span class="sc">*</span> SRN_Psd[j,<span class="dv">1</span>] }</span>
<span id="cb126-18"><a href="between-partner-sam.html#cb126-18" aria-hidden="true" tabindex="-1"></a>   </span>
<span id="cb126-19"><a href="between-partner-sam.html#cb126-19" aria-hidden="true" tabindex="-1"></a>SRN_partner2s <span class="ot">=</span> SRN_partner2</span>
<span id="cb126-20"><a href="between-partner-sam.html#cb126-20" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span>(j <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(SRN_partner2))</span>
<span id="cb126-21"><a href="between-partner-sam.html#cb126-21" aria-hidden="true" tabindex="-1"></a>    {SRN_partner2s[j,] <span class="ot">=</span> ( SRN_partner2[j,] <span class="sc">/</span> SRN_Psdmean[j,<span class="dv">2</span>] ) <span class="sc">*</span> SRN_Psd[j,<span class="dv">2</span>] }</span>
<span id="cb126-22"><a href="between-partner-sam.html#cb126-22" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb126-23"><a href="between-partner-sam.html#cb126-23" aria-hidden="true" tabindex="-1"></a><span class="co">#assortment matrix</span></span>
<span id="cb126-24"><a href="between-partner-sam.html#cb126-24" aria-hidden="true" tabindex="-1"></a>Beta_alpha <span class="ot">=</span> <span class="fu">list</span>()</span>
<span id="cb126-25"><a href="between-partner-sam.html#cb126-25" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb126-26"><a href="between-partner-sam.html#cb126-26" aria-hidden="true" tabindex="-1"></a><span class="co">#generate matrices across each posterior sample</span></span>
<span id="cb126-27"><a href="between-partner-sam.html#cb126-27" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(j <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(SRN_focal1))</span>
<span id="cb126-28"><a href="between-partner-sam.html#cb126-28" aria-hidden="true" tabindex="-1"></a>    {</span>
<span id="cb126-29"><a href="between-partner-sam.html#cb126-29" aria-hidden="true" tabindex="-1"></a>            Beta_mat <span class="ot">=</span> <span class="fu">matrix</span>(<span class="cn">NA</span>,<span class="dv">2</span>,<span class="dv">2</span>)</span>
<span id="cb126-30"><a href="between-partner-sam.html#cb126-30" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb126-31"><a href="between-partner-sam.html#cb126-31" aria-hidden="true" tabindex="-1"></a>            <span class="co">#mu&#39; ~ mu</span></span>
<span id="cb126-32"><a href="between-partner-sam.html#cb126-32" aria-hidden="true" tabindex="-1"></a>            Beta_mat[<span class="dv">1</span>,<span class="dv">1</span>] <span class="ot">=</span>  <span class="fu">cov</span>(SRN_focal1[j,], SRN_partner1s[j,])<span class="sc">/</span><span class="fu">var</span>(SRN_focal1[j,])</span>
<span id="cb126-33"><a href="between-partner-sam.html#cb126-33" aria-hidden="true" tabindex="-1"></a>            <span class="co">#mu&#39; ~ psi</span></span>
<span id="cb126-34"><a href="between-partner-sam.html#cb126-34" aria-hidden="true" tabindex="-1"></a>            Beta_mat[<span class="dv">2</span>,<span class="dv">1</span>] <span class="ot">=</span>  <span class="fu">cov</span>(SRN_focal2[j,], SRN_partner1s[j,])<span class="sc">/</span><span class="fu">var</span>(SRN_focal2[j,])</span>
<span id="cb126-35"><a href="between-partner-sam.html#cb126-35" aria-hidden="true" tabindex="-1"></a>            <span class="co">#psi&#39; ~ mu                                                        </span></span>
<span id="cb126-36"><a href="between-partner-sam.html#cb126-36" aria-hidden="true" tabindex="-1"></a>            Beta_mat[<span class="dv">1</span>,<span class="dv">2</span>] <span class="ot">=</span>  <span class="fu">cov</span>(SRN_focal1[j,], SRN_partner2s[j,])<span class="sc">/</span><span class="fu">var</span>(SRN_focal1[j,])</span>
<span id="cb126-37"><a href="between-partner-sam.html#cb126-37" aria-hidden="true" tabindex="-1"></a>            <span class="co">#psi&#39; ~ psi</span></span>
<span id="cb126-38"><a href="between-partner-sam.html#cb126-38" aria-hidden="true" tabindex="-1"></a>            Beta_mat[<span class="dv">2</span>,<span class="dv">2</span>] <span class="ot">=</span>  <span class="fu">cov</span>(SRN_focal2[j,], SRN_partner2s[j,])<span class="sc">/</span><span class="fu">var</span>(SRN_focal2[j,])</span>
<span id="cb126-39"><a href="between-partner-sam.html#cb126-39" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb126-40"><a href="between-partner-sam.html#cb126-40" aria-hidden="true" tabindex="-1"></a>            Beta_alpha[[j]] <span class="ot">=</span> Beta_mat</span>
<span id="cb126-41"><a href="between-partner-sam.html#cb126-41" aria-hidden="true" tabindex="-1"></a>    } </span>
<span id="cb126-42"><a href="between-partner-sam.html#cb126-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-43"><a href="between-partner-sam.html#cb126-43" aria-hidden="true" tabindex="-1"></a><span class="co">#extract beta_mu&#39;mu (assortment on SRN intercepts)</span></span>
<span id="cb126-44"><a href="between-partner-sam.html#cb126-44" aria-hidden="true" tabindex="-1"></a>Beta_mu <span class="ot">=</span> <span class="fu">unlist</span>(<span class="fu">lapply</span>(Beta_alpha, <span class="cf">function</span>(x) x[<span class="dv">1</span>,<span class="dv">1</span>]))</span>
<span id="cb126-45"><a href="between-partner-sam.html#cb126-45" aria-hidden="true" tabindex="-1"></a><span class="fu">mean</span>(Beta_mu); <span class="fu">sum</span>(Beta_mu <span class="sc">&gt;</span> <span class="dv">0</span>)<span class="sc">/</span><span class="fu">length</span>(Beta_mu)</span></code></pre></div>
<pre><code>## [1] 0.1041053</code></pre>
<pre><code>## [1] 0.9177778</code></pre>
<p>As expected, although the estimated assortment coefficient <span class="math inline">\(\beta_{\bar{\mu&#39;}\mu}\)</span> is downwardly estimated from its true value 0.3, positive assortment of moderate effect size is detected.</p>
</div>
<div id="phenotypic-model-1" class="section level2" number="3.4">
<h2><span class="header-section-number">3.4</span> Phenotypic model</h2>
<p>A phenotypic between partner model can also be estimated whenever quantitative genetic information is missing.</p>
<div class="sourceCode" id="cb129"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb129-1"><a href="between-partner-sam.html#cb129-1" aria-hidden="true" tabindex="-1"></a><span class="fu">write</span>(<span class="st">&quot;</span></span>
<span id="cb129-2"><a href="between-partner-sam.html#cb129-2" aria-hidden="true" tabindex="-1"></a><span class="st">data {</span></span>
<span id="cb129-3"><a href="between-partner-sam.html#cb129-3" aria-hidden="true" tabindex="-1"></a><span class="st">  </span></span>
<span id="cb129-4"><a href="between-partner-sam.html#cb129-4" aria-hidden="true" tabindex="-1"></a><span class="st">  //indices and scalars used for model specification</span></span>
<span id="cb129-5"><a href="between-partner-sam.html#cb129-5" aria-hidden="true" tabindex="-1"></a><span class="st">  int&lt;lower=1&gt; N_sex; //total aggression observations per sex (I/2 * 4 lifetime partners)</span></span>
<span id="cb129-6"><a href="between-partner-sam.html#cb129-6" aria-hidden="true" tabindex="-1"></a><span class="st">  int&lt;lower=0&gt; I; //total individuals (M + F)</span></span>
<span id="cb129-7"><a href="between-partner-sam.html#cb129-7" aria-hidden="true" tabindex="-1"></a><span class="st">  int&lt;lower=0&gt; Im; //number of males</span></span>
<span id="cb129-8"><a href="between-partner-sam.html#cb129-8" aria-hidden="true" tabindex="-1"></a><span class="st">  int&lt;lower=0&gt; If; //number of females</span></span>
<span id="cb129-9"><a href="between-partner-sam.html#cb129-9" aria-hidden="true" tabindex="-1"></a><span class="st">  int&lt;lower=1&gt; idm[N_sex]; //index of male AG observations (of length N_sex)</span></span>
<span id="cb129-10"><a href="between-partner-sam.html#cb129-10" aria-hidden="true" tabindex="-1"></a><span class="st">  int&lt;lower=1&gt; idf[N_sex]; //index of female AG observations</span></span>
<span id="cb129-11"><a href="between-partner-sam.html#cb129-11" aria-hidden="true" tabindex="-1"></a><span class="st">  int&lt;lower=1&gt; partners_m [Im,5]; //index of male partner IDs, first column is focal ID (1 + 4 IDs)</span></span>
<span id="cb129-12"><a href="between-partner-sam.html#cb129-12" aria-hidden="true" tabindex="-1"></a><span class="st">  int&lt;lower=1&gt; partners_f [If,5]; //index of female partner IDs, first column is focal ID (1 + 4 IDs)</span></span>
<span id="cb129-13"><a href="between-partner-sam.html#cb129-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-14"><a href="between-partner-sam.html#cb129-14" aria-hidden="true" tabindex="-1"></a><span class="st">  //empirical data</span></span>
<span id="cb129-15"><a href="between-partner-sam.html#cb129-15" aria-hidden="true" tabindex="-1"></a><span class="st">  matrix[I,I] A; //relatedness matrix</span></span>
<span id="cb129-16"><a href="between-partner-sam.html#cb129-16" aria-hidden="true" tabindex="-1"></a><span class="st">  real AG_m[N_sex]; //male aggression measurements</span></span>
<span id="cb129-17"><a href="between-partner-sam.html#cb129-17" aria-hidden="true" tabindex="-1"></a><span class="st">  real AG_f[N_sex]; //female aggression measurements</span></span>
<span id="cb129-18"><a href="between-partner-sam.html#cb129-18" aria-hidden="true" tabindex="-1"></a><span class="st">  real time[N_sex]; //time index (=1 for all measures)</span></span>
<span id="cb129-19"><a href="between-partner-sam.html#cb129-19" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb129-20"><a href="between-partner-sam.html#cb129-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-21"><a href="between-partner-sam.html#cb129-21" aria-hidden="true" tabindex="-1"></a><span class="st">transformed data{</span></span>
<span id="cb129-22"><a href="between-partner-sam.html#cb129-22" aria-hidden="true" tabindex="-1"></a><span class="st">  matrix[I,I] LA = cholesky_decompose(A); //lower-triangle A matrix</span></span>
<span id="cb129-23"><a href="between-partner-sam.html#cb129-23" aria-hidden="true" tabindex="-1"></a><span class="st">  </span></span>
<span id="cb129-24"><a href="between-partner-sam.html#cb129-24" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb129-25"><a href="between-partner-sam.html#cb129-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-26"><a href="between-partner-sam.html#cb129-26" aria-hidden="true" tabindex="-1"></a><span class="st">parameters {</span></span>
<span id="cb129-27"><a href="between-partner-sam.html#cb129-27" aria-hidden="true" tabindex="-1"></a><span class="st">  //population effects</span></span>
<span id="cb129-28"><a href="between-partner-sam.html#cb129-28" aria-hidden="true" tabindex="-1"></a><span class="st">  real alpha_0; //aggression global intercept</span></span>
<span id="cb129-29"><a href="between-partner-sam.html#cb129-29" aria-hidden="true" tabindex="-1"></a><span class="st">  real psi_1; //expected interaction coefficient</span></span>
<span id="cb129-30"><a href="between-partner-sam.html#cb129-30" aria-hidden="true" tabindex="-1"></a><span class="st">  real beta_B; //slope of between-partner component</span></span>
<span id="cb129-31"><a href="between-partner-sam.html#cb129-31" aria-hidden="true" tabindex="-1"></a><span class="st">  </span></span>
<span id="cb129-32"><a href="between-partner-sam.html#cb129-32" aria-hidden="true" tabindex="-1"></a><span class="st">  //no way to partition feedback when t=1</span></span>
<span id="cb129-33"><a href="between-partner-sam.html#cb129-33" aria-hidden="true" tabindex="-1"></a><span class="st">  //real&lt;lower=-1,upper=1&gt; phi; //(-1,1) ensures unique solution</span></span>
<span id="cb129-34"><a href="between-partner-sam.html#cb129-34" aria-hidden="true" tabindex="-1"></a><span class="st">  </span></span>
<span id="cb129-35"><a href="between-partner-sam.html#cb129-35" aria-hidden="true" tabindex="-1"></a><span class="st">  //random effects (standard deviations)</span></span>
<span id="cb129-36"><a href="between-partner-sam.html#cb129-36" aria-hidden="true" tabindex="-1"></a><span class="st">  vector&lt;lower=0, upper = 1&gt;[2] sd_P; //phenotypic SRN mu &amp; psi SDs</span></span>
<span id="cb129-37"><a href="between-partner-sam.html#cb129-37" aria-hidden="true" tabindex="-1"></a><span class="st">  vector&lt;lower=0, upper = 1&gt;[2] sd_R; //male &amp; female residual SDs</span></span>
<span id="cb129-38"><a href="between-partner-sam.html#cb129-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-39"><a href="between-partner-sam.html#cb129-39" aria-hidden="true" tabindex="-1"></a><span class="st">  cholesky_factor_corr[2] LP; //phenotypic SRN correlations</span></span>
<span id="cb129-40"><a href="between-partner-sam.html#cb129-40" aria-hidden="true" tabindex="-1"></a><span class="st">  cholesky_factor_corr[2] LR; //sex-specific residual correlations</span></span>
<span id="cb129-41"><a href="between-partner-sam.html#cb129-41" aria-hidden="true" tabindex="-1"></a><span class="st">  </span></span>
<span id="cb129-42"><a href="between-partner-sam.html#cb129-42" aria-hidden="true" tabindex="-1"></a><span class="st">  matrix[I,2] std_devP; //individual-level unscaled G SRN deviations</span></span>
<span id="cb129-43"><a href="between-partner-sam.html#cb129-43" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb129-44"><a href="between-partner-sam.html#cb129-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-45"><a href="between-partner-sam.html#cb129-45" aria-hidden="true" tabindex="-1"></a><span class="st">transformed parameters {</span></span>
<span id="cb129-46"><a href="between-partner-sam.html#cb129-46" aria-hidden="true" tabindex="-1"></a><span class="st">  vector&lt;lower=0&gt;[2] sd_P; //SDs of P effects</span></span>
<span id="cb129-47"><a href="between-partner-sam.html#cb129-47" aria-hidden="true" tabindex="-1"></a><span class="st">  </span></span>
<span id="cb129-48"><a href="between-partner-sam.html#cb129-48" aria-hidden="true" tabindex="-1"></a><span class="st">  matrix[I,2] SRN_P; //scaled P SRN parameter deviations</span></span>
<span id="cb129-49"><a href="between-partner-sam.html#cb129-49" aria-hidden="true" tabindex="-1"></a><span class="st">  </span></span>
<span id="cb129-50"><a href="between-partner-sam.html#cb129-50" aria-hidden="true" tabindex="-1"></a><span class="st">  matrix[If, 2] partner_meanm; //average SRN parameters of males&#39; partners</span></span>
<span id="cb129-51"><a href="between-partner-sam.html#cb129-51" aria-hidden="true" tabindex="-1"></a><span class="st">  matrix[Im, 2] partner_meanf; //average SRN parameters of females&#39; partners</span></span>
<span id="cb129-52"><a href="between-partner-sam.html#cb129-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-53"><a href="between-partner-sam.html#cb129-53" aria-hidden="true" tabindex="-1"></a><span class="st">  //non-centered parameterization of phenotypic effects</span></span>
<span id="cb129-54"><a href="between-partner-sam.html#cb129-54" aria-hidden="true" tabindex="-1"></a><span class="st">  SRN_P = std_devP * diag_pre_multiply(sd_P, LP)&#39;;</span></span>
<span id="cb129-55"><a href="between-partner-sam.html#cb129-55" aria-hidden="true" tabindex="-1"></a><span class="st">  </span></span>
<span id="cb129-56"><a href="between-partner-sam.html#cb129-56" aria-hidden="true" tabindex="-1"></a><span class="st">  //calculate the mean SRN parameters of each male&#39;s lifetime partners</span></span>
<span id="cb129-57"><a href="between-partner-sam.html#cb129-57" aria-hidden="true" tabindex="-1"></a><span class="st">  for(i in 1:Im) partner_meanm[i] = [mean(col(SRN_P[partners_m[i,2:5]],1)),</span></span>
<span id="cb129-58"><a href="between-partner-sam.html#cb129-58" aria-hidden="true" tabindex="-1"></a><span class="st">                                mean(col(SRN_P[partners_m[i,2:5]],2))];</span></span>
<span id="cb129-59"><a href="between-partner-sam.html#cb129-59" aria-hidden="true" tabindex="-1"></a><span class="st">  </span></span>
<span id="cb129-60"><a href="between-partner-sam.html#cb129-60" aria-hidden="true" tabindex="-1"></a><span class="st">  //calculate the mean SRN parameters of each female&#39;s lifetime partners</span></span>
<span id="cb129-61"><a href="between-partner-sam.html#cb129-61" aria-hidden="true" tabindex="-1"></a><span class="st">  for(i in 1:If) partner_meanf[i] = [mean(col(SRN_P[partners_f[i,2:5]],1)),</span></span>
<span id="cb129-62"><a href="between-partner-sam.html#cb129-62" aria-hidden="true" tabindex="-1"></a><span class="st">                                mean(col(SRN_P[partners_f[i,2:5]],2))];</span></span>
<span id="cb129-63"><a href="between-partner-sam.html#cb129-63" aria-hidden="true" tabindex="-1"></a><span class="st">  </span></span>
<span id="cb129-64"><a href="between-partner-sam.html#cb129-64" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb129-65"><a href="between-partner-sam.html#cb129-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-66"><a href="between-partner-sam.html#cb129-66" aria-hidden="true" tabindex="-1"></a><span class="st">model{</span></span>
<span id="cb129-67"><a href="between-partner-sam.html#cb129-67" aria-hidden="true" tabindex="-1"></a><span class="st">  //separate male and female vectors for efficiency</span></span>
<span id="cb129-68"><a href="between-partner-sam.html#cb129-68" aria-hidden="true" tabindex="-1"></a><span class="st">  matrix[Im,2] SRN_Pm = SRN_P[1:Im]; //male SRN phenotypic deviations</span></span>
<span id="cb129-69"><a href="between-partner-sam.html#cb129-69" aria-hidden="true" tabindex="-1"></a><span class="st">  matrix[If,2] SRN_Pf = SRN_P[(Im+1):I]; //female SRN phenotypic deviations</span></span>
<span id="cb129-70"><a href="between-partner-sam.html#cb129-70" aria-hidden="true" tabindex="-1"></a><span class="st">  </span></span>
<span id="cb129-71"><a href="between-partner-sam.html#cb129-71" aria-hidden="true" tabindex="-1"></a><span class="st">  //separate SRN intercepts and slopes (phenotypic deviations)</span></span>
<span id="cb129-72"><a href="between-partner-sam.html#cb129-72" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[Im] mu_m = col(SRN_Pm,1); //SRN intercepts</span></span>
<span id="cb129-73"><a href="between-partner-sam.html#cb129-73" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[If] mu_f = col(SRN_Pf,1); </span></span>
<span id="cb129-74"><a href="between-partner-sam.html#cb129-74" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[Im] psi_m = col(SRN_Pm,2); //SRN slopes</span></span>
<span id="cb129-75"><a href="between-partner-sam.html#cb129-75" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[If] psi_f = col(SRN_Pf,2); </span></span>
<span id="cb129-76"><a href="between-partner-sam.html#cb129-76" aria-hidden="true" tabindex="-1"></a><span class="st">  </span></span>
<span id="cb129-77"><a href="between-partner-sam.html#cb129-77" aria-hidden="true" tabindex="-1"></a><span class="st">  //separate mean partner SRN intercepts and slopes</span></span>
<span id="cb129-78"><a href="between-partner-sam.html#cb129-78" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[Im] mu_meanm = col(partner_meanm,1); //mean partner SRN intercept for males</span></span>
<span id="cb129-79"><a href="between-partner-sam.html#cb129-79" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[If] mu_meanf = col(partner_meanf,1); //...for females</span></span>
<span id="cb129-80"><a href="between-partner-sam.html#cb129-80" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[Im] psi_meanm = col(partner_meanm,2); //mean partner SRN slope for males</span></span>
<span id="cb129-81"><a href="between-partner-sam.html#cb129-81" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[If] psi_meanf = col(partner_meanf,2); //...for females </span></span>
<span id="cb129-82"><a href="between-partner-sam.html#cb129-82" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-83"><a href="between-partner-sam.html#cb129-83" aria-hidden="true" tabindex="-1"></a><span class="st">  //add in new vectors for within-individual centering</span></span>
<span id="cb129-84"><a href="between-partner-sam.html#cb129-84" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[N_sex] eta_Wm; //male SRN trait value </span></span>
<span id="cb129-85"><a href="between-partner-sam.html#cb129-85" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[N_sex] eta_Wf; //female SRN trait value</span></span>
<span id="cb129-86"><a href="between-partner-sam.html#cb129-86" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[N_sex] eta_Bm; //individual male SRN trait value toward average partner </span></span>
<span id="cb129-87"><a href="between-partner-sam.html#cb129-87" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[N_sex] eta_Bf; //individual female SRN trait toward average partner</span></span>
<span id="cb129-88"><a href="between-partner-sam.html#cb129-88" aria-hidden="true" tabindex="-1"></a><span class="st">  </span></span>
<span id="cb129-89"><a href="between-partner-sam.html#cb129-89" aria-hidden="true" tabindex="-1"></a><span class="st">  //other components of linear predictor</span></span>
<span id="cb129-90"><a href="between-partner-sam.html#cb129-90" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[N_sex] linpred_m; //total expected value for male responses</span></span>
<span id="cb129-91"><a href="between-partner-sam.html#cb129-91" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[N_sex] linpred_f; //total expected value for female responses</span></span>
<span id="cb129-92"><a href="between-partner-sam.html#cb129-92" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[N_sex] epsilon_m; //residual for male responses</span></span>
<span id="cb129-93"><a href="between-partner-sam.html#cb129-93" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[N_sex] epsilon_f; //residual for female responses</span></span>
<span id="cb129-94"><a href="between-partner-sam.html#cb129-94" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-95"><a href="between-partner-sam.html#cb129-95" aria-hidden="true" tabindex="-1"></a><span class="st">  //Male and female aggression response model</span></span>
<span id="cb129-96"><a href="between-partner-sam.html#cb129-96" aria-hidden="true" tabindex="-1"></a><span class="st">  for (n in 1:N_sex) {</span></span>
<span id="cb129-97"><a href="between-partner-sam.html#cb129-97" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-98"><a href="between-partner-sam.html#cb129-98" aria-hidden="true" tabindex="-1"></a><span class="st">  //SRN trait values (within-individual centered)</span></span>
<span id="cb129-99"><a href="between-partner-sam.html#cb129-99" aria-hidden="true" tabindex="-1"></a><span class="st">  //there is no residual feedback, so only t = 1</span></span>
<span id="cb129-100"><a href="between-partner-sam.html#cb129-100" aria-hidden="true" tabindex="-1"></a><span class="st">        //within-male male eta[t=1] = mu_j + (psi + psi_j)*(mu_k - mean_mu_K)</span></span>
<span id="cb129-101"><a href="between-partner-sam.html#cb129-101" aria-hidden="true" tabindex="-1"></a><span class="st">        eta_Wm[n] = mu_m[idm[n]] +  (psi_1 + psi_m[idm[n]])*(mu_f[idf[n]] - mu_meanm[idm[n]]) ;</span></span>
<span id="cb129-102"><a href="between-partner-sam.html#cb129-102" aria-hidden="true" tabindex="-1"></a><span class="st">        </span></span>
<span id="cb129-103"><a href="between-partner-sam.html#cb129-103" aria-hidden="true" tabindex="-1"></a><span class="st">        //female eta[t=1] = mu_k + (psi + psi_k)*(mu_j - mean_mu_J)</span></span>
<span id="cb129-104"><a href="between-partner-sam.html#cb129-104" aria-hidden="true" tabindex="-1"></a><span class="st">        eta_Wf[n] = mu_f[idf[n]] +   (psi_1 + psi_f[idf[n]])*(mu_m[idm[n]] - mu_meanf[idf[n]]);</span></span>
<span id="cb129-105"><a href="between-partner-sam.html#cb129-105" aria-hidden="true" tabindex="-1"></a><span class="st">  </span></span>
<span id="cb129-106"><a href="between-partner-sam.html#cb129-106" aria-hidden="true" tabindex="-1"></a><span class="st">        //average time=1 individual eta (used for feedback process)</span></span>
<span id="cb129-107"><a href="between-partner-sam.html#cb129-107" aria-hidden="true" tabindex="-1"></a><span class="st">        //between male eta[t=1] = mu_j + psi_j*mean_mu_K</span></span>
<span id="cb129-108"><a href="between-partner-sam.html#cb129-108" aria-hidden="true" tabindex="-1"></a><span class="st">        eta_Bm[n] = (psi_1 + psi_m[idm[n]])*mu_meanm[idm[n]];</span></span>
<span id="cb129-109"><a href="between-partner-sam.html#cb129-109" aria-hidden="true" tabindex="-1"></a><span class="st">        </span></span>
<span id="cb129-110"><a href="between-partner-sam.html#cb129-110" aria-hidden="true" tabindex="-1"></a><span class="st">        //between female eta[t=1] = mu_k + psi_k*mean_mu_J</span></span>
<span id="cb129-111"><a href="between-partner-sam.html#cb129-111" aria-hidden="true" tabindex="-1"></a><span class="st">        eta_Bf[n] = (psi_1 + psi_f[idf[n]])*mu_meanf[idf[n]];</span></span>
<span id="cb129-112"><a href="between-partner-sam.html#cb129-112" aria-hidden="true" tabindex="-1"></a><span class="st">        </span></span>
<span id="cb129-113"><a href="between-partner-sam.html#cb129-113" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-114"><a href="between-partner-sam.html#cb129-114" aria-hidden="true" tabindex="-1"></a><span class="st">  //add global intercept and between-individual parameters to linear predictor</span></span>
<span id="cb129-115"><a href="between-partner-sam.html#cb129-115" aria-hidden="true" tabindex="-1"></a><span class="st">  //other fixed effects can also be added here</span></span>
<span id="cb129-116"><a href="between-partner-sam.html#cb129-116" aria-hidden="true" tabindex="-1"></a><span class="st">   linpred_m[n] = alpha_0 + eta_Wm[n] + beta_B*eta_Bm[n] ;</span></span>
<span id="cb129-117"><a href="between-partner-sam.html#cb129-117" aria-hidden="true" tabindex="-1"></a><span class="st">   linpred_f[n] = alpha_0 + eta_Wf[n] + beta_B*eta_Bf[n] ;</span></span>
<span id="cb129-118"><a href="between-partner-sam.html#cb129-118" aria-hidden="true" tabindex="-1"></a><span class="st">   </span></span>
<span id="cb129-119"><a href="between-partner-sam.html#cb129-119" aria-hidden="true" tabindex="-1"></a><span class="st">   //there is no residual feedback, so only t = 1</span></span>
<span id="cb129-120"><a href="between-partner-sam.html#cb129-120" aria-hidden="true" tabindex="-1"></a><span class="st">        epsilon_m [n] = AG_m[n] - linpred_m[n];</span></span>
<span id="cb129-121"><a href="between-partner-sam.html#cb129-121" aria-hidden="true" tabindex="-1"></a><span class="st">        epsilon_f [n] = AG_f[n] - linpred_f[n];</span></span>
<span id="cb129-122"><a href="between-partner-sam.html#cb129-122" aria-hidden="true" tabindex="-1"></a><span class="st">   </span></span>
<span id="cb129-123"><a href="between-partner-sam.html#cb129-123" aria-hidden="true" tabindex="-1"></a><span class="st">  //correlated residuals between partners</span></span>
<span id="cb129-124"><a href="between-partner-sam.html#cb129-124" aria-hidden="true" tabindex="-1"></a><span class="st">   [epsilon_m[n],epsilon_f[n]]&#39; ~ multi_normal_cholesky([0,0], diag_pre_multiply(sd_R, LR));</span></span>
<span id="cb129-125"><a href="between-partner-sam.html#cb129-125" aria-hidden="true" tabindex="-1"></a><span class="st">  }</span></span>
<span id="cb129-126"><a href="between-partner-sam.html#cb129-126" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-127"><a href="between-partner-sam.html#cb129-127" aria-hidden="true" tabindex="-1"></a><span class="st">//model priors</span></span>
<span id="cb129-128"><a href="between-partner-sam.html#cb129-128" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-129"><a href="between-partner-sam.html#cb129-129" aria-hidden="true" tabindex="-1"></a><span class="st">  //fixed effects</span></span>
<span id="cb129-130"><a href="between-partner-sam.html#cb129-130" aria-hidden="true" tabindex="-1"></a><span class="st">  alpha_0 ~ std_normal();</span></span>
<span id="cb129-131"><a href="between-partner-sam.html#cb129-131" aria-hidden="true" tabindex="-1"></a><span class="st">  psi_1 ~ std_normal();</span></span>
<span id="cb129-132"><a href="between-partner-sam.html#cb129-132" aria-hidden="true" tabindex="-1"></a><span class="st">  beta_B ~ std_normal();</span></span>
<span id="cb129-133"><a href="between-partner-sam.html#cb129-133" aria-hidden="true" tabindex="-1"></a><span class="st">  </span></span>
<span id="cb129-134"><a href="between-partner-sam.html#cb129-134" aria-hidden="true" tabindex="-1"></a><span class="st">  //random effects</span></span>
<span id="cb129-135"><a href="between-partner-sam.html#cb129-135" aria-hidden="true" tabindex="-1"></a><span class="st">  to_vector(sd_P) ~ cauchy(0,1);</span></span>
<span id="cb129-136"><a href="between-partner-sam.html#cb129-136" aria-hidden="true" tabindex="-1"></a><span class="st">  to_vector(sd_R) ~ cauchy(0,1);</span></span>
<span id="cb129-137"><a href="between-partner-sam.html#cb129-137" aria-hidden="true" tabindex="-1"></a><span class="st">  </span></span>
<span id="cb129-138"><a href="between-partner-sam.html#cb129-138" aria-hidden="true" tabindex="-1"></a><span class="st">  LP ~ lkj_corr_cholesky(2);</span></span>
<span id="cb129-139"><a href="between-partner-sam.html#cb129-139" aria-hidden="true" tabindex="-1"></a><span class="st">  LR ~ lkj_corr_cholesky(2);</span></span>
<span id="cb129-140"><a href="between-partner-sam.html#cb129-140" aria-hidden="true" tabindex="-1"></a><span class="st">  </span></span>
<span id="cb129-141"><a href="between-partner-sam.html#cb129-141" aria-hidden="true" tabindex="-1"></a><span class="st">  to_vector(std_devP) ~ std_normal();</span></span>
<span id="cb129-142"><a href="between-partner-sam.html#cb129-142" aria-hidden="true" tabindex="-1"></a><span class="st">  </span></span>
<span id="cb129-143"><a href="between-partner-sam.html#cb129-143" aria-hidden="true" tabindex="-1"></a><span class="st">  //reaction norm heritability</span></span>
<span id="cb129-144"><a href="between-partner-sam.html#cb129-144" aria-hidden="true" tabindex="-1"></a><span class="st">  to_vector(SRN_h2) ~ beta(1.2,1.2);</span></span>
<span id="cb129-145"><a href="between-partner-sam.html#cb129-145" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb129-146"><a href="between-partner-sam.html#cb129-146" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-147"><a href="between-partner-sam.html#cb129-147" aria-hidden="true" tabindex="-1"></a><span class="st">generated quantities{</span></span>
<span id="cb129-148"><a href="between-partner-sam.html#cb129-148" aria-hidden="true" tabindex="-1"></a><span class="st">//cor and cov matrices of SRN parameters and residuals</span></span>
<span id="cb129-149"><a href="between-partner-sam.html#cb129-149" aria-hidden="true" tabindex="-1"></a><span class="st">matrix[2,2] Pcor = LP * LP&#39;; //P SRN correlation matrix</span></span>
<span id="cb129-150"><a href="between-partner-sam.html#cb129-150" aria-hidden="true" tabindex="-1"></a><span class="st">matrix[2,2] Rcor = LR * LR&#39;; //residual correlation matrix</span></span>
<span id="cb129-151"><a href="between-partner-sam.html#cb129-151" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-152"><a href="between-partner-sam.html#cb129-152" aria-hidden="true" tabindex="-1"></a><span class="st">matrix[2,2] Pcov = diag_matrix(sd_P)*Pcor*diag_matrix(sd_P); //phenotypic covariance</span></span>
<span id="cb129-153"><a href="between-partner-sam.html#cb129-153" aria-hidden="true" tabindex="-1"></a><span class="st">matrix[2,2] Rcov = iag_matrix(sd_R)*Rcor*diag_matrix(sd_R); //residual covariance</span></span>
<span id="cb129-154"><a href="between-partner-sam.html#cb129-154" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-155"><a href="between-partner-sam.html#cb129-155" aria-hidden="true" tabindex="-1"></a><span class="st">//variances</span></span>
<span id="cb129-156"><a href="between-partner-sam.html#cb129-156" aria-hidden="true" tabindex="-1"></a><span class="st">vector&lt;lower=0&gt;[2] V_P = sd_P .* sd_P;</span></span>
<span id="cb129-157"><a href="between-partner-sam.html#cb129-157" aria-hidden="true" tabindex="-1"></a><span class="st">vector&lt;lower=0&gt;[2] V_R = sd_R .* sd_R;</span></span>
<span id="cb129-158"><a href="between-partner-sam.html#cb129-158" aria-hidden="true" tabindex="-1"></a><span class="st">}&quot;</span>, <span class="st">&quot;sam3_2p.stan&quot;</span>)</span></code></pre></div>

</div>
</div>
<h3>Resources</h3>
<div id="refs" class="references csl-bib-body hanging-indent">
<div id="ref-SAM" class="csl-entry">
Martin, J. S., and A. V. Jaeggi. 2021. <span>“Social Animal Models for Quantifying Plasticity, Assortment, and Selection on Interacting Phenotypes.”</span> <em>Journal of Evolutionary Biology</em>. <a href="https://doi.org/10.1111/jeb.13900">https://doi.org/10.1111/jeb.13900</a>.
</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="within-partner-sam.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="within-and-between-partner-sam.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"whatsapp": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": null,
"text": null
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": null,
"toc": {
"collapse": "subsection"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
