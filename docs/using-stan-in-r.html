<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>1 Using Stan in R | Estimating Social Animal Models in Stan</title>
  <meta name="description" content="1 Using Stan in R | Estimating Social Animal Models in Stan" />
  <meta name="generator" content="bookdown 0.22 and GitBook 2.6.7" />

  <meta property="og:title" content="1 Using Stan in R | Estimating Social Animal Models in Stan" />
  <meta property="og:type" content="book" />
  
  
  
  

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="1 Using Stan in R | Estimating Social Animal Models in Stan" />
  
  
  

<meta name="author" content="Jordan S. Martin &amp; Adrian V. Jaeggi" />


<meta name="date" content="2021-07-10" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="introduction.html"/>
<link rel="next" href="within-partner-sam.html"/>
<script src="libs/header-attrs-2.8/header-attrs.js"></script>
<script src="libs/jquery-2.2.3/jquery.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />









<link href="libs/anchor-sections-1.0.1/anchor-sections.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.0.1/anchor-sections.js"></script>


<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<style type="text/css">
/* Used with Pandoc 2.11+ new --citeproc when CSL is used */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
}
.hanging div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}
</style>

<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li class="chapter" data-level="" data-path="introduction.html"><a href="introduction.html"><i class="fa fa-check"></i>Introduction</a></li>
<li class="chapter" data-level="1" data-path="using-stan-in-r.html"><a href="using-stan-in-r.html"><i class="fa fa-check"></i><b>1</b> Using Stan in R</a>
<ul>
<li class="chapter" data-level="1.1" data-path="using-stan-in-r.html"><a href="using-stan-in-r.html#why-stan"><i class="fa fa-check"></i><b>1.1</b> Why Stan?</a></li>
<li class="chapter" data-level="1.2" data-path="using-stan-in-r.html"><a href="using-stan-in-r.html#getting-started"><i class="fa fa-check"></i><b>1.2</b> Getting Started</a></li>
<li class="chapter" data-level="1.3" data-path="using-stan-in-r.html"><a href="using-stan-in-r.html#bayesian-inference"><i class="fa fa-check"></i><b>1.3</b> Bayesian inference</a></li>
<li class="chapter" data-level="1.4" data-path="using-stan-in-r.html"><a href="using-stan-in-r.html#basic-coding-tutorial"><i class="fa fa-check"></i><b>1.4</b> Basic coding tutorial</a>
<ul>
<li class="chapter" data-level="1.4.1" data-path="using-stan-in-r.html"><a href="using-stan-in-r.html#cholesky-decompositions"><i class="fa fa-check"></i><b>1.4.1</b> Cholesky decompositions</a></li>
<li class="chapter" data-level="1.4.2" data-path="using-stan-in-r.html"><a href="using-stan-in-r.html#non-centered-random-effects"><i class="fa fa-check"></i><b>1.4.2</b> Non-centered random effects</a></li>
</ul></li>
<li class="chapter" data-level="1.5" data-path="using-stan-in-r.html"><a href="using-stan-in-r.html#animal-models"><i class="fa fa-check"></i><b>1.5</b> Animal models</a>
<ul>
<li class="chapter" data-level="1.5.1" data-path="using-stan-in-r.html"><a href="using-stan-in-r.html#simulate-data"><i class="fa fa-check"></i><b>1.5.1</b> Simulate data</a></li>
<li class="chapter" data-level="1.5.2" data-path="using-stan-in-r.html"><a href="using-stan-in-r.html#kronecker-products"><i class="fa fa-check"></i><b>1.5.2</b> Kronecker products</a></li>
<li class="chapter" data-level="1.5.3" data-path="using-stan-in-r.html"><a href="using-stan-in-r.html#identifying-genetic-effects"><i class="fa fa-check"></i><b>1.5.3</b> Identifying genetic effects</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="2" data-path="within-partner-sam.html"><a href="within-partner-sam.html"><i class="fa fa-check"></i><b>2</b> Within partner SAM</a>
<ul>
<li class="chapter" data-level="2.1" data-path="within-partner-sam.html"><a href="within-partner-sam.html#formal-overview"><i class="fa fa-check"></i><b>2.1</b> Formal overview</a></li>
<li class="chapter" data-level="2.2" data-path="within-partner-sam.html"><a href="within-partner-sam.html#computational-approach"><i class="fa fa-check"></i><b>2.2</b> Computational approach</a></li>
<li class="chapter" data-level="2.3" data-path="within-partner-sam.html"><a href="within-partner-sam.html#simulate-data-1"><i class="fa fa-check"></i><b>2.3</b> Simulate data</a>
<ul>
<li class="chapter" data-level="2.3.1" data-path="within-partner-sam.html"><a href="within-partner-sam.html#srn-parameters"><i class="fa fa-check"></i><b>2.3.1</b> SRN parameters</a></li>
<li class="chapter" data-level="2.3.2" data-path="within-partner-sam.html"><a href="within-partner-sam.html#assortment"><i class="fa fa-check"></i><b>2.3.2</b> Assortment</a></li>
<li class="chapter" data-level="2.3.3" data-path="within-partner-sam.html"><a href="within-partner-sam.html#repeated-measurements-within-the-partner"><i class="fa fa-check"></i><b>2.3.3</b> Repeated measurements within the partner</a></li>
</ul></li>
<li class="chapter" data-level="2.4" data-path="within-partner-sam.html"><a href="within-partner-sam.html#coding-the-model"><i class="fa fa-check"></i><b>2.4</b> Coding the model</a></li>
<li class="chapter" data-level="2.5" data-path="within-partner-sam.html"><a href="within-partner-sam.html#estimating-the-model"><i class="fa fa-check"></i><b>2.5</b> Estimating the model</a></li>
<li class="chapter" data-level="2.6" data-path="within-partner-sam.html"><a href="within-partner-sam.html#failure-to-detect-assortment"><i class="fa fa-check"></i><b>2.6</b> Failure to detect assortment</a></li>
<li class="chapter" data-level="2.7" data-path="within-partner-sam.html"><a href="within-partner-sam.html#phenotypic-model"><i class="fa fa-check"></i><b>2.7</b> Phenotypic model</a></li>
</ul></li>
<li class="chapter" data-level="3" data-path="between-partner-sam.html"><a href="between-partner-sam.html"><i class="fa fa-check"></i><b>3</b> Between partner SAM</a>
<ul>
<li class="chapter" data-level="3.1" data-path="between-partner-sam.html"><a href="between-partner-sam.html#simulate-data-2"><i class="fa fa-check"></i><b>3.1</b> Simulate data</a></li>
<li class="chapter" data-level="3.2" data-path="between-partner-sam.html"><a href="between-partner-sam.html#estimate-the-model"><i class="fa fa-check"></i><b>3.2</b> Estimate the model</a></li>
<li class="chapter" data-level="3.3" data-path="between-partner-sam.html"><a href="between-partner-sam.html#estimating-assortment"><i class="fa fa-check"></i><b>3.3</b> Estimating assortment</a></li>
<li class="chapter" data-level="3.4" data-path="between-partner-sam.html"><a href="between-partner-sam.html#phenotypic-model-1"><i class="fa fa-check"></i><b>3.4</b> Phenotypic model</a></li>
</ul></li>
<li class="chapter" data-level="4" data-path="within-and-between-partner-sam.html"><a href="within-and-between-partner-sam.html"><i class="fa fa-check"></i><b>4</b> Within-and-between partner SAM</a>
<ul>
<li class="chapter" data-level="4.1" data-path="within-and-between-partner-sam.html"><a href="within-and-between-partner-sam.html#simulate-data-3"><i class="fa fa-check"></i><b>4.1</b> Simulate data</a></li>
<li class="chapter" data-level="4.2" data-path="within-and-between-partner-sam.html"><a href="within-and-between-partner-sam.html#estimate-the-model-1"><i class="fa fa-check"></i><b>4.2</b> Estimate the model</a></li>
<li class="chapter" data-level="4.3" data-path="within-and-between-partner-sam.html"><a href="within-and-between-partner-sam.html#estimating-assortment-1"><i class="fa fa-check"></i><b>4.3</b> Estimating assortment</a></li>
<li class="chapter" data-level="4.4" data-path="within-and-between-partner-sam.html"><a href="within-and-between-partner-sam.html#phenotypic-model-2"><i class="fa fa-check"></i><b>4.4</b> Phenotypic model</a></li>
</ul></li>
<li class="chapter" data-level="5" data-path="fitness-model.html"><a href="fitness-model.html"><i class="fa fa-check"></i><b>5</b> Fitness model</a>
<ul>
<li class="chapter" data-level="5.1" data-path="fitness-model.html"><a href="fitness-model.html#simulate-data-4"><i class="fa fa-check"></i><b>5.1</b> Simulate data</a></li>
<li class="chapter" data-level="5.2" data-path="fitness-model.html"><a href="fitness-model.html#estimating-the-model-1"><i class="fa fa-check"></i><b>5.2</b> Estimating the model</a></li>
<li class="chapter" data-level="5.3" data-path="fitness-model.html"><a href="fitness-model.html#estimating-assortment-2"><i class="fa fa-check"></i><b>5.3</b> Estimating assortment</a></li>
<li class="chapter" data-level="5.4" data-path="fitness-model.html"><a href="fitness-model.html#estimating-selection-differentials-and-genetic-responses"><i class="fa fa-check"></i><b>5.4</b> Estimating selection differentials and genetic responses</a></li>
</ul></li>
<li class="chapter" data-level="6" data-path="extending-sams.html"><a href="extending-sams.html"><i class="fa fa-check"></i><b>6</b> Extending SAMs</a></li>
<li class="chapter" data-level="" data-path="resources.html"><a href="resources.html"><i class="fa fa-check"></i>Resources</a></li>
</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Estimating Social Animal Models in Stan</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="using-stan-in-r" class="section level1" number="1">
<h1><span class="header-section-number">1</span> Using Stan in R</h1>
<style>
body {
text-align: justify}
</style>
<div id="why-stan" class="section level2" number="1.1">
<h2><span class="header-section-number">1.1</span> Why Stan?</h2>
<p>SAMs cannot be straightforwardly implemented with currently available software for quantitative genetic analysis, such as the frequentist ASREML program <span class="citation">(<a href="#ref-ASREML" role="doc-biblioref">Butler et al. 2018</a>)</span> or the Bayesian open-source R package MCMCglmm <span class="citation">(<a href="#ref-MCMCglmm" role="doc-biblioref">Hadfield 2010</a>)</span>. The classical animal models estimated by these programs can be used to describe reaction norms defined over non-social environments, with reaction norm slopes estimated on directly measured environmental gradients. However, social environments defined by partner phenotypes present novel challenges for animal models, such as accounting for temporal feedback between social partners’ phenotypes, differentiating the effects of assortment and social plasticity between partners, and avoiding bias due to correlated residual effects on measurements taken within and among social interactions <span class="citation">(<a href="#ref-SAM" role="doc-biblioref">Martin and Jaeggi 2021</a>)</span>. SAMs address these challenges by estimating plasticity, assortment, and selection directly on the latent social reaction norms (SRNs) governing repeatable individual variation. A highly flexible modeling framework is required to estimate these latent (i.e. indirectly measured) interactions with raw empirical data, as well as to use them for predicting social evolutionary change.</p>
<p>Stan <span class="citation">(<a href="#ref-Stan" role="doc-biblioref">Carpenter et al. 2017</a>)</span> is an open-source programming language for estimating probabilistic models of arbitrary complexity, which can interface with multiple statistical environments such as R <span class="citation">(<a href="#ref-Rbase" role="doc-biblioref">R Core Team 2020</a>)</span>. Stan also facilitates fully Bayesian inference using state-of-the-art Markov Chain Monte Carlo (MCMC) sampling techniques. In particular, the No U-Turn Sampler (NUTS) implimented in Stan has been found to perform particularly well for quantitative genetic analysis <span class="citation">(<a href="#ref-MCMCperf" role="doc-biblioref">Nishio and Arakawa 2019</a>)</span>. Stan is thus an ideal platform for flexibly estimating SAMs in any empirical system, as is further discussed in the main text <span class="citation">(<a href="#ref-SAM" role="doc-biblioref">Martin and Jaeggi 2021</a>)</span>. Using Bayesian posteriors rather than point estimates will also promote more robust biological inferences with SAMs, as statistical uncertainty can be easily carried forward across multiple stages of analysis <span class="citation">(<a href="#ref-Stinchcombe2014" role="doc-biblioref">Stinchcombe, Simonsen, and Blows 2014</a>)</span>. This provides a crucial means of quantifying uncertainty in the predicted direction and magnitude of social evolution.</p>
</div>
<div id="getting-started" class="section level2" number="1.2">
<h2><span class="header-section-number">1.2</span> Getting Started</h2>
<p>Stan interfaces with R through the RStan package <span class="citation">(<a href="#ref-Stan" role="doc-biblioref">Carpenter et al. 2017</a>)</span>, providing an efficient means of integrating SAMs into pre-existing data analysis pipelines. However, you will first need to install Stan on your computer and ensure that it is appropriately configured with your C++ toolchain. This can be accomplished by following the instructions for your operating system on the <a href="https://github.com/stan-dev/rstan/wiki/RStan-Getting-Started">RStan Getting Started</a> page. Once you are able to effectively use RStan, you can begin creating the <code>.stan</code> files necessary for estimating SAMs. These files can be composed using RStudio or any text editor, as well as directly in R with <code>write()</code>
</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1-1"><a href="using-stan-in-r.html#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">write</span>(<span class="st">&quot;// for Stan comments</span></span>
<span id="cb1-2"><a href="using-stan-in-r.html#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="st">    functions{...} // Stan models are composed of</span></span>
<span id="cb1-3"><a href="using-stan-in-r.html#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="st">    data {...} // multiple programming blocks</span></span>
<span id="cb1-4"><a href="using-stan-in-r.html#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="st">    transformed data {...} //only data, parameters, and model</span></span>
<span id="cb1-5"><a href="using-stan-in-r.html#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="st">    parameters {...} //blocks are necessary</span></span>
<span id="cb1-6"><a href="using-stan-in-r.html#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="st">    transformed parameters {...}</span></span>
<span id="cb1-7"><a href="using-stan-in-r.html#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="st">    model {...}</span></span>
<span id="cb1-8"><a href="using-stan-in-r.html#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="st">    generated quantities {...} &quot;</span>,</span>
<span id="cb1-9"><a href="using-stan-in-r.html#cb1-9" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;mod1.stan&quot;</span>)</span></code></pre></div>
<p>Once an appropriate <code>.stan</code> file is prepared, it can be compiled in R for the C++ toolchain using the <code>stan_model()</code> function and subsequently estimated with an appropriate list of empirical data using the <code>sampling()</code> function. The resulting posteriors of a model can then be accessed with the <code>extract()</code> function and manipulated for any further quantities or analyses of interest.
</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb2-1"><a href="using-stan-in-r.html#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co">#load package</span></span>
<span id="cb2-2"><a href="using-stan-in-r.html#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(rstan)</span>
<span id="cb2-3"><a href="using-stan-in-r.html#cb2-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-4"><a href="using-stan-in-r.html#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="co">#compiles the model in C++ for MCMC estimation</span></span>
<span id="cb2-5"><a href="using-stan-in-r.html#cb2-5" aria-hidden="true" tabindex="-1"></a>mod1 <span class="ot">=</span> <span class="fu">stan_model</span>(<span class="st">&quot;mod1.stan&quot;</span>)</span>
<span id="cb2-6"><a href="using-stan-in-r.html#cb2-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-7"><a href="using-stan-in-r.html#cb2-7" aria-hidden="true" tabindex="-1"></a><span class="co">#samples posterior distribution of the model with default MCMC settings</span></span>
<span id="cb2-8"><a href="using-stan-in-r.html#cb2-8" aria-hidden="true" tabindex="-1"></a>results <span class="ot">=</span> <span class="fu">sampling</span>(<span class="at">object =</span> mod1, <span class="at">data =</span> data)</span>
<span id="cb2-9"><a href="using-stan-in-r.html#cb2-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-10"><a href="using-stan-in-r.html#cb2-10" aria-hidden="true" tabindex="-1"></a><span class="co">#extracts posterior estimates</span></span>
<span id="cb2-11"><a href="using-stan-in-r.html#cb2-11" aria-hidden="true" tabindex="-1"></a>samples <span class="ot">=</span>  <span class="fu">extract</span>(results)</span></code></pre></div>
</div>
<div id="bayesian-inference" class="section level2" number="1.3">
<h2><span class="header-section-number">1.3</span> Bayesian inference</h2>
<p>A detailed overview of the benefits of Bayesian inference is beyond the scope of this guidebook, as attention is placed on coding and computational concerns rather than interpretation. We encourage researchers unfamiliar with fully Bayesian inference to see <span class="citation"><a href="#ref-Rethinking" role="doc-biblioref">McElreath</a> (<a href="#ref-Rethinking" role="doc-biblioref">2020</a>)</span> for further discussion. <span class="citation"><a href="#ref-Lemoine2019" role="doc-biblioref">Lemoine</a> (<a href="#ref-Lemoine2019" role="doc-biblioref">2019</a>)</span> also demonstrates why weakly regularizing (or “weakly informative”) priors are often preferable to the flat or diffuse priors more commonly used in evolutionary ecology. In general, we encourage researchers to utilize the benefits of fully Bayesian inference while working in Stan, rather than attempting to mimic classical inference and null-hypothesis testing approaches. <span class="citation"><a href="#ref-Gelman2020" role="doc-biblioref">Gelman et al.</a> (<a href="#ref-Gelman2020" role="doc-biblioref">2020</a>)</span> provide a very useful general discussion of Bayesian workflow from initial estimation to model comparison and selection. A basic understanding of MCMC and prior and posterior distributions is necessary to fully understand model estimation in Stan. MCMC provides a means of approximating any continous probability distribution, with a finite set of samples taken in proportion to the underlying target probability density. As a consequence, Stan models return objects with many MCMC samples for each model parameter, rather than single point estimates. These samples can then be summarized to approximate the shape of the truly continous target posterior distribution, as is shown throughout the coding tutorials.</p>
</div>
<div id="basic-coding-tutorial" class="section level2" number="1.4">
<h2><span class="header-section-number">1.4</span> Basic coding tutorial</h2>
<p>Stan uses its own language for writing probabilistic models, including a variety of built-in functions designed to aid in efficient computation. The biggest conceptual hurdle for new users of Stan is likely to be the absence of an intuitive R-like syntax for specifying model formulas, such as formulas like <code>y ~ x + (1|z)</code> that can be used to quickly specify complex generalized linear mixed-effects models. These formulas facilitate highly efficient statistical modeling, but do so at the cost of limiting users’ ability to specify atypical model structures. Instead, Stan provides the benefit of nearly unlimited flexibility in model specification, with the added cost of a steeper learning curve. In particular, models must be formally specified with mathematically appropriate likelihood functions, rather than this process being handled on the back-end through textual inputs from the user such as <code>family= poisson(link = "log")</code>. This may at first seem like a cumbersome task, but it provides a degree of independence and creativity for data analysis that is otherwise unavailable. It is this autonomy that makes it possible to unbiasedly estimate SAMs in Stan, which to the best of our knowledge cannot be accomplished with any other mainstream statistical software. Nonetheless, it is important to recognize that some practice and trial-and-error will be required to gain competency and comfortability with Stan. We therefore encourage those interested in SAMs to review the <a href="https://mc-stan.org/docs/2_25/reference-manual/index.html">Stan Reference Manual</a>, as well the extensive collection of <a href="https://mc-stan.org/users/documentation/case-studies">Stan Case Studies</a>, which will provide a more robust foundation for estimating any model of interest in Stan.</p>
<p>Here we review some basics of Stan that will be necessary for following the coding tutorials in the rest of the guidebook. To make this introduction more concrete, we simulate a simple data structure appropriately described by a Gaussian random regression model, with 50 subjects and 2 repeated measures per subject across an environmental gradient <span class="math inline">\(x\)</span>. Formally, the model for observation <em>i</em> of individual <em>j</em> is given by</p>
<p><span class="math display">\[z_{ij}=\mu_0+\mu_{j}+\left( \beta_0 + \beta_{j} \right) x_{ij}+\epsilon_i\]</span>
<span class="math display">\[ \begin{bmatrix}
\boldsymbol{\mu} \\ 
\boldsymbol{\beta_{\mathrm{ }}} 
\end{bmatrix} \sim \mathrm{MVNormal}(\boldsymbol{0}, \boldsymbol{\mathrm{P}} ) : 
\boldsymbol{\mathrm{ }} =
\begin{bmatrix}
\mathrm{Var}( {\mu} ) &amp;  
\mathrm{Cov}( {\mu},  \boldsymbol{\beta_{\mathrm{ }}})     \\ 
\mathrm{Cov}(\boldsymbol{\beta_{\mathrm{ }}}, {\mu} ) &amp; 
\mathrm{Var}( \boldsymbol{\beta_{\mathrm{ }}} )
\end{bmatrix} \]</span></p>
<p><span class="math display">\[ \boldsymbol{\epsilon} \sim \mathrm{Normal}(0, \boldsymbol{\Sigma} ): 
\boldsymbol{\Sigma} =
[\mathrm{Var}(\boldsymbol{\epsilon})]\]</span></p>
<p>where <span class="math inline">\(\mu_0\)</span> and <span class="math inline">\(\beta_1\)</span> are fixed population-level intercepts and slopes respectively, with the vectors <span class="math inline">\(\boldsymbol{\mu_{\mathrm{ }}}\)</span> and <span class="math inline">\(\boldsymbol{\beta_{\mathrm{ }}}\)</span> containing individual-specific phenotypic deviations from the population values (i.e. random intercepts and slopes). The probability density function of this Gaussian variable can be equivalently written as</p>
<p><span class="math display">\[z_{ij} \sim \mathrm{Normal}(\mu_0 + \mu_{j}+ \left( \beta_1 + \beta_{j} \right) x_{ij}, \boldsymbol{\Sigma})\]</span>
It is often easier to specify model likelihoods and priors over standard deviations and correlation matrices in Stan, rather than the variances and covariances represented in the formal model. These parameters can always be derived from one another with simple transformations. For variances and standard deviations</p>
<p><span class="math display">\[\mathrm{SD}( \boldsymbol{\mu_{\mathrm{ }}}  ) = \mathrm{Sqrt(Var} (\boldsymbol{\boldsymbol{\mu_{\mathrm{ }}} }) ) , \quad \mathrm{SD}( \boldsymbol{\beta_{\mathrm{ }}}  ) = \mathrm{Sqrt(Var} (\boldsymbol{\boldsymbol{\beta_{\mathrm{ }}} }) )\]</span></p>
<p>Similarly, the covariance matrix <span class="math inline">\(\boldsymbol{\mathrm{P_{cov}}}\)</span> can be derived by pre- and post-multiplying the correlation matrix <span class="math inline">\(\boldsymbol{\mathrm{P_{cor}}}\)</span> with diagonal matrices <span class="math inline">\(\boldsymbol{\mathrm{P_{sd}}}\)</span> of these standard deviations</p>
<p><span class="math display">\[\boldsymbol{\mathrm{P_{cov}}} =  \boldsymbol{\mathrm{P_{sd}}} \boldsymbol{\mathrm{P_{cor}}}\boldsymbol{\mathrm{P_{sd}}}\]</span></p>
<p><span class="math display">\[\boldsymbol{\mathrm{P_{sd}}}= \begin{bmatrix} \mathrm{SD}( \boldsymbol{\mu_{\mathrm{ }}} )     &amp;  0    \\ 
0     &amp;     \mathrm{SD}( \boldsymbol{\beta_{\mathrm{ }}} ) \end{bmatrix}, \quad 
\boldsymbol{\mathrm{P_{cor}}} = \begin{bmatrix} 1     &amp;  \mathrm{Cor}( \boldsymbol{\mu_{\mathrm{ }}}, \boldsymbol{\beta_{\mathrm{ }}} )    \\ 
\mathrm{Cor}( \boldsymbol{\beta_{\mathrm{ }}} , \boldsymbol{\mu_{\mathrm{ }}} )      &amp;    1
\end{bmatrix} \]</span>
We can simulate a random dataset from this model in R, along with an index variable <code>id</code> that tracks which individual (I = 1 - 50) is being measured at each observation (N = 1-100).</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb3-1"><a href="using-stan-in-r.html#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(mvtnorm)</span>
<span id="cb3-2"><a href="using-stan-in-r.html#cb3-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-3"><a href="using-stan-in-r.html#cb3-3" aria-hidden="true" tabindex="-1"></a>N <span class="ot">=</span> <span class="dv">100</span> <span class="co">#total observations</span></span>
<span id="cb3-4"><a href="using-stan-in-r.html#cb3-4" aria-hidden="true" tabindex="-1"></a>I <span class="ot">=</span> <span class="dv">50</span> <span class="co">#total individuals</span></span>
<span id="cb3-5"><a href="using-stan-in-r.html#cb3-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-6"><a href="using-stan-in-r.html#cb3-6" aria-hidden="true" tabindex="-1"></a>intercept <span class="ot">=</span> <span class="dv">1</span> <span class="co">#global intercept</span></span>
<span id="cb3-7"><a href="using-stan-in-r.html#cb3-7" aria-hidden="true" tabindex="-1"></a>beta1 <span class="ot">=</span> <span class="fl">0.3</span> <span class="co">#fixed effect regression coefficient</span></span>
<span id="cb3-8"><a href="using-stan-in-r.html#cb3-8" aria-hidden="true" tabindex="-1"></a>SD_intercept <span class="ot">=</span> <span class="fl">0.3</span> <span class="co">#standard deviation of random intercepts</span></span>
<span id="cb3-9"><a href="using-stan-in-r.html#cb3-9" aria-hidden="true" tabindex="-1"></a>SD_slope <span class="ot">=</span> <span class="fl">0.3</span></span>
<span id="cb3-10"><a href="using-stan-in-r.html#cb3-10" aria-hidden="true" tabindex="-1"></a>SD_residual <span class="ot">=</span> <span class="dv">1</span></span>
<span id="cb3-11"><a href="using-stan-in-r.html#cb3-11" aria-hidden="true" tabindex="-1"></a>cor_RE <span class="ot">=</span> <span class="fl">0.3</span> <span class="co">#correlation of random intercepts and slopes</span></span>
<span id="cb3-12"><a href="using-stan-in-r.html#cb3-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-13"><a href="using-stan-in-r.html#cb3-13" aria-hidden="true" tabindex="-1"></a><span class="co">#individual-level index</span></span>
<span id="cb3-14"><a href="using-stan-in-r.html#cb3-14" aria-hidden="true" tabindex="-1"></a>id <span class="ot">=</span> <span class="fu">rep</span>(<span class="fu">seq</span>(<span class="dv">1</span>, I), <span class="at">each =</span> N<span class="sc">/</span>I) <span class="co">#i.e. two observations per individual</span></span>
<span id="cb3-15"><a href="using-stan-in-r.html#cb3-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-16"><a href="using-stan-in-r.html#cb3-16" aria-hidden="true" tabindex="-1"></a><span class="co">#simulate fixed effect covariate</span></span>
<span id="cb3-17"><a href="using-stan-in-r.html#cb3-17" aria-hidden="true" tabindex="-1"></a>x <span class="ot">=</span> <span class="fu">rnorm</span>(<span class="dv">100</span>,<span class="dv">0</span>,<span class="dv">1</span>) </span>
<span id="cb3-18"><a href="using-stan-in-r.html#cb3-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-19"><a href="using-stan-in-r.html#cb3-19" aria-hidden="true" tabindex="-1"></a><span class="co">#simulate random individual deviations</span></span>
<span id="cb3-20"><a href="using-stan-in-r.html#cb3-20" aria-hidden="true" tabindex="-1"></a>Pcor <span class="ot">=</span> <span class="fu">matrix</span>( <span class="fu">c</span>(<span class="dv">1</span>, cor_RE, cor_RE, <span class="dv">1</span>), <span class="at">nrow =</span> <span class="dv">2</span>, <span class="at">ncol =</span> <span class="dv">2</span> )</span>
<span id="cb3-21"><a href="using-stan-in-r.html#cb3-21" aria-hidden="true" tabindex="-1"></a>Psd <span class="ot">=</span> <span class="fu">matrix</span>( <span class="fu">c</span>(SD_intercept, <span class="dv">0</span>, <span class="dv">0</span>, SD_slope), <span class="at">nrow =</span> <span class="dv">2</span>, <span class="at">ncol =</span> <span class="dv">2</span> )</span>
<span id="cb3-22"><a href="using-stan-in-r.html#cb3-22" aria-hidden="true" tabindex="-1"></a>Pcov <span class="ot">=</span> Psd <span class="sc">%*%</span> Pcor <span class="sc">%*%</span> Psd</span>
<span id="cb3-23"><a href="using-stan-in-r.html#cb3-23" aria-hidden="true" tabindex="-1"></a>re_P <span class="ot">=</span> <span class="fu">rmvnorm</span>(I, <span class="at">mean =</span> <span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">0</span>), <span class="at">sigma =</span> Pcov) <span class="co">#rows = I, cols = intercepts and slopes</span></span>
<span id="cb3-24"><a href="using-stan-in-r.html#cb3-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-25"><a href="using-stan-in-r.html#cb3-25" aria-hidden="true" tabindex="-1"></a><span class="co">#individual-level parameters</span></span>
<span id="cb3-26"><a href="using-stan-in-r.html#cb3-26" aria-hidden="true" tabindex="-1"></a>mu <span class="ot">=</span> re_P[,<span class="dv">1</span>]</span>
<span id="cb3-27"><a href="using-stan-in-r.html#cb3-27" aria-hidden="true" tabindex="-1"></a>beta <span class="ot">=</span> re_P[,<span class="dv">2</span>]</span>
<span id="cb3-28"><a href="using-stan-in-r.html#cb3-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-29"><a href="using-stan-in-r.html#cb3-29" aria-hidden="true" tabindex="-1"></a><span class="co">#residual effects</span></span>
<span id="cb3-30"><a href="using-stan-in-r.html#cb3-30" aria-hidden="true" tabindex="-1"></a>epsilon <span class="ot">=</span> <span class="fu">rnorm</span>(<span class="dv">100</span>, <span class="dv">0</span>, SD_residual )</span>
<span id="cb3-31"><a href="using-stan-in-r.html#cb3-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-32"><a href="using-stan-in-r.html#cb3-32" aria-hidden="true" tabindex="-1"></a><span class="co">#measured response (100 response values for 50 subjects)</span></span>
<span id="cb3-33"><a href="using-stan-in-r.html#cb3-33" aria-hidden="true" tabindex="-1"></a>z <span class="ot">=</span> intercept <span class="sc">+</span> mu[id] <span class="sc">+</span> (beta1 <span class="sc">+</span> beta[id])<span class="sc">*</span>x <span class="sc">+</span> epsilon</span>
<span id="cb3-34"><a href="using-stan-in-r.html#cb3-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-35"><a href="using-stan-in-r.html#cb3-35" aria-hidden="true" tabindex="-1"></a><span class="co">#combine into list for Stan</span></span>
<span id="cb3-36"><a href="using-stan-in-r.html#cb3-36" aria-hidden="true" tabindex="-1"></a><span class="co">#other values are empirically unobserved and will be model parameters</span></span>
<span id="cb3-37"><a href="using-stan-in-r.html#cb3-37" aria-hidden="true" tabindex="-1"></a>stan_data <span class="ot">=</span> <span class="fu">list</span>(<span class="at">z =</span> z, <span class="at">x =</span> x, <span class="at">id =</span> id, <span class="at">N =</span> N, <span class="at">I =</span> I)</span></code></pre></div>
<p>We can now program a Stan model to infer the data-generating process with these empirical observations. For any <code>.stan</code> file composed with a text editor, the following programming blocks will be recognized and all model code inside each block will be processed sequentially.</p>
<pre class="stan"><code>functions {
}
data {
}
transformed data {
}
parameters {
}
transformed parameters {
}
model {
}
generated quantities {
}
</code></pre>
<p>The <code>data</code>, <code>parameters</code>, and <code>model</code> blocks are specified for any model, while the other blocks provide optional declarations and statements. In most statistical software, empirical data are input with a single matrix or dataframe. Rather than inputting a single dataframe or matix to RStan, a list can be provided with data for each scalar (real or integer), vector, or matrix declared in the <code>.stan</code> file. The names of these data objects are declared along with their expected dimensions, which ensures that inappropriate data structures or likelihood functions will throw errors. For the simulated data, we first declare all the measured variables and indices relevant to model estimation. We use <code>//</code> rather than <code>#</code> for comments in Stan.</p>
<pre class="stan"><code>data {
  int&lt;lower=1&gt; N; //length of response vector/total observations
  int&lt;lower=1&gt; I; //number of individuals
  int&lt;lower=1&gt; id[N]; //N integer indices matching observations of z to the individual identity 

  vector[N] x; //vector of covariate values for fixed effect
  vector[N] z; //vector of response values
}</code></pre>
<p>This declarative approach requires that particular attention is given to the order of data input to the model, as values will need to be appropriately aligned and indexed throughout the model specification. However, it also provides additional benefits such as facilitating multi-response models with heterogeneous dimensions, as well as allowing for arbitrarily complex forms of social interaction to be specified in the model likelihood using appropriate indices of the relevant vectors or matrices.</p>
<p>We specify model parameters in accordance with the formal model used for the simulation, with standard deviations and correlation matrices replacing variances and covariance matrices. For simplicity, we use <code>_P</code> to indicate phenotypic (co)variances and values in the Stan code, with <code>_R</code> used to indicate residual (co)variance terms.</p>
<pre class="stan"><code>parameters {
  //fixed effects
  real mu_0; //global intercept
  real beta_1; //fixed effect coefficient for covariate x

  //random effects
  corr_matrix[2] Pcor; //correlation matrix of random effects 
  vector&lt;lower=0&gt;[2] sd_P; //standard deviations of random effects
  real&lt;lower=0&gt; sd_R; //standard deviation of residuals
  matrix[I,2] re_P; //individual-level phenotypic deviations (random intercepts and slopes)
}</code></pre>
<p>Note that rather than declaring the random effects as separate vectors, we instead declare a matrix for both individual intercept and slope values, which we use in the model block for declaring the covariance between these parameters. It is necessary to specify <code>&lt;lower=0&gt;</code> so that the standard deviation parameters are lower bound at zero.</p>
<p>The other parameters in the formal model are simply combinations of these fundamental parameters. The <code>transformed parameters</code> block of a <code>.stan</code> file is intended for such purposes. In particular, the covariance matrix <span class="math inline">\(\boldsymbol{\mathrm{P_{cov}}}\)</span> can be derived with the standard deviations <code>sd_P</code> and the correlation matrix <code>Pcor</code> as shown above. Separating these parameters is useful for increasing model clarity, as well for enhancing the efficiency of MCMC sampling as demonstrated further below.</p>
<pre class="stan"><code>transformed parameters {
  cov_matrix[2] Pcov = diag_matrix(sd_P) * Pcor * diag_matrix(sd_P); //cov of random effects
}</code></pre>
<p>This new transformed parameter <code>P</code> can now be used in the model block to more clearly express the likelihood function. Note that new objects can also be declared inside the <code>model</code> block prior to specifying the likelihood. However, any objects created in the <code>model</code> block are temporary and will not be saved along with the MCMC samples of objects declared in the <code>parameters</code> and <code>transformed parametrs</code> blocks. This can be useful for creating pragmatic objects that enable more efficient coding but do not need to be directly interpreted. For instance, rather than subsetting the matrix of individual random effects <code>re_P</code> inside the model likelihood, we can instead create two temporary vectors <code>mu</code> and <code>beta</code> to more intuitively write the likelihood function. Following the formal model above, we specify the response <span class="math inline">\(z_{ij}\)</span> as a function of the linear predictor containing population parameters as well as individual intercepts <span class="math inline">\(\mu_j\)</span> and slopes in response to the environmental covariate <span class="math inline">\(\beta_j\)</span>, as well as stochastic effects with standard deviation <span class="math inline">\(\mathrm{SD(\boldsymbol{\epsilon})}=\)</span><code>sd_R</code>. The random effects are sampled from a zero-centered multivariate normal with covariance matrix <span class="math inline">\(\boldsymbol{\mathrm{P_{cov}}}\)</span>.</p>
<pre class="stan"><code>model {
  vector[I] mu = col(re_P, 1); //temporary individual-level intercepts
  vector[I] beta = col(re_P, 2); //temporary individual-level slopes

  //model likelihood
  //use index id to match response vector length
  z ~ normal(mu_0 + mu[id] + (beta_1 + beta[id]).*x, sd_R);
  
  for(i in 1:I) //each individual&#39;s random effects ~ MVN(0,P_cov)
  re_P[i] ~ multi_normal([0,0], Pcov);
  
  //priors
  
  //fixed effects
  mu_0 ~ normal(0,1);
  beta_1 ~ normal(0,1);
  
  //random effects
  Pcor ~ lkj_corr(2);
  to_vector(sd_P) ~ cauchy(0,1);
  sd_R ~ cauchy(0,1);
}
</code></pre>
<p>Model priors are set for all parameters declared in the original programming block, while transformed parameters do not receive priors. We use general purpose, weakly regularizing priors to reduce the risk of inferential bias and enhance model identification, which will be crucial for SAMs relying on interactions among many latent variables. Interested readers should see <span class="citation"><a href="#ref-Lemoine2019" role="doc-biblioref">Lemoine</a> (<a href="#ref-Lemoine2019" role="doc-biblioref">2019</a>)</span> and <span class="citation"><a href="#ref-Rethinking" role="doc-biblioref">McElreath</a> (<a href="#ref-Rethinking" role="doc-biblioref">2020</a>)</span> for further discussion on the choice of model priors, as well as the clear limitations of using highly diffuse, flat, and/or improper priors that are more commonly utilized. Finally, rather than post-processing the posterior SDs ourselves to derive variances, we can instead use the <code>generated quantities</code> block to calculate the variances during model estimation.</p>
<pre class="stan"><code>generated quantities {
  vector[2] V_P = sd_P .* sd_P; //RN intercept [1] and slope [2] variance
  real V_R = sd_R * sd_R; //residual variance (=Sigma matrix)
}</code></pre>
<p>The posterior object returned from this model will now contain the random effects variances and covariance matrix, along with the SDs and correlation matrix. Each of the blocks can now be saved together in a single <code>.stan</code> file, which can be accomplished with a text editor or inside R.</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb10-1"><a href="using-stan-in-r.html#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="fu">write</span>(<span class="st">&quot;</span></span>
<span id="cb10-2"><a href="using-stan-in-r.html#cb10-2" aria-hidden="true" tabindex="-1"></a><span class="st">data {</span></span>
<span id="cb10-3"><a href="using-stan-in-r.html#cb10-3" aria-hidden="true" tabindex="-1"></a><span class="st">    int&lt;lower=1&gt; N; //length of response vector/total observations</span></span>
<span id="cb10-4"><a href="using-stan-in-r.html#cb10-4" aria-hidden="true" tabindex="-1"></a><span class="st">    int&lt;lower=1&gt; I; //number of individuals</span></span>
<span id="cb10-5"><a href="using-stan-in-r.html#cb10-5" aria-hidden="true" tabindex="-1"></a><span class="st">    int&lt;lower=1&gt; id[N]; //N integer indices matching observations of z to the individual identity </span></span>
<span id="cb10-6"><a href="using-stan-in-r.html#cb10-6" aria-hidden="true" tabindex="-1"></a><span class="st">    </span></span>
<span id="cb10-7"><a href="using-stan-in-r.html#cb10-7" aria-hidden="true" tabindex="-1"></a><span class="st">    vector[N] x; //vector of covariate values for fixed effect</span></span>
<span id="cb10-8"><a href="using-stan-in-r.html#cb10-8" aria-hidden="true" tabindex="-1"></a><span class="st">    vector[N] z; //vector of response values</span></span>
<span id="cb10-9"><a href="using-stan-in-r.html#cb10-9" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb10-10"><a href="using-stan-in-r.html#cb10-10" aria-hidden="true" tabindex="-1"></a><span class="st">parameters {</span></span>
<span id="cb10-11"><a href="using-stan-in-r.html#cb10-11" aria-hidden="true" tabindex="-1"></a><span class="st">    //fixed effects</span></span>
<span id="cb10-12"><a href="using-stan-in-r.html#cb10-12" aria-hidden="true" tabindex="-1"></a><span class="st">    real mu_0; //global intercept</span></span>
<span id="cb10-13"><a href="using-stan-in-r.html#cb10-13" aria-hidden="true" tabindex="-1"></a><span class="st">    real beta_1; //fixed effect coefficient for covariate x</span></span>
<span id="cb10-14"><a href="using-stan-in-r.html#cb10-14" aria-hidden="true" tabindex="-1"></a><span class="st">   </span></span>
<span id="cb10-15"><a href="using-stan-in-r.html#cb10-15" aria-hidden="true" tabindex="-1"></a><span class="st">    //random effects</span></span>
<span id="cb10-16"><a href="using-stan-in-r.html#cb10-16" aria-hidden="true" tabindex="-1"></a><span class="st">    corr_matrix[2] Pcor; //correlation matrix of random effects </span></span>
<span id="cb10-17"><a href="using-stan-in-r.html#cb10-17" aria-hidden="true" tabindex="-1"></a><span class="st">    vector&lt;lower=0&gt;[2] sd_P; //standard deviations of random effects</span></span>
<span id="cb10-18"><a href="using-stan-in-r.html#cb10-18" aria-hidden="true" tabindex="-1"></a><span class="st">    real&lt;lower=0&gt; sd_R; //standard deviation of residuals</span></span>
<span id="cb10-19"><a href="using-stan-in-r.html#cb10-19" aria-hidden="true" tabindex="-1"></a><span class="st">    matrix[I,2] re_P; //individual-level phenotypic deviations (random intercepts and slopes)  </span></span>
<span id="cb10-20"><a href="using-stan-in-r.html#cb10-20" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb10-21"><a href="using-stan-in-r.html#cb10-21" aria-hidden="true" tabindex="-1"></a><span class="st">transformed parameters {</span></span>
<span id="cb10-22"><a href="using-stan-in-r.html#cb10-22" aria-hidden="true" tabindex="-1"></a><span class="st">    cov_matrix[2] Pcov = diag_matrix(sd_P) * Pcor * diag_matrix(sd_P); //cov of random effects</span></span>
<span id="cb10-23"><a href="using-stan-in-r.html#cb10-23" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb10-24"><a href="using-stan-in-r.html#cb10-24" aria-hidden="true" tabindex="-1"></a><span class="st">model {</span></span>
<span id="cb10-25"><a href="using-stan-in-r.html#cb10-25" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[I] mu = col(re_P, 1); //temporary individual-level intercepts</span></span>
<span id="cb10-26"><a href="using-stan-in-r.html#cb10-26" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[I] beta = col(re_P, 2); //temporary individual-level slopes</span></span>
<span id="cb10-27"><a href="using-stan-in-r.html#cb10-27" aria-hidden="true" tabindex="-1"></a><span class="st">  </span></span>
<span id="cb10-28"><a href="using-stan-in-r.html#cb10-28" aria-hidden="true" tabindex="-1"></a><span class="st">  //model likelihood</span></span>
<span id="cb10-29"><a href="using-stan-in-r.html#cb10-29" aria-hidden="true" tabindex="-1"></a><span class="st">  //use index id to match response vector length</span></span>
<span id="cb10-30"><a href="using-stan-in-r.html#cb10-30" aria-hidden="true" tabindex="-1"></a><span class="st">  z ~ normal(mu_0 + mu[id] + (beta_1 + beta[id]).*x, sd_R);</span></span>
<span id="cb10-31"><a href="using-stan-in-r.html#cb10-31" aria-hidden="true" tabindex="-1"></a><span class="st">  </span></span>
<span id="cb10-32"><a href="using-stan-in-r.html#cb10-32" aria-hidden="true" tabindex="-1"></a><span class="st">  for(i in 1:I) //each individual&#39;s random effects ~ MVN(0,P_cov)</span></span>
<span id="cb10-33"><a href="using-stan-in-r.html#cb10-33" aria-hidden="true" tabindex="-1"></a><span class="st">  re_P[i] ~ multi_normal([0,0], Pcov);</span></span>
<span id="cb10-34"><a href="using-stan-in-r.html#cb10-34" aria-hidden="true" tabindex="-1"></a><span class="st">  </span></span>
<span id="cb10-35"><a href="using-stan-in-r.html#cb10-35" aria-hidden="true" tabindex="-1"></a><span class="st">  //priors</span></span>
<span id="cb10-36"><a href="using-stan-in-r.html#cb10-36" aria-hidden="true" tabindex="-1"></a><span class="st">  //fixed effects</span></span>
<span id="cb10-37"><a href="using-stan-in-r.html#cb10-37" aria-hidden="true" tabindex="-1"></a><span class="st">  mu_0 ~ normal(0,1);</span></span>
<span id="cb10-38"><a href="using-stan-in-r.html#cb10-38" aria-hidden="true" tabindex="-1"></a><span class="st">  beta_1 ~ normal(0,1);</span></span>
<span id="cb10-39"><a href="using-stan-in-r.html#cb10-39" aria-hidden="true" tabindex="-1"></a><span class="st">  //random effects</span></span>
<span id="cb10-40"><a href="using-stan-in-r.html#cb10-40" aria-hidden="true" tabindex="-1"></a><span class="st">  Pcor ~ lkj_corr(2);</span></span>
<span id="cb10-41"><a href="using-stan-in-r.html#cb10-41" aria-hidden="true" tabindex="-1"></a><span class="st">  to_vector(sd_P) ~ cauchy(0,1);</span></span>
<span id="cb10-42"><a href="using-stan-in-r.html#cb10-42" aria-hidden="true" tabindex="-1"></a><span class="st">  sd_R ~ cauchy(0,1); </span></span>
<span id="cb10-43"><a href="using-stan-in-r.html#cb10-43" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb10-44"><a href="using-stan-in-r.html#cb10-44" aria-hidden="true" tabindex="-1"></a><span class="st">generated quantities {</span></span>
<span id="cb10-45"><a href="using-stan-in-r.html#cb10-45" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[2] V_P = sd_P .* sd_P; //RN intercept [1] and slope [2] variance</span></span>
<span id="cb10-46"><a href="using-stan-in-r.html#cb10-46" aria-hidden="true" tabindex="-1"></a><span class="st">  real V_R = sd_R * sd_R; //residual variance (=Sigma matrix)</span></span>
<span id="cb10-47"><a href="using-stan-in-r.html#cb10-47" aria-hidden="true" tabindex="-1"></a><span class="st">}&quot;</span>, <span class="st">&quot;mod1.stan&quot;</span>)</span></code></pre></div>
<p>The model is now ready for estimation. We manually specify that the MCMC sampler should use 1500 iterations per chain to converge on the target joint posterior distribution <code>warmup=1500</code>, with the subsequent 1000 iterations used as posterior samples <code>iter = 2500</code> (i.e. <code>iter</code> - <code>warmup</code> = number of MCMC samples per chain). <code>init = 0</code> initializes the samplers near null values. Four MCMC chains are used to assess model convergence across independent random samplers <code>chains=4</code>, with one core assigned to each chain for parallel processing <code>cores=4</code>. The <code>adapt_delta=0.90</code> argument reduces the risk of divergent transitions during sampling.</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb11-1"><a href="using-stan-in-r.html#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(rstan)</span></code></pre></div>
<pre><code>## Loading required package: StanHeaders</code></pre>
<pre><code>## Loading required package: ggplot2</code></pre>
<pre><code>## rstan (Version 2.21.2, GitRev: 2e1f913d3ca3)</code></pre>
<pre><code>## For execution on a local, multicore CPU with excess RAM we recommend calling
## options(mc.cores = parallel::detectCores()).
## To avoid recompilation of unchanged Stan programs, we recommend calling
## rstan_options(auto_write = TRUE)</code></pre>
<pre><code>## Do not specify &#39;-march=native&#39; in &#39;LOCAL_CPPFLAGS&#39; or a Makevars file</code></pre>
<div class="sourceCode" id="cb17"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb17-1"><a href="using-stan-in-r.html#cb17-1" aria-hidden="true" tabindex="-1"></a>mod1 <span class="ot">=</span> <span class="fu">stan_model</span>(<span class="st">&quot;mod1.stan&quot;</span>)</span></code></pre></div>
<pre><code>## Warning in system(paste(CXX, ARGS), ignore.stdout = TRUE, ignore.stderr = TRUE): &#39;C:/rtools40/usr/mingw_/bin/g++&#39; not found</code></pre>
<div class="sourceCode" id="cb19"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb19-1"><a href="using-stan-in-r.html#cb19-1" aria-hidden="true" tabindex="-1"></a>stan_results <span class="ot">&lt;-</span> <span class="fu">sampling</span>(mod1, <span class="at">data=</span>stan_data, <span class="at">init =</span> <span class="dv">0</span>, <span class="at">warmup=</span><span class="dv">1500</span>, <span class="at">iter =</span> <span class="dv">2500</span>,</span>
<span id="cb19-2"><a href="using-stan-in-r.html#cb19-2" aria-hidden="true" tabindex="-1"></a>                         <span class="at">chains=</span><span class="dv">4</span>, <span class="at">cores=</span><span class="dv">4</span>, <span class="at">control=</span><span class="fu">list</span>(<span class="at">adapt_delta=</span><span class="fl">0.90</span>) )</span></code></pre></div>
<pre><code>## Warning: There were 13 divergent transitions after warmup. See
## http://mc-stan.org/misc/warnings.html#divergent-transitions-after-warmup
## to find out why this is a problem and how to eliminate them.</code></pre>
<pre><code>## Warning: There were 4 chains where the estimated Bayesian Fraction of Missing Information was low. See
## http://mc-stan.org/misc/warnings.html#bfmi-low</code></pre>
<pre><code>## Warning: Examine the pairs() plot to diagnose sampling problems</code></pre>
<pre><code>## Warning: The largest R-hat is NA, indicating chains have not mixed.
## Running the chains for more iterations may help. See
## http://mc-stan.org/misc/warnings.html#r-hat</code></pre>
<pre><code>## Warning: Bulk Effective Samples Size (ESS) is too low, indicating posterior means and medians may be unreliable.
## Running the chains for more iterations may help. See
## http://mc-stan.org/misc/warnings.html#bulk-ess</code></pre>
<pre><code>## Warning: Tail Effective Samples Size (ESS) is too low, indicating posterior variances and tail quantiles may be unreliable.
## Running the chains for more iterations may help. See
## http://mc-stan.org/misc/warnings.html#tail-ess</code></pre>
<p>Stan flags a few potential issues with the MCMC sampler. Note that the warning <code>## Warning in system(paste(CXX, ARGS), ignore.stdout = TRUE, ignore.stderr = TRUE): 'C:/rtools40/usr/mingw_/bin/g++' not found</code> during compilation of the model will sometimes appear on Windows computers and can be safely ignored. Further description of the sampler warnings can be found in the <a href="https://mc-stan.org/misc/warnings.html">Stan Warning Guide</a>. One warning is that “The largest R-hat is NA, indicating chains have not mixed.” Stan does not know whether some parameter values are fixed (causing Rhat = NA) because the sampler is stuck, or because the model has been intentionally specified with fixed parameter values (e.g. diagonals fixed to 1 in a correlation matrix or an intercept forced to 0). For the specified model, this is a harmless warning that can be safely ignored. However, we can also check for issues by looking at the Rhat values of all model parameters using <code>summary()</code> on the saved results. If an expected parameter is missing from the table or shows NA, this likely indicates an unintentional error in the model code.</p>
<div class="sourceCode" id="cb26"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb26-1"><a href="using-stan-in-r.html#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(stan_results)<span class="sc">$</span>summary[,<span class="st">&quot;Rhat&quot;</span>]</span></code></pre></div>
<pre><code>##       mu_0     beta_1  Pcor[1,1]  Pcor[1,2]  Pcor[2,1]  Pcor[2,2]    sd_P[1]    sd_P[2]       sd_R  re_P[1,1]  re_P[1,2]  re_P[2,1]  re_P[2,2]  re_P[3,1] 
##  1.0034848  1.0109206        NaN  1.0037288  1.0037288  0.9989995  1.1276055  1.1065316  1.0059386  1.0018671  1.0019077  1.0009945  1.0011217  1.0007110 
##  re_P[3,2]  re_P[4,1]  re_P[4,2]  re_P[5,1]  re_P[5,2]  re_P[6,1]  re_P[6,2]  re_P[7,1]  re_P[7,2]  re_P[8,1]  re_P[8,2]  re_P[9,1]  re_P[9,2] re_P[10,1] 
##  1.0028386  1.0055924  1.0008251  1.0177676  1.0286895  1.0023845  1.0001371  1.0044742  1.0152555  1.0224311  1.0009321  1.0022683  0.9994251  1.0000789 
## re_P[10,2] re_P[11,1] re_P[11,2] re_P[12,1] re_P[12,2] re_P[13,1] re_P[13,2] re_P[14,1] re_P[14,2] re_P[15,1] re_P[15,2] re_P[16,1] re_P[16,2] re_P[17,1] 
##  0.9996597  1.0065501  1.0054894  1.0084369  1.0035632  1.0052740  1.0009223  1.0111727  1.0091726  1.0053975  1.0019548  1.0052757  1.0013666  0.9993797 
## re_P[17,2] re_P[18,1] re_P[18,2] re_P[19,1] re_P[19,2] re_P[20,1] re_P[20,2] re_P[21,1] re_P[21,2] re_P[22,1] re_P[22,2] re_P[23,1] re_P[23,2] re_P[24,1] 
##  1.0006137  1.0124256  1.0032119  1.0002931  1.0032760  1.0037262  1.0035480  1.0100023  1.0495382  1.0186755  1.0023785  1.0098392  1.0091278  1.0042210 
## re_P[24,2] re_P[25,1] re_P[25,2] re_P[26,1] re_P[26,2] re_P[27,1] re_P[27,2] re_P[28,1] re_P[28,2] re_P[29,1] re_P[29,2] re_P[30,1] re_P[30,2] re_P[31,1] 
##  1.0007783  0.9999923  1.0020481  1.0012330  1.0013570  1.0158339  1.0051023  1.0010324  1.0007215  1.0019337  1.0000356  1.0016492  1.0019205  1.0021771 
## re_P[31,2] re_P[32,1] re_P[32,2] re_P[33,1] re_P[33,2] re_P[34,1] re_P[34,2] re_P[35,1] re_P[35,2] re_P[36,1] re_P[36,2] re_P[37,1] re_P[37,2] re_P[38,1] 
##  1.0004102  1.0196587  1.0001393  1.0003262  1.0046136  1.0208566  1.0072133  1.0030456  1.0039524  1.0288511  1.0039659  1.0319532  1.0138545  1.0011772 
## re_P[38,2] re_P[39,1] re_P[39,2] re_P[40,1] re_P[40,2] re_P[41,1] re_P[41,2] re_P[42,1] re_P[42,2] re_P[43,1] re_P[43,2] re_P[44,1] re_P[44,2] re_P[45,1] 
##  1.0014754  1.0105118  1.0016540  0.9997129  1.0005824  1.0138597  1.0028742  1.0055628  1.0056961  1.0000008  1.0036781  1.0020462  1.0024018  1.0172160 
## re_P[45,2] re_P[46,1] re_P[46,2] re_P[47,1] re_P[47,2] re_P[48,1] re_P[48,2] re_P[49,1] re_P[49,2] re_P[50,1] re_P[50,2]  Pcov[1,1]  Pcov[1,2]  Pcov[2,1] 
##  1.0039130  1.0049044  0.9996815  1.0002375  1.0006959  1.0042358  1.0019190  1.0010022  1.0109103  1.0014224  1.0010913  1.0801567  1.0248070  1.0248070 
##  Pcov[2,2]     V_P[1]     V_P[2]        V_R       lp__ 
##  1.0600993  1.0801567  1.0600993  1.0055360  1.2222847</code></pre>
<p>In addition to the Rhat warning, the effective sample sizes of some model parameters are too low to ensure accurate inferences. It is helpful to see which parameters are causing these warnings by sorting on the lowest <code>n_eff</code> values in the summary table.</p>
<div class="sourceCode" id="cb28"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb28-1"><a href="using-stan-in-r.html#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="fu">sort</span>(<span class="fu">summary</span>(stan_results)<span class="sc">$</span>summary[,<span class="st">&quot;n_eff&quot;</span>])</span></code></pre></div>
<pre><code>##       lp__    sd_P[1]    sd_P[2]  Pcov[1,1]     V_P[1] re_P[21,2]  Pcov[2,2]     V_P[2] re_P[37,1] re_P[36,1]  re_P[5,2] re_P[34,1]  re_P[5,1]  Pcov[1,2] 
##   11.09486   26.47586   28.34089   46.00793   46.00793   62.87688   80.66456   80.66456  102.04897  138.69796  165.57269  177.46271  220.82783  229.67573 
##  Pcov[2,1] re_P[22,1]  re_P[8,1] re_P[45,1] re_P[27,1] re_P[32,1] re_P[37,2] re_P[18,1]  re_P[7,2] re_P[21,1] re_P[12,1] re_P[49,2] re_P[41,1] re_P[23,1] 
##  229.67573  236.98924  237.25369  252.22413  272.13052  294.92369  359.77866  387.08044  464.33868  474.70730  487.76003  492.01589  500.05159  506.84706 
## re_P[39,1]  Pcor[1,2]  Pcor[2,1]     beta_1 re_P[33,2] re_P[16,1]       sd_R        V_R re_P[14,1] re_P[45,2] re_P[13,1] re_P[14,2]  re_P[7,1] re_P[15,1] 
##  533.24728  545.49657  545.49657  651.42170  746.92635  784.10976  793.03417  834.49860  861.08501  861.70985  909.83363  956.88820 1001.24564 1006.00218 
## re_P[27,2]  re_P[6,1]       mu_0 re_P[38,2] re_P[11,1] re_P[24,1] re_P[35,1] re_P[43,1] re_P[46,1] re_P[42,1] re_P[23,2]  re_P[2,1]  re_P[2,2] re_P[43,2] 
## 1009.89183 1085.48188 1143.15676 1147.84787 1168.73099 1302.22385 1355.49453 1391.74810 1413.01994 1476.03409 1478.21369 1515.97217 1600.58558 1636.26960 
##  re_P[1,1] re_P[20,1] re_P[26,1] re_P[20,2]  re_P[4,1] re_P[12,2]  re_P[3,2] re_P[42,2] re_P[35,2] re_P[44,2] re_P[33,1] re_P[38,1] re_P[34,2] re_P[48,1] 
## 1656.90823 1680.66573 1778.07510 1783.69205 1806.05462 1817.91773 1839.33936 1871.55425 1954.23219 1972.34696 2003.80211 2009.93591 2044.09092 2049.65709 
## re_P[18,2]  re_P[9,1] re_P[36,2] re_P[11,2]  re_P[1,2] re_P[25,1] re_P[30,2] re_P[31,1] re_P[49,1]  re_P[4,2] re_P[28,1] re_P[47,1]  re_P[3,1] re_P[16,2] 
## 2112.71784 2116.10237 2145.61471 2170.79191 2176.14754 2197.85713 2234.84195 2292.82133 2320.38499 2366.60117 2390.72390 2402.35099 2413.28474 2450.00466 
## re_P[19,2]  re_P[8,2] re_P[28,2] re_P[13,2] re_P[48,2] re_P[40,1] re_P[19,1] re_P[10,1] re_P[50,2] re_P[29,1] re_P[15,2] re_P[25,2] re_P[40,2] re_P[47,2] 
## 2480.11615 2485.06624 2519.55410 2612.85224 2651.87122 2656.47937 2686.26129 2713.11298 2810.80991 2931.70485 2939.55746 2949.64871 2977.72918 2992.65700 
## re_P[22,2] re_P[41,2] re_P[50,1] re_P[30,1] re_P[26,2] re_P[39,2] re_P[29,2] re_P[44,1] re_P[17,2] re_P[17,1] re_P[32,2]  re_P[6,2]  Pcor[2,2] re_P[24,2] 
## 3011.01920 3040.56501 3122.77427 3207.86962 3214.57016 3237.13277 3476.83430 3502.49620 3547.70511 3715.46855 3810.31912 3849.57815 3925.60111 4400.31094 
## re_P[31,2]  re_P[9,2] re_P[10,2] re_P[46,2] 
## 4503.31028 4728.16728 5060.31978 5304.71419</code></pre>
<p>It is typical that individual-specific trait values in <code>re_P</code> have relatively lower effective sample sizes than the population-level parameters of primary interest. More damningly, however, we also see an extremely low effective sample for <code>lp__</code>, which is the joint log density of the model (up to a constant internally defined <a href="https://www.jax.org/news-and-insights/jax-blog/2015/october/lp-in-stan-output#">scale factor</a>). This provides further evidence that the model, as currently defined, is poorly identified. The key random effect SDs <code>sd_P</code> and variances <code>V_P</code> are also very poorly sampled, along with the residual SD <code>sd_R</code> and variance <code>V_R</code>. We could run the MCMC sampler for more iterations, increase the warm-up period, and change various other manual control settings. However, the deeper issue here is not that the model is formally mispecified but rather that we have inefficiently parametrized the model for sampling.</p>
<div id="cholesky-decompositions" class="section level3" number="1.4.1">
<h3><span class="header-section-number">1.4.1</span> Cholesky decompositions</h3>
<p>Although the <code>.stan</code> file appropriately represents the formal model, it is programmed in such a way that the MCMC sampler has troubling sampling from the joint posterior distribution of the model. One of the first things we can do to increase efficiency is to reduce redundant computation over matrices in our model. This can be done with Cholesky decompositions. For any positive definite matrix <span class="math inline">\(\boldsymbol{\Omega}\)</span>, a Cholesky decomposition can be defined such that</p>
<p><span class="math display">\[\boldsymbol{\Omega} = \boldsymbol{\mathrm{L}_{\Omega}} \boldsymbol{\mathrm{L}_{\Omega}}^{\mathrm{T}}\]</span>
where <span class="math inline">\(\boldsymbol{\mathrm{L}_{\Omega}}\)</span> is a lower-triangular matrix and <span class="math inline">\(^{\mathrm{T}}\)</span> indicates matrix transposition. This property means that we can always do computations of reduced dimensionality on the lower-triangular matrix <span class="math inline">\(\boldsymbol{\mathrm{L}_{\Omega}}\)</span> and subsequently recover the full positive-definitive matrix <span class="math inline">\(\boldsymbol{\Omega}\)</span> by post-multiplying <span class="math inline">\(\boldsymbol{\mathrm{L}_{\Omega}}\)</span> with its transpose.</p>
<p>Stan provides many built-in functions for easily defining and manipulating Cholesky decomposed matrices, which we can use to reparametrize the <code>.stan</code> file. Comments are added below where Cholesky decompositions have been introduced.</p>
<pre class="stan"><code>data {
    int&lt;lower=1&gt; N; 
    int&lt;lower=1&gt; I; 
    int&lt;lower=1&gt; id[N];  
    
    vector[N] x; 
    vector[N] z; 
}
parameters {
    real mu_0;
    real beta_1; 
    
    cholesky_factor_corr[2] LPcor; //lower tri Cholesky of random effect cor matrix 
    vector&lt;lower=0&gt;[2] sd_P; 
    real&lt;lower=0&gt; sd_R;
    matrix[I,2] re_P;
}
transformed parameters {
    cholesky_factor_cov[2] LPcov = diag_pre_multiply(sd_P, LPcor); //Cholesky of random effect cov
}
model {
  vector[I] mu = col(re_P, 1);
  vector[I] beta = col(re_P, 2);
  
  z ~ normal(mu_0 + mu[id] + (beta_1 + beta[id]).*x, sd_R);
  
  for(i in 1:I)
  re_P[i] ~ multi_normal_cholesky([0,0], LPcov); //likelihood expecting Cholesky cov
  
  mu_0 ~ normal(0,1);
  beta_1 ~ normal(0,1);
  LPcor ~ lkj_corr_cholesky(2); //prior for Cholesky matrix
  to_vector(sd_P) ~ cauchy(0,1);
  sd_R ~ cauchy(0,1); 
}
generated quantities {
  vector[2] V_P = sd_P .* sd_P;
  real V_R = sd_R * sd_R;
  
  corr_matrix[2] Pcor = LPcor*LPcor&#39; ; //multiply by transpose to get full cor matrix
  cov_matrix[2] Pcov = diag_matrix(V_P) * Pcor * diag_matrix(V_P); //full cov matrix
</code></pre>
<p>The full covariance and correlation matrices are now specified in the <code>generated quantities</code> block.</p>
</div>
<div id="non-centered-random-effects" class="section level3" number="1.4.2">
<h3><span class="header-section-number">1.4.2</span> Non-centered random effects</h3>
<p>Before running this model, we can also reparametrize the random effects to further enhance efficiency. Currently, we express the unobserved random effects in <code>re_P</code> as being generated from a distribution with unobserved lower Cholesky covariance matrix <code>LPcov</code>. While mathematically appropriate, this specification can make it difficult for the model to identify the scale of the random effects. An alternative but mathematically equivalent parametrization can be used to separate out the scale of the random effect deviations from the population-level (co)variances, which often will enhance model identification. Note that any normally distributed random variable <span class="math inline">\(\boldsymbol{z}\)</span> where</p>
<p><span class="math display">\[\boldsymbol{z} \sim \mathrm{Normal}(0,\sigma_z)\]</span>
can also be expressed as a standard normal variable <span class="math inline">\(z_{std}\)</span> scaled by the original SD
<span class="math display">\[\boldsymbol{z} \equiv \boldsymbol{z_{\mathrm{std}}}\sigma_z\]</span>
<span class="math display">\[\boldsymbol{z_{\mathrm{std}}} \sim \mathrm{Normal}(0,1)\]</span>
Similarly for a <em>n</em> x <em>p</em> matrix <span class="math inline">\(\boldsymbol{Z}\)</span> of <em>p</em> multivariate phenotypes with covariance matrix <span class="math inline">\(\boldsymbol{\mathrm{C}}\)</span></p>
<p><span class="math display">\[\boldsymbol{Z} \equiv   \boldsymbol{Z_{\mathrm{std}}} \boldsymbol{\mathrm{L}_{\boldsymbol{\mathrm{C}}}}^{\mathrm{T}}\]</span>
<span class="math display">\[\mathrm{vec}(\boldsymbol{Z_{\mathrm{std}}}) \sim \mathrm{MVNormal}(\boldsymbol{0},\boldsymbol{\mathrm{I}})\]</span>
where <span class="math inline">\(\boldsymbol{\mathrm{L}_{\boldsymbol{\mathrm{C}}}}\)</span> is the lower-triangular Cholesky decomposition. Implementing this so-called “non-centered parametrization” is straightforward in Stan and can of course also be applied to correlation matrices. Building on the Cholesky decompositions added in the previous subsection, and using the <code>'</code> symbol for the transpose function</p>
<div class="sourceCode" id="cb31"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb31-1"><a href="using-stan-in-r.html#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="fu">write</span>(<span class="st">&quot;</span></span>
<span id="cb31-2"><a href="using-stan-in-r.html#cb31-2" aria-hidden="true" tabindex="-1"></a><span class="st">data {</span></span>
<span id="cb31-3"><a href="using-stan-in-r.html#cb31-3" aria-hidden="true" tabindex="-1"></a><span class="st">    int&lt;lower=1&gt; N; </span></span>
<span id="cb31-4"><a href="using-stan-in-r.html#cb31-4" aria-hidden="true" tabindex="-1"></a><span class="st">    int&lt;lower=1&gt; I; </span></span>
<span id="cb31-5"><a href="using-stan-in-r.html#cb31-5" aria-hidden="true" tabindex="-1"></a><span class="st">    int&lt;lower=1&gt; id[N];  </span></span>
<span id="cb31-6"><a href="using-stan-in-r.html#cb31-6" aria-hidden="true" tabindex="-1"></a><span class="st">    </span></span>
<span id="cb31-7"><a href="using-stan-in-r.html#cb31-7" aria-hidden="true" tabindex="-1"></a><span class="st">    vector[N] x; </span></span>
<span id="cb31-8"><a href="using-stan-in-r.html#cb31-8" aria-hidden="true" tabindex="-1"></a><span class="st">    vector[N] z; </span></span>
<span id="cb31-9"><a href="using-stan-in-r.html#cb31-9" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb31-10"><a href="using-stan-in-r.html#cb31-10" aria-hidden="true" tabindex="-1"></a><span class="st">parameters {</span></span>
<span id="cb31-11"><a href="using-stan-in-r.html#cb31-11" aria-hidden="true" tabindex="-1"></a><span class="st">    real mu_0;</span></span>
<span id="cb31-12"><a href="using-stan-in-r.html#cb31-12" aria-hidden="true" tabindex="-1"></a><span class="st">    real beta_1; </span></span>
<span id="cb31-13"><a href="using-stan-in-r.html#cb31-13" aria-hidden="true" tabindex="-1"></a><span class="st">    </span></span>
<span id="cb31-14"><a href="using-stan-in-r.html#cb31-14" aria-hidden="true" tabindex="-1"></a><span class="st">    cholesky_factor_corr[2] LPcor; </span></span>
<span id="cb31-15"><a href="using-stan-in-r.html#cb31-15" aria-hidden="true" tabindex="-1"></a><span class="st">    vector&lt;lower=0&gt;[2] sd_P; </span></span>
<span id="cb31-16"><a href="using-stan-in-r.html#cb31-16" aria-hidden="true" tabindex="-1"></a><span class="st">    real&lt;lower=0&gt; sd_R;</span></span>
<span id="cb31-17"><a href="using-stan-in-r.html#cb31-17" aria-hidden="true" tabindex="-1"></a><span class="st">    matrix[I,2] std_P; //now matrix of standard normals (see priors below)</span></span>
<span id="cb31-18"><a href="using-stan-in-r.html#cb31-18" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb31-19"><a href="using-stan-in-r.html#cb31-19" aria-hidden="true" tabindex="-1"></a><span class="st">transformed parameters {</span></span>
<span id="cb31-20"><a href="using-stan-in-r.html#cb31-20" aria-hidden="true" tabindex="-1"></a><span class="st">    matrix[I,2] re_P = std_P * diag_pre_multiply(sd_P,LPcor)&#39;; //non-centered parameterization</span></span>
<span id="cb31-21"><a href="using-stan-in-r.html#cb31-21" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb31-22"><a href="using-stan-in-r.html#cb31-22" aria-hidden="true" tabindex="-1"></a><span class="st">model {</span></span>
<span id="cb31-23"><a href="using-stan-in-r.html#cb31-23" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[I] mu = col(re_P, 1);</span></span>
<span id="cb31-24"><a href="using-stan-in-r.html#cb31-24" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[I] beta = col(re_P, 2);</span></span>
<span id="cb31-25"><a href="using-stan-in-r.html#cb31-25" aria-hidden="true" tabindex="-1"></a><span class="st">  </span></span>
<span id="cb31-26"><a href="using-stan-in-r.html#cb31-26" aria-hidden="true" tabindex="-1"></a><span class="st">  z ~ normal(mu_0 + mu[id] + (beta_1 + beta[id]).*x, sd_R);</span></span>
<span id="cb31-27"><a href="using-stan-in-r.html#cb31-27" aria-hidden="true" tabindex="-1"></a><span class="st">  </span></span>
<span id="cb31-28"><a href="using-stan-in-r.html#cb31-28" aria-hidden="true" tabindex="-1"></a><span class="st">  mu_0 ~ normal(0,1);</span></span>
<span id="cb31-29"><a href="using-stan-in-r.html#cb31-29" aria-hidden="true" tabindex="-1"></a><span class="st">  beta_1 ~ normal(0,1);</span></span>
<span id="cb31-30"><a href="using-stan-in-r.html#cb31-30" aria-hidden="true" tabindex="-1"></a><span class="st">  to_vector(std_P) ~ std_normal(); //new prior distribution over standard normal deviations</span></span>
<span id="cb31-31"><a href="using-stan-in-r.html#cb31-31" aria-hidden="true" tabindex="-1"></a><span class="st">  LPcor ~ lkj_corr_cholesky(2);</span></span>
<span id="cb31-32"><a href="using-stan-in-r.html#cb31-32" aria-hidden="true" tabindex="-1"></a><span class="st">  to_vector(sd_P) ~ cauchy(0,1);</span></span>
<span id="cb31-33"><a href="using-stan-in-r.html#cb31-33" aria-hidden="true" tabindex="-1"></a><span class="st">  sd_R ~ cauchy(0,1); </span></span>
<span id="cb31-34"><a href="using-stan-in-r.html#cb31-34" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb31-35"><a href="using-stan-in-r.html#cb31-35" aria-hidden="true" tabindex="-1"></a><span class="st">generated quantities {</span></span>
<span id="cb31-36"><a href="using-stan-in-r.html#cb31-36" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[2] V_P = sd_P .* sd_P;</span></span>
<span id="cb31-37"><a href="using-stan-in-r.html#cb31-37" aria-hidden="true" tabindex="-1"></a><span class="st">  real V_R = sd_R * sd_R;</span></span>
<span id="cb31-38"><a href="using-stan-in-r.html#cb31-38" aria-hidden="true" tabindex="-1"></a><span class="st">  </span></span>
<span id="cb31-39"><a href="using-stan-in-r.html#cb31-39" aria-hidden="true" tabindex="-1"></a><span class="st">  corr_matrix[2] Pcor = LPcor*LPcor&#39; ;</span></span>
<span id="cb31-40"><a href="using-stan-in-r.html#cb31-40" aria-hidden="true" tabindex="-1"></a><span class="st">  cov_matrix[2] Pcov = diag_matrix(V_P) * Pcor * diag_matrix(V_P);</span></span>
<span id="cb31-41"><a href="using-stan-in-r.html#cb31-41" aria-hidden="true" tabindex="-1"></a><span class="st">  </span></span>
<span id="cb31-42"><a href="using-stan-in-r.html#cb31-42" aria-hidden="true" tabindex="-1"></a><span class="st">}&quot;</span>, <span class="st">&quot;mod1.stan&quot;</span>)</span></code></pre></div>
<p>Note that the specification of the random effects has been greatly simplified with the non-centered parametrization. By separating out the scale of the deviations and the population-level (co)variances, it becomes unnecessary to directly specify the generative distribution of the full random effects as above. Instead, the full distribution is partitioned into three independent priors over the random effect standard normal deviations, SDs, and correlations, and the generative distribution of these values is specified directly through the scaling of the standard normals, i.e. <code>re_P = std_P * diag_pre_multiply(sd_P,LP_cor)'</code>=<span class="math inline">\(\boldsymbol{Z} \equiv \boldsymbol{Z_{\mathrm{std}}} \boldsymbol{\mathrm{L}_{\boldsymbol{\mathrm{C}}}}^{\mathrm{T}}\)</span> above. This should make the model much easier to sample from.</p>
<div class="sourceCode" id="cb32"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb32-1"><a href="using-stan-in-r.html#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(rstan)</span>
<span id="cb32-2"><a href="using-stan-in-r.html#cb32-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-3"><a href="using-stan-in-r.html#cb32-3" aria-hidden="true" tabindex="-1"></a>mod1 <span class="ot">=</span> <span class="fu">stan_model</span>(<span class="st">&quot;mod1.stan&quot;</span>)</span></code></pre></div>
<pre><code>## Warning in system(paste(CXX, ARGS), ignore.stdout = TRUE, ignore.stderr = TRUE): &#39;C:/rtools40/usr/mingw_/bin/g++&#39; not found</code></pre>
<div class="sourceCode" id="cb34"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb34-1"><a href="using-stan-in-r.html#cb34-1" aria-hidden="true" tabindex="-1"></a>stan_results2 <span class="ot">&lt;-</span> <span class="fu">sampling</span>(mod1, <span class="at">data=</span>stan_data, <span class="at">init =</span> <span class="dv">0</span>, <span class="at">warmup=</span><span class="dv">1500</span>, <span class="at">iter =</span> <span class="dv">2500</span>,</span>
<span id="cb34-2"><a href="using-stan-in-r.html#cb34-2" aria-hidden="true" tabindex="-1"></a>                         <span class="at">chains=</span><span class="dv">4</span>, <span class="at">cores=</span><span class="dv">4</span>, <span class="at">control=</span><span class="fu">list</span>(<span class="at">adapt_delta=</span><span class="fl">0.90</span>) )</span>
<span id="cb34-3"><a href="using-stan-in-r.html#cb34-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-4"><a href="using-stan-in-r.html#cb34-4" aria-hidden="true" tabindex="-1"></a><span class="co">#extracts posterior estimates</span></span>
<span id="cb34-5"><a href="using-stan-in-r.html#cb34-5" aria-hidden="true" tabindex="-1"></a>MCMCsamples <span class="ot">&lt;-</span>  <span class="fu">extract</span>(stan_results2)</span></code></pre></div>
<p>The absence of warning messages indicates that our mathematically equivalent reparametrizations have enhanced the efficiency of the MCMC sampler. The posterior samples of the model can subsequently be extracted, summarized, visualized, and manipulated. E.g.</p>
<div class="sourceCode" id="cb35"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb35-1"><a href="using-stan-in-r.html#cb35-1" aria-hidden="true" tabindex="-1"></a>post_beta_1 <span class="ot">=</span> MCMCsamples<span class="sc">$</span>beta_1 <span class="co">#extract population-level slope</span></span>
<span id="cb35-2"><a href="using-stan-in-r.html#cb35-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-3"><a href="using-stan-in-r.html#cb35-3" aria-hidden="true" tabindex="-1"></a><span class="fu">median</span>(post_beta_1) <span class="co">#central tendency of posterior</span></span></code></pre></div>
<pre><code>## [1] 0.3135554</code></pre>
<div class="sourceCode" id="cb37"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb37-1"><a href="using-stan-in-r.html#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="fu">mad</span>(post_beta_1) <span class="co">#dispersion around central tendency</span></span></code></pre></div>
<pre><code>## [1] 0.1186526</code></pre>
<div class="sourceCode" id="cb39"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb39-1"><a href="using-stan-in-r.html#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="fu">quantile</span>(post_beta_1, <span class="fu">c</span>(<span class="fl">0.05</span>,<span class="fl">0.95</span>)) <span class="co">#90% credible interval</span></span></code></pre></div>
<pre><code>##        5%       95% 
## 0.1141571 0.5144525</code></pre>
<div class="sourceCode" id="cb41"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb41-1"><a href="using-stan-in-r.html#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="fu">sum</span>(post_beta_1 <span class="sc">&gt;</span> <span class="dv">0</span>)<span class="sc">/</span><span class="fu">length</span>(post_beta_1) <span class="co">#posterior probability of + effect</span></span></code></pre></div>
<pre><code>## [1] 0.99175</code></pre>
<div class="sourceCode" id="cb43"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb43-1"><a href="using-stan-in-r.html#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="fu">hist</span>(post_beta_1) <span class="co">#MCMC approximation of posterior distribution</span></span></code></pre></div>
<p><img src="SAMs_files/figure-html/unnamed-chunk-17-1.png" width="672" /></p>
<p>We encourage the use of the <code>shinystan</code> R package for deeper inspection of model convergence and results with a GUI. In general, researchers should be skeptical of reporting results accompanied with sampler warnings and should seek to remove any diagnostic concerns prior to biological interpretation of the estimates.</p>
</div>
</div>
<div id="animal-models" class="section level2" number="1.5">
<h2><span class="header-section-number">1.5</span> Animal models</h2>
<p>The model presented above assumes a single set of individual-specific intercepts and slopes, as defined by the <code>mu</code> and <code>beta</code> vectors in the <code>.stan</code> file. For quantitative genetic analysis with an animal model, these phenotypic effects can be further decomposed into distinct genetic and permanent environmental trait values. In particular, we expand the random phenotypic deviations so that</p>
<p><span class="math display">\[ \boldsymbol{\mu_{\mathrm{ }}} =  \boldsymbol{\mu_{\mathrm{A}}} + \boldsymbol{\mu_{\mathrm{E}}}, \quad 
 \boldsymbol{\beta_{\mathrm{ }}} =  \boldsymbol{\beta_{\mathrm{A}}} + \boldsymbol{\beta_{\mathrm{E}}}\]</span>
<span class="math display">\[ \begin{bmatrix}
\boldsymbol{\mu_{\mathrm{A}}} \\ 
\boldsymbol{\beta_{\mathrm{A}}} 
\end{bmatrix} \sim \mathrm{MVNormal}(\boldsymbol{0}, \boldsymbol{\mathrm{G}} \otimes   \boldsymbol{\mathrm{A}}) : 
\boldsymbol{\mathrm{G}} =
\begin{bmatrix}
\mathrm{Var}( \boldsymbol{\mu_{\mathrm{A}}} ) &amp;  
\mathrm{Cov}( \boldsymbol{\mu_{\mathrm{A}}},  \boldsymbol{\beta_{\mathrm{A}}})     \\ 
\mathrm{Cov}(\boldsymbol{\beta_{\mathrm{A}}}, \boldsymbol{\mu_{\mathrm{A}}} ) &amp; 
\mathrm{Var}( \boldsymbol{\beta_{\mathrm{A}}} )
\end{bmatrix} \]</span></p>
<p><span class="math display">\[ \begin{bmatrix}
\boldsymbol{\mu_{\mathrm{E}}} \\ 
\boldsymbol{\beta_{\mathrm{E}}} 
\end{bmatrix} \sim \mathrm{MVNormal}(\boldsymbol{0}, \boldsymbol{\mathrm{E}} \otimes   \boldsymbol{\mathrm{I}}) : 
\boldsymbol{\mathrm{E}} =
\begin{bmatrix}
\mathrm{Var}( \boldsymbol{\mu_{\mathrm{E}}} ) &amp;  
\mathrm{Cov}( \boldsymbol{\mu_{\mathrm{E}}},  \boldsymbol{\beta_{\mathrm{E}}})     \\ 
\mathrm{Cov}(\boldsymbol{\beta_{\mathrm{E}}}, \boldsymbol{\mu_{\mathrm{E}}} ) &amp; 
\mathrm{Var}( \boldsymbol{\beta_{\mathrm{E}}} )
\end{bmatrix} \]</span></p>
<p>where <span class="math inline">\(\boldsymbol{\mathrm{A}}\)</span> is a positive-definite relatedness matrix derived from pedigree or molecular data. As we explain below, challenges arise when estimating such a model in Stan due to the difficulty of computing Kronecker products and the identification of genetic effects.</p>
<div id="simulate-data" class="section level3" number="1.5.1">
<h3><span class="header-section-number">1.5.1</span> Simulate data</h3>
<p>We use a custom function <code>pedfun</code> to generate an appropriately sized, positive-definite matrix for data simulation, which has been modified from prior work by <span class="citation"><a href="#ref-Thomson2018" role="doc-biblioref">Thomson et al.</a> (<a href="#ref-Thomson2018" role="doc-biblioref">2018</a>)</span>. This function is also utilized in the simulation code provided on the Github page. We supply basic demographic settings and generate <span class="math inline">\(\boldsymbol{\mathrm{A}}\)</span>, and we increase the sample size to N=300 to aid parameter estimate.</p>
<div class="sourceCode" id="cb44"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb44-1"><a href="using-stan-in-r.html#cb44-1" aria-hidden="true" tabindex="-1"></a><span class="co">#custom function</span></span>
<span id="cb44-2"><a href="using-stan-in-r.html#cb44-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(MCMCglmm)</span>
<span id="cb44-3"><a href="using-stan-in-r.html#cb44-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(Matrix)</span>
<span id="cb44-4"><a href="using-stan-in-r.html#cb44-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-5"><a href="using-stan-in-r.html#cb44-5" aria-hidden="true" tabindex="-1"></a>pedfun <span class="ot">&lt;-</span> <span class="cf">function</span>(popmin, popmax, ngenerations,</span>
<span id="cb44-6"><a href="using-stan-in-r.html#cb44-6" aria-hidden="true" tabindex="-1"></a>                 epm, nonb, nids, I, <span class="at">missing=</span><span class="cn">FALSE</span>){</span>
<span id="cb44-7"><a href="using-stan-in-r.html#cb44-7" aria-hidden="true" tabindex="-1"></a>  <span class="co"># get list of individuals and their generations</span></span>
<span id="cb44-8"><a href="using-stan-in-r.html#cb44-8" aria-hidden="true" tabindex="-1"></a>  gener<span class="ot">&lt;-</span><span class="dv">1</span><span class="sc">:</span>ngenerations</span>
<span id="cb44-9"><a href="using-stan-in-r.html#cb44-9" aria-hidden="true" tabindex="-1"></a>  genern <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="dv">1</span><span class="sc">:</span>ngenerations, <span class="at">times =</span> nids)</span>
<span id="cb44-10"><a href="using-stan-in-r.html#cb44-10" aria-hidden="true" tabindex="-1"></a>  ID <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">sum</span>(nids)</span>
<span id="cb44-11"><a href="using-stan-in-r.html#cb44-11" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb44-12"><a href="using-stan-in-r.html#cb44-12" aria-hidden="true" tabindex="-1"></a>  <span class="co"># runs on generation-by-generation basis</span></span>
<span id="cb44-13"><a href="using-stan-in-r.html#cb44-13" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>ngenerations){</span>
<span id="cb44-14"><a href="using-stan-in-r.html#cb44-14" aria-hidden="true" tabindex="-1"></a>    id<span class="ot">&lt;-</span>ID[<span class="fu">which</span>(genern<span class="sc">==</span>i)]</span>
<span id="cb44-15"><a href="using-stan-in-r.html#cb44-15" aria-hidden="true" tabindex="-1"></a>    dam<span class="ot">&lt;-</span><span class="fu">rep</span>(<span class="cn">NA</span>, nids[i])</span>
<span id="cb44-16"><a href="using-stan-in-r.html#cb44-16" aria-hidden="true" tabindex="-1"></a>    sire<span class="ot">&lt;-</span><span class="fu">rep</span>(<span class="cn">NA</span>, nids[i])</span>
<span id="cb44-17"><a href="using-stan-in-r.html#cb44-17" aria-hidden="true" tabindex="-1"></a>    <span class="co"># randomly allocates sex (0 = male, 1 = female)</span></span>
<span id="cb44-18"><a href="using-stan-in-r.html#cb44-18" aria-hidden="true" tabindex="-1"></a>    sex<span class="ot">&lt;-</span><span class="fu">sample</span>(<span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">1</span>), <span class="fu">length</span>(id), <span class="at">replace=</span><span class="cn">TRUE</span>)</span>
<span id="cb44-19"><a href="using-stan-in-r.html#cb44-19" aria-hidden="true" tabindex="-1"></a>    <span class="co"># for first generation, no dams or sires are known </span></span>
<span id="cb44-20"><a href="using-stan-in-r.html#cb44-20" aria-hidden="true" tabindex="-1"></a>    <span class="co"># so remain NA</span></span>
<span id="cb44-21"><a href="using-stan-in-r.html#cb44-21" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(i<span class="sc">==</span><span class="dv">1</span>){</span>
<span id="cb44-22"><a href="using-stan-in-r.html#cb44-22" aria-hidden="true" tabindex="-1"></a>      <span class="co"># combine into single data frame</span></span>
<span id="cb44-23"><a href="using-stan-in-r.html#cb44-23" aria-hidden="true" tabindex="-1"></a>      pedigree<span class="ot">&lt;-</span><span class="fu">data.frame</span>(<span class="at">id=</span>id, <span class="at">dam=</span>dam, <span class="at">sire=</span>sire, </span>
<span id="cb44-24"><a href="using-stan-in-r.html#cb44-24" aria-hidden="true" tabindex="-1"></a>                           <span class="at">generation=</span>i, <span class="at">sex=</span>sex)</span>
<span id="cb44-25"><a href="using-stan-in-r.html#cb44-25" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb44-26"><a href="using-stan-in-r.html#cb44-26" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span> <span class="cf">if</span>(i<span class="sc">&gt;</span><span class="dv">1</span>){</span>
<span id="cb44-27"><a href="using-stan-in-r.html#cb44-27" aria-hidden="true" tabindex="-1"></a>      <span class="co"># for all generations after first</span></span>
<span id="cb44-28"><a href="using-stan-in-r.html#cb44-28" aria-hidden="true" tabindex="-1"></a>      <span class="co"># list of all possible dams and sires</span></span>
<span id="cb44-29"><a href="using-stan-in-r.html#cb44-29" aria-hidden="true" tabindex="-1"></a>      <span class="co"># from previous generation</span></span>
<span id="cb44-30"><a href="using-stan-in-r.html#cb44-30" aria-hidden="true" tabindex="-1"></a>      pdams<span class="ot">&lt;-</span>pedigree<span class="sc">$</span>id[<span class="fu">which</span>(pedigree<span class="sc">$</span>generation<span class="sc">==</span>(i<span class="dv">-1</span>) <span class="sc">&amp;</span></span>
<span id="cb44-31"><a href="using-stan-in-r.html#cb44-31" aria-hidden="true" tabindex="-1"></a>                                 pedigree<span class="sc">$</span>sex<span class="sc">==</span><span class="dv">1</span>)]</span>
<span id="cb44-32"><a href="using-stan-in-r.html#cb44-32" aria-hidden="true" tabindex="-1"></a>      psires<span class="ot">&lt;-</span>pedigree<span class="sc">$</span>id[<span class="fu">which</span>(pedigree<span class="sc">$</span>generation<span class="sc">==</span>(i<span class="dv">-1</span>) <span class="sc">&amp;</span></span>
<span id="cb44-33"><a href="using-stan-in-r.html#cb44-33" aria-hidden="true" tabindex="-1"></a>                                  pedigree<span class="sc">$</span>sex<span class="sc">==</span><span class="dv">0</span>)]</span>
<span id="cb44-34"><a href="using-stan-in-r.html#cb44-34" aria-hidden="true" tabindex="-1"></a>      <span class="co"># determine number of pairs</span></span>
<span id="cb44-35"><a href="using-stan-in-r.html#cb44-35" aria-hidden="true" tabindex="-1"></a>      <span class="co"># depending on how many males and females</span></span>
<span id="cb44-36"><a href="using-stan-in-r.html#cb44-36" aria-hidden="true" tabindex="-1"></a>      <span class="co"># and the proportion of the population that is non-breeding</span></span>
<span id="cb44-37"><a href="using-stan-in-r.html#cb44-37" aria-hidden="true" tabindex="-1"></a>      npairs<span class="ot">&lt;-</span><span class="fu">min</span>(<span class="fu">length</span>(pdams), <span class="fu">length</span>(psires)) <span class="sc">-</span> </span>
<span id="cb44-38"><a href="using-stan-in-r.html#cb44-38" aria-hidden="true" tabindex="-1"></a>        <span class="fu">round</span>(<span class="fu">min</span>(<span class="fu">length</span>(pdams), <span class="fu">length</span>(psires))<span class="sc">*</span>nonb)</span>
<span id="cb44-39"><a href="using-stan-in-r.html#cb44-39" aria-hidden="true" tabindex="-1"></a>      <span class="co"># selects breeding males and females</span></span>
<span id="cb44-40"><a href="using-stan-in-r.html#cb44-40" aria-hidden="true" tabindex="-1"></a>      pdams<span class="ot">&lt;-</span>pedigree<span class="sc">$</span>id[<span class="fu">which</span>(pedigree<span class="sc">$</span>generation<span class="sc">==</span>(i<span class="dv">-1</span>) <span class="sc">&amp;</span> </span>
<span id="cb44-41"><a href="using-stan-in-r.html#cb44-41" aria-hidden="true" tabindex="-1"></a>                                 pedigree<span class="sc">$</span>sex<span class="sc">==</span><span class="dv">1</span>)]</span>
<span id="cb44-42"><a href="using-stan-in-r.html#cb44-42" aria-hidden="true" tabindex="-1"></a>      psires<span class="ot">&lt;-</span>pedigree<span class="sc">$</span>id[<span class="fu">which</span>(pedigree<span class="sc">$</span>generation<span class="sc">==</span>(i<span class="dv">-1</span>) <span class="sc">&amp;</span> </span>
<span id="cb44-43"><a href="using-stan-in-r.html#cb44-43" aria-hidden="true" tabindex="-1"></a>                                  pedigree<span class="sc">$</span>sex<span class="sc">==</span><span class="dv">0</span>)]</span>
<span id="cb44-44"><a href="using-stan-in-r.html#cb44-44" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span>(<span class="fu">length</span>(pdams)<span class="sc">&lt;</span>npairs <span class="sc">|</span> <span class="fu">length</span>(psires)<span class="sc">&lt;</span>npairs){</span>
<span id="cb44-45"><a href="using-stan-in-r.html#cb44-45" aria-hidden="true" tabindex="-1"></a>        npairs<span class="ot">&lt;-</span><span class="fu">min</span>(<span class="fu">length</span>(pdams), <span class="fu">length</span>(psires))</span>
<span id="cb44-46"><a href="using-stan-in-r.html#cb44-46" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb44-47"><a href="using-stan-in-r.html#cb44-47" aria-hidden="true" tabindex="-1"></a>      <span class="co"># selects pairs from possible dams and sires</span></span>
<span id="cb44-48"><a href="using-stan-in-r.html#cb44-48" aria-hidden="true" tabindex="-1"></a>      pairs<span class="ot">&lt;-</span><span class="fu">data.frame</span>(<span class="at">dam=</span><span class="fu">sample</span>(pdams, npairs, <span class="at">replace=</span><span class="cn">FALSE</span>),</span>
<span id="cb44-49"><a href="using-stan-in-r.html#cb44-49" aria-hidden="true" tabindex="-1"></a>                        <span class="at">sire=</span><span class="fu">sample</span>(psires, npairs, <span class="at">replace=</span><span class="cn">FALSE</span>))</span>
<span id="cb44-50"><a href="using-stan-in-r.html#cb44-50" aria-hidden="true" tabindex="-1"></a>      <span class="co"># gives each offspring their parental pair</span></span>
<span id="cb44-51"><a href="using-stan-in-r.html#cb44-51" aria-hidden="true" tabindex="-1"></a>      pairid<span class="ot">&lt;-</span><span class="fu">as.numeric</span>(<span class="fu">sample</span>(<span class="fu">rownames</span>(pairs), </span>
<span id="cb44-52"><a href="using-stan-in-r.html#cb44-52" aria-hidden="true" tabindex="-1"></a>                                <span class="fu">length</span>(id), <span class="at">replace=</span><span class="cn">TRUE</span>))</span>
<span id="cb44-53"><a href="using-stan-in-r.html#cb44-53" aria-hidden="true" tabindex="-1"></a>      <span class="co"># gives each offspring their sex</span></span>
<span id="cb44-54"><a href="using-stan-in-r.html#cb44-54" aria-hidden="true" tabindex="-1"></a>      sex<span class="ot">&lt;-</span><span class="fu">sample</span>(<span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">1</span>), <span class="fu">length</span>(id), <span class="at">replace=</span><span class="cn">TRUE</span>)</span>
<span id="cb44-55"><a href="using-stan-in-r.html#cb44-55" aria-hidden="true" tabindex="-1"></a>      <span class="co"># put into dataframe format</span></span>
<span id="cb44-56"><a href="using-stan-in-r.html#cb44-56" aria-hidden="true" tabindex="-1"></a>      addped<span class="ot">&lt;-</span><span class="fu">data.frame</span>(<span class="at">id=</span>id, </span>
<span id="cb44-57"><a href="using-stan-in-r.html#cb44-57" aria-hidden="true" tabindex="-1"></a>                         <span class="at">dam=</span>pairs<span class="sc">$</span>dam[pairid], </span>
<span id="cb44-58"><a href="using-stan-in-r.html#cb44-58" aria-hidden="true" tabindex="-1"></a>                         <span class="at">sire=</span>pairs<span class="sc">$</span>sire[pairid],</span>
<span id="cb44-59"><a href="using-stan-in-r.html#cb44-59" aria-hidden="true" tabindex="-1"></a>                         <span class="at">generation=</span>i, </span>
<span id="cb44-60"><a href="using-stan-in-r.html#cb44-60" aria-hidden="true" tabindex="-1"></a>                         <span class="at">sex=</span>sex)</span>
<span id="cb44-61"><a href="using-stan-in-r.html#cb44-61" aria-hidden="true" tabindex="-1"></a>      <span class="co"># deals with extra-pair mating (if included)</span></span>
<span id="cb44-62"><a href="using-stan-in-r.html#cb44-62" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span>(<span class="sc">!</span><span class="fu">is.null</span>(epm)){</span>
<span id="cb44-63"><a href="using-stan-in-r.html#cb44-63" aria-hidden="true" tabindex="-1"></a>        <span class="co"># for each individual, sample if they are extra pair</span></span>
<span id="cb44-64"><a href="using-stan-in-r.html#cb44-64" aria-hidden="true" tabindex="-1"></a>        <span class="co"># if 0 not extra pair</span></span>
<span id="cb44-65"><a href="using-stan-in-r.html#cb44-65" aria-hidden="true" tabindex="-1"></a>        <span class="co"># if 1 sire resampled from breeding population</span></span>
<span id="cb44-66"><a href="using-stan-in-r.html#cb44-66" aria-hidden="true" tabindex="-1"></a>        <span class="co"># if 2 dam resampled</span></span>
<span id="cb44-67"><a href="using-stan-in-r.html#cb44-67" aria-hidden="true" tabindex="-1"></a>        ext<span class="ot">&lt;-</span><span class="fu">sample</span>(<span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">1</span>,<span class="dv">2</span>), <span class="fu">nrow</span>(addped), </span>
<span id="cb44-68"><a href="using-stan-in-r.html#cb44-68" aria-hidden="true" tabindex="-1"></a>                    <span class="at">replace=</span><span class="cn">TRUE</span>, </span>
<span id="cb44-69"><a href="using-stan-in-r.html#cb44-69" aria-hidden="true" tabindex="-1"></a>                    <span class="at">prob =</span> <span class="fu">c</span>(<span class="dv">1</span><span class="sc">-</span>epm, epm<span class="sc">/</span><span class="dv">2</span>, epm<span class="sc">/</span><span class="dv">2</span>))</span>
<span id="cb44-70"><a href="using-stan-in-r.html#cb44-70" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span>(j <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(addped)){</span>
<span id="cb44-71"><a href="using-stan-in-r.html#cb44-71" aria-hidden="true" tabindex="-1"></a>          <span class="cf">if</span>(ext[j]<span class="sc">&gt;</span><span class="dv">0</span>){</span>
<span id="cb44-72"><a href="using-stan-in-r.html#cb44-72" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span>(ext[j]<span class="sc">==</span><span class="dv">1</span>){</span>
<span id="cb44-73"><a href="using-stan-in-r.html#cb44-73" aria-hidden="true" tabindex="-1"></a>              addped<span class="sc">$</span>sire[j]<span class="ot">&lt;-</span><span class="fu">sample</span>(psires,<span class="dv">1</span>,<span class="at">replace=</span><span class="cn">TRUE</span>)</span>
<span id="cb44-74"><a href="using-stan-in-r.html#cb44-74" aria-hidden="true" tabindex="-1"></a>            }<span class="cf">else</span> <span class="cf">if</span> (ext[j]<span class="sc">==</span><span class="dv">2</span>){</span>
<span id="cb44-75"><a href="using-stan-in-r.html#cb44-75" aria-hidden="true" tabindex="-1"></a>              addped<span class="sc">$</span>dam[j]<span class="ot">&lt;-</span><span class="fu">sample</span>(pdams,<span class="dv">1</span>,<span class="at">replace=</span><span class="cn">TRUE</span>)</span>
<span id="cb44-76"><a href="using-stan-in-r.html#cb44-76" aria-hidden="true" tabindex="-1"></a>            }</span>
<span id="cb44-77"><a href="using-stan-in-r.html#cb44-77" aria-hidden="true" tabindex="-1"></a>          }</span>
<span id="cb44-78"><a href="using-stan-in-r.html#cb44-78" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb44-79"><a href="using-stan-in-r.html#cb44-79" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb44-80"><a href="using-stan-in-r.html#cb44-80" aria-hidden="true" tabindex="-1"></a>      <span class="co"># add new generation to the whole pedigree</span></span>
<span id="cb44-81"><a href="using-stan-in-r.html#cb44-81" aria-hidden="true" tabindex="-1"></a>      pedigree<span class="ot">&lt;-</span><span class="fu">rbind</span>(pedigree, addped)</span>
<span id="cb44-82"><a href="using-stan-in-r.html#cb44-82" aria-hidden="true" tabindex="-1"></a>   }</span>
<span id="cb44-83"><a href="using-stan-in-r.html#cb44-83" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb44-84"><a href="using-stan-in-r.html#cb44-84" aria-hidden="true" tabindex="-1"></a>  ped <span class="ot">&lt;-</span> pedigree</span>
<span id="cb44-85"><a href="using-stan-in-r.html#cb44-85" aria-hidden="true" tabindex="-1"></a>  <span class="co"># make id&#39;s non-numeric</span></span>
<span id="cb44-86"><a href="using-stan-in-r.html#cb44-86" aria-hidden="true" tabindex="-1"></a>  ped<span class="sc">$</span>id<span class="ot">&lt;-</span><span class="fu">paste</span>(<span class="st">&quot;ID&quot;</span>,ped<span class="sc">$</span>id, <span class="at">sep=</span><span class="st">&quot;&quot;</span>)</span>
<span id="cb44-87"><a href="using-stan-in-r.html#cb44-87" aria-hidden="true" tabindex="-1"></a>  ped<span class="sc">$</span>dam[<span class="fu">which</span>(<span class="sc">!</span><span class="fu">is.na</span>(ped<span class="sc">$</span>dam))]<span class="ot">&lt;-</span><span class="fu">paste</span>(<span class="st">&quot;ID&quot;</span>,ped<span class="sc">$</span>dam[<span class="fu">which</span>(<span class="sc">!</span><span class="fu">is.na</span>(ped<span class="sc">$</span>dam))], <span class="at">sep=</span><span class="st">&quot;&quot;</span>)</span>
<span id="cb44-88"><a href="using-stan-in-r.html#cb44-88" aria-hidden="true" tabindex="-1"></a>  ped<span class="sc">$</span>sire[<span class="fu">which</span>(<span class="sc">!</span><span class="fu">is.na</span>(ped<span class="sc">$</span>sire))]<span class="ot">&lt;-</span><span class="fu">paste</span>(<span class="st">&quot;ID&quot;</span>,ped<span class="sc">$</span>sire[<span class="fu">which</span>(<span class="sc">!</span><span class="fu">is.na</span>(ped<span class="sc">$</span>sire))], <span class="at">sep=</span><span class="st">&quot;&quot;</span>)</span>
<span id="cb44-89"><a href="using-stan-in-r.html#cb44-89" aria-hidden="true" tabindex="-1"></a>  ped<span class="sc">$</span>id<span class="ot">&lt;-</span><span class="fu">as.character</span>(ped<span class="sc">$</span>id)</span>
<span id="cb44-90"><a href="using-stan-in-r.html#cb44-90" aria-hidden="true" tabindex="-1"></a>  ped<span class="sc">$</span>dam<span class="ot">&lt;-</span><span class="fu">as.character</span>(ped<span class="sc">$</span>dam)</span>
<span id="cb44-91"><a href="using-stan-in-r.html#cb44-91" aria-hidden="true" tabindex="-1"></a>  ped<span class="sc">$</span>sire<span class="ot">&lt;-</span><span class="fu">as.character</span>(ped<span class="sc">$</span>sire)</span>
<span id="cb44-92"><a href="using-stan-in-r.html#cb44-92" aria-hidden="true" tabindex="-1"></a>  IDs <span class="ot">&lt;-</span> <span class="fu">sample</span>(ped[ped<span class="sc">$</span>generation<span class="sc">==</span>ngenerations, <span class="st">&quot;id&quot;</span>], I, <span class="at">replace=</span><span class="cn">FALSE</span>)</span>
<span id="cb44-93"><a href="using-stan-in-r.html#cb44-93" aria-hidden="true" tabindex="-1"></a>  ped <span class="ot">&lt;-</span> <span class="fu">prunePed</span>(ped, <span class="at">keep =</span> IDs, <span class="at">make.base=</span><span class="cn">TRUE</span>)</span>
<span id="cb44-94"><a href="using-stan-in-r.html#cb44-94" aria-hidden="true" tabindex="-1"></a>  inv.phylo <span class="ot">&lt;-</span> <span class="fu">inverseA</span>(ped[,<span class="fu">c</span>(<span class="st">&quot;id&quot;</span>,<span class="st">&quot;dam&quot;</span>,<span class="st">&quot;sire&quot;</span>)])</span>
<span id="cb44-95"><a href="using-stan-in-r.html#cb44-95" aria-hidden="true" tabindex="-1"></a>  A <span class="ot">&lt;-</span> <span class="fu">solve</span>(inv.phylo<span class="sc">$</span>Ainv)</span>
<span id="cb44-96"><a href="using-stan-in-r.html#cb44-96" aria-hidden="true" tabindex="-1"></a>  A <span class="ot">&lt;-</span> <span class="fu">cov2cor</span>(A)</span>
<span id="cb44-97"><a href="using-stan-in-r.html#cb44-97" aria-hidden="true" tabindex="-1"></a>  A <span class="ot">=</span> (A <span class="sc">+</span> <span class="fu">t</span>(A))<span class="sc">/</span><span class="dv">2</span> <span class="co"># Not always symmetric after inversion</span></span>
<span id="cb44-98"><a href="using-stan-in-r.html#cb44-98" aria-hidden="true" tabindex="-1"></a>  A <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(A)</span>
<span id="cb44-99"><a href="using-stan-in-r.html#cb44-99" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rownames</span>(A) <span class="ot">&lt;-</span> <span class="fu">rownames</span>(inv.phylo<span class="sc">$</span>Ainv)</span>
<span id="cb44-100"><a href="using-stan-in-r.html#cb44-100" aria-hidden="true" tabindex="-1"></a>  <span class="fu">colnames</span>(A) <span class="ot">&lt;-</span> <span class="fu">rownames</span>(inv.phylo<span class="sc">$</span>Ainv)</span>
<span id="cb44-101"><a href="using-stan-in-r.html#cb44-101" aria-hidden="true" tabindex="-1"></a>  <span class="co">#subset to final generation</span></span>
<span id="cb44-102"><a href="using-stan-in-r.html#cb44-102" aria-hidden="true" tabindex="-1"></a>  A_sub<span class="ot">&lt;-</span>A[IDs,IDs]</span>
<span id="cb44-103"><a href="using-stan-in-r.html#cb44-103" aria-hidden="true" tabindex="-1"></a>  A_mat <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(<span class="fu">nearPD</span>(A_sub)<span class="sc">$</span>mat)</span>
<span id="cb44-104"><a href="using-stan-in-r.html#cb44-104" aria-hidden="true" tabindex="-1"></a>  A_mat <span class="ot">&lt;-</span> <span class="fu">cov2cor</span>(A_mat)</span>
<span id="cb44-105"><a href="using-stan-in-r.html#cb44-105" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(A_mat)</span>
<span id="cb44-106"><a href="using-stan-in-r.html#cb44-106" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb44-107"><a href="using-stan-in-r.html#cb44-107" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-108"><a href="using-stan-in-r.html#cb44-108" aria-hidden="true" tabindex="-1"></a> <span class="co">#population properties</span></span>
<span id="cb44-109"><a href="using-stan-in-r.html#cb44-109" aria-hidden="true" tabindex="-1"></a> I<span class="ot">=</span><span class="dv">300</span> <span class="co">#total individuals for simulation</span></span>
<span id="cb44-110"><a href="using-stan-in-r.html#cb44-110" aria-hidden="true" tabindex="-1"></a> popmin<span class="ot">=</span><span class="dv">400</span></span>
<span id="cb44-111"><a href="using-stan-in-r.html#cb44-111" aria-hidden="true" tabindex="-1"></a> popmax<span class="ot">=</span><span class="dv">600</span></span>
<span id="cb44-112"><a href="using-stan-in-r.html#cb44-112" aria-hidden="true" tabindex="-1"></a> ngenerations <span class="ot">=</span> <span class="dv">10</span></span>
<span id="cb44-113"><a href="using-stan-in-r.html#cb44-113" aria-hidden="true" tabindex="-1"></a> nids<span class="ot">&lt;-</span><span class="fu">sample</span>(popmin<span class="sc">:</span>popmax, ngenerations, <span class="at">replace=</span><span class="cn">TRUE</span>) <span class="co">#N / generation</span></span>
<span id="cb44-114"><a href="using-stan-in-r.html#cb44-114" aria-hidden="true" tabindex="-1"></a> epm <span class="ot">=</span> <span class="fu">sample</span>(<span class="fu">seq</span>(<span class="fl">0.15</span>, <span class="fl">0.25</span>,<span class="at">by=</span><span class="fl">0.05</span>),<span class="dv">1</span>) <span class="co">#extra-pair mating</span></span>
<span id="cb44-115"><a href="using-stan-in-r.html#cb44-115" aria-hidden="true" tabindex="-1"></a> nonb <span class="ot">=</span> <span class="fu">sample</span>(<span class="fu">seq</span>(<span class="fl">0.4</span>,<span class="fl">0.6</span>,<span class="at">by=</span><span class="fl">0.05</span>),<span class="dv">1</span>) <span class="co">#proportion of non-breeding / generation</span></span>
<span id="cb44-116"><a href="using-stan-in-r.html#cb44-116" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb44-117"><a href="using-stan-in-r.html#cb44-117" aria-hidden="true" tabindex="-1"></a> <span class="co">#relatedness matrix</span></span>
<span id="cb44-118"><a href="using-stan-in-r.html#cb44-118" aria-hidden="true" tabindex="-1"></a> A_mat <span class="ot">&lt;-</span> <span class="fu">pedfun</span>(<span class="at">popmin=</span>popmin, <span class="at">popmax=</span>popmax, <span class="at">ngenerations=</span>ngenerations,</span>
<span id="cb44-119"><a href="using-stan-in-r.html#cb44-119" aria-hidden="true" tabindex="-1"></a>                  <span class="at">epm=</span>epm, <span class="at">nonb=</span>nonb, <span class="at">nids=</span>nids, <span class="at">I=</span>I, <span class="at">missing=</span><span class="cn">FALSE</span>)</span></code></pre></div>
<p>We can now simulate a new dataset using the code from above, partitioning the distinct additive genetic and permanent environmental trait values. We include a third measurement per individual to enhance estimation of the individual-level RN intercepts and slopes.</p>
<div class="sourceCode" id="cb45"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb45-1"><a href="using-stan-in-r.html#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(mvtnorm)</span>
<span id="cb45-2"><a href="using-stan-in-r.html#cb45-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-3"><a href="using-stan-in-r.html#cb45-3" aria-hidden="true" tabindex="-1"></a>N <span class="ot">=</span> <span class="dv">900</span> <span class="co">#total observations (3x/individual)</span></span>
<span id="cb45-4"><a href="using-stan-in-r.html#cb45-4" aria-hidden="true" tabindex="-1"></a>I <span class="ot">=</span> <span class="dv">300</span> <span class="co">#total individuals</span></span>
<span id="cb45-5"><a href="using-stan-in-r.html#cb45-5" aria-hidden="true" tabindex="-1"></a>intercept <span class="ot">=</span> <span class="dv">1</span> <span class="co">#global intercept</span></span>
<span id="cb45-6"><a href="using-stan-in-r.html#cb45-6" aria-hidden="true" tabindex="-1"></a>beta1 <span class="ot">=</span> <span class="fl">0.3</span> <span class="co">#fixed effect regression coefficient</span></span>
<span id="cb45-7"><a href="using-stan-in-r.html#cb45-7" aria-hidden="true" tabindex="-1"></a>SD_intercept <span class="ot">=</span> <span class="fl">0.3</span> <span class="co">#standard deviation of random intercepts</span></span>
<span id="cb45-8"><a href="using-stan-in-r.html#cb45-8" aria-hidden="true" tabindex="-1"></a>SD_slope <span class="ot">=</span> <span class="fl">0.3</span></span>
<span id="cb45-9"><a href="using-stan-in-r.html#cb45-9" aria-hidden="true" tabindex="-1"></a>SD_residual <span class="ot">=</span> <span class="dv">1</span></span>
<span id="cb45-10"><a href="using-stan-in-r.html#cb45-10" aria-hidden="true" tabindex="-1"></a>r_G <span class="ot">=</span> <span class="fl">0.5</span> <span class="co">#genetic correlation of random intercepts and slopes</span></span>
<span id="cb45-11"><a href="using-stan-in-r.html#cb45-11" aria-hidden="true" tabindex="-1"></a>r_E <span class="ot">=</span> <span class="sc">-</span><span class="fl">0.5</span> <span class="co">#environmental correlation</span></span>
<span id="cb45-12"><a href="using-stan-in-r.html#cb45-12" aria-hidden="true" tabindex="-1"></a>V_G <span class="ot">=</span> <span class="fl">0.3</span> <span class="co">#genetic variance of REs</span></span>
<span id="cb45-13"><a href="using-stan-in-r.html#cb45-13" aria-hidden="true" tabindex="-1"></a>V_E <span class="ot">=</span> <span class="fl">0.3</span> <span class="co">#genetic variance of REs</span></span>
<span id="cb45-14"><a href="using-stan-in-r.html#cb45-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-15"><a href="using-stan-in-r.html#cb45-15" aria-hidden="true" tabindex="-1"></a><span class="co">#Random effect correlations</span></span>
<span id="cb45-16"><a href="using-stan-in-r.html#cb45-16" aria-hidden="true" tabindex="-1"></a>G_cor <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">c</span>(<span class="dv">1</span>,r_G,r_G,<span class="dv">1</span>), <span class="at">nrow=</span><span class="dv">2</span>, <span class="at">ncol=</span><span class="dv">2</span>) <span class="co">#mu_A, beta_A</span></span>
<span id="cb45-17"><a href="using-stan-in-r.html#cb45-17" aria-hidden="true" tabindex="-1"></a>G_sd  <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fu">sqrt</span>(V_G),<span class="fu">sqrt</span>(V_G)) <span class="co">#G effect sds</span></span>
<span id="cb45-18"><a href="using-stan-in-r.html#cb45-18" aria-hidden="true" tabindex="-1"></a>G_cov <span class="ot">&lt;-</span> <span class="fu">diag</span>(G_sd) <span class="sc">%*%</span> G_cor <span class="sc">%*%</span> <span class="fu">diag</span>(G_sd)</span>
<span id="cb45-19"><a href="using-stan-in-r.html#cb45-19" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb45-20"><a href="using-stan-in-r.html#cb45-20" aria-hidden="true" tabindex="-1"></a>E_cor <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">c</span>(<span class="dv">1</span>,r_E,r_E,<span class="dv">1</span>), <span class="at">nrow=</span><span class="dv">2</span>, <span class="at">ncol=</span><span class="dv">2</span>) <span class="co">#mu_E, beta_E</span></span>
<span id="cb45-21"><a href="using-stan-in-r.html#cb45-21" aria-hidden="true" tabindex="-1"></a>E_sd  <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fu">sqrt</span>(V_E),<span class="fu">sqrt</span>(V_E)) <span class="co">#E effect sds</span></span>
<span id="cb45-22"><a href="using-stan-in-r.html#cb45-22" aria-hidden="true" tabindex="-1"></a>E_cov <span class="ot">&lt;-</span> <span class="fu">diag</span>(E_sd) <span class="sc">%*%</span> E_cor <span class="sc">%*%</span> <span class="fu">diag</span>(E_sd)</span>
<span id="cb45-23"><a href="using-stan-in-r.html#cb45-23" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb45-24"><a href="using-stan-in-r.html#cb45-24" aria-hidden="true" tabindex="-1"></a><span class="co">#matrices</span></span>
<span id="cb45-25"><a href="using-stan-in-r.html#cb45-25" aria-hidden="true" tabindex="-1"></a>G_block <span class="ot">&lt;-</span> G_cov <span class="sc">%x%</span> A_mat</span>
<span id="cb45-26"><a href="using-stan-in-r.html#cb45-26" aria-hidden="true" tabindex="-1"></a>E_block <span class="ot">&lt;-</span> E_cov <span class="sc">%x%</span> <span class="fu">diag</span>(<span class="dv">1</span>,I)</span>
<span id="cb45-27"><a href="using-stan-in-r.html#cb45-27" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb45-28"><a href="using-stan-in-r.html#cb45-28" aria-hidden="true" tabindex="-1"></a><span class="co">#generate correlated REs</span></span>
<span id="cb45-29"><a href="using-stan-in-r.html#cb45-29" aria-hidden="true" tabindex="-1"></a>Gvalues <span class="ot">&lt;-</span> <span class="fu">rmvnorm</span>(<span class="dv">1</span>, <span class="at">mean=</span><span class="fu">rep</span>(<span class="dv">0</span>,I<span class="sc">*</span><span class="dv">2</span>), <span class="at">sigma=</span>G_block)</span>
<span id="cb45-30"><a href="using-stan-in-r.html#cb45-30" aria-hidden="true" tabindex="-1"></a>G_val <span class="ot">=</span> <span class="fu">data.frame</span>(<span class="fu">matrix</span>(Gvalues, <span class="at">nrow=</span>I, <span class="at">ncol=</span><span class="dv">2</span>))</span>
<span id="cb45-31"><a href="using-stan-in-r.html#cb45-31" aria-hidden="true" tabindex="-1"></a><span class="fu">cor</span>(G_val)</span></code></pre></div>
<pre><code>##           X1        X2
## X1 1.0000000 0.4511557
## X2 0.4511557 1.0000000</code></pre>
<div class="sourceCode" id="cb47"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb47-1"><a href="using-stan-in-r.html#cb47-1" aria-hidden="true" tabindex="-1"></a>Evalues <span class="ot">&lt;-</span> <span class="fu">rmvnorm</span>(<span class="dv">1</span>, <span class="at">mean=</span><span class="fu">rep</span>(<span class="dv">0</span>,I<span class="sc">*</span><span class="dv">2</span>), <span class="at">sigma=</span>E_block)</span>
<span id="cb47-2"><a href="using-stan-in-r.html#cb47-2" aria-hidden="true" tabindex="-1"></a>E_val <span class="ot">=</span> <span class="fu">data.frame</span>(<span class="fu">matrix</span>(Evalues, <span class="at">nrow=</span>I, <span class="at">ncol=</span><span class="dv">2</span>))</span>
<span id="cb47-3"><a href="using-stan-in-r.html#cb47-3" aria-hidden="true" tabindex="-1"></a><span class="fu">cor</span>(E_val)</span></code></pre></div>
<pre><code>##            X1         X2
## X1  1.0000000 -0.5033042
## X2 -0.5033042  1.0000000</code></pre>
<div class="sourceCode" id="cb49"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb49-1"><a href="using-stan-in-r.html#cb49-1" aria-hidden="true" tabindex="-1"></a><span class="co">#combine</span></span>
<span id="cb49-2"><a href="using-stan-in-r.html#cb49-2" aria-hidden="true" tabindex="-1"></a>re_P <span class="ot">=</span> <span class="fu">cbind</span>(G_val,E_val)</span>
<span id="cb49-3"><a href="using-stan-in-r.html#cb49-3" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(re_P) <span class="ot">=</span> <span class="fu">c</span>(<span class="st">&quot;mu_A&quot;</span>, <span class="st">&quot;beta_A&quot;</span>, <span class="st">&quot;mu_E&quot;</span>, <span class="st">&quot;beta_E&quot;</span>)</span>
<span id="cb49-4"><a href="using-stan-in-r.html#cb49-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-5"><a href="using-stan-in-r.html#cb49-5" aria-hidden="true" tabindex="-1"></a><span class="co">#individual-level index</span></span>
<span id="cb49-6"><a href="using-stan-in-r.html#cb49-6" aria-hidden="true" tabindex="-1"></a>id <span class="ot">=</span> <span class="fu">rep</span>(<span class="fu">seq</span>(<span class="dv">1</span>, I), <span class="at">each =</span> N<span class="sc">/</span>I) <span class="co">#i.e. two observations per individual</span></span>
<span id="cb49-7"><a href="using-stan-in-r.html#cb49-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-8"><a href="using-stan-in-r.html#cb49-8" aria-hidden="true" tabindex="-1"></a><span class="co">#simulate fixed effect covariate</span></span>
<span id="cb49-9"><a href="using-stan-in-r.html#cb49-9" aria-hidden="true" tabindex="-1"></a>x <span class="ot">=</span> <span class="fu">rnorm</span>(N,<span class="dv">0</span>,<span class="dv">1</span>)</span>
<span id="cb49-10"><a href="using-stan-in-r.html#cb49-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-11"><a href="using-stan-in-r.html#cb49-11" aria-hidden="true" tabindex="-1"></a><span class="co">#individual phenotypic REs</span></span>
<span id="cb49-12"><a href="using-stan-in-r.html#cb49-12" aria-hidden="true" tabindex="-1"></a>mu <span class="ot">=</span> re_P<span class="sc">$</span>mu_A <span class="sc">+</span> re_P<span class="sc">$</span>mu_E</span>
<span id="cb49-13"><a href="using-stan-in-r.html#cb49-13" aria-hidden="true" tabindex="-1"></a>beta <span class="ot">=</span> re_P<span class="sc">$</span>beta_A <span class="sc">+</span> re_P<span class="sc">$</span>beta_E</span>
<span id="cb49-14"><a href="using-stan-in-r.html#cb49-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-15"><a href="using-stan-in-r.html#cb49-15" aria-hidden="true" tabindex="-1"></a><span class="co">#residual effects</span></span>
<span id="cb49-16"><a href="using-stan-in-r.html#cb49-16" aria-hidden="true" tabindex="-1"></a>epsilon <span class="ot">=</span> <span class="fu">rnorm</span>(N, <span class="dv">0</span>, SD_residual )</span>
<span id="cb49-17"><a href="using-stan-in-r.html#cb49-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-18"><a href="using-stan-in-r.html#cb49-18" aria-hidden="true" tabindex="-1"></a><span class="co">#measured response</span></span>
<span id="cb49-19"><a href="using-stan-in-r.html#cb49-19" aria-hidden="true" tabindex="-1"></a>z <span class="ot">=</span> intercept <span class="sc">+</span> mu[id] <span class="sc">+</span> (beta1 <span class="sc">+</span> beta[id])<span class="sc">*</span>x <span class="sc">+</span> epsilon</span>
<span id="cb49-20"><a href="using-stan-in-r.html#cb49-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-21"><a href="using-stan-in-r.html#cb49-21" aria-hidden="true" tabindex="-1"></a><span class="co">#combine into list for Stan</span></span>
<span id="cb49-22"><a href="using-stan-in-r.html#cb49-22" aria-hidden="true" tabindex="-1"></a>stan_data <span class="ot">=</span> <span class="fu">list</span>(<span class="at">z =</span> z, <span class="at">x =</span> x, <span class="at">id =</span> id, <span class="at">N =</span> N, <span class="at">I =</span> I, <span class="at">A =</span> A_mat)</span></code></pre></div>
</div>
<div id="kronecker-products" class="section level3" number="1.5.2">
<h3><span class="header-section-number">1.5.2</span> Kronecker products</h3>
<p>We now need to edit the Stan file to partition the genetic and environmental values. Unfortunately, there are no in-built Stan functions for efficiently computing Kronecker products <span class="math inline">\(\otimes\)</span>. This could be overcome by manually specifying the Kronecker product function in the optional <code>functions</code> block of the model. However, Kronecker products can be incredibly costly to compute, particularly for large matrices. It’s thus desirable to find another alternative but mathematically equivalent parametrization to return random effects appropriately scaled by <span class="math inline">\(\boldsymbol{\mathrm{G}} \otimes \boldsymbol{\mathrm{A}}\)</span> without directly computing this term, as we did above with the Cholesky decomposition and non-centered random effects.</p>
<p>Fortunately, this can be easily accomplished by exploiting the properties of the matrix normal distribution, which generalizes the multivariate normal distribution to random variables described by matrices <span class="citation">(<a href="#ref-Gupta2018" role="doc-biblioref">Gupta and Nagar 2018</a>)</span>. In particular, the matrix normal distribution for some <em>n</em> x <em>p</em> matrix <span class="math inline">\(\boldsymbol{\mathrm{Z}}\)</span> of <em>p</em> phenotypes is given by</p>
<p><span class="math display">\[ \boldsymbol{\mathrm{Z}} \sim \mathrm{Matrix\ Normal_{n \ x \ p}}(\boldsymbol{\mathrm{M}}, \boldsymbol{\mathrm{U}}, \boldsymbol{\mathrm{V}}) \]</span></p>
<p>where <span class="math inline">\(\boldsymbol{\mathrm{M}}\)</span> is a matrix of expected values and <span class="math inline">\(\boldsymbol{\mathrm{U}}\)</span> and <span class="math inline">\(\boldsymbol{\mathrm{V}}\)</span> are scaling matrices describing the among-row and among-column (co)variance respectively. This lesser known distribution generalizes from the multivariate normal distribution such that any matrix <span class="math inline">\(\boldsymbol{\mathrm{Z}}\)</span> will be matrix normally distributed if and only if
<span class="math display">\[ \mathrm{vec}(\boldsymbol{\mathrm{Z}}) \sim \mathrm{MVNormal_{np}}(\mathrm{vec}(\boldsymbol{\mathrm{M}}),  \boldsymbol{\mathrm{V}} \otimes \boldsymbol{\mathrm{U}} ) \]</span>
where <span class="math inline">\(\mathrm{vec}()\)</span> is the vector operator, as used above in the <code>mod1.stan</code> file. Given that we are interested in generating random effects with covariance <span class="math inline">\(\boldsymbol{\mathrm{G}} \otimes \boldsymbol{\mathrm{A}}\)</span>, direct computation of the Kronecker product can be avoided by instead sampling the random effects from a matrix normal distribution with the appropriate scaling matrices, i.e. for the for the <em>I</em> x 2 matrix of additive genetic intercepts and slope deviations for <em>I</em> individuals</p>
<p><span class="math display">\[ \begin{bmatrix}
\boldsymbol{\mu_{\mathrm{A}}} &amp;
\boldsymbol{\beta_{\mathrm{A}}} 
\end{bmatrix}
\sim \mathrm{Matrix\ Normal_{I \ x \ 2}}(\boldsymbol{\mathrm{0}}, \boldsymbol{\mathrm{A}}, \boldsymbol{\mathrm{G}}) \]</span></p>
<p>We can use the non-centered parameterization described above for the multivariate normal distribution to also more efficiently sample from this matrix normal distribution. In particular, a matrix <span class="math inline">\(\boldsymbol{\mathrm{Z_{_{I \ x \ 2}}}}\)</span> can be defined for <em>I</em> individual standard normal deviations on each of 2 random effects, which are distributed such that</p>
<p><span class="math display">\[\boldsymbol{\mathrm{Z_{std}}}
\sim \mathrm{Matrix\ Normal_{I \ x \ 2}}(\boldsymbol{\mathrm{0}}, \boldsymbol{\mathrm{I}}, \boldsymbol{\mathrm{I}}) \]</span></p>
<p>The desired matrix of appropriately scaled, zero-centered random effects can then be defined such that</p>
<p><span class="math display">\[\begin{bmatrix}
\boldsymbol{\mu_{\mathrm{A}}} &amp;
\boldsymbol{\beta_{\mathrm{A}}} 
\end{bmatrix}
= \boldsymbol{0}+\boldsymbol{\mathrm{L_A}}
\boldsymbol{\mathrm{Z_{std}}}
\boldsymbol{\mathrm{L_G}}^{\mathrm{T}}\]</span>
where
<span class="math display">\[\begin{bmatrix}
\boldsymbol{\mu_{\mathrm{A}}} &amp;
\boldsymbol{\beta_{\mathrm{A}}} 
\end{bmatrix}
\sim  \mathrm{Matrix\ Normal_{I \ x \ 2}}(\boldsymbol{0},
\boldsymbol{\mathrm{L_A}} \boldsymbol{\mathrm{L_A}}^{\mathrm{T}},
\boldsymbol{\mathrm{L_G}} \boldsymbol{\mathrm{L_G}}^{\mathrm{T}} )\]</span></p>
<p>As explained above, <span class="math inline">\(\boldsymbol{\mathrm{L_A}}\)</span> is the lower triangular Cholesky decomposition of the <span class="math inline">\(\boldsymbol{\mathrm{A}}\)</span> matrix, while <span class="math inline">\(\boldsymbol{\mathrm{L_G}}^{\mathrm{T}}\)</span> is the transpose of the lower triangular Cholesky decomposition of the <span class="math inline">\(\boldsymbol{\mathrm{G}}\)</span> covariance matrix. This sampling property of the matrix normal distribution therefore facilitates sampling from</p>
<p><span class="math display">\[ \mathrm{vec}( 
\begin{bmatrix}
\boldsymbol{\mu_{\mathrm{A}}} &amp;
\boldsymbol{\beta_{\mathrm{A}}} 
\end{bmatrix}
)
\sim \mathrm{MVNormal_{np}}(\mathrm{vec}(\boldsymbol{\mathrm{0}}),  \boldsymbol{\mathrm{G}} \otimes \boldsymbol{\mathrm{A}} )\]</span></p>
<p>through the multiplication of the <span class="math inline">\(\boldsymbol{\mathrm{Z_{std}}}\)</span>, <span class="math inline">\(\boldsymbol{\mathrm{L_A}}\)</span>, and <span class="math inline">\(\boldsymbol{\mathrm{L_G}}^{\mathrm{T}}\)</span> matrices.</p>
<p>This useful sampling property is straightforward to implement in Stan with appropriate data and can be used to account for any form of random effect covariation among individuals, which may extend beyond <span class="math inline">\(\boldsymbol{\mathrm{A}}\)</span> alone. <span class="citation"><a href="#ref-Thomson2018" role="doc-biblioref">Thomson et al.</a> (<a href="#ref-Thomson2018" role="doc-biblioref">2018</a>)</span> provide an extensive review of various additional sources of autocorrelation that should be considered in quantitative genetic analyses.</p>
<p>Note that this matrix normal approach is key to efficient estimation of the SAM as well, as demonstrated in the subsequent tutorials. Here we review the relevant code in Stan to highlight how any Kronecker product could be implemented more generally. The code of <code>mod1.stan</code> can be modified accordingly, so that the basic linear mixed-effects model for phenotypic analysis becomes a linear animal model for quantitative genetic analysis. The relatedness matrix <span class="math inline">\(\boldsymbol{{\mathrm{A}}}\)</span> is now declared in the <code>data</code> block, while the lower triangle Cholesky decomposition matrix <span class="math inline">\(\boldsymbol{\mathrm{L_A}}\)</span> is generated in the <code>transformed data</code> block.</p>
<pre class="stan"><code>data {
  int&lt;lower=0&gt; N; 
  int&lt;lower=0&gt; I; 
  int&lt;lower=0&gt; id[N]; 
  vector[N] x; 
  vector[N] z;
  matrix[I,I] A; //new relatedness matrix
}
transformed data{
  matrix[I,I] LA = cholesky_decompose(A); //lower triangle relatedness matrix 
}</code></pre>
<p>New parameters are also declared for the separate genetic (G) and permanent environmental (E) effects.</p>
<pre class="stan"><code>parameters {
  //fixed effects
  real mu_0;
  real beta_1;
  
  //random effects
  cholesky_factor_corr[2] LGcor; //LC genetic correlation matrix
  cholesky_factor_corr[2] LEcor; //LC permanent environmental correlation matrix
  vector&lt;lower=0&gt;[2] sd_G; //SD of genetic effects
  vector&lt;lower=0&gt;[2] sd_E;  //SD of environmental effects
  real&lt;lower=0&gt; sd_R;
  matrix[I,2] std_G; //matrix of standard normals for G effects
  matrix[I,2] std_E; //matrix of standard normals for E effects
}</code></pre>
<p>The appropriately scaled random deviations can then be specified in the <code>transformed parameters</code> block. The matrix normal parametrization, i.e. <span class="math inline">\(\left[ \boldsymbol{\mu_A}, \boldsymbol{\beta_A}\right] =0+\mathrm{L_A}\mathrm{Z_{std_G}}(\mathrm{G_{sd}}\mathrm{L}_{G_{cor}})^{\mathrm{T}}\)</span> where <span class="math inline">\(\mathrm{G_{sd}}\mathrm{L}_{G_{cor}}=\mathrm{L}_{G_{}}\)</span> is the lower Cholesky covariance matrix, is required for the additive genetic random effects, while the simpler non-centered approach may instead be used for the permanent environmental effects that are independently distributed among individuals. The <code>'</code> function can again be used to return the transpose of the Cholesky decomposed covariance matrices in Stan.</p>
<pre class="stan"><code>transformed parameters {
  matrix[I,2] re_G = LA * std_G * diag_pre_multiply(sd_G,LGcor)&#39; ; //matrix normal
  matrix[I,2] re_E = std_E * diag_pre_multiply(sd_E,LEcor)&#39;; //non-centered
  
  vector[I] mu = col(re_G, 1) + col(re_E, 1); //P = G + E
  vector[I] beta = col(re_G, 2) + col(re_E, 2); //P = G + E
}</code></pre>
<p>With the addition of new priors in the <code>model</code> block</p>
<pre class="stan"><code>  to_vector(std_devG) ~ std_normal(); //standard normal deviates
  to_vector(std_devE) ~ std_normal();
  LGcor ~ lkj_corr_cholesky(2);
  LEcor ~ lkj_corr_cholesky(2);
  to_vector(sd_G) ~ cauchy(0,1);
  to_vector(sd_E) ~ cauchy(0,1);</code></pre>
<p>the model will be well defined and equivalent to the simpler formal model defined with Kronecker products of covariance matrices. Note that the permanent environmental effects are defined as they were for the purely phenotypic effects above, without consideration of the Kronecker product <span class="math inline">\(\boldsymbol{\mathrm{E}}\otimes\boldsymbol{\mathrm{I}}\)</span>. This product indicates that individuals’ trait values are independent and identically distributed, so that ignoring the Kronecker product in Stan with <code>re_E = std_E * diag_pre_multiply(sd_E,LEcor)'</code> is equivalent to specifying the matrix normal parameterization with additional Cholesky identity matrix <span class="math inline">\(\boldsymbol{\mathrm{L_{I}}}\)</span>, i.e. <code>re_E = LI * std_E * diag_pre_multiply(sd_E,LE_cor)'</code>.</p>
</div>
<div id="identifying-genetic-effects" class="section level3" number="1.5.3">
<h3><span class="header-section-number">1.5.3</span> Identifying genetic effects</h3>
<p>This matrix normal approach makes the animal model computationally efficient, but a more fundamental issue remains for identifying the scales of the distinct <span class="math inline">\(\boldsymbol{\mathrm{G}}\)</span> and <span class="math inline">\(\boldsymbol{\mathrm{E}}\)</span> effects during model estimation. Given that <span class="math inline">\(\boldsymbol{\mathrm{P}}=\boldsymbol{\mathrm{G}} + \boldsymbol{\mathrm{E}}\)</span> under the assumption of independent additive effects, it can be difficult to uniquely identify the scale of the distinct genetic and environmental trait values, as any increase/decrease in genetic trait values can be compensated by an equivalent decrease/increase in the environmental trait value to achieve equivalent phenotypic values. In principle, this issue is addressed by the fixed information in <span class="math inline">\(\boldsymbol{\mathrm{A}}\)</span> that is provided to the model prior to estimation. In reality, however, relatedness matrices in the wild are often quite sparse, with most elements at or near 0. As a consequence, when a single individual-level parameter is expressed as the sum of two distinct parameters, as differentiated by the scaling of <span class="math inline">\(\boldsymbol{\mathrm{A}}\)</span> and <span class="math inline">\(\boldsymbol{\mathrm{I}}\)</span>, it can be challenging to identify the proportion of variance attributable to each effect. Note that in the simplest case of completely unrelated individuals, i.e. <span class="math inline">\(\boldsymbol{\mathrm{A}} = \boldsymbol{\mathrm{I}}\)</span>, genetic and environmental effects are completely confounded and cannot be uniquely identified without introducing further assumptions, as any combination of genetic and environmental values summing to the same value will fit the data equally well.</p>
<p>Fortunately, in spite of the empirical reality of sparse relatedness matrices, it is possible to parameterize an animal model in Stan so that even weakly identified genetic effects can be disentangled from environmental effects, using whatever information is provided by the fixed relatedness matrix and empirical data. This is accomplished by re-expressing the scale of the <span class="math inline">\(\boldsymbol{\mathrm{G}}\)</span> and <span class="math inline">\(\boldsymbol{\mathrm{E}}\)</span> effects not as independent parameters, but rather as dependent variances derived from their proportion of a common phenotypic variance parameter. In other words, the model only has to identify the scale of the total phenotypic trait values rather than attempting to identify two independent but potentially confounded random effect variances, i.e.</p>
<p><span class="math display">\[\mathrm{Var}(\boldsymbol{\mu_\mathrm{ }}) = 
\frac { \mathrm{Var}(\boldsymbol{\mu_{\mathrm{A}}}) }{\mathrm{Var}(\boldsymbol{\mu_{\mathrm{P}}})}\mathrm{Var}(\boldsymbol{\mu_\mathrm{ }}) + 
\frac { \mathrm{Var}(\boldsymbol{\mu_{\mathrm{E}}}) }{\mathrm{Var}(\boldsymbol{\mu_{\mathrm{P}}})}\mathrm{Var}(\boldsymbol{\mu_\mathrm{ }})\]</span></p>
<p><span class="math display">\[\mathrm{Var}(\boldsymbol{\beta_\mathrm{ }}) = 
\frac { \mathrm{Var}(\boldsymbol{\beta_{\mathrm{A}}}) }{\mathrm{Var}(\boldsymbol{\beta_{\mathrm{ }}})}\mathrm{Var}(\boldsymbol{\beta_\mathrm{ }}) + 
\frac { \mathrm{Var}(\boldsymbol{\beta_{\mathrm{E}}}) }{\mathrm{Var}(\boldsymbol{\beta_{\mathrm{P}}})}\mathrm{Var}(\boldsymbol{\beta_\mathrm{ }})\]</span>
The additive genetic proportions can be conceptualized as reaction norm heritabilities for the intercept and slope parameters</p>
<p><span class="math display">\[h_{\mu}^{2} =\frac { \mathrm{Var}(\boldsymbol{\mu_{\mathrm{A}}}) }{\mathrm{Var}(\boldsymbol{\mu_{\mathrm{ }}})}\]</span>
<span class="math display">\[h_{\beta}^{2}=\frac { \mathrm{Var}(\boldsymbol{\beta_{\mathrm{A}}}) }{\mathrm{Var}(\boldsymbol{\beta_{\mathrm{ }}})}\]</span></p>
<p>Given that there are only two individual-level random effects, the proportion of variance attributable to environmental effects is necessarily <span class="math inline">\(1-h_{\mu}^{2}\)</span> and <span class="math inline">\(1-h_{\beta}^{2}\)</span> for intercepts and slopes respectively. This alternative parametrization is again mathematically equivalent to the previous model, but it is much easier for Stan to estimate appropriately.</p>
<p>To implement this trick, we respecify the model parameters, removing the distinct genetic and environmental SDs and replacing them with common phenotypic SD scale parameters and reaction norm heritability parameters, which can subsequently be used to scale the distinct genetic and environmental standard normal deviates and correlation matrices in the <code>transformed parameters</code> block. This final model can thus be written as</p>
<div class="sourceCode" id="cb54"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb54-1"><a href="using-stan-in-r.html#cb54-1" aria-hidden="true" tabindex="-1"></a><span class="fu">write</span>(<span class="st">&quot;</span></span>
<span id="cb54-2"><a href="using-stan-in-r.html#cb54-2" aria-hidden="true" tabindex="-1"></a><span class="st">data {</span></span>
<span id="cb54-3"><a href="using-stan-in-r.html#cb54-3" aria-hidden="true" tabindex="-1"></a><span class="st">  int&lt;lower=0&gt; N; </span></span>
<span id="cb54-4"><a href="using-stan-in-r.html#cb54-4" aria-hidden="true" tabindex="-1"></a><span class="st">  int&lt;lower=0&gt; I; </span></span>
<span id="cb54-5"><a href="using-stan-in-r.html#cb54-5" aria-hidden="true" tabindex="-1"></a><span class="st">  int&lt;lower=0&gt; id[N]; </span></span>
<span id="cb54-6"><a href="using-stan-in-r.html#cb54-6" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[N] x; </span></span>
<span id="cb54-7"><a href="using-stan-in-r.html#cb54-7" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[N] z;</span></span>
<span id="cb54-8"><a href="using-stan-in-r.html#cb54-8" aria-hidden="true" tabindex="-1"></a><span class="st">  matrix[I,I] A; //new relatedness matrix</span></span>
<span id="cb54-9"><a href="using-stan-in-r.html#cb54-9" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb54-10"><a href="using-stan-in-r.html#cb54-10" aria-hidden="true" tabindex="-1"></a><span class="st">transformed data{</span></span>
<span id="cb54-11"><a href="using-stan-in-r.html#cb54-11" aria-hidden="true" tabindex="-1"></a><span class="st">  matrix[I,I] LA = cholesky_decompose(A); //lower triangle relatedness matrix </span></span>
<span id="cb54-12"><a href="using-stan-in-r.html#cb54-12" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb54-13"><a href="using-stan-in-r.html#cb54-13" aria-hidden="true" tabindex="-1"></a><span class="st">parameters {</span></span>
<span id="cb54-14"><a href="using-stan-in-r.html#cb54-14" aria-hidden="true" tabindex="-1"></a><span class="st">  //fixed effects</span></span>
<span id="cb54-15"><a href="using-stan-in-r.html#cb54-15" aria-hidden="true" tabindex="-1"></a><span class="st">  real mu_0;</span></span>
<span id="cb54-16"><a href="using-stan-in-r.html#cb54-16" aria-hidden="true" tabindex="-1"></a><span class="st">  real beta_1;</span></span>
<span id="cb54-17"><a href="using-stan-in-r.html#cb54-17" aria-hidden="true" tabindex="-1"></a><span class="st">  </span></span>
<span id="cb54-18"><a href="using-stan-in-r.html#cb54-18" aria-hidden="true" tabindex="-1"></a><span class="st">  //random effects</span></span>
<span id="cb54-19"><a href="using-stan-in-r.html#cb54-19" aria-hidden="true" tabindex="-1"></a><span class="st">  cholesky_factor_corr[2] LGcor; //additive genetic cor matrix</span></span>
<span id="cb54-20"><a href="using-stan-in-r.html#cb54-20" aria-hidden="true" tabindex="-1"></a><span class="st">  cholesky_factor_corr[2] LEcor; //permanent environmental cor matrix</span></span>
<span id="cb54-21"><a href="using-stan-in-r.html#cb54-21" aria-hidden="true" tabindex="-1"></a><span class="st">  vector&lt;lower=0&gt;[2] sd_P; //total phenotypic SD (removed distinct G and E SDs)</span></span>
<span id="cb54-22"><a href="using-stan-in-r.html#cb54-22" aria-hidden="true" tabindex="-1"></a><span class="st">  real&lt;lower=0&gt; sd_R;</span></span>
<span id="cb54-23"><a href="using-stan-in-r.html#cb54-23" aria-hidden="true" tabindex="-1"></a><span class="st">  matrix[I,2] std_G; //matrix of standard normals for G effects</span></span>
<span id="cb54-24"><a href="using-stan-in-r.html#cb54-24" aria-hidden="true" tabindex="-1"></a><span class="st">  matrix[I,2] std_E; //matrix of standard normals for E effects</span></span>
<span id="cb54-25"><a href="using-stan-in-r.html#cb54-25" aria-hidden="true" tabindex="-1"></a><span class="st">  </span></span>
<span id="cb54-26"><a href="using-stan-in-r.html#cb54-26" aria-hidden="true" tabindex="-1"></a><span class="st">  //RN heritability (proportion between 0 and 1)</span></span>
<span id="cb54-27"><a href="using-stan-in-r.html#cb54-27" aria-hidden="true" tabindex="-1"></a><span class="st">  vector&lt;lower=0,upper=1&gt;[2] RN_h2;</span></span>
<span id="cb54-28"><a href="using-stan-in-r.html#cb54-28" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb54-29"><a href="using-stan-in-r.html#cb54-29" aria-hidden="true" tabindex="-1"></a><span class="st">transformed parameters {</span></span>
<span id="cb54-30"><a href="using-stan-in-r.html#cb54-30" aria-hidden="true" tabindex="-1"></a><span class="st">  vector&lt;lower=0&gt;[2] sd_G; //SDs of G effects</span></span>
<span id="cb54-31"><a href="using-stan-in-r.html#cb54-31" aria-hidden="true" tabindex="-1"></a><span class="st">  vector&lt;lower=0&gt;[2] sd_E; //SDs of E effects</span></span>
<span id="cb54-32"><a href="using-stan-in-r.html#cb54-32" aria-hidden="true" tabindex="-1"></a><span class="st">  matrix[I,2] re_G; //scaled G random effects</span></span>
<span id="cb54-33"><a href="using-stan-in-r.html#cb54-33" aria-hidden="true" tabindex="-1"></a><span class="st">  matrix[I,2] re_E;  //scaled E random effects</span></span>
<span id="cb54-34"><a href="using-stan-in-r.html#cb54-34" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[I] mu; //phenotypic individual intercepts</span></span>
<span id="cb54-35"><a href="using-stan-in-r.html#cb54-35" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[I] beta; //phenotypic individual slopes</span></span>
<span id="cb54-36"><a href="using-stan-in-r.html#cb54-36" aria-hidden="true" tabindex="-1"></a><span class="st">  </span></span>
<span id="cb54-37"><a href="using-stan-in-r.html#cb54-37" aria-hidden="true" tabindex="-1"></a><span class="st">  //SDs of genetic effects, sqrt(phenotypic variance * h2)</span></span>
<span id="cb54-38"><a href="using-stan-in-r.html#cb54-38" aria-hidden="true" tabindex="-1"></a><span class="st">  sd_G[1] = sd_P[1] * sqrt(RN_h2[1]); //genetic SD for ind intercepts </span></span>
<span id="cb54-39"><a href="using-stan-in-r.html#cb54-39" aria-hidden="true" tabindex="-1"></a><span class="st">  sd_G[2] = sd_P[2] * sqrt(RN_h2[2]);  //genetic SD for ind slopes</span></span>
<span id="cb54-40"><a href="using-stan-in-r.html#cb54-40" aria-hidden="true" tabindex="-1"></a><span class="st">  </span></span>
<span id="cb54-41"><a href="using-stan-in-r.html#cb54-41" aria-hidden="true" tabindex="-1"></a><span class="st">  //SDs of environmental effects, sqrt(phenotypic variance * [1-h2])</span></span>
<span id="cb54-42"><a href="using-stan-in-r.html#cb54-42" aria-hidden="true" tabindex="-1"></a><span class="st">  sd_E[1] = sd_P[1] * sqrt(1 - RN_h2[1]); //environment SD for ind intercepts </span></span>
<span id="cb54-43"><a href="using-stan-in-r.html#cb54-43" aria-hidden="true" tabindex="-1"></a><span class="st">  sd_E[2] = sd_P[2] * sqrt(1 - RN_h2[2]); //environment SD for ind slopes </span></span>
<span id="cb54-44"><a href="using-stan-in-r.html#cb54-44" aria-hidden="true" tabindex="-1"></a><span class="st">  </span></span>
<span id="cb54-45"><a href="using-stan-in-r.html#cb54-45" aria-hidden="true" tabindex="-1"></a><span class="st">  //matrix normal parameterization</span></span>
<span id="cb54-46"><a href="using-stan-in-r.html#cb54-46" aria-hidden="true" tabindex="-1"></a><span class="st">  re_G =  LA * std_G * diag_pre_multiply(sd_G, LGcor)&#39; ; </span></span>
<span id="cb54-47"><a href="using-stan-in-r.html#cb54-47" aria-hidden="true" tabindex="-1"></a><span class="st">  </span></span>
<span id="cb54-48"><a href="using-stan-in-r.html#cb54-48" aria-hidden="true" tabindex="-1"></a><span class="st">  //non-centered parameterization</span></span>
<span id="cb54-49"><a href="using-stan-in-r.html#cb54-49" aria-hidden="true" tabindex="-1"></a><span class="st">  re_E = std_E * diag_pre_multiply(sd_E, LEcor)&#39; ;</span></span>
<span id="cb54-50"><a href="using-stan-in-r.html#cb54-50" aria-hidden="true" tabindex="-1"></a><span class="st">  </span></span>
<span id="cb54-51"><a href="using-stan-in-r.html#cb54-51" aria-hidden="true" tabindex="-1"></a><span class="st">  //separate intercepts and slopes</span></span>
<span id="cb54-52"><a href="using-stan-in-r.html#cb54-52" aria-hidden="true" tabindex="-1"></a><span class="st">  mu = col(re_G, 1) + col(re_E, 1); //P = G + E</span></span>
<span id="cb54-53"><a href="using-stan-in-r.html#cb54-53" aria-hidden="true" tabindex="-1"></a><span class="st">  beta = col(re_G, 2) + col(re_E, 2); //P = G + E</span></span>
<span id="cb54-54"><a href="using-stan-in-r.html#cb54-54" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb54-55"><a href="using-stan-in-r.html#cb54-55" aria-hidden="true" tabindex="-1"></a><span class="st">model {</span></span>
<span id="cb54-56"><a href="using-stan-in-r.html#cb54-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-57"><a href="using-stan-in-r.html#cb54-57" aria-hidden="true" tabindex="-1"></a><span class="st">  //model likelihood</span></span>
<span id="cb54-58"><a href="using-stan-in-r.html#cb54-58" aria-hidden="true" tabindex="-1"></a><span class="st">  z ~ normal(mu_0 + mu[id] + (beta_1 + beta[id]).*x, sd_R);</span></span>
<span id="cb54-59"><a href="using-stan-in-r.html#cb54-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-60"><a href="using-stan-in-r.html#cb54-60" aria-hidden="true" tabindex="-1"></a><span class="st">  //priors</span></span>
<span id="cb54-61"><a href="using-stan-in-r.html#cb54-61" aria-hidden="true" tabindex="-1"></a><span class="st">  </span></span>
<span id="cb54-62"><a href="using-stan-in-r.html#cb54-62" aria-hidden="true" tabindex="-1"></a><span class="st">  //fixed effects</span></span>
<span id="cb54-63"><a href="using-stan-in-r.html#cb54-63" aria-hidden="true" tabindex="-1"></a><span class="st">  mu_0 ~ normal(0,1);</span></span>
<span id="cb54-64"><a href="using-stan-in-r.html#cb54-64" aria-hidden="true" tabindex="-1"></a><span class="st">  beta_1 ~ normal(0,1);</span></span>
<span id="cb54-65"><a href="using-stan-in-r.html#cb54-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-66"><a href="using-stan-in-r.html#cb54-66" aria-hidden="true" tabindex="-1"></a><span class="st">  //random effects</span></span>
<span id="cb54-67"><a href="using-stan-in-r.html#cb54-67" aria-hidden="true" tabindex="-1"></a><span class="st">  to_vector(std_G) ~ std_normal(); //genetic std normal deviates</span></span>
<span id="cb54-68"><a href="using-stan-in-r.html#cb54-68" aria-hidden="true" tabindex="-1"></a><span class="st">  to_vector(std_E) ~ std_normal(); //environmental std normal deviates</span></span>
<span id="cb54-69"><a href="using-stan-in-r.html#cb54-69" aria-hidden="true" tabindex="-1"></a><span class="st">  LGcor ~ lkj_corr_cholesky(2); //genetic correlations</span></span>
<span id="cb54-70"><a href="using-stan-in-r.html#cb54-70" aria-hidden="true" tabindex="-1"></a><span class="st">  LEcor ~ lkj_corr_cholesky(2); //environmental correlations</span></span>
<span id="cb54-71"><a href="using-stan-in-r.html#cb54-71" aria-hidden="true" tabindex="-1"></a><span class="st">  </span></span>
<span id="cb54-72"><a href="using-stan-in-r.html#cb54-72" aria-hidden="true" tabindex="-1"></a><span class="st">  to_vector(sd_P) ~ cauchy(0,1); //only phenotypic scale</span></span>
<span id="cb54-73"><a href="using-stan-in-r.html#cb54-73" aria-hidden="true" tabindex="-1"></a><span class="st">  sd_R ~ cauchy(0,1);</span></span>
<span id="cb54-74"><a href="using-stan-in-r.html#cb54-74" aria-hidden="true" tabindex="-1"></a><span class="st">  </span></span>
<span id="cb54-75"><a href="using-stan-in-r.html#cb54-75" aria-hidden="true" tabindex="-1"></a><span class="st">  //reaction norm heritability</span></span>
<span id="cb54-76"><a href="using-stan-in-r.html#cb54-76" aria-hidden="true" tabindex="-1"></a><span class="st">  to_vector(RN_h2) ~  beta(1.2,1.2);</span></span>
<span id="cb54-77"><a href="using-stan-in-r.html#cb54-77" aria-hidden="true" tabindex="-1"></a><span class="st">  </span></span>
<span id="cb54-78"><a href="using-stan-in-r.html#cb54-78" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb54-79"><a href="using-stan-in-r.html#cb54-79" aria-hidden="true" tabindex="-1"></a><span class="st">generated quantities {</span></span>
<span id="cb54-80"><a href="using-stan-in-r.html#cb54-80" aria-hidden="true" tabindex="-1"></a><span class="st">corr_matrix[2] Gcor = LGcor * LGcor&#39;; //genetic cor</span></span>
<span id="cb54-81"><a href="using-stan-in-r.html#cb54-81" aria-hidden="true" tabindex="-1"></a><span class="st">corr_matrix[2] Ecor = LEcor * LEcor&#39;; //environmental cor</span></span>
<span id="cb54-82"><a href="using-stan-in-r.html#cb54-82" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-83"><a href="using-stan-in-r.html#cb54-83" aria-hidden="true" tabindex="-1"></a><span class="st">matrix[2,2] Gcov = diag_matrix(sd_G)*Gcor*diag_matrix(sd_G); //genetic cov</span></span>
<span id="cb54-84"><a href="using-stan-in-r.html#cb54-84" aria-hidden="true" tabindex="-1"></a><span class="st">matrix[2,2] Ecov = diag_matrix(sd_E)*Ecor*diag_matrix(sd_E); //environmental cov</span></span>
<span id="cb54-85"><a href="using-stan-in-r.html#cb54-85" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-86"><a href="using-stan-in-r.html#cb54-86" aria-hidden="true" tabindex="-1"></a><span class="st">matrix[2,2] Pcov = Gcov + Ecov; //phenotypic covariance (assuming independent effects)</span></span>
<span id="cb54-87"><a href="using-stan-in-r.html#cb54-87" aria-hidden="true" tabindex="-1"></a><span class="st">matrix[2,2] Pcor = inverse(diag_matrix(sd_P))*Pcov*inverse(diag_matrix(sd_P)); //phenotypic cor</span></span>
<span id="cb54-88"><a href="using-stan-in-r.html#cb54-88" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-89"><a href="using-stan-in-r.html#cb54-89" aria-hidden="true" tabindex="-1"></a><span class="st">//variances</span></span>
<span id="cb54-90"><a href="using-stan-in-r.html#cb54-90" aria-hidden="true" tabindex="-1"></a><span class="st">vector&lt;lower=0&gt;[2] V_P = sd_P .* sd_P;</span></span>
<span id="cb54-91"><a href="using-stan-in-r.html#cb54-91" aria-hidden="true" tabindex="-1"></a><span class="st">vector&lt;lower=0&gt;[2] V_G = sd_G .* sd_G;</span></span>
<span id="cb54-92"><a href="using-stan-in-r.html#cb54-92" aria-hidden="true" tabindex="-1"></a><span class="st">vector&lt;lower=0&gt;[2] V_E = sd_E .* sd_E;</span></span>
<span id="cb54-93"><a href="using-stan-in-r.html#cb54-93" aria-hidden="true" tabindex="-1"></a><span class="st">real V_R = sd_R * sd_R;</span></span>
<span id="cb54-94"><a href="using-stan-in-r.html#cb54-94" aria-hidden="true" tabindex="-1"></a><span class="st">}&quot;</span>, <span class="st">&quot;mod1_QG.stan&quot;</span>)</span></code></pre></div>
<p>Note that because we specify phenotypic SDs <code>sd_P</code>, the genetic SDs <code>sd_G</code> are calculated as <span class="math inline">\(\mathrm{sqrt} ({\mathrm{Var}(\boldsymbol{\mu_{\mathrm{}}})}h_{\mu}^{2})= {\mathrm{SD}(\boldsymbol{\mu_{\mathrm{}}})}\mathrm{sqrt}(h_{\mu}^{2})\)</span> and <span class="math inline">\(\mathrm{sqrt} ({\mathrm{Var}(\boldsymbol{\beta_{\mathrm{}}})}h_{\beta}^{2})= {\mathrm{SD}(\boldsymbol{\beta_{\mathrm{}}})}\mathrm{sqrt}(h_{\beta}^{2})\)</span>, with the same approach taken for the proportion of environmental effects <span class="math inline">\(1- h_{\mu}^{2}\)</span> and <span class="math inline">\(1-h_{\beta}^{2}\)</span>. A weakly regularizing <span class="math inline">\(\mathrm{Beta}(1.2,1.2)\)</span> prior is placed on the reaction norm heritability parameters, which are constrained between 0 and 1. This and any other prior can be easily visualized in R by randomly sampling from the relevant distribution.</p>
<div class="sourceCode" id="cb55"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb55-1"><a href="using-stan-in-r.html#cb55-1" aria-hidden="true" tabindex="-1"></a><span class="fu">hist</span>( <span class="fu">rbeta</span>(<span class="fl">1e5</span>, <span class="fl">1.2</span>, <span class="fl">1.2</span>), <span class="at">prob =</span> <span class="cn">TRUE</span> )</span></code></pre></div>
<p><img src="SAMs_files/figure-html/unnamed-chunk-25-1.png" width="672" /></p>
<p>This prior is therefore relatively flat and uninformative over the range of plausible values, but provides very weak regularization by giving lower relative probability at the extreme ends approaching 0 (no genetic effect) and 1 (complete genetic effect). With more than two individual-level random effects, such as when specifying multiple matrices of individual autocorrelation <span class="citation">(<a href="#ref-Thomson2018" role="doc-biblioref">Thomson et al. 2018</a>)</span>, SDs and variances can instead be parameterized as scaled <a href="https://mc-stan.org/docs/2_19/reference-manual/vector-and-matrix-data-types.html">simplexes</a>.</p>
<p>We can now estimate our animal model in Stan.</p>
<div class="sourceCode" id="cb56"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb56-1"><a href="using-stan-in-r.html#cb56-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(rstan)</span>
<span id="cb56-2"><a href="using-stan-in-r.html#cb56-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-3"><a href="using-stan-in-r.html#cb56-3" aria-hidden="true" tabindex="-1"></a>mod1_QG <span class="ot">=</span> <span class="fu">stan_model</span>(<span class="st">&quot;mod1_QG.stan&quot;</span>)</span></code></pre></div>
<pre><code>## Warning in system(paste(CXX, ARGS), ignore.stdout = TRUE, ignore.stderr = TRUE): &#39;C:/rtools40/usr/mingw_/bin/g++&#39; not found</code></pre>
<div class="sourceCode" id="cb58"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb58-1"><a href="using-stan-in-r.html#cb58-1" aria-hidden="true" tabindex="-1"></a>stan_resultsQG <span class="ot">&lt;-</span> <span class="fu">sampling</span>(mod1_QG, <span class="at">data=</span>stan_data, <span class="at">init =</span> <span class="dv">0</span>, <span class="at">warmup=</span><span class="dv">1500</span>, <span class="at">iter =</span> <span class="dv">4500</span>,</span>
<span id="cb58-2"><a href="using-stan-in-r.html#cb58-2" aria-hidden="true" tabindex="-1"></a>                         <span class="at">chains=</span><span class="dv">4</span>, <span class="at">cores=</span><span class="dv">4</span>, <span class="at">control=</span><span class="fu">list</span>(<span class="at">adapt_delta=</span><span class="fl">0.90</span>) )</span>
<span id="cb58-3"><a href="using-stan-in-r.html#cb58-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-4"><a href="using-stan-in-r.html#cb58-4" aria-hidden="true" tabindex="-1"></a><span class="co">#extracts posterior estimates</span></span>
<span id="cb58-5"><a href="using-stan-in-r.html#cb58-5" aria-hidden="true" tabindex="-1"></a>post <span class="ot">=</span>  <span class="fu">extract</span>(stan_resultsQG)</span></code></pre></div>
<p>Let’s see how well we recovered the genetic and environmental (co)variances of the reaction norm parameters. Due to random sampling and our relatively small sample size, we should anticipate noisy estimates.</p>
<div class="sourceCode" id="cb59"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb59-1"><a href="using-stan-in-r.html#cb59-1" aria-hidden="true" tabindex="-1"></a><span class="co">#RN intercepts [1] and slopes [2]</span></span>
<span id="cb59-2"><a href="using-stan-in-r.html#cb59-2" aria-hidden="true" tabindex="-1"></a><span class="fu">apply</span>(post<span class="sc">$</span>V_P, <span class="dv">2</span>, median) <span class="co">#phenotypic variance</span></span></code></pre></div>
<pre><code>## [1] 0.4357406 0.7259852</code></pre>
<div class="sourceCode" id="cb61"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb61-1"><a href="using-stan-in-r.html#cb61-1" aria-hidden="true" tabindex="-1"></a><span class="fu">apply</span>(post<span class="sc">$</span>V_G, <span class="dv">2</span>, median) <span class="co">#genetic variance</span></span></code></pre></div>
<pre><code>## [1] 0.1994040 0.4870258</code></pre>
<div class="sourceCode" id="cb63"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb63-1"><a href="using-stan-in-r.html#cb63-1" aria-hidden="true" tabindex="-1"></a><span class="fu">apply</span>(post<span class="sc">$</span>V_E, <span class="dv">2</span>, median) <span class="co">#environmental variance</span></span></code></pre></div>
<pre><code>## [1] 0.2271417 0.2231888</code></pre>
<div class="sourceCode" id="cb65"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb65-1"><a href="using-stan-in-r.html#cb65-1" aria-hidden="true" tabindex="-1"></a><span class="co">#RN intercept and slope correlation</span></span>
<span id="cb65-2"><a href="using-stan-in-r.html#cb65-2" aria-hidden="true" tabindex="-1"></a><span class="fu">median</span>(post<span class="sc">$</span>Pcor[,<span class="dv">1</span>,<span class="dv">2</span>]) <span class="co">#phenotypic corr</span></span></code></pre></div>
<pre><code>## [1] -0.06201797</code></pre>
<div class="sourceCode" id="cb67"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb67-1"><a href="using-stan-in-r.html#cb67-1" aria-hidden="true" tabindex="-1"></a><span class="fu">median</span>(post<span class="sc">$</span>Gcor[,<span class="dv">1</span>,<span class="dv">2</span>]) <span class="co">#genetic corr</span></span></code></pre></div>
<pre><code>## [1] -0.1716683</code></pre>
<div class="sourceCode" id="cb69"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb69-1"><a href="using-stan-in-r.html#cb69-1" aria-hidden="true" tabindex="-1"></a><span class="fu">median</span>(post<span class="sc">$</span>Ecor[,<span class="dv">1</span>,<span class="dv">2</span>]) <span class="co">#environmental corr</span></span></code></pre></div>
<pre><code>## [1] 0.08256261</code></pre>

</div>
</div>
</div>
<h3>Resources</h3>
<div id="refs" class="references csl-bib-body hanging-indent">
<div id="ref-ASREML" class="csl-entry">
Butler, D. G., B. R. Cullis, A. R. Gilmour, B. J. Gogel, and R. Thompson. 2018. <em>ASReml-r Reference Manual</em> (version 4). Hemel Hempstead, UK: VSN International Ltd. <a href="https://asreml.kb.vsni.co.uk/wp-content/uploads/sites/3/2018/02/ASReml-R-Reference-Manual-4.pdf">https://asreml.kb.vsni.co.uk/wp-content/uploads/sites/3/2018/02/ASReml-R-Reference-Manual-4.pdf</a>.
</div>
<div id="ref-Stan" class="csl-entry">
Carpenter, B., A. Gelman, M. D. Hoffman, D. Lee, B. Goodrich, M. Betancourt, and... A. Riddell. 2017. <span>“Stan: A Probabilistic Programming Language.”</span> <em>Journal of Statistical Software</em> 74. <a href="https://www.jstatsoft.org/article/view/v076i01">https://www.jstatsoft.org/article/view/v076i01</a>.
</div>
<div id="ref-Gelman2020" class="csl-entry">
Gelman, A., A. Vehtari, D. Simpson, C. C. Margossian, B. Carpenter, Y. Yao, and... M. Modrák. 2020. <span>“Bayesian Workflow.”</span> <em>arXiv Preprint</em> arXiv:2011.01808. <a href="https://arxiv.org/abs/2011.01808">https://arxiv.org/abs/2011.01808</a>.
</div>
<div id="ref-Gupta2018" class="csl-entry">
Gupta, A. K., and D. K. Nagar. 2018. <em>Matrix Variate Distributions</em>. CRC Press. <a href="https://www.routledge.com/Matrix-Variate-Distributions/Gupta-Nagar/p/book/9781584880462">https://www.routledge.com/Matrix-Variate-Distributions/Gupta-Nagar/p/book/9781584880462</a>.
</div>
<div id="ref-MCMCglmm" class="csl-entry">
Hadfield, J. D. 2010. <span>“MCMC Methods for Multi-Response Generalized Linear Mixed Models: The MCMCglmm r Package.”</span> <em>Journal of Statistical Software</em> 33. <a href="https://mran.microsoft.com/snapshot/2016-10-12/web/packages/MCMCglmm/vignettes/Overview.pdf">https://mran.microsoft.com/snapshot/2016-10-12/web/packages/MCMCglmm/vignettes/Overview.pdf</a>.
</div>
<div id="ref-Lemoine2019" class="csl-entry">
Lemoine, N. P. 2019. <span>“Moving Beyond Noninformative Priors: Why and How to Choose Weakly Informative Priors in Bayesian Analyses.”</span> <em>Oikos</em> 128. <a href="https://onlinelibrary.wiley.com/doi/full/10.1111/oik.05985">https://onlinelibrary.wiley.com/doi/full/10.1111/oik.05985</a>.
</div>
<div id="ref-SAM" class="csl-entry">
Martin, J. S., and A. V. Jaeggi. 2021. <span>“Social Animal Models for Quantifying Plasticity, Assortment, and Selection on Interacting Phenotypes.”</span> <em>Journal of Evolutionary Biology</em>. <a href="https://doi.org/10.1111/jeb.13900">https://doi.org/10.1111/jeb.13900</a>.
</div>
<div id="ref-Rethinking" class="csl-entry">
McElreath, R. 2020. <em>Statistical Rethinking: A Bayesian Course with Examples in r and Stan</em>. 2nd ed. CRC Press. <a href="https://xcelab.net/rm/statistical-rethinking/">https://xcelab.net/rm/statistical-rethinking/</a>.
</div>
<div id="ref-MCMCperf" class="csl-entry">
Nishio, M., and A. Arakawa. 2019. <span>“Performance of Hamiltonian Monte Carlo and No-u-Turn Sampler for Estimating Genetic Parameters and Breeding Values.”</span> <em>Genetics Selection Evolution</em> 51. <a href="https://gsejournal.biomedcentral.com/articles/10.1186/s12711-019-0515-1">https://gsejournal.biomedcentral.com/articles/10.1186/s12711-019-0515-1</a>.
</div>
<div id="ref-Rbase" class="csl-entry">
R Core Team. 2020. <em>R: A Language and Environment for Statistical Computing</em>. Vienna, Austria: R Foundation for Statistical Computing. <a href="https://www.R-project.org">https://www.R-project.org</a>.
</div>
<div id="ref-Stinchcombe2014" class="csl-entry">
Stinchcombe, J. R., A. K. Simonsen, and M. W. Blows. 2014. <span>“Estimating Uncertainty in Multivariate Responses to Selection.”</span> <em>Evolution</em> 68. <a href="https://onlinelibrary.wiley.com/doi/full/10.1111/evo.12321">https://onlinelibrary.wiley.com/doi/full/10.1111/evo.12321</a>.
</div>
<div id="ref-Thomson2018" class="csl-entry">
Thomson, C. E., I. S. Winney, O. C. Salles, and B. Pujol. 2018. <span>“A Guide to Using a Multiple-Matrix Animal Model to Disentangle Genetic and Nongenetic Causes of Phenotypic Variance.”</span> <em>PloS One</em> 13. <a href="https://journals.plos.org/plosone/article/comments?id=10.1371/journal.pone.0197720">https://journals.plos.org/plosone/article/comments?id=10.1371/journal.pone.0197720</a>.
</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="introduction.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="within-partner-sam.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"whatsapp": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": null,
"text": null
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": null,
"toc": {
"collapse": "subsection"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
