<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>4 Within-and-between partner SAM | Estimating Social Animal Models in Stan</title>
  <meta name="description" content="4 Within-and-between partner SAM | Estimating Social Animal Models in Stan" />
  <meta name="generator" content="bookdown 0.22 and GitBook 2.6.7" />

  <meta property="og:title" content="4 Within-and-between partner SAM | Estimating Social Animal Models in Stan" />
  <meta property="og:type" content="book" />
  
  
  
  

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="4 Within-and-between partner SAM | Estimating Social Animal Models in Stan" />
  
  
  

<meta name="author" content="Jordan S. Martin &amp; Adrian V. Jaeggi" />


<meta name="date" content="2021-07-15" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="between-partner-sam.html"/>
<link rel="next" href="fitness-model.html"/>
<script src="libs/header-attrs-2.8/header-attrs.js"></script>
<script src="libs/jquery-2.2.3/jquery.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />









<link href="libs/anchor-sections-1.0.1/anchor-sections.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.0.1/anchor-sections.js"></script>


<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<style type="text/css">
/* Used with Pandoc 2.11+ new --citeproc when CSL is used */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
}
.hanging div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}
</style>

<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li class="chapter" data-level="" data-path="introduction.html"><a href="introduction.html"><i class="fa fa-check"></i>Introduction</a></li>
<li class="chapter" data-level="1" data-path="using-stan-in-r.html"><a href="using-stan-in-r.html"><i class="fa fa-check"></i><b>1</b> Using Stan in R</a>
<ul>
<li class="chapter" data-level="1.1" data-path="using-stan-in-r.html"><a href="using-stan-in-r.html#why-stan"><i class="fa fa-check"></i><b>1.1</b> Why Stan?</a></li>
<li class="chapter" data-level="1.2" data-path="using-stan-in-r.html"><a href="using-stan-in-r.html#getting-started"><i class="fa fa-check"></i><b>1.2</b> Getting Started</a></li>
<li class="chapter" data-level="1.3" data-path="using-stan-in-r.html"><a href="using-stan-in-r.html#bayesian-inference"><i class="fa fa-check"></i><b>1.3</b> Bayesian inference</a></li>
<li class="chapter" data-level="1.4" data-path="using-stan-in-r.html"><a href="using-stan-in-r.html#basic-coding-tutorial"><i class="fa fa-check"></i><b>1.4</b> Basic coding tutorial</a>
<ul>
<li class="chapter" data-level="1.4.1" data-path="using-stan-in-r.html"><a href="using-stan-in-r.html#cholesky-decompositions"><i class="fa fa-check"></i><b>1.4.1</b> Cholesky decompositions</a></li>
<li class="chapter" data-level="1.4.2" data-path="using-stan-in-r.html"><a href="using-stan-in-r.html#non-centered-random-effects"><i class="fa fa-check"></i><b>1.4.2</b> Non-centered random effects</a></li>
</ul></li>
<li class="chapter" data-level="1.5" data-path="using-stan-in-r.html"><a href="using-stan-in-r.html#animal-models"><i class="fa fa-check"></i><b>1.5</b> Animal models</a>
<ul>
<li class="chapter" data-level="1.5.1" data-path="using-stan-in-r.html"><a href="using-stan-in-r.html#simulate-data"><i class="fa fa-check"></i><b>1.5.1</b> Simulate data</a></li>
<li class="chapter" data-level="1.5.2" data-path="using-stan-in-r.html"><a href="using-stan-in-r.html#kronecker-products"><i class="fa fa-check"></i><b>1.5.2</b> Kronecker products</a></li>
<li class="chapter" data-level="1.5.3" data-path="using-stan-in-r.html"><a href="using-stan-in-r.html#identifying-genetic-effects"><i class="fa fa-check"></i><b>1.5.3</b> Identifying genetic effects</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="2" data-path="within-partner-sam.html"><a href="within-partner-sam.html"><i class="fa fa-check"></i><b>2</b> Within partner SAM</a>
<ul>
<li class="chapter" data-level="2.1" data-path="within-partner-sam.html"><a href="within-partner-sam.html#formal-overview"><i class="fa fa-check"></i><b>2.1</b> Formal overview</a></li>
<li class="chapter" data-level="2.2" data-path="within-partner-sam.html"><a href="within-partner-sam.html#computational-approach"><i class="fa fa-check"></i><b>2.2</b> Computational approach</a></li>
<li class="chapter" data-level="2.3" data-path="within-partner-sam.html"><a href="within-partner-sam.html#simulate-data-1"><i class="fa fa-check"></i><b>2.3</b> Simulate data</a>
<ul>
<li class="chapter" data-level="2.3.1" data-path="within-partner-sam.html"><a href="within-partner-sam.html#srn-parameters"><i class="fa fa-check"></i><b>2.3.1</b> SRN parameters</a></li>
<li class="chapter" data-level="2.3.2" data-path="within-partner-sam.html"><a href="within-partner-sam.html#assortment"><i class="fa fa-check"></i><b>2.3.2</b> Assortment</a></li>
<li class="chapter" data-level="2.3.3" data-path="within-partner-sam.html"><a href="within-partner-sam.html#repeated-measurements-within-the-partner"><i class="fa fa-check"></i><b>2.3.3</b> Repeated measurements within the partner</a></li>
</ul></li>
<li class="chapter" data-level="2.4" data-path="within-partner-sam.html"><a href="within-partner-sam.html#coding-the-model"><i class="fa fa-check"></i><b>2.4</b> Coding the model</a></li>
<li class="chapter" data-level="2.5" data-path="within-partner-sam.html"><a href="within-partner-sam.html#estimating-the-model"><i class="fa fa-check"></i><b>2.5</b> Estimating the model</a></li>
<li class="chapter" data-level="2.6" data-path="within-partner-sam.html"><a href="within-partner-sam.html#failure-to-detect-assortment"><i class="fa fa-check"></i><b>2.6</b> Failure to detect assortment</a></li>
<li class="chapter" data-level="2.7" data-path="within-partner-sam.html"><a href="within-partner-sam.html#phenotypic-model"><i class="fa fa-check"></i><b>2.7</b> Phenotypic model</a></li>
</ul></li>
<li class="chapter" data-level="3" data-path="between-partner-sam.html"><a href="between-partner-sam.html"><i class="fa fa-check"></i><b>3</b> Between partner SAM</a>
<ul>
<li class="chapter" data-level="3.1" data-path="between-partner-sam.html"><a href="between-partner-sam.html#simulate-data-2"><i class="fa fa-check"></i><b>3.1</b> Simulate data</a></li>
<li class="chapter" data-level="3.2" data-path="between-partner-sam.html"><a href="between-partner-sam.html#estimate-the-model"><i class="fa fa-check"></i><b>3.2</b> Estimate the model</a></li>
<li class="chapter" data-level="3.3" data-path="between-partner-sam.html"><a href="between-partner-sam.html#estimating-assortment"><i class="fa fa-check"></i><b>3.3</b> Estimating assortment</a></li>
<li class="chapter" data-level="3.4" data-path="between-partner-sam.html"><a href="between-partner-sam.html#phenotypic-model-1"><i class="fa fa-check"></i><b>3.4</b> Phenotypic model</a></li>
</ul></li>
<li class="chapter" data-level="4" data-path="within-and-between-partner-sam.html"><a href="within-and-between-partner-sam.html"><i class="fa fa-check"></i><b>4</b> Within-and-between partner SAM</a>
<ul>
<li class="chapter" data-level="4.1" data-path="within-and-between-partner-sam.html"><a href="within-and-between-partner-sam.html#simulate-data-3"><i class="fa fa-check"></i><b>4.1</b> Simulate data</a></li>
<li class="chapter" data-level="4.2" data-path="within-and-between-partner-sam.html"><a href="within-and-between-partner-sam.html#estimate-the-model-1"><i class="fa fa-check"></i><b>4.2</b> Estimate the model</a></li>
<li class="chapter" data-level="4.3" data-path="within-and-between-partner-sam.html"><a href="within-and-between-partner-sam.html#estimating-assortment-1"><i class="fa fa-check"></i><b>4.3</b> Estimating assortment</a></li>
<li class="chapter" data-level="4.4" data-path="within-and-between-partner-sam.html"><a href="within-and-between-partner-sam.html#phenotypic-model-2"><i class="fa fa-check"></i><b>4.4</b> Phenotypic model</a></li>
</ul></li>
<li class="chapter" data-level="5" data-path="fitness-model.html"><a href="fitness-model.html"><i class="fa fa-check"></i><b>5</b> Fitness model</a>
<ul>
<li class="chapter" data-level="5.1" data-path="fitness-model.html"><a href="fitness-model.html#simulate-data-4"><i class="fa fa-check"></i><b>5.1</b> Simulate data</a></li>
<li class="chapter" data-level="5.2" data-path="fitness-model.html"><a href="fitness-model.html#estimating-the-model-1"><i class="fa fa-check"></i><b>5.2</b> Estimating the model</a></li>
<li class="chapter" data-level="5.3" data-path="fitness-model.html"><a href="fitness-model.html#estimating-assortment-2"><i class="fa fa-check"></i><b>5.3</b> Estimating assortment</a></li>
<li class="chapter" data-level="5.4" data-path="fitness-model.html"><a href="fitness-model.html#estimating-selection-differentials-and-genetic-responses"><i class="fa fa-check"></i><b>5.4</b> Estimating selection differentials and genetic responses</a></li>
</ul></li>
<li class="chapter" data-level="6" data-path="extending-sams.html"><a href="extending-sams.html"><i class="fa fa-check"></i><b>6</b> Extending SAMs</a></li>
<li class="chapter" data-level="" data-path="resources.html"><a href="resources.html"><i class="fa fa-check"></i>Resources</a></li>
</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Estimating Social Animal Models in Stan</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="within-and-between-partner-sam" class="section level1" number="4">
<h1><span class="header-section-number">4</span> Within-and-between partner SAM</h1>
<p>As discussed and demonstrated in the previous chapters (<a href="within-partner-sam.html#within-partner-sam">2</a> &amp; <a href="between-partner-sam.html#between-partner-sam">3</a>), within partner variation allows for modelling the temporal dynamics of social interactions, including intrinsic and residual trait feedback, while between partner variation can be used to partition the effects of assortment and social plasticity. Study designs providing both within and between partner measurements will, therefore, tend to be optimally informative about phenotypic interactions and their evolutionary consequences.</p>
<p>The formal model for a between-and-within partner SAM combines the basic latent ARMA feedback process of the within partner SAM (Ch <a href="within-partner-sam.html#within-partner-sam">2</a>) with the within-individual centering used to remove bias from the SRN slopes of the between partner SAM (Ch <a href="between-partner-sam.html#between-partner-sam">3</a>). The model for a measurement <span class="math inline">\(i\)</span> of aggression <span class="math inline">\(z_{ijt}\)</span> in focal individual <span class="math inline">\(j\)</span> during a single interaction period <span class="math inline">\(t\)</span> is given by</p>
<p><span class="math display">\[z_{ijt} = \mu_0 + \eta_{Wijt} + \beta_{B}\eta_{Bijt} + \xi_{ijt}\]</span></p>
<p>where <span class="math inline">\(\eta_{Wijt}\)</span> is the within-individual centered plastic response to the social partner SRN trait value</p>
<p><span class="math display">\[\eta_{Wijt} = \begin{Bmatrix}
\mu_j + \left( \psi_1 + \psi_j \right) \left( \mu_k&#39; - \bar{\mu}&#39;_K \right) &amp; \mathrm{if} \ t = 1 \\ 
\mu_j + \left( \psi_1 + \psi_j \right) \left( \eta_{ikt-1}&#39; - \bar{\eta}&#39;_{iKt-1} \right) &amp; \mathrm{else}
\end{Bmatrix} \]</span></p>
<p>with <span class="math inline">\(\beta_{B}\eta_{Bijt}\)</span> reflecting the association with the average partner SRN trait value</p>
<p><span class="math display">\[\eta_{Bijt} = \begin{Bmatrix}
\left( \psi_1 + \psi_j \right) \bar{\mu}&#39;_K &amp; \mathrm{if} \ t = 1 \\ 
\left( \psi_1 + \psi_j \right) \bar{\eta}&#39;_{iKt-1} &amp; \mathrm{else}
\end{Bmatrix} \]</span></p>
<p>scaled by the between partner regression coefficient <span class="math inline">\(\beta_{B}\)</span>. In addition, <span class="math inline">\(\xi_{ijt}\)</span> captures SRN measurement error caused by residual feedback over time</p>
<p><span class="math display">\[\xi_{ijt} = \begin{Bmatrix}
\epsilon_{ijt} &amp; \mathrm{if} \ t = 1 \\ 
\epsilon_{ijt} + \phi\epsilon_{ikt-1}&#39; &amp; \mathrm{else}
\end{Bmatrix} \]</span></p>
<p>Similarly, for the social partner</p>
<p><span class="math display">\[z_{ikt}&#39; = \mu_0 + \eta_{Wikt}&#39; + \beta_B\eta_{Bikt}&#39; + \xi_{ikt}&#39;\]</span>
<span class="math display">\[\eta_{Wikt}&#39; = \begin{Bmatrix}
\mu_k&#39; + \left( \psi_1 + \psi_k&#39; \right)\left( \mu_j - \bar{\mu}_J \right) &amp; \mathrm{if} \ t = 1 \\ 
\mu_k&#39; + \left( \psi_1 + \psi_k&#39; \right)\left( \eta_{ijt} - \bar{\eta}_{iJt} \right) &amp; \mathrm{else}
\end{Bmatrix} \]</span></p>
<p><span class="math display">\[\eta_{Bikt}&#39; = \begin{Bmatrix}
\left( \psi_1 + \psi_k&#39; \right) \bar{\mu}_J &amp; \mathrm{if} \ t = 1 \\ 
\left( \psi_1 + \psi_k&#39; \right) \bar{\eta}_{iJt} &amp; \mathrm{else}
\end{Bmatrix} \]</span></p>
<p><span class="math display">\[\xi_{ikt}&#39; = \begin{Bmatrix}
\epsilon_{ikt}&#39; &amp; \mathrm{if} \ t = 1 \\ 
\epsilon_{ikt}&#39; + \phi\epsilon_{ijt-1} &amp; \mathrm{else}
\end{Bmatrix} \]</span></p>
<p>The random effects are assumed to be well-described by multivariate normal distributions.
<span class="math display">\[\mu_j = \mu_{\mathrm{A}j} + \mu_{\mathrm{E}j}, \quad  \psi_j = \psi_{\mathrm{A}j} + \psi_{\mathrm{E}j}\]</span>
<span class="math display">\[\mu_k&#39; = \mu_{\mathrm{A}k}&#39; + \mu_{\mathrm{E}j}&#39;, \quad  \psi_k&#39; = \psi_{\mathrm{A}k}&#39; + \psi_{\mathrm{E}k}&#39;\]</span></p>
<p><span class="math display">\[\begin{bmatrix} \boldsymbol{\mu_{\mathrm{A}}}, \boldsymbol{\mu&#39;_{\mathrm{A}}},\boldsymbol{\psi_{\mathrm{A}}},\boldsymbol{\psi}&#39;_{\mathrm{A}}  \end{bmatrix}^{\mathrm{T}} \sim \mathrm{MVNormal}(\boldsymbol{0}, \boldsymbol{\mathrm{G}} \otimes \boldsymbol{\mathrm{A}} ) \]</span>
<span class="math display">\[\begin{bmatrix} \boldsymbol{\mu_{\mathrm{E}}}, \boldsymbol{\mu&#39;_{\mathrm{E}}},\boldsymbol{\psi_{\mathrm{E}}},\boldsymbol{\psi}&#39;_{\mathrm{E}}  \end{bmatrix}^{\mathrm{T}} \sim \mathrm{MVNormal}(\boldsymbol{0}, \boldsymbol{\mathrm{E}} \otimes \boldsymbol{\mathrm{I}} ) \]</span>
<span class="math display">\[\begin{bmatrix} \boldsymbol{\epsilon}, \boldsymbol{\epsilon}&#39; \end{bmatrix}^{\mathrm{T}} \sim \mathrm{MVNormal}(\boldsymbol{0}, \boldsymbol{\mathrm{\Sigma}} ) \]</span>
We also assume that the social reaction norm (SRN) intercept and slope (co)variances are equivalent for focal (<span class="math inline">\(\boldsymbol{\mu},\boldsymbol{\psi}\)</span>) and social partners (<span class="math inline">\(\boldsymbol{\mu}&#39;,\boldsymbol{\psi}&#39;\)</span>). The <span class="math inline">\(\boldsymbol{G}\)</span> matrix can therefore be reduced to a 2x2 matrix for all individuals in the population</p>
<p><span class="math display">\[\boldsymbol{\mathrm{G}}= \begin{bmatrix} \mathrm{var([\boldsymbol{\mu},\boldsymbol{\mu}&#39;])} &amp; \mathrm{cov([\boldsymbol{\mu},\boldsymbol{\mu}&#39;],[\boldsymbol{\psi},\boldsymbol{\psi}&#39;])} \\ \mathrm{cov([\boldsymbol{\psi},\boldsymbol{\psi}&#39;],[\boldsymbol{\mu},\boldsymbol{\mu}&#39;])} &amp;
\mathrm{var([\boldsymbol{\psi},\boldsymbol{\psi}&#39;])} \end{bmatrix}\]</span></p>
<p>The residual matrix <span class="math inline">\(\boldsymbol{\Sigma}\)</span> estimates the association among focal and social partners’ residuals.</p>
<p><span class="math display">\[\boldsymbol{\Sigma}= \begin{bmatrix} \mathrm{var(\boldsymbol{\epsilon})} &amp; \mathrm{cov}(\boldsymbol{\epsilon},\boldsymbol{\epsilon}&#39;) \\ 
\mathrm{cov}(\boldsymbol{\epsilon}&#39;,\boldsymbol{\epsilon}) &amp;
\mathrm{var(\boldsymbol{\epsilon&#39;})}     \end{bmatrix}\]</span>
This model is, therefore, appropriate for situations where the distinction between focal and partner is semi-arbitrary, e.g. when measuring within-sex interactions or when males and females exhibit similar patterns of phenotypic variation. In this case, we make the latter assumption for simplicity. To account for differences between the responses of focal individuals and social partners, the model can simply be extended with additional parameters, e.g. specifying separate <span class="math inline">\(G_M\)</span> and <span class="math inline">\(G_F\)</span> matrices for males and female respective genetic (co)variances and so on.</p>
<div id="simulate-data-3" class="section level2" number="4.1">
<h2><span class="header-section-number">4.1</span> Simulate data</h2>
<p>We can simulate data from this model using the custom <code>pedfun()</code> function introduced in Ch. <a href="using-stan-in-r.html#animal-models">1.5</a>, as well by integrating the basic simulation approach outlined in the previous SAM chapters for repeated interactions with partners (Ch. <a href="within-partner-sam.html#within-partner-sam">2</a>) as well as across partners (Ch. <a href="between-partner-sam.html#between-partner-sam">3</a>).</p>
<p>We assume that interactions occur with 4 lifetime partners with two measurements per individual within each dyad. This empirical information allows us to more effectively partition within and between dyad variation.</p>
<div class="sourceCode" id="cb121"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb121-1"><a href="within-and-between-partner-sam.html#cb121-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(mvtnorm)</span>
<span id="cb121-2"><a href="within-and-between-partner-sam.html#cb121-2" aria-hidden="true" tabindex="-1"></a><span class="co">#common settings</span></span>
<span id="cb121-3"><a href="within-and-between-partner-sam.html#cb121-3" aria-hidden="true" tabindex="-1"></a>I_partner <span class="ot">=</span> <span class="dv">4</span> <span class="co">#partners/individual</span></span>
<span id="cb121-4"><a href="within-and-between-partner-sam.html#cb121-4" aria-hidden="true" tabindex="-1"></a>I_obs <span class="ot">=</span> <span class="dv">2</span> <span class="co">#observations/individual/seasonal partner</span></span>
<span id="cb121-5"><a href="within-and-between-partner-sam.html#cb121-5" aria-hidden="true" tabindex="-1"></a>I_sample <span class="ot">=</span> I_partner<span class="sc">*</span>I_obs <span class="co">#samples/individual</span></span>
<span id="cb121-6"><a href="within-and-between-partner-sam.html#cb121-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb121-7"><a href="within-and-between-partner-sam.html#cb121-7" aria-hidden="true" tabindex="-1"></a><span class="co">#population properties</span></span>
<span id="cb121-8"><a href="within-and-between-partner-sam.html#cb121-8" aria-hidden="true" tabindex="-1"></a>I<span class="ot">=</span><span class="dv">300</span> <span class="co">#total individuals for simulation</span></span>
<span id="cb121-9"><a href="within-and-between-partner-sam.html#cb121-9" aria-hidden="true" tabindex="-1"></a>popmin<span class="ot">=</span><span class="dv">400</span></span>
<span id="cb121-10"><a href="within-and-between-partner-sam.html#cb121-10" aria-hidden="true" tabindex="-1"></a>popmax<span class="ot">=</span><span class="dv">600</span></span>
<span id="cb121-11"><a href="within-and-between-partner-sam.html#cb121-11" aria-hidden="true" tabindex="-1"></a>ngenerations <span class="ot">=</span> <span class="dv">10</span></span>
<span id="cb121-12"><a href="within-and-between-partner-sam.html#cb121-12" aria-hidden="true" tabindex="-1"></a>nids<span class="ot">&lt;-</span><span class="fu">sample</span>(popmin<span class="sc">:</span>popmax, ngenerations, <span class="at">replace=</span><span class="cn">TRUE</span>) <span class="co">#N / generation</span></span>
<span id="cb121-13"><a href="within-and-between-partner-sam.html#cb121-13" aria-hidden="true" tabindex="-1"></a>epm <span class="ot">=</span> <span class="fu">sample</span>(<span class="fu">seq</span>(<span class="fl">0.15</span>, <span class="fl">0.25</span>,<span class="at">by=</span><span class="fl">0.05</span>),<span class="dv">1</span>) <span class="co">#extra-pair mating</span></span>
<span id="cb121-14"><a href="within-and-between-partner-sam.html#cb121-14" aria-hidden="true" tabindex="-1"></a>nonb <span class="ot">=</span> <span class="fu">sample</span>(<span class="fu">seq</span>(<span class="fl">0.4</span>,<span class="fl">0.6</span>,<span class="at">by=</span><span class="fl">0.05</span>),<span class="dv">1</span>) <span class="co">#proportion of non-breeding / generation</span></span>
<span id="cb121-15"><a href="within-and-between-partner-sam.html#cb121-15" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb121-16"><a href="within-and-between-partner-sam.html#cb121-16" aria-hidden="true" tabindex="-1"></a><span class="co">#relatedness matrix</span></span>
<span id="cb121-17"><a href="within-and-between-partner-sam.html#cb121-17" aria-hidden="true" tabindex="-1"></a>A_mat <span class="ot">&lt;-</span> <span class="fu">pedfun</span>(<span class="at">popmin=</span>popmin, <span class="at">popmax=</span>popmax, <span class="at">ngenerations=</span>ngenerations,</span>
<span id="cb121-18"><a href="within-and-between-partner-sam.html#cb121-18" aria-hidden="true" tabindex="-1"></a>                  <span class="at">epm=</span>epm, <span class="at">nonb=</span>nonb, <span class="at">nids=</span>nids, <span class="at">I=</span>I, <span class="at">missing=</span><span class="cn">FALSE</span>)</span>
<span id="cb121-19"><a href="within-and-between-partner-sam.html#cb121-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb121-20"><a href="within-and-between-partner-sam.html#cb121-20" aria-hidden="true" tabindex="-1"></a><span class="do">#####################################################################</span></span>
<span id="cb121-21"><a href="within-and-between-partner-sam.html#cb121-21" aria-hidden="true" tabindex="-1"></a><span class="co">#Parameter values</span></span>
<span id="cb121-22"><a href="within-and-between-partner-sam.html#cb121-22" aria-hidden="true" tabindex="-1"></a><span class="do">#####################################################################</span></span>
<span id="cb121-23"><a href="within-and-between-partner-sam.html#cb121-23" aria-hidden="true" tabindex="-1"></a>alpha_0 <span class="ot">=</span> <span class="dv">0</span> <span class="co">#global intercept</span></span>
<span id="cb121-24"><a href="within-and-between-partner-sam.html#cb121-24" aria-hidden="true" tabindex="-1"></a>psi_1 <span class="ot">=</span> <span class="fl">0.5</span> <span class="co">#population interaction coefficient</span></span>
<span id="cb121-25"><a href="within-and-between-partner-sam.html#cb121-25" aria-hidden="true" tabindex="-1"></a>phi <span class="ot">=</span>  <span class="fl">0.5</span> <span class="co">#residual feedback coefficient (epsilon_j ~ epsilon_t-1k)</span></span>
<span id="cb121-26"><a href="within-and-between-partner-sam.html#cb121-26" aria-hidden="true" tabindex="-1"></a>SD_intercept <span class="ot">=</span> <span class="fl">0.3</span> <span class="co">#standard deviation of SRN intercepts</span></span>
<span id="cb121-27"><a href="within-and-between-partner-sam.html#cb121-27" aria-hidden="true" tabindex="-1"></a>SD_slope <span class="ot">=</span> <span class="fl">0.3</span> <span class="co">#SD of SRN slopes</span></span>
<span id="cb121-28"><a href="within-and-between-partner-sam.html#cb121-28" aria-hidden="true" tabindex="-1"></a>r_alpha <span class="ot">=</span> <span class="fl">0.3</span> <span class="co">#assortment coefficient (expressed as correlation)</span></span>
<span id="cb121-29"><a href="within-and-between-partner-sam.html#cb121-29" aria-hidden="true" tabindex="-1"></a>r_G <span class="ot">=</span> <span class="fl">0.3</span> <span class="co">#genetic correlation of random intercepts and slopes</span></span>
<span id="cb121-30"><a href="within-and-between-partner-sam.html#cb121-30" aria-hidden="true" tabindex="-1"></a>r_E <span class="ot">=</span> <span class="fl">0.3</span> <span class="co">#environmental correlation</span></span>
<span id="cb121-31"><a href="within-and-between-partner-sam.html#cb121-31" aria-hidden="true" tabindex="-1"></a>r_R <span class="ot">=</span> <span class="sc">-</span><span class="fl">0.3</span> <span class="co">#residual effect correlation (epsilon_tj = epsilon_tk)</span></span>
<span id="cb121-32"><a href="within-and-between-partner-sam.html#cb121-32" aria-hidden="true" tabindex="-1"></a>V_G <span class="ot">=</span> <span class="fl">0.3</span> <span class="co">#genetic variance of REs</span></span>
<span id="cb121-33"><a href="within-and-between-partner-sam.html#cb121-33" aria-hidden="true" tabindex="-1"></a>V_E <span class="ot">=</span> <span class="fl">0.3</span> <span class="co">#genetic variance of REs</span></span>
<span id="cb121-34"><a href="within-and-between-partner-sam.html#cb121-34" aria-hidden="true" tabindex="-1"></a>res_V <span class="ot">=</span> <span class="dv">1</span></span>
<span id="cb121-35"><a href="within-and-between-partner-sam.html#cb121-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb121-36"><a href="within-and-between-partner-sam.html#cb121-36" aria-hidden="true" tabindex="-1"></a><span class="co">#Random effect correlations</span></span>
<span id="cb121-37"><a href="within-and-between-partner-sam.html#cb121-37" aria-hidden="true" tabindex="-1"></a>G_cor <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">c</span>(<span class="dv">1</span>,r_G,r_G,<span class="dv">1</span>), <span class="at">nrow=</span><span class="dv">2</span>, <span class="at">ncol=</span><span class="dv">2</span>) <span class="co">#mu_A, beta_A</span></span>
<span id="cb121-38"><a href="within-and-between-partner-sam.html#cb121-38" aria-hidden="true" tabindex="-1"></a>G_sd  <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fu">sqrt</span>(V_G),<span class="fu">sqrt</span>(V_G)) <span class="co">#G effect sds</span></span>
<span id="cb121-39"><a href="within-and-between-partner-sam.html#cb121-39" aria-hidden="true" tabindex="-1"></a>G_cov <span class="ot">&lt;-</span> <span class="fu">diag</span>(G_sd) <span class="sc">%*%</span> G_cor <span class="sc">%*%</span> <span class="fu">diag</span>(G_sd)</span>
<span id="cb121-40"><a href="within-and-between-partner-sam.html#cb121-40" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb121-41"><a href="within-and-between-partner-sam.html#cb121-41" aria-hidden="true" tabindex="-1"></a>E_cor <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">c</span>(<span class="dv">1</span>,r_E,r_E,<span class="dv">1</span>), <span class="at">nrow=</span><span class="dv">2</span>, <span class="at">ncol=</span><span class="dv">2</span>) <span class="co">#mu_E, beta_E</span></span>
<span id="cb121-42"><a href="within-and-between-partner-sam.html#cb121-42" aria-hidden="true" tabindex="-1"></a>E_sd  <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fu">sqrt</span>(V_E),<span class="fu">sqrt</span>(V_E)) <span class="co">#E effect sds</span></span>
<span id="cb121-43"><a href="within-and-between-partner-sam.html#cb121-43" aria-hidden="true" tabindex="-1"></a>E_cov <span class="ot">&lt;-</span> <span class="fu">diag</span>(E_sd) <span class="sc">%*%</span> E_cor <span class="sc">%*%</span> <span class="fu">diag</span>(E_sd)</span>
<span id="cb121-44"><a href="within-and-between-partner-sam.html#cb121-44" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb121-45"><a href="within-and-between-partner-sam.html#cb121-45" aria-hidden="true" tabindex="-1"></a><span class="co">#matrices</span></span>
<span id="cb121-46"><a href="within-and-between-partner-sam.html#cb121-46" aria-hidden="true" tabindex="-1"></a>G_block <span class="ot">&lt;-</span> G_cov <span class="sc">%x%</span> A_mat</span>
<span id="cb121-47"><a href="within-and-between-partner-sam.html#cb121-47" aria-hidden="true" tabindex="-1"></a>E_block <span class="ot">&lt;-</span> E_cov <span class="sc">%x%</span> <span class="fu">diag</span>(<span class="dv">1</span>,I)</span>
<span id="cb121-48"><a href="within-and-between-partner-sam.html#cb121-48" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb121-49"><a href="within-and-between-partner-sam.html#cb121-49" aria-hidden="true" tabindex="-1"></a><span class="co">#generate correlated REs</span></span>
<span id="cb121-50"><a href="within-and-between-partner-sam.html#cb121-50" aria-hidden="true" tabindex="-1"></a>Gvalues <span class="ot">&lt;-</span> <span class="fu">rmvnorm</span>(<span class="dv">1</span>, <span class="at">mean=</span><span class="fu">rep</span>(<span class="dv">0</span>,I<span class="sc">*</span><span class="dv">2</span>), <span class="at">sigma=</span>G_block)</span>
<span id="cb121-51"><a href="within-and-between-partner-sam.html#cb121-51" aria-hidden="true" tabindex="-1"></a>G_val <span class="ot">=</span> <span class="fu">data.frame</span>(<span class="fu">matrix</span>(Gvalues, <span class="at">nrow=</span>I, <span class="at">ncol=</span><span class="dv">2</span>))</span>
<span id="cb121-52"><a href="within-and-between-partner-sam.html#cb121-52" aria-hidden="true" tabindex="-1"></a><span class="fu">cor</span>(G_val)</span></code></pre></div>
<pre><code>##           X1        X2
## X1 1.0000000 0.3003963
## X2 0.3003963 1.0000000</code></pre>
<div class="sourceCode" id="cb123"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb123-1"><a href="within-and-between-partner-sam.html#cb123-1" aria-hidden="true" tabindex="-1"></a>Evalues <span class="ot">&lt;-</span> <span class="fu">rmvnorm</span>(<span class="dv">1</span>, <span class="at">mean=</span><span class="fu">rep</span>(<span class="dv">0</span>,I<span class="sc">*</span><span class="dv">2</span>), <span class="at">sigma=</span>E_block)</span>
<span id="cb123-2"><a href="within-and-between-partner-sam.html#cb123-2" aria-hidden="true" tabindex="-1"></a>E_val <span class="ot">=</span> <span class="fu">data.frame</span>(<span class="fu">matrix</span>(Evalues, <span class="at">nrow=</span>I, <span class="at">ncol=</span><span class="dv">2</span>))</span>
<span id="cb123-3"><a href="within-and-between-partner-sam.html#cb123-3" aria-hidden="true" tabindex="-1"></a><span class="fu">cor</span>(E_val)</span></code></pre></div>
<pre><code>##           X1        X2
## X1 1.0000000 0.3394947
## X2 0.3394947 1.0000000</code></pre>
<div class="sourceCode" id="cb125"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb125-1"><a href="within-and-between-partner-sam.html#cb125-1" aria-hidden="true" tabindex="-1"></a><span class="co">#combine temporary object for all SRN parameters</span></span>
<span id="cb125-2"><a href="within-and-between-partner-sam.html#cb125-2" aria-hidden="true" tabindex="-1"></a><span class="co">#use shorthand mu = 0, psi = 1</span></span>
<span id="cb125-3"><a href="within-and-between-partner-sam.html#cb125-3" aria-hidden="true" tabindex="-1"></a>P <span class="ot">=</span> <span class="fu">cbind</span>(G_val,E_val)</span>
<span id="cb125-4"><a href="within-and-between-partner-sam.html#cb125-4" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(P) <span class="ot">=</span> <span class="fu">c</span>(<span class="st">&quot;A0&quot;</span>, <span class="st">&quot;A1&quot;</span>, <span class="st">&quot;E0&quot;</span>, <span class="st">&quot;E1&quot;</span>)</span>
<span id="cb125-5"><a href="within-and-between-partner-sam.html#cb125-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-6"><a href="within-and-between-partner-sam.html#cb125-6" aria-hidden="true" tabindex="-1"></a><span class="co">#individual phenotypic REs</span></span>
<span id="cb125-7"><a href="within-and-between-partner-sam.html#cb125-7" aria-hidden="true" tabindex="-1"></a><span class="co">#use shorthand mu = 0, psi = 1</span></span>
<span id="cb125-8"><a href="within-and-between-partner-sam.html#cb125-8" aria-hidden="true" tabindex="-1"></a>P<span class="sc">$</span>P0 <span class="ot">=</span> P<span class="sc">$</span>A0 <span class="sc">+</span> P<span class="sc">$</span>E0 </span>
<span id="cb125-9"><a href="within-and-between-partner-sam.html#cb125-9" aria-hidden="true" tabindex="-1"></a>P<span class="sc">$</span>P1 <span class="ot">=</span> P<span class="sc">$</span>A1 <span class="sc">+</span> P<span class="sc">$</span>E1</span>
<span id="cb125-10"><a href="within-and-between-partner-sam.html#cb125-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-11"><a href="within-and-between-partner-sam.html#cb125-11" aria-hidden="true" tabindex="-1"></a><span class="co">#add ID</span></span>
<span id="cb125-12"><a href="within-and-between-partner-sam.html#cb125-12" aria-hidden="true" tabindex="-1"></a>P<span class="sc">$</span>ID <span class="ot">=</span> <span class="fu">seq</span>(<span class="dv">1</span><span class="sc">:</span>I)</span></code></pre></div>
<p>The structure of dyads is sampled to match the expected SRN intercept correlation among individuals and their social partners. For this simulation, we assume that partners assort on their SRN slopes rather than intercepts. This is of course arbitrary but allows us to directly assess how well the model can partition within- and between-individual sources of partner covariation. After determining the dyads and organizing their trait values, the data frame is then expanded to account for multiple observations with the same social partner.</p>
<div class="sourceCode" id="cb126"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb126-1"><a href="within-and-between-partner-sam.html#cb126-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb126-2"><a href="within-and-between-partner-sam.html#cb126-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(MASS)</span>
<span id="cb126-3"><a href="within-and-between-partner-sam.html#cb126-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-4"><a href="within-and-between-partner-sam.html#cb126-4" aria-hidden="true" tabindex="-1"></a>pairs <span class="ot">=</span> <span class="fu">list</span>()</span>
<span id="cb126-5"><a href="within-and-between-partner-sam.html#cb126-5" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (j <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>I_partner){</span>
<span id="cb126-6"><a href="within-and-between-partner-sam.html#cb126-6" aria-hidden="true" tabindex="-1"></a>    <span class="co">#male additive genetic RN slopes (x I_partner for multiple lifetime partners)</span></span>
<span id="cb126-7"><a href="within-and-between-partner-sam.html#cb126-7" aria-hidden="true" tabindex="-1"></a>    sort.m <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">P1_m =</span> P<span class="sc">$</span>P1[<span class="dv">1</span><span class="sc">:</span>(I<span class="sc">/</span><span class="dv">2</span>)], <span class="at">ID_m =</span> (<span class="dv">1</span><span class="sc">:</span>(I<span class="sc">/</span><span class="dv">2</span>)) )</span>
<span id="cb126-8"><a href="within-and-between-partner-sam.html#cb126-8" aria-hidden="true" tabindex="-1"></a>    sort.m<span class="ot">&lt;-</span>sort.m[<span class="fu">order</span>(sort.m[,<span class="st">&quot;P1_m&quot;</span>]),]</span>
<span id="cb126-9"><a href="within-and-between-partner-sam.html#cb126-9" aria-hidden="true" tabindex="-1"></a>    <span class="co">#female phenotypic RN slopes</span></span>
<span id="cb126-10"><a href="within-and-between-partner-sam.html#cb126-10" aria-hidden="true" tabindex="-1"></a>    sort.f <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">P1_f =</span> P<span class="sc">$</span>P1[(I<span class="sc">/</span><span class="dv">2</span> <span class="sc">+</span> <span class="dv">1</span>)<span class="sc">:</span>I], <span class="at">ID_f =</span> ((I<span class="sc">/</span><span class="dv">2</span><span class="sc">+</span><span class="dv">1</span>)<span class="sc">:</span>I) )</span>
<span id="cb126-11"><a href="within-and-between-partner-sam.html#cb126-11" aria-hidden="true" tabindex="-1"></a>    sort.f<span class="ot">&lt;-</span>sort.f[<span class="fu">order</span>(sort.f[,<span class="st">&quot;P1_f&quot;</span>]),]</span>
<span id="cb126-12"><a href="within-and-between-partner-sam.html#cb126-12" aria-hidden="true" tabindex="-1"></a>    <span class="co">#generate random dataset with desired rank-order correlation</span></span>
<span id="cb126-13"><a href="within-and-between-partner-sam.html#cb126-13" aria-hidden="true" tabindex="-1"></a>    temp_mat <span class="ot">&lt;-</span> <span class="fu">matrix</span>(r_alpha, <span class="at">ncol =</span> <span class="dv">2</span>, <span class="at">nrow =</span> <span class="dv">2</span>) <span class="co">#cor of male and female values</span></span>
<span id="cb126-14"><a href="within-and-between-partner-sam.html#cb126-14" aria-hidden="true" tabindex="-1"></a>    <span class="fu">diag</span>(temp_mat) <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="co">#cor matrix</span></span>
<span id="cb126-15"><a href="within-and-between-partner-sam.html#cb126-15" aria-hidden="true" tabindex="-1"></a>    <span class="co">#sim values</span></span>
<span id="cb126-16"><a href="within-and-between-partner-sam.html#cb126-16" aria-hidden="true" tabindex="-1"></a>    temp_data1<span class="ot">&lt;-</span>MASS<span class="sc">::</span><span class="fu">mvrnorm</span>(<span class="at">n =</span> I<span class="sc">/</span><span class="dv">2</span>, <span class="at">mu =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">0</span>), <span class="at">Sigma =</span> temp_mat, <span class="at">empirical=</span><span class="cn">TRUE</span>)</span>
<span id="cb126-17"><a href="within-and-between-partner-sam.html#cb126-17" aria-hidden="true" tabindex="-1"></a>    <span class="co">#ranks of random data</span></span>
<span id="cb126-18"><a href="within-and-between-partner-sam.html#cb126-18" aria-hidden="true" tabindex="-1"></a>    rm <span class="ot">&lt;-</span> <span class="fu">rank</span>(temp_data1[ , <span class="dv">1</span>], <span class="at">ties.method =</span> <span class="st">&quot;first&quot;</span>)</span>
<span id="cb126-19"><a href="within-and-between-partner-sam.html#cb126-19" aria-hidden="true" tabindex="-1"></a>    rf <span class="ot">&lt;-</span> <span class="fu">rank</span>(temp_data1[ , <span class="dv">2</span>], <span class="at">ties.method =</span> <span class="st">&quot;first&quot;</span>)</span>
<span id="cb126-20"><a href="within-and-between-partner-sam.html#cb126-20" aria-hidden="true" tabindex="-1"></a>    <span class="co">#induce cor through rank-ordering of RN vectors</span></span>
<span id="cb126-21"><a href="within-and-between-partner-sam.html#cb126-21" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cor</span>(sort.m<span class="sc">$</span>P1_m[rm], sort.f<span class="sc">$</span>P1_f[rf])</span>
<span id="cb126-22"><a href="within-and-between-partner-sam.html#cb126-22" aria-hidden="true" tabindex="-1"></a>    <span class="co">#sort partner ids into dataframe</span></span>
<span id="cb126-23"><a href="within-and-between-partner-sam.html#cb126-23" aria-hidden="true" tabindex="-1"></a>    partner.id <span class="ot">=</span> <span class="fu">data.frame</span>(<span class="at">ID_m =</span> sort.m<span class="sc">$</span>ID_m[rm], <span class="at">ID_f =</span> sort.f<span class="sc">$</span>ID_f[rf])</span>
<span id="cb126-24"><a href="within-and-between-partner-sam.html#cb126-24" aria-hidden="true" tabindex="-1"></a>    partner.id <span class="ot">=</span> partner.id[<span class="fu">order</span>(partner.id[,<span class="st">&quot;ID_m&quot;</span>]),]</span>
<span id="cb126-25"><a href="within-and-between-partner-sam.html#cb126-25" aria-hidden="true" tabindex="-1"></a>    <span class="co">#add to list</span></span>
<span id="cb126-26"><a href="within-and-between-partner-sam.html#cb126-26" aria-hidden="true" tabindex="-1"></a>    pairs[[j]] <span class="ot">=</span> partner.id</span>
<span id="cb126-27"><a href="within-and-between-partner-sam.html#cb126-27" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb126-28"><a href="within-and-between-partner-sam.html#cb126-28" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb126-29"><a href="within-and-between-partner-sam.html#cb126-29" aria-hidden="true" tabindex="-1"></a>  partner.id <span class="ot">=</span> <span class="fu">bind_rows</span>(pairs)</span>
<span id="cb126-30"><a href="within-and-between-partner-sam.html#cb126-30" aria-hidden="true" tabindex="-1"></a>  partner.id[<span class="fu">order</span>(partner.id<span class="sc">$</span>ID_m),]</span></code></pre></div>
<pre><code>##     ID_m ID_f
## 1      1  220
## 151    1  285
## 301    1  280
## 451    1  215
## 2      2  179
## 152    2  281
## 302    2  182
## 452    2  165
## 3      3  152
## 153    3  164
## 303    3  230
## 453    3  274
## 4      4  198
## 154    4  212
## 304    4  165
## 454    4  249
## 5      5  231
## 155    5  196
## 305    5  238
## 455    5  291
## 6      6  270
## 156    6  297
## 306    6  154
## 456    6  192
## 7      7  265
## 157    7  256
## 307    7  269
## 457    7  273
## 8      8  251
## 158    8  163
## 308    8  195
## 458    8  250
## 9      9  167
## 159    9  188
## 309    9  222
## 459    9  241
## 10    10  300
## 160   10  264
## 310   10  265
## 460   10  168
## 11    11  254
## 161   11  205
## 311   11  168
## 461   11  272
## 12    12  267
## 162   12  189
## 312   12  232
## 462   12  271
## 13    13  258
## 163   13  243
## 313   13  194
## 463   13  197
## 14    14  226
## 164   14  193
## 314   14  293
## 464   14  200
## 15    15  273
## 165   15  236
## 315   15  258
## 465   15  187
## 16    16  203
## 166   16  180
## 316   16  196
## 466   16  265
## 17    17  227
## 167   17  162
## 317   17  276
## 467   17  240
## 18    18  280
## 168   18  253
## 318   18  208
## 468   18  193
## 19    19  284
## 169   19  204
## 319   19  216
## 469   19  214
## 20    20  228
## 170   20  192
## 320   20  278
## 470   20  184
## 21    21  233
## 171   21  287
## 321   21  209
## 471   21  199
## 22    22  292
## 172   22  223
## 322   22  191
## 472   22  170
## 23    23  283
## 173   23  217
## 323   23  274
## 473   23  248
## 24    24  271
## 174   24  276
## 324   24  184
## 474   24  201
## 25    25  277
## 175   25  280
## 325   25  251
## 475   25  233
## 26    26  214
## 176   26  181
## 326   26  158
## 476   26  267
## 27    27  287
## 177   27  270
## 327   27  153
## 477   27  210
## 28    28  163
## 178   28  245
## 328   28  256
## 478   28  224
## 29    29  185
## 179   29  201
## 329   29  248
## 479   29  208
## 30    30  221
## 180   30  262
## 330   30  229
## 480   30  180
## 31    31  219
## 181   31  184
## 331   31  246
## 481   31  247
## 32    32  200
## 182   32  246
## 332   32  268
## 482   32  152
## 33    33  243
## 183   33  214
## 333   33  239
## 483   33  295
## 34    34  246
## 184   34  177
## 334   34  205
## 484   34  289
## 35    35  256
## 185   35  296
## 335   35  202
## 485   35  167
## 36    36  188
## 186   36  238
## 336   36  177
## 486   36  194
## 37    37  223
## 187   37  293
## 337   37  295
## 487   37  154
## 38    38  162
## 188   38  154
## 338   38  211
## 488   38  260
## 39    39  186
## 189   39  186
## 339   39  291
## 489   39  296
## 40    40  229
## 190   40  179
## 340   40  299
## 490   40  190
## 41    41  266
## 191   41  295
## 341   41  180
## 491   41  268
## 42    42  201
## 192   42  161
## 342   42  292
## 492   42  157
## 43    43  218
## 193   43  241
## 343   43  171
## 493   43  221
## 44    44  295
## 194   44  237
## 344   44  215
## 494   44  195
## 45    45  232
## 195   45  151
## 345   45  201
## 495   45  204
## 46    46  257
## 196   46  249
## 346   46  281
## 496   46  236
## 47    47  171
## 197   47  231
## 347   47  218
## 497   47  172
## 48    48  285
## 198   48  203
## 348   48  188
## 498   48  169
## 49    49  168
## 199   49  247
## 349   49  159
## 499   49  163
## 50    50  176
## 200   50  224
## 350   50  152
## 500   50  287
## 51    51  215
## 201   51  242
## 351   51  264
## 501   51  234
## 52    52  225
## 202   52  267
## 352   52  212
## 502   52  198
## 53    53  154
## 203   53  213
## 353   53  203
## 503   53  292
## 54    54  260
## 204   54  250
## 354   54  253
## 504   54  262
## 55    55  235
## 205   55  197
## 355   55  284
## 505   55  225
## 56    56  196
## 206   56  173
## 356   56  176
## 506   56  245
## 57    57  240
## 207   57  278
## 357   57  226
## 507   57  160
## 58    58  255
## 208   58  288
## 358   58  273
## 508   58  253
## 59    59  151
## 209   59  248
## 359   59  279
## 509   59  239
## 60    60  279
## 210   60  220
## 360   60  163
## 510   60  171
## 61    61  269
## 211   61  251
## 361   61  161
## 511   61  283
## 62    62  262
## 212   62  263
## 362   62  285
## 512   62  183
## 63    63  252
## 213   63  239
## 363   63  186
## 513   63  174
## 64    64  297
## 214   64  244
## 364   64  167
## 514   64  222
## 65    65  204
## 215   65  282
## 365   65  242
## 515   65  202
## 66    66  182
## 216   66  272
## 366   66  252
## 516   66  188
## 67    67  184
## 217   67  229
## 367   67  164
## 517   67  213
## 68    68  197
## 218   68  208
## 368   68  200
## 518   68  166
## 69    69  166
## 219   69  286
## 369   69  236
## 519   69  277
## 70    70  286
## 220   70  294
## 370   70  287
## 520   70  246
## 71    71  164
## 221   71  230
## 371   71  206
## 521   71  217
## 72    72  155
## 222   72  153
## 372   72  254
## 522   72  151
## 73    73  157
## 223   73  259
## 373   73  297
## 523   73  191
## 74    74  192
## 224   74  165
## 374   74  272
## 524   74  235
## 75    75  153
## 225   75  207
## 375   75  190
## 525   75  294
## 76    76  222
## 226   76  275
## 376   76  179
## 526   76  182
## 77    77  205
## 227   77  299
## 377   77  277
## 527   77  270
## 78    78  290
## 228   78  255
## 378   78  266
## 528   78  196
## 79    79  178
## 229   79  254
## 379   79  169
## 529   79  158
## 80    80  244
## 230   80  209
## 380   80  290
## 530   80  237
## 81    81  238
## 231   81  174
## 381   81  189
## 531   81  299
## 82    82  190
## 232   82  195
## 382   82  227
## 532   82  276
## 83    83  156
## 233   83  210
## 383   83  183
## 533   83  282
## 84    84  263
## 234   84  157
## 384   84  244
## 534   84  161
## 85    85  216
## 235   85  182
## 385   85  289
## 535   85  178
## 86    86  165
## 236   86  194
## 386   86  192
## 536   86  173
## 87    87  242
## 237   87  269
## 387   87  162
## 537   87  298
## 88    88  234
## 238   88  211
## 388   88  262
## 538   88  266
## 89    89  206
## 239   89  199
## 389   89  249
## 539   89  275
## 90    90  264
## 240   90  290
## 390   90  275
## 540   90  203
## 91    91  272
## 241   91  232
## 391   91  187
## 541   91  205
## 92    92  180
## 242   92  258
## 392   92  257
## 542   92  261
## 93    93  282
## 243   93  279
## 393   93  255
## 543   93  257
## 94    94  291
## 244   94  187
## 394   94  225
## 544   94  216
## 95    95  195
## 245   95  265
## 395   95  223
## 545   95  212
## 96    96  261
## 246   96  292
## 396   96  217
## 546   96  259
## 97    97  187
## 247   97  234
## 397   97  288
## 547   97  162
## 98    98  169
## 248   98  202
## 398   98  219
## 548   98  300
## 99    99  241
## 249   99  178
## 399   99  231
## 549   99  219
## 100  100  230
## 250  100  222
## 400  100  175
## 550  100  256
## 101  101  211
## 251  101  226
## 401  101  178
## 551  101  175
## 102  102  158
## 252  102  268
## 402  102  198
## 552  102  254
## 103  103  177
## 253  103  235
## 403  103  210
## 553  103  263
## 104  104  181
## 254  104  216
## 404  104  250
## 554  104  229
## 105  105  217
## 255  105  277
## 405  105  263
## 555  105  251
## 106  106  288
## 256  106  152
## 406  106  243
## 556  106  279
## 107  107  213
## 257  107  215
## 407  107  160
## 557  107  185
## 108  108  294
## 258  108  198
## 408  108  166
## 558  108  232
## 109  109  193
## 259  109  191
## 409  109  259
## 559  109  258
## 110  110  202
## 260  110  257
## 410  110  270
## 560  110  207
## 111  111  259
## 261  111  169
## 411  111  240
## 561  111  255
## 112  112  173
## 262  112  266
## 412  112  228
## 562  112  179
## 113  113  208
## 263  113  261
## 413  113  247
## 563  113  293
## 114  114  207
## 264  114  233
## 414  114  286
## 564  114  156
## 115  115  170
## 265  115  190
## 415  115  245
## 565  115  238
## 116  116  275
## 266  116  155
## 416  116  261
## 566  116  227
## 117  117  250
## 267  117  271
## 417  117  221
## 567  117  177
## 118  118  239
## 268  118  200
## 418  118  185
## 568  118  297
## 119  119  183
## 269  119  185
## 419  119  204
## 569  119  220
## 120  120  189
## 270  120  175
## 420  120  234
## 570  120  181
## 121  121  160
## 271  121  160
## 421  121  237
## 571  121  231
## 122  122  247
## 272  122  159
## 422  122  170
## 572  122  176
## 123  123  209
## 273  123  227
## 423  123  207
## 573  123  285
## 124  124  174
## 274  124  167
## 424  124  197
## 574  124  230
## 125  125  159
## 275  125  283
## 425  125  214
## 575  125  223
##  [ reached &#39;max&#39; / getOption(&quot;max.print&quot;) -- omitted 100 rows ]</code></pre>
<div class="sourceCode" id="cb128"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb128-1"><a href="within-and-between-partner-sam.html#cb128-1" aria-hidden="true" tabindex="-1"></a>  <span class="co">#put all dyads together</span></span>
<span id="cb128-2"><a href="within-and-between-partner-sam.html#cb128-2" aria-hidden="true" tabindex="-1"></a>  partner.id<span class="sc">$</span>dyadn <span class="ot">=</span> <span class="fu">seq</span>(<span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(partner.id))</span>
<span id="cb128-3"><a href="within-and-between-partner-sam.html#cb128-3" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb128-4"><a href="within-and-between-partner-sam.html#cb128-4" aria-hidden="true" tabindex="-1"></a>  <span class="co">#add values back to dataframe (male and joint)</span></span>
<span id="cb128-5"><a href="within-and-between-partner-sam.html#cb128-5" aria-hidden="true" tabindex="-1"></a>  partner.id<span class="sc">$</span>P0m <span class="ot">&lt;-</span> P<span class="sc">$</span>P0[<span class="fu">match</span>(partner.id<span class="sc">$</span>ID_m,P<span class="sc">$</span>ID)]</span>
<span id="cb128-6"><a href="within-and-between-partner-sam.html#cb128-6" aria-hidden="true" tabindex="-1"></a>  partner.id<span class="sc">$</span>P0f <span class="ot">&lt;-</span> P<span class="sc">$</span>P0[<span class="fu">match</span>(partner.id<span class="sc">$</span>ID_f,P<span class="sc">$</span>ID)]</span>
<span id="cb128-7"><a href="within-and-between-partner-sam.html#cb128-7" aria-hidden="true" tabindex="-1"></a>  partner.id<span class="sc">$</span>P1m <span class="ot">&lt;-</span> P<span class="sc">$</span>P1[<span class="fu">match</span>(partner.id<span class="sc">$</span>ID_m,P<span class="sc">$</span>ID)]</span>
<span id="cb128-8"><a href="within-and-between-partner-sam.html#cb128-8" aria-hidden="true" tabindex="-1"></a>  partner.id<span class="sc">$</span>P1f <span class="ot">&lt;-</span> P<span class="sc">$</span>P1[<span class="fu">match</span>(partner.id<span class="sc">$</span>ID_f,P<span class="sc">$</span>ID)]</span>
<span id="cb128-9"><a href="within-and-between-partner-sam.html#cb128-9" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb128-10"><a href="within-and-between-partner-sam.html#cb128-10" aria-hidden="true" tabindex="-1"></a>  partner.id<span class="sc">$</span>A0m <span class="ot">&lt;-</span> P<span class="sc">$</span>A0[<span class="fu">match</span>(partner.id<span class="sc">$</span>ID_m,P<span class="sc">$</span>ID)]</span>
<span id="cb128-11"><a href="within-and-between-partner-sam.html#cb128-11" aria-hidden="true" tabindex="-1"></a>  partner.id<span class="sc">$</span>A0f <span class="ot">&lt;-</span> P<span class="sc">$</span>A0[<span class="fu">match</span>(partner.id<span class="sc">$</span>ID_f,P<span class="sc">$</span>ID)]</span>
<span id="cb128-12"><a href="within-and-between-partner-sam.html#cb128-12" aria-hidden="true" tabindex="-1"></a>  partner.id<span class="sc">$</span>A1m <span class="ot">&lt;-</span> P<span class="sc">$</span>A1[<span class="fu">match</span>(partner.id<span class="sc">$</span>ID_m,P<span class="sc">$</span>ID)]</span>
<span id="cb128-13"><a href="within-and-between-partner-sam.html#cb128-13" aria-hidden="true" tabindex="-1"></a>  partner.id<span class="sc">$</span>A1f <span class="ot">&lt;-</span> P<span class="sc">$</span>A1[<span class="fu">match</span>(partner.id<span class="sc">$</span>ID_f,P<span class="sc">$</span>ID)]</span>
<span id="cb128-14"><a href="within-and-between-partner-sam.html#cb128-14" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb128-15"><a href="within-and-between-partner-sam.html#cb128-15" aria-hidden="true" tabindex="-1"></a>  partner.id<span class="sc">$</span>E0m <span class="ot">&lt;-</span> P<span class="sc">$</span>E0[<span class="fu">match</span>(partner.id<span class="sc">$</span>ID_m,P<span class="sc">$</span>ID)]</span>
<span id="cb128-16"><a href="within-and-between-partner-sam.html#cb128-16" aria-hidden="true" tabindex="-1"></a>  partner.id<span class="sc">$</span>E0f <span class="ot">&lt;-</span> P<span class="sc">$</span>E0[<span class="fu">match</span>(partner.id<span class="sc">$</span>ID_f,P<span class="sc">$</span>ID)]</span>
<span id="cb128-17"><a href="within-and-between-partner-sam.html#cb128-17" aria-hidden="true" tabindex="-1"></a>  partner.id<span class="sc">$</span>E1m <span class="ot">&lt;-</span> P<span class="sc">$</span>E1[<span class="fu">match</span>(partner.id<span class="sc">$</span>ID_m,P<span class="sc">$</span>ID)]</span>
<span id="cb128-18"><a href="within-and-between-partner-sam.html#cb128-18" aria-hidden="true" tabindex="-1"></a>  partner.id<span class="sc">$</span>E1f <span class="ot">&lt;-</span> P<span class="sc">$</span>E1[<span class="fu">match</span>(partner.id<span class="sc">$</span>ID_f,P<span class="sc">$</span>ID)]</span>
<span id="cb128-19"><a href="within-and-between-partner-sam.html#cb128-19" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb128-20"><a href="within-and-between-partner-sam.html#cb128-20" aria-hidden="true" tabindex="-1"></a>  <span class="co">#calculate mean partner phenotype for each subject</span></span>
<span id="cb128-21"><a href="within-and-between-partner-sam.html#cb128-21" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb128-22"><a href="within-and-between-partner-sam.html#cb128-22" aria-hidden="true" tabindex="-1"></a>  <span class="co">#average female for male partners</span></span>
<span id="cb128-23"><a href="within-and-between-partner-sam.html#cb128-23" aria-hidden="true" tabindex="-1"></a>  mean_0m <span class="ot">&lt;-</span> <span class="fu">aggregate</span>(P0f <span class="sc">~</span> ID_m, mean, <span class="at">data =</span> partner.id)</span>
<span id="cb128-24"><a href="within-and-between-partner-sam.html#cb128-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">names</span>(mean_0m)[<span class="dv">2</span>] <span class="ot">&lt;-</span> <span class="st">&quot;meanP0m&quot;</span></span>
<span id="cb128-25"><a href="within-and-between-partner-sam.html#cb128-25" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb128-26"><a href="within-and-between-partner-sam.html#cb128-26" aria-hidden="true" tabindex="-1"></a>  mean_1m <span class="ot">&lt;-</span> <span class="fu">aggregate</span>(P1f <span class="sc">~</span> ID_m, mean, <span class="at">data =</span> partner.id)</span>
<span id="cb128-27"><a href="within-and-between-partner-sam.html#cb128-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">names</span>(mean_1m)[<span class="dv">2</span>] <span class="ot">&lt;-</span> <span class="st">&quot;meanP1m&quot;</span></span>
<span id="cb128-28"><a href="within-and-between-partner-sam.html#cb128-28" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb128-29"><a href="within-and-between-partner-sam.html#cb128-29" aria-hidden="true" tabindex="-1"></a>  partner.id<span class="sc">$</span>meanP0m <span class="ot">&lt;-</span> mean_0m<span class="sc">$</span>meanP0m[<span class="fu">match</span>(partner.id<span class="sc">$</span>ID_m,mean_0m<span class="sc">$</span>ID_m)]</span>
<span id="cb128-30"><a href="within-and-between-partner-sam.html#cb128-30" aria-hidden="true" tabindex="-1"></a>  partner.id<span class="sc">$</span>meanP1m <span class="ot">&lt;-</span> mean_1m<span class="sc">$</span>meanP1m[<span class="fu">match</span>(partner.id<span class="sc">$</span>ID_m,mean_1m<span class="sc">$</span>ID_m)]</span>
<span id="cb128-31"><a href="within-and-between-partner-sam.html#cb128-31" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb128-32"><a href="within-and-between-partner-sam.html#cb128-32" aria-hidden="true" tabindex="-1"></a>  <span class="co">#average male for female partners</span></span>
<span id="cb128-33"><a href="within-and-between-partner-sam.html#cb128-33" aria-hidden="true" tabindex="-1"></a>  mean_0f <span class="ot">&lt;-</span> <span class="fu">aggregate</span>(P0m <span class="sc">~</span> ID_f, mean, <span class="at">data =</span> partner.id)</span>
<span id="cb128-34"><a href="within-and-between-partner-sam.html#cb128-34" aria-hidden="true" tabindex="-1"></a>  <span class="fu">names</span>(mean_0f)[<span class="dv">2</span>] <span class="ot">&lt;-</span> <span class="st">&quot;meanP0f&quot;</span></span>
<span id="cb128-35"><a href="within-and-between-partner-sam.html#cb128-35" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb128-36"><a href="within-and-between-partner-sam.html#cb128-36" aria-hidden="true" tabindex="-1"></a>  mean_1f <span class="ot">&lt;-</span> <span class="fu">aggregate</span>(P1m <span class="sc">~</span> ID_f, mean, <span class="at">data =</span> partner.id)</span>
<span id="cb128-37"><a href="within-and-between-partner-sam.html#cb128-37" aria-hidden="true" tabindex="-1"></a>  <span class="fu">names</span>(mean_1f)[<span class="dv">2</span>] <span class="ot">&lt;-</span> <span class="st">&quot;meanP1f&quot;</span></span>
<span id="cb128-38"><a href="within-and-between-partner-sam.html#cb128-38" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb128-39"><a href="within-and-between-partner-sam.html#cb128-39" aria-hidden="true" tabindex="-1"></a>  partner.id<span class="sc">$</span>meanP0f <span class="ot">&lt;-</span> mean_0f<span class="sc">$</span>meanP0f[<span class="fu">match</span>(partner.id<span class="sc">$</span>ID_f,mean_0f<span class="sc">$</span>ID_f)]</span>
<span id="cb128-40"><a href="within-and-between-partner-sam.html#cb128-40" aria-hidden="true" tabindex="-1"></a>  partner.id<span class="sc">$</span>meanP1f <span class="ot">&lt;-</span> mean_1f<span class="sc">$</span>meanP1f[<span class="fu">match</span>(partner.id<span class="sc">$</span>ID_f,mean_1f<span class="sc">$</span>ID_f)]</span>
<span id="cb128-41"><a href="within-and-between-partner-sam.html#cb128-41" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb128-42"><a href="within-and-between-partner-sam.html#cb128-42" aria-hidden="true" tabindex="-1"></a>  <span class="co">#number of dyads</span></span>
<span id="cb128-43"><a href="within-and-between-partner-sam.html#cb128-43" aria-hidden="true" tabindex="-1"></a>  ndyad <span class="ot">=</span> <span class="fu">nrow</span>(partner.id)</span>
<span id="cb128-44"><a href="within-and-between-partner-sam.html#cb128-44" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb128-45"><a href="within-and-between-partner-sam.html#cb128-45" aria-hidden="true" tabindex="-1"></a>  <span class="co">#expand for repeated measures</span></span>
<span id="cb128-46"><a href="within-and-between-partner-sam.html#cb128-46" aria-hidden="true" tabindex="-1"></a>  partner.id<span class="sc">$</span>rep <span class="ot">&lt;-</span> I_obs</span>
<span id="cb128-47"><a href="within-and-between-partner-sam.html#cb128-47" aria-hidden="true" tabindex="-1"></a>  pair_df <span class="ot">&lt;-</span> partner.id[<span class="fu">rep</span>(<span class="fu">row.names</span>(partner.id), partner.id<span class="sc">$</span>rep),]</span>
<span id="cb128-48"><a href="within-and-between-partner-sam.html#cb128-48" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb128-49"><a href="within-and-between-partner-sam.html#cb128-49" aria-hidden="true" tabindex="-1"></a>  <span class="co">#correlations</span></span>
<span id="cb128-50"><a href="within-and-between-partner-sam.html#cb128-50" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cor</span>(partner.id<span class="sc">$</span>P0m, partner.id<span class="sc">$</span>P0f)</span></code></pre></div>
<pre><code>## [1] 0.05302799</code></pre>
<div class="sourceCode" id="cb130"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb130-1"><a href="within-and-between-partner-sam.html#cb130-1" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cor</span>(partner.id<span class="sc">$</span>P1m, partner.id<span class="sc">$</span>P0f)</span></code></pre></div>
<pre><code>## [1] -0.01685785</code></pre>
<div class="sourceCode" id="cb132"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb132-1"><a href="within-and-between-partner-sam.html#cb132-1" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cor</span>(partner.id<span class="sc">$</span>P0m, partner.id<span class="sc">$</span>P1f)</span></code></pre></div>
<pre><code>## [1] 0.11546</code></pre>
<div class="sourceCode" id="cb134"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb134-1"><a href="within-and-between-partner-sam.html#cb134-1" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cor</span>(partner.id<span class="sc">$</span>P1m, partner.id<span class="sc">$</span>P1f)</span></code></pre></div>
<pre><code>## [1] 0.3003677</code></pre>
<p>The responses can now be sampled. Rather than directly within-individual centering responses and specifying the between-partner regression coefficient <span class="math inline">\(\beta_{B}\)</span> in the simulation, we assume partners respond to the total SRN trait value of their partner. Therefore, we expect <span class="math inline">\(\beta_{B}=1\)</span>.</p>
<div class="sourceCode" id="cb136"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb136-1"><a href="within-and-between-partner-sam.html#cb136-1" aria-hidden="true" tabindex="-1"></a><span class="do">#####################################################################</span></span>
<span id="cb136-2"><a href="within-and-between-partner-sam.html#cb136-2" aria-hidden="true" tabindex="-1"></a><span class="co">#Additional effects</span></span>
<span id="cb136-3"><a href="within-and-between-partner-sam.html#cb136-3" aria-hidden="true" tabindex="-1"></a><span class="do">#####################################################################</span></span>
<span id="cb136-4"><a href="within-and-between-partner-sam.html#cb136-4" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb136-5"><a href="within-and-between-partner-sam.html#cb136-5" aria-hidden="true" tabindex="-1"></a>  <span class="co">#correlated  residuals between male and females</span></span>
<span id="cb136-6"><a href="within-and-between-partner-sam.html#cb136-6" aria-hidden="true" tabindex="-1"></a>  R_cor <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">c</span>(<span class="dv">1</span>,r_R,r_R,<span class="dv">1</span>), <span class="at">nrow=</span><span class="dv">2</span>, <span class="at">ncol=</span><span class="dv">2</span>)</span>
<span id="cb136-7"><a href="within-and-between-partner-sam.html#cb136-7" aria-hidden="true" tabindex="-1"></a>  res_sd <span class="ot">&lt;-</span> <span class="fu">sqrt</span>(res_V)</span>
<span id="cb136-8"><a href="within-and-between-partner-sam.html#cb136-8" aria-hidden="true" tabindex="-1"></a>  R_cov <span class="ot">&lt;-</span> <span class="fu">diag</span>(<span class="fu">c</span>(res_sd,res_sd)) <span class="sc">%*%</span> R_cor <span class="sc">%*%</span> <span class="fu">diag</span>(<span class="fu">c</span>(res_sd,res_sd))</span>
<span id="cb136-9"><a href="within-and-between-partner-sam.html#cb136-9" aria-hidden="true" tabindex="-1"></a>  res_ind<span class="ot">&lt;-</span><span class="fu">data.frame</span>(<span class="fu">rmvnorm</span>(<span class="fu">nrow</span>(pair_df), <span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">0</span>), R_cov))</span>
<span id="cb136-10"><a href="within-and-between-partner-sam.html#cb136-10" aria-hidden="true" tabindex="-1"></a>  pair_df<span class="sc">$</span>resAGm <span class="ot">=</span> res_ind<span class="sc">$</span>X1</span>
<span id="cb136-11"><a href="within-and-between-partner-sam.html#cb136-11" aria-hidden="true" tabindex="-1"></a>  pair_df<span class="sc">$</span>resAGf <span class="ot">=</span> res_ind<span class="sc">$</span>X2</span>
<span id="cb136-12"><a href="within-and-between-partner-sam.html#cb136-12" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb136-13"><a href="within-and-between-partner-sam.html#cb136-13" aria-hidden="true" tabindex="-1"></a><span class="do">#####################################################################</span></span>
<span id="cb136-14"><a href="within-and-between-partner-sam.html#cb136-14" aria-hidden="true" tabindex="-1"></a><span class="co">#Simulate responses over t = {1,2} per partner</span></span>
<span id="cb136-15"><a href="within-and-between-partner-sam.html#cb136-15" aria-hidden="true" tabindex="-1"></a><span class="do">#####################################################################</span></span>
<span id="cb136-16"><a href="within-and-between-partner-sam.html#cb136-16" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb136-17"><a href="within-and-between-partner-sam.html#cb136-17" aria-hidden="true" tabindex="-1"></a>  <span class="co">#add interaction number</span></span>
<span id="cb136-18"><a href="within-and-between-partner-sam.html#cb136-18" aria-hidden="true" tabindex="-1"></a>  pair_df<span class="sc">$</span>turn <span class="ot">=</span> <span class="fu">rep</span>(<span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">2</span>),ndyad) </span>
<span id="cb136-19"><a href="within-and-between-partner-sam.html#cb136-19" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb136-20"><a href="within-and-between-partner-sam.html#cb136-20" aria-hidden="true" tabindex="-1"></a>  <span class="co">#average male social environment at time = 1</span></span>
<span id="cb136-21"><a href="within-and-between-partner-sam.html#cb136-21" aria-hidden="true" tabindex="-1"></a>  pair_df[pair_df<span class="sc">$</span>turn<span class="sc">==</span><span class="dv">1</span>,<span class="st">&quot;meaneta_m&quot;</span>] <span class="ot">=</span>  pair_df[pair_df<span class="sc">$</span>turn<span class="sc">==</span><span class="dv">1</span>,<span class="st">&quot;meanP0m&quot;</span>] <span class="sc">+</span> </span>
<span id="cb136-22"><a href="within-and-between-partner-sam.html#cb136-22" aria-hidden="true" tabindex="-1"></a>    (psi_1 <span class="sc">+</span> pair_df[pair_df<span class="sc">$</span>turn<span class="sc">==</span><span class="dv">1</span>,<span class="st">&quot;meanP1m&quot;</span>])<span class="sc">*</span>(pair_df[pair_df<span class="sc">$</span>turn<span class="sc">==</span><span class="dv">1</span>,<span class="st">&quot;P0m&quot;</span>])</span>
<span id="cb136-23"><a href="within-and-between-partner-sam.html#cb136-23" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb136-24"><a href="within-and-between-partner-sam.html#cb136-24" aria-hidden="true" tabindex="-1"></a>  <span class="co">#average female social environment at time = 1</span></span>
<span id="cb136-25"><a href="within-and-between-partner-sam.html#cb136-25" aria-hidden="true" tabindex="-1"></a>  pair_df[pair_df<span class="sc">$</span>turn<span class="sc">==</span><span class="dv">1</span>,<span class="st">&quot;meaneta_f&quot;</span>] <span class="ot">=</span>  pair_df[pair_df<span class="sc">$</span>turn<span class="sc">==</span><span class="dv">1</span>,<span class="st">&quot;meanP0f&quot;</span>] <span class="sc">+</span> </span>
<span id="cb136-26"><a href="within-and-between-partner-sam.html#cb136-26" aria-hidden="true" tabindex="-1"></a>    (psi_1 <span class="sc">+</span> pair_df[pair_df<span class="sc">$</span>turn<span class="sc">==</span><span class="dv">1</span>,<span class="st">&quot;meanP1f&quot;</span>])<span class="sc">*</span>(pair_df[pair_df<span class="sc">$</span>turn<span class="sc">==</span><span class="dv">1</span>,<span class="st">&quot;P0f&quot;</span>])</span>
<span id="cb136-27"><a href="within-and-between-partner-sam.html#cb136-27" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb136-28"><a href="within-and-between-partner-sam.html#cb136-28" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb136-29"><a href="within-and-between-partner-sam.html#cb136-29" aria-hidden="true" tabindex="-1"></a>  <span class="co">#individual prediction at t = 1</span></span>
<span id="cb136-30"><a href="within-and-between-partner-sam.html#cb136-30" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb136-31"><a href="within-and-between-partner-sam.html#cb136-31" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb136-32"><a href="within-and-between-partner-sam.html#cb136-32" aria-hidden="true" tabindex="-1"></a>  <span class="co">#males</span></span>
<span id="cb136-33"><a href="within-and-between-partner-sam.html#cb136-33" aria-hidden="true" tabindex="-1"></a>  <span class="co">#eta_j{t=1} = mu_j + psi_j*(mu_k - mu_meanK)</span></span>
<span id="cb136-34"><a href="within-and-between-partner-sam.html#cb136-34" aria-hidden="true" tabindex="-1"></a>  pair_df[pair_df<span class="sc">$</span>turn<span class="sc">==</span><span class="dv">1</span>,<span class="st">&quot;eta_m&quot;</span>] <span class="ot">=</span> pair_df[pair_df<span class="sc">$</span>turn<span class="sc">==</span><span class="dv">1</span>,<span class="st">&quot;P0m&quot;</span>] <span class="sc">+</span> </span>
<span id="cb136-35"><a href="within-and-between-partner-sam.html#cb136-35" aria-hidden="true" tabindex="-1"></a>    (psi_1 <span class="sc">+</span> pair_df[pair_df<span class="sc">$</span>turn<span class="sc">==</span><span class="dv">1</span>,<span class="st">&quot;P1m&quot;</span>])<span class="sc">*</span>(pair_df[pair_df<span class="sc">$</span>turn<span class="sc">==</span><span class="dv">1</span>,<span class="st">&quot;P0f&quot;</span>])</span>
<span id="cb136-36"><a href="within-and-between-partner-sam.html#cb136-36" aria-hidden="true" tabindex="-1"></a>  <span class="co">#females</span></span>
<span id="cb136-37"><a href="within-and-between-partner-sam.html#cb136-37" aria-hidden="true" tabindex="-1"></a>  <span class="co">#eta_k{t=1} = mu_k + psi_k*(mu_j - mu_meanJ)                                                                                                                </span></span>
<span id="cb136-38"><a href="within-and-between-partner-sam.html#cb136-38" aria-hidden="true" tabindex="-1"></a>  pair_df[pair_df<span class="sc">$</span>turn<span class="sc">==</span><span class="dv">1</span>,<span class="st">&quot;eta_f&quot;</span>] <span class="ot">=</span> pair_df[pair_df<span class="sc">$</span>turn<span class="sc">==</span><span class="dv">1</span>,<span class="st">&quot;P0f&quot;</span>] <span class="sc">+</span> </span>
<span id="cb136-39"><a href="within-and-between-partner-sam.html#cb136-39" aria-hidden="true" tabindex="-1"></a>    (psi_1 <span class="sc">+</span> pair_df[pair_df<span class="sc">$</span>turn<span class="sc">==</span><span class="dv">1</span>,<span class="st">&quot;P1f&quot;</span>])<span class="sc">*</span>(pair_df[pair_df<span class="sc">$</span>turn<span class="sc">==</span><span class="dv">1</span>,<span class="st">&quot;P0m&quot;</span>])</span>
<span id="cb136-40"><a href="within-and-between-partner-sam.html#cb136-40" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb136-41"><a href="within-and-between-partner-sam.html#cb136-41" aria-hidden="true" tabindex="-1"></a>  <span class="co">#individual prediction at t = 2</span></span>
<span id="cb136-42"><a href="within-and-between-partner-sam.html#cb136-42" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb136-43"><a href="within-and-between-partner-sam.html#cb136-43" aria-hidden="true" tabindex="-1"></a>  <span class="co">#eta_j{t=2} = mu_j + psi_j*(eta_k{t=1} - eta_meanK{t=1})</span></span>
<span id="cb136-44"><a href="within-and-between-partner-sam.html#cb136-44" aria-hidden="true" tabindex="-1"></a>  pair_df[pair_df<span class="sc">$</span>turn<span class="sc">==</span><span class="dv">2</span>,<span class="st">&quot;eta_m&quot;</span>] <span class="ot">=</span> pair_df[pair_df<span class="sc">$</span>turn<span class="sc">==</span><span class="dv">2</span>,<span class="st">&quot;P0m&quot;</span>] <span class="sc">+</span></span>
<span id="cb136-45"><a href="within-and-between-partner-sam.html#cb136-45" aria-hidden="true" tabindex="-1"></a>    (psi_1 <span class="sc">+</span> pair_df[pair_df<span class="sc">$</span>turn<span class="sc">==</span><span class="dv">2</span>,<span class="st">&quot;P1m&quot;</span>])<span class="sc">*</span>(pair_df[pair_df<span class="sc">$</span>turn<span class="sc">==</span><span class="dv">1</span>,<span class="st">&quot;eta_f&quot;</span>])</span>
<span id="cb136-46"><a href="within-and-between-partner-sam.html#cb136-46" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb136-47"><a href="within-and-between-partner-sam.html#cb136-47" aria-hidden="true" tabindex="-1"></a>  <span class="co">#females</span></span>
<span id="cb136-48"><a href="within-and-between-partner-sam.html#cb136-48" aria-hidden="true" tabindex="-1"></a>  pair_df[pair_df<span class="sc">$</span>turn<span class="sc">==</span><span class="dv">2</span>,<span class="st">&quot;eta_f&quot;</span>] <span class="ot">=</span> pair_df[pair_df<span class="sc">$</span>turn<span class="sc">==</span><span class="dv">2</span>,<span class="st">&quot;P0f&quot;</span>] <span class="sc">+</span> </span>
<span id="cb136-49"><a href="within-and-between-partner-sam.html#cb136-49" aria-hidden="true" tabindex="-1"></a>    (psi_1 <span class="sc">+</span> pair_df[pair_df<span class="sc">$</span>turn<span class="sc">==</span><span class="dv">2</span>,<span class="st">&quot;P1f&quot;</span>])<span class="sc">*</span>(pair_df[pair_df<span class="sc">$</span>turn<span class="sc">==</span><span class="dv">1</span>,<span class="st">&quot;eta_m&quot;</span>])</span>
<span id="cb136-50"><a href="within-and-between-partner-sam.html#cb136-50" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb136-51"><a href="within-and-between-partner-sam.html#cb136-51" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb136-52"><a href="within-and-between-partner-sam.html#cb136-52" aria-hidden="true" tabindex="-1"></a>  <span class="co">#add intercept and residual</span></span>
<span id="cb136-53"><a href="within-and-between-partner-sam.html#cb136-53" aria-hidden="true" tabindex="-1"></a>  pair_df<span class="sc">$</span>AG_m <span class="ot">=</span> alpha_0 <span class="sc">+</span> pair_df<span class="sc">$</span>eta_m <span class="sc">+</span> pair_df<span class="sc">$</span>resAGm</span>
<span id="cb136-54"><a href="within-and-between-partner-sam.html#cb136-54" aria-hidden="true" tabindex="-1"></a>  pair_df<span class="sc">$</span>AG_f <span class="ot">=</span> alpha_0 <span class="sc">+</span> pair_df<span class="sc">$</span>eta_f <span class="sc">+</span> pair_df<span class="sc">$</span>resAGf</span>
<span id="cb136-55"><a href="within-and-between-partner-sam.html#cb136-55" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb136-56"><a href="within-and-between-partner-sam.html#cb136-56" aria-hidden="true" tabindex="-1"></a>  <span class="co">#add residual feedback</span></span>
<span id="cb136-57"><a href="within-and-between-partner-sam.html#cb136-57" aria-hidden="true" tabindex="-1"></a>  pair_df[pair_df<span class="sc">$</span>turn<span class="sc">==</span><span class="dv">2</span>,<span class="st">&quot;AG_m&quot;</span>] <span class="ot">=</span> pair_df[pair_df<span class="sc">$</span>turn<span class="sc">==</span><span class="dv">2</span>,<span class="st">&quot;AG_m&quot;</span>] <span class="sc">+</span> phi <span class="sc">*</span> pair_df[pair_df<span class="sc">$</span>turn<span class="sc">==</span><span class="dv">1</span>,<span class="st">&quot;resAGf&quot;</span>]</span>
<span id="cb136-58"><a href="within-and-between-partner-sam.html#cb136-58" aria-hidden="true" tabindex="-1"></a>  pair_df[pair_df<span class="sc">$</span>turn<span class="sc">==</span><span class="dv">2</span>,<span class="st">&quot;AG_f&quot;</span>] <span class="ot">=</span> pair_df[pair_df<span class="sc">$</span>turn<span class="sc">==</span><span class="dv">2</span>,<span class="st">&quot;AG_f&quot;</span>] <span class="sc">+</span> phi <span class="sc">*</span> pair_df[pair_df<span class="sc">$</span>turn<span class="sc">==</span><span class="dv">1</span>,<span class="st">&quot;resAGm&quot;</span>]</span></code></pre></div>
<p>This data frame is combined with indices of male and female IDs in a list for Stan.</p>
<div class="sourceCode" id="cb137"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb137-1"><a href="within-and-between-partner-sam.html#cb137-1" aria-hidden="true" tabindex="-1"></a><span class="do">#####################################################################</span></span>
<span id="cb137-2"><a href="within-and-between-partner-sam.html#cb137-2" aria-hidden="true" tabindex="-1"></a><span class="co">#Prepare data for Stan</span></span>
<span id="cb137-3"><a href="within-and-between-partner-sam.html#cb137-3" aria-hidden="true" tabindex="-1"></a><span class="do">#####################################################################</span></span>
<span id="cb137-4"><a href="within-and-between-partner-sam.html#cb137-4" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb137-5"><a href="within-and-between-partner-sam.html#cb137-5" aria-hidden="true" tabindex="-1"></a>  <span class="co">#individual indices</span></span>
<span id="cb137-6"><a href="within-and-between-partner-sam.html#cb137-6" aria-hidden="true" tabindex="-1"></a>  Im <span class="ot">=</span> I<span class="sc">/</span><span class="dv">2</span> <span class="co">#number of males</span></span>
<span id="cb137-7"><a href="within-and-between-partner-sam.html#cb137-7" aria-hidden="true" tabindex="-1"></a>  If <span class="ot">=</span> I<span class="sc">/</span><span class="dv">2</span> <span class="co">#number of females</span></span>
<span id="cb137-8"><a href="within-and-between-partner-sam.html#cb137-8" aria-hidden="true" tabindex="-1"></a>  N_sex <span class="ot">=</span> (I<span class="sc">/</span><span class="dv">2</span>)<span class="sc">*</span><span class="dv">2</span><span class="sc">*</span><span class="dv">4</span> <span class="co">#total observations per sex</span></span>
<span id="cb137-9"><a href="within-and-between-partner-sam.html#cb137-9" aria-hidden="true" tabindex="-1"></a>  idm<span class="ot">&lt;-</span>pair_df<span class="sc">$</span>ID_m <span class="co">#male ID</span></span>
<span id="cb137-10"><a href="within-and-between-partner-sam.html#cb137-10" aria-hidden="true" tabindex="-1"></a>  idf<span class="ot">&lt;-</span>pair_df<span class="sc">$</span>ID_f <span class="co">#female ID</span></span>
<span id="cb137-11"><a href="within-and-between-partner-sam.html#cb137-11" aria-hidden="true" tabindex="-1"></a>  idf<span class="ot">&lt;-</span>idf <span class="sc">-</span> (Im) <span class="co">#index within female vector</span></span>
<span id="cb137-12"><a href="within-and-between-partner-sam.html#cb137-12" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb137-13"><a href="within-and-between-partner-sam.html#cb137-13" aria-hidden="true" tabindex="-1"></a>  <span class="co">#partner IDs for male individuals</span></span>
<span id="cb137-14"><a href="within-and-between-partner-sam.html#cb137-14" aria-hidden="true" tabindex="-1"></a>  partners_m<span class="ot">&lt;-</span><span class="fu">data.frame</span>(<span class="at">idfocal =</span> <span class="fu">rep</span>(<span class="dv">1</span><span class="sc">:</span>(I<span class="sc">/</span><span class="dv">2</span>)), <span class="co">#all partners ID</span></span>
<span id="cb137-15"><a href="within-and-between-partner-sam.html#cb137-15" aria-hidden="true" tabindex="-1"></a>                         <span class="at">partner1 =</span> <span class="cn">NA</span>, <span class="at">partner2 =</span> <span class="cn">NA</span>, <span class="at">partner3 =</span> <span class="cn">NA</span>, <span class="at">partner4 =</span> <span class="cn">NA</span>)</span>
<span id="cb137-16"><a href="within-and-between-partner-sam.html#cb137-16" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>(I<span class="sc">/</span><span class="dv">2</span>)){partners_m[i,<span class="fu">c</span>(<span class="dv">2</span><span class="sc">:</span><span class="dv">5</span>)] <span class="ot">&lt;-</span>partner.id[partner.id<span class="sc">$</span>ID_m<span class="sc">==</span>i,<span class="st">&quot;ID_f&quot;</span>]}</span>
<span id="cb137-17"><a href="within-and-between-partner-sam.html#cb137-17" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb137-18"><a href="within-and-between-partner-sam.html#cb137-18" aria-hidden="true" tabindex="-1"></a>  <span class="co">#partner IDs for female individuals</span></span>
<span id="cb137-19"><a href="within-and-between-partner-sam.html#cb137-19" aria-hidden="true" tabindex="-1"></a>  partners_f<span class="ot">&lt;-</span><span class="fu">data.frame</span>(<span class="at">idfocal =</span> <span class="fu">rep</span>((I<span class="sc">/</span><span class="dv">2</span><span class="sc">+</span><span class="dv">1</span>)<span class="sc">:</span>I), <span class="co">#all partners ID</span></span>
<span id="cb137-20"><a href="within-and-between-partner-sam.html#cb137-20" aria-hidden="true" tabindex="-1"></a>                         <span class="at">partner1 =</span> <span class="cn">NA</span>, <span class="at">partner2 =</span> <span class="cn">NA</span>, <span class="at">partner3 =</span> <span class="cn">NA</span>, <span class="at">partner4 =</span> <span class="cn">NA</span>)</span>
<span id="cb137-21"><a href="within-and-between-partner-sam.html#cb137-21" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(i <span class="cf">in</span> (I<span class="sc">/</span><span class="dv">2</span><span class="sc">+</span><span class="dv">1</span>)<span class="sc">:</span>I){partners_f[i<span class="sc">-</span>(I<span class="sc">/</span><span class="dv">2</span>),<span class="fu">c</span>(<span class="dv">2</span><span class="sc">:</span><span class="dv">5</span>)] <span class="ot">&lt;-</span>partner.id[partner.id<span class="sc">$</span>ID_f<span class="sc">==</span>i,<span class="st">&quot;ID_m&quot;</span>]}</span>
<span id="cb137-22"><a href="within-and-between-partner-sam.html#cb137-22" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb137-23"><a href="within-and-between-partner-sam.html#cb137-23" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb137-24"><a href="within-and-between-partner-sam.html#cb137-24" aria-hidden="true" tabindex="-1"></a><span class="do">######################</span></span>
<span id="cb137-25"><a href="within-and-between-partner-sam.html#cb137-25" aria-hidden="true" tabindex="-1"></a><span class="co">#data prep for Stan</span></span>
<span id="cb137-26"><a href="within-and-between-partner-sam.html#cb137-26" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb137-27"><a href="within-and-between-partner-sam.html#cb137-27" aria-hidden="true" tabindex="-1"></a> stan_data <span class="ot">&lt;-</span></span>
<span id="cb137-28"><a href="within-and-between-partner-sam.html#cb137-28" aria-hidden="true" tabindex="-1"></a>    <span class="fu">list</span>(<span class="at">N_sex =</span> N_sex, <span class="at">I =</span> I, <span class="at">Im=</span>Im, <span class="at">If =</span> If, <span class="at">idm =</span> idm, <span class="at">idf =</span> idf,</span>
<span id="cb137-29"><a href="within-and-between-partner-sam.html#cb137-29" aria-hidden="true" tabindex="-1"></a>         <span class="at">partners_m =</span> partners_m, <span class="at">partners_f =</span> partners_f,</span>
<span id="cb137-30"><a href="within-and-between-partner-sam.html#cb137-30" aria-hidden="true" tabindex="-1"></a>         <span class="at">AG_m =</span> pair_df<span class="sc">$</span>AG_m, <span class="at">AG_f =</span> pair_df<span class="sc">$</span>AG_f, <span class="at">time =</span> pair_df<span class="sc">$</span>turn, <span class="at">A =</span> A_mat)</span></code></pre></div>
</div>
<div id="estimate-the-model-1" class="section level2" number="4.2">
<h2><span class="header-section-number">4.2</span> Estimate the model</h2>
<p>The within and between partner model code extends the within individual centered, between partner model to account for longitudinal feedback effects within dyads. These changes are accomplished in the <code>parameters</code> as well as the <code>model</code> program blocks. In the latter, a conditional statement is added to account for the effects on <span class="math inline">\(\eta_{ijt}\)</span> and <span class="math inline">\(\eta&#39;_{ikt}\)</span> at <span class="math inline">\(t=1\)</span> and <span class="math inline">\(t&gt;1\)</span>, and similarly for the residual feedback effects <span class="math inline">\(\xi_j\)</span> and <span class="math inline">\(\xi&#39;_k\)</span>.</p>
<div class="sourceCode" id="cb138"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb138-1"><a href="within-and-between-partner-sam.html#cb138-1" aria-hidden="true" tabindex="-1"></a><span class="fu">write</span>(<span class="st">&quot;</span></span>
<span id="cb138-2"><a href="within-and-between-partner-sam.html#cb138-2" aria-hidden="true" tabindex="-1"></a><span class="st">data {</span></span>
<span id="cb138-3"><a href="within-and-between-partner-sam.html#cb138-3" aria-hidden="true" tabindex="-1"></a><span class="st">  </span></span>
<span id="cb138-4"><a href="within-and-between-partner-sam.html#cb138-4" aria-hidden="true" tabindex="-1"></a><span class="st">  //indices and scalars used for model specification</span></span>
<span id="cb138-5"><a href="within-and-between-partner-sam.html#cb138-5" aria-hidden="true" tabindex="-1"></a><span class="st">  int&lt;lower=1&gt; N_sex; //total aggression observations per sex (I/2 * 4 lifetime partners)</span></span>
<span id="cb138-6"><a href="within-and-between-partner-sam.html#cb138-6" aria-hidden="true" tabindex="-1"></a><span class="st">  int&lt;lower=0&gt; I; //total individuals (M + F)</span></span>
<span id="cb138-7"><a href="within-and-between-partner-sam.html#cb138-7" aria-hidden="true" tabindex="-1"></a><span class="st">  int&lt;lower=0&gt; Im; //number of males</span></span>
<span id="cb138-8"><a href="within-and-between-partner-sam.html#cb138-8" aria-hidden="true" tabindex="-1"></a><span class="st">  int&lt;lower=0&gt; If; //number of females</span></span>
<span id="cb138-9"><a href="within-and-between-partner-sam.html#cb138-9" aria-hidden="true" tabindex="-1"></a><span class="st">  int&lt;lower=1&gt; idm[N_sex]; //index of male AG observations (of length N_sex)</span></span>
<span id="cb138-10"><a href="within-and-between-partner-sam.html#cb138-10" aria-hidden="true" tabindex="-1"></a><span class="st">  int&lt;lower=1&gt; idf[N_sex]; //index of female AG observations</span></span>
<span id="cb138-11"><a href="within-and-between-partner-sam.html#cb138-11" aria-hidden="true" tabindex="-1"></a><span class="st">  int&lt;lower=1&gt; partners_m [Im,5]; //index of male partner IDs, first column is focal ID (1 + 4 IDs)</span></span>
<span id="cb138-12"><a href="within-and-between-partner-sam.html#cb138-12" aria-hidden="true" tabindex="-1"></a><span class="st">  int&lt;lower=1&gt; partners_f [If,5]; //index of female partner IDs, first column is focal ID (1 + 4 IDs)</span></span>
<span id="cb138-13"><a href="within-and-between-partner-sam.html#cb138-13" aria-hidden="true" tabindex="-1"></a><span class="st">  </span></span>
<span id="cb138-14"><a href="within-and-between-partner-sam.html#cb138-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb138-15"><a href="within-and-between-partner-sam.html#cb138-15" aria-hidden="true" tabindex="-1"></a><span class="st">  //empirical data</span></span>
<span id="cb138-16"><a href="within-and-between-partner-sam.html#cb138-16" aria-hidden="true" tabindex="-1"></a><span class="st">  matrix[I,I] A; //relatedness matrix</span></span>
<span id="cb138-17"><a href="within-and-between-partner-sam.html#cb138-17" aria-hidden="true" tabindex="-1"></a><span class="st">  real AG_m[N_sex]; //male aggression measurements</span></span>
<span id="cb138-18"><a href="within-and-between-partner-sam.html#cb138-18" aria-hidden="true" tabindex="-1"></a><span class="st">  real AG_f[N_sex]; //female aggression measurements</span></span>
<span id="cb138-19"><a href="within-and-between-partner-sam.html#cb138-19" aria-hidden="true" tabindex="-1"></a><span class="st">  real time[N_sex]; //time index (=1 for all measures)</span></span>
<span id="cb138-20"><a href="within-and-between-partner-sam.html#cb138-20" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb138-21"><a href="within-and-between-partner-sam.html#cb138-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb138-22"><a href="within-and-between-partner-sam.html#cb138-22" aria-hidden="true" tabindex="-1"></a><span class="st">transformed data{</span></span>
<span id="cb138-23"><a href="within-and-between-partner-sam.html#cb138-23" aria-hidden="true" tabindex="-1"></a><span class="st">  matrix[I,I] LA = cholesky_decompose(A); //lower-triangle A matrix</span></span>
<span id="cb138-24"><a href="within-and-between-partner-sam.html#cb138-24" aria-hidden="true" tabindex="-1"></a><span class="st">  </span></span>
<span id="cb138-25"><a href="within-and-between-partner-sam.html#cb138-25" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb138-26"><a href="within-and-between-partner-sam.html#cb138-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb138-27"><a href="within-and-between-partner-sam.html#cb138-27" aria-hidden="true" tabindex="-1"></a><span class="st">parameters {</span></span>
<span id="cb138-28"><a href="within-and-between-partner-sam.html#cb138-28" aria-hidden="true" tabindex="-1"></a><span class="st">  //population effects</span></span>
<span id="cb138-29"><a href="within-and-between-partner-sam.html#cb138-29" aria-hidden="true" tabindex="-1"></a><span class="st">  real alpha_0; //aggression global intercept</span></span>
<span id="cb138-30"><a href="within-and-between-partner-sam.html#cb138-30" aria-hidden="true" tabindex="-1"></a><span class="st">  real psi_1; //expected interaction coefficient</span></span>
<span id="cb138-31"><a href="within-and-between-partner-sam.html#cb138-31" aria-hidden="true" tabindex="-1"></a><span class="st">  real beta_B; //between partner effect</span></span>
<span id="cb138-32"><a href="within-and-between-partner-sam.html#cb138-32" aria-hidden="true" tabindex="-1"></a><span class="st">  real&lt;lower=-1,upper=1&gt; phi; //(-1,1) ensures unique solution</span></span>
<span id="cb138-33"><a href="within-and-between-partner-sam.html#cb138-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb138-34"><a href="within-and-between-partner-sam.html#cb138-34" aria-hidden="true" tabindex="-1"></a><span class="st">  //random effects (standard deviations)</span></span>
<span id="cb138-35"><a href="within-and-between-partner-sam.html#cb138-35" aria-hidden="true" tabindex="-1"></a><span class="st">  vector&lt;lower=0, upper = 1&gt;[2] sd_P; //phenotypic SRN mu &amp; psi SDs</span></span>
<span id="cb138-36"><a href="within-and-between-partner-sam.html#cb138-36" aria-hidden="true" tabindex="-1"></a><span class="st">  vector&lt;lower=0, upper = 1&gt;[2] sd_R; //male &amp; female residual SDs</span></span>
<span id="cb138-37"><a href="within-and-between-partner-sam.html#cb138-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb138-38"><a href="within-and-between-partner-sam.html#cb138-38" aria-hidden="true" tabindex="-1"></a><span class="st">  cholesky_factor_corr[2] LG; //genetic SRN correlations</span></span>
<span id="cb138-39"><a href="within-and-between-partner-sam.html#cb138-39" aria-hidden="true" tabindex="-1"></a><span class="st">  cholesky_factor_corr[2] LE; //permanent environmental SRN correlations</span></span>
<span id="cb138-40"><a href="within-and-between-partner-sam.html#cb138-40" aria-hidden="true" tabindex="-1"></a><span class="st">  cholesky_factor_corr[2] LR; //sex-specific residual correlations</span></span>
<span id="cb138-41"><a href="within-and-between-partner-sam.html#cb138-41" aria-hidden="true" tabindex="-1"></a><span class="st">  </span></span>
<span id="cb138-42"><a href="within-and-between-partner-sam.html#cb138-42" aria-hidden="true" tabindex="-1"></a><span class="st">  matrix[I,2] std_devG; //individual-level unscaled G SRN deviations</span></span>
<span id="cb138-43"><a href="within-and-between-partner-sam.html#cb138-43" aria-hidden="true" tabindex="-1"></a><span class="st">  matrix[I,2] std_devE; //individual-level unscaled E SRN deviations</span></span>
<span id="cb138-44"><a href="within-and-between-partner-sam.html#cb138-44" aria-hidden="true" tabindex="-1"></a><span class="st">  </span></span>
<span id="cb138-45"><a href="within-and-between-partner-sam.html#cb138-45" aria-hidden="true" tabindex="-1"></a><span class="st">  //SRN heritability parmameters, i.e. Var(G_RN) / Var(P_RN) </span></span>
<span id="cb138-46"><a href="within-and-between-partner-sam.html#cb138-46" aria-hidden="true" tabindex="-1"></a><span class="st">  //see supplementary appendix SI for further explanation of this parameter</span></span>
<span id="cb138-47"><a href="within-and-between-partner-sam.html#cb138-47" aria-hidden="true" tabindex="-1"></a><span class="st">  vector&lt;lower=0,upper=1&gt;[2] SRN_h2;</span></span>
<span id="cb138-48"><a href="within-and-between-partner-sam.html#cb138-48" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb138-49"><a href="within-and-between-partner-sam.html#cb138-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb138-50"><a href="within-and-between-partner-sam.html#cb138-50" aria-hidden="true" tabindex="-1"></a><span class="st">transformed parameters {</span></span>
<span id="cb138-51"><a href="within-and-between-partner-sam.html#cb138-51" aria-hidden="true" tabindex="-1"></a><span class="st">  vector&lt;lower=0&gt;[2] sd_G; //SDs of G effects (derived from sd_P)</span></span>
<span id="cb138-52"><a href="within-and-between-partner-sam.html#cb138-52" aria-hidden="true" tabindex="-1"></a><span class="st">  vector&lt;lower=0&gt;[2] sd_E; //SDs of E effects (derived from sd_P)</span></span>
<span id="cb138-53"><a href="within-and-between-partner-sam.html#cb138-53" aria-hidden="true" tabindex="-1"></a><span class="st">  </span></span>
<span id="cb138-54"><a href="within-and-between-partner-sam.html#cb138-54" aria-hidden="true" tabindex="-1"></a><span class="st">  matrix[I,2] SRN_P; //scaled P SRN parameter deviations</span></span>
<span id="cb138-55"><a href="within-and-between-partner-sam.html#cb138-55" aria-hidden="true" tabindex="-1"></a><span class="st">  matrix[I,2] SRN_G; //scaled G SRN parameter deviations</span></span>
<span id="cb138-56"><a href="within-and-between-partner-sam.html#cb138-56" aria-hidden="true" tabindex="-1"></a><span class="st">  matrix[I,2] SRN_E; //scaled E SRN parameter deviations</span></span>
<span id="cb138-57"><a href="within-and-between-partner-sam.html#cb138-57" aria-hidden="true" tabindex="-1"></a><span class="st">  </span></span>
<span id="cb138-58"><a href="within-and-between-partner-sam.html#cb138-58" aria-hidden="true" tabindex="-1"></a><span class="st">  matrix[If, 2] partner_meanm; //average SRN parameters of males&#39; partners</span></span>
<span id="cb138-59"><a href="within-and-between-partner-sam.html#cb138-59" aria-hidden="true" tabindex="-1"></a><span class="st">  matrix[Im, 2] partner_meanf; //average SRN parameters of females&#39; partners</span></span>
<span id="cb138-60"><a href="within-and-between-partner-sam.html#cb138-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb138-61"><a href="within-and-between-partner-sam.html#cb138-61" aria-hidden="true" tabindex="-1"></a><span class="st">  //standard deviations of genetic effects</span></span>
<span id="cb138-62"><a href="within-and-between-partner-sam.html#cb138-62" aria-hidden="true" tabindex="-1"></a><span class="st">  //simplified from sqrt ( total RN phenotype variance * h2 )</span></span>
<span id="cb138-63"><a href="within-and-between-partner-sam.html#cb138-63" aria-hidden="true" tabindex="-1"></a><span class="st">  sd_G[1] = sd_P[1] * sqrt(SRN_h2[1]); //genetic SD for RN intercepts </span></span>
<span id="cb138-64"><a href="within-and-between-partner-sam.html#cb138-64" aria-hidden="true" tabindex="-1"></a><span class="st">  sd_G[2] = sd_P[2] * sqrt(SRN_h2[2]);  //genetic SD for RN slopes</span></span>
<span id="cb138-65"><a href="within-and-between-partner-sam.html#cb138-65" aria-hidden="true" tabindex="-1"></a><span class="st">  </span></span>
<span id="cb138-66"><a href="within-and-between-partner-sam.html#cb138-66" aria-hidden="true" tabindex="-1"></a><span class="st">  //standard deviations of environmental effects (total phenotype SD * proportion environment SD)</span></span>
<span id="cb138-67"><a href="within-and-between-partner-sam.html#cb138-67" aria-hidden="true" tabindex="-1"></a><span class="st">  sd_E[1] = sd_P[1] * sqrt(1 - SRN_h2[1]); //environment SD for RN intercepts </span></span>
<span id="cb138-68"><a href="within-and-between-partner-sam.html#cb138-68" aria-hidden="true" tabindex="-1"></a><span class="st">  sd_E[2] = sd_P[2] * sqrt(1 - SRN_h2[2]); //environment SD for RN slopes </span></span>
<span id="cb138-69"><a href="within-and-between-partner-sam.html#cb138-69" aria-hidden="true" tabindex="-1"></a><span class="st">  </span></span>
<span id="cb138-70"><a href="within-and-between-partner-sam.html#cb138-70" aria-hidden="true" tabindex="-1"></a><span class="st">  //matrix normal parameterization of Kronecker product between G and A</span></span>
<span id="cb138-71"><a href="within-and-between-partner-sam.html#cb138-71" aria-hidden="true" tabindex="-1"></a><span class="st">  SRN_G =  LA * std_devG  * diag_pre_multiply(sd_G, LG)&#39; ; </span></span>
<span id="cb138-72"><a href="within-and-between-partner-sam.html#cb138-72" aria-hidden="true" tabindex="-1"></a><span class="st">  </span></span>
<span id="cb138-73"><a href="within-and-between-partner-sam.html#cb138-73" aria-hidden="true" tabindex="-1"></a><span class="st">  //non-centered parameterization of permanent environmental effects</span></span>
<span id="cb138-74"><a href="within-and-between-partner-sam.html#cb138-74" aria-hidden="true" tabindex="-1"></a><span class="st">  SRN_E = std_devE * diag_pre_multiply(sd_E, LE)&#39;;</span></span>
<span id="cb138-75"><a href="within-and-between-partner-sam.html#cb138-75" aria-hidden="true" tabindex="-1"></a><span class="st">  </span></span>
<span id="cb138-76"><a href="within-and-between-partner-sam.html#cb138-76" aria-hidden="true" tabindex="-1"></a><span class="st">  //phenotypic RN effects (P = G + E); here G = additive genetic effects</span></span>
<span id="cb138-77"><a href="within-and-between-partner-sam.html#cb138-77" aria-hidden="true" tabindex="-1"></a><span class="st">  SRN_P = SRN_G + SRN_E;</span></span>
<span id="cb138-78"><a href="within-and-between-partner-sam.html#cb138-78" aria-hidden="true" tabindex="-1"></a><span class="st">  </span></span>
<span id="cb138-79"><a href="within-and-between-partner-sam.html#cb138-79" aria-hidden="true" tabindex="-1"></a><span class="st">  //calculate the mean SRN parameters of each male&#39;s lifetime partners</span></span>
<span id="cb138-80"><a href="within-and-between-partner-sam.html#cb138-80" aria-hidden="true" tabindex="-1"></a><span class="st">  for(i in 1:Im) partner_meanm[i] = [mean(col(SRN_P[partners_m[i,2:5]],1)),</span></span>
<span id="cb138-81"><a href="within-and-between-partner-sam.html#cb138-81" aria-hidden="true" tabindex="-1"></a><span class="st">                                mean(col(SRN_P[partners_m[i,2:5]],2))];</span></span>
<span id="cb138-82"><a href="within-and-between-partner-sam.html#cb138-82" aria-hidden="true" tabindex="-1"></a><span class="st">  </span></span>
<span id="cb138-83"><a href="within-and-between-partner-sam.html#cb138-83" aria-hidden="true" tabindex="-1"></a><span class="st">  //calculate the mean SRN parameters of each female&#39;s lifetime partners</span></span>
<span id="cb138-84"><a href="within-and-between-partner-sam.html#cb138-84" aria-hidden="true" tabindex="-1"></a><span class="st">  for(i in 1:If) partner_meanf[i] = [mean(col(SRN_P[partners_f[i,2:5]],1)),</span></span>
<span id="cb138-85"><a href="within-and-between-partner-sam.html#cb138-85" aria-hidden="true" tabindex="-1"></a><span class="st">                                mean(col(SRN_P[partners_f[i,2:5]],2))];</span></span>
<span id="cb138-86"><a href="within-and-between-partner-sam.html#cb138-86" aria-hidden="true" tabindex="-1"></a><span class="st">  </span></span>
<span id="cb138-87"><a href="within-and-between-partner-sam.html#cb138-87" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb138-88"><a href="within-and-between-partner-sam.html#cb138-88" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb138-89"><a href="within-and-between-partner-sam.html#cb138-89" aria-hidden="true" tabindex="-1"></a><span class="st">model{</span></span>
<span id="cb138-90"><a href="within-and-between-partner-sam.html#cb138-90" aria-hidden="true" tabindex="-1"></a><span class="st"> //separate male and female vectors for efficiency</span></span>
<span id="cb138-91"><a href="within-and-between-partner-sam.html#cb138-91" aria-hidden="true" tabindex="-1"></a><span class="st">  matrix[Im,2] SRN_Pm = SRN_P[1:Im]; //male SRN phenotypic deviations</span></span>
<span id="cb138-92"><a href="within-and-between-partner-sam.html#cb138-92" aria-hidden="true" tabindex="-1"></a><span class="st">  matrix[If,2] SRN_Pf = SRN_P[(Im+1):I]; //female SRN phenotypic deviations</span></span>
<span id="cb138-93"><a href="within-and-between-partner-sam.html#cb138-93" aria-hidden="true" tabindex="-1"></a><span class="st">  </span></span>
<span id="cb138-94"><a href="within-and-between-partner-sam.html#cb138-94" aria-hidden="true" tabindex="-1"></a><span class="st">  //separate SRN intercepts and slopes (phenotypic deviations)</span></span>
<span id="cb138-95"><a href="within-and-between-partner-sam.html#cb138-95" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[Im] mu_m = col(SRN_Pm,1); //SRN intercepts</span></span>
<span id="cb138-96"><a href="within-and-between-partner-sam.html#cb138-96" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[If] mu_f = col(SRN_Pf,1); </span></span>
<span id="cb138-97"><a href="within-and-between-partner-sam.html#cb138-97" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[Im] psi_m = col(SRN_Pm,2); //SRN slopes</span></span>
<span id="cb138-98"><a href="within-and-between-partner-sam.html#cb138-98" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[If] psi_f = col(SRN_Pf,2); </span></span>
<span id="cb138-99"><a href="within-and-between-partner-sam.html#cb138-99" aria-hidden="true" tabindex="-1"></a><span class="st">  </span></span>
<span id="cb138-100"><a href="within-and-between-partner-sam.html#cb138-100" aria-hidden="true" tabindex="-1"></a><span class="st">  //separate mean partner SRN intercepts and slopes (deviations)</span></span>
<span id="cb138-101"><a href="within-and-between-partner-sam.html#cb138-101" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[Im] mu_meanm = col(partner_meanm,1); //mean partner SRN intercept for males</span></span>
<span id="cb138-102"><a href="within-and-between-partner-sam.html#cb138-102" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[If] mu_meanf = col(partner_meanf,1); //...for females</span></span>
<span id="cb138-103"><a href="within-and-between-partner-sam.html#cb138-103" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[Im] psi_meanm = col(partner_meanm,2); //mean partner SRN slope for males</span></span>
<span id="cb138-104"><a href="within-and-between-partner-sam.html#cb138-104" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[If] psi_meanf = col(partner_meanf,2); //...for females </span></span>
<span id="cb138-105"><a href="within-and-between-partner-sam.html#cb138-105" aria-hidden="true" tabindex="-1"></a><span class="st">  </span></span>
<span id="cb138-106"><a href="within-and-between-partner-sam.html#cb138-106" aria-hidden="true" tabindex="-1"></a><span class="st">  //initialize vectors for constructing individual-centered linear predictors</span></span>
<span id="cb138-107"><a href="within-and-between-partner-sam.html#cb138-107" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[N_sex] eta_Wm; //within-individual centered male SRN trait value </span></span>
<span id="cb138-108"><a href="within-and-between-partner-sam.html#cb138-108" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[N_sex] eta_Wf; //within-individual centered female SRN trait value</span></span>
<span id="cb138-109"><a href="within-and-between-partner-sam.html#cb138-109" aria-hidden="true" tabindex="-1"></a><span class="st">  </span></span>
<span id="cb138-110"><a href="within-and-between-partner-sam.html#cb138-110" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[N_sex] eta_Bm; //individual male SRN trait value toward average partner </span></span>
<span id="cb138-111"><a href="within-and-between-partner-sam.html#cb138-111" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[N_sex] eta_Bf; //individual female SRN trait toward average partner</span></span>
<span id="cb138-112"><a href="within-and-between-partner-sam.html#cb138-112" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[N_sex] eta_meanm; //average SRN partner values for males</span></span>
<span id="cb138-113"><a href="within-and-between-partner-sam.html#cb138-113" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[N_sex] eta_meanf; //average SRN partner values for females</span></span>
<span id="cb138-114"><a href="within-and-between-partner-sam.html#cb138-114" aria-hidden="true" tabindex="-1"></a><span class="st">  </span></span>
<span id="cb138-115"><a href="within-and-between-partner-sam.html#cb138-115" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[N_sex] linpred_m; //expected value for male responses</span></span>
<span id="cb138-116"><a href="within-and-between-partner-sam.html#cb138-116" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[N_sex] linpred_f; //expected value for female responses</span></span>
<span id="cb138-117"><a href="within-and-between-partner-sam.html#cb138-117" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[N_sex] epsilon_m; //residuals for male responses</span></span>
<span id="cb138-118"><a href="within-and-between-partner-sam.html#cb138-118" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[N_sex] epsilon_f; //residuals for male responses</span></span>
<span id="cb138-119"><a href="within-and-between-partner-sam.html#cb138-119" aria-hidden="true" tabindex="-1"></a><span class="st">  </span></span>
<span id="cb138-120"><a href="within-and-between-partner-sam.html#cb138-120" aria-hidden="true" tabindex="-1"></a><span class="st">  //Male and female aggression response model</span></span>
<span id="cb138-121"><a href="within-and-between-partner-sam.html#cb138-121" aria-hidden="true" tabindex="-1"></a><span class="st">  for (n in 1:N_sex) {</span></span>
<span id="cb138-122"><a href="within-and-between-partner-sam.html#cb138-122" aria-hidden="true" tabindex="-1"></a><span class="st">    </span></span>
<span id="cb138-123"><a href="within-and-between-partner-sam.html#cb138-123" aria-hidden="true" tabindex="-1"></a><span class="st">    //SRN trait values</span></span>
<span id="cb138-124"><a href="within-and-between-partner-sam.html#cb138-124" aria-hidden="true" tabindex="-1"></a><span class="st">    //assumes that n = 1 in the context of an ongoing social interaction</span></span>
<span id="cb138-125"><a href="within-and-between-partner-sam.html#cb138-125" aria-hidden="true" tabindex="-1"></a><span class="st">    //if n = 1 prior to social context, then specify eta[t=1] = mu_j instead</span></span>
<span id="cb138-126"><a href="within-and-between-partner-sam.html#cb138-126" aria-hidden="true" tabindex="-1"></a><span class="st">    if (time[n]==1)</span></span>
<span id="cb138-127"><a href="within-and-between-partner-sam.html#cb138-127" aria-hidden="true" tabindex="-1"></a><span class="st">      {</span></span>
<span id="cb138-128"><a href="within-and-between-partner-sam.html#cb138-128" aria-hidden="true" tabindex="-1"></a><span class="st">        //within-individual centered eta</span></span>
<span id="cb138-129"><a href="within-and-between-partner-sam.html#cb138-129" aria-hidden="true" tabindex="-1"></a><span class="st">        //male eta[t=1] = mu_j + psi_j*(mu_k - mu_meanK)</span></span>
<span id="cb138-130"><a href="within-and-between-partner-sam.html#cb138-130" aria-hidden="true" tabindex="-1"></a><span class="st">        eta_Wm[n] = mu_m[idm[n]] +  (psi_1 + psi_m[idm[n]])*(mu_f[idf[n]] - mu_meanm[idm[n]]) ;</span></span>
<span id="cb138-131"><a href="within-and-between-partner-sam.html#cb138-131" aria-hidden="true" tabindex="-1"></a><span class="st">        </span></span>
<span id="cb138-132"><a href="within-and-between-partner-sam.html#cb138-132" aria-hidden="true" tabindex="-1"></a><span class="st">        //female eta[t=1] = mu_k + psi_k*(mu_j - mu_meanJ)</span></span>
<span id="cb138-133"><a href="within-and-between-partner-sam.html#cb138-133" aria-hidden="true" tabindex="-1"></a><span class="st">        eta_Wf[n] = mu_f[idf[n]] +   (psi_1 + psi_f[idf[n]])*(mu_m[idm[n]] - mu_meanf[idf[n]]);</span></span>
<span id="cb138-134"><a href="within-and-between-partner-sam.html#cb138-134" aria-hidden="true" tabindex="-1"></a><span class="st">        </span></span>
<span id="cb138-135"><a href="within-and-between-partner-sam.html#cb138-135" aria-hidden="true" tabindex="-1"></a><span class="st">        //average individual eta</span></span>
<span id="cb138-136"><a href="within-and-between-partner-sam.html#cb138-136" aria-hidden="true" tabindex="-1"></a><span class="st">        //male eta[t=1] = mu_j + psi_j*mu_k</span></span>
<span id="cb138-137"><a href="within-and-between-partner-sam.html#cb138-137" aria-hidden="true" tabindex="-1"></a><span class="st">        eta_Bm[n] =   (psi_1 + psi_m[idm[n]])*mu_meanm[idm[n]];</span></span>
<span id="cb138-138"><a href="within-and-between-partner-sam.html#cb138-138" aria-hidden="true" tabindex="-1"></a><span class="st">        </span></span>
<span id="cb138-139"><a href="within-and-between-partner-sam.html#cb138-139" aria-hidden="true" tabindex="-1"></a><span class="st">        //female eta[t=1] = mu_k + psi_k*mu_j</span></span>
<span id="cb138-140"><a href="within-and-between-partner-sam.html#cb138-140" aria-hidden="true" tabindex="-1"></a><span class="st">        eta_Bf[n] =   (psi_1 + psi_f[idf[n]])*mu_meanf[idf[n]];</span></span>
<span id="cb138-141"><a href="within-and-between-partner-sam.html#cb138-141" aria-hidden="true" tabindex="-1"></a><span class="st">        </span></span>
<span id="cb138-142"><a href="within-and-between-partner-sam.html#cb138-142" aria-hidden="true" tabindex="-1"></a><span class="st">        //average partner eta[t=1]</span></span>
<span id="cb138-143"><a href="within-and-between-partner-sam.html#cb138-143" aria-hidden="true" tabindex="-1"></a><span class="st">        //average eta males&#39; partners [t=1] = mu_meanK + psi_meanK*mu_j</span></span>
<span id="cb138-144"><a href="within-and-between-partner-sam.html#cb138-144" aria-hidden="true" tabindex="-1"></a><span class="st">        eta_meanm[n] = mu_meanm[idm[n]] +   (psi_1 + psi_meanm[idm[n]])*mu_m[idm[n]];</span></span>
<span id="cb138-145"><a href="within-and-between-partner-sam.html#cb138-145" aria-hidden="true" tabindex="-1"></a><span class="st">        </span></span>
<span id="cb138-146"><a href="within-and-between-partner-sam.html#cb138-146" aria-hidden="true" tabindex="-1"></a><span class="st">        //average eta females&#39; partners [t=1] = mu_meanJ + psi_meanJ*mu_k</span></span>
<span id="cb138-147"><a href="within-and-between-partner-sam.html#cb138-147" aria-hidden="true" tabindex="-1"></a><span class="st">        eta_meanf[n] = mu_meanf[idf[n]] +   (psi_1 + psi_meanf[idf[n]])*mu_f[idf[n]];</span></span>
<span id="cb138-148"><a href="within-and-between-partner-sam.html#cb138-148" aria-hidden="true" tabindex="-1"></a><span class="st">      }    </span></span>
<span id="cb138-149"><a href="within-and-between-partner-sam.html#cb138-149" aria-hidden="true" tabindex="-1"></a><span class="st">    else</span></span>
<span id="cb138-150"><a href="within-and-between-partner-sam.html#cb138-150" aria-hidden="true" tabindex="-1"></a><span class="st">      {</span></span>
<span id="cb138-151"><a href="within-and-between-partner-sam.html#cb138-151" aria-hidden="true" tabindex="-1"></a><span class="st">        //within-individual centered eta</span></span>
<span id="cb138-152"><a href="within-and-between-partner-sam.html#cb138-152" aria-hidden="true" tabindex="-1"></a><span class="st">        //male eta[t=2] = mu_j + psi_j*(eta_k[t=1] - eta_meanK[t=1])</span></span>
<span id="cb138-153"><a href="within-and-between-partner-sam.html#cb138-153" aria-hidden="true" tabindex="-1"></a><span class="st">        eta_Wm[n] = mu_m[idm[n]] +   (psi_1 + psi_m[idm[n]])*(eta_Wf[n-1] - eta_meanm[n-1]);</span></span>
<span id="cb138-154"><a href="within-and-between-partner-sam.html#cb138-154" aria-hidden="true" tabindex="-1"></a><span class="st">        </span></span>
<span id="cb138-155"><a href="within-and-between-partner-sam.html#cb138-155" aria-hidden="true" tabindex="-1"></a><span class="st">        //female eta[t=2] = mu_k + psi_k*(eta_j[t=1] - eta_meanJ[t=1])</span></span>
<span id="cb138-156"><a href="within-and-between-partner-sam.html#cb138-156" aria-hidden="true" tabindex="-1"></a><span class="st">        eta_Wf[n] = mu_f[idf[n]] +   (psi_1 + psi_f[idf[n]])*(eta_Wm[n-1] - eta_meanf[n-1]);</span></span>
<span id="cb138-157"><a href="within-and-between-partner-sam.html#cb138-157" aria-hidden="true" tabindex="-1"></a><span class="st">        </span></span>
<span id="cb138-158"><a href="within-and-between-partner-sam.html#cb138-158" aria-hidden="true" tabindex="-1"></a><span class="st">        //average individual eta</span></span>
<span id="cb138-159"><a href="within-and-between-partner-sam.html#cb138-159" aria-hidden="true" tabindex="-1"></a><span class="st">        //male average eta[t=2] = mu_j + psi_j*eta_meanK[t=1]</span></span>
<span id="cb138-160"><a href="within-and-between-partner-sam.html#cb138-160" aria-hidden="true" tabindex="-1"></a><span class="st">        eta_Bm[n] =  (psi_1 + psi_m[idm[n]])*eta_meanm[n-1];</span></span>
<span id="cb138-161"><a href="within-and-between-partner-sam.html#cb138-161" aria-hidden="true" tabindex="-1"></a><span class="st">        </span></span>
<span id="cb138-162"><a href="within-and-between-partner-sam.html#cb138-162" aria-hidden="true" tabindex="-1"></a><span class="st">        //female average eta[t=2] = mu_k + psi_k*eta_meanJ[t=1]</span></span>
<span id="cb138-163"><a href="within-and-between-partner-sam.html#cb138-163" aria-hidden="true" tabindex="-1"></a><span class="st">        eta_Bf[n] =  (psi_1 + psi_f[idf[n]])*eta_meanf[n-1];</span></span>
<span id="cb138-164"><a href="within-and-between-partner-sam.html#cb138-164" aria-hidden="true" tabindex="-1"></a><span class="st">        </span></span>
<span id="cb138-165"><a href="within-and-between-partner-sam.html#cb138-165" aria-hidden="true" tabindex="-1"></a><span class="st">        //average eta males&#39; partners [t=1] = mu_meanK + psi_meanK*mean eta_j[t-1]</span></span>
<span id="cb138-166"><a href="within-and-between-partner-sam.html#cb138-166" aria-hidden="true" tabindex="-1"></a><span class="st">        eta_meanm[n] = mu_meanm[idm[n]] +  (psi_1 + psi_meanm[idm[n]])*(mu_m[idm[n]] + eta_Bm[n-1]);</span></span>
<span id="cb138-167"><a href="within-and-between-partner-sam.html#cb138-167" aria-hidden="true" tabindex="-1"></a><span class="st">        </span></span>
<span id="cb138-168"><a href="within-and-between-partner-sam.html#cb138-168" aria-hidden="true" tabindex="-1"></a><span class="st">        //female average partner eta</span></span>
<span id="cb138-169"><a href="within-and-between-partner-sam.html#cb138-169" aria-hidden="true" tabindex="-1"></a><span class="st">        eta_meanf[n] = mu_meanf[idf[n]] +  (psi_1 + psi_meanf[idf[n]])*(mu_f[idf[n]] +   eta_Bf[n-1]); </span></span>
<span id="cb138-170"><a href="within-and-between-partner-sam.html#cb138-170" aria-hidden="true" tabindex="-1"></a><span class="st">      }</span></span>
<span id="cb138-171"><a href="within-and-between-partner-sam.html#cb138-171" aria-hidden="true" tabindex="-1"></a><span class="st">    </span></span>
<span id="cb138-172"><a href="within-and-between-partner-sam.html#cb138-172" aria-hidden="true" tabindex="-1"></a><span class="st">    //add global intercept and between-individual parameters to linear predictor</span></span>
<span id="cb138-173"><a href="within-and-between-partner-sam.html#cb138-173" aria-hidden="true" tabindex="-1"></a><span class="st">    //other fixed effects can also be added here</span></span>
<span id="cb138-174"><a href="within-and-between-partner-sam.html#cb138-174" aria-hidden="true" tabindex="-1"></a><span class="st">    linpred_m[n] = alpha_0 + eta_Wm[n] + beta_B*eta_Bm[n]; //+beta_B*eta_Bm[n]</span></span>
<span id="cb138-175"><a href="within-and-between-partner-sam.html#cb138-175" aria-hidden="true" tabindex="-1"></a><span class="st">    linpred_f[n] = alpha_0 + eta_Wf[n] + beta_B*eta_Bf[n]; //+beta_B*eta_Bf[n]</span></span>
<span id="cb138-176"><a href="within-and-between-partner-sam.html#cb138-176" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb138-177"><a href="within-and-between-partner-sam.html#cb138-177" aria-hidden="true" tabindex="-1"></a><span class="st">    //residual trait values</span></span>
<span id="cb138-178"><a href="within-and-between-partner-sam.html#cb138-178" aria-hidden="true" tabindex="-1"></a><span class="st">    if(time[n]==1)</span></span>
<span id="cb138-179"><a href="within-and-between-partner-sam.html#cb138-179" aria-hidden="true" tabindex="-1"></a><span class="st">      {</span></span>
<span id="cb138-180"><a href="within-and-between-partner-sam.html#cb138-180" aria-hidden="true" tabindex="-1"></a><span class="st">        epsilon_m [n] = AG_m[n] - linpred_m[n];</span></span>
<span id="cb138-181"><a href="within-and-between-partner-sam.html#cb138-181" aria-hidden="true" tabindex="-1"></a><span class="st">        epsilon_f [n] = AG_f[n] - linpred_f[n];</span></span>
<span id="cb138-182"><a href="within-and-between-partner-sam.html#cb138-182" aria-hidden="true" tabindex="-1"></a><span class="st">      }</span></span>
<span id="cb138-183"><a href="within-and-between-partner-sam.html#cb138-183" aria-hidden="true" tabindex="-1"></a><span class="st">    else</span></span>
<span id="cb138-184"><a href="within-and-between-partner-sam.html#cb138-184" aria-hidden="true" tabindex="-1"></a><span class="st">      {</span></span>
<span id="cb138-185"><a href="within-and-between-partner-sam.html#cb138-185" aria-hidden="true" tabindex="-1"></a><span class="st">       linpred_m[n] = linpred_m[n] + phi * epsilon_f[n-1];</span></span>
<span id="cb138-186"><a href="within-and-between-partner-sam.html#cb138-186" aria-hidden="true" tabindex="-1"></a><span class="st">       epsilon_m[n] = AG_m[n] - linpred_m[n]; </span></span>
<span id="cb138-187"><a href="within-and-between-partner-sam.html#cb138-187" aria-hidden="true" tabindex="-1"></a><span class="st">       </span></span>
<span id="cb138-188"><a href="within-and-between-partner-sam.html#cb138-188" aria-hidden="true" tabindex="-1"></a><span class="st">       linpred_f[n] = linpred_f[n] + phi * epsilon_m[n-1];</span></span>
<span id="cb138-189"><a href="within-and-between-partner-sam.html#cb138-189" aria-hidden="true" tabindex="-1"></a><span class="st">       epsilon_f[n] = AG_f[n] - linpred_f[n]; </span></span>
<span id="cb138-190"><a href="within-and-between-partner-sam.html#cb138-190" aria-hidden="true" tabindex="-1"></a><span class="st">      }</span></span>
<span id="cb138-191"><a href="within-and-between-partner-sam.html#cb138-191" aria-hidden="true" tabindex="-1"></a><span class="st">  </span></span>
<span id="cb138-192"><a href="within-and-between-partner-sam.html#cb138-192" aria-hidden="true" tabindex="-1"></a><span class="st">    //correlated residuals between partners</span></span>
<span id="cb138-193"><a href="within-and-between-partner-sam.html#cb138-193" aria-hidden="true" tabindex="-1"></a><span class="st">    [epsilon_m[n],epsilon_f[n]]&#39; ~ multi_normal_cholesky([0,0], diag_pre_multiply(sd_R, LR));</span></span>
<span id="cb138-194"><a href="within-and-between-partner-sam.html#cb138-194" aria-hidden="true" tabindex="-1"></a><span class="st">  }</span></span>
<span id="cb138-195"><a href="within-and-between-partner-sam.html#cb138-195" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb138-196"><a href="within-and-between-partner-sam.html#cb138-196" aria-hidden="true" tabindex="-1"></a><span class="st">//model priors</span></span>
<span id="cb138-197"><a href="within-and-between-partner-sam.html#cb138-197" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb138-198"><a href="within-and-between-partner-sam.html#cb138-198" aria-hidden="true" tabindex="-1"></a><span class="st">  //fixed effects</span></span>
<span id="cb138-199"><a href="within-and-between-partner-sam.html#cb138-199" aria-hidden="true" tabindex="-1"></a><span class="st">  alpha_0 ~ std_normal();</span></span>
<span id="cb138-200"><a href="within-and-between-partner-sam.html#cb138-200" aria-hidden="true" tabindex="-1"></a><span class="st">  psi_1 ~ std_normal();</span></span>
<span id="cb138-201"><a href="within-and-between-partner-sam.html#cb138-201" aria-hidden="true" tabindex="-1"></a><span class="st">  beta_B ~ std_normal();</span></span>
<span id="cb138-202"><a href="within-and-between-partner-sam.html#cb138-202" aria-hidden="true" tabindex="-1"></a><span class="st">  phi ~ std_normal();</span></span>
<span id="cb138-203"><a href="within-and-between-partner-sam.html#cb138-203" aria-hidden="true" tabindex="-1"></a><span class="st">  </span></span>
<span id="cb138-204"><a href="within-and-between-partner-sam.html#cb138-204" aria-hidden="true" tabindex="-1"></a><span class="st">  //random effects</span></span>
<span id="cb138-205"><a href="within-and-between-partner-sam.html#cb138-205" aria-hidden="true" tabindex="-1"></a><span class="st">  to_vector(sd_P) ~ cauchy(0,1);</span></span>
<span id="cb138-206"><a href="within-and-between-partner-sam.html#cb138-206" aria-hidden="true" tabindex="-1"></a><span class="st">  to_vector(sd_R) ~ cauchy(0,1);</span></span>
<span id="cb138-207"><a href="within-and-between-partner-sam.html#cb138-207" aria-hidden="true" tabindex="-1"></a><span class="st">  </span></span>
<span id="cb138-208"><a href="within-and-between-partner-sam.html#cb138-208" aria-hidden="true" tabindex="-1"></a><span class="st">  LG ~ lkj_corr_cholesky(2);</span></span>
<span id="cb138-209"><a href="within-and-between-partner-sam.html#cb138-209" aria-hidden="true" tabindex="-1"></a><span class="st">  LE ~ lkj_corr_cholesky(2);</span></span>
<span id="cb138-210"><a href="within-and-between-partner-sam.html#cb138-210" aria-hidden="true" tabindex="-1"></a><span class="st">  LR ~ lkj_corr_cholesky(2);</span></span>
<span id="cb138-211"><a href="within-and-between-partner-sam.html#cb138-211" aria-hidden="true" tabindex="-1"></a><span class="st">  </span></span>
<span id="cb138-212"><a href="within-and-between-partner-sam.html#cb138-212" aria-hidden="true" tabindex="-1"></a><span class="st">  to_vector(std_devG) ~ std_normal();</span></span>
<span id="cb138-213"><a href="within-and-between-partner-sam.html#cb138-213" aria-hidden="true" tabindex="-1"></a><span class="st">  to_vector(std_devE) ~ std_normal();</span></span>
<span id="cb138-214"><a href="within-and-between-partner-sam.html#cb138-214" aria-hidden="true" tabindex="-1"></a><span class="st">  </span></span>
<span id="cb138-215"><a href="within-and-between-partner-sam.html#cb138-215" aria-hidden="true" tabindex="-1"></a><span class="st">  //reaction norm heritability</span></span>
<span id="cb138-216"><a href="within-and-between-partner-sam.html#cb138-216" aria-hidden="true" tabindex="-1"></a><span class="st">  to_vector(SRN_h2) ~ beta(1.2,1.2);</span></span>
<span id="cb138-217"><a href="within-and-between-partner-sam.html#cb138-217" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb138-218"><a href="within-and-between-partner-sam.html#cb138-218" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb138-219"><a href="within-and-between-partner-sam.html#cb138-219" aria-hidden="true" tabindex="-1"></a><span class="st">generated quantities{</span></span>
<span id="cb138-220"><a href="within-and-between-partner-sam.html#cb138-220" aria-hidden="true" tabindex="-1"></a><span class="st">//cor and cov matrices of SRN parameters and residuals</span></span>
<span id="cb138-221"><a href="within-and-between-partner-sam.html#cb138-221" aria-hidden="true" tabindex="-1"></a><span class="st">matrix[2,2] Gcor = LG * LG&#39;; //G SRN correlation matric</span></span>
<span id="cb138-222"><a href="within-and-between-partner-sam.html#cb138-222" aria-hidden="true" tabindex="-1"></a><span class="st">matrix[2,2] Ecor = LE * LE&#39;; //E SRN correlation matric</span></span>
<span id="cb138-223"><a href="within-and-between-partner-sam.html#cb138-223" aria-hidden="true" tabindex="-1"></a><span class="st">matrix[2,2] Rcor = LR * LR&#39;; //residual correlation matrix</span></span>
<span id="cb138-224"><a href="within-and-between-partner-sam.html#cb138-224" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb138-225"><a href="within-and-between-partner-sam.html#cb138-225" aria-hidden="true" tabindex="-1"></a><span class="st">matrix[2,2] Rcov = diag_matrix(sd_R)*Rcor*diag_matrix(sd_R); //residual covariance</span></span>
<span id="cb138-226"><a href="within-and-between-partner-sam.html#cb138-226" aria-hidden="true" tabindex="-1"></a><span class="st">matrix[2,2] Gcov = diag_matrix(sd_G)*Gcor*diag_matrix(sd_G); //G SRN covariance</span></span>
<span id="cb138-227"><a href="within-and-between-partner-sam.html#cb138-227" aria-hidden="true" tabindex="-1"></a><span class="st">matrix[2,2] Ecov = diag_matrix(sd_E)*Ecor*diag_matrix(sd_E); //E SRN covariance</span></span>
<span id="cb138-228"><a href="within-and-between-partner-sam.html#cb138-228" aria-hidden="true" tabindex="-1"></a><span class="st">matrix[2,2] Pcov = Gcov + Ecov; //P SRN covariance</span></span>
<span id="cb138-229"><a href="within-and-between-partner-sam.html#cb138-229" aria-hidden="true" tabindex="-1"></a><span class="st">matrix[2,2] Pcor = inverse(diag_matrix(sd_P))*Pcov*inverse(diag_matrix(sd_P)); //P SRN correlation</span></span>
<span id="cb138-230"><a href="within-and-between-partner-sam.html#cb138-230" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb138-231"><a href="within-and-between-partner-sam.html#cb138-231" aria-hidden="true" tabindex="-1"></a><span class="st">//variances</span></span>
<span id="cb138-232"><a href="within-and-between-partner-sam.html#cb138-232" aria-hidden="true" tabindex="-1"></a><span class="st">vector&lt;lower=0&gt;[2] V_P = sd_P .* sd_P;</span></span>
<span id="cb138-233"><a href="within-and-between-partner-sam.html#cb138-233" aria-hidden="true" tabindex="-1"></a><span class="st">vector&lt;lower=0&gt;[2] V_G = sd_G .* sd_G;</span></span>
<span id="cb138-234"><a href="within-and-between-partner-sam.html#cb138-234" aria-hidden="true" tabindex="-1"></a><span class="st">vector&lt;lower=0&gt;[2] V_E = sd_E .* sd_E;</span></span>
<span id="cb138-235"><a href="within-and-between-partner-sam.html#cb138-235" aria-hidden="true" tabindex="-1"></a><span class="st">vector&lt;lower=0&gt;[2] V_R = sd_R .* sd_R;</span></span>
<span id="cb138-236"><a href="within-and-between-partner-sam.html#cb138-236" aria-hidden="true" tabindex="-1"></a><span class="st">}&quot;</span>, <span class="st">&quot;sam3_3w.stan&quot;</span>)</span></code></pre></div>
<p>Depending on the sample size set during the simulation, this model will likely take 30+ min to finish sampling. The total number of iterations can be reduced to save time, but is set to a large value here to ensure sufficient effective sample sizes for some parameters.</p>
<div class="sourceCode" id="cb139"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb139-1"><a href="within-and-between-partner-sam.html#cb139-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(rstan)</span>
<span id="cb139-2"><a href="within-and-between-partner-sam.html#cb139-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb139-3"><a href="within-and-between-partner-sam.html#cb139-3" aria-hidden="true" tabindex="-1"></a>sam_3<span class="fl">.3</span> <span class="ot">=</span> <span class="fu">stan_model</span>(<span class="st">&quot;sam3_3w.stan&quot;</span>)</span>
<span id="cb139-4"><a href="within-and-between-partner-sam.html#cb139-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb139-5"><a href="within-and-between-partner-sam.html#cb139-5" aria-hidden="true" tabindex="-1"></a>stan_results3<span class="fl">.3</span> <span class="ot">&lt;-</span> <span class="fu">sampling</span>(sam_3<span class="fl">.3</span>, <span class="at">data=</span>stan_data, <span class="at">init =</span> <span class="dv">0</span>, <span class="at">warmup=</span><span class="dv">1500</span>, <span class="at">iter =</span> <span class="dv">3000</span>,</span>
<span id="cb139-6"><a href="within-and-between-partner-sam.html#cb139-6" aria-hidden="true" tabindex="-1"></a>                         <span class="at">chains=</span><span class="dv">4</span>, <span class="at">cores=</span><span class="dv">4</span>, <span class="at">control=</span><span class="fu">list</span>(<span class="at">adapt_delta=</span><span class="fl">0.90</span>) )</span>
<span id="cb139-7"><a href="within-and-between-partner-sam.html#cb139-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb139-8"><a href="within-and-between-partner-sam.html#cb139-8" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(bayesplot) </span>
<span id="cb139-9"><a href="within-and-between-partner-sam.html#cb139-9" aria-hidden="true" tabindex="-1"></a><span class="fu">mcmc_areas</span>(stan_results3<span class="fl">.3</span>, <span class="at">pars =</span> <span class="fu">c</span>( <span class="st">&quot;psi_1&quot;</span>, <span class="st">&quot;beta_B&quot;</span>, <span class="st">&quot;V_P[1]&quot;</span>, <span class="st">&quot;V_P[2]&quot;</span>, <span class="st">&quot;Gcor[2,1]&quot;</span>, <span class="st">&quot;Ecor[2,1]&quot;</span>, <span class="st">&quot;Rcor[2,1]&quot;</span>, </span>
<span id="cb139-10"><a href="within-and-between-partner-sam.html#cb139-10" aria-hidden="true" tabindex="-1"></a>                                      <span class="st">&quot;Pcor[2,1]&quot;</span>,  <span class="st">&quot;SRN_h2[1]&quot;</span>,  <span class="st">&quot;SRN_h2[2]&quot;</span>), <span class="at">prob =</span> <span class="fl">0.9</span> )</span></code></pre></div>
<p><img src="SAMs_files/figure-html/unnamed-chunk-63-1.png" width="672" />
The model seems to be doing well overall, detecting the negative population SRN slope (-0.5) as well as approximating the locaiton of the total phenotypic variance of SRN intercepts and slopes (0.6), the phenotypic correlation between SRN parameters (0.3), the SRN heritability of intercepts and slopes (0.5), and the expected between partner regresson coefficient (1).</p>
</div>
<div id="estimating-assortment-1" class="section level2" number="4.3">
<h2><span class="header-section-number">4.3</span> Estimating assortment</h2>
<p>The mean partner intrinsic trait values calculated in the model can then be used to estimate the assortment coefficient of interest <span class="math inline">\(\beta_{{\bar{\psi}&#39;}\psi}\)</span>, as well as the broader assortment matrix <span class="math inline">\(\boldsymbol{B_{\alpha}}\)</span>. We can directly calculate the quantities of the assortment matrix using the vectors of mean partner SRN parameters that we constructed and estimated with the Stan model. In this case, we’re also interesting in estimating the expected assortment within any particular breeding season, under the assumption that variation in assortment coefficients between seasons is random. To do this, we need to scale the (co)variances of interest appropriately for the expected variance of a single partner, rather than the mean of multiple partners. If the intrinsic SRN parameter values of social partners are independent Gaussian variables, then the expected variance for a single partner phenotype <span class="math inline">\(\alpha&#39;_k\)</span> can be derived from the variance of the mean phenotype of the set of <span class="math inline">\(K\)</span> partners such that</p>
<p><span class="math display">\[\mathrm{var}\left({\alpha&#39;_k} \right) = \mathrm{var} \left( \bar{\alpha}_K \right)*n \]</span>
Conversely, we can derive the expected variance of the mean of <span class="math inline">\(n\)</span> partners by dividing through the expected variance of a single partner <span class="math inline">\(\mathrm{var} \left( \bar{\alpha}_K \right)=\mathrm{var}\left({\alpha&#39;_k} \right) /n\)</span>. In this simplified simulation, individuals and their social partners’ SRN parameters are characterized by the same population variances, so we can simply use the expected variance of individual SRN intercepts and slopes, i.e. <span class="math inline">\(\mathrm{var}(\boldsymbol{\alpha})=\mathrm{var}(\boldsymbol{\alpha&#39;})\)</span>, to calculate the expected variance of the mean of <span class="math inline">\(n\)</span> partner phenotypes. We can then use this variance to transform the vector of mean partner trait values to a standardized scale (i.e. variance = 1, z-scores), and subsequently scale these standardized values to the expected variance of a single partner using <span class="math inline">\(\mathrm{var}\left({\alpha&#39;_k} \right)\)</span>.</p>
<div class="sourceCode" id="cb140"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb140-1"><a href="within-and-between-partner-sam.html#cb140-1" aria-hidden="true" tabindex="-1"></a><span class="co">#extract posteriors</span></span>
<span id="cb140-2"><a href="within-and-between-partner-sam.html#cb140-2" aria-hidden="true" tabindex="-1"></a>post <span class="ot">&lt;-</span> rstan<span class="sc">::</span><span class="fu">extract</span>(stan_results3<span class="fl">.3</span>)</span>
<span id="cb140-3"><a href="within-and-between-partner-sam.html#cb140-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb140-4"><a href="within-and-between-partner-sam.html#cb140-4" aria-hidden="true" tabindex="-1"></a><span class="co">#temporary vectors for assortment coefficients</span></span>
<span id="cb140-5"><a href="within-and-between-partner-sam.html#cb140-5" aria-hidden="true" tabindex="-1"></a>SRN_PV <span class="ot">=</span> post<span class="sc">$</span>V_P</span>
<span id="cb140-6"><a href="within-and-between-partner-sam.html#cb140-6" aria-hidden="true" tabindex="-1"></a>SRN_Psd <span class="ot">=</span> post<span class="sc">$</span>sd_P</span>
<span id="cb140-7"><a href="within-and-between-partner-sam.html#cb140-7" aria-hidden="true" tabindex="-1"></a>SRN_PVmean <span class="ot">=</span> post<span class="sc">$</span>V_P <span class="sc">/</span> I_partner <span class="co">#expected variance for mean of partners</span></span>
<span id="cb140-8"><a href="within-and-between-partner-sam.html#cb140-8" aria-hidden="true" tabindex="-1"></a>SRN_Psdmean <span class="ot">=</span> <span class="fu">sqrt</span>(SRN_PVmean) <span class="co">#expected SD for mean of partners</span></span>
<span id="cb140-9"><a href="within-and-between-partner-sam.html#cb140-9" aria-hidden="true" tabindex="-1"></a>SRN_focal1 <span class="ot">&lt;-</span> post<span class="sc">$</span>SRN_P[,,<span class="dv">1</span>] <span class="co">#individual intercepts</span></span>
<span id="cb140-10"><a href="within-and-between-partner-sam.html#cb140-10" aria-hidden="true" tabindex="-1"></a>SRN_focal2 <span class="ot">&lt;-</span> post<span class="sc">$</span>SRN_P[,,<span class="dv">2</span>] <span class="co">#individual slopes</span></span>
<span id="cb140-11"><a href="within-and-between-partner-sam.html#cb140-11" aria-hidden="true" tabindex="-1"></a>SRN_partner1 <span class="ot">&lt;-</span> <span class="fu">cbind</span>(post<span class="sc">$</span>partner_meanm[,,<span class="dv">1</span>], post<span class="sc">$</span>partner_meanf[,,<span class="dv">1</span>])</span>
<span id="cb140-12"><a href="within-and-between-partner-sam.html#cb140-12" aria-hidden="true" tabindex="-1"></a>SRN_partner2 <span class="ot">&lt;-</span> <span class="fu">cbind</span>(post<span class="sc">$</span>partner_meanm[,,<span class="dv">2</span>], post<span class="sc">$</span>partner_meanf[,,<span class="dv">2</span>])</span>
<span id="cb140-13"><a href="within-and-between-partner-sam.html#cb140-13" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb140-14"><a href="within-and-between-partner-sam.html#cb140-14" aria-hidden="true" tabindex="-1"></a><span class="co">#scale mean partner variance to variance of single partner</span></span>
<span id="cb140-15"><a href="within-and-between-partner-sam.html#cb140-15" aria-hidden="true" tabindex="-1"></a>SRN_partner1s <span class="ot">=</span> SRN_partner1</span>
<span id="cb140-16"><a href="within-and-between-partner-sam.html#cb140-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span>(j <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(SRN_partner1))</span>
<span id="cb140-17"><a href="within-and-between-partner-sam.html#cb140-17" aria-hidden="true" tabindex="-1"></a>    {SRN_partner1s[j,] <span class="ot">=</span> ( SRN_partner1[j,] <span class="sc">/</span> SRN_Psdmean[j,<span class="dv">1</span>] ) <span class="sc">*</span> SRN_Psd[j,<span class="dv">1</span>] }</span>
<span id="cb140-18"><a href="within-and-between-partner-sam.html#cb140-18" aria-hidden="true" tabindex="-1"></a>   </span>
<span id="cb140-19"><a href="within-and-between-partner-sam.html#cb140-19" aria-hidden="true" tabindex="-1"></a>SRN_partner2s <span class="ot">=</span> SRN_partner2</span>
<span id="cb140-20"><a href="within-and-between-partner-sam.html#cb140-20" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span>(j <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(SRN_partner2))</span>
<span id="cb140-21"><a href="within-and-between-partner-sam.html#cb140-21" aria-hidden="true" tabindex="-1"></a>    {SRN_partner2s[j,] <span class="ot">=</span> ( SRN_partner2[j,] <span class="sc">/</span> SRN_Psdmean[j,<span class="dv">2</span>] ) <span class="sc">*</span> SRN_Psd[j,<span class="dv">2</span>] }</span>
<span id="cb140-22"><a href="within-and-between-partner-sam.html#cb140-22" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb140-23"><a href="within-and-between-partner-sam.html#cb140-23" aria-hidden="true" tabindex="-1"></a><span class="co">#assortment matrix</span></span>
<span id="cb140-24"><a href="within-and-between-partner-sam.html#cb140-24" aria-hidden="true" tabindex="-1"></a>Beta_alpha <span class="ot">=</span> <span class="fu">list</span>()</span>
<span id="cb140-25"><a href="within-and-between-partner-sam.html#cb140-25" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb140-26"><a href="within-and-between-partner-sam.html#cb140-26" aria-hidden="true" tabindex="-1"></a><span class="co">#generate matrices across each posterior sample</span></span>
<span id="cb140-27"><a href="within-and-between-partner-sam.html#cb140-27" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(j <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(SRN_focal1))</span>
<span id="cb140-28"><a href="within-and-between-partner-sam.html#cb140-28" aria-hidden="true" tabindex="-1"></a>    {</span>
<span id="cb140-29"><a href="within-and-between-partner-sam.html#cb140-29" aria-hidden="true" tabindex="-1"></a>            Beta_mat <span class="ot">=</span> <span class="fu">matrix</span>(<span class="cn">NA</span>,<span class="dv">2</span>,<span class="dv">2</span>)</span>
<span id="cb140-30"><a href="within-and-between-partner-sam.html#cb140-30" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb140-31"><a href="within-and-between-partner-sam.html#cb140-31" aria-hidden="true" tabindex="-1"></a>            <span class="co">#mu&#39; ~ mu</span></span>
<span id="cb140-32"><a href="within-and-between-partner-sam.html#cb140-32" aria-hidden="true" tabindex="-1"></a>            Beta_mat[<span class="dv">1</span>,<span class="dv">1</span>] <span class="ot">=</span>  <span class="fu">cov</span>(SRN_focal1[j,], SRN_partner1s[j,])<span class="sc">/</span><span class="fu">var</span>(SRN_focal1[j,])</span>
<span id="cb140-33"><a href="within-and-between-partner-sam.html#cb140-33" aria-hidden="true" tabindex="-1"></a>            <span class="co">#mu&#39; ~ psi</span></span>
<span id="cb140-34"><a href="within-and-between-partner-sam.html#cb140-34" aria-hidden="true" tabindex="-1"></a>            Beta_mat[<span class="dv">2</span>,<span class="dv">1</span>] <span class="ot">=</span>  <span class="fu">cov</span>(SRN_focal2[j,], SRN_partner1s[j,])<span class="sc">/</span><span class="fu">var</span>(SRN_focal2[j,])</span>
<span id="cb140-35"><a href="within-and-between-partner-sam.html#cb140-35" aria-hidden="true" tabindex="-1"></a>            <span class="co">#psi&#39; ~ mu                                                        </span></span>
<span id="cb140-36"><a href="within-and-between-partner-sam.html#cb140-36" aria-hidden="true" tabindex="-1"></a>            Beta_mat[<span class="dv">1</span>,<span class="dv">2</span>] <span class="ot">=</span>  <span class="fu">cov</span>(SRN_focal1[j,], SRN_partner2s[j,])<span class="sc">/</span><span class="fu">var</span>(SRN_focal1[j,])</span>
<span id="cb140-37"><a href="within-and-between-partner-sam.html#cb140-37" aria-hidden="true" tabindex="-1"></a>            <span class="co">#psi&#39; ~ psi</span></span>
<span id="cb140-38"><a href="within-and-between-partner-sam.html#cb140-38" aria-hidden="true" tabindex="-1"></a>            Beta_mat[<span class="dv">2</span>,<span class="dv">2</span>] <span class="ot">=</span>  <span class="fu">cov</span>(SRN_focal2[j,], SRN_partner2s[j,])<span class="sc">/</span><span class="fu">var</span>(SRN_focal2[j,])</span>
<span id="cb140-39"><a href="within-and-between-partner-sam.html#cb140-39" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb140-40"><a href="within-and-between-partner-sam.html#cb140-40" aria-hidden="true" tabindex="-1"></a>            Beta_alpha[[j]] <span class="ot">=</span> Beta_mat</span>
<span id="cb140-41"><a href="within-and-between-partner-sam.html#cb140-41" aria-hidden="true" tabindex="-1"></a>    } </span>
<span id="cb140-42"><a href="within-and-between-partner-sam.html#cb140-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb140-43"><a href="within-and-between-partner-sam.html#cb140-43" aria-hidden="true" tabindex="-1"></a><span class="co">#extract beta_mu&#39;mu (assortment on SRN intercepts)</span></span>
<span id="cb140-44"><a href="within-and-between-partner-sam.html#cb140-44" aria-hidden="true" tabindex="-1"></a>Beta_psi <span class="ot">=</span> <span class="fu">unlist</span>(<span class="fu">lapply</span>(Beta_alpha, <span class="cf">function</span>(x) x[<span class="dv">2</span>,<span class="dv">2</span>]))</span>
<span id="cb140-45"><a href="within-and-between-partner-sam.html#cb140-45" aria-hidden="true" tabindex="-1"></a><span class="fu">median</span>(Beta_psi); <span class="fu">sum</span>(Beta_psi <span class="sc">&gt;</span> <span class="dv">0</span>)<span class="sc">/</span><span class="fu">length</span>(Beta_psi)</span></code></pre></div>
<pre><code>## [1] 0.270885</code></pre>
<pre><code>## [1] 1</code></pre>
<p>Positive assortment of moderate effect size is detected.</p>
</div>
<div id="phenotypic-model-2" class="section level2" number="4.4">
<h2><span class="header-section-number">4.4</span> Phenotypic model</h2>
<p>A phenotypic within and between partner model can also be estimated whenever quantitative genetic information is missing.</p>
<div class="sourceCode" id="cb143"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb143-1"><a href="within-and-between-partner-sam.html#cb143-1" aria-hidden="true" tabindex="-1"></a><span class="fu">write</span>(<span class="st">&quot;</span></span>
<span id="cb143-2"><a href="within-and-between-partner-sam.html#cb143-2" aria-hidden="true" tabindex="-1"></a><span class="st">data {</span></span>
<span id="cb143-3"><a href="within-and-between-partner-sam.html#cb143-3" aria-hidden="true" tabindex="-1"></a><span class="st">  </span></span>
<span id="cb143-4"><a href="within-and-between-partner-sam.html#cb143-4" aria-hidden="true" tabindex="-1"></a><span class="st">  //indices and scalars used for model specification</span></span>
<span id="cb143-5"><a href="within-and-between-partner-sam.html#cb143-5" aria-hidden="true" tabindex="-1"></a><span class="st">  int&lt;lower=1&gt; N_sex; //total aggression observations per sex (I/2 * 4 lifetime partners)</span></span>
<span id="cb143-6"><a href="within-and-between-partner-sam.html#cb143-6" aria-hidden="true" tabindex="-1"></a><span class="st">  int&lt;lower=0&gt; I; //total individuals (M + F)</span></span>
<span id="cb143-7"><a href="within-and-between-partner-sam.html#cb143-7" aria-hidden="true" tabindex="-1"></a><span class="st">  int&lt;lower=0&gt; Im; //number of males</span></span>
<span id="cb143-8"><a href="within-and-between-partner-sam.html#cb143-8" aria-hidden="true" tabindex="-1"></a><span class="st">  int&lt;lower=0&gt; If; //number of females</span></span>
<span id="cb143-9"><a href="within-and-between-partner-sam.html#cb143-9" aria-hidden="true" tabindex="-1"></a><span class="st">  int&lt;lower=1&gt; idm[N_sex]; //index of male AG observations (of length N_sex)</span></span>
<span id="cb143-10"><a href="within-and-between-partner-sam.html#cb143-10" aria-hidden="true" tabindex="-1"></a><span class="st">  int&lt;lower=1&gt; idf[N_sex]; //index of female AG observations</span></span>
<span id="cb143-11"><a href="within-and-between-partner-sam.html#cb143-11" aria-hidden="true" tabindex="-1"></a><span class="st">  int&lt;lower=1&gt; partners_m [Im,5]; //index of male partner IDs, first column is focal ID (1 + 4 IDs)</span></span>
<span id="cb143-12"><a href="within-and-between-partner-sam.html#cb143-12" aria-hidden="true" tabindex="-1"></a><span class="st">  int&lt;lower=1&gt; partners_f [If,5]; //index of female partner IDs, first column is focal ID (1 + 4 IDs)</span></span>
<span id="cb143-13"><a href="within-and-between-partner-sam.html#cb143-13" aria-hidden="true" tabindex="-1"></a><span class="st">  </span></span>
<span id="cb143-14"><a href="within-and-between-partner-sam.html#cb143-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb143-15"><a href="within-and-between-partner-sam.html#cb143-15" aria-hidden="true" tabindex="-1"></a><span class="st">  //empirical data</span></span>
<span id="cb143-16"><a href="within-and-between-partner-sam.html#cb143-16" aria-hidden="true" tabindex="-1"></a><span class="st">  real AG_m[N_sex]; //male aggression measurements</span></span>
<span id="cb143-17"><a href="within-and-between-partner-sam.html#cb143-17" aria-hidden="true" tabindex="-1"></a><span class="st">  real AG_f[N_sex]; //female aggression measurements</span></span>
<span id="cb143-18"><a href="within-and-between-partner-sam.html#cb143-18" aria-hidden="true" tabindex="-1"></a><span class="st">  real time[N_sex]; //time index (=1 for all measures)</span></span>
<span id="cb143-19"><a href="within-and-between-partner-sam.html#cb143-19" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb143-20"><a href="within-and-between-partner-sam.html#cb143-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb143-21"><a href="within-and-between-partner-sam.html#cb143-21" aria-hidden="true" tabindex="-1"></a><span class="st">parameters {</span></span>
<span id="cb143-22"><a href="within-and-between-partner-sam.html#cb143-22" aria-hidden="true" tabindex="-1"></a><span class="st">  //population effects</span></span>
<span id="cb143-23"><a href="within-and-between-partner-sam.html#cb143-23" aria-hidden="true" tabindex="-1"></a><span class="st">  real alpha_0; //aggression global intercept</span></span>
<span id="cb143-24"><a href="within-and-between-partner-sam.html#cb143-24" aria-hidden="true" tabindex="-1"></a><span class="st">  real psi_1; //expected interaction coefficient</span></span>
<span id="cb143-25"><a href="within-and-between-partner-sam.html#cb143-25" aria-hidden="true" tabindex="-1"></a><span class="st">  real beta_B; //between partner effect</span></span>
<span id="cb143-26"><a href="within-and-between-partner-sam.html#cb143-26" aria-hidden="true" tabindex="-1"></a><span class="st">  real&lt;lower=-1,upper=1&gt; phi; //(-1,1) ensures unique solution</span></span>
<span id="cb143-27"><a href="within-and-between-partner-sam.html#cb143-27" aria-hidden="true" tabindex="-1"></a><span class="st">  </span></span>
<span id="cb143-28"><a href="within-and-between-partner-sam.html#cb143-28" aria-hidden="true" tabindex="-1"></a><span class="st">  //no way to partition feedback when t=1</span></span>
<span id="cb143-29"><a href="within-and-between-partner-sam.html#cb143-29" aria-hidden="true" tabindex="-1"></a><span class="st">  //real&lt;lower=-1,upper=1&gt; phi; //(-1,1) ensures unique solution</span></span>
<span id="cb143-30"><a href="within-and-between-partner-sam.html#cb143-30" aria-hidden="true" tabindex="-1"></a><span class="st">  </span></span>
<span id="cb143-31"><a href="within-and-between-partner-sam.html#cb143-31" aria-hidden="true" tabindex="-1"></a><span class="st">  //random effects (standard deviations)</span></span>
<span id="cb143-32"><a href="within-and-between-partner-sam.html#cb143-32" aria-hidden="true" tabindex="-1"></a><span class="st">  vector&lt;lower=0, upper = 1&gt;[2] sd_P; //phenotypic SRN mu &amp; psi SDs</span></span>
<span id="cb143-33"><a href="within-and-between-partner-sam.html#cb143-33" aria-hidden="true" tabindex="-1"></a><span class="st">  vector&lt;lower=0, upper = 1&gt;[2] sd_R; //male &amp; female residual SDs</span></span>
<span id="cb143-34"><a href="within-and-between-partner-sam.html#cb143-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb143-35"><a href="within-and-between-partner-sam.html#cb143-35" aria-hidden="true" tabindex="-1"></a><span class="st">  cholesky_factor_corr[2] LP; //phenotypic SRN correlations</span></span>
<span id="cb143-36"><a href="within-and-between-partner-sam.html#cb143-36" aria-hidden="true" tabindex="-1"></a><span class="st">  cholesky_factor_corr[2] LR; //sex-specific residual correlations</span></span>
<span id="cb143-37"><a href="within-and-between-partner-sam.html#cb143-37" aria-hidden="true" tabindex="-1"></a><span class="st">  </span></span>
<span id="cb143-38"><a href="within-and-between-partner-sam.html#cb143-38" aria-hidden="true" tabindex="-1"></a><span class="st">  matrix[I,2] std_devP; //individual-level unscaled P SRN deviations</span></span>
<span id="cb143-39"><a href="within-and-between-partner-sam.html#cb143-39" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb143-40"><a href="within-and-between-partner-sam.html#cb143-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb143-41"><a href="within-and-between-partner-sam.html#cb143-41" aria-hidden="true" tabindex="-1"></a><span class="st">transformed parameters {</span></span>
<span id="cb143-42"><a href="within-and-between-partner-sam.html#cb143-42" aria-hidden="true" tabindex="-1"></a><span class="st">  matrix[I,2] SRN_P; //scaled P SRN parameter deviations</span></span>
<span id="cb143-43"><a href="within-and-between-partner-sam.html#cb143-43" aria-hidden="true" tabindex="-1"></a><span class="st">  matrix[I,2] SRN_G; //scaled G SRN parameter deviations</span></span>
<span id="cb143-44"><a href="within-and-between-partner-sam.html#cb143-44" aria-hidden="true" tabindex="-1"></a><span class="st">  matrix[I,2] SRN_E; //scaled E SRN parameter deviations</span></span>
<span id="cb143-45"><a href="within-and-between-partner-sam.html#cb143-45" aria-hidden="true" tabindex="-1"></a><span class="st">  </span></span>
<span id="cb143-46"><a href="within-and-between-partner-sam.html#cb143-46" aria-hidden="true" tabindex="-1"></a><span class="st">  matrix[If, 2] partner_meanm; //average SRN parameters of males&#39; partners</span></span>
<span id="cb143-47"><a href="within-and-between-partner-sam.html#cb143-47" aria-hidden="true" tabindex="-1"></a><span class="st">  matrix[Im, 2] partner_meanf; //average SRN parameters of females&#39; partners</span></span>
<span id="cb143-48"><a href="within-and-between-partner-sam.html#cb143-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb143-49"><a href="within-and-between-partner-sam.html#cb143-49" aria-hidden="true" tabindex="-1"></a><span class="st">  //non-centered parameterization of phenotypic effects</span></span>
<span id="cb143-50"><a href="within-and-between-partner-sam.html#cb143-50" aria-hidden="true" tabindex="-1"></a><span class="st">  SRN_P = std_devP * diag_pre_multiply(sd_P, LP)&#39;;</span></span>
<span id="cb143-51"><a href="within-and-between-partner-sam.html#cb143-51" aria-hidden="true" tabindex="-1"></a><span class="st">  </span></span>
<span id="cb143-52"><a href="within-and-between-partner-sam.html#cb143-52" aria-hidden="true" tabindex="-1"></a><span class="st">  //calculate the mean SRN parameters of each male&#39;s lifetime partners</span></span>
<span id="cb143-53"><a href="within-and-between-partner-sam.html#cb143-53" aria-hidden="true" tabindex="-1"></a><span class="st">  for(i in 1:Im) partner_meanm[i] = [mean(col(SRN_P[partners_m[i,2:5]],1)),</span></span>
<span id="cb143-54"><a href="within-and-between-partner-sam.html#cb143-54" aria-hidden="true" tabindex="-1"></a><span class="st">                                mean(col(SRN_P[partners_m[i,2:5]],2))];</span></span>
<span id="cb143-55"><a href="within-and-between-partner-sam.html#cb143-55" aria-hidden="true" tabindex="-1"></a><span class="st">  </span></span>
<span id="cb143-56"><a href="within-and-between-partner-sam.html#cb143-56" aria-hidden="true" tabindex="-1"></a><span class="st">  //calculate the mean SRN parameters of each female&#39;s lifetime partners</span></span>
<span id="cb143-57"><a href="within-and-between-partner-sam.html#cb143-57" aria-hidden="true" tabindex="-1"></a><span class="st">  for(i in 1:If) partner_meanf[i] = [mean(col(SRN_P[partners_f[i,2:5]],1)),</span></span>
<span id="cb143-58"><a href="within-and-between-partner-sam.html#cb143-58" aria-hidden="true" tabindex="-1"></a><span class="st">                                mean(col(SRN_P[partners_f[i,2:5]],2))];</span></span>
<span id="cb143-59"><a href="within-and-between-partner-sam.html#cb143-59" aria-hidden="true" tabindex="-1"></a><span class="st">  </span></span>
<span id="cb143-60"><a href="within-and-between-partner-sam.html#cb143-60" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb143-61"><a href="within-and-between-partner-sam.html#cb143-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb143-62"><a href="within-and-between-partner-sam.html#cb143-62" aria-hidden="true" tabindex="-1"></a><span class="st">model{</span></span>
<span id="cb143-63"><a href="within-and-between-partner-sam.html#cb143-63" aria-hidden="true" tabindex="-1"></a><span class="st"> //separate male and female vectors for efficiency</span></span>
<span id="cb143-64"><a href="within-and-between-partner-sam.html#cb143-64" aria-hidden="true" tabindex="-1"></a><span class="st">  matrix[Im,2] SRN_Pm = SRN_P[1:Im]; //male SRN phenotypic deviations</span></span>
<span id="cb143-65"><a href="within-and-between-partner-sam.html#cb143-65" aria-hidden="true" tabindex="-1"></a><span class="st">  matrix[If,2] SRN_Pf = SRN_P[(Im+1):I]; //female SRN phenotypic deviations</span></span>
<span id="cb143-66"><a href="within-and-between-partner-sam.html#cb143-66" aria-hidden="true" tabindex="-1"></a><span class="st">  </span></span>
<span id="cb143-67"><a href="within-and-between-partner-sam.html#cb143-67" aria-hidden="true" tabindex="-1"></a><span class="st">  //separate SRN intercepts and slopes (phenotypic deviations)</span></span>
<span id="cb143-68"><a href="within-and-between-partner-sam.html#cb143-68" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[Im] mu_m = col(SRN_Pm,1); //SRN intercepts</span></span>
<span id="cb143-69"><a href="within-and-between-partner-sam.html#cb143-69" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[If] mu_f = col(SRN_Pf,1); </span></span>
<span id="cb143-70"><a href="within-and-between-partner-sam.html#cb143-70" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[Im] psi_m = col(SRN_Pm,2); //SRN slopes</span></span>
<span id="cb143-71"><a href="within-and-between-partner-sam.html#cb143-71" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[If] psi_f = col(SRN_Pf,2); </span></span>
<span id="cb143-72"><a href="within-and-between-partner-sam.html#cb143-72" aria-hidden="true" tabindex="-1"></a><span class="st">  </span></span>
<span id="cb143-73"><a href="within-and-between-partner-sam.html#cb143-73" aria-hidden="true" tabindex="-1"></a><span class="st">  //separate mean partner SRN intercepts and slopes (deviations)</span></span>
<span id="cb143-74"><a href="within-and-between-partner-sam.html#cb143-74" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[Im] mu_meanm = col(partner_meanm,1); //mean partner SRN intercept for males</span></span>
<span id="cb143-75"><a href="within-and-between-partner-sam.html#cb143-75" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[If] mu_meanf = col(partner_meanf,1); //...for females</span></span>
<span id="cb143-76"><a href="within-and-between-partner-sam.html#cb143-76" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[Im] psi_meanm = col(partner_meanm,2); //mean partner SRN slope for males</span></span>
<span id="cb143-77"><a href="within-and-between-partner-sam.html#cb143-77" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[If] psi_meanf = col(partner_meanf,2); //...for females </span></span>
<span id="cb143-78"><a href="within-and-between-partner-sam.html#cb143-78" aria-hidden="true" tabindex="-1"></a><span class="st">  </span></span>
<span id="cb143-79"><a href="within-and-between-partner-sam.html#cb143-79" aria-hidden="true" tabindex="-1"></a><span class="st">  //initialize vectors for constructing individual-centered linear predictors</span></span>
<span id="cb143-80"><a href="within-and-between-partner-sam.html#cb143-80" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[N_sex] eta_Wm; //within-individual centered male SRN trait value </span></span>
<span id="cb143-81"><a href="within-and-between-partner-sam.html#cb143-81" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[N_sex] eta_Wf; //within-individual centered female SRN trait value</span></span>
<span id="cb143-82"><a href="within-and-between-partner-sam.html#cb143-82" aria-hidden="true" tabindex="-1"></a><span class="st">  </span></span>
<span id="cb143-83"><a href="within-and-between-partner-sam.html#cb143-83" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[N_sex] eta_Bm; //individual male SRN trait value toward average partner </span></span>
<span id="cb143-84"><a href="within-and-between-partner-sam.html#cb143-84" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[N_sex] eta_Bf; //individual female SRN trait toward average partner</span></span>
<span id="cb143-85"><a href="within-and-between-partner-sam.html#cb143-85" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[N_sex] eta_meanm; //average SRN partner values for males</span></span>
<span id="cb143-86"><a href="within-and-between-partner-sam.html#cb143-86" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[N_sex] eta_meanf; //average SRN partner values for females</span></span>
<span id="cb143-87"><a href="within-and-between-partner-sam.html#cb143-87" aria-hidden="true" tabindex="-1"></a><span class="st">  </span></span>
<span id="cb143-88"><a href="within-and-between-partner-sam.html#cb143-88" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[N_sex] linpred_m; //expected value for male responses</span></span>
<span id="cb143-89"><a href="within-and-between-partner-sam.html#cb143-89" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[N_sex] linpred_f; //expected value for female responses</span></span>
<span id="cb143-90"><a href="within-and-between-partner-sam.html#cb143-90" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[N_sex] epsilon_m; //residuals for male responses</span></span>
<span id="cb143-91"><a href="within-and-between-partner-sam.html#cb143-91" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[N_sex] epsilon_f; //residuals for male responses</span></span>
<span id="cb143-92"><a href="within-and-between-partner-sam.html#cb143-92" aria-hidden="true" tabindex="-1"></a><span class="st">  </span></span>
<span id="cb143-93"><a href="within-and-between-partner-sam.html#cb143-93" aria-hidden="true" tabindex="-1"></a><span class="st">  //Male and female aggression response model</span></span>
<span id="cb143-94"><a href="within-and-between-partner-sam.html#cb143-94" aria-hidden="true" tabindex="-1"></a><span class="st">  for (n in 1:N_sex) {</span></span>
<span id="cb143-95"><a href="within-and-between-partner-sam.html#cb143-95" aria-hidden="true" tabindex="-1"></a><span class="st">    </span></span>
<span id="cb143-96"><a href="within-and-between-partner-sam.html#cb143-96" aria-hidden="true" tabindex="-1"></a><span class="st">    //SRN trait values</span></span>
<span id="cb143-97"><a href="within-and-between-partner-sam.html#cb143-97" aria-hidden="true" tabindex="-1"></a><span class="st">    //assumes that n = 1 in the context of an ongoing social interaction</span></span>
<span id="cb143-98"><a href="within-and-between-partner-sam.html#cb143-98" aria-hidden="true" tabindex="-1"></a><span class="st">    //if n = 1 prior to social context, then specify eta[t=1] = mu_j instead</span></span>
<span id="cb143-99"><a href="within-and-between-partner-sam.html#cb143-99" aria-hidden="true" tabindex="-1"></a><span class="st">    if (time[n]==1)</span></span>
<span id="cb143-100"><a href="within-and-between-partner-sam.html#cb143-100" aria-hidden="true" tabindex="-1"></a><span class="st">      {</span></span>
<span id="cb143-101"><a href="within-and-between-partner-sam.html#cb143-101" aria-hidden="true" tabindex="-1"></a><span class="st">        //within-individual centered eta</span></span>
<span id="cb143-102"><a href="within-and-between-partner-sam.html#cb143-102" aria-hidden="true" tabindex="-1"></a><span class="st">        //male eta[t=1] = mu_j + psi_j*(mu_k - mu_meanK)</span></span>
<span id="cb143-103"><a href="within-and-between-partner-sam.html#cb143-103" aria-hidden="true" tabindex="-1"></a><span class="st">        eta_Wm[n] = mu_m[idm[n]] +  (psi_1 + psi_m[idm[n]])*(mu_f[idf[n]] - mu_meanm[idm[n]]) ;</span></span>
<span id="cb143-104"><a href="within-and-between-partner-sam.html#cb143-104" aria-hidden="true" tabindex="-1"></a><span class="st">        </span></span>
<span id="cb143-105"><a href="within-and-between-partner-sam.html#cb143-105" aria-hidden="true" tabindex="-1"></a><span class="st">        //female eta[t=1] = mu_k + psi_k*(mu_j - mu_meanJ)</span></span>
<span id="cb143-106"><a href="within-and-between-partner-sam.html#cb143-106" aria-hidden="true" tabindex="-1"></a><span class="st">        eta_Wf[n] = mu_f[idf[n]] +   (psi_1 + psi_f[idf[n]])*(mu_m[idm[n]] - mu_meanf[idf[n]]);</span></span>
<span id="cb143-107"><a href="within-and-between-partner-sam.html#cb143-107" aria-hidden="true" tabindex="-1"></a><span class="st">        </span></span>
<span id="cb143-108"><a href="within-and-between-partner-sam.html#cb143-108" aria-hidden="true" tabindex="-1"></a><span class="st">        //average individual eta</span></span>
<span id="cb143-109"><a href="within-and-between-partner-sam.html#cb143-109" aria-hidden="true" tabindex="-1"></a><span class="st">        //male eta[t=1] = mu_j + psi_j*mu_k</span></span>
<span id="cb143-110"><a href="within-and-between-partner-sam.html#cb143-110" aria-hidden="true" tabindex="-1"></a><span class="st">        eta_Bm[n] =   (psi_1 + psi_m[idm[n]])*mu_meanm[idm[n]];</span></span>
<span id="cb143-111"><a href="within-and-between-partner-sam.html#cb143-111" aria-hidden="true" tabindex="-1"></a><span class="st">        </span></span>
<span id="cb143-112"><a href="within-and-between-partner-sam.html#cb143-112" aria-hidden="true" tabindex="-1"></a><span class="st">        //female eta[t=1] = mu_k + psi_k*mu_j</span></span>
<span id="cb143-113"><a href="within-and-between-partner-sam.html#cb143-113" aria-hidden="true" tabindex="-1"></a><span class="st">        eta_Bf[n] =   (psi_1 + psi_f[idf[n]])*mu_meanf[idf[n]];</span></span>
<span id="cb143-114"><a href="within-and-between-partner-sam.html#cb143-114" aria-hidden="true" tabindex="-1"></a><span class="st">        </span></span>
<span id="cb143-115"><a href="within-and-between-partner-sam.html#cb143-115" aria-hidden="true" tabindex="-1"></a><span class="st">        //average partner eta[t=1]</span></span>
<span id="cb143-116"><a href="within-and-between-partner-sam.html#cb143-116" aria-hidden="true" tabindex="-1"></a><span class="st">        //average eta males&#39; partners [t=1] = mu_meanK + psi_meanK*mu_j</span></span>
<span id="cb143-117"><a href="within-and-between-partner-sam.html#cb143-117" aria-hidden="true" tabindex="-1"></a><span class="st">        eta_meanm[n] = mu_meanm[idm[n]] +   (psi_1 + psi_meanm[idm[n]])*mu_m[idm[n]];</span></span>
<span id="cb143-118"><a href="within-and-between-partner-sam.html#cb143-118" aria-hidden="true" tabindex="-1"></a><span class="st">        </span></span>
<span id="cb143-119"><a href="within-and-between-partner-sam.html#cb143-119" aria-hidden="true" tabindex="-1"></a><span class="st">        //average eta females&#39; partners [t=1] = mu_meanJ + psi_meanJ*mu_k</span></span>
<span id="cb143-120"><a href="within-and-between-partner-sam.html#cb143-120" aria-hidden="true" tabindex="-1"></a><span class="st">        eta_meanf[n] = mu_meanf[idf[n]] +   (psi_1 + psi_meanf[idf[n]])*mu_f[idf[n]];</span></span>
<span id="cb143-121"><a href="within-and-between-partner-sam.html#cb143-121" aria-hidden="true" tabindex="-1"></a><span class="st">      }    </span></span>
<span id="cb143-122"><a href="within-and-between-partner-sam.html#cb143-122" aria-hidden="true" tabindex="-1"></a><span class="st">    else</span></span>
<span id="cb143-123"><a href="within-and-between-partner-sam.html#cb143-123" aria-hidden="true" tabindex="-1"></a><span class="st">      {</span></span>
<span id="cb143-124"><a href="within-and-between-partner-sam.html#cb143-124" aria-hidden="true" tabindex="-1"></a><span class="st">        //within-individual centered eta</span></span>
<span id="cb143-125"><a href="within-and-between-partner-sam.html#cb143-125" aria-hidden="true" tabindex="-1"></a><span class="st">        //male eta[t=2] = mu_j + psi_j*(eta_k[t=1] - eta_meanK[t=1])</span></span>
<span id="cb143-126"><a href="within-and-between-partner-sam.html#cb143-126" aria-hidden="true" tabindex="-1"></a><span class="st">        eta_Wm[n] = mu_m[idm[n]] +   (psi_1 + psi_m[idm[n]])*(eta_Wf[n-1] - eta_meanm[n-1]);</span></span>
<span id="cb143-127"><a href="within-and-between-partner-sam.html#cb143-127" aria-hidden="true" tabindex="-1"></a><span class="st">        </span></span>
<span id="cb143-128"><a href="within-and-between-partner-sam.html#cb143-128" aria-hidden="true" tabindex="-1"></a><span class="st">        //female eta[t=2] = mu_k + psi_k*(eta_j[t=1] - eta_meanJ[t=1])</span></span>
<span id="cb143-129"><a href="within-and-between-partner-sam.html#cb143-129" aria-hidden="true" tabindex="-1"></a><span class="st">        eta_Wf[n] = mu_f[idf[n]] +   (psi_1 + psi_f[idf[n]])*(eta_Wm[n-1] - eta_meanf[n-1]);</span></span>
<span id="cb143-130"><a href="within-and-between-partner-sam.html#cb143-130" aria-hidden="true" tabindex="-1"></a><span class="st">        </span></span>
<span id="cb143-131"><a href="within-and-between-partner-sam.html#cb143-131" aria-hidden="true" tabindex="-1"></a><span class="st">        //average individual eta</span></span>
<span id="cb143-132"><a href="within-and-between-partner-sam.html#cb143-132" aria-hidden="true" tabindex="-1"></a><span class="st">        //male average eta[t=2] = mu_j + psi_j*eta_meanK[t=1]</span></span>
<span id="cb143-133"><a href="within-and-between-partner-sam.html#cb143-133" aria-hidden="true" tabindex="-1"></a><span class="st">        eta_Bm[n] =  (psi_1 + psi_m[idm[n]])*eta_meanm[n-1];</span></span>
<span id="cb143-134"><a href="within-and-between-partner-sam.html#cb143-134" aria-hidden="true" tabindex="-1"></a><span class="st">        </span></span>
<span id="cb143-135"><a href="within-and-between-partner-sam.html#cb143-135" aria-hidden="true" tabindex="-1"></a><span class="st">        //female average eta[t=2] = mu_k + psi_k*eta_meanJ[t=1]</span></span>
<span id="cb143-136"><a href="within-and-between-partner-sam.html#cb143-136" aria-hidden="true" tabindex="-1"></a><span class="st">        eta_Bf[n] =  (psi_1 + psi_f[idf[n]])*eta_meanf[n-1];</span></span>
<span id="cb143-137"><a href="within-and-between-partner-sam.html#cb143-137" aria-hidden="true" tabindex="-1"></a><span class="st">        </span></span>
<span id="cb143-138"><a href="within-and-between-partner-sam.html#cb143-138" aria-hidden="true" tabindex="-1"></a><span class="st">        //average eta males&#39; partners [t=1] = mu_meanK + psi_meanK*mean eta_j[t-1]</span></span>
<span id="cb143-139"><a href="within-and-between-partner-sam.html#cb143-139" aria-hidden="true" tabindex="-1"></a><span class="st">        eta_meanm[n] = mu_meanm[idm[n]] +  (psi_1 + psi_meanm[idm[n]])*(mu_m[idm[n]] + eta_Bm[n-1]);</span></span>
<span id="cb143-140"><a href="within-and-between-partner-sam.html#cb143-140" aria-hidden="true" tabindex="-1"></a><span class="st">        </span></span>
<span id="cb143-141"><a href="within-and-between-partner-sam.html#cb143-141" aria-hidden="true" tabindex="-1"></a><span class="st">        //female average partner eta</span></span>
<span id="cb143-142"><a href="within-and-between-partner-sam.html#cb143-142" aria-hidden="true" tabindex="-1"></a><span class="st">        eta_meanf[n] = mu_meanf[idf[n]] +  (psi_1 + psi_meanf[idf[n]])*(mu_f[idf[n]] +   eta_Bf[n-1]); </span></span>
<span id="cb143-143"><a href="within-and-between-partner-sam.html#cb143-143" aria-hidden="true" tabindex="-1"></a><span class="st">      }</span></span>
<span id="cb143-144"><a href="within-and-between-partner-sam.html#cb143-144" aria-hidden="true" tabindex="-1"></a><span class="st">    </span></span>
<span id="cb143-145"><a href="within-and-between-partner-sam.html#cb143-145" aria-hidden="true" tabindex="-1"></a><span class="st">    //add global intercept and between-individual parameters to linear predictor</span></span>
<span id="cb143-146"><a href="within-and-between-partner-sam.html#cb143-146" aria-hidden="true" tabindex="-1"></a><span class="st">    //other fixed effects can also be added here</span></span>
<span id="cb143-147"><a href="within-and-between-partner-sam.html#cb143-147" aria-hidden="true" tabindex="-1"></a><span class="st">    linpred_m[n] = alpha_0 + eta_Wm[n] + beta_B*eta_Bm[n]; //+beta_B*eta_Bm[n]</span></span>
<span id="cb143-148"><a href="within-and-between-partner-sam.html#cb143-148" aria-hidden="true" tabindex="-1"></a><span class="st">    linpred_f[n] = alpha_0 + eta_Wf[n] + beta_B*eta_Bf[n]; //+beta_B*eta_Bf[n]</span></span>
<span id="cb143-149"><a href="within-and-between-partner-sam.html#cb143-149" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb143-150"><a href="within-and-between-partner-sam.html#cb143-150" aria-hidden="true" tabindex="-1"></a><span class="st">    //residual trait values</span></span>
<span id="cb143-151"><a href="within-and-between-partner-sam.html#cb143-151" aria-hidden="true" tabindex="-1"></a><span class="st">    if(time[n]==1)</span></span>
<span id="cb143-152"><a href="within-and-between-partner-sam.html#cb143-152" aria-hidden="true" tabindex="-1"></a><span class="st">      {</span></span>
<span id="cb143-153"><a href="within-and-between-partner-sam.html#cb143-153" aria-hidden="true" tabindex="-1"></a><span class="st">        epsilon_m [n] = AG_m[n] - linpred_m[n];</span></span>
<span id="cb143-154"><a href="within-and-between-partner-sam.html#cb143-154" aria-hidden="true" tabindex="-1"></a><span class="st">        epsilon_f [n] = AG_f[n] - linpred_f[n];</span></span>
<span id="cb143-155"><a href="within-and-between-partner-sam.html#cb143-155" aria-hidden="true" tabindex="-1"></a><span class="st">      }</span></span>
<span id="cb143-156"><a href="within-and-between-partner-sam.html#cb143-156" aria-hidden="true" tabindex="-1"></a><span class="st">    else</span></span>
<span id="cb143-157"><a href="within-and-between-partner-sam.html#cb143-157" aria-hidden="true" tabindex="-1"></a><span class="st">      {</span></span>
<span id="cb143-158"><a href="within-and-between-partner-sam.html#cb143-158" aria-hidden="true" tabindex="-1"></a><span class="st">       linpred_m[n] = linpred_m[n] + phi * epsilon_f[n-1];</span></span>
<span id="cb143-159"><a href="within-and-between-partner-sam.html#cb143-159" aria-hidden="true" tabindex="-1"></a><span class="st">       epsilon_m[n] = AG_m[n] - linpred_m[n]; </span></span>
<span id="cb143-160"><a href="within-and-between-partner-sam.html#cb143-160" aria-hidden="true" tabindex="-1"></a><span class="st">       </span></span>
<span id="cb143-161"><a href="within-and-between-partner-sam.html#cb143-161" aria-hidden="true" tabindex="-1"></a><span class="st">       linpred_f[n] = linpred_f[n] + phi * epsilon_m[n-1];</span></span>
<span id="cb143-162"><a href="within-and-between-partner-sam.html#cb143-162" aria-hidden="true" tabindex="-1"></a><span class="st">       epsilon_f[n] = AG_f[n] - linpred_f[n]; </span></span>
<span id="cb143-163"><a href="within-and-between-partner-sam.html#cb143-163" aria-hidden="true" tabindex="-1"></a><span class="st">      }</span></span>
<span id="cb143-164"><a href="within-and-between-partner-sam.html#cb143-164" aria-hidden="true" tabindex="-1"></a><span class="st">  </span></span>
<span id="cb143-165"><a href="within-and-between-partner-sam.html#cb143-165" aria-hidden="true" tabindex="-1"></a><span class="st">    //correlated residuals between partners</span></span>
<span id="cb143-166"><a href="within-and-between-partner-sam.html#cb143-166" aria-hidden="true" tabindex="-1"></a><span class="st">    [epsilon_m[n],epsilon_f[n]]&#39; ~ multi_normal_cholesky([0,0], diag_pre_multiply(sd_R, LR));</span></span>
<span id="cb143-167"><a href="within-and-between-partner-sam.html#cb143-167" aria-hidden="true" tabindex="-1"></a><span class="st">  }</span></span>
<span id="cb143-168"><a href="within-and-between-partner-sam.html#cb143-168" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb143-169"><a href="within-and-between-partner-sam.html#cb143-169" aria-hidden="true" tabindex="-1"></a><span class="st">//model priors</span></span>
<span id="cb143-170"><a href="within-and-between-partner-sam.html#cb143-170" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb143-171"><a href="within-and-between-partner-sam.html#cb143-171" aria-hidden="true" tabindex="-1"></a><span class="st">  //fixed effects</span></span>
<span id="cb143-172"><a href="within-and-between-partner-sam.html#cb143-172" aria-hidden="true" tabindex="-1"></a><span class="st">  alpha_0 ~ std_normal();</span></span>
<span id="cb143-173"><a href="within-and-between-partner-sam.html#cb143-173" aria-hidden="true" tabindex="-1"></a><span class="st">  psi_1 ~ std_normal();</span></span>
<span id="cb143-174"><a href="within-and-between-partner-sam.html#cb143-174" aria-hidden="true" tabindex="-1"></a><span class="st">  beta_B ~ std_normal();</span></span>
<span id="cb143-175"><a href="within-and-between-partner-sam.html#cb143-175" aria-hidden="true" tabindex="-1"></a><span class="st">  phi ~ std_normal();</span></span>
<span id="cb143-176"><a href="within-and-between-partner-sam.html#cb143-176" aria-hidden="true" tabindex="-1"></a><span class="st">  </span></span>
<span id="cb143-177"><a href="within-and-between-partner-sam.html#cb143-177" aria-hidden="true" tabindex="-1"></a><span class="st">  //random effects</span></span>
<span id="cb143-178"><a href="within-and-between-partner-sam.html#cb143-178" aria-hidden="true" tabindex="-1"></a><span class="st">  to_vector(sd_P) ~ cauchy(0,1);</span></span>
<span id="cb143-179"><a href="within-and-between-partner-sam.html#cb143-179" aria-hidden="true" tabindex="-1"></a><span class="st">  to_vector(sd_R) ~ cauchy(0,1);</span></span>
<span id="cb143-180"><a href="within-and-between-partner-sam.html#cb143-180" aria-hidden="true" tabindex="-1"></a><span class="st">  </span></span>
<span id="cb143-181"><a href="within-and-between-partner-sam.html#cb143-181" aria-hidden="true" tabindex="-1"></a><span class="st">  LP ~ lkj_corr_cholesky(2);</span></span>
<span id="cb143-182"><a href="within-and-between-partner-sam.html#cb143-182" aria-hidden="true" tabindex="-1"></a><span class="st">  LR ~ lkj_corr_cholesky(2);</span></span>
<span id="cb143-183"><a href="within-and-between-partner-sam.html#cb143-183" aria-hidden="true" tabindex="-1"></a><span class="st">  </span></span>
<span id="cb143-184"><a href="within-and-between-partner-sam.html#cb143-184" aria-hidden="true" tabindex="-1"></a><span class="st">  to_vector(std_devP) ~ std_normal();</span></span>
<span id="cb143-185"><a href="within-and-between-partner-sam.html#cb143-185" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb143-186"><a href="within-and-between-partner-sam.html#cb143-186" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb143-187"><a href="within-and-between-partner-sam.html#cb143-187" aria-hidden="true" tabindex="-1"></a><span class="st">generated quantities{</span></span>
<span id="cb143-188"><a href="within-and-between-partner-sam.html#cb143-188" aria-hidden="true" tabindex="-1"></a><span class="st">//cor and cov matrices of SRN parameters and residuals</span></span>
<span id="cb143-189"><a href="within-and-between-partner-sam.html#cb143-189" aria-hidden="true" tabindex="-1"></a><span class="st">matrix[2,2] Pcor = LP * LP&#39;; //P SRN correlation matrix</span></span>
<span id="cb143-190"><a href="within-and-between-partner-sam.html#cb143-190" aria-hidden="true" tabindex="-1"></a><span class="st">matrix[2,2] Rcor = LR * LR&#39;; //residual correlation matrix</span></span>
<span id="cb143-191"><a href="within-and-between-partner-sam.html#cb143-191" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb143-192"><a href="within-and-between-partner-sam.html#cb143-192" aria-hidden="true" tabindex="-1"></a><span class="st">matrix[2,2] Pcov = diag_matrix(sd_P)*Pcor*diag_matrix(sd_P); //phenotypic covariance</span></span>
<span id="cb143-193"><a href="within-and-between-partner-sam.html#cb143-193" aria-hidden="true" tabindex="-1"></a><span class="st">matrix[2,2] Rcov = iag_matrix(sd_R)*Rcor*diag_matrix(sd_R); //residual covariance</span></span>
<span id="cb143-194"><a href="within-and-between-partner-sam.html#cb143-194" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb143-195"><a href="within-and-between-partner-sam.html#cb143-195" aria-hidden="true" tabindex="-1"></a><span class="st">//variances</span></span>
<span id="cb143-196"><a href="within-and-between-partner-sam.html#cb143-196" aria-hidden="true" tabindex="-1"></a><span class="st">vector&lt;lower=0&gt;[2] V_P = sd_P .* sd_P;</span></span>
<span id="cb143-197"><a href="within-and-between-partner-sam.html#cb143-197" aria-hidden="true" tabindex="-1"></a><span class="st">vector&lt;lower=0&gt;[2] V_R = sd_R .* sd_R;</span></span>
<span id="cb143-198"><a href="within-and-between-partner-sam.html#cb143-198" aria-hidden="true" tabindex="-1"></a><span class="st">}&quot;</span>, <span class="st">&quot;sam3_3p.stan&quot;</span>)</span></code></pre></div>

</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="between-partner-sam.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="fitness-model.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"whatsapp": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": null,
"text": null
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": null,
"toc": {
"collapse": "subsection"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
